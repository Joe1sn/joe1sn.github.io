<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Joe1sn's Cabin | 【免杀】天堂之门</title><meta name="description" content="&lt;p&gt;如何在32位程序塞入64位代码从而绕过hook拦截&lt;/p&gt;
&lt;p&gt;公众号：&lt;a href=&quot;https://mp.weixin.qq.com/s/DljrsqfemEZcblCyVYNDsQ&quot;&gt;https://mp.weixin.qq.com/s/DljrsqfemEZcblCyVYNDsQ&lt;/a&gt;&lt;/p&gt;"><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="https://joe1sn.eu.org/atom.xml" title="Joe1sn's Cabin"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Joe1sn's Cabin" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/">Joe1sn's Cabin</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="https://github.com/Joe1sn" target="_blank">GITHUB</a></li></ul></nav></header><main class="container__wrapper"><article class="article post"><h3 class="article__title">【免杀】天堂之门</h3><div class="article__date metadata"><div class="post-info">2026/01/27</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/bypass/">bypass</a></div><div class="article__body"><p>如何在32位程序塞入64位代码从而绕过hook拦截</p>
<p>公众号：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/DljrsqfemEZcblCyVYNDsQ">https://mp.weixin.qq.com/s/DljrsqfemEZcblCyVYNDsQ</a></p>
<span id="more"></span>
<p>这里是两段汇编代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">section .data</span><br><span class="line">    msg db &quot;Hello, World!&quot;, 10</span><br><span class="line">    len equ $ - msg</span><br><span class="line"></span><br><span class="line">section .text</span><br><span class="line">    global _start</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">    ; ssize_t write(int fd, const void *buf, size_t count)</span><br><span class="line">    mov eax, 4          ; sys_write</span><br><span class="line">    mov ebx, 1          ; stdout</span><br><span class="line">    mov ecx, msg</span><br><span class="line">    mov edx, len</span><br><span class="line">    int 0x80</span><br><span class="line"></span><br><span class="line">    ; void exit(int status)</span><br><span class="line">    mov eax, 1          ; sys_exit</span><br><span class="line">    xor ebx, ebx</span><br><span class="line">    int 0x80</span><br></pre></td></tr></table></figure>
<p>使用<code>int 0x80</code>系统调用完成输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">section .data</span><br><span class="line">    msg db &quot;Hello, World!&quot;, 10</span><br><span class="line">    len equ $ - msg</span><br><span class="line"></span><br><span class="line">section .text</span><br><span class="line">    global _start</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">    ; ssize_t write(int fd, const void *buf, size_t count)</span><br><span class="line">    mov rax, 1          ; sys_write</span><br><span class="line">    mov rdi, 1          ; stdout</span><br><span class="line">    lea rsi, [rel msg]</span><br><span class="line">    mov rdx, len</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    ; void exit(int status)</span><br><span class="line">    mov rax, 60         ; sys_exit</span><br><span class="line">    xor rdi, rdi</span><br><span class="line">    syscall</span><br></pre></td></tr></table></figure>
<p>这里使用的是<code>syscall</code>完成输出</p>
<p>或许在之前你已经了解过DLL注入的相关篇章</p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/qYO0Cf5MRT4vKCT5WYz1KQ">https://mp.weixin.qq.com/s/qYO0Cf5MRT4vKCT5WYz1KQ</a></p>
<p>不禁让人产生疑问：32位和64位程序使用的指令集不同，那么64位系统如何兼容运行32位软件呢？本篇文章在windows上作为探索。</p>
<h2 id="wow64分析"><a class="markdownIt-Anchor" href="#wow64分析"></a> Wow64分析</h2>
<p>32位程序在64位windows上的运行时通过<code>wow64</code>模拟器实现的</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploadsimage-20260127133658568.png" alt="image-20260127133658568" /></p>
<p>顺带提一嘴，这里根据《深入解析windows操作系统》<code>3.6 CreateProcess</code> 的创建进程中相关步骤</p>
<ol>
<li>
<p>首先是转换并验证参数：主要调度优先级，是否调试，分析参数</p>
</li>
<li>
<p>打开要执行的映像：主要是创建对应的windows映像</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploadsimage-20260127132913114.png" alt="image-20260127132913114" /></p>
</li>
<li>
<p>创建Windows进程执行体对象：主要是设置<code>EPROCESS</code>对象，其中</p>
<ul>
<li>如果处于<code>Wow64</code>下检查是否使用大页面</li>
<li><code>Wow64</code>下则随后分配辅助结构<code>EWOW64PROCESS</code></li>
<li>在映射<code>Ntdll.dll</code>到进程中，对于<code>Wow64</code>进程还需要映射32位的<code>Ntdll.dll</code></li>
</ul>
</li>
</ol>
<h2 id="操作系统相关知识"><a class="markdownIt-Anchor" href="#操作系统相关知识"></a> 操作系统相关知识</h2>
<p>在OS混沌未开之际，便有几位老祖</p>
<ul>
<li>CS (Code Segment Register)：代码段的段基址</li>
<li>DS(Data Segment Register)：数据段的段基址</li>
<li>ES(Extra Segment Register)：其值为附加数据段的段基值，称为“附加”是因为此段寄存器用途不像其他 <code>sreg</code> 那样固定，可以额外做他用。</li>
<li>FS(Extra Segment Register)：其值为附加数据段的段基值</li>
<li>GS：同上</li>
<li>SS(Stack Segment Register)：堆栈段寄存器</li>
</ul>
<p>其存储着os的本源灵气（物理地址）</p>
<p>再后来一生二、二生三，老祖集天地之造化，创结界（保护模式），著天书（全局描述符GDT（Global Descriptor Table）），生韵韵众生于虚幻。老祖（段寄存器）在虚幻中的像，幻化众生心中便为<strong>段选择子</strong>。</p>
<hr />
<p>说人话：</p>
<p>段寄存器（CS / DS / SS …）里放的 <strong>不是地址</strong>，而是：一个 <code>索引 + 权限声明</code>的小结构。</p>
<p>在windows中</p>
<table>
<thead>
<tr>
<th>CS</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>0x23</code></td>
<td>32 位用户代码段</td>
</tr>
<tr>
<td><code>0x33</code></td>
<td>64 位用户代码段</td>
</tr>
<tr>
<td><code>0x10</code></td>
<td>内核代码段</td>
</tr>
</tbody>
</table>
<ul>
<li>怎么做权限隔离？</li>
<li>怎么防止用户程序乱访问内核？</li>
<li>怎么同时跑不同“模式”的代码？</li>
</ul>
<p>Intel 的答案：把“段的定义”集中放在一张表里，让 CPU 强制检查</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/cf935ed6d3a5ee349c8c72d2806e3e7b.jpg" alt="img" /></p>
<p>段选择子一般长这样（冒号后面可以理解为二进制的长度(bit长度)，注意是小端序）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">selector</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> RPL :<span class="number">2</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> TI :<span class="number">1</span>;	<span class="comment">//local descriptor table</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> index :<span class="number">13</span>;</span><br><span class="line">&#125; __attribute__((packed)) selector;</span><br><span class="line"></span><br><span class="line"><span class="comment">//15           3 2  1 0</span></span><br><span class="line"><span class="comment">//+--------------+--+--+</span></span><br><span class="line"><span class="comment">//|   Index      |TI|RPL|</span></span><br><span class="line"><span class="comment">//+--------------+--+--+</span></span><br></pre></td></tr></table></figure>
<p>那么当<code>CS=0x33=0b110011</code>是，按照段选择子的结构体解析：</p>
<ul>
<li>RPL = 11 b = 2</li>
<li>TI = 0 = 0</li>
<li>index = 110 = 6</li>
</ul>
<p>那么CPU就回去<code>GDT[6]</code>看这是一个 64 位 ring3 代码段</p>
<h2 id="天堂之门-heavens-gate"><a class="markdownIt-Anchor" href="#天堂之门-heavens-gate"></a> 天堂之门 Heaven’s Gate</h2>
<p>​	利用<code>Wow64</code>机制，就可以在32位程序中运行64位代码，这样EDR 常 hook 32 位 <code>ntdll.dll</code>的时候就可以绕过检测。同时分析32位的程序发现了64位的指令一般是反汇编不出的，例如使用32位的ida分析64位的程序。</p>
<p>​	这种方式的特征就是使用长跳，类似如下代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">; 32-bit context</span><br><span class="line">far_jump CS=0x33, RIP=entry64</span><br><span class="line"></span><br><span class="line">; ===== 64-bit context =====</span><br><span class="line">entry64:</span><br><span class="line">    ; 64-bit instructions</span><br><span class="line">    ; e.g. call 64-bit ntdll stub</span><br><span class="line">    far_return CS=0x23</span><br></pre></td></tr></table></figure>
<p>现在结合<code>Minhook</code>编写一段<code>hook ntdll.dll</code>中 测试代码</p>
<p>关于minhook的使用可以参考：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/Po_t-JGj0e3dMBKDd9i8cw">https://mp.weixin.qq.com/s/Po_t-JGj0e3dMBKDd9i8cw</a></p>
<p>为了省去LDR这种通用过程的代码，我使用了 <a target="_blank" rel="noopener" href="https://github.com/JustasMasiulis/wow64pp">https://github.com/JustasMasiulis/wow64pp</a></p>
<p>这个框架的长跳部分实现如下：</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploadsimage-20260127200245626.png" alt="image-20260127200245626" /></p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploadsimage-20260127200001817.png" alt="image-20260127200001817" /></p>
<p><strong>其中的<code>push 0x33</code>只是为“远返回 / 远跳转”准备一个新的段选择子</strong></p>
<p>框架是header-only的，只有一个<code>.h</code>文件，非常轻松的就能使用，但是这个框架目前存在两个问题：</p>
<ul>
<li>
<p>只能使用ntdll.dll中的函数。怎么说呢，根据一些看雪老哥的说法是</p>
<blockquote>
<p>另外无法加载kerner32.dll，和user32.dll是操作系统设计限制，就算你加载成功并调用了里面的函数，之后程序也会问题，因为程序已经进入一个混乱的状态了（同时拥有了32位和64位的窗口态等），会让系统分不清楚你这个进程到底是64位的还是32位的</p>
</blockquote>
</li>
<li>
<p>多参数传参问题。最开始我使用的是<code>NtCreateFile</code>，但是返回的结果是传参错误，换了<code>NtQuerySystemTime</code>就可了。这种保持堆栈平衡之类的感觉很难做到十全十美。</p>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> NOMINMAX</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;extern/minhook/minhook.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;extern/wow64pp/wow64pp.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winternl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(NTAPI* NtQuerySystemTime_t)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    PLARGE_INTEGER SystemTime</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line">NtQuerySystemTime_t fpNtQuerySystemTime = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS NTAPI <span class="title">HookedNtQuerySystemTime</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    PLARGE_INTEGER SystemTime</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;[hook] NtQuerySystemTime called (x86 stub), &quot;</span>;</span><br><span class="line"></span><br><span class="line">    NTSTATUS status = <span class="built_in">fpNtQuerySystemTime</span>(SystemTime);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">NT_SUCCESS</span>(status))</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;[hook] SystemTime = &quot;</span></span><br><span class="line">            &lt;&lt; SystemTime-&gt;QuadPart &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    LARGE_INTEGER systemTime = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="built_in">NtQuerySystemTime</span>(&amp;systemTime);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">MH_Initialize</span>() != MH_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[x] init hook failed\n&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LPVOID pTarget = <span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleW</span>(<span class="string">L&quot;ntdll.dll&quot;</span>), <span class="string">&quot;NtQuerySystemTime&quot;</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;[*] now hook NtQuerySystemTime: 0x&quot;</span> &lt;&lt; std::hex &lt;&lt; pTarget &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">MH_CreateHook</span>(pTarget, &amp;HookedNtQuerySystemTime, <span class="built_in">reinterpret_cast</span>&lt;LPVOID*&gt;(&amp;fpNtQuerySystemTime)) != MH_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[x] create hook failed\n&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">MH_EnableHook</span>(pTarget);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NtQuerySystemTime</span>(&amp;systemTime);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> ntdllHandle = wow64pp::<span class="built_in">module_handle</span>(<span class="string">&quot;ntdll.dll&quot;</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;[*] found ntdll (x64): 0x&quot;</span> &lt;&lt; std::hex &lt;&lt; ntdllHandle &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> NtQuerySystemTime64 = wow64pp::<span class="built_in">import</span>(ntdllHandle, <span class="string">&quot;NtQuerySystemTime&quot;</span>);</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;[*] found NtQuerySystemTime (x64): 0x&quot;</span> &lt;&lt; std::hex &lt;&lt; NtQuerySystemTime64 &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> status = wow64pp::<span class="built_in">call_function</span>(</span><br><span class="line">        NtQuerySystemTime64,</span><br><span class="line">        &amp;systemTime        <span class="comment">// PLARGE_INTEGER</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;[wow64] NtQuerySystemTime status: 0x&quot;</span> &lt;&lt; std::hex &lt;&lt; status &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;[wow64] SystemTime (100ns since 1601): &quot;</span> &lt;&lt; systemTime.QuadPart &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">MH_DisableHook</span>(pTarget);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>正常调用<code>NtQuerySystemTime</code></li>
<li>Hook <code>NtQuerySystemTime</code>并调用</li>
<li>使用Wow64进行64位的<code>NtQuerySystemTime</code>调用</li>
</ol>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploadsimage-20260127195411794.png" alt="image-20260127195411794" /></p>
<h2 id="后记"><a class="markdownIt-Anchor" href="#后记"></a> 后记</h2>
<p>看似很nb但是现在这种技巧已经不怎么行了</p>
<p>比如上面的绕过hook，这种应用层的很明显是无法绕过内核/etw hook的，同时有明显的shellcode特征。不过可以恶心一手逆向的人，因为这样可以向32位的程序狠狠塞64位的shellcode，造成反汇编指令识别的错误，但也只能恶心了。</p>
<p>关于项目结构这里给出来便于复现。</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploadsimage-20260127201247825.png" alt="image-20260127201247825" /></p>
<p><code>extern\minhook\CMakeLists.txt</code></p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.11</span>)</span><br><span class="line"><span class="keyword">project</span>(minhook)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span>(MINHOOK_SOURCES</span><br><span class="line">    buffer.c</span><br><span class="line">    hook.c</span><br><span class="line">    trampoline.c</span><br><span class="line">    hde/hde32.c</span><br><span class="line">    hde/hde64.c</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span>(MINHOOK_INCLUDE</span><br><span class="line">    buffer.h</span><br><span class="line">    trampoline.h</span><br><span class="line">    hde/hde32.h</span><br><span class="line">    hde/hde64.h</span><br><span class="line">    hde/pstdint.h</span><br><span class="line">    hde/table32.h</span><br><span class="line">    hde/table64.h</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_library</span>(<span class="variable">$&#123;PROJECT_NAME&#125;</span>  STATIC</span><br><span class="line">    <span class="variable">$&#123;MINHOOK_SOURCES&#125;</span></span><br><span class="line">    <span class="variable">$&#123;MINHOOK_INCLUDE&#125;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">target_include_directories</span>(<span class="variable">$&#123;PROJECT_NAME&#125;</span>  PUBLIC</span><br><span class="line">    <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p><code>extern\wow64pp\CMakeLists.txt</code></p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.11</span>)</span><br><span class="line"><span class="keyword">project</span>(wow64pp LANGUAGES CXX)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个 interface 库</span></span><br><span class="line"><span class="keyword">add_library</span>(<span class="variable">$&#123;PROJECT_NAME&#125;</span> INTERFACE)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加 include 目录</span></span><br><span class="line"><span class="keyword">target_include_directories</span>(<span class="variable">$&#123;PROJECT_NAME&#125;</span> INTERFACE</span><br><span class="line">    <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p><code>CMakeLists.txt</code></p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.11</span>)</span><br><span class="line"><span class="keyword">project</span>(gate_example LANGUAGES CXX)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_INCLUDE_CURRENT_DIR <span class="keyword">ON</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">14</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD_REQUIRED <span class="keyword">ON</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_subdirectory</span>(extern/minhook)</span><br><span class="line"><span class="keyword">add_subdirectory</span>(extern/wow64pp)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span>(PROJECT_INCLUDE</span><br><span class="line">    <span class="keyword">include</span>/HeavensGate.hpp</span><br><span class="line">)</span><br><span class="line"><span class="keyword">set</span>(PROJECT_SOURCE</span><br><span class="line">    src/main.cpp</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Specify MSVC UTF-8 encoding</span></span><br><span class="line"><span class="keyword">add_compile_options</span>(<span class="string">&quot;$&lt;$&lt;C_COMPILER_ID:MSVC&gt;:/utf-8&gt;&quot;</span>)</span><br><span class="line"><span class="keyword">add_compile_options</span>(<span class="string">&quot;$&lt;$&lt;CXX_COMPILER_ID:MSVC&gt;:/utf-8&gt;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_executable</span>(<span class="variable">$&#123;PROJECT_NAME&#125;</span> <span class="variable">$&#123;PROJECT_INCLUDE&#125;</span> <span class="variable">$&#123;PROJECT_SOURCE&#125;</span>)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE minhook wow64pp)</span><br><span class="line"><span class="keyword">target_compile_definitions</span>(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE UNICODE _UNICODE)</span><br></pre></td></tr></table></figure>
<h1 id="引用"><a class="markdownIt-Anchor" href="#引用"></a> 引用</h1>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/win32/winprog64/wow64-implementation-details">https://learn.microsoft.com/zh-cn/windows/win32/winprog64/wow64-implementation-details</a></p>
<p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-270153.htm">https://bbs.kanxue.com/thread-270153.htm</a></p>
<p><a target="_blank" rel="noopener" href="http://blog.rewolf.pl/blog/?p=102">http://blog.rewolf.pl/blog/?p=102</a></p>
</div></article><div class="pagination"><a class="pagination__link pagination__prev" href="/2026/02/05/vnctf2026rewp/">prev_post</a><a class="pagination__link pagination__next" href="/2025/11/14/bad-cloud-Strategy/">next_post</a></div></main><footer class="footer metadata"><p class="footer__text">© 2026 Joe1sn</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div></body></html>