<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Joe1sn's Cabin | SUDO堆溢出提权：从fuzz到exp [2]</title><meta name="description" content="&lt;p&gt;前文：&lt;a href=&quot;https://blog.joe1sn.top/2022/01/04/CVE-2021-3156/&quot;&gt;https://blog.joe1sn.top/2022/01/04/CVE-2021-3156/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;受到youtuber：LiveOverflow的系列教程的启发，我发现在中文互联网上并没有相关的翻译教程，所以我想以实验报告的形式来创造这个从fuzz到exp的系列图文教程&lt;/p&gt;
&lt;p&gt;原始视频合集：&lt;a href=&quot;https://www.youtube.com/watch?v=uj1FTiczJSE&amp;amp;list=PLhixgUqwRTjy0gMuT4C3bmjeZjuNQyqdx&quot;&gt;https://www.youtube.com/watch?v=uj1FTiczJSE&amp;amp;list=PLhixgUqwRTjy0gMuT4C3bmjeZjuNQyqdx&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;原始Blog：&lt;a href=&quot;https://liveoverflow.com/why-pick-sudo-research-target-part-1/&quot;&gt;https://liveoverflow.com/why-pick-sudo-research-target-part-1/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;原作者代码仓库：&lt;a href=&quot;https://github.com/LiveOverflow/pwnedit&quot;&gt;https://github.com/LiveOverflow/pwnedit&lt;/a&gt;&lt;/p&gt;"><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="https://joe1sn.eu.org/atom.xml" title="Joe1sn's Cabin"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Joe1sn's Cabin" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/">Joe1sn's Cabin</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="https://github.com/Joe1sn" target="_blank">GITHUB</a></li></ul></nav></header><main class="container__wrapper"><article class="article post"><h3 class="article__title">SUDO堆溢出提权：从fuzz到exp [2]</h3><div class="article__date metadata"><div class="post-info">2022/04/13</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/CVE/">CVE</a><a class="article__tags__link metadata" href="/tags/fuzz/">fuzz</a></div><div class="article__body"><p>前文：<a target="_blank" rel="noopener" href="https://blog.joe1sn.top/2022/01/04/CVE-2021-3156/">https://blog.joe1sn.top/2022/01/04/CVE-2021-3156/</a></p>
<p>受到youtuber：LiveOverflow的系列教程的启发，我发现在中文互联网上并没有相关的翻译教程，所以我想以实验报告的形式来创造这个从fuzz到exp的系列图文教程</p>
<p>原始视频合集：<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=uj1FTiczJSE&amp;list=PLhixgUqwRTjy0gMuT4C3bmjeZjuNQyqdx">https://www.youtube.com/watch?v=uj1FTiczJSE&amp;list=PLhixgUqwRTjy0gMuT4C3bmjeZjuNQyqdx</a></p>
<p>原始Blog：<a target="_blank" rel="noopener" href="https://liveoverflow.com/why-pick-sudo-research-target-part-1/">https://liveoverflow.com/why-pick-sudo-research-target-part-1/</a></p>
<p>原作者代码仓库：<a target="_blank" rel="noopener" href="https://github.com/LiveOverflow/pwnedit">https://github.com/LiveOverflow/pwnedit</a></p>
<span id="more"></span>
<blockquote>
<p>My previous blog: <a target="_blank" rel="noopener" href="https://blog.joe1sn.top/2022/01/04/CVE-2021-3156/">https://blog.joe1sn.top/2022/01/04/CVE-2021-3156/</a></p>
<p>I was inspired by the LiveOverflow’s Sudo Vulnerability Walkthrough on youtube, but i found there’s no Chinese version of this walkthrough tutorial, so i decided to write in experimental report way to create this “from fuzz to exploit” series.</p>
<p>Original Videos: <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=uj1FTiczJSE&amp;list=PLhixgUqwRTjy0gMuT4C3bmjeZjuNQyqdx">https://www.youtube.com/watch?v=uj1FTiczJSE&amp;list=PLhixgUqwRTjy0gMuT4C3bmjeZjuNQyqdx</a></p>
<p>Original Blog: <a target="_blank" rel="noopener" href="https://liveoverflow.com/why-pick-sudo-research-target-part-1/">https://liveoverflow.com/why-pick-sudo-research-target-part-1/</a></p>
<p>Source Project Code: <a target="_blank" rel="noopener" href="https://github.com/LiveOverflow/pwnedit">https://github.com/LiveOverflow/pwnedit</a></p>
</blockquote>
<hr />
<blockquote>
<p>本节内容：</p>
<p>Troubleshooting AFL Fuzzing Problems | Ep. 03</p>
<p>Finding Buffer Overflow with Fuzzing | Ep. 04</p>
<p>Found a Crash Through Fuzzing? Minimize AFL Testcases! | Ep. 05</p>
<p>Root Cause Analysis With AddressSanitizer (ASan) | Ep. 06</p>
<p>Understanding C Pointer Magic Arithmetic | Ep. 07</p>
<p>C Code Review - Reaching Vulnerable Code in sudo | Ep. 08</p>
</blockquote>
<h1 id="解决afl的小麻烦"><a class="markdownIt-Anchor" href="#解决afl的小麻烦"></a> 解决AFL的小麻烦</h1>
<p>因为时间原因，我并不能一直开着电脑跑，不过我翻译一下作者遇到的问题</p>
<h2 id="no-more-free-cpu-cores"><a class="markdownIt-Anchor" href="#no-more-free-cpu-cores"></a> No more free CPU cores</h2>
<p>作者在遇到fuzz很慢的时候，尝试关闭一个fuzz，然后重启</p>
<p><img src="https://liveoverflow.com/content/images/2021/05/nomorecores.gif" alt="" /></p>
<p>然后使用<code>ps aux</code>产看全部运行过程，发现afl在尝试fuzz这些奇怪的东西（因为sudo中可能会有<code>exec</code>之类的）。然后<code>pkill vi</code>关闭所有vi的进程就短暂的解决了这个问题。</p>
<p>**解决：**彻底解决的话要关闭所有在sudo中的<code>exec</code>相关函数，然后重新编译</p>
<p><img src="https://liveoverflow.com/content/images/2021/05/exec.gif" alt="" /></p>
<h2 id="and-of-disk-space"><a class="markdownIt-Anchor" href="#and-of-disk-space"></a> And of Disk Space</h2>
<p><img src="https://liveoverflow.com/content/images/2021/05/nodiskspace.gif" alt="Today's surprising error message: we ran out of disk space overnight!" /></p>
<p>作者查看空间使用情况过后发现磁盘空间充足，但是任然不能创建文件</p>
<p>但是使用<code>df -i</code>查看inode节点，发现被占满了</p>
<blockquote>
<p>**inode (index node)**是指在许多“类<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Unix">Unix</a><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F">文件系统</a>”中的一种<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">数据结构</a>，用于描述<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F">文件系统</a>对象（包括<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%96%87%E4%BB%B6">文件</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%9B%AE%E5%BD%95_(%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F)">目录</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%AE%BE%E5%A4%87%E6%96%87%E4%BB%B6">设备文件</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Unix%E5%9F%9F%E5%A5%97%E6%8E%A5%E5%AD%97">socket</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%AE%A1%E9%81%93_(Unix)">管道</a>等）。每个inode保存了<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F">文件系统</a>对象数据的属性和磁盘块位置[<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Inode#cite_note-1">1]</a>。<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F">文件系统</a>对象属性包含了各种<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%85%83%E6%95%B0%E6%8D%AE">元数据</a>（如：最后修改时间） ，也包含用户组（owner ）和权限数据</p>
</blockquote>
<p>说明有过多的细小文件使用光了inode节点号，最后在<code>/var/tmp</code>找到了这些文件，原因是fuzz的时候产生了例如<code>../../</code>的路径穿越。</p>
<p>**解决：**手动在sudo要创建文件的时候添加上一个crash，这里用空指针引用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;mk tmp file(%s)\n&quot;</span>,stuff);</span><br><span class="line">*(<span class="type">int</span> *)<span class="number">0</span>=<span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/fe3413067a7b9f99e3ba021c607a1e81.png" alt="image-20220413123850967" /></p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/7f09bcfe84615c2aef0120d62a5796cd.png" alt="image-20220413125559550" /></p>
<p>之后开始fuzz</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/e7e313c41387799a8863c6bab6748943.png" alt="image-20220413130155444" /></p>
<p>然后分析crash</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/598831b472a33be0f627555aec16b7d4.png" alt="image-20220413132119763" /></p>
<p>但是又引入了新的问题：</p>
<p><strong>root和普通用户相同吗？</strong></p>
<p>这里就要说到sudo的原理，sudo是通过在root条件下使用<code>setuid</code>的方式来让普通用户指令得到root执行。</p>
<p>比如我们在<code>user</code>下fuzz，但是真实情况会将它变为<code>root</code>下运行</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/f1512d8ce661b5bd34be5512d0087838.png" alt="image-20220413130808491" /></p>
<p>如果要在fuzz时实现真实情况的效果，那么就要将当前用户uid设置为普通用户的</p>
<p><code>sudo-1.8.31p2/src/sudo.c get_user_info</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ud-&gt;uid = <span class="number">1000</span><span class="comment">//getuid();</span></span><br><span class="line">ud-&gt;euid = geteuid();</span><br><span class="line">ud-&gt;gid = <span class="number">1000</span><span class="comment">//getgid();</span></span><br><span class="line">ud-&gt;egid = getegid();</span><br></pre></td></tr></table></figure>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/7e0f59e187a13a0777663e9347639af0.png" alt="image-20220413131502294" /></p>
<p><s>忘写分号了</s></p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/b074e3080f25b0d667b7c7e6fb7cc860.png" alt="image-20220413132555058" /></p>
<h1 id="找到缓冲区溢出"><a class="markdownIt-Anchor" href="#找到缓冲区溢出"></a> 找到缓冲区溢出</h1>
<p>作者用上一节的fuzz得到了一些ctash样本，本章内容讲的基本上是分析这些样本</p>
<h2 id="gdb调试"><a class="markdownIt-Anchor" href="#gdb调试"></a> gdb调试</h2>
<p>和我预料的一样，这样做会产生大量的非<code>sudo</code>从而crash的样本，可以用以下命令查看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep -R sudoedit file_floder/</span><br><span class="line">grep -R sudo file_floder/</span><br></pre></td></tr></table></figure>
<p>为了方便分析，可以安装一些gdb的插件，如<code>pwndbg</code>，也在<a target="_blank" rel="noopener" href="https://blog.joe1sn.top/2022/01/04/CVE-2021-3156/">CVE分析的文章</a>里讲过了该插件的安装(不要放在共享文件夹<code>/pwd</code>下安装)</p>
<p>有的crash是由于fuzzer的错误引起的，作者使用了这段代码判断</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;argv-fuzz-inl.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[], <span class="type">char</span> *envp[])</span></span><br><span class="line">&#123;</span><br><span class="line">	AFL_INIT_ARGV(); <span class="comment">// argv is now the fake argv</span></span><br><span class="line">    execve(<span class="string">&quot;/usr/local/bin/sudo&quot;</span>, argv, envp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>作者遇到的第一个问题是<code>argv-fuzz-inl</code>中的<code>ret</code>数组造成的栈溢出，覆写了其他的函数指针造成crash</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/208250c8cc25a075605053752bfa3e33.png" alt="image-20220413134205097" /></p>
<p><strong>解决</strong> 如果<code>rc</code>比最大参数数量大时退出循环</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/bcce29acd287179264e9079b3e8a078b.png" alt="image-20220413134751535" /></p>
<h2 id="更换fuzzer"><a class="markdownIt-Anchor" href="#更换fuzzer"></a> 更换fuzzer</h2>
<p>使用更好的fuzzer：AFL++ 项目地址：<a target="_blank" rel="noopener" href="https://github.com/AFLplusplus/AFLplusplus">https://github.com/AFLplusplus/AFLplusplus</a></p>
<p>AFL++支持对命令行的fuzz，所以之前的修改要去掉</p>
<p>要新建镜像的话，可以在Dockerfile中加上</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> /root/ &amp;&amp; git <span class="built_in">clone</span> https://github.com/AFLplusplus/AFLplusplus &amp;&amp; <span class="built_in">cd</span> AFLplusplus &amp;&amp; make source-only &amp;&amp; make install</span></span><br></pre></td></tr></table></figure>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span></span><br><span class="line"><span class="keyword">ENV</span> LC_CTYPE C.UTF-<span class="number">8</span></span><br><span class="line"><span class="keyword">ARG</span> DEBIAN_FRONTEND=noninteractive</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -yq gcc make wget curl git vim gdb clang llvm lld llvm-dev bsdmainutils libstdc++-10-dev python3 python3-pip python3-dev automake flex bison build-essential libglib2.0-dev libpixman-1-dev python3-setuptools </span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> /root/ &amp;&amp; wget https://www.sudo.ws/dist/sudo-1.8.31p2.tar.gz &amp;&amp; tar -xvf sudo-1.8.31p2.tar.gz &amp;&amp; <span class="built_in">cd</span> sudo-1.8.31p2 &amp;&amp; ./configure &amp;&amp; make &amp;&amp; make install</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> /root/ &amp;&amp; git <span class="built_in">clone</span> https://github.com/AFLplusplus/AFLplusplus &amp;&amp; <span class="built_in">cd</span> AFLplusplus &amp;&amp; make source-only &amp;&amp; make install</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> useradd -ms /bin/bash user</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&#x27;export PS1=&quot;\[\e]0;\u@\h: \w\a\]\[\033[01;31m\]\u\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]# &quot;&#x27;</span> &gt;&gt; /root/.bashrc</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&#x27;export PS1=&quot;\[\e]0;\u@\h: \w\a\]\[\033[01;32m\]\u\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]$ &quot;&#x27;</span> &gt;&gt; /home/user/.bashrc</span></span><br><span class="line"><span class="keyword">USER</span> <span class="keyword">user</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /home/user</span></span><br></pre></td></tr></table></figure>
<p>重新编译</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">whereis afl-clang-fast</span><br><span class="line">ls -lah /usr/local/bin/afl-clang-fast</span><br><span class="line">CC=afl-cc ./configure --disable-shared &amp;&amp; make -j8</span><br></pre></td></tr></table></figure>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/2274e530d0cad0978349510ad0d5b73f.png" alt="image-20220413150943670" /></p>
<p>开始fuzz，指令<code>-T</code>参数可以指定<code>argv[0]</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afl-fuzz -i /tmp/in/ -o /tmp/out/ -T sudoedit ./src/sudo</span><br></pre></td></tr></table></figure>
<p>我这里故意放了能够引起crash的样本进去只为了加速过程</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/472972f2b18e905df2f043c940558cb4.png" alt="image-20220413162529243" /></p>
<h1 id="分析新的crash"><a class="markdownIt-Anchor" href="#分析新的crash"></a> 分析新的crash</h1>
<h2 id="判断是否为误报"><a class="markdownIt-Anchor" href="#判断是否为误报"></a> 判断是否为误报</h2>
<p>我直接使用作者的crash文件，你可以在：<a target="_blank" rel="noopener" href="https://github.com/LiveOverflow/pwnedit/tree/main/episode05">https://github.com/LiveOverflow/pwnedit/tree/main/episode05</a> 中找到</p>
<p><code>id_000000,sig_06,src_000083+000451,time_23448104,op_splice,rep_8</code></p>
<p>​	<img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/6f8de69e488e04c88c10bafce2b57c21.png" alt="image-20220413162911500" /></p>
<p>检验下在我的环境里面是否会有crash</p>
<p>root</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/265397d0da23f6a809df1c35c9e5d286.png" alt="image-20220413163015370" /></p>
<p>user</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/0ade7d1c969da3dbb611172d78451e41.png" alt="image-20220413164830186" /></p>
<h2 id="gdb调试-2"><a class="markdownIt-Anchor" href="#gdb调试-2"></a> gdb调试</h2>
<p>原视频里面用的是<code>GEF</code>，这里我用<code>pwndbg</code>，新人(没有CTFpwn经验)建议用GEF</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/7b80528f9a373af973d627b2a2ca6ae8.png" alt="image-20220413165152014" /></p>
<p>程序自动运行后停止了</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/13b36fd977fb17e39124b2afe6aab95d.png" alt="image-20220413165314583" /></p>
<p>说明这个错误是被<code>malloc</code>给抛出的</p>
<p>**这会是一个新的0day吗？**在最新平台上测试后发现并不是</p>
<h2 id="简化crash"><a class="markdownIt-Anchor" href="#简化crash"></a> 简化crash</h2>
<p>其实我做到这一步想到的是用<code>afl-tmin</code>，后来发现作者尝试其他方案失败后，我就直接用<code>afl-tmin</code>了</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/ede57706c88ad393445a59251320c6ca.png" alt="image-20220413172941195" /></p>
<p>在<code>user</code>下检验</p>
<ol>
<li>
<p>创建软链接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s /usr/local/bin/sudo 0edit</span><br><span class="line">ls -lah 0edit</span><br></pre></td></tr></table></figure>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/13d1cf086fed8c1a09c80748979f0f49.png" alt="image-20220413173329188" /></p>
</li>
<li>
<p>运行测试</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/0c4c5b99c28011c3f51f2dcdcd33100e.png" alt="image-20220413173442633" /></p>
</li>
<li>
<p>有趣的发现</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/398330becbcf7f97e12da43098b9a277.png" alt="image-20220413174215939" /></p>
<p>结尾是<code>xedit</code>这种形式就可以调用<code>sudoedit</code></p>
</li>
</ol>
<h2 id="使用asan分析漏洞"><a class="markdownIt-Anchor" href="#使用asan分析漏洞"></a> 使用ASAN分析漏洞</h2>
<p>asan一直是一个很操蛋的工具，经常报错，作者也在这里报错很多，我也是直接展示正常（正常报错）做法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make clean &amp;&amp; ./configure CFLAGS=&quot;-fsanitize=address,undefined -g&quot; LDFLAGS=&quot;-fsanitize=address,undefined&quot; CC=clang --disable-shared &amp;&amp; make -j8</span><br></pre></td></tr></table></figure>
<p>送入mini_crash样例检测</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/11df8269329c22ceab581946fa93e0eb.png" alt="image-20220413175350857" /></p>
<p>如果没有加上<code>--disable-shared</code>的话，就算有<code>-g</code>参数，也不会知道具体代码在哪里</p>
<p>现在我们知道漏洞的位置在<code>/plugins/sudoers/./sudoers.c:868</code>的<code>set_cmnd</code>函数内</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">set_cmnd</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sudo_nss</span> *<span class="title">nss</span>;</span></span><br><span class="line">    <span class="type">char</span> *path = user_path;</span><br><span class="line">    <span class="type">int</span> ret = FOUND;</span><br><span class="line">    debug_decl(set_cmnd, SUDOERS_DEBUG_PLUGIN)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Allocate user_stat for find_path() and match functions. */</span></span><br><span class="line">    user_stat = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> stat));</span><br><span class="line">    <span class="keyword">if</span> (user_stat == <span class="literal">NULL</span>) &#123;</span><br><span class="line">	sudo_warnx(U_(<span class="string">&quot;%s: %s&quot;</span>), __func__, U_(<span class="string">&quot;unable to allocate memory&quot;</span>));</span><br><span class="line">	debug_return_int(NOT_FOUND_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Default value for cmnd, overridden below. */</span></span><br><span class="line">    <span class="keyword">if</span> (user_cmnd == <span class="literal">NULL</span>)</span><br><span class="line">	user_cmnd = NewArgv[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sudo_mode &amp; (MODE_RUN | MODE_EDIT | MODE_CHECK)) &#123;</span><br><span class="line">	<span class="keyword">if</span> (ISSET(sudo_mode, MODE_RUN | MODE_CHECK)) &#123;</span><br><span class="line">	    <span class="keyword">if</span> (def_secure_path &amp;&amp; !user_is_exempt())</span><br><span class="line">		path = def_secure_path;</span><br><span class="line">	    <span class="keyword">if</span> (!set_perms(PERM_RUNAS))</span><br><span class="line">		debug_return_int(<span class="number">-1</span>);</span><br><span class="line">	    ret = find_path(NewArgv[<span class="number">0</span>], &amp;user_cmnd, user_stat, path,</span><br><span class="line">		def_ignore_dot, <span class="literal">NULL</span>);</span><br><span class="line">	    <span class="keyword">if</span> (!restore_perms())</span><br><span class="line">		debug_return_int(<span class="number">-1</span>);</span><br><span class="line">	    <span class="keyword">if</span> (ret == NOT_FOUND) &#123;</span><br><span class="line">		<span class="comment">/* Failed as root, try as invoking user. */</span></span><br><span class="line">		<span class="keyword">if</span> (!set_perms(PERM_USER))</span><br><span class="line">		    debug_return_int(<span class="number">-1</span>);</span><br><span class="line">		ret = find_path(NewArgv[<span class="number">0</span>], &amp;user_cmnd, user_stat, path,</span><br><span class="line">		    def_ignore_dot, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="keyword">if</span> (!restore_perms())</span><br><span class="line">		    debug_return_int(<span class="number">-1</span>);</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">if</span> (ret == NOT_FOUND_ERROR) &#123;</span><br><span class="line">		<span class="keyword">if</span> (errno == ENAMETOOLONG)</span><br><span class="line">		    audit_failure(NewArgc, NewArgv, N_(<span class="string">&quot;command too long&quot;</span>));</span><br><span class="line">		log_warning(<span class="number">0</span>, <span class="string">&quot;%s&quot;</span>, NewArgv[<span class="number">0</span>]);</span><br><span class="line">		debug_return_int(ret);</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* set user_args */</span></span><br><span class="line">	<span class="keyword">if</span> (NewArgc &gt; <span class="number">1</span>) &#123;</span><br><span class="line">	    <span class="type">char</span> *to, *from, **av;</span><br><span class="line">	    <span class="type">size_t</span> size, n;</span><br><span class="line"></span><br><span class="line">	    <span class="comment">/* Alloc and build up user_args. */</span></span><br><span class="line">	    <span class="keyword">for</span> (size = <span class="number">0</span>, av = NewArgv + <span class="number">1</span>; *av; av++)</span><br><span class="line">		size += <span class="built_in">strlen</span>(*av) + <span class="number">1</span>;</span><br><span class="line">	    <span class="keyword">if</span> (size == <span class="number">0</span> || (user_args = <span class="built_in">malloc</span>(size)) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		sudo_warnx(U_(<span class="string">&quot;%s: %s&quot;</span>), __func__, U_(<span class="string">&quot;unable to allocate memory&quot;</span>));</span><br><span class="line">		debug_return_int(<span class="number">-1</span>);</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">if</span> (ISSET(sudo_mode, MODE_SHELL|MODE_LOGIN_SHELL)) &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * When running a command via a shell, the sudo front-end</span></span><br><span class="line"><span class="comment">		 * escapes potential meta chars.  We unescape non-spaces</span></span><br><span class="line"><span class="comment">		 * for sudoers matching and logging purposes.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">for</span> (to = user_args, av = NewArgv + <span class="number">1</span>; (from = *av); av++) &#123;</span><br><span class="line">		    <span class="keyword">while</span> (*from) &#123;</span><br><span class="line">			<span class="keyword">if</span> (from[<span class="number">0</span>] == <span class="string">&#x27;\\&#x27;</span> &amp;&amp; !<span class="built_in">isspace</span>((<span class="type">unsigned</span> <span class="type">char</span>)from[<span class="number">1</span>]))</span><br><span class="line">			    from++;</span><br><span class="line">			*to++ = *from++;</span><br><span class="line">		    &#125;</span><br><span class="line">		    *to++ = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		*--to = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">	    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">for</span> (to = user_args, av = NewArgv + <span class="number">1</span>; *av; av++) &#123;</span><br><span class="line">		    n = strlcpy(to, *av, size - (to - user_args));</span><br><span class="line">		    <span class="keyword">if</span> (n &gt;= size - (to - user_args)) &#123;</span><br><span class="line">			sudo_warnx(U_(<span class="string">&quot;internal error, %s overflow&quot;</span>), __func__);</span><br><span class="line">			debug_return_int(<span class="number">-1</span>);</span><br><span class="line">		    &#125;</span><br><span class="line">		    to += n;</span><br><span class="line">		    *to++ = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		*--to = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((user_base = <span class="built_in">strrchr</span>(user_cmnd, <span class="string">&#x27;/&#x27;</span>)) != <span class="literal">NULL</span>)</span><br><span class="line">	user_base++;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">	user_base = user_cmnd;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Convert &quot;sudo sudoedit&quot; -&gt; &quot;sudoedit&quot; */</span></span><br><span class="line">    <span class="keyword">if</span> (ISSET(sudo_mode, MODE_RUN) &amp;&amp; <span class="built_in">strcmp</span>(user_base, <span class="string">&quot;sudoedit&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">	CLR(sudo_mode, MODE_RUN);</span><br><span class="line">	SET(sudo_mode, MODE_EDIT);</span><br><span class="line">	sudo_warnx(U_(<span class="string">&quot;sudoedit doesn&#x27;t need to be run via sudo&quot;</span>));</span><br><span class="line">	user_base = user_cmnd = <span class="string">&quot;sudoedit&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    TAILQ_FOREACH(nss, snl, entries) &#123;</span><br><span class="line">	<span class="keyword">if</span> (!update_defaults(nss-&gt;parse_tree, <span class="literal">NULL</span>, SETDEF_CMND, <span class="literal">false</span>)) &#123;</span><br><span class="line">	    log_warningx(SLOG_SEND_MAIL|SLOG_NO_STDERR,</span><br><span class="line">		N_(<span class="string">&quot;problem with defaults entries&quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    debug_return_int(ret);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>漏洞造成的原因在<a target="_blank" rel="noopener" href="https://blog.joe1sn.top/2022/04/11/sudo-fuzz2exp-1/">CVE那篇文章</a>分析过了</p>
<h1 id="简化漏洞模型"><a class="markdownIt-Anchor" href="#简化漏洞模型"></a> 简化漏洞模型</h1>
<p>这里的视角更像是给CTF出题，我也确实一句这个漏洞出过一道，不过在这里我们后面会完成exp的编写，所以只写c程序分析就行了</p>
<p>精简一下上面的源代码，问题出现在这里</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ISSET(sudo_mode, MODE_SHELL|MODE_LOGIN_SHELL)) &#123;</span><br><span class="line">    <span class="keyword">for</span> (to = user_args, av = NewArgv + <span class="number">1</span>; (from = *av); av++) &#123;</span><br><span class="line">        <span class="keyword">while</span> (*from) &#123;</span><br><span class="line">        <span class="keyword">if</span> (from[<span class="number">0</span>] == <span class="string">&#x27;\\&#x27;</span> &amp;&amp; !<span class="built_in">isspace</span>((<span class="type">unsigned</span> <span class="type">char</span>)from[<span class="number">1</span>]))</span><br><span class="line">            from++;</span><br><span class="line">        *to++ = *from++;</span><br><span class="line">        &#125;</span><br><span class="line">        *to++ = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    *--to = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果最后一个参数是<code>\</code>的话，<code>from++</code>，</li>
<li>然后<code>*to++ = *from++</code>，此时的<code>from</code>指针就超出了边界，造成堆溢出</li>
</ul>
<p>可以写一个小的例子调试一下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> from[<span class="number">100</span>];</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;please input some data, max is 100&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>,from,<span class="number">100</span>);</span><br><span class="line">    <span class="type">int</span> len = <span class="built_in">strlen</span>(from);</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> *src = from;</span><br><span class="line">    <span class="type">char</span> *to = (<span class="type">char</span> *)<span class="built_in">malloc</span>(len);</span><br><span class="line">    <span class="type">char</span> *dst = to+<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;start copy file&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(*src)&#123;</span><br><span class="line">        <span class="keyword">if</span> (src[<span class="number">0</span>] == <span class="string">&#x27;\\&#x27;</span> &amp;&amp; !<span class="built_in">isspace</span>((<span class="type">unsigned</span> <span class="type">char</span>)src[<span class="number">1</span>]))</span><br><span class="line">            src++;</span><br><span class="line">        *dst++ = *src++;</span><br><span class="line">    &#125;</span><br><span class="line">    *to++ = <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;src&gt; %s&quot;</span>,from);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;dst&gt; %s&quot;</span>,to);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>构造这样的特殊输入，<strong>在输入的时候已经输入0x18个字符串了</strong>，所以是<code>malloc(0x18)</code></p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/b9648613040076eb566c77966dea5d67.png" alt="image-20220413183616868" /></p>
<p>按照程序的效果，会将下一个<code>chunk</code>的头部份覆写为<code>0xbbbbbbbb</code></p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/7ad96585e880f07ad0daed331805901a.png" alt="image-20220413183740441" /></p>
<p>成功覆盖掉，实现预期堆溢出的目标，<strong>说明当结尾的反斜杠后面还有数据的时候会产生堆溢出</strong></p>
</div></article><div class="pagination"><a class="pagination__link pagination__prev" href="/2022/04/14/sudo-fuzz2exp-3/">prev_post</a><a class="pagination__link pagination__next" href="/2022/04/11/sudo-fuzz2exp-1/">next_post</a></div></main><footer class="footer metadata"><p class="footer__text">© 2025 Joe1sn</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div></body></html>