<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Joe1sn's Cabinet | 【破解】使用hook再游戏内部创建菜单栏</title><meta name="description" content="&lt;p&gt;学习是对技术的祛魅&lt;/p&gt;
&lt;p&gt;公众号：&lt;/p&gt;"><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="https://joe1sn.eu.org/atom.xml" title="Joe1sn's Cabinet"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Joe1sn's Cabinet" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/">Joe1sn's Cabinet</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="https://github.com/Joe1sn" target="_blank">GITHUB</a></li></ul></nav></header><main class="container__wrapper"><article class="article post"><h3 class="article__title">【破解】使用hook再游戏内部创建菜单栏</h3><div class="article__date metadata"><div class="post-info">2024/10/11</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/source/">source</a><a class="article__tags__link metadata" href="/tags/MinHook/">MinHook</a></div><div class="article__body"><p>学习是对技术的祛魅</p>
<p>公众号：</p>
<span id="more"></span>
<p>或许我们的公众号会有更多你感兴趣的内容</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/a0d42261f5e0b243c214f5af9049fc29.jpg" alt="img" /></p>
<h1 id="direct3d11-注入"><a class="markdownIt-Anchor" href="#direct3d11-注入"></a> Direct3D11 注入</h1>
<p>在此之前，公众号已经简述了<code>MinHook</code>的原理，那么利用这种原理我们就可以通过hook在d3d编写的游戏中实现窗口</p>
<p>相关代码：<a target="_blank" rel="noopener" href="https://github.com/Joe1sn/dx11-hook-example">https://github.com/Joe1sn/dx11-hook-example</a></p>
<h2 id="direct3d简述"><a class="markdownIt-Anchor" href="#direct3d简述"></a> Direct3D简述</h2>
<p>这里使用<code>ImGui</code>的默认dx11版本示例来讲解，首先d3d的绘制依靠的是windows的窗口(window)，接着是D3D设备、上下文和交换链以及各种绘制方法的d3dAPI传入操作系统和GPU，最后传输到显示器显示，大致如下</p>
<img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/6ad88f19b612a87f0fb01fa263ec643b.png" alt="d3d" style="zoom:33%;" />
<p>那么对于d3d API来说是这样的：</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/95bce98f171ccebac244f038b7c2fdad.png" alt="d3d2" /></p>
<h2 id="如何显示"><a class="markdownIt-Anchor" href="#如何显示"></a> 如何显示</h2>
<p>那么最后如何得到渲染好的最终帧呢？答案是交换链的 <code>IDXGISwapChain::Present</code> 方法用于呈现最终渲染的帧</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/win32/api/dxgi/nn-dxgi-idxgiswapchain">https://learn.microsoft.com/zh-cn/windows/win32/api/dxgi/nn-dxgi-idxgiswapchain</a></p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/4824f10eb0ef21a90370e4945328cdfe.png" alt="image-20240917122252505" /></p>
<p>具体参数</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/win32/api/dxgi/nf-dxgi-idxgiswapchain-present">https://learn.microsoft.com/zh-cn/windows/win32/api/dxgi/nf-dxgi-idxgiswapchain-present</a></p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/2f28850b01647a34c57d9de400ec9880.png" alt="image-20240917122310168" /></p>
<p>那么我们可以hook这个函数，然后提交我们要现实的内容，最后再一同显示出来</p>
<h2 id="编写dll"><a class="markdownIt-Anchor" href="#编写dll"></a> 编写DLL</h2>
<p>这里我就是用visual studio 2022 默认的DLL项目</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/5ee8bb5398a29ab79eed633f6e706a8d.png" alt="image-20240917122615650" /></p>
<p>导入imgui和minhook</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/dd7ca61bd48246964b9157a0cf175503.png" alt="image-20240917122813488" /></p>
<p>本篇文章将处理的是dx11版本的d3d，那么如何判断游戏是否使用了该dll呢？一般来说是凭借经验，不过也可以使用CE遍历一下DLL即可</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/49035b1e59e676e047d645fdfe4bd7c2.png" alt="image-20240917123134652" /></p>
<p>如果发现调用了多种图形API，例如OpenGL，Vulkan等，可查看使用调用对应的呈现最终帧的渲染函数，也可以参考kiero的一些做法，链接：<a target="_blank" rel="noopener" href="https://github.com/Rebzzel/kiero">https://github.com/Rebzzel/kiero</a></p>
<p>那么如何找到该函数呢？别忘了最后的dll是注入到程序中的，那么我们的dll也可以使用<code>d3d11.dll</code>，而且前文提到过<code>IDXGISwapChain::Present</code>是<code>IDXGISwapChain</code>下的方法，那么我们如果也要使用该方法，也是会跳转到同一个位置（因为注入后就是同一个程序了，那么对应的dll的内存也是同一块）</p>
<p>而且<code>Present</code>是虚函数，位置在<code>vtable[8]</code>，</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/599e0ba67c882ef76728154004315291.png" alt="image-20240917131813505" /></p>
<p>那么可以得到定位函数，这里抄了下imgui例子</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义函数参数</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">long</span><span class="params">(__stdcall* DIGX_Present)</span><span class="params">(IDXGISwapChain*, UINT, UINT)</span></span>;</span><br><span class="line">DIGX_Present originPresent;</span><br><span class="line">DIGX_Present old_present;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">getPresentPtr</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Setup swap chain</span></span><br><span class="line">    DXGI_SWAP_CHAIN_DESC sd;</span><br><span class="line">    <span class="built_in">ZeroMemory</span>(&amp;sd, <span class="built_in">sizeof</span>(sd));</span><br><span class="line">    sd.BufferCount = <span class="number">2</span>;</span><br><span class="line">    sd.BufferDesc.Width = <span class="number">0</span>;</span><br><span class="line">    sd.BufferDesc.Height = <span class="number">0</span>;</span><br><span class="line">    sd.BufferDesc.Format = DXGI_FORMAT_R8G8B8A8_UNORM;</span><br><span class="line">    <span class="comment">//sd.BufferDesc.RefreshRate.Numerator = 60;         跟随游戏的fps</span></span><br><span class="line">    <span class="comment">//sd.BufferDesc.RefreshRate.Denominator = 1;        跟随游戏</span></span><br><span class="line">    sd.OutputWindow = <span class="built_in">GetForegroundWindow</span>();        <span class="comment">//  跟随游戏窗口</span></span><br><span class="line">    sd.SampleDesc.Count = <span class="number">1</span>;</span><br><span class="line">    sd.Windowed = TRUE;</span><br><span class="line">    sd.SwapEffect = DXGI_SWAP_EFFECT_DISCARD;</span><br><span class="line"></span><br><span class="line">    UINT createDeviceFlags = <span class="number">0</span>;</span><br><span class="line">    IDXGISwapChain* swap_chain;</span><br><span class="line">    ID3D11Device* device;</span><br><span class="line"></span><br><span class="line">    D3D_FEATURE_LEVEL featureLevel;</span><br><span class="line">    <span class="type">const</span> D3D_FEATURE_LEVEL featureLevelArray[<span class="number">2</span>] = &#123; D3D_FEATURE_LEVEL_11_0, D3D_FEATURE_LEVEL_10_0, &#125;;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">D3D11CreateDeviceAndSwapChain</span>(</span><br><span class="line">        <span class="literal">nullptr</span>, </span><br><span class="line">        D3D_DRIVER_TYPE_HARDWARE, </span><br><span class="line">        <span class="literal">nullptr</span>, </span><br><span class="line">        createDeviceFlags, </span><br><span class="line">        featureLevelArray, </span><br><span class="line">        <span class="number">2</span>, </span><br><span class="line">        D3D11_SDK_VERSION, </span><br><span class="line">        &amp;sd, </span><br><span class="line">        &amp;swap_chain,</span><br><span class="line">        &amp;device,</span><br><span class="line">        &amp;featureLevel, </span><br><span class="line">        <span class="literal">nullptr</span>) == S_OK) &#123;</span><br><span class="line">        <span class="type">void</span>** p_vtable = *<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>***&gt;(swap_chain);   <span class="comment">//得到虚函数表</span></span><br><span class="line">        swap_chain-&gt;<span class="built_in">Release</span>();      <span class="comment">//释放</span></span><br><span class="line">        device-&gt;<span class="built_in">Release</span>();          <span class="comment">//释放</span></span><br><span class="line">        old_present = (DIGX_Present)p_vtable[<span class="number">8</span>];    <span class="comment">//从虚函数表得到present函数</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>确定下主线程的主要结构</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//&quot;main&quot; loop</span></span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">main</span><span class="params">(HMODULE hModule)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1.获得函数</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">getPresentPtr</span>())</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.开始hook</span></span><br><span class="line">    <span class="comment">//  2.1 hook初始化</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">MH_Initialize</span>() != MH_OK)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="comment">//  2.2 创建hook</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">MH_CreateHook</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(old_present), &amp;myPresent, <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;originPresent)) != MH_OK)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="comment">//  2.3 启用hook</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">MH_EnableHook</span>(old_present) != MH_OK)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 3.等待 F1 退出</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="built_in">Sleep</span>(<span class="number">50</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">GetAsyncKeyState</span>(VK_F1)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.退出hook，清理</span></span><br><span class="line">        <span class="comment">//Cleanup</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">MH_DisableHook</span>(MH_ALL_HOOKS) != MH_OK)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">MH_Uninitialize</span>() != MH_OK)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">FreeLibraryAndExitThread</span>(hModule, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">( HMODULE hModule,</span></span></span><br><span class="line"><span class="params"><span class="function">                       DWORD  ul_reason_for_call,</span></span></span><br><span class="line"><span class="params"><span class="function">                       LPVOID lpReserved</span></span></span><br><span class="line"><span class="params"><span class="function">                     )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_ATTACH: &#123;</span><br><span class="line">        <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)main, hModule, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>完成<code>myPresent</code>来替换旧的<code>Present</code>，这里依旧是抄了写imgui的示例代码，主要还是参考示例代码中的初始化和绘制的步骤</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">WNDPROC oWndProc;</span><br><span class="line"><span class="comment">// Forward declare message handler from imgui_impl_win32.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> IMGUI_IMPL_API LRESULT <span class="title">ImGui_ImplWin32_WndProcHandler</span><span class="params">(HWND hWnd, UINT msg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Win32 message handler</span></span><br><span class="line"><span class="comment">// You can read the io.WantCaptureMouse, io.WantCaptureKeyboard flags to tell if dear imgui wants to use your inputs.</span></span><br><span class="line"><span class="comment">// - When io.WantCaptureMouse is true, do not dispatch mouse input data to your main application, or clear/overwrite your copy of the mouse data.</span></span><br><span class="line"><span class="comment">// - When io.WantCaptureKeyboard is true, do not dispatch keyboard input data to your main application, or clear/overwrite your copy of the keyboard data.</span></span><br><span class="line"><span class="comment">// Generally you may always pass all inputs to dear imgui, and hide them from your application based on those two flags.</span></span><br><span class="line"><span class="function">LRESULT WINAPI <span class="title">WndProc</span><span class="params">(HWND hWnd, UINT msg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">ImGui_ImplWin32_WndProcHandler</span>(hWnd, msg, wParam, lParam))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ::<span class="built_in">DefWindowProcW</span>(hWnd, msg, wParam, lParam);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> init = <span class="literal">false</span>;</span><br><span class="line">HWND window = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">static</span> ID3D11Device* g_pd3dDevice = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="type">static</span> ID3D11DeviceContext* g_pd3dDeviceContext = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="type">static</span> ID3D11RenderTargetView* g_mainRenderTargetView = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">long</span> __stdcall <span class="title">myPresent</span><span class="params">(IDXGISwapChain* p_swap_chain, UINT sync_interval, UINT flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!init) &#123;</span><br><span class="line">        <span class="comment">//从swap chain获得device</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">SUCCEEDED</span>(p_swap_chain-&gt;<span class="built_in">GetDevice</span>(__uuidof(ID3D11Device), (<span class="type">void</span>**)&amp;g_pd3dDevice)))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//获得上下文</span></span><br><span class="line">            g_pd3dDevice-&gt;<span class="built_in">GetImmediateContext</span>(&amp;g_pd3dDeviceContext);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            DXGI_SWAP_CHAIN_DESC sd;</span><br><span class="line">            p_swap_chain-&gt;<span class="built_in">GetDesc</span>(&amp;sd);</span><br><span class="line">            window = sd.OutputWindow;</span><br><span class="line">            ID3D11Texture2D* pBackBuffer;</span><br><span class="line">            p_swap_chain-&gt;<span class="built_in">GetBuffer</span>(<span class="number">0</span>, __uuidof(ID3D11Texture2D), (LPVOID*)&amp;pBackBuffer);</span><br><span class="line">            g_pd3dDevice-&gt;<span class="built_in">CreateRenderTargetView</span>(pBackBuffer, <span class="literal">NULL</span>, &amp;g_mainRenderTargetView);</span><br><span class="line">            pBackBuffer-&gt;<span class="built_in">Release</span>();</span><br><span class="line"></span><br><span class="line">            oWndProc = (WNDPROC)<span class="built_in">SetWindowLongPtr</span>(window, GWLP_WNDPROC, (LONG_PTR)WndProc);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//创建imgui上下文</span></span><br><span class="line">            ImGui::<span class="built_in">CreateContext</span>();</span><br><span class="line">            ImGuiIO&amp; io = ImGui::<span class="built_in">GetIO</span>(); (<span class="type">void</span>)io;</span><br><span class="line">            io.ConfigFlags |= ImGuiConfigFlags_NavEnableKeyboard;     <span class="comment">// Enable Keyboard Controls</span></span><br><span class="line">            io.ConfigFlags |= ImGuiConfigFlags_NavEnableGamepad;      <span class="comment">// Enable Gamepad Controls</span></span><br><span class="line"></span><br><span class="line">            ImGui::<span class="built_in">StyleColorsDark</span>();</span><br><span class="line"></span><br><span class="line">            ImGuiStyle&amp; style = ImGui::<span class="built_in">GetStyle</span>();</span><br><span class="line">            <span class="keyword">if</span> (io.ConfigFlags)</span><br><span class="line">            &#123;</span><br><span class="line">                style.WindowRounding = <span class="number">0.0f</span>;</span><br><span class="line">                style.Colors[ImGuiCol_WindowBg].w = <span class="number">1.0f</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">ImGui_ImplWin32_Init</span>(window);</span><br><span class="line">            <span class="built_in">ImGui_ImplDX11_Init</span>(g_pd3dDevice, g_pd3dDeviceContext);</span><br><span class="line">            init = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">originPresent</span>(p_swap_chain, sync_interval, flags);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">ImGui_ImplDX11_NewFrame</span>();</span><br><span class="line">    <span class="built_in">ImGui_ImplWin32_NewFrame</span>();</span><br><span class="line"></span><br><span class="line">    ImGui::<span class="built_in">NewFrame</span>();</span><br><span class="line"></span><br><span class="line">    ImGui::<span class="built_in">ShowDemoWindow</span>();</span><br><span class="line"></span><br><span class="line">    ImGui::<span class="built_in">EndFrame</span>();</span><br><span class="line">    ImGui::<span class="built_in">Render</span>();</span><br><span class="line">    g_pd3dDeviceContext-&gt;<span class="built_in">OMSetRenderTargets</span>(<span class="number">1</span>, &amp;g_mainRenderTargetView, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">ImGui_ImplDX11_RenderDrawData</span>(ImGui::<span class="built_in">GetDrawData</span>());</span><br><span class="line">    <span class="comment">// Update and Render additional Platform Windows</span></span><br><span class="line">    <span class="comment">//if (io.ConfigFlags &amp; ImGuiConfigFlags_ViewportsEnable)</span></span><br><span class="line">    <span class="comment">//&#123;</span></span><br><span class="line">    <span class="comment">//    ImGui::UpdatePlatformWindows();</span></span><br><span class="line">    <span class="comment">//    ImGui::RenderPlatformWindowsDefault();</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//// Present</span></span><br><span class="line">    <span class="comment">//HRESULT hr = g_pSwapChain-&gt;Present(1, 0);   // Present with vsync</span></span><br><span class="line">    <span class="comment">////HRESULT hr = g_pSwapChain-&gt;Present(0, 0); // Present without vsync</span></span><br><span class="line">    <span class="comment">//g_SwapChainOccluded = (hr == DXGI_STATUS_OCCLUDED);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">originPresent</span>(p_swap_chain, sync_interval, flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/f950e1c8830aacf20c596032f21d2345.png" alt="image-20240917134455215" /></p>
</div></article><div class="pagination"><a class="pagination__link pagination__prev" href="/2024/12/01/pe_format/">prev_post</a><a class="pagination__link pagination__next" href="/2024/10/01/dll-inject/">next_post</a></div></main><footer class="footer metadata"><p class="footer__text">© 2025 Joe1sn</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div></body></html>