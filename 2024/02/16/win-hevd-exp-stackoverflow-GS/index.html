<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Joe1sn's Cabinet | 【Win Pwn】记一次失败的Windows内核GS栈溢出保护</title><meta name="description" content="&lt;p&gt;HEVD中的栈溢出加上GS保护，貌似没有什么好的方法了&lt;/p&gt;"><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="https://joe1sn.eu.org/atom.xml" title="Joe1sn's Cabinet"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Joe1sn's Cabinet" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/">Joe1sn's Cabinet</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="https://github.com/Joe1sn" target="_blank">GITHUB</a></li></ul></nav></header><main class="container__wrapper"><article class="article post"><h3 class="article__title">【Win Pwn】记一次失败的Windows内核GS栈溢出保护</h3><div class="article__date metadata"><div class="post-info">2024/02/16</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/kernel/">kernel</a><a class="article__tags__link metadata" href="/tags/windows/">windows</a><a class="article__tags__link metadata" href="/tags/pwn/">pwn</a></div><div class="article__body"><p>HEVD中的栈溢出加上GS保护，貌似没有什么好的方法了</p>
<span id="more"></span>
<p>函数功能</p>
<p><img src="https://img.joe1sn.top/uploads/big/a1743db93e122898948550a845f7d04f.png" alt="image-20240124203451123" /></p>
<p>在上三篇中讲的很清楚了，这里我关闭了KVAS</p>
<p><img src="https://img.joe1sn.top/uploads/big/21407e450615457821bd83e162b53ecc.png" alt="image-20240124203542280" /></p>
<p>又是一段经典的栈溢出，但是有了内核的GS保护</p>
<p>这里就不得不提到Windows中一种Cannary的绕过方式了，通过try except的Handler进行绕过，很遗憾handler只在32位程序中才保存在栈上</p>
<p>查阅资料</p>
<p><a target="_blank" rel="noopener" href="https://paper.seebug.org/2017/#22">https://paper.seebug.org/2017/#22</a></p>
<p><a target="_blank" rel="noopener" href="https://kristal-g.github.io/2021/02/07/HEVD_StackOverflowGS_Windows_10_RS5_x64.html">https://kristal-g.github.io/2021/02/07/HEVD_StackOverflowGS_Windows_10_RS5_x64.html</a></p>
<p>cookie值是存储在<code>_data</code>段的第一个</p>
<p><img src="https://img.joe1sn.top/uploads/big/1c6b200d43a1bc05250cfd066d6c2991.png" alt="image-20240124215049718" /></p>
<p>函数检查的部分，有一个异或</p>
<p><img src="https://img.joe1sn.top/uploads/big/fb17ff5c2760ddac222db2dda25f7b7f.png" alt="image-20240124215249257" /></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">1: kd&gt; dqs rsp</span><br><span class="line">ffff8788`21979540  00000000`00000000</span><br><span class="line">ffff8788`21979548  ffffc186`261f98f0</span><br><span class="line">ffff8788`21979550  ffffc186`269c86b0</span><br><span class="line">ffff8788`21979558  00000000`80000004</span><br><span class="line">ffff8788`21979560  00000000`00000000</span><br><span class="line">ffff8788`21979568  fffff804`2a4d66e5 HEVD!TriggerBufferOverflowStackGS+0x5 [c:\projects\hevd\driver\hevd\bufferoverflowstackgs.c @ 70]</span><br><span class="line">ffff8788`21979570  00000000`00000000</span><br><span class="line">ffff8788`21979578  00000000`00000003</span><br><span class="line">ffff8788`21979580  54535f57`4f4c4652</span><br><span class="line">ffff8788`21979588  ffffc186`1f93206c</span><br><span class="line">ffff8788`21979590  00000000`00000000</span><br><span class="line">ffff8788`21979598  00000000`00000000</span><br><span class="line">ffff8788`219795a0  00000000`00000000</span><br><span class="line">ffff8788`219795a8  00000000`00000000</span><br><span class="line">ffff8788`219795b0  ffff8788`219796a0</span><br><span class="line">ffff8788`219795b8  00000000`00000000</span><br><span class="line"></span><br><span class="line">1: kd&gt; r rax</span><br><span class="line">rax=0000ad1068899811</span><br><span class="line"></span><br><span class="line">1: kd&gt; s rsp L1000 07 20 22</span><br><span class="line">ffff8788`219797e8  07 20 22 00 00 00 00 00-20 0d 07 27 86 c1 ff ff  . &quot;..... ..&#x27;....</span><br><span class="line">ffff8788`21979988  07 20 22 00 86 c1 ff ff-00 00 00 00 00 00 00 00  . &quot;.............</span><br><span class="line">ffff8788`21979a48  07 20 22 00 ff ff ff ff-30 e8 d9 1f 07 00 00 00  . &quot;.....0.......</span><br><span class="line">ffff8788`21979ab8  07 20 22 00 00 00 00 00-30 e8 d9 1f 07 00 00 00  . &quot;.....0.......</span><br><span class="line">1: kd&gt; ? ffff8788`219797e8-rsp</span><br><span class="line">Evaluate expression: 680 = 00000000`000002a8</span><br></pre></td></tr></table></figure>
<ol>
<li>
<p>利用之前的<code>ulGetBase</code>得到<code>HEVD.sys</code>的基地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; dqs  0xfffff80522fe0000+3000</span><br><span class="line">fffff805`22fe3000  00006fd9`604347b3</span><br><span class="line">fffff805`22fe3008  ffff9026`9fbcb84c</span><br></pre></td></tr></table></figure>
<p>再下断点看看是不是为这个值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; g</span><br><span class="line">Breakpoint 0 hit</span><br><span class="line">HEVD!TriggerBufferOverflowStackGS+0x1b:</span><br><span class="line">fffff805`230666fb 4833c4          xor     rax,rsp</span><br><span class="line">1: kd&gt; r rax</span><br><span class="line">rax=00006fd9604347b3</span><br></pre></td></tr></table></figure>
<p>还真是，那么访问<code>base+3000</code>就可以得<code>cookie</code>值</p>
</li>
<li>
<p>如何读取？这个还真没办法，只能利用另外一个漏洞<code>HEVD_IOCTL_ARBITRARY_WRITE</code>，将该值修改为我们自己的值，也可以设置<code>Ring3ToKernel</code>中的一个地址的值为待写入的地方，然后利用这个漏洞将<code>cookie</code>写入</p>
</li>
<li>
<p><code>key</code>值位于<code>rsp</code>上，利用<code>NtQuerySystemInformation</code>中的<code>PSYSTEM_EXTENDED_PROCESS_INFORMATION</code>可以得到，</p>
<p>但是win10好像修复了这个利用方式，对该函数增加鉴权，普通用户只能便利普通用户的栈信息</p>
</li>
</ol>
</div></article><section class="comments"><div id="disqus_thread"></div><script>var disqus_shortname = 'disqus';
(function () {
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async></script></section><div class="pagination"><a class="pagination__link pagination__next" href="/2024/02/15/kerberos/">next_post</a></div></main><footer class="footer metadata"><p class="footer__text">© 2024 Joe1sn</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div></body></html>