<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Joe1sn's Cabinet | windows内核驱动 8-计时器与通知</title><meta name="description" content=""><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="https://joe1sn.eu.org/atom.xml" title="Joe1sn's Cabinet"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Joe1sn's Cabinet" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/">Joe1sn's Cabinet</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="https://github.com/Joe1sn" target="_blank">GITHUB</a></li></ul></nav></header><main class="container__wrapper"><article class="article post"><h3 class="article__title">windows内核驱动 8-计时器与通知</h3><div class="article__date metadata"><div class="post-info">2024/03/27</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/kernel/">kernel</a><a class="article__tags__link metadata" href="/tags/windows/">windows</a></div><div class="article__body"><p>在内核中使用定时器、通知和回调</p>
<p>…学到一半打靶场去了</p>
<h1 id="定时器"><a class="markdownIt-Anchor" href="#定时器"></a> 定时器</h1>
<p>CPU最短能统计时间为100纳秒 100ns</p>
<p>内核中使用LARGEINT来表示时间长度</p>
<p>1s = -10 *1000 * 1000</p>
<h2 id="基于设备的io定时器"><a class="markdownIt-Anchor" href="#基于设备的io定时器"></a> 基于设备的IO定时器</h2>
<p>在<code>DriverEntry</code>里面尝试一下</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID <span class="title">TimeWorker</span><span class="params">(PVOID CONTEXT)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DbgPrint</span>(<span class="string">&quot;Irql: %d\n&quot;</span>, <span class="built_in">KeGetCurrentIrql</span>());</span><br><span class="line">    <span class="built_in">DbgPrint</span>(<span class="string">&quot;Process: %s\n&quot;</span>, <span class="built_in">PsGetProcessImageFileName</span>(<span class="built_in">PsGetCurrentProcess</span>()));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT  DriverObject, PUNICODE_STRING RegistryPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//    ...</span></span><br><span class="line">    <span class="built_in">IoInitializeTimer</span>(pDevice, TimeWorker, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">IoStartTimer</span>(pDevice);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Unload</span>()&#123;</span><br><span class="line">    <span class="built_in">IoStopTimer</span>(DriverObject-&gt;DeviceObject);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://img.joe1sn.top/uploads/big/d8a887058e533a26fd3119640ff28557.png" alt="image-20240327161718432" /></p>
<p>主要API</p>
<ul>
<li>
<p><code>IoInitializeTimer</code>：创建定时</p>
</li>
<li>
<p><code>IoStartTimer</code>：开启定时</p>
</li>
<li>
<p><code>IoStopTimer</code>：关闭定时</p>
</li>
</ul>
<p>技巧</p>
<ul>
<li>同时启用两个定时器可以关闭PCHUNTER</li>
<li>做认证</li>
</ul>
<h2 id="结合dpc的定时器"><a class="markdownIt-Anchor" href="#结合dpc的定时器"></a> 结合DPC的定时器</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//全局变量</span></span><br><span class="line">KDPC kDPC = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">LARGE_INTEGER DpcTime = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">KeInitializeTimer</span>(&amp;keTimer);</span><br><span class="line">    KDPC kDPC = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="built_in">KeInitializeDpc</span>(&amp;kDPC, &amp;DpcRoutineFunc, <span class="literal">NULL</span>);</span><br><span class="line">    LARGE_INTEGER DpcTime = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    DpcTime.QuadPart = <span class="number">-10</span> * <span class="number">1000</span> * <span class="number">2000</span>;</span><br><span class="line">    <span class="built_in">KeSetTimer</span>(&amp;keTimer, DpcTime, &amp;kDPC);</span><br><span class="line"></span><br><span class="line"><span class="built_in">KeCancelTimer</span>(&amp;keTimer);</span><br></pre></td></tr></table></figure>
<p><img src="https://img.joe1sn.top/uploads/big/f9b8a75ab6eab4e335c7f7f88140713f.png" alt="image-20240327164409369" /></p>
<ul>
<li>后续可以通过<code>KeWait</code>来判断超时之类的</li>
<li>这个只会触发一次</li>
</ul>
<p><strong>放在工作队列线程池中运行</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ExInitializeWorkItem</span>(&amp;work_item, WorkItemRoutine, <span class="literal">NULL</span>);</span><br><span class="line"><span class="built_in">ExQueueWorkItem</span>(&amp;work_item, CriticalWorkQueue);</span><br></pre></td></tr></table></figure>
<p><img src="https://img.joe1sn.top/uploads/big/8252549ad4ddd4cf75ab29a1ca6c01cb.png" alt="image-20240327170200351" /></p>
<ul>
<li>例程级别很低</li>
<li><code>WorkItemRoutine</code>别陷入死循环，<strong>同步</strong></li>
</ul>
<h1 id="通知"><a class="markdownIt-Anchor" href="#通知"></a> 通知</h1>
<p>通知：发生某一件事变更，知道事情变更，但不能操作变更的结果。<code>PsCreateNotify</code></p>
<p>回调：能拦截相关信息，更改流程和结果。</p>
<p><a href="https://joe1sn.eu.org/2024/03/20/windows-kernel-driver-6-memory/">windows内核驱动 6-链表与进程</a>讲了部分</p>
<p>模块加载回调：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID <span class="title">ImageRoutine</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    PUNICODE_STRING FullImageName,</span></span></span><br><span class="line"><span class="params"><span class="function">    HANDLE ProcessId,                <span class="comment">// pid into which image is being mapped</span></span></span></span><br><span class="line"><span class="params"><span class="function">    PIMAGE_INFO ImageInfo</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//DbgPrint(&quot;Triigered callback\n&quot;);</span></span><br><span class="line">    PEPROCESS temppe = <span class="literal">NULL</span>;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    status = <span class="built_in">PsLookupProcessByProcessId</span>(ProcessId, &amp;temppe);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">        <span class="built_in">ObDereferenceObject</span>(temppe);</span><br><span class="line">        PUCHAR imagename = <span class="built_in">PsGetProcessImageFileName</span>(temppe);</span><br><span class="line">        <span class="built_in">DbgPrint</span>(<span class="string">&quot;[%s] load [%wZ] with baseaddr [%llx]\n&quot;</span>, imagename, FullImageName, ImageInfo-&gt;ImageBase);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//DbgPrint(&quot;FullImageName: %wZ---PID: %d\n&quot;, FullImageName, ProcessId);</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">PsSetLoadImageNotifyRoutine</span>(ImageRoutine);</span><br><span class="line"><span class="built_in">PsRemoveLoadImageNotifyRoutine</span>(ImageRoutine);</span><br></pre></td></tr></table></figure>
<p><img src="https://img.joe1sn.top/uploads/big/c39428184cbd25839e0f744924c3ea0e.png" alt="image-20240327175140251" /></p>
<p>其他的也很类似</p>
</div></article><section class="comments"><div id="disqus_thread"></div><script>var disqus_shortname = 'disqus';
(function () {
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async></script></section><div class="pagination"><a class="pagination__link pagination__prev" href="/2024/03/28/crackme-coploit/">prev_post</a><a class="pagination__link pagination__next" href="/2024/03/21/windows-kernel-driver-7-process-sync/">next_post</a></div></main><footer class="footer metadata"><p class="footer__text">© 2024 Joe1sn</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div></body></html>